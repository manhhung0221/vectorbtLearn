<!doctype html><html lang=en class=no-js> 
<!-- Mirrored from vectorbt.pro/pvt_41531c19/cookbook/portfolio/ by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 22 Nov 2025 03:46:35 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Recipes for simulating and analyzing portfolios in VectorBT PRO"><meta name=author content="Oleg Polakow"><link href=https://vectorbt.pro/cookbook/portfolio/ rel=canonical><link href=../plotting/index.html rel=prev><link href=../signals/index.html rel=next><link rel=icon href=../../assets/logo/favicon.png><meta name=generator content="mkdocs-1.6.0, mkdocs-material-9.6.21+insiders-4.53.17"><title>Portfolio - VectorBT® PRO</title><link rel=stylesheet href=../../assets/stylesheets/main.010a373c.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=../../../../fonts.gstatic.com/index.html crossorigin><link rel=stylesheet href="../../../../fonts.googleapis.com/cssbe43.css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../assets/stylesheets/extra.css><link rel=stylesheet href=../../assets/stylesheets/custom-light.css><link rel=stylesheet href=../../assets/stylesheets/custom-dark.css><link rel=stylesheet href=../../assets/stylesheets/pygments-light.css><link rel=stylesheet href=../../assets/stylesheets/pygments-dark.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-0C5VNYCFHL"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-0C5VNYCFHL",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="../../../../www.googletagmanager.com/gtag/jsc6c8?id=G-0C5VNYCFHL",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script><meta name=robots content="noindex, nofollow"><meta property=og:title content=Portfolio><meta property=og:type content=website><meta content=https://vectorbt.pro/cookbook/portfolio/ property=og:url><meta property=og:image:url content=https://vectorbt.pro/pvt_41531c19/assets/logo/social-new.png><meta property=og:image:type content=image/png><meta property=og:description content="Recipes for simulating and analyzing portfolios in VectorBT PRO"><meta property=og:locale content=en-GB><link rel=apple-touch-icon sizes=180x180 href=https://vectorbt.pro/pvt_41531c19/assets/logo/apple-touch-icon.png><link rel=icon type=image/svg+xml href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon.svg><link rel=icon type=image/png sizes=32x32 href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon-16x16.png><link rel=manifest href=https://vectorbt.pro/pvt_41531c19/assets/logo/site.webmanifest><link rel=mask-icon href=https://vectorbt.pro/pvt_41531c19/assets/logo/safari-pinned-tab.svg color=#1e1f22><link rel="shortcut icon" href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon.ico><meta name=msapplication-TileColor content=#1e1f22><meta name=msapplication-config content=https://vectorbt.pro/pvt_41531c19/assets/logo/browserconfig.xml><meta name=theme-color content=#1e1f22><link href=https://unpkg.com/aos@2.3.4/dist/aos.css rel=stylesheet><script src=https://unpkg.com/aos@2.3.4/dist/aos.js></script><link href=http://fonts.cdnfonts.com/css/uni-neue rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/js/all.min.js integrity="sha512-8pHNiqTlsrRjVD4A/3va++W1sMbUHwWxxRPWNyVlql3T+Hgfd81Qc6FC5WMXDC+tSauxxzp1tgiAvSKFu1qIlA==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js integrity="sha512-q583ppKrCRc7N5O0n2nzUiJ+suUv7Et1JGels4bXOaMFQcamPk9HjdUknZuuFjBNs7tsMuadge5k9RzdmO+1GQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><link rel=preconnect href=https://fonts.googleapis.com/><link rel=preconnect href=https://fonts.gstatic.com/ crossorigin></head> <body dir=ltr data-md-color-scheme=custom-dark data-md-color-primary=custom-dark data-md-color-accent=custom-dark> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#portfolio class=md-skip> Skip to content </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> <button class="md-banner__button md-icon" aria-label="Don't show this again"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> <i>What's new</i>: New LLM providers, reasoning steps, function calling, YAML & TOML support, and <a href=https://vectorbt.pro/pvt_41531c19/getting-started/release-notes><strong>more</strong></a> <span class="twemoji announce-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m153.6 29.9 16-21.3c4-5.4 10.4-8.6 17.1-8.6C198.4 0 208 9.6 208 21.3v22.1c0 13.1 5.4 25.7 14.9 34.7l84.7 80.9c48.8 46.6 76.4 111.2 76.4 178.7C384 434 306 512 209.7 512H192C86 512 0 426 0 320v-3.8c0-48.8 19.4-95.6 53.9-130.1l3.5-3.5c4.2-4.2 10-6.6 16-6.6 12.5 0 22.6 10.1 22.6 22.6V288c0 35.3 28.7 64 64 64s64-28.7 64-64v-3.9c0-18-7.2-35.3-19.9-48l-38.6-38.6c-24-24-37.5-56.7-37.5-90.7 0-27.7 9-54.8 25.6-76.9"/></svg></span> </div> <script>var el=document.querySelector("[data-md-component=announce]");if(el){var content=el.querySelector(".md-typeset");__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0)}</script> </aside> </div> <!-- Determine class according to configuration --> <!-- Header --> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=header.title> <!-- Link to home --> <a href=https://vectorbt.pro/pvt_41531c19/ title="VectorBT® PRO" class="md-header__button md-logo" aria-label="VectorBT® PRO" data-md-component=logo> <img src=https://vectorbt.pro/pvt_41531c19/assets/logo/logo.svg alt=logo class=logo> </a> <!-- Button to open drawer --> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <!-- Header title --> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> VectorBT® PRO <span class=md-version> v2025.10.15 </span> <span class=unlock-icon><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M192 32c-35.3 0-64 28.7-64 64v64h192c35.3 0 64 28.7 64 64v224c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V224c0-35.3 28.7-64 64-64V96c0-70.7 57.3-128 128-128 63.5 0 116.1 46.1 126.2 106.7 2.9 17.4-8.8 33.9-26.3 36.9S258 102.8 255 85.3C250 55.1 223.7 32 192 32m40 328c13.3 0 24-10.7 24-24s-10.7-24-24-24h-80c-13.3 0-24 10.7-24 24s10.7 24 24 24z"/></svg></span> </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Portfolio </span> </div> </div> </div> <!-- Color palette --> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=custom-dark data-md-color-primary=custom-dark data-md-color-accent=custom-dark aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=custom-light data-md-color-primary=custom-light data-md-color-accent=custom-light aria-label="Switch to dark mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <!-- Site language selector --> <!-- Button to open search modal --> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <!-- Search interface --> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <!-- Repository information --> <div class=md-header__source> <a href=https://github.com/polakowo/vectorbt.pro title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> vectorbt.pro </div> </a> </div> </nav> <!-- Navigation tabs (sticky) --> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/ class=md-tabs__link> Getting started </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/features/overview/ class=md-tabs__link> Features </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/overview/ class=md-tabs__link> Tutorials </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/documentation/overview/ class=md-tabs__link> Documentation </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/overview/ class=md-tabs__link> Cookbook </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/api/ class=md-tabs__link> API </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/terms/terms-of-use/ class=md-tabs__link> Terms </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://vectorbt.pro/pvt_41531c19/ title="VectorBT® PRO" class="md-nav__button md-logo" aria-label="VectorBT® PRO" data-md-component=logo> <img src=https://vectorbt.pro/pvt_41531c19/assets/logo/logo.svg alt=logo class=logo> </a> VectorBT® PRO </label> <div class=md-nav__source> <a href=https://github.com/polakowo/vectorbt.pro title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> vectorbt.pro </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/ class=md-nav__link> <span class=md-ellipsis> Getting started </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/features/overview/ class=md-nav__link> <span class=md-ellipsis> Features </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/overview/ class=md-nav__link> <span class=md-ellipsis> Tutorials </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/documentation/overview/ class=md-nav__link> <span class=md-ellipsis> Documentation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5 checked> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex> <span class=md-ellipsis> Cookbook </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=true> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Cookbook </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/overview/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/arrays/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7 2h14a2 2 0 0 1 2 2v12c0 1.11-.89 2-2 2H7a2 2 0 0 1-2-2V4c0-1.1.9-2 2-2m0 4v4h6V6zm8 0v4h6V6zm-8 6v4h6v-4zm8 0v4h6v-4zM3 20V6H1v14c0 1.11.89 2 2 2h16v-2z"/></svg> <span class=md-ellipsis> Arrays </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/benchmarking/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9 5a7 7 0 0 1 7 7h1v3h-1v4H9a7 7 0 0 1-7-7 7 7 0 0 1 7-7m0 3a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m8 9h5v4h-2v-2h-3z"/></svg> <span class=md-ellipsis> Benchmarking </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/caching/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m19 8-4 4h3a6 6 0 0 1-6 6c-1 0-1.97-.25-2.8-.7l-1.46 1.46A7.93 7.93 0 0 0 12 20a8 8 0 0 0 8-8h3M6 12a6 6 0 0 1 6-6c1 0 1.97.25 2.8.7l1.46-1.46A7.93 7.93 0 0 0 12 4a8 8 0 0 0-8 8H1l4 4 4-4"/></svg> <span class=md-ellipsis> Caching </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/compilation/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 16a3 3 0 0 1-3-3c0-1.12.61-2.1 1.5-2.61l9.71-5.62-5.53 9.58c-.5.98-1.51 1.65-2.68 1.65m0-13c1.81 0 3.5.5 4.97 1.32l-2.1 1.21C14 5.19 13 5 12 5a8 8 0 0 0-8 8c0 2.21.89 4.21 2.34 5.65h.01c.39.39.39 1.02 0 1.41s-1.03.39-1.42.01A9.97 9.97 0 0 1 2 13 10 10 0 0 1 12 3m10 10c0 2.76-1.12 5.26-2.93 7.07-.39.38-1.02.38-1.41-.01a.996.996 0 0 1 0-1.41A7.95 7.95 0 0 0 20 13c0-1-.19-2-.54-2.9L20.67 8C21.5 9.5 22 11.18 22 13"/></svg> <span class=md-ellipsis> Compilation </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/configuration/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 15.5A3.5 3.5 0 0 1 8.5 12 3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97s-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1s.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64z"/></svg> <span class=md-ellipsis> Configuration </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/cross-validation/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M.41 13.41 6 19l1.41-1.42L1.83 12m20.41-6.42L11.66 16.17 7.5 12l-1.43 1.41L11.66 19l12-12M18 7l-1.41-1.42-6.35 6.35 1.42 1.41z"/></svg> <span class=md-ellipsis> Cross-validation </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/data/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 3C7.58 3 4 4.79 4 7s3.58 4 8 4 8-1.79 8-4-3.58-4-8-4M4 9v3c0 2.21 3.58 4 8 4s8-1.79 8-4V9c0 2.21-3.58 4-8 4s-8-1.79-8-4m0 5v3c0 2.21 3.58 4 8 4s8-1.79 8-4v-3c0 2.21-3.58 4-8 4s-8-1.79-8-4"/></svg> <span class=md-ellipsis> Data </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/datetime/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg> <span class=md-ellipsis> Datetime </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/discovery/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 3h6v4H3zm12 7h6v4h-6zm0 7h6v4h-6zm-2-4H7v5h6v2H5V9h2v2h6z"/></svg> <span class=md-ellipsis> Discovery </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/indexing/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 20.5c0 .8-.7 1.5-1.5 1.5H13c-.4 0-.7-.1-1-.4l-4-4.2.7-.8c.2-.2.5-.3.8-.3h.2L12 18V9c0-.6.4-1 1-1s1 .4 1 1v4.5l1.2.1 3.9 2.2c.5.2.9.8.9 1.3zM20 2H4c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h4v-2H4V4h16v8h-2v2h2c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2"/></svg> <span class=md-ellipsis> Indexing </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/indicators/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m3 14 .5.07L8.07 9.5a1.95 1.95 0 0 1 .52-1.91c.78-.79 2.04-.79 2.82 0 .53.52.7 1.26.52 1.91l2.57 2.57.5-.07c.18 0 .35 0 .5.07l3.57-3.57C19 8.35 19 8.18 19 8a2 2 0 0 1 2-2 2 2 0 0 1 2 2 2 2 0 0 1-2 2c-.18 0-.35 0-.5-.07l-3.57 3.57c.07.15.07.32.07.5a2 2 0 0 1-2 2 2 2 0 0 1-2-2l.07-.5-2.57-2.57c-.32.07-.68.07-1 0L4.93 15.5 5 16a2 2 0 0 1-2 2 2 2 0 0 1-2-2 2 2 0 0 1 2-2"/></svg> <span class=md-ellipsis> Indicators </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/knowledge/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 2a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6l-4 4V4a2 2 0 0 1 2-2zM4 4v13.17L5.17 16H20V4zm2 3h12v2H6zm0 4h9v2H6z"/></svg> <span class=md-ellipsis> Knowledge </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/optimization/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16h-.58l-.81-.81A7.07 7.07 0 0 0 18 11c0-3.87-3.13-7-7-7-1.5 0-3 .5-4.21 1.4-3.09 2.32-3.72 6.71-1.4 9.8s6.71 3.72 9.8 1.4l.81.81V18l5 5 2-2zm-7 0c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5M3 6 1 8V1h7L6 3H3zm18-5v7l-2-2V3h-3l-2-2zM6 19l2 2H1v-7l2 2v3z"/></svg> <span class=md-ellipsis> Optimization </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/persistence/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M2 12h2v5h16v-5h2v5c0 1.11-.89 2-2 2H4a2 2 0 0 1-2-2zm10 3 5.55-5.46-1.42-1.41L13 11.25V2h-2v9.25L7.88 8.13 6.46 9.55z"/></svg> <span class=md-ellipsis> Persistence </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/plotting/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7.2 11.2c1.77 0 3.2 1.43 3.2 3.2s-1.43 3.2-3.2 3.2S4 16.17 4 14.4s1.43-3.2 3.2-3.2m7.6 4.8a2 2 0 0 1 2 2 2 2 0 0 1-2 2 2 2 0 0 1-2-2 2 2 0 0 1 2-2m.4-12A4.8 4.8 0 0 1 20 8.8c0 2.65-2.15 4.8-4.8 4.8a4.8 4.8 0 0 1-4.8-4.8c0-2.65 2.15-4.8 4.8-4.8"/></svg> <span class=md-ellipsis> Plotting </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17.45 15.18 22 7.31V21H2V3h2v12.54L9.5 6 16 9.78l4.24-7.33 1.73 1-5.23 9.05-6.51-3.75L4.31 19h2.26l4.39-7.56z"/></svg> <span class=md-ellipsis> Portfolio </span> <span class="md-nav__icon md-icon"></span> </label> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/portfolio/ class="md-nav__link md-nav__link--active"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17.45 15.18 22 7.31V21H2V3h2v12.54L9.5 6 16 9.78l4.24-7.33 1.73 1-5.23 9.05-6.51-3.75L4.31 19h2.26l4.39-7.56z"/></svg> <span class=md-ellipsis> Portfolio </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#from-data class=md-nav__link> <span class=md-ellipsis> From data </span> </a> </li> <li class=md-nav__item> <a href=#from-signals class=md-nav__link> <span class=md-ellipsis> From signals </span> </a> <nav class=md-nav aria-label="From signals"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#callbacks class=md-nav__link> <span class=md-ellipsis> Callbacks </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#records class=md-nav__link> <span class=md-ellipsis> Records </span> </a> </li> <li class=md-nav__item> <a href=#metrics class=md-nav__link> <span class=md-ellipsis> Metrics </span> </a> </li> <li class=md-nav__item> <a href=#metadata class=md-nav__link> <span class=md-ellipsis> Metadata </span> </a> </li> <li class=md-nav__item> <a href=#stacking class=md-nav__link> <span class=md-ellipsis> Stacking </span> </a> </li> <li class=md-nav__item> <a href=#parallelizing class=md-nav__link> <span class=md-ellipsis> Parallelizing </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/signals/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m6 2c0-3.3-2.7-6-6-6s-6 2.7-6 6c0 2.2 1.2 4.1 3 5.2l1-1.7c-1.2-.7-2-2-2-3.4 0-2.2 1.8-4 4-4s4 1.8 4 4c0 1.5-.8 2.8-2 3.4l1 1.7c1.8-1 3-3 3-5.2M12 2C6.5 2 2 6.5 2 12c0 3.7 2 6.9 5 8.6l1-1.7c-2.4-1.4-4-4-4-6.9 0-4.4 3.6-8 8-8s8 3.6 8 8c0 3-1.6 5.5-4 6.9l1 1.7c3-1.7 5-4.9 5-8.6 0-5.5-4.5-10-10-10"/></svg> <span class=md-ellipsis> Signals </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/api/ class=md-nav__link> <span class=md-ellipsis> API </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/terms/terms-of-use/ class=md-nav__link> <span class=md-ellipsis> Terms </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=portfolio><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17.45 15.18 22 7.31V21H2V3h2v12.54L9.5 6 16 9.78l4.24-7.33 1.73 1-5.23 9.05-6.51-3.75L4.31 19h2.26l4.39-7.56z"/></svg></span> Portfolio<a class=headerlink href=#portfolio title="Permanent link">&para;</a></h1> <div class="admonition question"> <p class=admonition-title>Question</p> <p>Find more information in the <a href=https://vectorbt.pro/pvt_41531c19/documentation/portfolio/ >Portfolio documentation</a>.</p> </div> <h2 id=from-data>From data<a class=headerlink href=#from-data title="Permanent link">&para;</a></h2> <p>To quickly simulate a portfolio from any OHLC data, you can use <a href=https://vectorbt.pro/pvt_41531c19/api/data/base/#vectorbtpro.data.base.Data.run>Data.run</a> or pass the data instance (or simply a symbol or <code>class_name:symbol</code>) to the simulation method.</p> <div class="language-python highlight"><span class=filename>Various way to quickly simulate a portfolio from a Data instance</span><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=n>pf</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=s2>&quot;from_holding&quot;</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=n>pf</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=s2>&quot;from_random_signals&quot;</span><span class=p>,</span> <span class=n>n</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_holding</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_holding</span><span class=p>(</span><span class=s2>&quot;BTC-USD&quot;</span><span class=p>)</span>  <span class=c1># (4)!</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_holding</span><span class=p>(</span><span class=s2>&quot;BinanceData:BTCUSDT&quot;</span><span class=p>)</span>  <span class=c1># (5)!</span>
</span></code></pre></div> <ol> <li>Simulate a buy-and-hold portfolio from data.</li> <li>Simulate a portfolio from data with 10 entries and 10 exits placed randomly.</li> <li>Same as the first line.</li> <li>Retrieve the symbol "BTC-USD" from Yahoo Finance (default) and simulate a buy-and-hold portfolio.</li> <li>Retrieve the symbol "BTCUSDT" from Binance and simulate a buy-and-hold portfolio.</li> </ol> <h2 id=from-signals>From signals<a class=headerlink href=#from-signals title="Permanent link">&para;</a></h2> <p>This simulation method is easy to use yet powerful, as long as your strategy can be defined using signals, such as buy, sell, short sell, and buy to cover.</p> <div class="language-python highlight"><span class=filename>Various signal configurations</span><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=o>...</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=nb>open</span><span class=o>=</span><span class=nb>open</span><span class=p>,</span> <span class=n>high</span><span class=o>=</span><span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=o>=</span><span class=n>low</span><span class=p>,</span> <span class=n>close</span><span class=o>=</span><span class=n>close</span><span class=p>,</span> <span class=o>...</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=n>close</span><span class=p>,</span> <span class=o>...</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>entries</span><span class=p>,</span> <span class=n>exits</span><span class=p>)</span>  <span class=c1># (4)!</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>entries</span><span class=p>,</span> <span class=n>exits</span><span class=p>,</span> <span class=n>direction</span><span class=o>=</span><span class=s2>&quot;shortonly&quot;</span><span class=p>)</span>  <span class=c1># (5)!</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>entries</span><span class=p>,</span> <span class=n>exits</span><span class=p>,</span> <span class=n>direction</span><span class=o>=</span><span class=s2>&quot;both&quot;</span><span class=p>)</span>  <span class=c1># (6)!</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>  <span class=c1># (7)!</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a>    <span class=n>data</span><span class=p>,</span> 
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>    <span class=n>long_entries</span><span class=o>=</span><span class=n>long_entries</span><span class=p>,</span> 
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>    <span class=n>long_exits</span><span class=o>=</span><span class=n>long_exits</span><span class=p>,</span>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a>    <span class=n>short_entries</span><span class=o>=</span><span class=n>short_entries</span><span class=p>,</span> 
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a>    <span class=n>short_exits</span><span class=o>=</span><span class=n>short_exits</span><span class=p>,</span>
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a><span class=p>)</span>
</span></code></pre></div> <ol> <li>When a data instance is passed (not a DataFrame!), VBT will extract OHLC data automatically.</li> <li>Same as above, but all price features are passed manually.</li> <li>For tick data or when OHL is not available, pass only the close price.</li> <li>Enter a long position when <code>entries</code> is True and exit it when <code>exits</code> is True (no short positions).</li> <li>Enter a short position when <code>entries</code> is True and exit it when <code>exits</code> is True (no long positions).</li> <li>Enter a long position when <code>entries</code> is True and a short position when <code>exits</code> is True, using reversals.</li> <li>Enter a long position when <code>long_entries</code> is True, exit it when <code>long_exits</code> is True, enter a short position when <code>short_entries</code> is True, and exit it when <code>short_exits</code> is True.</li> </ol> <div class=separator-container> <hr class=separator> <span class=separator-text>+</span> <hr class=separator> </div> <p>To set different prices or other arguments for long and short signals, create an empty array and use each signal type as a mask to assign the corresponding value.</p> <div class="language-python highlight"><span class=filename>Manually apply a 1% slippage to the price</span><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=n>price</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>()</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=n>price</span><span class=p>[</span><span class=n>entries</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>close</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=mf>0.01</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=n>price</span><span class=p>[</span><span class=n>exits</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>close</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=mf>0.01</span><span class=p>)</span>
</span></code></pre></div> <ol> <li>Entries and exits here are masks: assign values where their value is True. If you want to replace <code>data.close</code> with a NumPy array, use <code>arr[entries]</code> on the right side as well.</li> </ol> <div class="language-python highlight"><span class=filename>Use the ask price for buying and the bid price for selling</span><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=n>price</span> <span class=o>=</span> <span class=p>(</span><span class=n>bid_price</span> <span class=o>+</span> <span class=n>ask_price</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=n>price</span><span class=p>[</span><span class=n>entries</span><span class=p>]</span> <span class=o>=</span> <span class=n>ask_price</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=n>price</span><span class=p>[</span><span class=n>exits</span><span class=p>]</span> <span class=o>=</span> <span class=n>bid_price</span>
</span></code></pre></div> <div class=separator-container> <hr class=separator> <span class=separator-text>+</span> <hr class=separator> </div> <p>To exit a trade after a specific amount of time or number of rows, use the <code>td_stop</code> argument. The measurement starts from the opening time of the entry row.</p> <div class="language-python highlight"><span class=filename>How to close out a position after some time</span><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>td_stop</span><span class=o>=</span><span class=s2>&quot;7 days&quot;</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>td_stop</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>7</span><span class=p>))</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>td_stop</span><span class=o>=</span><span class=n>td_arr</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>td_stop</span><span class=o>=</span><span class=mi>7</span><span class=p>,</span> <span class=n>time_delta_format</span><span class=o>=</span><span class=s2>&quot;rows&quot;</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>td_stop</span><span class=o>=</span><span class=n>int_arr</span><span class=p>,</span> <span class=n>time_delta_format</span><span class=o>=</span><span class=s2>&quot;rows&quot;</span><span class=p>)</span>  <span class=c1># (4)!</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>td_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=s2>&quot;1 day&quot;</span><span class=p>,</span> <span class=s2>&quot;7 days&quot;</span><span class=p>]))</span>  <span class=c1># (5)!</span>
</span></code></pre></div> <ol> <li>Exit after 7 days.</li> <li>Specify a custom timedelta for each row using an array. For example, you can use <a href=https://pandas.pydata.org/docs/reference/api/pandas.TimedeltaIndex.html><code>pd.TimedeltaIndex</code></a>.</li> <li>Exit after 7 rows (i.e., bars).</li> <li>For each potential entry row, specify after how many rows to exit.</li> <li>Any of the above examples can be tested as a parameter.</li> </ol> <div class=separator-container> <hr class=separator> <span class=separator-text>+</span> <hr class=separator> </div> <p>To exit a trade at a specific time or row count, use the <code>dt_stop</code> argument. If you pass a timedelta (as above), the position will be exited at the last bar <em>before</em> the target date. Otherwise, if you provide an exact date or time, the position will be exited <em>at</em> or <em>after</em> that point. You can override this behavior using the argument config.</p> <div class="language-python highlight"><span class=filename>How to close out a position at some time</span><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=kn>import</span><span class=w> </span><span class=nn>datetime</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>dt_stop</span><span class=o>=</span><span class=s2>&quot;daily&quot;</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>dt_stop</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>1</span><span class=p>))</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>  <span class=c1># (2)!</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>    <span class=o>...</span><span class=p>,</span> 
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a>    <span class=n>dt_stop</span><span class=o>=</span><span class=s2>&quot;daily&quot;</span><span class=p>,</span> 
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>    <span class=n>arg_config</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>dt_stop</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>last_before</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=p>)</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>dt_stop</span><span class=o>=</span><span class=s2>&quot;16:00&quot;</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>dt_stop</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>time</span><span class=p>(</span><span class=mi>16</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>  <span class=c1># (4)!</span>
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a>    <span class=o>...</span><span class=p>,</span> 
</span><span id=__span-5-15><a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a>    <span class=n>dt_stop</span><span class=o>=</span><span class=s2>&quot;16:00&quot;</span><span class=p>,</span> 
</span><span id=__span-5-16><a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a>    <span class=n>arg_config</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>dt_stop</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>last_before</span><span class=o>=</span><span class=kc>True</span><span class=p>))</span>
</span><span id=__span-5-17><a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a><span class=p>)</span>
</span><span id=__span-5-18><a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a>
</span><span id=__span-5-19><a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>dt_stop</span><span class=o>=</span><span class=s2>&quot;2024-01-01&quot;</span><span class=p>)</span>  <span class=c1># (5)!</span>
</span><span id=__span-5-20><a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>dt_stop</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Timestamp</span><span class=p>(</span><span class=s2>&quot;2024-01-01&quot;</span><span class=p>))</span>
</span><span id=__span-5-21><a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>  <span class=c1># (6)!</span>
</span><span id=__span-5-22><a id=__codelineno-5-22 name=__codelineno-5-22 href=#__codelineno-5-22></a>    <span class=o>...</span><span class=p>,</span> 
</span><span id=__span-5-23><a id=__codelineno-5-23 name=__codelineno-5-23 href=#__codelineno-5-23></a>    <span class=n>dt_stop</span><span class=o>=</span><span class=s2>&quot;2024-01-01&quot;</span><span class=p>,</span> 
</span><span id=__span-5-24><a id=__codelineno-5-24 name=__codelineno-5-24 href=#__codelineno-5-24></a>    <span class=n>arg_config</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>dt_stop</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>last_before</span><span class=o>=</span><span class=kc>True</span><span class=p>))</span>
</span><span id=__span-5-25><a id=__codelineno-5-25 name=__codelineno-5-25 href=#__codelineno-5-25></a><span class=p>)</span>
</span><span id=__span-5-26><a id=__codelineno-5-26 name=__codelineno-5-26 href=#__codelineno-5-26></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>dt_stop</span><span class=o>=</span><span class=n>dt_arr</span><span class=p>)</span>  <span class=c1># (7)!</span>
</span><span id=__span-5-27><a id=__codelineno-5-27 name=__codelineno-5-27 href=#__codelineno-5-27></a>
</span><span id=__span-5-28><a id=__codelineno-5-28 name=__codelineno-5-28 href=#__codelineno-5-28></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>dt_stop</span><span class=o>=</span><span class=n>int_arr</span><span class=p>,</span> <span class=n>time_delta_format</span><span class=o>=</span><span class=s2>&quot;rows&quot;</span><span class=p>)</span>  <span class=c1># (8)!</span>
</span><span id=__span-5-29><a id=__codelineno-5-29 name=__codelineno-5-29 href=#__codelineno-5-29></a>
</span><span id=__span-5-30><a id=__codelineno-5-30 name=__codelineno-5-30 href=#__codelineno-5-30></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>dt_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=s2>&quot;1 day&quot;</span><span class=p>,</span> <span class=s2>&quot;7 days&quot;</span><span class=p>]))</span>  <span class=c1># (9)!</span>
</span></code></pre></div> <ol> <li>Exit at the last bar before the end of the day.</li> <li>Exit at or after the end of the day.</li> <li>Exit at or after 16:00.</li> <li>Exit at the last bar before 16:00.</li> <li>Exit on or after January 1, 2024. This applies only to entries issued before that date.</li> <li>Exit at the last bar before January 1, 2024. This applies only to entries issued before that date.</li> <li>Specify a custom datetime for each row using an array. For example, you can use <a href=https://pandas.pydata.org/docs/reference/api/pandas.DatetimeIndex.html><code>pd.DatetimeIndex</code></a>.</li> <li>For each potential entry row, specify at which row to exit.</li> <li>Any of the above examples can be tested as a parameter.</li> </ol> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Do not confuse <code>td_stop</code> with <code>dt_stop</code>. "td" stands for timedelta, while "dt" stands for datetime.</p> </div> <div class=separator-container> <hr class=separator> <span class=separator-text>+</span> <hr class=separator> </div> <p>To perform multiple actions within a single bar, split each bar into three sub-bars: opening nanosecond, middle, and closing nanosecond. For example, you can execute your signals at the end of the bar, and your stop orders will be guaranteed to execute at the first two sub-bars. This lets you close out a position and enter a new one within the same bar.</p> <div class="language-python highlight"><span class=filename>Execute entries at open, exits at close</span><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=n>x3_open</span> <span class=o>=</span> <span class=nb>open</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>repeat</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=n>x3_high</span> <span class=o>=</span> <span class=n>high</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>repeat</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=n>x3_low</span> <span class=o>=</span> <span class=n>low</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>repeat</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=n>x3_close</span> <span class=o>=</span> <span class=n>close</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>repeat</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=n>x3_entries</span> <span class=o>=</span> <span class=n>entries</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>repeat</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=n>x3_exits</span> <span class=o>=</span> <span class=n>exits</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>repeat</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=n>bar_open</span> <span class=o>=</span> <span class=nb>slice</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=n>bar_middle</span> <span class=o>=</span> <span class=nb>slice</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=n>bar_close</span> <span class=o>=</span> <span class=nb>slice</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a>
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a><span class=n>x3_high</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>bar_open</span><span class=p>]</span> <span class=o>=</span> <span class=nb>open</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>  <span class=c1># (3)!</span>
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a><span class=n>x3_low</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>bar_open</span><span class=p>]</span> <span class=o>=</span> <span class=nb>open</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span><span id=__span-6-14><a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a><span class=n>x3_close</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>bar_open</span><span class=p>]</span> <span class=o>=</span> <span class=nb>open</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span><span id=__span-6-15><a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a>
</span><span id=__span-6-16><a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a><span class=n>x3_open</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>bar_close</span><span class=p>]</span> <span class=o>=</span> <span class=n>close</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>  <span class=c1># (4)!</span>
</span><span id=__span-6-17><a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a><span class=n>x3_high</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>bar_close</span><span class=p>]</span> <span class=o>=</span> <span class=n>close</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span><span id=__span-6-18><a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a><span class=n>x3_low</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>bar_close</span><span class=p>]</span> <span class=o>=</span> <span class=n>close</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span><span id=__span-6-19><a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a>
</span><span id=__span-6-20><a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a><span class=n>x3_entries</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>bar_middle</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span>  <span class=c1># (5)!</span>
</span><span id=__span-6-21><a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a><span class=n>x3_entries</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>bar_close</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-6-22><a id=__codelineno-6-22 name=__codelineno-6-22 href=#__codelineno-6-22></a>
</span><span id=__span-6-23><a id=__codelineno-6-23 name=__codelineno-6-23 href=#__codelineno-6-23></a><span class=n>x3_exits</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>bar_open</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span>  <span class=c1># (6)!</span>
</span><span id=__span-6-24><a id=__codelineno-6-24 name=__codelineno-6-24 href=#__codelineno-6-24></a><span class=n>x3_exits</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>bar_middle</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-6-25><a id=__codelineno-6-25 name=__codelineno-6-25 href=#__codelineno-6-25></a>
</span><span id=__span-6-26><a id=__codelineno-6-26 name=__codelineno-6-26 href=#__codelineno-6-26></a><span class=n>x3_index</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>(</span><span class=n>x3_close</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>  <span class=c1># (7)!</span>
</span><span id=__span-6-27><a id=__codelineno-6-27 name=__codelineno-6-27 href=#__codelineno-6-27></a><span class=n>x3_index</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>bar_middle</span><span class=p>]</span> <span class=o>+=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Timedelta</span><span class=p>(</span><span class=n>nanoseconds</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-6-28><a id=__codelineno-6-28 name=__codelineno-6-28 href=#__codelineno-6-28></a><span class=n>x3_index</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>bar_close</span><span class=p>]</span> <span class=o>+=</span> <span class=n>index</span><span class=o>.</span><span class=n>freq</span> <span class=o>-</span> <span class=n>pd</span><span class=o>.</span><span class=n>Timedelta</span><span class=p>(</span><span class=n>nanoseconds</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-6-29><a id=__codelineno-6-29 name=__codelineno-6-29 href=#__codelineno-6-29></a><span class=n>x3_index</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Index</span><span class=p>(</span><span class=n>x3_index</span><span class=p>)</span>
</span><span id=__span-6-30><a id=__codelineno-6-30 name=__codelineno-6-30 href=#__codelineno-6-30></a><span class=n>x3_open</span><span class=o>.</span><span class=n>index</span> <span class=o>=</span> <span class=n>x3_index</span>
</span><span id=__span-6-31><a id=__codelineno-6-31 name=__codelineno-6-31 href=#__codelineno-6-31></a><span class=n>x3_high</span><span class=o>.</span><span class=n>index</span> <span class=o>=</span> <span class=n>x3_index</span>
</span><span id=__span-6-32><a id=__codelineno-6-32 name=__codelineno-6-32 href=#__codelineno-6-32></a><span class=n>x3_low</span><span class=o>.</span><span class=n>index</span> <span class=o>=</span> <span class=n>x3_index</span>
</span><span id=__span-6-33><a id=__codelineno-6-33 name=__codelineno-6-33 href=#__codelineno-6-33></a><span class=n>x3_close</span><span class=o>.</span><span class=n>index</span> <span class=o>=</span> <span class=n>x3_index</span>
</span><span id=__span-6-34><a id=__codelineno-6-34 name=__codelineno-6-34 href=#__codelineno-6-34></a><span class=n>x3_entries</span><span class=o>.</span><span class=n>index</span> <span class=o>=</span> <span class=n>x3_index</span>
</span><span id=__span-6-35><a id=__codelineno-6-35 name=__codelineno-6-35 href=#__codelineno-6-35></a><span class=n>x3_exits</span><span class=o>.</span><span class=n>index</span> <span class=o>=</span> <span class=n>x3_index</span>
</span><span id=__span-6-36><a id=__codelineno-6-36 name=__codelineno-6-36 href=#__codelineno-6-36></a>
</span><span id=__span-6-37><a id=__codelineno-6-37 name=__codelineno-6-37 href=#__codelineno-6-37></a><span class=n>x3_pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>  <span class=c1># (8)!</span>
</span><span id=__span-6-38><a id=__codelineno-6-38 name=__codelineno-6-38 href=#__codelineno-6-38></a>    <span class=nb>open</span><span class=o>=</span><span class=n>x3_open</span><span class=p>,</span>
</span><span id=__span-6-39><a id=__codelineno-6-39 name=__codelineno-6-39 href=#__codelineno-6-39></a>    <span class=n>high</span><span class=o>=</span><span class=n>x3_high</span><span class=p>,</span>
</span><span id=__span-6-40><a id=__codelineno-6-40 name=__codelineno-6-40 href=#__codelineno-6-40></a>    <span class=n>low</span><span class=o>=</span><span class=n>x3_low</span><span class=p>,</span>
</span><span id=__span-6-41><a id=__codelineno-6-41 name=__codelineno-6-41 href=#__codelineno-6-41></a>    <span class=n>close</span><span class=o>=</span><span class=n>x3_close</span><span class=p>,</span>
</span><span id=__span-6-42><a id=__codelineno-6-42 name=__codelineno-6-42 href=#__codelineno-6-42></a>    <span class=n>entries</span><span class=o>=</span><span class=n>x3_entries</span><span class=p>,</span>
</span><span id=__span-6-43><a id=__codelineno-6-43 name=__codelineno-6-43 href=#__codelineno-6-43></a>    <span class=n>exits</span><span class=o>=</span><span class=n>x3_exits</span><span class=p>,</span>
</span><span id=__span-6-44><a id=__codelineno-6-44 name=__codelineno-6-44 href=#__codelineno-6-44></a><span class=p>)</span>
</span><span id=__span-6-45><a id=__codelineno-6-45 name=__codelineno-6-45 href=#__codelineno-6-45></a><span class=n>pf</span> <span class=o>=</span> <span class=n>x3_pf</span><span class=o>.</span><span class=n>resample</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>index</span><span class=p>,</span> <span class=n>freq</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>silence_warnings</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># (9)!</span>
</span></code></pre></div> <ol> <li>Split each array into three sub-bars.</li> <li>These slices are used to index a specific sub-bar. They can be applied only with <code>iloc</code> or on NumPy arrays.</li> <li>Set OHLC to open at the first nanosecond.</li> <li>Set OHLC to close at the last nanosecond.</li> <li>Enable entries only at the open, and disable them at other sub-bars.</li> <li>Enable exits only at the close, and disable them at other sub-bars.</li> <li>Prepare the index.</li> <li>Run the simulation.</li> <li>Resample back to the original index.</li> </ol> <h3 id=callbacks>Callbacks<a class=headerlink href=#callbacks title="Permanent link">&para;</a></h3> <p>To save a piece of information at one timestamp and reuse it at a later timestamp in a callback, create a NumPy array and pass it to the callback. The array should be one-dimensional and have the same number of elements as there are columns. You can then read and write the element under the current column using the same method as accessing the latest position via <code>c.last_position[c.col]</code>. If you need to store more pieces of information, use additional arrays or a single structured array. For convenience, you can combine multiple arrays into a named tuple.</p> <div class="language-python highlight"><span class=filename>Execute only the first signal</span><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=kn>from</span><span class=w> </span><span class=nn>collections</span><span class=w> </span><span class=kn>import</span> <span class=n>namedtuple</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=n>Memory</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s2>&quot;Memory&quot;</span><span class=p>,</span> <span class=p>[</span><span class=s2>&quot;signal_executed&quot;</span><span class=p>])</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=nd>@njit</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=k>def</span><span class=w> </span><span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>entries</span><span class=p>,</span> <span class=n>exits</span><span class=p>,</span> <span class=n>memory</span><span class=p>):</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a>    <span class=n>is_entry</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>entries</span><span class=p>)</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a>    <span class=n>is_exit</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>exits</span><span class=p>)</span>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a>    <span class=k>if</span> <span class=n>is_entry</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>memory</span><span class=o>.</span><span class=n>signal_executed</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]:</span>  <span class=c1># (1)!</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a>        <span class=n>memory</span><span class=o>.</span><span class=n>signal_executed</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>  <span class=c1># (2)!</span>
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a>        <span class=k>return</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a>    <span class=k>if</span> <span class=n>is_exit</span><span class=p>:</span>
</span><span id=__span-7-13><a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a>        <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-7-14><a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a>    <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-7-15><a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a>
</span><span id=__span-7-16><a id=__codelineno-7-16 name=__codelineno-7-16 href=#__codelineno-7-16></a><span class=k>def</span><span class=w> </span><span class=nf>init_memory</span><span class=p>(</span><span class=n>target_shape</span><span class=p>):</span>
</span><span id=__span-7-17><a id=__codelineno-7-17 name=__codelineno-7-17 href=#__codelineno-7-17></a>    <span class=k>return</span> <span class=n>Memory</span><span class=p>(</span>
</span><span id=__span-7-18><a id=__codelineno-7-18 name=__codelineno-7-18 href=#__codelineno-7-18></a>        <span class=n>signal_executed</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>target_shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=kc>False</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-7-19><a id=__codelineno-7-19 name=__codelineno-7-19 href=#__codelineno-7-19></a>    <span class=p>)</span>
</span><span id=__span-7-20><a id=__codelineno-7-20 name=__codelineno-7-20 href=#__codelineno-7-20></a>
</span><span id=__span-7-21><a id=__codelineno-7-21 name=__codelineno-7-21 href=#__codelineno-7-21></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-7-22><a id=__codelineno-7-22 name=__codelineno-7-22 href=#__codelineno-7-22></a>    <span class=o>...</span><span class=p>,</span>
</span><span id=__span-7-23><a id=__codelineno-7-23 name=__codelineno-7-23 href=#__codelineno-7-23></a>    <span class=n>entries</span><span class=o>=</span><span class=n>entries</span><span class=p>,</span>
</span><span id=__span-7-24><a id=__codelineno-7-24 name=__codelineno-7-24 href=#__codelineno-7-24></a>    <span class=n>exits</span><span class=o>=</span><span class=n>exits</span><span class=p>,</span>
</span><span id=__span-7-25><a id=__codelineno-7-25 name=__codelineno-7-25 href=#__codelineno-7-25></a>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-7-26><a id=__codelineno-7-26 name=__codelineno-7-26 href=#__codelineno-7-26></a>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-7-27><a id=__codelineno-7-27 name=__codelineno-7-27 href=#__codelineno-7-27></a>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;entries&quot;</span><span class=p>),</span> 
</span><span id=__span-7-28><a id=__codelineno-7-28 name=__codelineno-7-28 href=#__codelineno-7-28></a>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;exits&quot;</span><span class=p>),</span> 
</span><span id=__span-7-29><a id=__codelineno-7-29 name=__codelineno-7-29 href=#__codelineno-7-29></a>        <span class=n>vbt</span><span class=o>.</span><span class=n>RepFunc</span><span class=p>(</span><span class=n>init_memory</span><span class=p>)</span>
</span><span id=__span-7-30><a id=__codelineno-7-30 name=__codelineno-7-30 href=#__codelineno-7-30></a>    <span class=p>)</span>
</span><span id=__span-7-31><a id=__codelineno-7-31 name=__codelineno-7-31 href=#__codelineno-7-31></a><span class=p>)</span>
</span></code></pre></div> <ol> <li>Read the element under the current column.</li> <li>Write the element under the current column.</li> <li>Create a boolean array filled with False, with one element per column.</li> </ol> <div class=separator-container> <hr class=separator> <span class=separator-text>+</span> <hr class=separator> </div> <p>To overcome the limitation of having only one active built-in limit order at a time, you can create custom limit orders. This allows you to have multiple active orders at once. Store relevant data in memory and manually check if the limit order price has been reached on each bar. When the price is hit, simply generate a signal.</p> <div class="language-python highlight"><span class=filename>Breakout strategy by straddling current price with opposing limit orders</span><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=n>Memory</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s2>&quot;Memory&quot;</span><span class=p>,</span> <span class=p>[</span><span class=s2>&quot;signal_price&quot;</span><span class=p>])</span>  <span class=c1># (1)!</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=nd>@njit</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=k>def</span><span class=w> </span><span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>signals</span><span class=p>,</span> <span class=n>memory</span><span class=p>,</span> <span class=n>limit_delta</span><span class=p>):</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>    <span class=k>if</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>memory</span><span class=o>.</span><span class=n>signal_price</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]):</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>        <span class=n>signal</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>signals</span><span class=p>)</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a>        <span class=k>if</span> <span class=n>signal</span><span class=p>:</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>            <span class=n>memory</span><span class=o>.</span><span class=n>signal_price</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>close</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a>    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a>        <span class=nb>open</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>open</span><span class=p>)</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a>        <span class=n>high</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>high</span><span class=p>)</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a>        <span class=n>low</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>low</span><span class=p>)</span>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a>        <span class=n>close</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>close</span><span class=p>)</span>
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a>        <span class=n>above_price</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>resolve_limit_price_nb</span><span class=p>(</span>  <span class=c1># (3)!</span>
</span><span id=__span-8-15><a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a>            <span class=n>init_price</span><span class=o>=</span><span class=n>memory</span><span class=o>.</span><span class=n>signal_price</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-8-16><a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a>            <span class=n>limit_delta</span><span class=o>=</span><span class=n>limit_delta</span><span class=p>,</span>
</span><span id=__span-8-17><a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a>            <span class=n>hit_below</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-8-18><a id=__codelineno-8-18 name=__codelineno-8-18 href=#__codelineno-8-18></a>        <span class=p>)</span>
</span><span id=__span-8-19><a id=__codelineno-8-19 name=__codelineno-8-19 href=#__codelineno-8-19></a>        <span class=n>hit_price</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>check_price_hit_nb</span><span class=p>(</span>  <span class=c1># (4)!</span>
</span><span id=__span-8-20><a id=__codelineno-8-20 name=__codelineno-8-20 href=#__codelineno-8-20></a>            <span class=nb>open</span><span class=o>=</span><span class=nb>open</span><span class=p>,</span>
</span><span id=__span-8-21><a id=__codelineno-8-21 name=__codelineno-8-21 href=#__codelineno-8-21></a>            <span class=n>high</span><span class=o>=</span><span class=n>high</span><span class=p>,</span>
</span><span id=__span-8-22><a id=__codelineno-8-22 name=__codelineno-8-22 href=#__codelineno-8-22></a>            <span class=n>low</span><span class=o>=</span><span class=n>low</span><span class=p>,</span>
</span><span id=__span-8-23><a id=__codelineno-8-23 name=__codelineno-8-23 href=#__codelineno-8-23></a>            <span class=n>close</span><span class=o>=</span><span class=n>close</span><span class=p>,</span>
</span><span id=__span-8-24><a id=__codelineno-8-24 name=__codelineno-8-24 href=#__codelineno-8-24></a>            <span class=n>price</span><span class=o>=</span><span class=n>above_price</span><span class=p>,</span>
</span><span id=__span-8-25><a id=__codelineno-8-25 name=__codelineno-8-25 href=#__codelineno-8-25></a>            <span class=n>hit_below</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-8-26><a id=__codelineno-8-26 name=__codelineno-8-26 href=#__codelineno-8-26></a>        <span class=p>)</span>
</span><span id=__span-8-27><a id=__codelineno-8-27 name=__codelineno-8-27 href=#__codelineno-8-27></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>hit_price</span><span class=p>):</span>
</span><span id=__span-8-28><a id=__codelineno-8-28 name=__codelineno-8-28 href=#__codelineno-8-28></a>            <span class=n>memory</span><span class=o>.</span><span class=n>signal_price</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span>
</span><span id=__span-8-29><a id=__codelineno-8-29 name=__codelineno-8-29 href=#__codelineno-8-29></a>            <span class=k>return</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>  <span class=c1># (5)!</span>
</span><span id=__span-8-30><a id=__codelineno-8-30 name=__codelineno-8-30 href=#__codelineno-8-30></a>        <span class=n>below_price</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>resolve_limit_price_nb</span><span class=p>(</span>  <span class=c1># (6)!</span>
</span><span id=__span-8-31><a id=__codelineno-8-31 name=__codelineno-8-31 href=#__codelineno-8-31></a>            <span class=n>init_price</span><span class=o>=</span><span class=n>memory</span><span class=o>.</span><span class=n>signal_price</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-8-32><a id=__codelineno-8-32 name=__codelineno-8-32 href=#__codelineno-8-32></a>            <span class=n>limit_delta</span><span class=o>=</span><span class=n>limit_delta</span><span class=p>,</span>
</span><span id=__span-8-33><a id=__codelineno-8-33 name=__codelineno-8-33 href=#__codelineno-8-33></a>            <span class=n>hit_below</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-8-34><a id=__codelineno-8-34 name=__codelineno-8-34 href=#__codelineno-8-34></a>        <span class=p>)</span>
</span><span id=__span-8-35><a id=__codelineno-8-35 name=__codelineno-8-35 href=#__codelineno-8-35></a>        <span class=n>hit_price</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>check_price_hit_nb</span><span class=p>(</span>
</span><span id=__span-8-36><a id=__codelineno-8-36 name=__codelineno-8-36 href=#__codelineno-8-36></a>            <span class=nb>open</span><span class=o>=</span><span class=nb>open</span><span class=p>,</span>
</span><span id=__span-8-37><a id=__codelineno-8-37 name=__codelineno-8-37 href=#__codelineno-8-37></a>            <span class=n>high</span><span class=o>=</span><span class=n>high</span><span class=p>,</span>
</span><span id=__span-8-38><a id=__codelineno-8-38 name=__codelineno-8-38 href=#__codelineno-8-38></a>            <span class=n>low</span><span class=o>=</span><span class=n>low</span><span class=p>,</span>
</span><span id=__span-8-39><a id=__codelineno-8-39 name=__codelineno-8-39 href=#__codelineno-8-39></a>            <span class=n>close</span><span class=o>=</span><span class=n>close</span><span class=p>,</span>
</span><span id=__span-8-40><a id=__codelineno-8-40 name=__codelineno-8-40 href=#__codelineno-8-40></a>            <span class=n>price</span><span class=o>=</span><span class=n>below_price</span><span class=p>,</span>
</span><span id=__span-8-41><a id=__codelineno-8-41 name=__codelineno-8-41 href=#__codelineno-8-41></a>            <span class=n>hit_below</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-8-42><a id=__codelineno-8-42 name=__codelineno-8-42 href=#__codelineno-8-42></a>        <span class=p>)</span>
</span><span id=__span-8-43><a id=__codelineno-8-43 name=__codelineno-8-43 href=#__codelineno-8-43></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>hit_price</span><span class=p>):</span>
</span><span id=__span-8-44><a id=__codelineno-8-44 name=__codelineno-8-44 href=#__codelineno-8-44></a>            <span class=n>memory</span><span class=o>.</span><span class=n>signal_price</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span>
</span><span id=__span-8-45><a id=__codelineno-8-45 name=__codelineno-8-45 href=#__codelineno-8-45></a>            <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-8-46><a id=__codelineno-8-46 name=__codelineno-8-46 href=#__codelineno-8-46></a>    <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-8-47><a id=__codelineno-8-47 name=__codelineno-8-47 href=#__codelineno-8-47></a>
</span><span id=__span-8-48><a id=__codelineno-8-48 name=__codelineno-8-48 href=#__codelineno-8-48></a><span class=k>def</span><span class=w> </span><span class=nf>init_memory</span><span class=p>(</span><span class=n>target_shape</span><span class=p>):</span>
</span><span id=__span-8-49><a id=__codelineno-8-49 name=__codelineno-8-49 href=#__codelineno-8-49></a>    <span class=k>return</span> <span class=n>Memory</span><span class=p>(</span>
</span><span id=__span-8-50><a id=__codelineno-8-50 name=__codelineno-8-50 href=#__codelineno-8-50></a>        <span class=n>signal_price</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>target_shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span><span id=__span-8-51><a id=__codelineno-8-51 name=__codelineno-8-51 href=#__codelineno-8-51></a>    <span class=p>)</span>
</span><span id=__span-8-52><a id=__codelineno-8-52 name=__codelineno-8-52 href=#__codelineno-8-52></a>
</span><span id=__span-8-53><a id=__codelineno-8-53 name=__codelineno-8-53 href=#__codelineno-8-53></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-8-54><a id=__codelineno-8-54 name=__codelineno-8-54 href=#__codelineno-8-54></a>    <span class=o>...</span><span class=p>,</span>
</span><span id=__span-8-55><a id=__codelineno-8-55 name=__codelineno-8-55 href=#__codelineno-8-55></a>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-8-56><a id=__codelineno-8-56 name=__codelineno-8-56 href=#__codelineno-8-56></a>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-8-57><a id=__codelineno-8-57 name=__codelineno-8-57 href=#__codelineno-8-57></a>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;signals&quot;</span><span class=p>),</span> 
</span><span id=__span-8-58><a id=__codelineno-8-58 name=__codelineno-8-58 href=#__codelineno-8-58></a>        <span class=n>vbt</span><span class=o>.</span><span class=n>RepFunc</span><span class=p>(</span><span class=n>init_memory</span><span class=p>),</span>
</span><span id=__span-8-59><a id=__codelineno-8-59 name=__codelineno-8-59 href=#__codelineno-8-59></a>        <span class=mf>0.1</span>
</span><span id=__span-8-60><a id=__codelineno-8-60 name=__codelineno-8-60 href=#__codelineno-8-60></a>    <span class=p>),</span>
</span><span id=__span-8-61><a id=__codelineno-8-61 name=__codelineno-8-61 href=#__codelineno-8-61></a>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-8-62><a id=__codelineno-8-62 name=__codelineno-8-62 href=#__codelineno-8-62></a>        <span class=n>signals</span><span class=o>=</span><span class=n>signals</span>
</span><span id=__span-8-63><a id=__codelineno-8-63 name=__codelineno-8-63 href=#__codelineno-8-63></a>    <span class=p>)</span>
</span><span id=__span-8-64><a id=__codelineno-8-64 name=__codelineno-8-64 href=#__codelineno-8-64></a><span class=p>)</span>
</span></code></pre></div> <ol> <li>Memory with a single array: the price at the time when the latest user signal occurred.</li> <li>Whenever a user signal occurs, save the current price and skip the current bar.</li> <li>Resolve the limit price (i.e., signal price plus delta) for going long.</li> <li>Check whether the limit price has been hit.</li> <li>If so, clear the memory for this asset and return a long entry.</li> <li>The same logic applies for a short entry.</li> </ol> <div class=separator-container> <hr class=separator> <span class=separator-text>+</span> <hr class=separator> </div> <p>If signals are generated dynamically and only a subset are actually executed, you may want to keep track of all generated signals for later analysis. To do this, use function templates to create <strong>global</strong> custom arrays and fill these arrays during the simulation.</p> <div class="language-python highlight"><span class=filename>Place entries and exits randomly and access them outside the simulation</span><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=n>custom_arrays</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>()</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=k>def</span><span class=w> </span><span class=nf>create_entries_out</span><span class=p>(</span><span class=n>wrapper</span><span class=p>):</span>  <span class=c1># (1)!</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a>    <span class=n>entries_out</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>wrapper</span><span class=o>.</span><span class=n>shape_2d</span><span class=p>,</span> <span class=kc>False</span><span class=p>)</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>    <span class=n>custom_arrays</span><span class=p>[</span><span class=s2>&quot;entries&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>entries_out</span>  <span class=c1># (2)!</span>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a>    <span class=k>return</span> <span class=n>entries_out</span>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=k>def</span><span class=w> </span><span class=nf>create_exits_out</span><span class=p>(</span><span class=n>wrapper</span><span class=p>):</span>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a>    <span class=n>exits_out</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>wrapper</span><span class=o>.</span><span class=n>shape_2d</span><span class=p>,</span> <span class=kc>False</span><span class=p>)</span>
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a>    <span class=n>custom_arrays</span><span class=p>[</span><span class=s2>&quot;exits&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>exits_out</span>
</span><span id=__span-9-11><a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a>    <span class=k>return</span> <span class=n>exits_out</span>
</span><span id=__span-9-12><a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a>
</span><span id=__span-9-13><a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a><span class=nd>@njit</span>
</span><span id=__span-9-14><a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a><span class=k>def</span><span class=w> </span><span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>entry_prob</span><span class=p>,</span> <span class=n>exit_prob</span><span class=p>,</span> <span class=n>entries_out</span><span class=p>,</span> <span class=n>exits_out</span><span class=p>):</span>
</span><span id=__span-9-15><a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a>    <span class=n>entry_prob_now</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>entry_prob</span><span class=p>)</span>
</span><span id=__span-9-16><a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a>    <span class=n>exit_prob_now</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>exit_prob</span><span class=p>)</span>
</span><span id=__span-9-17><a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a>    <span class=k>if</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>entry_prob_now</span><span class=p>:</span>
</span><span id=__span-9-18><a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a>        <span class=n>is_entry</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-9-19><a id=__codelineno-9-19 name=__codelineno-9-19 href=#__codelineno-9-19></a>        <span class=n>entries_out</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>  <span class=c1># (3)!</span>
</span><span id=__span-9-20><a id=__codelineno-9-20 name=__codelineno-9-20 href=#__codelineno-9-20></a>    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-9-21><a id=__codelineno-9-21 name=__codelineno-9-21 href=#__codelineno-9-21></a>        <span class=n>is_entry</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-9-22><a id=__codelineno-9-22 name=__codelineno-9-22 href=#__codelineno-9-22></a>    <span class=k>if</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>exit_prob_now</span><span class=p>:</span>
</span><span id=__span-9-23><a id=__codelineno-9-23 name=__codelineno-9-23 href=#__codelineno-9-23></a>        <span class=n>is_exit</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-9-24><a id=__codelineno-9-24 name=__codelineno-9-24 href=#__codelineno-9-24></a>        <span class=n>exits_out</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-9-25><a id=__codelineno-9-25 name=__codelineno-9-25 href=#__codelineno-9-25></a>    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-9-26><a id=__codelineno-9-26 name=__codelineno-9-26 href=#__codelineno-9-26></a>        <span class=n>is_exit</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-9-27><a id=__codelineno-9-27 name=__codelineno-9-27 href=#__codelineno-9-27></a>    <span class=k>return</span> <span class=n>is_entry</span><span class=p>,</span> <span class=n>is_exit</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-9-28><a id=__codelineno-9-28 name=__codelineno-9-28 href=#__codelineno-9-28></a>
</span><span id=__span-9-29><a id=__codelineno-9-29 name=__codelineno-9-29 href=#__codelineno-9-29></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-9-30><a id=__codelineno-9-30 name=__codelineno-9-30 href=#__codelineno-9-30></a>    <span class=o>...</span><span class=p>,</span>
</span><span id=__span-9-31><a id=__codelineno-9-31 name=__codelineno-9-31 href=#__codelineno-9-31></a>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-9-32><a id=__codelineno-9-32 name=__codelineno-9-32 href=#__codelineno-9-32></a>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-9-33><a id=__codelineno-9-33 name=__codelineno-9-33 href=#__codelineno-9-33></a>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;entry_prob&quot;</span><span class=p>),</span> 
</span><span id=__span-9-34><a id=__codelineno-9-34 name=__codelineno-9-34 href=#__codelineno-9-34></a>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;exit_prob&quot;</span><span class=p>),</span> 
</span><span id=__span-9-35><a id=__codelineno-9-35 name=__codelineno-9-35 href=#__codelineno-9-35></a>        <span class=n>vbt</span><span class=o>.</span><span class=n>RepFunc</span><span class=p>(</span><span class=n>create_entries_out</span><span class=p>),</span>  <span class=c1># (4)!</span>
</span><span id=__span-9-36><a id=__codelineno-9-36 name=__codelineno-9-36 href=#__codelineno-9-36></a>        <span class=n>vbt</span><span class=o>.</span><span class=n>RepFunc</span><span class=p>(</span><span class=n>create_exits_out</span><span class=p>),</span>
</span><span id=__span-9-37><a id=__codelineno-9-37 name=__codelineno-9-37 href=#__codelineno-9-37></a>    <span class=p>),</span>
</span><span id=__span-9-38><a id=__codelineno-9-38 name=__codelineno-9-38 href=#__codelineno-9-38></a>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-9-39><a id=__codelineno-9-39 name=__codelineno-9-39 href=#__codelineno-9-39></a>        <span class=n>entry_prob</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
</span><span id=__span-9-40><a id=__codelineno-9-40 name=__codelineno-9-40 href=#__codelineno-9-40></a>        <span class=n>exit_prob</span><span class=o>=</span><span class=mf>0.1</span>
</span><span id=__span-9-41><a id=__codelineno-9-41 name=__codelineno-9-41 href=#__codelineno-9-41></a>    <span class=p>)</span>
</span><span id=__span-9-42><a id=__codelineno-9-42 name=__codelineno-9-42 href=#__codelineno-9-42></a><span class=p>)</span>
</span><span id=__span-9-43><a id=__codelineno-9-43 name=__codelineno-9-43 href=#__codelineno-9-43></a>
</span><span id=__span-9-44><a id=__codelineno-9-44 name=__codelineno-9-44 href=#__codelineno-9-44></a><span class=nb>print</span><span class=p>(</span><span class=n>custom_arrays</span><span class=p>)</span>
</span></code></pre></div> <ol> <li>Function to create an empty NumPy array. The wrapper contains the shape of the simulation.</li> <li>Store a reference to the array for later use.</li> <li>Write information to the array.</li> <li>Use a template to call the function once the shape of the simulation is known.</li> </ol> <div class=separator-container> <hr class=separator> <span class=separator-text>+</span> <hr class=separator> </div> <p>To limit the number of active positions within a group, disable any entry signal in a custom signal function whenever the limit has been reached. The exit signal should be allowed to execute at any time.</p> <div class="language-python highlight"><span class=filename>Allow at most one active position at a time</span><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=nd>@njit</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=k>def</span><span class=w> </span><span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>entries</span><span class=p>,</span> <span class=n>exits</span><span class=p>,</span> <span class=n>max_active_positions</span><span class=p>):</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>    <span class=n>is_entry</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>entries</span><span class=p>)</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a>    <span class=n>is_exit</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>exits</span><span class=p>)</span>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a>    <span class=n>n_active_positions</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>get_n_active_positions_nb</span><span class=p>(</span><span class=n>c</span><span class=p>)</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a>    <span class=k>if</span> <span class=n>n_active_positions</span> <span class=o>&gt;=</span> <span class=n>max_active_positions</span><span class=p>:</span>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a>        <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=n>is_exit</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>  <span class=c1># (1)!</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a>    <span class=k>return</span> <span class=n>is_entry</span><span class=p>,</span> <span class=n>is_exit</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a>
</span><span id=__span-10-10><a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-10-11><a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a>    <span class=o>...</span><span class=p>,</span>
</span><span id=__span-10-12><a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a>    <span class=n>entries</span><span class=o>=</span><span class=n>entries</span><span class=p>,</span>
</span><span id=__span-10-13><a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a>    <span class=n>exits</span><span class=o>=</span><span class=n>exits</span><span class=p>,</span>
</span><span id=__span-10-14><a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-10-15><a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;entries&quot;</span><span class=p>),</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;exits&quot;</span><span class=p>),</span> <span class=mi>1</span><span class=p>),</span>
</span><span id=__span-10-16><a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a>    <span class=n>group_by</span><span class=o>=</span><span class=kc>True</span>  <span class=c1># (2)!</span>
</span><span id=__span-10-17><a id=__codelineno-10-17 name=__codelineno-10-17 href=#__codelineno-10-17></a><span class=p>)</span>
</span></code></pre></div> <ol> <li>Disable any entry signal.</li> <li>Combine all assets into one group. This can be customized.</li> </ol> <div class=separator-container> <hr class=separator> <span class=separator-text>+</span> <hr class=separator> </div> <p>To access information on the current or previous position, query the position information records.</p> <div class="language-python highlight"><span class=filename>Ignore entries for a number of days after a losing trade</span><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=nd>@njit</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=k>def</span><span class=w> </span><span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>entries</span><span class=p>,</span> <span class=n>exits</span><span class=p>,</span> <span class=n>cooldown</span><span class=p>):</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a>    <span class=n>entry</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>entries</span><span class=p>)</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a>    <span class=n>exit</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>exits</span><span class=p>)</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>in_position_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a>        <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>has_orders_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a>            <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>last_pos_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>][</span><span class=s2>&quot;pnl&quot;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>  <span class=c1># (1)!</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a>                <span class=n>last_exit_idx</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_pos_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>][</span><span class=s2>&quot;exit_idx&quot;</span><span class=p>]</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a>                <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>c</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>last_exit_idx</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>cooldown</span><span class=p>:</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a>                    <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=n>exit</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a>    <span class=k>return</span> <span class=n>entry</span><span class=p>,</span> <span class=n>exit</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-11-14><a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a>    <span class=o>...</span><span class=p>,</span>
</span><span id=__span-11-15><a id=__codelineno-11-15 name=__codelineno-11-15 href=#__codelineno-11-15></a>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-11-16><a id=__codelineno-11-16 name=__codelineno-11-16 href=#__codelineno-11-16></a>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-11-17><a id=__codelineno-11-17 name=__codelineno-11-17 href=#__codelineno-11-17></a>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;entries&quot;</span><span class=p>),</span> 
</span><span id=__span-11-18><a id=__codelineno-11-18 name=__codelineno-11-18 href=#__codelineno-11-18></a>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;exits&quot;</span><span class=p>),</span> 
</span><span id=__span-11-19><a id=__codelineno-11-19 name=__codelineno-11-19 href=#__codelineno-11-19></a>        <span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s2>&quot;7D&quot;</span><span class=p>))</span>
</span><span id=__span-11-20><a id=__codelineno-11-20 name=__codelineno-11-20 href=#__codelineno-11-20></a>    <span class=p>)</span>
</span><span id=__span-11-21><a id=__codelineno-11-21 name=__codelineno-11-21 href=#__codelineno-11-21></a><span class=p>)</span>
</span></code></pre></div> <ol> <li>If not in a position, the position information records contain information about the last (closed) position.</li> <li>Cooldown should be an integer representing the number of nanoseconds. Any timedelta should be converted to nanoseconds before execution.</li> </ol> <div class=separator-container> <hr class=separator> <span class=separator-text>+</span> <hr class=separator> </div> <p>To activate a stop-loss (SL) or another stop order after a certain condition is met, set it initially to infinity. Then, update the stop value in a callback once the condition is satisfied.</p> <div class="language-python highlight"><span class=filename>Set SL to breakeven after price has moved a certain %</span><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=nd>@njit</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=k>def</span><span class=w> </span><span class=nf>adjust_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>perc</span><span class=p>):</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a>    <span class=o>...</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a>    <span class=n>sl_info</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_sl_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a>    <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>np</span><span class=o>.</span><span class=n>isinf</span><span class=p>(</span><span class=n>sl_info</span><span class=p>[</span><span class=s2>&quot;stop&quot;</span><span class=p>]):</span>  <span class=c1># (1)!</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a>        <span class=n>prev_close</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>close</span><span class=p>,</span> <span class=n>i</span><span class=o>=</span><span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a>        <span class=n>price_change</span> <span class=o>=</span> <span class=n>prev_close</span> <span class=o>/</span> <span class=n>sl_info</span><span class=p>[</span><span class=s2>&quot;init_price&quot;</span><span class=p>]</span> <span class=o>-</span> <span class=mi>1</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a>        <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>last_position</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a>            <span class=n>price_change</span> <span class=o>*=</span> <span class=o>-</span><span class=mi>1</span>
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a>        <span class=k>if</span> <span class=n>price_change</span> <span class=o>&gt;=</span> <span class=n>perc</span><span class=p>:</span>
</span><span id=__span-12-11><a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a>            <span class=n>sl_info</span><span class=p>[</span><span class=s2>&quot;stop&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=mf>0.0</span>  <span class=c1># (2)!</span>
</span><span id=__span-12-12><a id=__codelineno-12-12 name=__codelineno-12-12 href=#__codelineno-12-12></a>
</span><span id=__span-12-13><a id=__codelineno-12-13 name=__codelineno-12-13 href=#__codelineno-12-13></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-12-14><a id=__codelineno-12-14 name=__codelineno-12-14 href=#__codelineno-12-14></a>    <span class=o>...</span><span class=p>,</span>
</span><span id=__span-12-15><a id=__codelineno-12-15 name=__codelineno-12-15 href=#__codelineno-12-15></a>    <span class=n>sl_stop</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span>
</span><span id=__span-12-16><a id=__codelineno-12-16 name=__codelineno-12-16 href=#__codelineno-12-16></a>    <span class=n>stop_entry_price</span><span class=o>=</span><span class=s2>&quot;fillprice&quot;</span><span class=p>,</span>
</span><span id=__span-12-17><a id=__codelineno-12-17 name=__codelineno-12-17 href=#__codelineno-12-17></a>    <span class=n>adjust_func_nb</span><span class=o>=</span><span class=n>adjust_func_nb</span><span class=p>,</span> 
</span><span id=__span-12-18><a id=__codelineno-12-18 name=__codelineno-12-18 href=#__codelineno-12-18></a>    <span class=n>adjust_args</span><span class=o>=</span><span class=p>(</span><span class=mf>0.1</span><span class=p>,),</span>
</span><span id=__span-12-19><a id=__codelineno-12-19 name=__codelineno-12-19 href=#__codelineno-12-19></a><span class=p>)</span>
</span></code></pre></div> <ol> <li>SL has not yet been activated.</li> <li>Activate an SL order by setting the stop price to the initial price.</li> </ol> <div class=separator-container> <hr class=separator> <span class=separator-text>+</span> <hr class=separator> </div> <p>The stop value can be updated not just once, but on every bar.</p> <div class="language-python highlight"><span class=filename>ATR-based TSL order</span><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=nd>@njit</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=k>def</span><span class=w> </span><span class=nf>adjust_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>atr</span><span class=p>):</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a>    <span class=o>...</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a>    <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a>        <span class=n>tsl_info</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_tsl_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a>        <span class=n>tsl_info</span><span class=p>[</span><span class=s2>&quot;stop&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>atr</span><span class=p>,</span> <span class=n>i</span><span class=o>=</span><span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a>    <span class=o>...</span><span class=p>,</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a>    <span class=n>tsl_stop</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a>    <span class=n>stop_entry_price</span><span class=o>=</span><span class=s2>&quot;fillprice&quot;</span><span class=p>,</span>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12 href=#__codelineno-13-12></a>    <span class=n>delta_format</span><span class=o>=</span><span class=s2>&quot;absolute&quot;</span><span class=p>,</span>
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13 href=#__codelineno-13-13></a>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>atr</span><span class=o>=</span><span class=n>atr</span><span class=p>),</span>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14 href=#__codelineno-13-14></a>    <span class=n>adjust_func_nb</span><span class=o>=</span><span class=n>adjust_func_nb</span><span class=p>,</span>
</span><span id=__span-13-15><a id=__codelineno-13-15 name=__codelineno-13-15 href=#__codelineno-13-15></a>    <span class=n>adjust_args</span><span class=o>=</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;atr&quot;</span><span class=p>),)</span>
</span><span id=__span-13-16><a id=__codelineno-13-16 name=__codelineno-13-16 href=#__codelineno-13-16></a><span class=p>)</span>
</span></code></pre></div> <div class=separator-container> <hr class=separator> <span class=separator-text>+</span> <hr class=separator> </div> <p>To set a ladder dynamically, use <code>stop_ladder="dynamic"</code> and then use the current ladder step in a callback to pull information from a custom array and override the stop information with that value.</p> <div class="language-python highlight"><span class=filename>Set a ladder based on ATR multipliers</span><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=nd>@njit</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=k>def</span><span class=w> </span><span class=nf>adjust_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>atr</span><span class=p>,</span> <span class=n>multipliers</span><span class=p>,</span> <span class=n>exit_sizes</span><span class=p>):</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a>    <span class=n>tp_info</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_tp_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a>    <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>is_stop_info_ladder_active_nb</span><span class=p>(</span><span class=n>tp_info</span><span class=p>):</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a>        <span class=k>if</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>tp_info</span><span class=p>[</span><span class=s2>&quot;stop&quot;</span><span class=p>]):</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a>            <span class=n>step</span> <span class=o>=</span> <span class=n>tp_info</span><span class=p>[</span><span class=s2>&quot;step&quot;</span><span class=p>]</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a>            <span class=n>init_atr</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>atr</span><span class=p>,</span> <span class=n>i</span><span class=o>=</span><span class=n>tp_info</span><span class=p>[</span><span class=s2>&quot;init_idx&quot;</span><span class=p>])</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a>            <span class=n>tp_info</span><span class=p>[</span><span class=s2>&quot;stop&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>init_atr</span> <span class=o>*</span> <span class=n>multipliers</span><span class=p>[</span><span class=n>step</span><span class=p>]</span>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a>            <span class=n>tp_info</span><span class=p>[</span><span class=s2>&quot;delta_format&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>DeltaFormat</span><span class=o>.</span><span class=n>Absolute</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a>            <span class=n>tp_info</span><span class=p>[</span><span class=s2>&quot;exit_size&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>exit_sizes</span><span class=p>[</span><span class=n>step</span><span class=p>]</span>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a>            <span class=n>tp_info</span><span class=p>[</span><span class=s2>&quot;exit_size_type&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>SizeType</span><span class=o>.</span><span class=n>Percent</span>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14 href=#__codelineno-14-14></a>    <span class=o>...</span><span class=p>,</span>
</span><span id=__span-14-15><a id=__codelineno-14-15 name=__codelineno-14-15 href=#__codelineno-14-15></a>    <span class=n>adjust_func_nb</span><span class=o>=</span><span class=n>adjust_func_nb</span><span class=p>,</span>
</span><span id=__span-14-16><a id=__codelineno-14-16 name=__codelineno-14-16 href=#__codelineno-14-16></a>    <span class=n>adjust_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-14-17><a id=__codelineno-14-17 name=__codelineno-14-17 href=#__codelineno-14-17></a>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;atr&quot;</span><span class=p>),</span>
</span><span id=__span-14-18><a id=__codelineno-14-18 name=__codelineno-14-18 href=#__codelineno-14-18></a>        <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>]),</span>
</span><span id=__span-14-19><a id=__codelineno-14-19 name=__codelineno-14-19 href=#__codelineno-14-19></a>        <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>])</span>
</span><span id=__span-14-20><a id=__codelineno-14-20 name=__codelineno-14-20 href=#__codelineno-14-20></a>    <span class=p>),</span>
</span><span id=__span-14-21><a id=__codelineno-14-21 name=__codelineno-14-21 href=#__codelineno-14-21></a>    <span class=n>stop_ladder</span><span class=o>=</span><span class=s2>&quot;dynamic&quot;</span><span class=p>,</span>
</span><span id=__span-14-22><a id=__codelineno-14-22 name=__codelineno-14-22 href=#__codelineno-14-22></a>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>atr</span><span class=o>=</span><span class=n>atr</span><span class=p>)</span>
</span><span id=__span-14-23><a id=__codelineno-14-23 name=__codelineno-14-23 href=#__codelineno-14-23></a><span class=p>)</span>
</span></code></pre></div> <div class=separator-container> <hr class=separator> <span class=separator-text>+</span> <hr class=separator> </div> <p>Position metrics, such as the current open P&amp;L and return, are available through the <code>last_pos_info</code> context field. This is an array with one record per column, using the data type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.trade_dt>trade_dt</a>.</p> <div class="language-python highlight"><span class=filename>By hitting an unrealized profit of 100%, lock in 50% of it with SL</span><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=nd>@njit</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=k>def</span><span class=w> </span><span class=nf>adjust_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>):</span>  <span class=c1># (1)!</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a>    <span class=n>pos_info</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_pos_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a>    <span class=k>if</span> <span class=n>pos_info</span><span class=p>[</span><span class=s2>&quot;status&quot;</span><span class=p>]</span> <span class=o>==</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>TradeStatus</span><span class=o>.</span><span class=n>Open</span><span class=p>:</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a>        <span class=k>if</span> <span class=n>pos_info</span><span class=p>[</span><span class=s2>&quot;return&quot;</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>x</span><span class=p>:</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a>            <span class=n>sl_info</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_sl_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a>            <span class=k>if</span> <span class=ow>not</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>is_stop_info_active_nb</span><span class=p>(</span><span class=n>sl_info</span><span class=p>):</span>
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a>                <span class=n>entry_price</span> <span class=o>=</span> <span class=n>pos_info</span><span class=p>[</span><span class=s2>&quot;entry_price&quot;</span><span class=p>]</span>
</span><span id=__span-15-9><a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a>                <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>in_long_position_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span><span id=__span-15-10><a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a>                    <span class=n>x_price</span> <span class=o>=</span> <span class=n>entry_price</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>x</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-15-11><a id=__codelineno-15-11 name=__codelineno-15-11 href=#__codelineno-15-11></a>                    <span class=n>y_price</span> <span class=o>=</span> <span class=n>entry_price</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>y</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-15-12><a id=__codelineno-15-12 name=__codelineno-15-12 href=#__codelineno-15-12></a>                <span class=k>else</span><span class=p>:</span>
</span><span id=__span-15-13><a id=__codelineno-15-13 name=__codelineno-15-13 href=#__codelineno-15-13></a>                    <span class=n>x_price</span> <span class=o>=</span> <span class=n>entry_price</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>x</span><span class=p>)</span>
</span><span id=__span-15-14><a id=__codelineno-15-14 name=__codelineno-15-14 href=#__codelineno-15-14></a>                    <span class=n>y_price</span> <span class=o>=</span> <span class=n>entry_price</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>y</span><span class=p>)</span>
</span><span id=__span-15-15><a id=__codelineno-15-15 name=__codelineno-15-15 href=#__codelineno-15-15></a>                <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>set_sl_info_nb</span><span class=p>(</span>
</span><span id=__span-15-16><a id=__codelineno-15-16 name=__codelineno-15-16 href=#__codelineno-15-16></a>                    <span class=n>sl_info</span><span class=p>,</span> 
</span><span id=__span-15-17><a id=__codelineno-15-17 name=__codelineno-15-17 href=#__codelineno-15-17></a>                    <span class=n>init_idx</span><span class=o>=</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> 
</span><span id=__span-15-18><a id=__codelineno-15-18 name=__codelineno-15-18 href=#__codelineno-15-18></a>                    <span class=n>init_price</span><span class=o>=</span><span class=n>x_price</span><span class=p>,</span>
</span><span id=__span-15-19><a id=__codelineno-15-19 name=__codelineno-15-19 href=#__codelineno-15-19></a>                    <span class=n>stop</span><span class=o>=</span><span class=n>y_price</span><span class=p>,</span>
</span><span id=__span-15-20><a id=__codelineno-15-20 name=__codelineno-15-20 href=#__codelineno-15-20></a>                    <span class=n>delta_format</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>DeltaFormat</span><span class=o>.</span><span class=n>Target</span>
</span><span id=__span-15-21><a id=__codelineno-15-21 name=__codelineno-15-21 href=#__codelineno-15-21></a>                <span class=p>)</span>
</span><span id=__span-15-22><a id=__codelineno-15-22 name=__codelineno-15-22 href=#__codelineno-15-22></a>
</span><span id=__span-15-23><a id=__codelineno-15-23 name=__codelineno-15-23 href=#__codelineno-15-23></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-15-24><a id=__codelineno-15-24 name=__codelineno-15-24 href=#__codelineno-15-24></a>    <span class=o>...</span><span class=p>,</span> 
</span><span id=__span-15-25><a id=__codelineno-15-25 name=__codelineno-15-25 href=#__codelineno-15-25></a>    <span class=n>adjust_func_nb</span><span class=o>=</span><span class=n>adjust_func_nb</span><span class=p>,</span>
</span><span id=__span-15-26><a id=__codelineno-15-26 name=__codelineno-15-26 href=#__codelineno-15-26></a>    <span class=n>adjust_args</span><span class=o>=</span><span class=p>(</span><span class=mf>1.0</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>)</span>
</span><span id=__span-15-27><a id=__codelineno-15-27 name=__codelineno-15-27 href=#__codelineno-15-27></a><span class=p>)</span>
</span></code></pre></div> <ol> <li>Both arguments (x = return as %, y = SL as %) should be provided as single values.</li> <li>The SL is triggered at the price where <code>x</code> was reached.</li> <li>The target price of the SL is calculated relative to the entry price so that <code>x</code> and <code>y</code> use the same scale (for example, 10% and 10% -&gt; 0% final return).</li> </ol> <div class=separator-container> <hr class=separator> <span class=separator-text>+</span> <hr class=separator> </div> <p>To dynamically determine and apply an optimal position size, create an empty size array filled with NaN. Then, in a callback, calculate the target size and write it to the size array.</p> <div class="language-python highlight"><span class=filename>Risk only 1% of the cash balance with each trade</span><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=nd>@njit</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=k>def</span><span class=w> </span><span class=nf>adjust_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>size</span><span class=p>,</span> <span class=n>sl_stop</span><span class=p>,</span> <span class=n>delta_format</span><span class=p>,</span> <span class=n>risk_amount</span><span class=p>):</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a>    <span class=n>close_now</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>close</span><span class=p>)</span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a>    <span class=n>sl_stop_now</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>sl_stop</span><span class=p>)</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a>    <span class=n>delta_format_now</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>delta_format</span><span class=p>)</span>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a>    <span class=n>risk_amount_now</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>risk_amount</span><span class=p>)</span>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a>    <span class=n>free_cash_now</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>get_free_cash_nb</span><span class=p>(</span><span class=n>c</span><span class=p>)</span>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a>
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a>    <span class=n>stop_price</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>resolve_stop_price_nb</span><span class=p>(</span>
</span><span id=__span-16-10><a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a>        <span class=n>init_price</span><span class=o>=</span><span class=n>close_now</span><span class=p>,</span>
</span><span id=__span-16-11><a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a>        <span class=n>stop</span><span class=o>=</span><span class=n>sl_stop_now</span><span class=p>,</span>
</span><span id=__span-16-12><a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a>        <span class=n>delta_format</span><span class=o>=</span><span class=n>delta_format_now</span><span class=p>,</span>
</span><span id=__span-16-13><a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a>        <span class=n>hit_below</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-16-14><a id=__codelineno-16-14 name=__codelineno-16-14 href=#__codelineno-16-14></a>    <span class=p>)</span>
</span><span id=__span-16-15><a id=__codelineno-16-15 name=__codelineno-16-15 href=#__codelineno-16-15></a>    <span class=n>price_diff</span> <span class=o>=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>close_now</span> <span class=o>-</span> <span class=n>stop_price</span><span class=p>)</span>
</span><span id=__span-16-16><a id=__codelineno-16-16 name=__codelineno-16-16 href=#__codelineno-16-16></a>    <span class=n>size</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>risk_amount_now</span> <span class=o>*</span> <span class=n>free_cash_now</span> <span class=o>/</span> <span class=n>price_diff</span>
</span><span id=__span-16-17><a id=__codelineno-16-17 name=__codelineno-16-17 href=#__codelineno-16-17></a>
</span><span id=__span-16-18><a id=__codelineno-16-18 name=__codelineno-16-18 href=#__codelineno-16-18></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-16-19><a id=__codelineno-16-19 name=__codelineno-16-19 href=#__codelineno-16-19></a>    <span class=o>...</span><span class=p>,</span>
</span><span id=__span-16-20><a id=__codelineno-16-20 name=__codelineno-16-20 href=#__codelineno-16-20></a>    <span class=n>adjust_func_nb</span><span class=o>=</span><span class=n>adjust_func_nb</span><span class=p>,</span>
</span><span id=__span-16-21><a id=__codelineno-16-21 name=__codelineno-16-21 href=#__codelineno-16-21></a>    <span class=n>adjust_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-16-22><a id=__codelineno-16-22 name=__codelineno-16-22 href=#__codelineno-16-22></a>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;size&quot;</span><span class=p>),</span> 
</span><span id=__span-16-23><a id=__codelineno-16-23 name=__codelineno-16-23 href=#__codelineno-16-23></a>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;sl_stop&quot;</span><span class=p>),</span> 
</span><span id=__span-16-24><a id=__codelineno-16-24 name=__codelineno-16-24 href=#__codelineno-16-24></a>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;delta_format&quot;</span><span class=p>),</span> 
</span><span id=__span-16-25><a id=__codelineno-16-25 name=__codelineno-16-25 href=#__codelineno-16-25></a>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;risk_amount&quot;</span><span class=p>)</span>
</span><span id=__span-16-26><a id=__codelineno-16-26 name=__codelineno-16-26 href=#__codelineno-16-26></a>    <span class=p>),</span>
</span><span id=__span-16-27><a id=__codelineno-16-27 name=__codelineno-16-27 href=#__codelineno-16-27></a>    <span class=n>size</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>RepFunc</span><span class=p>(</span><span class=k>lambda</span> <span class=n>wrapper</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>wrapper</span><span class=o>.</span><span class=n>shape_2d</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)),</span>
</span><span id=__span-16-28><a id=__codelineno-16-28 name=__codelineno-16-28 href=#__codelineno-16-28></a>    <span class=n>sl_stop</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
</span><span id=__span-16-29><a id=__codelineno-16-29 name=__codelineno-16-29 href=#__codelineno-16-29></a>    <span class=n>delta_format</span><span class=o>=</span><span class=s2>&quot;percent&quot;</span><span class=p>,</span>
</span><span id=__span-16-30><a id=__codelineno-16-30 name=__codelineno-16-30 href=#__codelineno-16-30></a>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>risk_amount</span><span class=o>=</span><span class=mf>0.01</span><span class=p>)</span>
</span><span id=__span-16-31><a id=__codelineno-16-31 name=__codelineno-16-31 href=#__codelineno-16-31></a><span class=p>)</span>
</span></code></pre></div> <div class=separator-container> <hr class=separator> <span class=separator-text>+</span> <hr class=separator> </div> <p>To ensure SL/TP considers the average entry price, rather than just the first order entry price, when accumulation is enabled, set the initial price of the stop record to the position's entry price.</p> <div class="language-python highlight"><span class=filename>Apply an SL of 10% to the accumulated position</span><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=nd>@njit</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=k>def</span><span class=w> </span><span class=nf>post_signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a>    <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_increased_position_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a>        <span class=n>c</span><span class=o>.</span><span class=n>last_sl_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>][</span><span class=s2>&quot;init_price&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_pos_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>][</span><span class=s2>&quot;entry_price&quot;</span><span class=p>]</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a>    <span class=o>...</span><span class=p>,</span>
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a>    <span class=n>accumulate</span><span class=o>=</span><span class=s2>&quot;addonly&quot;</span><span class=p>,</span>
</span><span id=__span-17-9><a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a>    <span class=n>sl_stop</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
</span><span id=__span-17-10><a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a>    <span class=n>post_signal_func_nb</span><span class=o>=</span><span class=n>post_signal_func_nb</span><span class=p>,</span>
</span><span id=__span-17-11><a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a><span class=p>)</span>
</span></code></pre></div> <div class=separator-container> <hr class=separator> <span class=separator-text>+</span> <hr class=separator> </div> <p>To check at the end of a bar whether a signal has been executed, use <code>post_signal_func_nb</code> or <code>post_segment_func_nb</code>. The first is called right after an order is executed and can access the result of the executed order through <code>c.order_result</code>. The second is called after all columns in the current group have been processed (just one column if there is no grouping), cash deposits and earnings have been applied, and the portfolio value and returns have been updated.</p> <div class="language-python highlight"><span class=filename>Apply a 20% tax on any positive P&L generated from closing out a position</span><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=nd>@njit</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=k>def</span><span class=w> </span><span class=nf>post_signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>cash_earnings</span><span class=p>,</span> <span class=n>tax</span><span class=p>):</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a>    <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_closed_position_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a>        <span class=n>pos_info</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_pos_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a>        <span class=n>pnl</span> <span class=o>=</span> <span class=n>pos_info</span><span class=p>[</span><span class=s2>&quot;pnl&quot;</span><span class=p>]</span>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a>        <span class=k>if</span> <span class=n>pnl</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a>            <span class=n>cash_earnings</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=n>tax</span> <span class=o>*</span> <span class=n>pnl</span>
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a>
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a><span class=n>tax</span> <span class=o>=</span> <span class=mf>0.2</span>
</span><span id=__span-18-10><a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-18-11><a id=__codelineno-18-11 name=__codelineno-18-11 href=#__codelineno-18-11></a>    <span class=o>...</span><span class=p>,</span>
</span><span id=__span-18-12><a id=__codelineno-18-12 name=__codelineno-18-12 href=#__codelineno-18-12></a>    <span class=n>post_signal_func_nb</span><span class=o>=</span><span class=n>post_signal_func_nb</span><span class=p>,</span>
</span><span id=__span-18-13><a id=__codelineno-18-13 name=__codelineno-18-13 href=#__codelineno-18-13></a>    <span class=n>post_signal_args</span><span class=o>=</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;cash_earnings&quot;</span><span class=p>),</span> <span class=n>tax</span><span class=p>),</span>
</span><span id=__span-18-14><a id=__codelineno-18-14 name=__codelineno-18-14 href=#__codelineno-18-14></a>    <span class=n>cash_earnings</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;np.full(wrapper.shape_2d, 0.0)&quot;</span><span class=p>)</span>
</span><span id=__span-18-15><a id=__codelineno-18-15 name=__codelineno-18-15 href=#__codelineno-18-15></a><span class=p>)</span>
</span></code></pre></div> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>An alternative approach after creating the portfolio:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=n>winning_positions</span> <span class=o>=</span> <span class=n>pf</span><span class=o>.</span><span class=n>positions</span><span class=o>.</span><span class=n>winning</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=n>winning_idxs</span> <span class=o>=</span> <span class=n>winning_positions</span><span class=o>.</span><span class=n>end_idx</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=n>winning_pnl</span> <span class=o>=</span> <span class=n>winning_positions</span><span class=o>.</span><span class=n>pnl</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=n>cash_earnings</span> <span class=o>=</span> <span class=n>pf</span><span class=o>.</span><span class=n>get_cash_earnings</span><span class=p>(</span><span class=n>group_by</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=k>if</span> <span class=n>pf</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>ndim</span> <span class=o>==</span> <span class=mi>2</span><span class=p>:</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a>    <span class=n>winning_cols</span> <span class=o>=</span> <span class=n>winning_positions</span><span class=o>.</span><span class=n>col_arr</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a>    <span class=n>cash_earnings</span><span class=o>.</span><span class=n>values</span><span class=p>[</span><span class=n>winning_idxs</span><span class=p>,</span> <span class=n>winning_cols</span><span class=p>]</span> <span class=o>+=</span> <span class=o>-</span><span class=n>tax</span> <span class=o>*</span> <span class=n>winning_pnl</span>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a><span class=k>else</span><span class=p>:</span>
</span><span id=__span-19-9><a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a>    <span class=n>cash_earnings</span><span class=o>.</span><span class=n>values</span><span class=p>[</span><span class=n>winning_idxs</span><span class=p>]</span> <span class=o>+=</span> <span class=o>-</span><span class=n>tax</span> <span class=o>*</span> <span class=n>winning_pnl</span>
</span><span id=__span-19-10><a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a><span class=n>new_pf</span> <span class=o>=</span> <span class=n>pf</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=n>cash_earnings</span><span class=o>=</span><span class=n>cash_earnings</span><span class=p>)</span>
</span></code></pre></div> </div> <div class=separator-container> <hr class=separator> <span class=separator-text>+</span> <hr class=separator> </div> <p>To access the running total return during the simulation, create an empty array for cumulative returns and update it within the <code>post_segment_func_nb</code> callback. The same array can be accessed by other callbacks to get the total return at any time step.</p> <div class="language-python highlight"><span class=filename>Access the running total return from within a simulation</span><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=nd>@njit</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=k>def</span><span class=w> </span><span class=nf>adjust_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>cum_return</span><span class=p>):</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a>    <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>cash_sharing</span><span class=p>:</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a>        <span class=n>total_return</span> <span class=o>=</span> <span class=n>cum_return</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>]</span> <span class=o>-</span> <span class=mi>1</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a>    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a>        <span class=n>total_return</span> <span class=o>=</span> <span class=n>cum_return</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>-</span> <span class=mi>1</span>
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a>    <span class=o>...</span>  <span class=c1># (1)!</span>
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a>
</span><span id=__span-20-9><a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a><span class=nd>@njit</span>
</span><span id=__span-20-10><a id=__codelineno-20-10 name=__codelineno-20-10 href=#__codelineno-20-10></a><span class=k>def</span><span class=w> </span><span class=nf>post_segment_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>cum_return</span><span class=p>):</span>
</span><span id=__span-20-11><a id=__codelineno-20-11 name=__codelineno-20-11 href=#__codelineno-20-11></a>    <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>cash_sharing</span><span class=p>:</span>
</span><span id=__span-20-12><a id=__codelineno-20-12 name=__codelineno-20-12 href=#__codelineno-20-12></a>        <span class=n>cum_return</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>]</span> <span class=o>*=</span> <span class=mi>1</span> <span class=o>+</span> <span class=n>c</span><span class=o>.</span><span class=n>last_return</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>]</span>
</span><span id=__span-20-13><a id=__codelineno-20-13 name=__codelineno-20-13 href=#__codelineno-20-13></a>    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-20-14><a id=__codelineno-20-14 name=__codelineno-20-14 href=#__codelineno-20-14></a>        <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>from_col</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>to_col</span><span class=p>):</span>
</span><span id=__span-20-15><a id=__codelineno-20-15 name=__codelineno-20-15 href=#__codelineno-20-15></a>            <span class=n>cum_return</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>*=</span> <span class=mi>1</span> <span class=o>+</span> <span class=n>c</span><span class=o>.</span><span class=n>last_return</span><span class=p>[</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-20-16><a id=__codelineno-20-16 name=__codelineno-20-16 href=#__codelineno-20-16></a>
</span><span id=__span-20-17><a id=__codelineno-20-17 name=__codelineno-20-17 href=#__codelineno-20-17></a><span class=n>cum_return</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-20-18><a id=__codelineno-20-18 name=__codelineno-20-18 href=#__codelineno-20-18></a><span class=k>def</span><span class=w> </span><span class=nf>init_cum_return</span><span class=p>(</span><span class=n>wrapper</span><span class=p>):</span>
</span><span id=__span-20-19><a id=__codelineno-20-19 name=__codelineno-20-19 href=#__codelineno-20-19></a>    <span class=k>global</span> <span class=n>cum_return</span>
</span><span id=__span-20-20><a id=__codelineno-20-20 name=__codelineno-20-20 href=#__codelineno-20-20></a>    <span class=k>if</span> <span class=n>cum_return</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-20-21><a id=__codelineno-20-21 name=__codelineno-20-21 href=#__codelineno-20-21></a>        <span class=n>cum_return</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>wrapper</span><span class=o>.</span><span class=n>shape_2d</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mf>1.0</span><span class=p>)</span>
</span><span id=__span-20-22><a id=__codelineno-20-22 name=__codelineno-20-22 href=#__codelineno-20-22></a>    <span class=k>return</span> <span class=n>cum_return</span>
</span><span id=__span-20-23><a id=__codelineno-20-23 name=__codelineno-20-23 href=#__codelineno-20-23></a>
</span><span id=__span-20-24><a id=__codelineno-20-24 name=__codelineno-20-24 href=#__codelineno-20-24></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-20-25><a id=__codelineno-20-25 name=__codelineno-20-25 href=#__codelineno-20-25></a>    <span class=o>...</span><span class=p>,</span>
</span><span id=__span-20-26><a id=__codelineno-20-26 name=__codelineno-20-26 href=#__codelineno-20-26></a>    <span class=n>adjust_func_nb</span><span class=o>=</span><span class=n>adjust_func_nb</span><span class=p>,</span>
</span><span id=__span-20-27><a id=__codelineno-20-27 name=__codelineno-20-27 href=#__codelineno-20-27></a>    <span class=n>adjust_args</span><span class=o>=</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>RepFunc</span><span class=p>(</span><span class=n>init_cum_return</span><span class=p>),),</span>
</span><span id=__span-20-28><a id=__codelineno-20-28 name=__codelineno-20-28 href=#__codelineno-20-28></a>    <span class=n>post_segment_func_nb</span><span class=o>=</span><span class=n>post_segment_func_nb</span><span class=p>,</span>
</span><span id=__span-20-29><a id=__codelineno-20-29 name=__codelineno-20-29 href=#__codelineno-20-29></a>    <span class=n>post_segment_args</span><span class=o>=</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>RepFunc</span><span class=p>(</span><span class=n>init_cum_return</span><span class=p>),),</span>
</span><span id=__span-20-30><a id=__codelineno-20-30 name=__codelineno-20-30 href=#__codelineno-20-30></a><span class=p>)</span>
</span></code></pre></div> <ol> <li>Your logic here.</li> </ol> <div class=separator-container> <hr class=separator> <span class=separator-text>+</span> <hr class=separator> </div> <p>You can use the same process to access the running trade records during the simulation.</p> <div class="language-python highlight"><span class=filename>Access the running trade records from within a simulation</span><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=kn>from</span><span class=w> </span><span class=nn>collections</span><span class=w> </span><span class=kn>import</span> <span class=n>namedtuple</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=n>TradeMemory</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s2>&quot;TradeMemory&quot;</span><span class=p>,</span> <span class=p>[</span><span class=s2>&quot;trade_records&quot;</span><span class=p>,</span> <span class=s2>&quot;trade_counts&quot;</span><span class=p>])</span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a><span class=nd>@njit</span>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a><span class=k>def</span><span class=w> </span><span class=nf>adjust_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>trade_memory</span><span class=p>):</span>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a>    <span class=n>trade_count</span> <span class=o>=</span> <span class=n>trade_memory</span><span class=o>.</span><span class=n>trade_counts</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a>    <span class=n>trade_records</span> <span class=o>=</span> <span class=n>trade_memory</span><span class=o>.</span><span class=n>trade_records</span><span class=p>[:</span><span class=n>trade_count</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-21-9><a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a>    <span class=o>...</span>  <span class=c1># (1)!</span>
</span><span id=__span-21-10><a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a>
</span><span id=__span-21-11><a id=__codelineno-21-11 name=__codelineno-21-11 href=#__codelineno-21-11></a><span class=nd>@njit</span>
</span><span id=__span-21-12><a id=__codelineno-21-12 name=__codelineno-21-12 href=#__codelineno-21-12></a><span class=k>def</span><span class=w> </span><span class=nf>post_signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>trade_memory</span><span class=p>):</span>
</span><span id=__span-21-13><a id=__codelineno-21-13 name=__codelineno-21-13 href=#__codelineno-21-13></a>    <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_filled_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span><span id=__span-21-14><a id=__codelineno-21-14 name=__codelineno-21-14 href=#__codelineno-21-14></a>        <span class=n>exit_trade_records</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>get_exit_trade_records_nb</span><span class=p>(</span><span class=n>c</span><span class=p>)</span>
</span><span id=__span-21-15><a id=__codelineno-21-15 name=__codelineno-21-15 href=#__codelineno-21-15></a>        <span class=n>trade_memory</span><span class=o>.</span><span class=n>trade_records</span><span class=p>[:</span><span class=nb>len</span><span class=p>(</span><span class=n>exit_trade_records</span><span class=p>),</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>exit_trade_records</span>
</span><span id=__span-21-16><a id=__codelineno-21-16 name=__codelineno-21-16 href=#__codelineno-21-16></a>        <span class=n>trade_memory</span><span class=o>.</span><span class=n>trade_counts</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>exit_trade_records</span><span class=p>)</span>
</span><span id=__span-21-17><a id=__codelineno-21-17 name=__codelineno-21-17 href=#__codelineno-21-17></a>
</span><span id=__span-21-18><a id=__codelineno-21-18 name=__codelineno-21-18 href=#__codelineno-21-18></a><span class=n>trade_memory</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-21-19><a id=__codelineno-21-19 name=__codelineno-21-19 href=#__codelineno-21-19></a><span class=k>def</span><span class=w> </span><span class=nf>init_trade_memory</span><span class=p>(</span><span class=n>target_shape</span><span class=p>):</span>
</span><span id=__span-21-20><a id=__codelineno-21-20 name=__codelineno-21-20 href=#__codelineno-21-20></a>    <span class=k>global</span> <span class=n>trade_memory</span>
</span><span id=__span-21-21><a id=__codelineno-21-21 name=__codelineno-21-21 href=#__codelineno-21-21></a>    <span class=k>if</span> <span class=n>trade_memory</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-21-22><a id=__codelineno-21-22 name=__codelineno-21-22 href=#__codelineno-21-22></a>        <span class=n>trade_memory</span> <span class=o>=</span> <span class=n>TradeMemory</span><span class=p>(</span>
</span><span id=__span-21-23><a id=__codelineno-21-23 name=__codelineno-21-23 href=#__codelineno-21-23></a>            <span class=n>trade_records</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>target_shape</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>trade_dt</span><span class=p>),</span>  <span class=c1># (2)!</span>
</span><span id=__span-21-24><a id=__codelineno-21-24 name=__codelineno-21-24 href=#__codelineno-21-24></a>            <span class=n>trade_counts</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>target_shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mi>0</span><span class=p>)</span>
</span><span id=__span-21-25><a id=__codelineno-21-25 name=__codelineno-21-25 href=#__codelineno-21-25></a>        <span class=p>)</span>
</span><span id=__span-21-26><a id=__codelineno-21-26 name=__codelineno-21-26 href=#__codelineno-21-26></a>    <span class=k>return</span> <span class=n>trade_memory</span>
</span><span id=__span-21-27><a id=__codelineno-21-27 name=__codelineno-21-27 href=#__codelineno-21-27></a>
</span><span id=__span-21-28><a id=__codelineno-21-28 name=__codelineno-21-28 href=#__codelineno-21-28></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_random_signals</span><span class=p>(</span>
</span><span id=__span-21-29><a id=__codelineno-21-29 name=__codelineno-21-29 href=#__codelineno-21-29></a>    <span class=o>...</span><span class=p>,</span>
</span><span id=__span-21-30><a id=__codelineno-21-30 name=__codelineno-21-30 href=#__codelineno-21-30></a>    <span class=n>post_signal_func_nb</span><span class=o>=</span><span class=n>post_signal_func_nb</span><span class=p>,</span>
</span><span id=__span-21-31><a id=__codelineno-21-31 name=__codelineno-21-31 href=#__codelineno-21-31></a>    <span class=n>post_signal_args</span><span class=o>=</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>RepFunc</span><span class=p>(</span><span class=n>init_trade_memory</span><span class=p>),),</span>
</span><span id=__span-21-32><a id=__codelineno-21-32 name=__codelineno-21-32 href=#__codelineno-21-32></a><span class=p>)</span>
</span></code></pre></div> <ol> <li>Your logic here.</li> <li>Create an array with the full shape to handle the worst case of one trade per bar. If you expect fewer trades, you can limit the number of rows in the shape.</li> </ol> <div class=separator-container> <hr class=separator> <span class=separator-text>+</span> <hr class=separator> </div> <p>To execute an SL (or any other order type) on the same bar as the entry, you can check whether the stop order is triggered on this bar and, if so, execute it as a regular signal on the next bar.</p> <div class="language-python highlight"><span class=filename>Execute each entry using open price and potentially SL at the same bar</span><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=n>Memory</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s2>&quot;Memory&quot;</span><span class=p>,</span> <span class=p>[</span><span class=s2>&quot;stop_price&quot;</span><span class=p>,</span> <span class=s2>&quot;order_type&quot;</span><span class=p>])</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=n>memory</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a><span class=k>def</span><span class=w> </span><span class=nf>init_memory</span><span class=p>(</span><span class=n>target_shape</span><span class=p>):</span>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a>    <span class=k>global</span> <span class=n>memory</span>
</span><span id=__span-22-6><a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a>    <span class=k>if</span> <span class=n>memory</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-22-7><a id=__codelineno-22-7 name=__codelineno-22-7 href=#__codelineno-22-7></a>        <span class=n>memory</span> <span class=o>=</span> <span class=n>Memory</span><span class=p>(</span>
</span><span id=__span-22-8><a id=__codelineno-22-8 name=__codelineno-22-8 href=#__codelineno-22-8></a>            <span class=n>stop_price</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>target_shape</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>),</span>
</span><span id=__span-22-9><a id=__codelineno-22-9 name=__codelineno-22-9 href=#__codelineno-22-9></a>            <span class=n>order_type</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>target_shape</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>),</span>
</span><span id=__span-22-10><a id=__codelineno-22-10 name=__codelineno-22-10 href=#__codelineno-22-10></a>        <span class=p>)</span>
</span><span id=__span-22-11><a id=__codelineno-22-11 name=__codelineno-22-11 href=#__codelineno-22-11></a>    <span class=k>return</span> <span class=n>memory</span>
</span><span id=__span-22-12><a id=__codelineno-22-12 name=__codelineno-22-12 href=#__codelineno-22-12></a>
</span><span id=__span-22-13><a id=__codelineno-22-13 name=__codelineno-22-13 href=#__codelineno-22-13></a><span class=nd>@njit</span>
</span><span id=__span-22-14><a id=__codelineno-22-14 name=__codelineno-22-14 href=#__codelineno-22-14></a><span class=k>def</span><span class=w> </span><span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>price</span><span class=p>,</span> <span class=n>memory</span><span class=p>,</span> <span class=o>...</span><span class=p>):</span>
</span><span id=__span-22-15><a id=__codelineno-22-15 name=__codelineno-22-15 href=#__codelineno-22-15></a>    <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>memory</span><span class=o>.</span><span class=n>stop_price</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]):</span>
</span><span id=__span-22-16><a id=__codelineno-22-16 name=__codelineno-22-16 href=#__codelineno-22-16></a>        <span class=n>price</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>memory</span><span class=o>.</span><span class=n>stop_price</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-22-17><a id=__codelineno-22-17 name=__codelineno-22-17 href=#__codelineno-22-17></a>        <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>True</span>
</span><span id=__span-22-18><a id=__codelineno-22-18 name=__codelineno-22-18 href=#__codelineno-22-18></a>    <span class=o>...</span>
</span><span id=__span-22-19><a id=__codelineno-22-19 name=__codelineno-22-19 href=#__codelineno-22-19></a>
</span><span id=__span-22-20><a id=__codelineno-22-20 name=__codelineno-22-20 href=#__codelineno-22-20></a>
</span><span id=__span-22-21><a id=__codelineno-22-21 name=__codelineno-22-21 href=#__codelineno-22-21></a><span class=nd>@njit</span>
</span><span id=__span-22-22><a id=__codelineno-22-22 name=__codelineno-22-22 href=#__codelineno-22-22></a><span class=k>def</span><span class=w> </span><span class=nf>post_signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>memory</span><span class=p>,</span> <span class=o>...</span><span class=p>):</span>
</span><span id=__span-22-23><a id=__codelineno-22-23 name=__codelineno-22-23 href=#__codelineno-22-23></a>    <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_opened_position_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span><span id=__span-22-24><a id=__codelineno-22-24 name=__codelineno-22-24 href=#__codelineno-22-24></a>        <span class=nb>open</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>open</span><span class=p>)</span>
</span><span id=__span-22-25><a id=__codelineno-22-25 name=__codelineno-22-25 href=#__codelineno-22-25></a>        <span class=n>high</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>high</span><span class=p>)</span>
</span><span id=__span-22-26><a id=__codelineno-22-26 name=__codelineno-22-26 href=#__codelineno-22-26></a>        <span class=n>low</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>low</span><span class=p>)</span>
</span><span id=__span-22-27><a id=__codelineno-22-27 name=__codelineno-22-27 href=#__codelineno-22-27></a>        <span class=n>close</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>close</span><span class=p>)</span>
</span><span id=__span-22-28><a id=__codelineno-22-28 name=__codelineno-22-28 href=#__codelineno-22-28></a>        <span class=n>sl_stop_price</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>check_stop_hit_nb</span><span class=p>(</span>
</span><span id=__span-22-29><a id=__codelineno-22-29 name=__codelineno-22-29 href=#__codelineno-22-29></a>            <span class=nb>open</span><span class=o>=</span><span class=nb>open</span><span class=p>,</span>
</span><span id=__span-22-30><a id=__codelineno-22-30 name=__codelineno-22-30 href=#__codelineno-22-30></a>            <span class=n>high</span><span class=o>=</span><span class=n>high</span><span class=p>,</span>
</span><span id=__span-22-31><a id=__codelineno-22-31 name=__codelineno-22-31 href=#__codelineno-22-31></a>            <span class=n>low</span><span class=o>=</span><span class=n>low</span><span class=p>,</span>
</span><span id=__span-22-32><a id=__codelineno-22-32 name=__codelineno-22-32 href=#__codelineno-22-32></a>            <span class=n>close</span><span class=o>=</span><span class=n>close</span><span class=p>,</span>
</span><span id=__span-22-33><a id=__codelineno-22-33 name=__codelineno-22-33 href=#__codelineno-22-33></a>            <span class=n>is_position_long</span><span class=o>=</span><span class=n>c</span><span class=o>.</span><span class=n>last_position</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>,</span>
</span><span id=__span-22-34><a id=__codelineno-22-34 name=__codelineno-22-34 href=#__codelineno-22-34></a>            <span class=n>init_price</span><span class=o>=</span><span class=n>c</span><span class=o>.</span><span class=n>last_sl_info</span><span class=p>[</span><span class=s2>&quot;init_price&quot;</span><span class=p>][</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-22-35><a id=__codelineno-22-35 name=__codelineno-22-35 href=#__codelineno-22-35></a>            <span class=n>stop</span><span class=o>=</span><span class=n>c</span><span class=o>.</span><span class=n>last_sl_info</span><span class=p>[</span><span class=s2>&quot;stop&quot;</span><span class=p>][</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-22-36><a id=__codelineno-22-36 name=__codelineno-22-36 href=#__codelineno-22-36></a>            <span class=n>delta_format</span><span class=o>=</span><span class=n>c</span><span class=o>.</span><span class=n>last_sl_info</span><span class=p>[</span><span class=s2>&quot;delta_format&quot;</span><span class=p>][</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-22-37><a id=__codelineno-22-37 name=__codelineno-22-37 href=#__codelineno-22-37></a>            <span class=n>hit_below</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-22-38><a id=__codelineno-22-38 name=__codelineno-22-38 href=#__codelineno-22-38></a>            <span class=n>can_use_ohlc</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-22-39><a id=__codelineno-22-39 name=__codelineno-22-39 href=#__codelineno-22-39></a>            <span class=n>check_open</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-22-40><a id=__codelineno-22-40 name=__codelineno-22-40 href=#__codelineno-22-40></a>            <span class=n>hard_stop</span><span class=o>=</span><span class=n>c</span><span class=o>.</span><span class=n>last_sl_info</span><span class=p>[</span><span class=s2>&quot;exit_price&quot;</span><span class=p>][</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>==</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>StopExitPrice</span><span class=o>.</span><span class=n>HardStop</span><span class=p>,</span>
</span><span id=__span-22-41><a id=__codelineno-22-41 name=__codelineno-22-41 href=#__codelineno-22-41></a>        <span class=p>)</span>
</span><span id=__span-22-42><a id=__codelineno-22-42 name=__codelineno-22-42 href=#__codelineno-22-42></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>sl_stop_price</span><span class=p>):</span>
</span><span id=__span-22-43><a id=__codelineno-22-43 name=__codelineno-22-43 href=#__codelineno-22-43></a>            <span class=n>memory</span><span class=o>.</span><span class=n>stop_price</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>sl_stop_price</span>
</span><span id=__span-22-44><a id=__codelineno-22-44 name=__codelineno-22-44 href=#__codelineno-22-44></a>            <span class=n>memory</span><span class=o>.</span><span class=n>order_type</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>sig_enums</span><span class=o>.</span><span class=n>StopType</span><span class=o>.</span><span class=n>SL</span>
</span><span id=__span-22-45><a id=__codelineno-22-45 name=__codelineno-22-45 href=#__codelineno-22-45></a>            <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>clear_sl_info_nb</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>last_sl_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>])</span>
</span><span id=__span-22-46><a id=__codelineno-22-46 name=__codelineno-22-46 href=#__codelineno-22-46></a>            <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>clear_tp_info_nb</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>last_tp_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>])</span>
</span><span id=__span-22-47><a id=__codelineno-22-47 name=__codelineno-22-47 href=#__codelineno-22-47></a>
</span><span id=__span-22-48><a id=__codelineno-22-48 name=__codelineno-22-48 href=#__codelineno-22-48></a>    <span class=k>elif</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_closed_position_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span><span id=__span-22-49><a id=__codelineno-22-49 name=__codelineno-22-49 href=#__codelineno-22-49></a>        <span class=k>if</span> <span class=n>memory</span><span class=o>.</span><span class=n>order_type</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>:</span>
</span><span id=__span-22-50><a id=__codelineno-22-50 name=__codelineno-22-50 href=#__codelineno-22-50></a>            <span class=n>order</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>order_records</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>order_counts</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-22-51><a id=__codelineno-22-51 name=__codelineno-22-51 href=#__codelineno-22-51></a>            <span class=n>order</span><span class=p>[</span><span class=s2>&quot;stop_type&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>memory</span><span class=o>.</span><span class=n>order_type</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-22-52><a id=__codelineno-22-52 name=__codelineno-22-52 href=#__codelineno-22-52></a>            <span class=n>order</span><span class=p>[</span><span class=s2>&quot;signal_idx&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span>
</span><span id=__span-22-53><a id=__codelineno-22-53 name=__codelineno-22-53 href=#__codelineno-22-53></a>            <span class=n>order</span><span class=p>[</span><span class=s2>&quot;creation_idx&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span>
</span><span id=__span-22-54><a id=__codelineno-22-54 name=__codelineno-22-54 href=#__codelineno-22-54></a>            <span class=n>order</span><span class=p>[</span><span class=s2>&quot;idx&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span>
</span><span id=__span-22-55><a id=__codelineno-22-55 name=__codelineno-22-55 href=#__codelineno-22-55></a>    <span class=o>...</span>
</span><span id=__span-22-56><a id=__codelineno-22-56 name=__codelineno-22-56 href=#__codelineno-22-56></a>
</span><span id=__span-22-57><a id=__codelineno-22-57 name=__codelineno-22-57 href=#__codelineno-22-57></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-22-58><a id=__codelineno-22-58 name=__codelineno-22-58 href=#__codelineno-22-58></a>    <span class=o>...</span><span class=p>,</span>
</span><span id=__span-22-59><a id=__codelineno-22-59 name=__codelineno-22-59 href=#__codelineno-22-59></a>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-22-60><a id=__codelineno-22-60 name=__codelineno-22-60 href=#__codelineno-22-60></a>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;price&quot;</span><span class=p>),</span> <span class=n>vbt</span><span class=o>.</span><span class=n>RepFunc</span><span class=p>(</span><span class=n>init_memory</span><span class=p>),</span> <span class=o>...</span><span class=p>),</span>
</span><span id=__span-22-61><a id=__codelineno-22-61 name=__codelineno-22-61 href=#__codelineno-22-61></a>    <span class=n>post_signal_func_nb</span><span class=o>=</span><span class=n>post_signal_func_nb</span><span class=p>,</span>
</span><span id=__span-22-62><a id=__codelineno-22-62 name=__codelineno-22-62 href=#__codelineno-22-62></a>    <span class=n>post_signal_args</span><span class=o>=</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>RepFunc</span><span class=p>(</span><span class=n>init_memory</span><span class=p>),</span> <span class=o>...</span><span class=p>),</span>
</span><span id=__span-22-63><a id=__codelineno-22-63 name=__codelineno-22-63 href=#__codelineno-22-63></a>    <span class=n>price</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>RepFunc</span><span class=p>(</span><span class=k>lambda</span> <span class=n>wrapper</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>wrapper</span><span class=o>.</span><span class=n>shape_2d</span><span class=p>,</span> <span class=o>-</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>)),</span>
</span><span id=__span-22-64><a id=__codelineno-22-64 name=__codelineno-22-64 href=#__codelineno-22-64></a>    <span class=n>sl_stop</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
</span><span id=__span-22-65><a id=__codelineno-22-65 name=__codelineno-22-65 href=#__codelineno-22-65></a>    <span class=n>stop_entry_price</span><span class=o>=</span><span class=s2>&quot;fillprice&quot;</span>
</span><span id=__span-22-66><a id=__codelineno-22-66 name=__codelineno-22-66 href=#__codelineno-22-66></a><span class=p>)</span>
</span></code></pre></div> <h2 id=records>Records<a class=headerlink href=#records title="Permanent link">&para;</a></h2> <p>There are several ways to examine the orders, trades, and positions generated by a simulation. Each one corresponds to a different concept in vectorbtpro. Be sure to understand their differences by reviewing the examples at the top of the <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/trades/ >trades</a> module.</p> <div class="language-python highlight"><span class=filename>Print out information on various records</span><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=nb>print</span><span class=p>(</span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>readable</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a><span class=nb>print</span><span class=p>(</span><span class=n>pf</span><span class=o>.</span><span class=n>entry_trades</span><span class=o>.</span><span class=n>readable</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a><span class=nb>print</span><span class=p>(</span><span class=n>pf</span><span class=o>.</span><span class=n>exit_trades</span><span class=o>.</span><span class=n>readable</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a><span class=nb>print</span><span class=p>(</span><span class=n>pf</span><span class=o>.</span><span class=n>trades</span><span class=o>.</span><span class=n>readable</span><span class=p>)</span>  <span class=c1># (4)!</span>
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a><span class=nb>print</span><span class=p>(</span><span class=n>pf</span><span class=o>.</span><span class=n>positions</span><span class=o>.</span><span class=n>readable</span><span class=p>)</span>  <span class=c1># (5)!</span>
</span><span id=__span-23-6><a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a>
</span><span id=__span-23-7><a id=__codelineno-23-7 name=__codelineno-23-7 href=#__codelineno-23-7></a><span class=nb>print</span><span class=p>(</span><span class=n>pf</span><span class=o>.</span><span class=n>trade_history</span><span class=p>)</span>  <span class=c1># (6)!</span>
</span></code></pre></div> <ol> <li>Information on orders.</li> <li>Information on trades that open or increase a position.</li> <li>Information on trades that close or decrease a position.</li> <li>Same as <code>exit_trades</code> by default.</li> <li>Information on positions.</li> <li>Information on orders and trades merged together.</li> </ol> <h2 id=metrics>Metrics<a class=headerlink href=#metrics title="Permanent link">&para;</a></h2> <p>By default, the year frequency is set to 365 days, assuming each trading day lasts 24 hours. However, for stocks or other securities, you should change it to 252 days or less. Also, consider trading hours when working with sub-daily data frequency.</p> <div class="language-python highlight"><span class=filename>Change the year frequency</span><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=n>vbt</span><span class=o>.</span><span class=n>settings</span><span class=o>.</span><span class=n>returns</span><span class=o>.</span><span class=n>year_freq</span> <span class=o>=</span> <span class=s2>&quot;auto&quot;</span>  <span class=c1># (1)!</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=n>vbt</span><span class=o>.</span><span class=n>settings</span><span class=o>.</span><span class=n>returns</span><span class=o>.</span><span class=n>year_freq</span> <span class=o>=</span> <span class=s2>&quot;252 days&quot;</span>  <span class=c1># (2)!</span>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=n>vbt</span><span class=o>.</span><span class=n>settings</span><span class=o>.</span><span class=n>returns</span><span class=o>.</span><span class=n>year_freq</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>252</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a><span class=n>vbt</span><span class=o>.</span><span class=n>settings</span><span class=o>.</span><span class=n>returns</span><span class=o>.</span><span class=n>year_freq</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>offsets</span><span class=o>.</span><span class=n>BDay</span><span class=p>()</span> <span class=o>*</span> <span class=mi>252</span>  <span class=c1># (4)!</span>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a><span class=n>vbt</span><span class=o>.</span><span class=n>settings</span><span class=o>.</span><span class=n>returns</span><span class=o>.</span><span class=n>year_freq</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Timedelta</span><span class=p>(</span><span class=n>hours</span><span class=o>=</span><span class=mf>6.5</span><span class=p>)</span> <span class=o>*</span> <span class=mi>252</span>  <span class=c1># (5)!</span>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a>
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a><span class=n>returns_df</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>returns</span><span class=p>(</span><span class=n>year_freq</span><span class=o>=</span><span class=s2>&quot;252 days&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>stats</span><span class=p>()</span>  <span class=c1># (6)!</span>
</span><span id=__span-24-9><a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>year_freq</span><span class=o>=</span><span class=s2>&quot;252 days&quot;</span><span class=p>)</span>  <span class=c1># (7)!</span>
</span></code></pre></div> <ol> <li>Determine the year frequency automatically.</li> <li>Change the year frequency to 252 days. Assumes daily frequency.</li> <li>Same as above, set as a timedelta.</li> <li>Same as above, set as a date offset (business days).</li> <li>Account for 6.5 trading hours per day. Assumes intra-daily frequency.</li> <li>Year frequency can also be set locally per DataFrame.</li> <li>Year frequency can also be passed directly to the portfolio.</li> </ol> <div class="admonition info"> <p class=admonition-title>Info</p> <p>The year frequency will be divided by the frequency of your data to calculate the annualization factor. For example, <code>pd.Timedelta(hours=6.5) * 252</code> divided by <code>15 minutes</code> will result in a factor of 6552.</p> </div> <div class=separator-container> <hr class=separator> <span class=separator-text>+</span> <hr class=separator> </div> <p>To tell VBT to place zero instead of infinity and NaN in any generated returns, create a <a href=https://vectorbt.pro/pvt_41531c19/cookbook/configuration/#settings>configuration</a> file with the following content:</p> <div class="tabbed-set tabbed-alternate" data-tabs=1:3><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><input id=__tabbed_1_2 name=__tabbed_1 type=radio><input id=__tabbed_1_3 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1>INI</label><label for=__tabbed_1_2>YAML</label><label for=__tabbed_1_3>TOML</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-ini highlight"><span class=filename>File vbt.cfg</span><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=k>[returns]</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=na>inf_to_nan</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>True</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=na>nan_to_zero</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>True</span>
</span></code></pre></div> </div> <div class=tabbed-block> <div class="language-yaml highlight"><span class=filename>File vbt.yml</span><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=nt>returns</span><span class=p>:</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=w>  </span><span class=nt>inf_to_nan</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a><span class=w>  </span><span class=nt>nan_to_zero</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span></code></pre></div> </div> <div class=tabbed-block> <div class="language-toml highlight"><span class=filename>File vbt.toml</span><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=k>[returns]</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=n>inf_to_nan</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=n>nan_to_zero</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span>
</span></code></pre></div> </div> </div> </div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>If this does not work, run <code>vbt.clear_pycache()</code> and restart the kernel.</p> </div> <div class=separator-container> <hr class=separator> <span class=separator-text>+</span> <hr class=separator> </div> <p>To compute a metric based on the returns or other time series of each trade, rather than for the entire equity, use projections to extract the time series range corresponding to each trade.</p> <div class="language-python highlight"><span class=filename>Calculate the average total log return of winning and losing trades</span><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=n>winning_trade_returns</span> <span class=o>=</span> <span class=n>pf</span><span class=o>.</span><span class=n>trades</span><span class=o>.</span><span class=n>winning</span><span class=o>.</span><span class=n>get_projections</span><span class=p>(</span><span class=n>pf</span><span class=o>.</span><span class=n>log_returns</span><span class=p>,</span> <span class=n>rebase</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=n>losing_trade_returns</span> <span class=o>=</span> <span class=n>pf</span><span class=o>.</span><span class=n>trades</span><span class=o>.</span><span class=n>losing</span><span class=o>.</span><span class=n>get_projections</span><span class=p>(</span><span class=n>pf</span><span class=o>.</span><span class=n>log_returns</span><span class=p>,</span> <span class=n>rebase</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a><span class=n>avg_winning_trade_return</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pd_acc</span><span class=o>.</span><span class=n>returns</span><span class=p>(</span><span class=n>winning_trade_returns</span><span class=p>,</span> <span class=n>log_returns</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span><span class=o>.</span><span class=n>total</span><span class=p>()</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a><span class=n>avg_losing_trade_return</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pd_acc</span><span class=o>.</span><span class=n>returns</span><span class=p>(</span><span class=n>losing_trade_returns</span><span class=p>,</span> <span class=n>log_returns</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span><span class=o>.</span><span class=n>total</span><span class=p>()</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></code></pre></div> <div class=separator-container> <hr class=separator> <span class=separator-text>+</span> <hr class=separator> </div> <p>To calculate a trade metric purely in Numba, convert order records to trade records, compute the column map for the trade records, and then reduce each column to a single number.</p> <div class="language-python highlight"><span class=filename>Calculate trade win rate in Numba</span><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=n>order_records</span> <span class=o>=</span> <span class=n>sim_out</span><span class=o>.</span><span class=n>order_records</span>  <span class=c1># (1)!</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a>
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a><span class=n>order_col_map</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>rec_nb</span><span class=o>.</span><span class=n>col_map_nb</span><span class=p>(</span>
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a>    <span class=n>order_records</span><span class=p>[</span><span class=s2>&quot;col&quot;</span><span class=p>],</span>
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a>    <span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>  <span class=c1># (2)!</span>
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a><span class=p>)</span>
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a><span class=n>trade_records</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>get_exit_trades_nb</span><span class=p>(</span>
</span><span id=__span-29-8><a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a>    <span class=n>order_records</span><span class=p>,</span> 
</span><span id=__span-29-9><a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a>    <span class=n>close</span><span class=p>,</span> 
</span><span id=__span-29-10><a id=__codelineno-29-10 name=__codelineno-29-10 href=#__codelineno-29-10></a>    <span class=n>order_col_map</span>
</span><span id=__span-29-11><a id=__codelineno-29-11 name=__codelineno-29-11 href=#__codelineno-29-11></a><span class=p>)</span>
</span><span id=__span-29-12><a id=__codelineno-29-12 name=__codelineno-29-12 href=#__codelineno-29-12></a><span class=n>trade_col_map</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>rec_nb</span><span class=o>.</span><span class=n>col_map_nb</span><span class=p>(</span>
</span><span id=__span-29-13><a id=__codelineno-29-13 name=__codelineno-29-13 href=#__codelineno-29-13></a>    <span class=n>trade_records</span><span class=p>[</span><span class=s2>&quot;col&quot;</span><span class=p>],</span> 
</span><span id=__span-29-14><a id=__codelineno-29-14 name=__codelineno-29-14 href=#__codelineno-29-14></a>    <span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-29-15><a id=__codelineno-29-15 name=__codelineno-29-15 href=#__codelineno-29-15></a><span class=p>)</span>
</span><span id=__span-29-16><a id=__codelineno-29-16 name=__codelineno-29-16 href=#__codelineno-29-16></a><span class=n>win_rate</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>rec_nb</span><span class=o>.</span><span class=n>reduce_mapped_nb</span><span class=p>(</span>
</span><span id=__span-29-17><a id=__codelineno-29-17 name=__codelineno-29-17 href=#__codelineno-29-17></a>    <span class=n>trade_records</span><span class=p>[</span><span class=s2>&quot;pnl&quot;</span><span class=p>],</span> 
</span><span id=__span-29-18><a id=__codelineno-29-18 name=__codelineno-29-18 href=#__codelineno-29-18></a>    <span class=n>trade_col_map</span><span class=p>,</span> 
</span><span id=__span-29-19><a id=__codelineno-29-19 name=__codelineno-29-19 href=#__codelineno-29-19></a>    <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> 
</span><span id=__span-29-20><a id=__codelineno-29-20 name=__codelineno-29-20 href=#__codelineno-29-20></a>    <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>win_rate_reduce_nb</span>
</span><span id=__span-29-21><a id=__codelineno-29-21 name=__codelineno-29-21 href=#__codelineno-29-21></a><span class=p>)</span>
</span></code></pre></div> <ol> <li>Simulation output is from a simulation function such as <code>from_signals_nb</code>.</li> <li>Close must be a two-dimensional NumPy array.</li> </ol> <div class=separator-container> <hr class=separator> <span class=separator-text>+</span> <hr class=separator> </div> <p>The same method applies to drawdown records, which are based on cumulative returns.</p> <div class="language-python highlight"><span class=filename>Calculate maximum drawdown duration in Numba</span><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=n>returns</span> <span class=o>=</span> <span class=n>sim_out</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>returns</span>
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a>
</span><span id=__span-30-3><a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a><span class=n>cumulative_returns</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>ret_nb</span><span class=o>.</span><span class=n>cumulative_returns_nb</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-30-4><a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a><span class=n>drawdown_records</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>get_drawdowns_nb</span><span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=n>cumulative_returns</span><span class=p>)</span>
</span><span id=__span-30-5><a id=__codelineno-30-5 name=__codelineno-30-5 href=#__codelineno-30-5></a><span class=n>dd_duration</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>range_duration_nb</span><span class=p>(</span>  <span class=c1># (2)!</span>
</span><span id=__span-30-6><a id=__codelineno-30-6 name=__codelineno-30-6 href=#__codelineno-30-6></a>    <span class=n>drawdown_records</span><span class=p>[</span><span class=s2>&quot;start_idx&quot;</span><span class=p>],</span> 
</span><span id=__span-30-7><a id=__codelineno-30-7 name=__codelineno-30-7 href=#__codelineno-30-7></a>    <span class=n>drawdown_records</span><span class=p>[</span><span class=s2>&quot;end_idx&quot;</span><span class=p>],</span> 
</span><span id=__span-30-8><a id=__codelineno-30-8 name=__codelineno-30-8 href=#__codelineno-30-8></a>    <span class=n>drawdown_records</span><span class=p>[</span><span class=s2>&quot;status&quot;</span><span class=p>]</span>
</span><span id=__span-30-9><a id=__codelineno-30-9 name=__codelineno-30-9 href=#__codelineno-30-9></a><span class=p>)</span>
</span><span id=__span-30-10><a id=__codelineno-30-10 name=__codelineno-30-10 href=#__codelineno-30-10></a><span class=n>dd_col_map</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>rec_nb</span><span class=o>.</span><span class=n>col_map_nb</span><span class=p>(</span>
</span><span id=__span-30-11><a id=__codelineno-30-11 name=__codelineno-30-11 href=#__codelineno-30-11></a>    <span class=n>drawdown_records</span><span class=p>[</span><span class=s2>&quot;col&quot;</span><span class=p>],</span>
</span><span id=__span-30-12><a id=__codelineno-30-12 name=__codelineno-30-12 href=#__codelineno-30-12></a>    <span class=n>returns</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-30-13><a id=__codelineno-30-13 name=__codelineno-30-13 href=#__codelineno-30-13></a><span class=p>)</span>
</span><span id=__span-30-14><a id=__codelineno-30-14 name=__codelineno-30-14 href=#__codelineno-30-14></a><span class=n>max_dd_duration</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>rec_nb</span><span class=o>.</span><span class=n>reduce_mapped_nb</span><span class=p>(</span>  <span class=c1># (3)!</span>
</span><span id=__span-30-15><a id=__codelineno-30-15 name=__codelineno-30-15 href=#__codelineno-30-15></a>    <span class=n>dd_duration</span><span class=p>,</span>
</span><span id=__span-30-16><a id=__codelineno-30-16 name=__codelineno-30-16 href=#__codelineno-30-16></a>    <span class=n>dd_col_map</span><span class=p>,</span>
</span><span id=__span-30-17><a id=__codelineno-30-17 name=__codelineno-30-17 href=#__codelineno-30-17></a>    <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-30-18><a id=__codelineno-30-18 name=__codelineno-30-18 href=#__codelineno-30-18></a>    <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>max_reduce_nb</span>
</span><span id=__span-30-19><a id=__codelineno-30-19 name=__codelineno-30-19 href=#__codelineno-30-19></a><span class=p>)</span>
</span></code></pre></div> <ol> <li>Expects a two-dimensional NumPy array.</li> <li>Returns one value per record.</li> <li>Returns one value per column.</li> </ol> <div class=separator-container> <hr class=separator> <span class=separator-text>+</span> <hr class=separator> </div> <p>Return metrics are not based on records and can be calculated directly from returns.</p> <div class="language-python highlight"><span class=filename>Calculate various return metrics in Numba</span><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=n>returns</span> <span class=o>=</span> <span class=n>sim_out</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>returns</span>
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a>
</span><span id=__span-31-3><a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a><span class=n>total_return</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>ret_nb</span><span class=o>.</span><span class=n>total_return_nb</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-31-4><a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a><span class=n>max_dd</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>ret_nb</span><span class=o>.</span><span class=n>max_drawdown_nb</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-31-5><a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a><span class=n>sharpe_ratio</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>ret_nb</span><span class=o>.</span><span class=n>sharpe_ratio_nb</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>ann_factor</span><span class=o>=</span><span class=n>ann_factor</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span></code></pre></div> <ol> <li>Expects a two-dimensional NumPy array.</li> <li>Returns one value per column.</li> <li>Annualization factor is the average number of bars in a year, such as 365.</li> </ol> <h2 id=metadata>Metadata<a class=headerlink href=#metadata title="Permanent link">&para;</a></h2> <p>You can access the columns and groups of the portfolio through its wrapper and grouper, respectively.</p> <div class="language-python highlight"><span class=filename>How to get the columns and groups of a Portfolio instance</span><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=nb>print</span><span class=p>(</span><span class=n>pf</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a><span class=nb>print</span><span class=p>(</span><span class=n>pf</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>grouper</span><span class=o>.</span><span class=n>is_grouped</span><span class=p>())</span>  <span class=c1># (2)!</span>
</span><span id=__span-32-3><a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a><span class=nb>print</span><span class=p>(</span><span class=n>pf</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>grouper</span><span class=o>.</span><span class=n>grouped_index</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-32-4><a id=__codelineno-32-4 name=__codelineno-32-4 href=#__codelineno-32-4></a><span class=nb>print</span><span class=p>(</span><span class=n>pf</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>get_columns</span><span class=p>())</span>  <span class=c1># (4)!</span>
</span><span id=__span-32-5><a id=__codelineno-32-5 name=__codelineno-32-5 href=#__codelineno-32-5></a>
</span><span id=__span-32-6><a id=__codelineno-32-6 name=__codelineno-32-6 href=#__codelineno-32-6></a><span class=n>columns_or_groups</span> <span class=o>=</span> <span class=n>pf</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>get_columns</span><span class=p>()</span>
</span><span id=__span-32-7><a id=__codelineno-32-7 name=__codelineno-32-7 href=#__codelineno-32-7></a><span class=n>first_pf</span> <span class=o>=</span> <span class=n>pf</span><span class=p>[</span><span class=n>columns_or_groups</span><span class=p>[</span><span class=mi>0</span><span class=p>]]</span>  <span class=c1># (5)!</span>
</span></code></pre></div> <ol> <li>Get the columns, regardless of any grouping.</li> <li>Check whether the object is grouped.</li> <li>If the above is True, get the groups.</li> <li>Get the columns or groups (if grouped). Recommended.</li> <li>Select the first column or group (if grouped) from the object.</li> </ol> <h2 id=stacking>Stacking<a class=headerlink href=#stacking title="Permanent link">&para;</a></h2> <p>Multiple compatible array-based strategies can be included in the same portfolio by stacking their respective arrays along the columns.</p> <div class="language-python highlight"><span class=filename>Simulate and analyze multiple strategies jointly</span><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a><span class=n>strategy_keys</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Index</span><span class=p>([</span><span class=s2>&quot;strategy1&quot;</span><span class=p>,</span> <span class=s2>&quot;strategy2&quot;</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;strategy&quot;</span><span class=p>)</span>
</span><span id=__span-33-2><a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a><span class=n>entries</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>((</span><span class=n>entries1</span><span class=p>,</span> <span class=n>entries2</span><span class=p>),</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>keys</span><span class=o>=</span><span class=n>strategy_keys</span><span class=p>)</span>
</span><span id=__span-33-3><a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a><span class=n>exits</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>((</span><span class=n>exits1</span><span class=p>,</span> <span class=n>exits2</span><span class=p>),</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>keys</span><span class=o>=</span><span class=n>strategy_keys</span><span class=p>)</span>
</span><span id=__span-33-4><a id=__codelineno-33-4 name=__codelineno-33-4 href=#__codelineno-33-4></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>entries</span><span class=p>,</span> <span class=n>exits</span><span class=p>)</span>
</span></code></pre></div> <div class=separator-container> <hr class=separator> <span class=separator-text>+</span> <hr class=separator> </div> <p>You can also stack multiple incompatible strategies—such as those requiring different simulation methods or argument combinations—by simulating them independently and then stacking them for joint analysis. This combines their data, order records, initial states, in-place output arrays, and more as if they were stacked before simulation, with grouping disabled.</p> <div class="language-python highlight"><span class=filename>Simulate multiple strategies separately but analyze them jointly</span><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=n>strategy_keys</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Index</span><span class=p>([</span><span class=s2>&quot;strategy1&quot;</span><span class=p>,</span> <span class=s2>&quot;strategy2&quot;</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;strategy&quot;</span><span class=p>)</span>
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a><span class=n>pf1</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>entries</span><span class=p>,</span> <span class=n>exits</span><span class=p>)</span>
</span><span id=__span-34-3><a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a><span class=n>pf2</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_orders</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>size</span><span class=p>,</span> <span class=n>price</span><span class=p>)</span>
</span><span id=__span-34-4><a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>column_stack</span><span class=p>((</span><span class=n>pf1</span><span class=p>,</span> <span class=n>pf2</span><span class=p>),</span> <span class=n>wrapper_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>keys</span><span class=o>=</span><span class=n>strategy_keys</span><span class=p>))</span>
</span><span id=__span-34-5><a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a>
</span><span id=__span-34-6><a id=__codelineno-34-6 name=__codelineno-34-6 href=#__codelineno-34-6></a><span class=c1># ______________________________________________________________</span>
</span><span id=__span-34-7><a id=__codelineno-34-7 name=__codelineno-34-7 href=#__codelineno-34-7></a>
</span><span id=__span-34-8><a id=__codelineno-34-8 name=__codelineno-34-8 href=#__codelineno-34-8></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>column_stack</span><span class=p>(</span>
</span><span id=__span-34-9><a id=__codelineno-34-9 name=__codelineno-34-9 href=#__codelineno-34-9></a>    <span class=p>(</span><span class=n>pf1</span><span class=p>,</span> <span class=n>pf2</span><span class=p>),</span> 
</span><span id=__span-34-10><a id=__codelineno-34-10 name=__codelineno-34-10 href=#__codelineno-34-10></a>    <span class=n>wrapper_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>keys</span><span class=o>=</span><span class=n>strategy_keys</span><span class=p>),</span> 
</span><span id=__span-34-11><a id=__codelineno-34-11 name=__codelineno-34-11 href=#__codelineno-34-11></a>    <span class=n>group_by</span><span class=o>=</span><span class=n>strategy_keys</span><span class=o>.</span><span class=n>name</span>  <span class=c1># (1)!</span>
</span><span id=__span-34-12><a id=__codelineno-34-12 name=__codelineno-34-12 href=#__codelineno-34-12></a><span class=p>)</span>
</span></code></pre></div> <ol> <li>Represent each portfolio as a group in the new portfolio.</li> </ol> <h2 id=parallelizing>Parallelizing<a class=headerlink href=#parallelizing title="Permanent link">&para;</a></h2> <p>If you want to simulate multiple columns (without cash sharing) or multiple groups (with or without cash sharing), you can easily parallelize execution in several ways.</p> <div class="language-python highlight"><span class=filename>How to parallelize simulation</span><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>chunked</span><span class=o>=</span><span class=s2>&quot;threadpool&quot;</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a>
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a><span class=c1># ______________________________________________________________</span>
</span><span id=__span-35-4><a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a>
</span><span id=__span-35-5><a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PF</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>jitted</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>parallel</span><span class=o>=</span><span class=kc>True</span><span class=p>))</span>  <span class=c1># (2)!</span>
</span></code></pre></div> <ol> <li>Use chunking with multithreading.</li> <li>Use automatic parallelization within Numba.</li> </ol> <p>You can also parallelize statistics after your portfolio has been simulated.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a><span class=nd>@vbt</span><span class=o>.</span><span class=n>chunked</span><span class=p>(</span><span class=n>engine</span><span class=o>=</span><span class=s2>&quot;threadpool&quot;</span><span class=p>)</span>
</span><span id=__span-36-2><a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a><span class=k>def</span><span class=w> </span><span class=nf>chunked_stats</span><span class=p>(</span><span class=n>pf</span><span class=p>:</span> <span class=n>vbt</span><span class=o>.</span><span class=n>ChunkedArray</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>))</span> <span class=o>-&gt;</span> <span class=s2>&quot;row_stack&quot;</span><span class=p>:</span>
</span><span id=__span-36-3><a id=__codelineno-36-3 name=__codelineno-36-3 href=#__codelineno-36-3></a>    <span class=k>return</span> <span class=n>pf</span><span class=o>.</span><span class=n>stats</span><span class=p>(</span><span class=n>agg_func</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span>
</span><span id=__span-36-4><a id=__codelineno-36-4 name=__codelineno-36-4 href=#__codelineno-36-4></a>
</span><span id=__span-36-5><a id=__codelineno-36-5 name=__codelineno-36-5 href=#__codelineno-36-5></a><span class=n>chunked_stats</span><span class=p>(</span><span class=n>pf</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-36-6><a id=__codelineno-36-6 name=__codelineno-36-6 href=#__codelineno-36-6></a>
</span><span id=__span-36-7><a id=__codelineno-36-7 name=__codelineno-36-7 href=#__codelineno-36-7></a><span class=c1># ______________________________________________________________</span>
</span><span id=__span-36-8><a id=__codelineno-36-8 name=__codelineno-36-8 href=#__codelineno-36-8></a>
</span><span id=__span-36-9><a id=__codelineno-36-9 name=__codelineno-36-9 href=#__codelineno-36-9></a><span class=n>pf</span><span class=o>.</span><span class=n>chunk_apply</span><span class=p>(</span>  <span class=c1># (2)!</span>
</span><span id=__span-36-10><a id=__codelineno-36-10 name=__codelineno-36-10 href=#__codelineno-36-10></a>    <span class=s2>&quot;stats&quot;</span><span class=p>,</span> 
</span><span id=__span-36-11><a id=__codelineno-36-11 name=__codelineno-36-11 href=#__codelineno-36-11></a>    <span class=n>agg_func</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> 
</span><span id=__span-36-12><a id=__codelineno-36-12 name=__codelineno-36-12 href=#__codelineno-36-12></a>    <span class=n>execute_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>engine</span><span class=o>=</span><span class=s2>&quot;threadpool&quot;</span><span class=p>,</span> <span class=n>merge_func</span><span class=o>=</span><span class=s2>&quot;row_stack&quot;</span><span class=p>)</span>
</span><span id=__span-36-13><a id=__codelineno-36-13 name=__codelineno-36-13 href=#__codelineno-36-13></a><span class=p>)</span>
</span><span id=__span-36-14><a id=__codelineno-36-14 name=__codelineno-36-14 href=#__codelineno-36-14></a>
</span><span id=__span-36-15><a id=__codelineno-36-15 name=__codelineno-36-15 href=#__codelineno-36-15></a><span class=c1># ______________________________________________________________</span>
</span><span id=__span-36-16><a id=__codelineno-36-16 name=__codelineno-36-16 href=#__codelineno-36-16></a>
</span><span id=__span-36-17><a id=__codelineno-36-17 name=__codelineno-36-17 href=#__codelineno-36-17></a><span class=n>pf</span><span class=o>.</span><span class=n>stats</span><span class=p>(</span><span class=n>agg_func</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>settings</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>jitted</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>parallel</span><span class=o>=</span><span class=kc>True</span><span class=p>)))</span>  <span class=c1># (3)!</span>
</span></code></pre></div> <ol> <li>Use chunking with multithreading.</li> <li>Same as above.</li> <li>Use automatic parallelization within Numba.</li> </ol> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/plotting/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Plotting"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Plotting </div> </div> </a> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/signals/ class="md-footer__link md-footer__link--next" aria-label="Next: Signals"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Signals </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2021-2025 Oleg Polakow. All rights reserved. </div> </div> <div class=md-social> <a href=https://www.linkedin.com/in/polakowo target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> <a href=https://github.com/polakowo target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <div class=md-consent data-md-component=consent id=__consent hidden> <div class=md-consent__overlay></div> <aside class=md-consent__inner> <form class="md-consent__form md-grid md-typeset" name=consent> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class=md-toggle type=checkbox id=__settings> <div class=md-consent__settings> <ul class=task-list> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=analytics checked> <span class=task-list-indicator></span> Google Analytics </label> </li> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=github checked> <span class=task-list-indicator></span> GitHub </label> </li> </ul> </div> <div class=md-consent__controls> <button class="md-button md-button--primary">Accept</button> <label class=md-button for=__settings>Manage settings</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script> <script id=__config type=application/json>{"annotate": null, "base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.instant", "navigation.instant.progress", "navigation.top", "navigation.prune", "navigation.path", "navigation.footer", "search.suggest", "search.share", "content.code.annotate", "content.code.copy", "content.code.select", "content.tooltips", "content.tabs.link", "toc.follow", "toc.integrate", "announce.dismiss"], "search": "../../assets/javascripts/workers/search.26099bd0.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=https://vectorbt.pro/pvt_41531c19/assets/javascripts/bundle.9d1edc04.min.js></script> <script src=https://vectorbt.pro/pvt_41531c19/assets/scripts/extra.js></script> <script src=https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js></script> </body> 
<!-- Mirrored from vectorbt.pro/pvt_41531c19/cookbook/portfolio/ by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 22 Nov 2025 03:46:35 GMT -->
</html>