<!doctype html><html lang=en class=no-js> 
<!-- Mirrored from vectorbt.pro/pvt_41531c19/documentation/portfolio/from-signals/ by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 22 Nov 2025 03:46:39 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Documentation on simulating portfolios based on signals in VectorBT PRO"><meta name=author content="Oleg Polakow"><link href=https://vectorbt.pro/documentation/portfolio/from-signals/ rel=canonical><link href=../from-orders/index.html rel=prev><link href=../../to-be-continued/index.html rel=next><link rel=icon href=../../../assets/logo/favicon.png><meta name=generator content="mkdocs-1.6.0, mkdocs-material-9.6.21+insiders-4.53.17"><title>From signals - VectorBTÂ® PRO</title><link rel=stylesheet href=../../../assets/stylesheets/main.010a373c.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=../../../../../fonts.gstatic.com/index.html crossorigin><link rel=stylesheet href="../../../../../fonts.googleapis.com/cssbe43.css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../assets/stylesheets/extra.css><link rel=stylesheet href=../../../assets/stylesheets/custom-light.css><link rel=stylesheet href=../../../assets/stylesheets/custom-dark.css><link rel=stylesheet href=../../../assets/stylesheets/pygments-light.css><link rel=stylesheet href=../../../assets/stylesheets/pygments-dark.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-0C5VNYCFHL"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-0C5VNYCFHL",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="../../../../../www.googletagmanager.com/gtag/jsc6c8?id=G-0C5VNYCFHL",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script><meta name=robots content="noindex, nofollow"><meta property=og:title content="From signals"><meta property=og:type content=website><meta content=https://vectorbt.pro/documentation/portfolio/from-signals/ property=og:url><meta property=og:image:url content=https://vectorbt.pro/pvt_41531c19/assets/logo/social-new.png><meta property=og:image:type content=image/png><meta property=og:description content="Documentation on simulating portfolios based on signals in VectorBT PRO"><meta property=og:locale content=en-GB><link rel=apple-touch-icon sizes=180x180 href=https://vectorbt.pro/pvt_41531c19/assets/logo/apple-touch-icon.png><link rel=icon type=image/svg+xml href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon.svg><link rel=icon type=image/png sizes=32x32 href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon-16x16.png><link rel=manifest href=https://vectorbt.pro/pvt_41531c19/assets/logo/site.webmanifest><link rel=mask-icon href=https://vectorbt.pro/pvt_41531c19/assets/logo/safari-pinned-tab.svg color=#1e1f22><link rel="shortcut icon" href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon.ico><meta name=msapplication-TileColor content=#1e1f22><meta name=msapplication-config content=https://vectorbt.pro/pvt_41531c19/assets/logo/browserconfig.xml><meta name=theme-color content=#1e1f22><link href=https://unpkg.com/aos@2.3.4/dist/aos.css rel=stylesheet><script src=https://unpkg.com/aos@2.3.4/dist/aos.js></script><link href=http://fonts.cdnfonts.com/css/uni-neue rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/js/all.min.js integrity="sha512-8pHNiqTlsrRjVD4A/3va++W1sMbUHwWxxRPWNyVlql3T+Hgfd81Qc6FC5WMXDC+tSauxxzp1tgiAvSKFu1qIlA==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js integrity="sha512-q583ppKrCRc7N5O0n2nzUiJ+suUv7Et1JGels4bXOaMFQcamPk9HjdUknZuuFjBNs7tsMuadge5k9RzdmO+1GQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><link rel=preconnect href=https://fonts.googleapis.com/><link rel=preconnect href=https://fonts.gstatic.com/ crossorigin></head> <body dir=ltr data-md-color-scheme=custom-dark data-md-color-primary=custom-dark data-md-color-accent=custom-dark> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#from-signals class=md-skip> Skip to content </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> <button class="md-banner__button md-icon" aria-label="Don't show this again"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> <i>What's new</i>: New LLM providers, reasoning steps, function calling, YAML & TOML support, and <a href=https://vectorbt.pro/pvt_41531c19/getting-started/release-notes><strong>more</strong></a> <span class="twemoji announce-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m153.6 29.9 16-21.3c4-5.4 10.4-8.6 17.1-8.6C198.4 0 208 9.6 208 21.3v22.1c0 13.1 5.4 25.7 14.9 34.7l84.7 80.9c48.8 46.6 76.4 111.2 76.4 178.7C384 434 306 512 209.7 512H192C86 512 0 426 0 320v-3.8c0-48.8 19.4-95.6 53.9-130.1l3.5-3.5c4.2-4.2 10-6.6 16-6.6 12.5 0 22.6 10.1 22.6 22.6V288c0 35.3 28.7 64 64 64s64-28.7 64-64v-3.9c0-18-7.2-35.3-19.9-48l-38.6-38.6c-24-24-37.5-56.7-37.5-90.7 0-27.7 9-54.8 25.6-76.9"/></svg></span> </div> <script>var el=document.querySelector("[data-md-component=announce]");if(el){var content=el.querySelector(".md-typeset");__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0)}</script> </aside> </div> <!-- Determine class according to configuration --> <!-- Header --> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=header.title> <!-- Link to home --> <a href=https://vectorbt.pro/pvt_41531c19/ title="VectorBTÂ® PRO" class="md-header__button md-logo" aria-label="VectorBTÂ® PRO" data-md-component=logo> <img src=https://vectorbt.pro/pvt_41531c19/assets/logo/logo.svg alt=logo class=logo> </a> <!-- Button to open drawer --> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <!-- Header title --> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> VectorBTÂ® PRO <span class=md-version> v2025.10.15 </span> <span class=unlock-icon><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M192 32c-35.3 0-64 28.7-64 64v64h192c35.3 0 64 28.7 64 64v224c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V224c0-35.3 28.7-64 64-64V96c0-70.7 57.3-128 128-128 63.5 0 116.1 46.1 126.2 106.7 2.9 17.4-8.8 33.9-26.3 36.9S258 102.8 255 85.3C250 55.1 223.7 32 192 32m40 328c13.3 0 24-10.7 24-24s-10.7-24-24-24h-80c-13.3 0-24 10.7-24 24s10.7 24 24 24z"/></svg></span> </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> From signals </span> </div> </div> </div> <!-- Color palette --> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=custom-dark data-md-color-primary=custom-dark data-md-color-accent=custom-dark aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=custom-light data-md-color-primary=custom-light data-md-color-accent=custom-light aria-label="Switch to dark mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <!-- Site language selector --> <!-- Button to open search modal --> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <!-- Search interface --> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <!-- Repository information --> <div class=md-header__source> <a href=https://github.com/polakowo/vectorbt.pro title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> vectorbt.pro </div> </a> </div> </nav> <!-- Navigation tabs (sticky) --> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/ class=md-tabs__link> Getting started </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/features/overview/ class=md-tabs__link> Features </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/overview/ class=md-tabs__link> Tutorials </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=https://vectorbt.pro/pvt_41531c19/documentation/overview/ class=md-tabs__link> Documentation </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/overview/ class=md-tabs__link> Cookbook </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/api/ class=md-tabs__link> API </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/terms/terms-of-use/ class=md-tabs__link> Terms </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://vectorbt.pro/pvt_41531c19/ title="VectorBTÂ® PRO" class="md-nav__button md-logo" aria-label="VectorBTÂ® PRO" data-md-component=logo> <img src=https://vectorbt.pro/pvt_41531c19/assets/logo/logo.svg alt=logo class=logo> </a> VectorBTÂ® PRO </label> <div class=md-nav__source> <a href=https://github.com/polakowo/vectorbt.pro title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> vectorbt.pro </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/ class=md-nav__link> <span class=md-ellipsis> Getting started </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/features/overview/ class=md-nav__link> <span class=md-ellipsis> Features </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/overview/ class=md-nav__link> <span class=md-ellipsis> Tutorials </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> Documentation </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=true> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Documentation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/documentation/overview/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/documentation/fundamentals/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 7a2 2 0 0 0-2 2v8h2v-4h2v4h2V9a2 2 0 0 0-2-2zm0 2h2v2H3m12-.5V9a2 2 0 0 0-2-2H9v10h4a2 2 0 0 0 2-2v-1.5a1.54 1.54 0 0 0-1.5-1.5 1.54 1.54 0 0 0 1.5-1.5M13 15h-2v-2h2zm0-4h-2V9h2m6-2a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-1h-2v1h-2V9h2v1h2V9a2 2 0 0 0-2-2Z"/></svg> <span class=md-ellipsis> Fundamentals </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/documentation/building-blocks/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 16.5c0 .38-.21.71-.53.88l-7.9 4.44c-.16.12-.36.18-.57.18s-.41-.06-.57-.18l-7.9-4.44A.99.99 0 0 1 3 16.5v-9c0-.38.21-.71.53-.88l7.9-4.44c.16-.12.36-.18.57-.18s.41.06.57.18l7.9 4.44c.32.17.53.5.53.88zM12 4.15 6.04 7.5 12 10.85l5.96-3.35zM5 15.91l6 3.38v-6.71L5 9.21zm14 0v-6.7l-6 3.37v6.71z"/></svg> <span class=md-ellipsis> Building blocks </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/documentation/data/ class=md-nav__link> <span class=md-ellipsis> Data </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/documentation/indicators/ class=md-nav__link> <span class=md-ellipsis> Indicators </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_6 checked> <label class=md-nav__link for=__nav_4_6 id=__nav_4_6_label tabindex=0> <span class=md-ellipsis> Portfolio </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_6_label aria-expanded=true> <label class=md-nav__title for=__nav_4_6> <span class="md-nav__icon md-icon"></span> Portfolio </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/documentation/portfolio/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17.45 15.18 22 7.31V21H2V3h2v12.54L9.5 6 16 9.78l4.24-7.33 1.73 1-5.23 9.05-6.51-3.75L4.31 19h2.26l4.39-7.56z"/></svg> <span class=md-ellipsis> Portfolio </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/documentation/portfolio/from-orders/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M2 2v20h20V2zm18 10h-4v4h4v4h-4v-4h-4v4H8v-4H4v-4h4V8H4V4h4v4h4V4h4v4h4zm-4-4v4h-4V8zm-4 4v4H8v-4z"/></svg> <span class=md-ellipsis> From orders </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m6 2c0-3.3-2.7-6-6-6s-6 2.7-6 6c0 2.2 1.2 4.1 3 5.2l1-1.7c-1.2-.7-2-2-2-3.4 0-2.2 1.8-4 4-4s4 1.8 4 4c0 1.5-.8 2.8-2 3.4l1 1.7c1.8-1 3-3 3-5.2M12 2C6.5 2 2 6.5 2 12c0 3.7 2 6.9 5 8.6l1-1.7c-2.4-1.4-4-4-4-6.9 0-4.4 3.6-8 8-8s8 3.6 8 8c0 3-1.6 5.5-4 6.9l1 1.7c3-1.7 5-4.9 5-8.6 0-5.5-4.5-10-10-10"/></svg> <span class=md-ellipsis> From signals </span> <span class="md-nav__icon md-icon"></span> </label> <a href=https://vectorbt.pro/pvt_41531c19/documentation/portfolio/from-signals/ class="md-nav__link md-nav__link--active"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m6 2c0-3.3-2.7-6-6-6s-6 2.7-6 6c0 2.2 1.2 4.1 3 5.2l1-1.7c-1.2-.7-2-2-2-3.4 0-2.2 1.8-4 4-4s4 1.8 4 4c0 1.5-.8 2.8-2 3.4l1 1.7c1.8-1 3-3 3-5.2M12 2C6.5 2 2 6.5 2 12c0 3.7 2 6.9 5 8.6l1-1.7c-2.4-1.4-4-4-4-6.9 0-4.4 3.6-8 8-8s8 3.6 8 8c0 3-1.6 5.5-4 6.9l1 1.7c3-1.7 5-4.9 5-8.6 0-5.5-4.5-10-10-10"/></svg> <span class=md-ellipsis> From signals </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#mechanics class=md-nav__link> <span class=md-ellipsis> Mechanics </span> </a> <nav class=md-nav aria-label=Mechanics> <ul class=md-nav__list> <li class=md-nav__item> <a href=#framework class=md-nav__link> <span class=md-ellipsis> Framework </span> </a> <nav class=md-nav aria-label=Framework> <ul class=md-nav__list> <li class=md-nav__item> <a href=#segment-workflow class=md-nav__link> <span class=md-ellipsis> Segment workflow </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#signal-generation class=md-nav__link> <span class=md-ellipsis> Signal generation </span> </a> <nav class=md-nav aria-label="Signal generation"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#signal-function class=md-nav__link> <span class=md-ellipsis> Signal function </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#signal-resolution class=md-nav__link> <span class=md-ellipsis> Signal resolution </span> </a> </li> <li class=md-nav__item> <a href=#signal-conversion class=md-nav__link> <span class=md-ellipsis> Signal conversion </span> </a> </li> <li class=md-nav__item> <a href=#main-order-resolution class=md-nav__link> <span class=md-ellipsis> Main order resolution </span> </a> </li> <li class=md-nav__item> <a href=#limit-management class=md-nav__link> <span class=md-ellipsis> Limit management </span> </a> <nav class=md-nav aria-label="Limit management"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#creation class=md-nav__link> <span class=md-ellipsis> Creation </span> </a> </li> <li class=md-nav__item> <a href=#expiration class=md-nav__link> <span class=md-ellipsis> Expiration </span> </a> </li> <li class=md-nav__item> <a href=#activation class=md-nav__link> <span class=md-ellipsis> Activation </span> </a> </li> <li class=md-nav__item> <a href=#cancellation class=md-nav__link> <span class=md-ellipsis> Cancellation </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#stop-management class=md-nav__link> <span class=md-ellipsis> Stop management </span> </a> <nav class=md-nav aria-label="Stop management"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#types class=md-nav__link> <span class=md-ellipsis> Types </span> </a> </li> <li class=md-nav__item> <a href=#creation_1 class=md-nav__link> <span class=md-ellipsis> Creation </span> </a> </li> <li class=md-nav__item> <a href=#activation_1 class=md-nav__link> <span class=md-ellipsis> Activation </span> </a> </li> <li class=md-nav__item> <a href=#resolution class=md-nav__link> <span class=md-ellipsis> Resolution </span> </a> </li> <li class=md-nav__item> <a href=#updating class=md-nav__link> <span class=md-ellipsis> Updating </span> </a> </li> <li class=md-nav__item> <a href=#cancellation_1 class=md-nav__link> <span class=md-ellipsis> Cancellation </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#signals class=md-nav__link> <span class=md-ellipsis> Signals </span> </a> <nav class=md-nav aria-label=Signals> <ul class=md-nav__list> <li class=md-nav__item> <a href=#direction-unaware class=md-nav__link> <span class=md-ellipsis> Direction-unaware </span> </a> </li> <li class=md-nav__item> <a href=#direction-aware class=md-nav__link> <span class=md-ellipsis> Direction-aware </span> </a> </li> <li class=md-nav__item> <a href=#signal-function_1 class=md-nav__link> <span class=md-ellipsis> Signal function </span> </a> </li> <li class=md-nav__item> <a href=#conflicts class=md-nav__link> <span class=md-ellipsis> Conflicts </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#orders class=md-nav__link> <span class=md-ellipsis> Orders </span> </a> <nav class=md-nav aria-label=Orders> <ul class=md-nav__list> <li class=md-nav__item> <a href=#accumulation class=md-nav__link> <span class=md-ellipsis> Accumulation </span> </a> </li> <li class=md-nav__item> <a href=#size-types class=md-nav__link> <span class=md-ellipsis> Size types </span> </a> </li> <li class=md-nav__item> <a href=#size-granularity class=md-nav__link> <span class=md-ellipsis> Size granularity </span> </a> </li> <li class=md-nav__item> <a href=#price class=md-nav__link> <span class=md-ellipsis> Price </span> </a> </li> <li class=md-nav__item> <a href=#shifting class=md-nav__link> <span class=md-ellipsis> Shifting </span> </a> </li> <li class=md-nav__item> <a href=#slippage class=md-nav__link> <span class=md-ellipsis> Slippage </span> </a> </li> <li class=md-nav__item> <a href=#limit-orders class=md-nav__link> <span class=md-ellipsis> Limit orders </span> </a> <nav class=md-nav aria-label="Limit orders"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#time-in-force class=md-nav__link> <span class=md-ellipsis> Time in force </span> </a> </li> <li class=md-nav__item> <a href=#expiration-date class=md-nav__link> <span class=md-ellipsis> Expiration date </span> </a> </li> <li class=md-nav__item> <a href=#conflicts_1 class=md-nav__link> <span class=md-ellipsis> Conflicts </span> </a> </li> <li class=md-nav__item> <a href=#delta class=md-nav__link> <span class=md-ellipsis> Delta </span> </a> </li> <li class=md-nav__item> <a href=#reversing class=md-nav__link> <span class=md-ellipsis> Reversing </span> </a> </li> <li class=md-nav__item> <a href=#adjustment class=md-nav__link> <span class=md-ellipsis> Adjustment </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#stop-orders class=md-nav__link> <span class=md-ellipsis> Stop orders </span> </a> <nav class=md-nav aria-label="Stop orders"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#entry-point class=md-nav__link> <span class=md-ellipsis> Entry point </span> </a> </li> <li class=md-nav__item> <a href=#exit-point class=md-nav__link> <span class=md-ellipsis> Exit point </span> </a> </li> <li class=md-nav__item> <a href=#conflicts_2 class=md-nav__link> <span class=md-ellipsis> Conflicts </span> </a> </li> <li class=md-nav__item> <a href=#adjustment_1 class=md-nav__link> <span class=md-ellipsis> Adjustment </span> </a> </li> <li class=md-nav__item> <a href=#laddering class=md-nav__link> <span class=md-ellipsis> Laddering </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#dynamic class=md-nav__link> <span class=md-ellipsis> Dynamic </span> </a> <nav class=md-nav aria-label=Dynamic> <ul class=md-nav__list> <li class=md-nav__item> <a href=#entry-laddering class=md-nav__link> <span class=md-ellipsis> Entry laddering </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#grouping class=md-nav__link> <span class=md-ellipsis> Grouping </span> </a> <nav class=md-nav aria-label=Grouping> <ul class=md-nav__list> <li class=md-nav__item> <a href=#after-simulation class=md-nav__link> <span class=md-ellipsis> After simulation </span> </a> </li> <li class=md-nav__item> <a href=#before-simulation class=md-nav__link> <span class=md-ellipsis> Before simulation </span> </a> <nav class=md-nav aria-label="Before simulation"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#sorting class=md-nav__link> <span class=md-ellipsis> Sorting </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#custom-outputs class=md-nav__link> <span class=md-ellipsis> Custom outputs </span> </a> </li> <li class=md-nav__item> <a href=#summary class=md-nav__link> <span class=md-ellipsis> Summary </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/documentation/to-be-continued/ class=md-nav__link> <span class=md-ellipsis> To be continued... </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/overview/ class=md-nav__link> <span class=md-ellipsis> Cookbook </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/api/ class=md-nav__link> <span class=md-ellipsis> API </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/terms/terms-of-use/ class=md-nav__link> <span class=md-ellipsis> Terms </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <nav class=md-path aria-label=Navigation> <ol class=md-path__list> <li class=md-path__item> <a href=https://vectorbt.pro/pvt_41531c19/documentation/overview/ class=md-path__link> <span class=md-ellipsis> Documentation </span> </a> </li> <li class=md-path__item> <a href=https://vectorbt.pro/pvt_41531c19/documentation/portfolio/ class=md-path__link> <span class=md-ellipsis> Portfolio </span> </a> </li> </ol> </nav> <article class="md-content__inner md-typeset"> <h1 id=from-signals><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m6 2c0-3.3-2.7-6-6-6s-6 2.7-6 6c0 2.2 1.2 4.1 3 5.2l1-1.7c-1.2-.7-2-2-2-3.4 0-2.2 1.8-4 4-4s4 1.8 4 4c0 1.5-.8 2.8-2 3.4l1 1.7c1.8-1 3-3 3-5.2M12 2C6.5 2 2 6.5 2 12c0 3.7 2 6.9 5 8.6l1-1.7c-2.4-1.4-4-4-4-6.9 0-4.4 3.6-8 8-8s8 3.6 8 8c0 3-1.6 5.5-4 6.9l1 1.7c3-1.7 5-4.9 5-8.6 0-5.5-4.5-10-10-10"/></svg></span> From signals<a class=headerlink href=#from-signals title="Permanent link">&para;</a></h1> <p>The <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_orders>Portfolio.from_orders</a> (<abbr title="From-orders simulation method">FO</abbr>) method, discussed earlier, is the most basic simulation approach. It accepts order information as multiple array-like arguments and broadcasts them to a single shape, allowing us to know exactly what should be ordered for each asset at each bar. This method requires having all this information upfront, regardless of what happens during the simulation. But what if we want to create an order only when we are not currently in the market, or generally, make an order based on the current simulation state? Such conditional logic cannot be represented using orders aloneâ€”we would need to use either a callback or define more arrays. Both approaches are implemented in <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a> (<abbr title="From-signals simulation method">FS</abbr>).</p> <p>Before diving into this method, make sure to learn more about signals <a href=https://vectorbt.pro/pvt_41531c19/tutorials/signal-development>here</a>. In short, signals are an abstraction layer over orders. Each signal consists of four boolean values: <img alt=1âƒ£ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/31-20e3.svg title=:one:> long entry, <img alt=2âƒ£ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/32-20e3.svg title=:two:> long exit, <img alt=3âƒ£ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/33-20e3.svg title=:three:> short entry, and <img alt=4âƒ£ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/34-20e3.svg title=:four:> short exit. The combination of these values allows us to control the direction of an order relative to the current position. For example, a short entry flag will reverse the current long position or open a new short one if we are not in the market. This way, position management can be separated from order management, letting us focus on deciding whether we are bullish or bearish at any given timeâ€”a perfect playground for machine learning models.</p> <p>There is another reason to appreciate signals: statistically, within the entire universe of signal <a href=https://en.wikipedia.org/wiki/Permutation>permutations</a>, there is at least one permutation that always outperforms the market. This means we could design the perfect trading algorithm using only the above signal schemaâ€”we just need to guess the right timing and direction for each signal. This reduces the number of factors to just two (in an ideal scenario, since in the real world we must also consider risk, execution constraints, and more). For example, if the price of a security is $21 on day 1, $20 on day 2, and $22 on day 3, we could enter a short position on day 1 and a long position on day 2 to achieve positive returns. That's why trading systems and their backtesting components do not have to be complex to be profitableâ€”they just need a robust signal generator as their algorithmic backbone, along with trading infrastructure that closely matches the backtesting system.</p> <div class="admonition example"> <p class=admonition-title>Example</p> <p>Here are all the signal permutations for a price series with four points and their total return.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=kn>from</span><span class=w> </span><span class=nn>vectorbtpro</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>price</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>21</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>22</span><span class=p>,</span> <span class=mi>21</span><span class=p>])</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>returns</span> <span class=o>=</span> <span class=p>(</span><span class=n>price</span><span class=p>[</span><span class=mi>1</span><span class=p>:]</span> <span class=o>-</span> <span class=n>price</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span> <span class=o>/</span> <span class=n>price</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>permutations</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>product</span><span class=p>([</span><span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>],</span> <span class=n>repeat</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>returns</span><span class=p>)))</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>total_return</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>prod</span><span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>permutations</span><span class=p>,</span> <span class=n>returns</span><span class=p>,</span> <span class=o>-</span><span class=n>returns</span><span class=p>),</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>(</span><span class=n>total_return</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=n>permutations</span><span class=p>)</span><span class=o>.</span><span class=n>sort_values</span><span class=p>(</span><span class=n>ascending</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>(False, True, False)     0.204762</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=go>(False, True, True)      0.100000</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=go>(True, True, False)      0.095238</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=go>(True, True, True)       0.000000</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=go>(False, False, False)   -0.014286</span>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=go>(False, False, True)    -0.100000</span>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a><span class=go>(True, False, False)    -0.103896</span>
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a><span class=go>(True, False, True)     -0.181818</span>
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a><span class=go>dtype: float64</span>
</span></code></pre></div> <p>Do not run this on longer price series, since the number of permutations grows exponentially with the number of data pointsâ€”<code>2^n</code>. For example, a year of daily history would require checking <code>2^365</code> or <code>7.515336e+109</code> permutations.</p> </div> <h2 id=mechanics>Mechanics<a class=headerlink href=#mechanics title="Permanent link">&para;</a></h2> <p>Similar to <abbr title="From-orders simulation method">FO</abbr>, this method is also a class method of <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio>Portfolio</a> and includes two Numba-compiled core functions: <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.from_signals_nb>from_signals_nb</a> and <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.from_signal_func_nb>from_signal_func_nb</a>. <abbr title="From-signals simulation method">FS</abbr> shares many arguments with <abbr title="From-orders simulation method">FO</abbr>, especially those that set up the simulation, such as <code>init_cash</code>, as well as those that contain order information, like <code>size</code>. For example, if you check the API documentation for the <code>size</code> argument under <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a>, you will see "See <code>Portfolio.from_orders</code>." The simulation procedure of <abbr title="From-signals simulation method">FS</abbr> is also very similar to that of <abbr title="From-orders simulation method">FO</abbr>: as it loops over all columns and rows, at each iteration it resolves the current order and executes it by appending information about the filled order to the order records and updating the current simulation state. However, that is where the similarities end.</p> <h3 id=framework>Framework<a class=headerlink href=#framework title="Permanent link">&para;</a></h3> <p>Below is an abstract visualization of the <abbr title="From-signals simulation method">FS</abbr> framework running on three rows and two groups, with two columns and one column, respectively:</p> <p><img alt loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/documentation/pf/from_signals_framework.svg style=width:800px;></p> <p>If you have worked with VBT for a while, you have likely noticed that the framework of <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a> follows that of <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_orders</a> and <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_order_func>Portfolio.from_order_func</a>. Like most things in the VBT universe, simulation with <abbr title="From-signals simulation method">FS</abbr> is performed by iterating over a "target shape." This shape has two dimensions: rows representing the time axis and columns representing the asset axis (or, more generally, configurations). Columns are further divided into groups: if multiple columns share the same cash, they are placed into the same group (as shown in the blue rectangle on the left above), while columns without cash sharing or grouping are treated as isolated and appear as a group with exactly one column (blue rectangle on the right above). Groups are treated as separate, atomic backtesting instances that are not connected in any way; splitting the shape by target groups should not affect the final result. This is also why chunking is generally performed on groups rather than columns <img alt=ðŸ’¡ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f4a1.svg title=:bulb:></p> <p>The actual iteration over rows and groups takes place in <a href=https://en.wikipedia.org/wiki/Row-_and_column-major_order>column-major order</a>: the simulator starts by moving over the rows in the first group, and once finished, continues with the second group. Each time it processes a new row within a group, all the assets at that row are considered a "segment" because they compete for the same resources at the same time or are connected by any user-defined methods. For example, an account with <code>BTC-USD</code> and <code>ETH-USD</code> on the date <code>2020-01-01</code> forms a segment since the value of both assets contributes to the total value of the group at this date. Each asset within a segment is called an "element," which is the smallest simulation unit. An element in <abbr title="From-signals simulation method">FS</abbr> can hold only one order, so the number of filled orders is capped by the number of rows times the number of columns. For example, a year's worth of daily <code>BTC-USD</code> and <code>ETH-USD</code> history can generate at most <code>365 * 2 = 730</code> orders, or one order per bar and asset.</p> <h4 id=segment-workflow>Segment workflow<a class=headerlink href=#segment-workflow title="Permanent link">&para;</a></h4> <p>The segment is where the main part of the simulation occurs:</p> <pre class=mermaid><code>flowchart TD;
    id0["Update state at open"]

    id4["Get signals (0)"]
    id5["Get signals (1)"]
    id6["Get signals (2)"]

    id7["Generate order"]
    id8["Generate order"]
    id9["Generate order"]

    id10["Sort orders"]

    id11["Execute order (2)"]
    id12["Execute order (0)"]
    id13["Execute order (1)"]

    id14["Update state at close"]

    id15["Post-segment processing (optional)"]

    id0 --&gt; id4;
    id0 --&gt; id5;
    id0 --&gt; id6;
    id4 --&gt; id7;
    id5 --&gt; id8;
    id6 --&gt; id9;
    id7 --&gt; id10;
    id8 --&gt; id10;
    id9 --&gt; id10;
    id10 --&gt; id11;
    id10 --&gt; id12;
    id10 --&gt; id13;
    id11 --&gt; id14;
    id12 --&gt; id14;
    id13 --&gt; id14;
    id14 --&gt; id15;</code></pre> <p><abbr title="From-signals simulation method">FS</abbr> first updates the current simulation state using the opening price. This step is needed to obtain the group value in case an order has a size defined as a (target) percentage, allowing the size to be converted into an absolute number of units. Then, it iterates over the columns in the current group and determines the four signals for each column. These signals are then converted into an order specification similar to that used by <abbr title="From-orders simulation method">FO</abbr>.</p> <p>After resolving all order specifications, and if the automatic call sequence is enabled, the simulator attempts to sort the orders by their potential value so that sell orders are executed first. This is necessary for rebalancing. This sorting is only possible if all orders within the current group (limit, order, and user-defined) happen either all at the beginning or all at the end of the current bar. If some orders occur in the middle of the bar, or if some happen at the beginning and others at the end, an error will be thrown because orders can only be sorted if they are guaranteed to occur simultaneously. If the dynamic call sequence is disabled and there are orders in multiple bar zones, the simulator will sort them by bar zone.</p> <p>Finally, <abbr title="From-signals simulation method">FS</abbr> processes the columns in the newly established call sequence to execute the orders, and updates the simulation state again using the closing price. This final update is necessary to optionally generate the portfolio returns and for the segment post-processing function.</p> <h3 id=signal-generation>Signal generation<a class=headerlink href=#signal-generation title="Permanent link">&para;</a></h3> <p><abbr title="From-signals simulation method">FS</abbr> supports two signal generation modes: fixed (cached) and dynamic (non-cached). The first mode is implemented by the function <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.from_signals_nb>from_signals_nb</a>, which uses four pre-defined arrays as signals and does not allow defining callbacks. Because of this, it is fully cacheable and does not need to be recompiled for each new runtime, unless a new set of data types is detected. The second mode is implemented by the function <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.from_signal_func_nb>from_signal_func_nb</a>, which does not accept signal arrays but defines a signal function. This is a special callback meant to generate the four signals for each asset and at each bar dynamically. This mode is especially suited for use cases where the signal depends on the current simulation state. Additionally, it defines a callback that is called after processing the current segment, which can be used to pre-compute various metrics, such as the Sharpe ratio. The main drawback is that it cannot be cached (yet), so it must be recompiled in each new runtime (<img alt=âš° class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26b0.svg title=:coffin:> to those running VBT as a script).</p> <p>The convenience of the <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a> method, which wraps both of these modes, is its ability to automatically choose the appropriate mode: whenever you override any default callback, it will run the second mode instead of the first.</p> <h4 id=signal-function>Signal function<a class=headerlink href=#signal-function title="Permanent link">&para;</a></h4> <p>Recall that in <abbr title="From-orders simulation method">FO</abbr>, all data had to be provided as arrays, and it was not possible to dynamically change the information or influence execution in any way. <abbr title="From-signals simulation method">FS</abbr> is much more flexible: while most information is still expected to be defined beforehand (acting as a facade), signals can be generated both statically and dynamically. Let's experiment with dynamic signal generation.</p> <p>The second mode is implemented by accepting a user-defined callback function, <code>signal_func_nb</code>. Whenever the main simulation loop processes a new row (bar), it asks each asset in the current group to generate signals using this callback function. To do so, it packs all potentially useful information, such as the current cash balance and group value, into a named tuple of type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.SignalContext>SignalContext</a>. In return, the function must provide four signals, which will then be used to create an order for that asset.</p> <p>Here is an example of a very simple signal function that does not generate any orders:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=gp>&gt;&gt;&gt; </span><span class=kn>from</span><span class=w> </span><span class=nn>vectorbtpro</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=gp>... </span>    <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>close</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=gp>... </span>    <span class=s2>&quot;BTC-USD&quot;</span><span class=p>:</span> <span class=p>[</span><span class=mf>20594.29</span><span class=p>,</span> <span class=mf>20719.41</span><span class=p>,</span> <span class=mf>19986.60</span><span class=p>,</span> <span class=mf>21084.64</span><span class=p>],</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=gp>... </span>    <span class=s2>&quot;ETH-USD&quot;</span><span class=p>:</span> <span class=p>[</span><span class=mf>1127.51</span><span class=p>,</span> <span class=mf>1125.37</span><span class=p>,</span> <span class=mf>1051.32</span><span class=p>,</span> <span class=mf>1143.20</span><span class=p>],</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=gp>... </span>    <span class=s2>&quot;DOT-USD&quot;</span><span class=p>:</span> <span class=p>[</span><span class=mf>7.88</span><span class=p>,</span> <span class=mf>7.74</span><span class=p>,</span> <span class=mf>7.41</span><span class=p>,</span> <span class=mf>7.78</span><span class=p>],</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a><span class=gp>... </span>    <span class=s2>&quot;BNB-USD&quot;</span><span class=p>:</span> <span class=p>[</span><span class=mf>216.90</span><span class=p>,</span> <span class=mf>219.67</span><span class=p>,</span> <span class=mf>214.23</span><span class=p>,</span> <span class=mf>228.92</span><span class=p>]</span>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a><span class=gp>... </span><span class=p>})</span>
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a>
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-1-15><a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=n>close</span><span class=p>,</span>
</span><span id=__span-1-16><a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span>
</span><span id=__span-1-17><a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-1-18><a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>order_records</span>
</span><span id=__span-1-19><a id=__codelineno-1-19 name=__codelineno-1-19 href=#__codelineno-1-19></a><span class=go>array([], dtype={...})</span>
</span></code></pre></div> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>To avoid waiting for the function to compile, remove the <code>@njit</code> decorator from <code>signal_func_nb</code> and pass <code>jitted=False</code> to <code>from_signals</code> to fully disable Numba for this method. Do this only if the amount of input data is small (&lt; 1000).</p> </div> <p>To understand when the function is called, let's narrow the data to two assets and print out the current column and row:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>)</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=gp>... </span>    <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=n>close</span><span class=p>[[</span><span class=s2>&quot;BTC-USD&quot;</span><span class=p>,</span> <span class=s2>&quot;ETH-USD&quot;</span><span class=p>]],</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=go>0 0</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=go>0 1</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=go>0 2</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=go>0 3</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=go>1 0</span>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=go>1 1</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=go>1 2</span>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=go>1 3</span>
</span></code></pre></div> <p>You can see that the function was called at each row, first for column <code>BTC-USD</code> and then for column <code>ETH-USD</code>. In this scenario, both assets are isolated tests, so the simulator processes one column after the other. However, once we introduce grouping with or without cash sharing, which binds columns together, the simulator processes the columns group-wise: it iterates through groups, then rows, and finally through columns within the current group and row. Let's demonstrate this by defining two groups, with two assets sharing the same cash:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>)</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=gp>... </span>    <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=n>close</span><span class=p>,</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=gp>... </span>    <span class=n>group_by</span><span class=o>=</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>],</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=gp>... </span>    <span class=n>cash_sharing</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=go>0 0 0</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a><span class=go>0 1 0</span>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=go>0 0 1</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a><span class=go>0 1 1</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a><span class=go>0 0 2</span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a><span class=go>0 1 2</span>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a><span class=go>0 0 3</span>
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a><span class=go>0 1 3</span>
</span><span id=__span-3-20><a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a><span class=go>1 2 0</span>
</span><span id=__span-3-21><a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a><span class=go>1 3 0</span>
</span><span id=__span-3-22><a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a><span class=go>1 2 1</span>
</span><span id=__span-3-23><a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a><span class=go>1 3 1</span>
</span><span id=__span-3-24><a id=__codelineno-3-24 name=__codelineno-3-24 href=#__codelineno-3-24></a><span class=go>1 2 2</span>
</span><span id=__span-3-25><a id=__codelineno-3-25 name=__codelineno-3-25 href=#__codelineno-3-25></a><span class=go>1 3 2</span>
</span><span id=__span-3-26><a id=__codelineno-3-26 name=__codelineno-3-26 href=#__codelineno-3-26></a><span class=go>1 2 3</span>
</span><span id=__span-3-27><a id=__codelineno-3-27 name=__codelineno-3-27 href=#__codelineno-3-27></a><span class=go>1 3 3</span>
</span></code></pre></div> <p>The context tuple passed to the signal function contains all the necessary information to identify the position of the call in the simulation. For example, <code>c.index[c.i]</code> can be used with <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.SignalContext.index>SignalContext.index</a> and <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.SignalContext.i>SignalContext.i</a> to get the timestamp of the current bar. You can also change the state of any pending limit or stop order before it is processed, since the signal function is conceptually executed just before the beginning of the bar.</p> <p>Because the groups are processed from left to right and each group's state is stored globally, you can access the order records and, in general, the latest simulation state of all groups that have been processed so far. For example, <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.SignalContext.last_cash>SignalContext.last_cash</a> contains as many elements as there are groups. This is both powerful and potentially risky: you can create complex intergroup relationships if you wish, or accidentally access the wrong group if you are not paying close attention.</p> <h3 id=signal-resolution>Signal resolution<a class=headerlink href=#signal-resolution title="Permanent link">&para;</a></h3> <p>Signals add an extra layer of abstraction over orders, so logic is needed to translate signals into order specifications. Whenever the simulator receives a new set of four signals at each row and column, it first consolidates them into a single signal, which is then converted into an order. The resolution step checks for conflicting signals. Usually, you would expect only one <code>True</code> signal and three <code>False</code> signals, but sometimes multiple signals can be <code>True</code>, especially when the signal function is merging data from different boolean arrays. In such cases, the simulator uses the following multi-step procedure to resolve conflicts:</p> <pre class=mermaid><code>flowchart TD;
    id1["Long entry and long exit?"]
    id2["Short entry and short exit?"]
    id3["Long entry and short entry?"]
    id4["Long/short position and short/long entry?"]
    id5["Final signal"]

    id1 --&gt;|"fix"| id2;
    id2 --&gt;|"fix"| id3;
    id3 --&gt;|"fix"| id4;
    id4 --&gt;|"fix"| id5;</code></pre> <p>First, the simulator checks if there are multiple <code>True</code> signals within the same direction, such as both long entry and long exit being set. To choose between these, the simulator uses the argument <code>upon_long_conflict</code> of type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.ConflictMode>ConflictMode</a>. For example, the "adjacent" option will pick the signal adjacent to your current position, so only the long entry remains active if you are in a long position. This step uses the function <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.resolve_signal_conflict_nb>resolve_signal_conflict_nb</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>resolve_signal_conflict_nb</span><span class=p>(</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=gp>... </span>    <span class=n>position_now</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=gp>... </span>    <span class=n>is_entry</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=gp>... </span>    <span class=n>is_exit</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=gp>... </span>    <span class=n>direction</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>Direction</span><span class=o>.</span><span class=n>LongOnly</span><span class=p>,</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=gp>... </span>    <span class=n>conflict_mode</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>ConflictMode</span><span class=o>.</span><span class=n>Adjacent</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=go>(True, False)</span>
</span></code></pre></div> <p>After at most one signal is selected in each direction, the simulator checks if both long entry and short entry are active. It then calls <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.resolve_dir_conflict_nb>resolve_dir_conflict_nb</a>, using the argument <code>upon_dir_conflict</code> of type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.DirectionConflictMode>DirectionConflictMode</a> to determine which direction wins. For example, you can choose to always go short when there is uncertainty:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>resolve_dir_conflict_nb</span><span class=p>(</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=gp>... </span>    <span class=n>position_now</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=gp>... </span>    <span class=n>is_long_entry</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=gp>... </span>    <span class=n>is_short_entry</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=gp>... </span>    <span class=n>upon_dir_conflict</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>DirectionConflictMode</span><span class=o>.</span><span class=n>Short</span><span class=p>,</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=go>(False, True)</span>
</span></code></pre></div> <p>Finally, the function <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.resolve_opposite_entry_nb>resolve_opposite_entry_nb</a> handles cases when an entry signal is opposite to the current position's direction. For example, if you are in a long position and the short entry signal is given, the simulator uses the argument <code>upon_opposite_entry</code> of type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.OppositeEntryMode>OppositeEntryMode</a> to decide whether to reduce, close, or fully reverse the long position. Here is how you could make the short entry signal behave like the long exit signal:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>resolve_opposite_entry_nb</span><span class=p>(</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=gp>... </span>    <span class=n>position_now</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=gp>... </span>    <span class=n>is_long_entry</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=gp>... </span>    <span class=n>is_long_exit</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=gp>... </span>    <span class=n>is_short_entry</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=gp>... </span>    <span class=n>is_short_exit</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=gp>... </span>    <span class=n>upon_opposite_entry</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>OppositeEntryMode</span><span class=o>.</span><span class=n>Close</span><span class=p>,</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=gp>... </span>    <span class=n>accumulate</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=go>(False, True, False, False, 0)</span>
</span></code></pre></div> <ol> <li>This argument can be <code>True</code>, <code>False</code>, or any of <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.AccumulationMode>AccumulationMode</a>.</li> </ol> <p>At the end of these steps, there will be only one active signal out of four <img alt=ðŸ›¤ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f6e4.svg title=:railway_track:></p> <h3 id=signal-conversion>Signal conversion<a class=headerlink href=#signal-conversion title="Permanent link">&para;</a></h3> <p>Now that we have identified the single signal, what comes next? It is time to convert it into an order! This step is straightforward and is performed by <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.signal_to_size_nb>signal_to_size_nb</a>, which takes the four signals (with three now deactivated) and the size requirement for this row and column, and returns the order size, size type, and direction to use. For example, if you are in a position of 20 shares and receive a long exit signal, the size becomes minus 20 shares, the size type is <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.SizeType.Amount>SizeType.Amount</a>, and the direction is <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.Direction.LongOnly>Direction.LongOnly</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>signal_to_size_nb</span><span class=p>(</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=gp>... </span>    <span class=n>position_now</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=gp>... </span>    <span class=n>val_price_now</span><span class=o>=</span><span class=mf>20594.29</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=gp>... </span>    <span class=n>value_now</span><span class=o>=</span><span class=mf>411885.80</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=gp>... </span>    <span class=n>is_long_entry</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=gp>... </span>    <span class=n>is_long_exit</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=gp>... </span>    <span class=n>is_short_entry</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a><span class=gp>... </span>    <span class=n>is_short_exit</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>  <span class=c1># (3)!</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>SizeType</span><span class=o>.</span><span class=n>ValuePercent</span><span class=p>,</span>  <span class=c1># (4)!</span>
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a><span class=gp>... </span>    <span class=n>accumulate</span><span class=o>=</span><span class=kc>False</span>  <span class=c1># (5)!</span>
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-7-13><a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a><span class=go>(-20.0, 0, 0)</span>
</span></code></pre></div> <ol> <li>Latest known asset price.</li> <li>Latest known group value.</li> <li>Default value for this element.</li> <li>Default value for this element.</li> <li>Default value for this element.</li> </ol> <p>Even though we provided the default order specification for the current element, such as <code>size</code>, the function ignored it here because it is not needed for closing the current position. However, if you wanted to reverse the current position (close it and then place a new order using the default specification), those inputs would now be used:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>signal_to_size_nb</span><span class=p>(</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=gp>... </span>    <span class=n>position_now</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=gp>... </span>    <span class=n>val_price_now</span><span class=o>=</span><span class=mf>20594.29</span><span class=p>,</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=gp>... </span>    <span class=n>value_now</span><span class=o>=</span><span class=mf>411885.80</span><span class=p>,</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=gp>... </span>    <span class=n>is_long_entry</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=gp>... </span>    <span class=n>is_long_exit</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=gp>... </span>    <span class=n>is_short_entry</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=gp>... </span>    <span class=n>is_short_exit</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>SizeType</span><span class=o>.</span><span class=n>ValuePercent</span><span class=p>,</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a><span class=gp>... </span>    <span class=n>accumulate</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a><span class=go>(-22.0, 0, 2)</span>
</span></code></pre></div> <ol> <li>Reverses the long position.</li> </ol> <p>Here, the size is calculated as follows: decrease the position by 20 shares to close out the long position, and, since we are working with a percentage of the current group value, open a new short position of <code>size * value_now / val_price_now = 2.0</code> shares. The size type is <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.SizeType.Amount>SizeType.Amount</a> and the direction is <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.Direction.Both>Direction.Both</a> because this operation goes in both directions.</p> <h3 id=main-order-resolution>Main order resolution<a class=headerlink href=#main-order-resolution title="Permanent link">&para;</a></h3> <p>The simulator calls the signal function, resolves the signals, and converts them into an order specification. However, this is not the only order that may compete for the current bar: there may also be pending limit and stop orders. Since the <abbr title="From-signals simulation method">FS</abbr> simulation function can process at most one order per bar, it must pick a winner, which should always be the order that executes first. But how do we determine which order comes first without any intra-bar data? We can divide each bar into three "zones": opening (the first rectangle below), somewhere in the middle (the second rectangle), and closing (the third rectangle). For example, if a stop order is triggered at or before the opening of the current bar and a user order is set to execute at the closing price, the stop order should go first. Here is the full decision chain:</p> <pre class=mermaid><code>flowchart TD;
    subgraph " "
    id1["Pending limit price hit at/before open?"]
    id2["Pending stop price hit at/before open?"]
    id3["User price is open?"]

    id1 --&gt;|"no"| id2;
    id2 --&gt;|"no"| id3;
    end

    subgraph " "
    id4["Pending limit price hit?"]
    id5["Pending stop price hit before close?"]
    id6["User price isn't close?"]

    id3 --&gt;|"no"| id4;
    id4 --&gt;|"no"| id5;
    id5 --&gt;|"no"| id6;
    end

    subgraph " "
    id7["Pending stop price hit at close?"]
    id8["User price is close?"]

    id6 --&gt;|"no"| id7;
    id7 --&gt;|"no"| id8;
    end</code></pre> <p>As shown, limit orders have precedence over stop orders, and stop orders have priority over user orders, but only if they are triggered within the same zone of a bar.</p> <h3 id=limit-management>Limit management<a class=headerlink href=#limit-management title="Permanent link">&para;</a></h3> <p>A market order is a transaction designed to execute as quickly as possible at the current market price. A limit order, by contrast, is an order to buy or sell an asset with a restriction on the maximum price to be paid or the minimum price to be received (the "limit price"). The price of a limit order is compared against a pre-defined price level. If this level is not reached, the order remains pending and will not be filled unless the price reaches the specified limit.</p> <h4 id=creation>Creation<a class=headerlink href=#creation title="Permanent link">&para;</a></h4> <p>When a stop or user-defined order is created and its order type is provided via <code>order_type</code> as <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.OrderType.Limit>OrderType.Limit</a>, the simulator first determines the limit price type at which the order should execute: open, close, or something else. This is an important concept: the <code>price</code> argument guides VBT on where in the bar the operation should occur. If the limit price is the open price (provided as either <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.PriceType.Open>PriceType.Open</a> or <code>-np.inf</code>), the simulator can use the entire candle for its checks and execute the order as soon as the price is hit within the same bar. If the limit price is not the close price, but falls somewhere in between, the simulator can use only the close price. If the limit price is the close price (provided as either <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.PriceType.Close>PriceType.Close</a> or <code>np.inf</code>), the simulator cannot execute the limit order immediately and must delay its first check to the next bar.</p> <p>If the limit order is not executed in the same bar where it was created, it is marked as pending, and all relevant information is stored in a record array of type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.limit_info_dt>limit_info_dt</a>, structured by asset. This array can hold only one instance per asset, so <abbr title="From-signals simulation method">FS</abbr> allows only one limit order to be active at a time. In a signal function, you can access this array through <code>c.limit_info_dt</code>, allowing you to change any information before the new bar. For example, to change the price: <code>c.limit_info_dt["init_price"][c.col] = new_price</code>.</p> <h4 id=expiration>Expiration<a class=headerlink href=#expiration title="Permanent link">&para;</a></h4> <p>When the simulator arrives at the next bar, it first calls <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.check_limit_expired_nb>check_limit_expired_nb</a> to check if the pending limit order has expired at the start or somewhere in the middle of the bar. If it has expired at the start, the order is discarded. If it expires during the bar, the simulator also checks whether the order was hit at the bar's open; if it was not, the order is discarded since there is no guarantee that the order was hit before the deadline. For example, suppose the order can be in force for at most 36 hours, it was issued on <code>2020-01-01</code>, and now it is <code>2020-01-02</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>check_limit_expired_nb</span><span class=p>(</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=gp>... </span>    <span class=n>creation_idx</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=gp>... </span>    <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=gp>... </span>    <span class=n>tif</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s2>&quot;36h&quot;</span><span class=p>)),</span>  <span class=c1># (1)!</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=gp>... </span>    <span class=n>index</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>date_range</span><span class=p>(</span><span class=s2>&quot;2020-01-01&quot;</span><span class=p>,</span> <span class=n>periods</span><span class=o>=</span><span class=mi>3</span><span class=p>)),</span>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=gp>... </span>    <span class=n>freq</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s2>&quot;1d&quot;</span><span class=p>))</span>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=go>(False, True)</span>
</span></code></pre></div> <ol> <li>Index and time deltas must be converted into nanoseconds.</li> </ol> <p>We see that the function marks the order as expired, but not at the bar's start, so it can still be executed using the open price. If the order's lifespan was 24 hours, the function would also raise the first flag and prevent any execution:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>check_limit_expired_nb</span><span class=p>(</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=gp>... </span>    <span class=n>creation_idx</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=gp>... </span>    <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=gp>... </span>    <span class=n>tif</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s2>&quot;24h&quot;</span><span class=p>)),</span>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=gp>... </span>    <span class=n>index</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>date_range</span><span class=p>(</span><span class=s2>&quot;2020-01-01&quot;</span><span class=p>,</span> <span class=n>periods</span><span class=o>=</span><span class=mi>3</span><span class=p>)),</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=gp>... </span>    <span class=n>freq</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s2>&quot;1d&quot;</span><span class=p>))</span>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a><span class=go>(True, True)</span>
</span></code></pre></div> <div class="admonition info"> <p class=admonition-title>Info</p> <p>The lifespan is calculated by subtracting any time from the opening time of the creation bar, even if the order was placed at the very end of the creation bar.</p> </div> <h4 id=activation>Activation<a class=headerlink href=#activation title="Permanent link">&para;</a></h4> <p>Once it is confirmed that the order <strong>can</strong> be executed at the current bar (meaning it will not expire), the simulator uses the function <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.check_limit_hit_nb>check_limit_hit_nb</a> to determine whether the order <strong>should</strong> be executed by checking if its target price has been hit. This check compares the price against the current candle. For example, with a pending buy limit order and a target price of <code>9.5</code>, the function will check if the low price went below this target:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>check_limit_hit_nb</span><span class=p>(</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=gp>... </span>    <span class=nb>open</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=gp>... </span>    <span class=n>high</span><span class=o>=</span><span class=mf>11.0</span><span class=p>,</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=gp>... </span>    <span class=n>low</span><span class=o>=</span><span class=mf>9.0</span><span class=p>,</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=mf>10.5</span><span class=p>,</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>9.5</span><span class=p>,</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mf>2.0</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a><span class=go>(9.5, False, False)</span>
</span></code></pre></div> <p>If the target price were <code>11</code>, the function would indicate that the price was hit at the bar's start, allowing the order to be executed right away at the open price:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>check_limit_hit_nb</span><span class=p>(</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=gp>... </span>    <span class=nb>open</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=gp>... </span>    <span class=n>high</span><span class=o>=</span><span class=mf>11.0</span><span class=p>,</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=gp>... </span>    <span class=n>low</span><span class=o>=</span><span class=mf>9.0</span><span class=p>,</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=mf>10.5</span><span class=p>,</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>11.0</span><span class=p>,</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mf>2.0</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a><span class=go>(10.0, True, False)</span>
</span></code></pre></div> <p>If the target price were <code>8</code>, the function would indicate that the price was not hit at all:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>check_limit_hit_nb</span><span class=p>(</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=gp>... </span>    <span class=nb>open</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=gp>... </span>    <span class=n>high</span><span class=o>=</span><span class=mf>11.0</span><span class=p>,</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=gp>... </span>    <span class=n>low</span><span class=o>=</span><span class=mf>9.0</span><span class=p>,</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=mf>10.5</span><span class=p>,</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=mf>8.0</span><span class=p>,</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mf>2.0</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=go>(nan, False, False)</span>
</span></code></pre></div> <h4 id=cancellation>Cancellation<a class=headerlink href=#cancellation title="Permanent link">&para;</a></h4> <p>If the target price is not hit, the limit order remains pending. The order can still be canceled manually within the signal function, which is called before all the checks above, or within the post-segment function, which is called after processing the entire segment. The pending order will also be canceled automatically once a stop order is executed, since executing the stop order may change the simulation state and may consume resources required to execute the limit order in the future.</p> <p>Finally, the four signals returned by the signal function and resolved into a single signal can also affect the pending order, regardless of whether the final signal is executed. For example, if there is a pending buy limit order and the user decides to issue a long exit or short entry signal, the most intuitive action is to cancel the pending order, since the user's intent has changed. This is the default behavior. Such "pending conflicts" are resolved using the function <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.resolve_pending_conflict_nb>resolve_pending_conflict_nb</a>, which uses the arguments <code>upon_adj_limit_conflict</code> and <code>upon_opp_limit_conflict</code>, both of type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.PendingConflictMode>PendingConflictMode</a>, to decide what to do if the direction of the pending order is adjacent or opposite to the direction of the resolved user-defined signal.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>resolve_pending_conflict_nb</span><span class=p>(</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=gp>... </span>    <span class=n>is_pending_long</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=gp>... </span>    <span class=n>is_user_long</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=gp>... </span>    <span class=n>upon_adj_conflict</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>PendingConflictMode</span><span class=o>.</span><span class=n>KeepIgnore</span><span class=p>,</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=gp>... </span>    <span class=n>upon_opp_conflict</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>PendingConflictMode</span><span class=o>.</span><span class=n>CancelIgnore</span><span class=p>,</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=go>(False, False)</span>
</span></code></pre></div> <p>In this example, the function decides to cancel the limit order and to ignore the user-defined signal.</p> <h3 id=stop-management>Stop management<a class=headerlink href=#stop-management title="Permanent link">&para;</a></h3> <p>Stop orders are used to increase the likelihood of reaching a set entry or exit price, limit potential losses, or lock in profits. These orders stay inactive until a specific price is reached, at which point they are activated as a market or limit order. When a stop order is executed, it typically closes the position.</p> <h4 id=types>Types<a class=headerlink href=#types title="Permanent link">&para;</a></h4> <p>There are four types of stop orders:</p> <ol> <li>Stop loss (<abbr title="Stop loss">SL</abbr>).</li> <li>Trailing stop loss (<abbr title="Trailing stop loss">TSL</abbr>).</li> <li>Trailing take profit (<abbr title="Trailing take profit">TTP</abbr>).</li> <li>Take profit (<abbr title="Take profit">TP</abbr>).</li> </ol> <p>A stop-loss order limits our risk in a trade to a set amount if the market moves against us. For example, if a stop-loss sell order is placed at $45 per unit, the order remains inactive until the price reaches or falls below $45. At that point, the order is converted into a market or limit order, and the units are sold at the best available price. A take profit order works in the opposite way. It defines the amount of profit we are willing to make on a trade and closes the position once that amount is reached. Combining an <abbr title="Stop loss">SL</abbr> and <abbr title="Take profit">TP</abbr> order creates a specific risk-to-reward ratio, which can be further adjusted to match the probabilities of reaching each breakout scenario.</p> <p>Trailing orders behave differently. As the price rises, the trailing stop follows it higher. When the price stops rising, the new stop-loss price stays at its last level, automatically protecting our downside while locking in profits as the price sets new highs. <abbr title="Trailing take profit">TTP</abbr> is a variation of <abbr title="Trailing stop loss">TSL</abbr> that becomes active only after a specific threshold is reached. These two orders are often viewed and displayed as a single order.</p> <h4 id=creation_1>Creation<a class=headerlink href=#creation_1 title="Permanent link">&para;</a></h4> <p>Unlike limit orders, stop orders are created after an entry order has been filled and act the same as user-defined exit signals that are triggered once a stop condition is met. An entry order is any successfully filled order that has opened a new position or increased an existing one. When the simulator identifies such an order, it first determines the stop entry price provided through the <code>stop_entry_price</code> argument of type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.StopEntryPrice>StopEntryPrice</a>. This price serves as the starting point for all stop values and thresholds.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>By default, the stop entry price is the closing price, not the order price. This prevents the situation where the stop is hit on the very first bar and cannot be executed, as we lack intra-bar data and cannot execute two orders within the same bar. If the order price is used, the soonest the stop can execute is at the open of the next bar.</p> </div> <p>Based on this price, the simulator can also determine the exact timing within the bar when the stop order should be triggered. Why does this matter? The simulator needs to know if it can use the current candle to update the price of any <abbr title="Trailing stop loss">TSL</abbr> or <abbr title="Trailing take profit">TTP</abbr> order. Internally, stop order data is stored in three arrays by asset: <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.sl_info_dt>sl_info_dt</a>, <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.tsl_info_dt>tsl_info_dt</a>, and <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.tp_info_dt>tp_info_dt</a>. Each data type follows a similar structure: the initial row and price, the current stop value (in absolute or percentage terms), the limit delta and its format if the stop should eventually trigger a limit order. For trailing stops, the schema also includes the updated price and the row where the update occurred.</p> <h4 id=activation_1>Activation<a class=headerlink href=#activation_1 title="Permanent link">&para;</a></h4> <p>Stop orders cannot be activated on the same bar in which they are issued, even if the entry price is the opening price. This is because <abbr title="From-signals simulation method">FS</abbr> cannot handle two orders within the same bar. If you need this functionality, use a flexible order function with <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_order_func>Portfolio.from_order_func</a>. Upon reaching a new bar, the price of any pending <abbr title="Stop loss">SL</abbr> and <abbr title="Take profit">TP</abbr> orders is then checked against the low and high prices of the current candle, respectively (the reverse for short positions). This uses the <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.check_stop_hit_nb>check_stop_hit_nb</a> function, which returns the stop price, whether it was hit on open, and whether it was hit on close. For example, if the initial price is $10 per unit and the stop loss is set at 10%, the stop is marked as hit if the lowest price of the candle is below <code>10 * (1 - 0.1) = 9</code> per unit:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>check_stop_hit_nb</span><span class=p>(</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=gp>... </span>    <span class=nb>open</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=gp>... </span>    <span class=n>high</span><span class=o>=</span><span class=mf>11.0</span><span class=p>,</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=gp>... </span>    <span class=n>low</span><span class=o>=</span><span class=mf>9.0</span><span class=p>,</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=mf>10.5</span><span class=p>,</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a><span class=gp>... </span>    <span class=n>is_position_long</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a><span class=gp>... </span>    <span class=n>init_price</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span>
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a><span class=gp>... </span>    <span class=n>stop</span><span class=o>=</span><span class=mf>0.1</span>
</span><span id=__span-15-9><a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-15-10><a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a><span class=go>(9.0, False, False)</span>
</span></code></pre></div> <p>If the initial price was $12 per unit, the stop would trigger immediately on open:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>check_stop_hit_nb</span><span class=p>(</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=gp>... </span>    <span class=nb>open</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=gp>... </span>    <span class=n>high</span><span class=o>=</span><span class=mf>11.0</span><span class=p>,</span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=gp>... </span>    <span class=n>low</span><span class=o>=</span><span class=mf>9.0</span><span class=p>,</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=mf>10.5</span><span class=p>,</span>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=gp>... </span>    <span class=n>is_position_long</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=gp>... </span>    <span class=n>init_price</span><span class=o>=</span><span class=mf>12.0</span><span class=p>,</span>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a><span class=gp>... </span>    <span class=n>stop</span><span class=o>=</span><span class=mf>0.1</span>
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-16-10><a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a><span class=go>(10.0, True, False)</span>
</span></code></pre></div> <p>If the stop was not hit (here the initial price was $9), the returned stop price is NaN:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>check_stop_hit_nb</span><span class=p>(</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=gp>... </span>    <span class=nb>open</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=gp>... </span>    <span class=n>high</span><span class=o>=</span><span class=mf>11.0</span><span class=p>,</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=gp>... </span>    <span class=n>low</span><span class=o>=</span><span class=mf>9.0</span><span class=p>,</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=mf>10.5</span><span class=p>,</span>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=gp>... </span>    <span class=n>is_position_long</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a><span class=gp>... </span>    <span class=n>init_price</span><span class=o>=</span><span class=mf>9.0</span><span class=p>,</span>
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a><span class=gp>... </span>    <span class=n>stop</span><span class=o>=</span><span class=mf>0.1</span>
</span><span id=__span-17-9><a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-17-10><a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a><span class=go>(nan, False, False)</span>
</span></code></pre></div> <p>For a <abbr title="Take profit">TP</abbr> order, set the argument <code>hit_below</code> to <code>False</code>.</p> <p>Unlike fixed stop orders, <abbr title="Trailing stop loss">TSL</abbr> and <abbr title="Trailing take profit">TTP</abbr> orders must also track the peak price on which the stop price is based. Since we do not know if the highest price of a candle comes before the lowest price or the other way around, the candle must be split into distinct zones, updating the peak price in the zone that comes before the stop check. First, the simulator uses the opening price to update the peak price. Then, it checks if the stop was hit during the entire bar. If not, it proceeds to update the peak price with the highest (for long positions) or lowest (for short positions) price of the candle, and then checks the stop again using only the closing price to avoid this ambiguity. This way, the simulator always assumes the pessimistic scenario that the worst event (the stop being hit) happens before the best event (updating the peak price).</p> <p><abbr title="Trailing take profit">TTP</abbr> orders add another layer of complexity, as they must also check if their activation threshold has been reached. This check is performed using the <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.check_tsl_th_hit_nb>check_tsl_th_hit_nb</a> function, which takes the initial and the peak price and tests whether the difference between them is greater than or equal to the threshold. If it is, the order is converted into a regular <abbr title="Trailing stop loss">TSL</abbr> order. If not, the simulator updates the peak price using the current candle and tries again to check for threshold crossover. If the difference now meets the threshold, it uses <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.check_stop_hit_nb>check_stop_hit_nb</a>, but can no longer use the current candle. Since it is unclear if the stop was hit before or after the threshold was crossed, only the closing price is used, and the argument <code>can_use_ohlc</code> is disabled. The following diagram shows this process:</p> <pre class=mermaid><code>flowchart TD;
    subgraph " "
    id0["Update peak price using open"]
    id1["Has a threshold?"]
    id2["Threshold crossed at/before open?"]
    id3["Stop hit at/after open?"]

    id0 --&gt; id1;
    id1 --&gt;|"yes - TTP"| id2;
    id1 --&gt;|"no - TSL"| id3;
    id2 --&gt;|"yes"| id3;
    end

    subgraph " "
    id4["Update peak price using high/low"]
    id5["Has a threshold?"]
    id6["Threshold crossed before close?"]
    id7["Stop hit before close?"]

    id2 --&gt;|"no"| id4;
    id3 --&gt;|"no"| id4;
    id4 --&gt; id5;
    id5 --&gt;|"yes - TTP"| id6;
    id5 --&gt;|"no - TSL"| id7;
    id6 --&gt;|"yes"| id7;
    end

    id3 --&gt;|"yes"| id9;
    id6 --&gt;|"no"| id8;
    id7 --&gt;|"yes"| id9;
    id7 --&gt;|"no"| id8;

    id8["Keep pending"]
    id9["Execute"]</code></pre> <p>If multiple stops are hit, the simulator takes a pessimistic approach: <abbr title="Stop loss">SL</abbr> is checked first, <abbr title="Trailing stop loss">TSL</abbr> and <abbr title="Trailing take profit">TTP</abbr> are checked second, and <abbr title="Take profit">TP</abbr> is checked last. The first pending stop is executed and all other pending stops are canceled.</p> <h4 id=resolution>Resolution<a class=headerlink href=#resolution title="Permanent link">&para;</a></h4> <p>After that, the winning stop is converted into four signals by the function <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.generate_stop_signal_nb>generate_stop_signal_nb</a>, which uses the current position and the default stop exit behavior defined by the <code>stop_exit_type</code> argument of type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.StopExitType>StopExitType</a>. For example, instead of closing the position, you can have the function reverse it by using <code>StopExitType.Reverse</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>generate_stop_signal_nb</span><span class=p>(</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=gp>... </span>    <span class=n>position_now</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=gp>... </span>    <span class=n>stop_exit_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>StopExitType</span><span class=o>.</span><span class=n>Reverse</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=go>(False, False, True, False, 0)</span>
</span></code></pre></div> <p>As shown, the short entry signal is <code>True</code> while the other signals are <code>False</code>. The number following the signals represents the selected accumulation mode of type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.AccumulationMode>AccumulationMode</a>, which is used in situations where you want to reduce the position instead of closing or reversing it. Next, the stop exit price is resolved using the function <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.resolve_stop_exit_price_nb>resolve_stop_exit_price_nb</a>. The logic is simple: if the <code>stop_exit_price</code> argument of type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.StopExitPrice>StopExitPrice</a> is <code>StopExitPrice.Close</code>, then the closing price is used; otherwise, the stop price that was hit is used. You can also provide an actual price as the argument.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>resolve_stop_exit_price_nb</span><span class=p>(</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=gp>... </span>    <span class=n>stop_price</span><span class=o>=</span><span class=mf>9.0</span><span class=p>,</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=mf>10.5</span><span class=p>,</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=gp>... </span>    <span class=n>stop_exit_price</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>StopExitPrice</span><span class=o>.</span><span class=n>Stop</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=go>9.0</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>resolve_stop_exit_price_nb</span><span class=p>(</span>
</span><span id=__span-19-9><a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a><span class=gp>... </span>    <span class=n>stop_price</span><span class=o>=</span><span class=mf>9.0</span><span class=p>,</span>
</span><span id=__span-19-10><a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=mf>10.5</span><span class=p>,</span>
</span><span id=__span-19-11><a id=__codelineno-19-11 name=__codelineno-19-11 href=#__codelineno-19-11></a><span class=gp>... </span>    <span class=n>stop_exit_price</span><span class=o>=</span><span class=mf>9.5</span>
</span><span id=__span-19-12><a id=__codelineno-19-12 name=__codelineno-19-12 href=#__codelineno-19-12></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-19-13><a id=__codelineno-19-13 name=__codelineno-19-13 href=#__codelineno-19-13></a><span class=go>9.5</span>
</span></code></pre></div> <p>Finally, the order signal is converted into a market or limit order specification just like a user-defined signal. See <a href=#signal-conversion>Signal conversion</a>.</p> <h4 id=updating>Updating<a class=headerlink href=#updating title="Permanent link">&para;</a></h4> <p>In addition to updating any stop within a callback, you can also update the stop automatically when the current position increases. In this case, the <code>upon_stop_update</code> argument of type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.StopUpdateMode>StopUpdateMode</a> controls whether the current stop should stay the same or be reset. This decision is made by the function <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.should_update_stop_nb>should_update_stop_nb</a>. For example, if your position has increased and you want to know whether the current stop should be updated with <code>StopUpdateMode.Override</code>, you would do the following:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>should_update_stop_nb</span><span class=p>(</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=gp>... </span>    <span class=n>new_stop</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=gp>... </span>    <span class=n>upon_stop_update</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>StopUpdateMode</span><span class=o>.</span><span class=n>Override</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a><span class=go>True</span>
</span></code></pre></div> <p>If the new stop value is NaN (i.e., no stop), you should not update:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>should_update_stop_nb</span><span class=p>(</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=gp>... </span>    <span class=n>new_stop</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=gp>... </span>    <span class=n>upon_stop_update</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>StopUpdateMode</span><span class=o>.</span><span class=n>Override</span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a><span class=go>False</span>
</span></code></pre></div> <p>Unless you choose the option <code>StopUpdateMode.OverrideNaN</code>, which effectively disables all stops:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>should_update_stop_nb</span><span class=p>(</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=gp>... </span>    <span class=n>new_stop</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a><span class=gp>... </span>    <span class=n>upon_stop_update</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>StopUpdateMode</span><span class=o>.</span><span class=n>OverrideNaN</span>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a><span class=go>True</span>
</span></code></pre></div> <p>This does not apply when the current position decreases. But why is it important to consider updates if signals normally just open or close positions, rather than increase or decrease them? With accumulation, signals can add to or remove from the position. In such cases, you should consider: should this change to the position invalidate previously defined stops, or should new stops be created? The <code>upon_stop_update</code> argument controls this behavior.</p> <h4 id=cancellation_1>Cancellation<a class=headerlink href=#cancellation_1 title="Permanent link">&para;</a></h4> <p>Like updating, cancellation of currently pending stop orders occurs when the position is closed. This clears all stops automatically. But similar to limit orders, there may be a conflict with an active user-defined signal. This is resolved by the function <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.resolve_pending_conflict_nb>resolve_pending_conflict_nb</a>. The arguments used to resolve pending conflicts for stop orders are <code>upon_adj_stop_conflict</code> and <code>upon_opp_stop_conflict</code>, both of type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.PendingConflictMode>PendingConflictMode</a>. For example, if a user decides to reduce the position and clear all pending stops at the same time, they can set the <code>upon_adj_stop_conflict</code> argument (reducing or attempting to close the position are considered adjacent signals) to the option <code>PendingConflictMode.CancelExecute</code>.</p> <h2 id=signals>Signals<a class=headerlink href=#signals title="Permanent link">&para;</a></h2> <p>We have covered some theory on how this simulation method works. Now, let's take a break from reading and focus on signal arrays, whichâ€”together with a signal functionâ€”are the main input to this method. As you already know, signals come in two types:</p> <ol> <li>Direction-unaware signals: entries and exits enhanced by direction.</li> <li>Direction-aware signals: long entries, long exits, short entries, short exits.</li> </ol> <p>The first type is a compressed form of the second. You can always convert direction-unaware signals into direction-aware signals, but not the other way around, since the first format covers a total of <code>2 * 2 * 3 = 12</code> combinations, while the second format covers <code>2 * 2 * 2 * 2 = 16</code> combinations. On the other hand, the first format is easier to use because you can set the direction globally and work with two arrays instead of four.</p> <p>First, let's fetch the entire history of <code>BTCUSDT</code> and <code>ETHUSDT</code> for our examples below:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>BinanceData</span><span class=o>.</span><span class=n>pull</span><span class=p>([</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>,</span> <span class=s2>&quot;ETHUSDT&quot;</span><span class=p>])</span>
</span></code></pre></div> <p>Since we will not need the entire history to illustrate most concepts, let's select the week of data between February 18 and February 24, 2021, when there was a substantial price change in both directions:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sub_data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=s2>&quot;2021-02-18&quot;</span><span class=p>:</span><span class=s2>&quot;2021-02-24&quot;</span><span class=p>]</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sub_data</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>symbol</span><span class=o>=</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/documentation/pf/from_signals_sub_data.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/documentation/pf/from_signals_sub_data.dark.svg#only-dark></p> <p>Let's try passing the data without any signals:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=n>sub_data</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>count</span><span class=p>()</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=go>symbol</span>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a><span class=go>BTCUSDT    0</span>
</span><span id=__span-25-5><a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a><span class=go>ETHUSDT    0</span>
</span><span id=__span-25-6><a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a><span class=go>Name: count, dtype: int64</span>
</span></code></pre></div> <ol> <li>Even though the first argument expects the closing price (<code>close</code>), you can pass the entire data instance, from which the OHLC features will be extracted automatically.</li> </ol> <p>By default, all signals are set to <code>False</code>, so no orders were generated.</p> <p>Now, let's say our ML model correctly predicted the peak on February 21 and signaled us to enter a position on February 18 and close it on February 21. To do this, we need to build our entry and exit arrays with the same shape as our data. Instead of specifying the same signals for each asset repeatedly, you can provide a Series instead of a DataFrame. The Series will be applied to each asset thanks to <a href=https://vectorbt.pro/pvt_41531c19/documentation/portfolio/from-orders/#broadcasting>broadcasting</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entries</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span>   <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])</span>
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>entries</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span><span class=n>exits</span>
</span><span id=__span-26-7><a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-26-8><a id=__codelineno-26-8 name=__codelineno-26-8 href=#__codelineno-26-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>readable</span>
</span><span id=__span-26-9><a id=__codelineno-26-9 name=__codelineno-26-9 href=#__codelineno-26-9></a><span class=go>   Order Id   Column              Signal Index            Creation Index  \</span>
</span><span id=__span-26-10><a id=__codelineno-26-10 name=__codelineno-26-10 href=#__codelineno-26-10></a><span class=go>0         0  BTCUSDT 2021-02-18 00:00:00+00:00 2021-02-18 00:00:00+00:00   </span>
</span><span id=__span-26-11><a id=__codelineno-26-11 name=__codelineno-26-11 href=#__codelineno-26-11></a><span class=go>1         1  BTCUSDT 2021-02-21 00:00:00+00:00 2021-02-21 00:00:00+00:00   </span>
</span><span id=__span-26-12><a id=__codelineno-26-12 name=__codelineno-26-12 href=#__codelineno-26-12></a><span class=go>2         0  ETHUSDT 2021-02-18 00:00:00+00:00 2021-02-18 00:00:00+00:00   </span>
</span><span id=__span-26-13><a id=__codelineno-26-13 name=__codelineno-26-13 href=#__codelineno-26-13></a><span class=go>3         1  ETHUSDT 2021-02-21 00:00:00+00:00 2021-02-21 00:00:00+00:00   </span>
</span><span id=__span-26-14><a id=__codelineno-26-14 name=__codelineno-26-14 href=#__codelineno-26-14></a>
</span><span id=__span-26-15><a id=__codelineno-26-15 name=__codelineno-26-15 href=#__codelineno-26-15></a><span class=go>                 Fill Index      Size     Price  Fees  Side    Type Stop Type  </span>
</span><span id=__span-26-16><a id=__codelineno-26-16 name=__codelineno-26-16 href=#__codelineno-26-16></a><span class=go>0 2021-02-18 00:00:00+00:00  0.001940  51552.60   0.0   Buy  Market      None  </span>
</span><span id=__span-26-17><a id=__codelineno-26-17 name=__codelineno-26-17 href=#__codelineno-26-17></a><span class=go>1 2021-02-21 00:00:00+00:00  0.001940  57408.57   0.0  Sell  Market      None  </span>
</span><span id=__span-26-18><a id=__codelineno-26-18 name=__codelineno-26-18 href=#__codelineno-26-18></a><span class=go>2 2021-02-18 00:00:00+00:00  0.051557   1939.61   0.0   Buy  Market      None  </span>
</span><span id=__span-26-19><a id=__codelineno-26-19 name=__codelineno-26-19 href=#__codelineno-26-19></a><span class=go>3 2021-02-21 00:00:00+00:00  0.051557   1933.53   0.0  Sell  Market      None  </span>
</span></code></pre></div> <ol> <li>You could also specify this as a two-dimensional NumPy array with one column.</li> </ol> <p>You can see that the first order in the <code>BTCUSDT</code> column is a buy market order that opened a new long position. The second order is the same size but on the opposite side, so it was used to close the long position. Reading orders is not always straightforward, especially when you want to determine when positions are opened or closed. To get a better overview, let's calculate and print the position for each symbol at each bar:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=go>symbol                     BTCUSDT   ETHUSDT</span>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=go>Open time                                   </span>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=go>2021-02-18 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=go>2021-02-19 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a><span class=go>2021-02-20 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a><span class=go>2021-02-21 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-27-8><a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a><span class=go>2021-02-22 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-27-9><a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a><span class=go>2021-02-23 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-27-10><a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a><span class=go>2021-02-24 00:00:00+00:00  0.00000  0.000000</span>
</span></code></pre></div> <p>The returned array represents the position at the end of each bar, so we are still in the market on February 20 but out of the market on February 21.</p> <p>We provided the same array for each symbol, but what if our ML model indicated that the peak for <code>ETHUSDT</code> was one day ahead of <code>BTCUSDT</code>? As soon as your signal specification varies by columns, you need to build the signal array as a DataFrame with values defined per element. Let's keep the entry array the same for both symbols (since the entry signals do not vary by columns in this case) and expand only the exit array:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entries</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a><span class=gp>... </span>    <span class=mi>0</span><span class=p>:</span> <span class=p>[</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>],</span>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a><span class=gp>... </span>    <span class=mi>1</span><span class=p>:</span> <span class=p>[</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>],</span>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=gp>... </span><span class=p>})</span>  <span class=c1># (1)!</span>
</span><span id=__span-28-6><a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-28-7><a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-28-8><a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>entries</span><span class=p>,</span>
</span><span id=__span-28-9><a id=__codelineno-28-9 name=__codelineno-28-9 href=#__codelineno-28-9></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span><span class=n>exits</span>
</span><span id=__span-28-10><a id=__codelineno-28-10 name=__codelineno-28-10 href=#__codelineno-28-10></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-28-11><a id=__codelineno-28-11 name=__codelineno-28-11 href=#__codelineno-28-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-28-12><a id=__codelineno-28-12 name=__codelineno-28-12 href=#__codelineno-28-12></a><span class=go>symbol                     BTCUSDT   ETHUSDT</span>
</span><span id=__span-28-13><a id=__codelineno-28-13 name=__codelineno-28-13 href=#__codelineno-28-13></a><span class=go>Open time                                   </span>
</span><span id=__span-28-14><a id=__codelineno-28-14 name=__codelineno-28-14 href=#__codelineno-28-14></a><span class=go>2021-02-18 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-28-15><a id=__codelineno-28-15 name=__codelineno-28-15 href=#__codelineno-28-15></a><span class=go>2021-02-19 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-28-16><a id=__codelineno-28-16 name=__codelineno-28-16 href=#__codelineno-28-16></a><span class=go>2021-02-20 00:00:00+00:00  0.00194  0.000000</span>
</span><span id=__span-28-17><a id=__codelineno-28-17 name=__codelineno-28-17 href=#__codelineno-28-17></a><span class=go>2021-02-21 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-28-18><a id=__codelineno-28-18 name=__codelineno-28-18 href=#__codelineno-28-18></a><span class=go>2021-02-22 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-28-19><a id=__codelineno-28-19 name=__codelineno-28-19 href=#__codelineno-28-19></a><span class=go>2021-02-23 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-28-20><a id=__codelineno-28-20 name=__codelineno-28-20 href=#__codelineno-28-20></a><span class=go>2021-02-24 00:00:00+00:00  0.00000  0.000000</span>
</span></code></pre></div> <ol> <li>You could also use symbol names as column names. Defining rows and columns as a simple range of values (from <code>0</code> to <code>n</code>) will ignore the labels and broadcast only by shapes.</li> </ol> <p>We can now see that the long position in the <code>ETHUSDT</code> column was closed one day before the position in <code>BTCUSDT</code>, just as our hypothetical model intended. To simplify array creation and avoid setting each element manually, you can use the symbol wrapper of the data instance to create empty boolean arrays matching the shape of your data, and fill them on specific dates:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span> <span class=o>=</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=kc>False</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=s2>&quot;2021-02-21&quot;</span><span class=p>,</span> <span class=s2>&quot;BTCUSDT&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=s2>&quot;2021-02-20&quot;</span><span class=p>,</span> <span class=s2>&quot;ETHUSDT&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span>
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a><span class=go>Open time                                  </span>
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a><span class=go>2021-02-18 00:00:00+00:00    False    False</span>
</span><span id=__span-29-8><a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a><span class=go>2021-02-19 00:00:00+00:00    False    False</span>
</span><span id=__span-29-9><a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a><span class=go>2021-02-20 00:00:00+00:00    False     True</span>
</span><span id=__span-29-10><a id=__codelineno-29-10 name=__codelineno-29-10 href=#__codelineno-29-10></a><span class=go>2021-02-21 00:00:00+00:00     True    False</span>
</span><span id=__span-29-11><a id=__codelineno-29-11 name=__codelineno-29-11 href=#__codelineno-29-11></a><span class=go>2021-02-22 00:00:00+00:00    False    False</span>
</span><span id=__span-29-12><a id=__codelineno-29-12 name=__codelineno-29-12 href=#__codelineno-29-12></a><span class=go>2021-02-23 00:00:00+00:00    False    False</span>
</span><span id=__span-29-13><a id=__codelineno-29-13 name=__codelineno-29-13 href=#__codelineno-29-13></a><span class=go>2021-02-24 00:00:00+00:00    False    False</span>
</span></code></pre></div> <ol> <li>Create an array with the same number of columns as your symbols, and fill it with <code>False</code>.</li> </ol> <p>For those who enjoy using advanced features, here is how to let VBT's broadcaster create both arrays and fill them dynamically with <a href=https://vectorbt.pro/pvt_41531c19/api/base/wrapping/#vectorbtpro.base.wrapping.ArrayWrapper.fill_and_set>index dictionaries</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-30-3><a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>index_dict</span><span class=p>({</span><span class=mi>0</span><span class=p>:</span> <span class=kc>True</span><span class=p>}),</span>
</span><span id=__span-30-4><a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>index_dict</span><span class=p>({</span>
</span><span id=__span-30-5><a id=__codelineno-30-5 name=__codelineno-30-5 href=#__codelineno-30-5></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>idx</span><span class=p>(</span><span class=s2>&quot;2021-02-21&quot;</span><span class=p>,</span> <span class=s2>&quot;BTCUSDT&quot;</span><span class=p>):</span> <span class=kc>True</span><span class=p>,</span>
</span><span id=__span-30-6><a id=__codelineno-30-6 name=__codelineno-30-6 href=#__codelineno-30-6></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>idx</span><span class=p>(</span><span class=s2>&quot;2021-02-20&quot;</span><span class=p>,</span> <span class=s2>&quot;ETHUSDT&quot;</span><span class=p>):</span> <span class=kc>True</span>
</span><span id=__span-30-7><a id=__codelineno-30-7 name=__codelineno-30-7 href=#__codelineno-30-7></a><span class=gp>... </span>    <span class=p>})</span>
</span><span id=__span-30-8><a id=__codelineno-30-8 name=__codelineno-30-8 href=#__codelineno-30-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-30-9><a id=__codelineno-30-9 name=__codelineno-30-9 href=#__codelineno-30-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-30-10><a id=__codelineno-30-10 name=__codelineno-30-10 href=#__codelineno-30-10></a><span class=go>symbol                     BTCUSDT   ETHUSDT</span>
</span><span id=__span-30-11><a id=__codelineno-30-11 name=__codelineno-30-11 href=#__codelineno-30-11></a><span class=go>Open time                                   </span>
</span><span id=__span-30-12><a id=__codelineno-30-12 name=__codelineno-30-12 href=#__codelineno-30-12></a><span class=go>2021-02-18 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-30-13><a id=__codelineno-30-13 name=__codelineno-30-13 href=#__codelineno-30-13></a><span class=go>2021-02-19 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-30-14><a id=__codelineno-30-14 name=__codelineno-30-14 href=#__codelineno-30-14></a><span class=go>2021-02-20 00:00:00+00:00  0.00194  0.000000</span>
</span><span id=__span-30-15><a id=__codelineno-30-15 name=__codelineno-30-15 href=#__codelineno-30-15></a><span class=go>2021-02-21 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-30-16><a id=__codelineno-30-16 name=__codelineno-30-16 href=#__codelineno-30-16></a><span class=go>2021-02-22 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-30-17><a id=__codelineno-30-17 name=__codelineno-30-17 href=#__codelineno-30-17></a><span class=go>2021-02-23 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-30-18><a id=__codelineno-30-18 name=__codelineno-30-18 href=#__codelineno-30-18></a><span class=go>2021-02-24 00:00:00+00:00  0.00000  0.000000</span>
</span></code></pre></div> <p>The best part of the approach above is that the broadcaster will not create arrays larger than necessary. It will detect that the entry specification is the same for both symbols and create an array with one column instead of two, saving memory.</p> <h3 id=direction-unaware>Direction-unaware<a class=headerlink href=#direction-unaware title="Permanent link">&para;</a></h3> <p>In all the examples above, we provided only two arrays: <code>entries</code> and <code>exits</code>. When you do this, the method treats the provided signals as direction-unaware, meaning an additional argument, <code>direction</code>, is used to control the signal direction. By default, the direction is <code>Direction.LongOnly</code> (see <code>signal_direction</code> in <a href=https://vectorbt.pro/pvt_41531c19/api/_settings/#vectorbtpro._settings.portfolio>portfolio settings</a>). To change the direction, you can override <code>direction</code> with any option available in <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.Direction>Direction</a>. You can provide an option either as an integer or a field name. For example, let's allow <em>both</em> directions so the system reverses the position on exit instead of just closing it:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-31-3><a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>entries</span><span class=p>,</span>
</span><span id=__span-31-4><a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span><span class=n>exits</span><span class=p>,</span>
</span><span id=__span-31-5><a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a><span class=gp>... </span>    <span class=n>direction</span><span class=o>=</span><span class=s2>&quot;both&quot;</span>  <span class=c1># (1)!</span>
</span><span id=__span-31-6><a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-31-7><a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-31-8><a id=__codelineno-31-8 name=__codelineno-31-8 href=#__codelineno-31-8></a><span class=go>symbol                     BTCUSDT   ETHUSDT</span>
</span><span id=__span-31-9><a id=__codelineno-31-9 name=__codelineno-31-9 href=#__codelineno-31-9></a><span class=go>Open time                                   </span>
</span><span id=__span-31-10><a id=__codelineno-31-10 name=__codelineno-31-10 href=#__codelineno-31-10></a><span class=go>2021-02-18 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-31-11><a id=__codelineno-31-11 name=__codelineno-31-11 href=#__codelineno-31-11></a><span class=go>2021-02-19 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-31-12><a id=__codelineno-31-12 name=__codelineno-31-12 href=#__codelineno-31-12></a><span class=go>2021-02-20 00:00:00+00:00  0.00194 -0.051557</span>
</span><span id=__span-31-13><a id=__codelineno-31-13 name=__codelineno-31-13 href=#__codelineno-31-13></a><span class=go>2021-02-21 00:00:00+00:00 -0.00194 -0.051557</span>
</span><span id=__span-31-14><a id=__codelineno-31-14 name=__codelineno-31-14 href=#__codelineno-31-14></a><span class=go>2021-02-22 00:00:00+00:00 -0.00194 -0.051557</span>
</span><span id=__span-31-15><a id=__codelineno-31-15 name=__codelineno-31-15 href=#__codelineno-31-15></a><span class=go>2021-02-23 00:00:00+00:00 -0.00194 -0.051557</span>
</span><span id=__span-31-16><a id=__codelineno-31-16 name=__codelineno-31-16 href=#__codelineno-31-16></a><span class=go>2021-02-24 00:00:00+00:00 -0.00194 -0.051557</span>
</span></code></pre></div> <ol> <li>You can also provide this in numeric format as <code>Direction.Both</code>.</li> </ol> <p>Zero values have now turned negative, which means positions are being reversed. Just like with the signal arguments, the direction argument can also be provided as an array. This allows you to define different directions for different dates and symbols. For example, let's long <code>BTCUSDT</code> and short <code>ETHUSDT</code>. Thanks to broadcasting, you can provide per-column information as a two-dimensional array with just one row:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>direction</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>([[</span><span class=s2>&quot;longonly&quot;</span><span class=p>,</span> <span class=s2>&quot;shortonly&quot;</span><span class=p>]])</span>
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-32-3><a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-32-4><a id=__codelineno-32-4 name=__codelineno-32-4 href=#__codelineno-32-4></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>entries</span><span class=p>,</span>
</span><span id=__span-32-5><a id=__codelineno-32-5 name=__codelineno-32-5 href=#__codelineno-32-5></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span><span class=n>exits</span><span class=p>,</span>
</span><span id=__span-32-6><a id=__codelineno-32-6 name=__codelineno-32-6 href=#__codelineno-32-6></a><span class=gp>... </span>    <span class=n>direction</span><span class=o>=</span><span class=n>direction</span>
</span><span id=__span-32-7><a id=__codelineno-32-7 name=__codelineno-32-7 href=#__codelineno-32-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-32-8><a id=__codelineno-32-8 name=__codelineno-32-8 href=#__codelineno-32-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-32-9><a id=__codelineno-32-9 name=__codelineno-32-9 href=#__codelineno-32-9></a><span class=go>symbol                     BTCUSDT   ETHUSDT</span>
</span><span id=__span-32-10><a id=__codelineno-32-10 name=__codelineno-32-10 href=#__codelineno-32-10></a><span class=go>Open time                                   </span>
</span><span id=__span-32-11><a id=__codelineno-32-11 name=__codelineno-32-11 href=#__codelineno-32-11></a><span class=go>2021-02-18 00:00:00+00:00  0.00194 -0.051557</span>
</span><span id=__span-32-12><a id=__codelineno-32-12 name=__codelineno-32-12 href=#__codelineno-32-12></a><span class=go>2021-02-19 00:00:00+00:00  0.00194 -0.051557</span>
</span><span id=__span-32-13><a id=__codelineno-32-13 name=__codelineno-32-13 href=#__codelineno-32-13></a><span class=go>2021-02-20 00:00:00+00:00  0.00194  0.000000</span>
</span><span id=__span-32-14><a id=__codelineno-32-14 name=__codelineno-32-14 href=#__codelineno-32-14></a><span class=go>2021-02-21 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-32-15><a id=__codelineno-32-15 name=__codelineno-32-15 href=#__codelineno-32-15></a><span class=go>2021-02-22 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-32-16><a id=__codelineno-32-16 name=__codelineno-32-16 href=#__codelineno-32-16></a><span class=go>2021-02-23 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-32-17><a id=__codelineno-32-17 name=__codelineno-32-17 href=#__codelineno-32-17></a><span class=go>2021-02-24 00:00:00+00:00  0.00000  0.000000</span>
</span></code></pre></div> <p>Position values under the <code>ETHUSDT</code> column are negative, indicating a short position. The following example shows how to use per-element directions by entering a long position at the first bar, exiting at the peak, then entering a short position at the next bar, and finally exiting at the last bar:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>L</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>Direction</span><span class=o>.</span><span class=n>LongOnly</span>  <span class=c1># (1)!</span>
</span><span id=__span-33-2><a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>S</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>Direction</span><span class=o>.</span><span class=n>ShortOnly</span>
</span><span id=__span-33-3><a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a>
</span><span id=__span-33-4><a id=__codelineno-33-4 name=__codelineno-33-4 href=#__codelineno-33-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-33-5><a id=__codelineno-33-5 name=__codelineno-33-5 href=#__codelineno-33-5></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>),</span>  <span class=c1># (2)!</span>
</span><span id=__span-33-6><a id=__codelineno-33-6 name=__codelineno-33-6 href=#__codelineno-33-6></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-33-7><a id=__codelineno-33-7 name=__codelineno-33-7 href=#__codelineno-33-7></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>    <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>]),</span>
</span><span id=__span-33-8><a id=__codelineno-33-8 name=__codelineno-33-8 href=#__codelineno-33-8></a><span class=gp>... </span>    <span class=n>direction</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>L</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>S</span><span class=p>,</span> <span class=n>S</span><span class=p>,</span> <span class=n>S</span><span class=p>])</span>
</span><span id=__span-33-9><a id=__codelineno-33-9 name=__codelineno-33-9 href=#__codelineno-33-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-33-10><a id=__codelineno-33-10 name=__codelineno-33-10 href=#__codelineno-33-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-33-11><a id=__codelineno-33-11 name=__codelineno-33-11 href=#__codelineno-33-11></a><span class=go>Open time</span>
</span><span id=__span-33-12><a id=__codelineno-33-12 name=__codelineno-33-12 href=#__codelineno-33-12></a><span class=go>2021-02-18 00:00:00+00:00    0.001940</span>
</span><span id=__span-33-13><a id=__codelineno-33-13 name=__codelineno-33-13 href=#__codelineno-33-13></a><span class=go>2021-02-19 00:00:00+00:00    0.001940</span>
</span><span id=__span-33-14><a id=__codelineno-33-14 name=__codelineno-33-14 href=#__codelineno-33-14></a><span class=go>2021-02-20 00:00:00+00:00    0.001940</span>
</span><span id=__span-33-15><a id=__codelineno-33-15 name=__codelineno-33-15 href=#__codelineno-33-15></a><span class=go>2021-02-21 00:00:00+00:00    0.000000</span>
</span><span id=__span-33-16><a id=__codelineno-33-16 name=__codelineno-33-16 href=#__codelineno-33-16></a><span class=go>2021-02-22 00:00:00+00:00   -0.002059</span>
</span><span id=__span-33-17><a id=__codelineno-33-17 name=__codelineno-33-17 href=#__codelineno-33-17></a><span class=go>2021-02-23 00:00:00+00:00   -0.002059</span>
</span><span id=__span-33-18><a id=__codelineno-33-18 name=__codelineno-33-18 href=#__codelineno-33-18></a><span class=go>2021-02-24 00:00:00+00:00    0.000000</span>
</span><span id=__span-33-19><a id=__codelineno-33-19 name=__codelineno-33-19 href=#__codelineno-33-19></a><span class=go>Freq: D, dtype: float64</span>
</span></code></pre></div> <ol> <li>Shortcuts for better readability, numeric format.</li> <li>Select one symbol of data.</li> </ol> <div class="admonition note"> <p class=admonition-title>Note</p> <p>For larger arrays, prefer the numeric format over the string format, since strings must be converted to integers before simulation, which is a slower operation.</p> </div> <h3 id=direction-aware>Direction-aware<a class=headerlink href=#direction-aware title="Permanent link">&para;</a></h3> <p>Direction-aware signals are a more flexible type of signal, allowing for a greater variety of signal combinations. To use this mode, provide the arguments <code>short_entries</code> and <code>short_exits</code> as short signals, along with the <code>entries</code> and <code>exits</code> arguments for long signals. This disables the <code>direction</code> argument entirely, since the signals themselves now control the direction. Let's adapt the example above:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>),</span>
</span><span id=__span-34-3><a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span>      <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-34-4><a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>        <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-34-5><a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a><span class=gp>... </span>    <span class=n>short_entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-34-6><a id=__codelineno-34-6 name=__codelineno-34-6 href=#__codelineno-34-6></a><span class=gp>... </span>    <span class=n>short_exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>]),</span>
</span><span id=__span-34-7><a id=__codelineno-34-7 name=__codelineno-34-7 href=#__codelineno-34-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-34-8><a id=__codelineno-34-8 name=__codelineno-34-8 href=#__codelineno-34-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-34-9><a id=__codelineno-34-9 name=__codelineno-34-9 href=#__codelineno-34-9></a><span class=go>Open time</span>
</span><span id=__span-34-10><a id=__codelineno-34-10 name=__codelineno-34-10 href=#__codelineno-34-10></a><span class=go>2021-02-18 00:00:00+00:00    0.001940</span>
</span><span id=__span-34-11><a id=__codelineno-34-11 name=__codelineno-34-11 href=#__codelineno-34-11></a><span class=go>2021-02-19 00:00:00+00:00    0.001940</span>
</span><span id=__span-34-12><a id=__codelineno-34-12 name=__codelineno-34-12 href=#__codelineno-34-12></a><span class=go>2021-02-20 00:00:00+00:00    0.001940</span>
</span><span id=__span-34-13><a id=__codelineno-34-13 name=__codelineno-34-13 href=#__codelineno-34-13></a><span class=go>2021-02-21 00:00:00+00:00    0.000000</span>
</span><span id=__span-34-14><a id=__codelineno-34-14 name=__codelineno-34-14 href=#__codelineno-34-14></a><span class=go>2021-02-22 00:00:00+00:00   -0.002059</span>
</span><span id=__span-34-15><a id=__codelineno-34-15 name=__codelineno-34-15 href=#__codelineno-34-15></a><span class=go>2021-02-23 00:00:00+00:00   -0.002059</span>
</span><span id=__span-34-16><a id=__codelineno-34-16 name=__codelineno-34-16 href=#__codelineno-34-16></a><span class=go>2021-02-24 00:00:00+00:00    0.000000</span>
</span><span id=__span-34-17><a id=__codelineno-34-17 name=__codelineno-34-17 href=#__codelineno-34-17></a><span class=go>Freq: D, dtype: float64</span>
</span></code></pre></div> <p>So, when should you use each signal mode? Use direction-unaware signals when you have a single direction throughout an entire column, and direction-aware signals when you want more granular control, especially when positions must be closed under both directions. For example, to close out any position at the end of a day.</p> <h3 id=signal-function_1>Signal function<a class=headerlink href=#signal-function_1 title="Permanent link">&para;</a></h3> <p>Providing signals as pre-defined arrays offers one main advantage: caching. Even after you restart the runtime, there will not be any recompilation if you pass signal arrays of the same format again. Sometimes, however, you may want to trade some performance for added flexibility. This includes path-dependent cases, where signals depend on previous or current simulation state, making them impossible to generate in advance. Another use case is reducing RAM usage: by putting all indicator and signal generation logic into a single signal function, you avoid the need for any intermediate arrays. This is useful when you need to test a large number of parameters, or when you want to select which assets to trade from a large universe. These situations often require very wide arrays in RAM, but a signal function makes such arrays unnecessary.</p> <p>Let's implement the last example above, but without using any arrays!</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a><span class=gp>... </span>    <span class=n>ts</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>]</span>  <span class=c1># (1)!</span>
</span><span id=__span-35-4><a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>dt_nb</span><span class=o>.</span><span class=n>matches_date_nb</span><span class=p>(</span><span class=n>ts</span><span class=p>,</span> <span class=mi>2021</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>18</span><span class=p>):</span>  <span class=c1># (2)!</span>
</span><span id=__span-35-5><a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a><span class=gp>... </span>        <span class=k>return</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>  <span class=c1># (3)!</span>
</span><span id=__span-35-6><a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>dt_nb</span><span class=o>.</span><span class=n>matches_date_nb</span><span class=p>(</span><span class=n>ts</span><span class=p>,</span> <span class=mi>2021</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>21</span><span class=p>):</span>
</span><span id=__span-35-7><a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a><span class=gp>... </span>        <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-35-8><a id=__codelineno-35-8 name=__codelineno-35-8 href=#__codelineno-35-8></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>dt_nb</span><span class=o>.</span><span class=n>matches_date_nb</span><span class=p>(</span><span class=n>ts</span><span class=p>,</span> <span class=mi>2021</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>22</span><span class=p>):</span>
</span><span id=__span-35-9><a id=__codelineno-35-9 name=__codelineno-35-9 href=#__codelineno-35-9></a><span class=gp>... </span>        <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-35-10><a id=__codelineno-35-10 name=__codelineno-35-10 href=#__codelineno-35-10></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>dt_nb</span><span class=o>.</span><span class=n>matches_date_nb</span><span class=p>(</span><span class=n>ts</span><span class=p>,</span> <span class=mi>2021</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>24</span><span class=p>):</span>
</span><span id=__span-35-11><a id=__codelineno-35-11 name=__codelineno-35-11 href=#__codelineno-35-11></a><span class=gp>... </span>        <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>True</span>
</span><span id=__span-35-12><a id=__codelineno-35-12 name=__codelineno-35-12 href=#__codelineno-35-12></a><span class=gp>... </span>    <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-35-13><a id=__codelineno-35-13 name=__codelineno-35-13 href=#__codelineno-35-13></a>
</span><span id=__span-35-14><a id=__codelineno-35-14 name=__codelineno-35-14 href=#__codelineno-35-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-35-15><a id=__codelineno-35-15 name=__codelineno-35-15 href=#__codelineno-35-15></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>),</span>
</span><span id=__span-35-16><a id=__codelineno-35-16 name=__codelineno-35-16 href=#__codelineno-35-16></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span>
</span><span id=__span-35-17><a id=__codelineno-35-17 name=__codelineno-35-17 href=#__codelineno-35-17></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-35-18><a id=__codelineno-35-18 name=__codelineno-35-18 href=#__codelineno-35-18></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-35-19><a id=__codelineno-35-19 name=__codelineno-35-19 href=#__codelineno-35-19></a><span class=go>Open time</span>
</span><span id=__span-35-20><a id=__codelineno-35-20 name=__codelineno-35-20 href=#__codelineno-35-20></a><span class=go>2021-02-18 00:00:00+00:00    0.001940</span>
</span><span id=__span-35-21><a id=__codelineno-35-21 name=__codelineno-35-21 href=#__codelineno-35-21></a><span class=go>2021-02-19 00:00:00+00:00    0.001940</span>
</span><span id=__span-35-22><a id=__codelineno-35-22 name=__codelineno-35-22 href=#__codelineno-35-22></a><span class=go>2021-02-20 00:00:00+00:00    0.001940</span>
</span><span id=__span-35-23><a id=__codelineno-35-23 name=__codelineno-35-23 href=#__codelineno-35-23></a><span class=go>2021-02-21 00:00:00+00:00    0.000000</span>
</span><span id=__span-35-24><a id=__codelineno-35-24 name=__codelineno-35-24 href=#__codelineno-35-24></a><span class=go>2021-02-22 00:00:00+00:00   -0.002059</span>
</span><span id=__span-35-25><a id=__codelineno-35-25 name=__codelineno-35-25 href=#__codelineno-35-25></a><span class=go>2021-02-23 00:00:00+00:00   -0.002059</span>
</span><span id=__span-35-26><a id=__codelineno-35-26 name=__codelineno-35-26 href=#__codelineno-35-26></a><span class=go>2021-02-24 00:00:00+00:00    0.000000</span>
</span><span id=__span-35-27><a id=__codelineno-35-27 name=__codelineno-35-27 href=#__codelineno-35-27></a><span class=go>Freq: D, dtype: float64</span>
</span></code></pre></div> <ol> <li><code>c.index</code> returns an array with timestamps in nanosecond format, and <code>c.i</code> returns the current row. By applying the latter to the former, we get the current timestamp.</li> <li>Use <a href=https://vectorbt.pro/pvt_41531c19/api/utils/datetime_nb/#vectorbtpro.utils.datetime_nb.matches_date_nb>matches_date_nb</a> to check if the current day matches a specific date.</li> <li>Signal functions must return a set of direction-aware signals.</li> </ol> <p>We have replaced vectorized logic with iterative logic, which is usually more verbose but offers greater flexibility and resembles the format used in most open-source backtesting frameworks. However, this does not mean you must define everything iteratively. You can still pass one or more arrays and make decisions based on them. To do this, have the signal function accept arrays as positional arguments and select one element from each at each time step to generate the four signals. Then, pass the actual arrays to <abbr title="From-signals simulation method">FS</abbr> as a tuple using <code>signal_args</code>. Keep in mind that any array-like object must be a NumPy array, since Numba does not support Pandas.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-36-2><a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>entries</span><span class=p>,</span> <span class=n>exits</span><span class=p>,</span> <span class=n>short_entries</span><span class=p>,</span> <span class=n>short_exits</span><span class=p>):</span>
</span><span id=__span-36-3><a id=__codelineno-36-3 name=__codelineno-36-3 href=#__codelineno-36-3></a><span class=gp>... </span>    <span class=n>long_entry</span> <span class=o>=</span> <span class=n>entries</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-36-4><a id=__codelineno-36-4 name=__codelineno-36-4 href=#__codelineno-36-4></a><span class=gp>... </span>    <span class=n>long_exit</span> <span class=o>=</span> <span class=n>exits</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-36-5><a id=__codelineno-36-5 name=__codelineno-36-5 href=#__codelineno-36-5></a><span class=gp>... </span>    <span class=n>short_entry</span> <span class=o>=</span> <span class=n>short_entries</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-36-6><a id=__codelineno-36-6 name=__codelineno-36-6 href=#__codelineno-36-6></a><span class=gp>... </span>    <span class=n>short_exit</span> <span class=o>=</span> <span class=n>short_exits</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-36-7><a id=__codelineno-36-7 name=__codelineno-36-7 href=#__codelineno-36-7></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>long_entry</span><span class=p>,</span> <span class=n>long_exit</span><span class=p>,</span> <span class=n>short_entry</span><span class=p>,</span> <span class=n>short_exit</span>
</span><span id=__span-36-8><a id=__codelineno-36-8 name=__codelineno-36-8 href=#__codelineno-36-8></a>
</span><span id=__span-36-9><a id=__codelineno-36-9 name=__codelineno-36-9 href=#__codelineno-36-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-36-10><a id=__codelineno-36-10 name=__codelineno-36-10 href=#__codelineno-36-10></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>),</span>
</span><span id=__span-36-11><a id=__codelineno-36-11 name=__codelineno-36-11 href=#__codelineno-36-11></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-36-12><a id=__codelineno-36-12 name=__codelineno-36-12 href=#__codelineno-36-12></a><span class=gp>... </span>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-36-13><a id=__codelineno-36-13 name=__codelineno-36-13 href=#__codelineno-36-13></a><span class=gp>... </span>        <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-36-14><a id=__codelineno-36-14 name=__codelineno-36-14 href=#__codelineno-36-14></a><span class=gp>... </span>        <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-36-15><a id=__codelineno-36-15 name=__codelineno-36-15 href=#__codelineno-36-15></a><span class=gp>... </span>        <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-36-16><a id=__codelineno-36-16 name=__codelineno-36-16 href=#__codelineno-36-16></a><span class=gp>... </span>        <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>])</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-36-17><a id=__codelineno-36-17 name=__codelineno-36-17 href=#__codelineno-36-17></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-36-18><a id=__codelineno-36-18 name=__codelineno-36-18 href=#__codelineno-36-18></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-36-19><a id=__codelineno-36-19 name=__codelineno-36-19 href=#__codelineno-36-19></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-36-20><a id=__codelineno-36-20 name=__codelineno-36-20 href=#__codelineno-36-20></a><span class=go>Open time</span>
</span><span id=__span-36-21><a id=__codelineno-36-21 name=__codelineno-36-21 href=#__codelineno-36-21></a><span class=go>2021-02-18 00:00:00+00:00    0.001940</span>
</span><span id=__span-36-22><a id=__codelineno-36-22 name=__codelineno-36-22 href=#__codelineno-36-22></a><span class=go>2021-02-19 00:00:00+00:00    0.001940</span>
</span><span id=__span-36-23><a id=__codelineno-36-23 name=__codelineno-36-23 href=#__codelineno-36-23></a><span class=go>2021-02-20 00:00:00+00:00    0.001940</span>
</span><span id=__span-36-24><a id=__codelineno-36-24 name=__codelineno-36-24 href=#__codelineno-36-24></a><span class=go>2021-02-21 00:00:00+00:00    0.000000</span>
</span><span id=__span-36-25><a id=__codelineno-36-25 name=__codelineno-36-25 href=#__codelineno-36-25></a><span class=go>2021-02-22 00:00:00+00:00   -0.002059</span>
</span><span id=__span-36-26><a id=__codelineno-36-26 name=__codelineno-36-26 href=#__codelineno-36-26></a><span class=go>2021-02-23 00:00:00+00:00   -0.002059</span>
</span><span id=__span-36-27><a id=__codelineno-36-27 name=__codelineno-36-27 href=#__codelineno-36-27></a><span class=go>2021-02-24 00:00:00+00:00    0.000000</span>
</span><span id=__span-36-28><a id=__codelineno-36-28 name=__codelineno-36-28 href=#__codelineno-36-28></a><span class=go>Freq: D, dtype: float64</span>
</span></code></pre></div> <p>But what if we want to expand our data to multiple assets? The example above works only if each array remains one-dimensional, since only rows are selected in the signal function. To create shape-agnostic logic, you should use two-dimensional arrays for each input and select the current column in the signal function as well. However, there is another issue: you must handle broadcasting, which can be handled flexibly in the signal function, either manually with <a href=https://vectorbt.pro/pvt_41531c19/api/base/flex_indexing/#vectorbtpro.base.flex_indexing.flex_select_nb>flex_select_nb</a> or automatically with <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/iter_/#vectorbtpro.portfolio.nb.iter_.select_nb>select_nb</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>entries</span><span class=p>,</span> <span class=n>exits</span><span class=p>,</span> <span class=n>short_entries</span><span class=p>,</span> <span class=n>short_exits</span><span class=p>):</span>
</span><span id=__span-37-3><a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a><span class=gp>... </span>    <span class=n>long_entry</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>entries</span><span class=p>)</span>
</span><span id=__span-37-4><a id=__codelineno-37-4 name=__codelineno-37-4 href=#__codelineno-37-4></a><span class=gp>... </span>    <span class=n>long_exit</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>exits</span><span class=p>)</span>
</span><span id=__span-37-5><a id=__codelineno-37-5 name=__codelineno-37-5 href=#__codelineno-37-5></a><span class=gp>... </span>    <span class=n>short_entry</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>short_entries</span><span class=p>)</span>
</span><span id=__span-37-6><a id=__codelineno-37-6 name=__codelineno-37-6 href=#__codelineno-37-6></a><span class=gp>... </span>    <span class=n>short_exit</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>short_exits</span><span class=p>)</span>
</span><span id=__span-37-7><a id=__codelineno-37-7 name=__codelineno-37-7 href=#__codelineno-37-7></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>long_entry</span><span class=p>,</span> <span class=n>long_exit</span><span class=p>,</span> <span class=n>short_entry</span><span class=p>,</span> <span class=n>short_exit</span>
</span><span id=__span-37-8><a id=__codelineno-37-8 name=__codelineno-37-8 href=#__codelineno-37-8></a>
</span><span id=__span-37-9><a id=__codelineno-37-9 name=__codelineno-37-9 href=#__codelineno-37-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-37-10><a id=__codelineno-37-10 name=__codelineno-37-10 href=#__codelineno-37-10></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-37-11><a id=__codelineno-37-11 name=__codelineno-37-11 href=#__codelineno-37-11></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-37-12><a id=__codelineno-37-12 name=__codelineno-37-12 href=#__codelineno-37-12></a><span class=gp>... </span>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-37-13><a id=__codelineno-37-13 name=__codelineno-37-13 href=#__codelineno-37-13></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array</span><span class=p>(</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])),</span>
</span><span id=__span-37-14><a id=__codelineno-37-14 name=__codelineno-37-14 href=#__codelineno-37-14></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array</span><span class=p>(</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])),</span>
</span><span id=__span-37-15><a id=__codelineno-37-15 name=__codelineno-37-15 href=#__codelineno-37-15></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array</span><span class=p>(</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])),</span>
</span><span id=__span-37-16><a id=__codelineno-37-16 name=__codelineno-37-16 href=#__codelineno-37-16></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array</span><span class=p>(</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>]))</span>
</span><span id=__span-37-17><a id=__codelineno-37-17 name=__codelineno-37-17 href=#__codelineno-37-17></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-37-18><a id=__codelineno-37-18 name=__codelineno-37-18 href=#__codelineno-37-18></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-37-19><a id=__codelineno-37-19 name=__codelineno-37-19 href=#__codelineno-37-19></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-37-20><a id=__codelineno-37-20 name=__codelineno-37-20 href=#__codelineno-37-20></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-37-21><a id=__codelineno-37-21 name=__codelineno-37-21 href=#__codelineno-37-21></a><span class=go>Open time                                    </span>
</span><span id=__span-37-22><a id=__codelineno-37-22 name=__codelineno-37-22 href=#__codelineno-37-22></a><span class=go>2021-02-18 00:00:00+00:00  0.001940  0.051557</span>
</span><span id=__span-37-23><a id=__codelineno-37-23 name=__codelineno-37-23 href=#__codelineno-37-23></a><span class=go>2021-02-19 00:00:00+00:00  0.001940  0.051557</span>
</span><span id=__span-37-24><a id=__codelineno-37-24 name=__codelineno-37-24 href=#__codelineno-37-24></a><span class=go>2021-02-20 00:00:00+00:00  0.001940  0.051557</span>
</span><span id=__span-37-25><a id=__codelineno-37-25 name=__codelineno-37-25 href=#__codelineno-37-25></a><span class=go>2021-02-21 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-37-26><a id=__codelineno-37-26 name=__codelineno-37-26 href=#__codelineno-37-26></a><span class=go>2021-02-22 00:00:00+00:00 -0.002059 -0.056080</span>
</span><span id=__span-37-27><a id=__codelineno-37-27 name=__codelineno-37-27 href=#__codelineno-37-27></a><span class=go>2021-02-23 00:00:00+00:00 -0.002059 -0.056080</span>
</span><span id=__span-37-28><a id=__codelineno-37-28 name=__codelineno-37-28 href=#__codelineno-37-28></a><span class=go>2021-02-24 00:00:00+00:00  0.000000  0.000000</span>
</span></code></pre></div> <p>Now our strategy can be applied to any number of columns. Great! But even this is not the most flexible design <img alt=ðŸ˜®â€ðŸ’¨ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f62e-200d-1f4a8.svg title=:face_exhaling:> What if the user provides a signal array that does not have the same number of rows as the data? If bound checking is enabled, you would get an "index is out of bounds" error because the signal function would try to select an element that does not exist. To ensure an array broadcasts against the data automatically before simulation, define it in the <code>broadcast_named_args</code> dictionary, and then use a template to substitute its name with the broadcasted array in <code>signal_args</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entries</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>({</span><span class=n>vbt</span><span class=o>.</span><span class=n>utc_timestamp</span><span class=p>(</span><span class=s2>&quot;2021-02-18&quot;</span><span class=p>):</span> <span class=kc>True</span><span class=p>})</span>
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>({</span><span class=n>vbt</span><span class=o>.</span><span class=n>utc_timestamp</span><span class=p>(</span><span class=s2>&quot;2021-02-21&quot;</span><span class=p>):</span> <span class=kc>True</span><span class=p>})</span>
</span><span id=__span-38-3><a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>short_entries</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>({</span><span class=n>vbt</span><span class=o>.</span><span class=n>utc_timestamp</span><span class=p>(</span><span class=s2>&quot;2021-02-22&quot;</span><span class=p>):</span> <span class=kc>True</span><span class=p>})</span>
</span><span id=__span-38-4><a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>short_exits</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>({</span><span class=n>vbt</span><span class=o>.</span><span class=n>utc_timestamp</span><span class=p>(</span><span class=s2>&quot;2021-02-24&quot;</span><span class=p>):</span> <span class=kc>True</span><span class=p>})</span>
</span><span id=__span-38-5><a id=__codelineno-38-5 name=__codelineno-38-5 href=#__codelineno-38-5></a>
</span><span id=__span-38-6><a id=__codelineno-38-6 name=__codelineno-38-6 href=#__codelineno-38-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-38-7><a id=__codelineno-38-7 name=__codelineno-38-7 href=#__codelineno-38-7></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-38-8><a id=__codelineno-38-8 name=__codelineno-38-8 href=#__codelineno-38-8></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-38-9><a id=__codelineno-38-9 name=__codelineno-38-9 href=#__codelineno-38-9></a><span class=gp>... </span>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-38-10><a id=__codelineno-38-10 name=__codelineno-38-10 href=#__codelineno-38-10></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;entries&quot;</span><span class=p>),</span>  <span class=c1># (1)!</span>
</span><span id=__span-38-11><a id=__codelineno-38-11 name=__codelineno-38-11 href=#__codelineno-38-11></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;exits&quot;</span><span class=p>),</span>
</span><span id=__span-38-12><a id=__codelineno-38-12 name=__codelineno-38-12 href=#__codelineno-38-12></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;short_entries&quot;</span><span class=p>),</span>
</span><span id=__span-38-13><a id=__codelineno-38-13 name=__codelineno-38-13 href=#__codelineno-38-13></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;short_exits&quot;</span><span class=p>)</span>
</span><span id=__span-38-14><a id=__codelineno-38-14 name=__codelineno-38-14 href=#__codelineno-38-14></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-38-15><a id=__codelineno-38-15 name=__codelineno-38-15 href=#__codelineno-38-15></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-38-16><a id=__codelineno-38-16 name=__codelineno-38-16 href=#__codelineno-38-16></a><span class=gp>... </span>        <span class=n>entries</span><span class=o>=</span><span class=n>entries</span><span class=p>,</span>
</span><span id=__span-38-17><a id=__codelineno-38-17 name=__codelineno-38-17 href=#__codelineno-38-17></a><span class=gp>... </span>        <span class=n>exits</span><span class=o>=</span><span class=n>exits</span><span class=p>,</span>
</span><span id=__span-38-18><a id=__codelineno-38-18 name=__codelineno-38-18 href=#__codelineno-38-18></a><span class=gp>... </span>        <span class=n>short_entries</span><span class=o>=</span><span class=n>short_entries</span><span class=p>,</span>
</span><span id=__span-38-19><a id=__codelineno-38-19 name=__codelineno-38-19 href=#__codelineno-38-19></a><span class=gp>... </span>        <span class=n>short_exits</span><span class=o>=</span><span class=n>short_exits</span>
</span><span id=__span-38-20><a id=__codelineno-38-20 name=__codelineno-38-20 href=#__codelineno-38-20></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-38-21><a id=__codelineno-38-21 name=__codelineno-38-21 href=#__codelineno-38-21></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-38-22><a id=__codelineno-38-22 name=__codelineno-38-22 href=#__codelineno-38-22></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-38-23><a id=__codelineno-38-23 name=__codelineno-38-23 href=#__codelineno-38-23></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-38-24><a id=__codelineno-38-24 name=__codelineno-38-24 href=#__codelineno-38-24></a><span class=go>2021-02-18 00:00:00+00:00  0.001940  0.051557</span>
</span><span id=__span-38-25><a id=__codelineno-38-25 name=__codelineno-38-25 href=#__codelineno-38-25></a><span class=go>2021-02-19 00:00:00+00:00  0.001940  0.051557</span>
</span><span id=__span-38-26><a id=__codelineno-38-26 name=__codelineno-38-26 href=#__codelineno-38-26></a><span class=go>2021-02-20 00:00:00+00:00  0.001940  0.051557</span>
</span><span id=__span-38-27><a id=__codelineno-38-27 name=__codelineno-38-27 href=#__codelineno-38-27></a><span class=go>2021-02-21 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-38-28><a id=__codelineno-38-28 name=__codelineno-38-28 href=#__codelineno-38-28></a><span class=go>2021-02-22 00:00:00+00:00 -0.002059 -0.056080</span>
</span><span id=__span-38-29><a id=__codelineno-38-29 name=__codelineno-38-29 href=#__codelineno-38-29></a><span class=go>2021-02-23 00:00:00+00:00 -0.002059 -0.056080</span>
</span><span id=__span-38-30><a id=__codelineno-38-30 name=__codelineno-38-30 href=#__codelineno-38-30></a><span class=go>2021-02-24 00:00:00+00:00  0.000000  0.000000</span>
</span></code></pre></div> <ol> <li><code>entries</code> is recognized as a key in <code>broadcast_named_args</code>.</li> </ol> <p>Our setup now works just like the built-in arguments <code>entries</code>, <code>exits</code>, <code>short_entries</code>, and <code>short_exits</code> <img alt=ðŸª„ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1fa84.svg title=:magic_wand:> You no longer need to convert them to NumPy arrays, as the broadcaster takes care of this automatically. This also allows you to use index dictionaries and other advanced broadcasting features:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-39-2><a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-39-3><a id=__codelineno-39-3 name=__codelineno-39-3 href=#__codelineno-39-3></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-39-4><a id=__codelineno-39-4 name=__codelineno-39-4 href=#__codelineno-39-4></a><span class=gp>... </span>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-39-5><a id=__codelineno-39-5 name=__codelineno-39-5 href=#__codelineno-39-5></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;entries&quot;</span><span class=p>),</span>
</span><span id=__span-39-6><a id=__codelineno-39-6 name=__codelineno-39-6 href=#__codelineno-39-6></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;exits&quot;</span><span class=p>),</span>
</span><span id=__span-39-7><a id=__codelineno-39-7 name=__codelineno-39-7 href=#__codelineno-39-7></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;short_entries&quot;</span><span class=p>),</span>
</span><span id=__span-39-8><a id=__codelineno-39-8 name=__codelineno-39-8 href=#__codelineno-39-8></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;short_exits&quot;</span><span class=p>)</span>
</span><span id=__span-39-9><a id=__codelineno-39-9 name=__codelineno-39-9 href=#__codelineno-39-9></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-39-10><a id=__codelineno-39-10 name=__codelineno-39-10 href=#__codelineno-39-10></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-39-11><a id=__codelineno-39-11 name=__codelineno-39-11 href=#__codelineno-39-11></a><span class=gp>... </span>        <span class=n>entries</span><span class=o>=</span>      <span class=n>vbt</span><span class=o>.</span><span class=n>index_dict</span><span class=p>({</span><span class=s2>&quot;2021-02-18&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span> <span class=s2>&quot;_def&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>}),</span>
</span><span id=__span-39-12><a id=__codelineno-39-12 name=__codelineno-39-12 href=#__codelineno-39-12></a><span class=gp>... </span>        <span class=n>exits</span><span class=o>=</span>        <span class=n>vbt</span><span class=o>.</span><span class=n>index_dict</span><span class=p>({</span><span class=s2>&quot;2021-02-21&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span> <span class=s2>&quot;_def&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>}),</span>
</span><span id=__span-39-13><a id=__codelineno-39-13 name=__codelineno-39-13 href=#__codelineno-39-13></a><span class=gp>... </span>        <span class=n>short_entries</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>index_dict</span><span class=p>({</span><span class=s2>&quot;2021-02-22&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span> <span class=s2>&quot;_def&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>}),</span>
</span><span id=__span-39-14><a id=__codelineno-39-14 name=__codelineno-39-14 href=#__codelineno-39-14></a><span class=gp>... </span>        <span class=n>short_exits</span><span class=o>=</span>  <span class=n>vbt</span><span class=o>.</span><span class=n>index_dict</span><span class=p>({</span><span class=s2>&quot;2021-02-24&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span> <span class=s2>&quot;_def&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>})</span>
</span><span id=__span-39-15><a id=__codelineno-39-15 name=__codelineno-39-15 href=#__codelineno-39-15></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-39-16><a id=__codelineno-39-16 name=__codelineno-39-16 href=#__codelineno-39-16></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <p>However, backtesting signals on fixed dates is rarely our main interest. Let's create a signal function that produces a long entry signal when there is an above-crossover and a short entry signal when there is a below-crossover of two moving average arrays. We will also parameterize this strategy by introducing a flexible parameter, <code>wait</code>, that controls the number of bars to wait after a crossover has been detected before placing a signal. If an opposite crossover occurs during this time, the signal is canceled, so <code>wait</code> works as a confirmation period. This parameter will broadcast with the data, letting you define it per row, column, or element.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-40-1><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-40-2><a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>fast_sma</span><span class=p>,</span> <span class=n>slow_sma</span><span class=p>,</span> <span class=n>wait</span><span class=p>):</span>
</span><span id=__span-40-3><a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a><span class=gp>... </span>    <span class=n>curr_wait</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>wait</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-40-4><a id=__codelineno-40-4 name=__codelineno-40-4 href=#__codelineno-40-4></a><span class=gp>... </span>    <span class=n>i_wait</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>-</span> <span class=n>curr_wait</span>  <span class=c1># (2)!</span>
</span><span id=__span-40-5><a id=__codelineno-40-5 name=__codelineno-40-5 href=#__codelineno-40-5></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>i_wait</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>  <span class=c1># (3)!</span>
</span><span id=__span-40-6><a id=__codelineno-40-6 name=__codelineno-40-6 href=#__codelineno-40-6></a><span class=gp>... </span>        <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-40-7><a id=__codelineno-40-7 name=__codelineno-40-7 href=#__codelineno-40-7></a><span class=gp>...</span>
</span><span id=__span-40-8><a id=__codelineno-40-8 name=__codelineno-40-8 href=#__codelineno-40-8></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>iter_crossed_above_nb</span><span class=p>(</span><span class=n>fast_sma</span><span class=p>,</span> <span class=n>slow_sma</span><span class=p>,</span> <span class=n>i_wait</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>):</span>  <span class=c1># (4)!</span>
</span><span id=__span-40-9><a id=__codelineno-40-9 name=__codelineno-40-9 href=#__codelineno-40-9></a><span class=gp>... </span>        <span class=n>cross_confirmed</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-40-10><a id=__codelineno-40-10 name=__codelineno-40-10 href=#__codelineno-40-10></a><span class=gp>... </span>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>i_wait</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>):</span>  <span class=c1># (5)!</span>
</span><span id=__span-40-11><a id=__codelineno-40-11 name=__codelineno-40-11 href=#__codelineno-40-11></a><span class=gp>... </span>            <span class=k>if</span> <span class=ow>not</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>iter_above_nb</span><span class=p>(</span><span class=n>fast_sma</span><span class=p>,</span> <span class=n>slow_sma</span><span class=p>,</span> <span class=n>j</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>):</span>
</span><span id=__span-40-12><a id=__codelineno-40-12 name=__codelineno-40-12 href=#__codelineno-40-12></a><span class=gp>... </span>                <span class=n>cross_confirmed</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-40-13><a id=__codelineno-40-13 name=__codelineno-40-13 href=#__codelineno-40-13></a><span class=gp>... </span>                <span class=k>break</span>
</span><span id=__span-40-14><a id=__codelineno-40-14 name=__codelineno-40-14 href=#__codelineno-40-14></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>cross_confirmed</span><span class=p>:</span>
</span><span id=__span-40-15><a id=__codelineno-40-15 name=__codelineno-40-15 href=#__codelineno-40-15></a><span class=gp>... </span>            <span class=k>return</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-40-16><a id=__codelineno-40-16 name=__codelineno-40-16 href=#__codelineno-40-16></a><span class=gp>...</span>
</span><span id=__span-40-17><a id=__codelineno-40-17 name=__codelineno-40-17 href=#__codelineno-40-17></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>iter_crossed_below_nb</span><span class=p>(</span><span class=n>fast_sma</span><span class=p>,</span> <span class=n>slow_sma</span><span class=p>,</span> <span class=n>i_wait</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>):</span>  <span class=c1># (6)!</span>
</span><span id=__span-40-18><a id=__codelineno-40-18 name=__codelineno-40-18 href=#__codelineno-40-18></a><span class=gp>... </span>        <span class=n>cross_confirmed</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-40-19><a id=__codelineno-40-19 name=__codelineno-40-19 href=#__codelineno-40-19></a><span class=gp>... </span>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>i_wait</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>):</span>
</span><span id=__span-40-20><a id=__codelineno-40-20 name=__codelineno-40-20 href=#__codelineno-40-20></a><span class=gp>... </span>            <span class=k>if</span> <span class=ow>not</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>iter_below_nb</span><span class=p>(</span><span class=n>fast_sma</span><span class=p>,</span> <span class=n>slow_sma</span><span class=p>,</span> <span class=n>j</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>):</span>
</span><span id=__span-40-21><a id=__codelineno-40-21 name=__codelineno-40-21 href=#__codelineno-40-21></a><span class=gp>... </span>                <span class=n>cross_confirmed</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-40-22><a id=__codelineno-40-22 name=__codelineno-40-22 href=#__codelineno-40-22></a><span class=gp>... </span>                <span class=k>break</span>
</span><span id=__span-40-23><a id=__codelineno-40-23 name=__codelineno-40-23 href=#__codelineno-40-23></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>cross_confirmed</span><span class=p>:</span>
</span><span id=__span-40-24><a id=__codelineno-40-24 name=__codelineno-40-24 href=#__codelineno-40-24></a><span class=gp>... </span>            <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-40-25><a id=__codelineno-40-25 name=__codelineno-40-25 href=#__codelineno-40-25></a><span class=gp>...</span>
</span><span id=__span-40-26><a id=__codelineno-40-26 name=__codelineno-40-26 href=#__codelineno-40-26></a><span class=gp>... </span>    <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-40-27><a id=__codelineno-40-27 name=__codelineno-40-27 href=#__codelineno-40-27></a>
</span><span id=__span-40-28><a id=__codelineno-40-28 name=__codelineno-40-28 href=#__codelineno-40-28></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fast_sma</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=s2>&quot;sma&quot;</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=n>short_name</span><span class=o>=</span><span class=s2>&quot;fast_sma&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>real</span>
</span><span id=__span-40-29><a id=__codelineno-40-29 name=__codelineno-40-29 href=#__codelineno-40-29></a><span class=gp>&gt;&gt;&gt; </span><span class=n>slow_sma</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=s2>&quot;sma&quot;</span><span class=p>,</span> <span class=mi>50</span><span class=p>,</span> <span class=n>short_name</span><span class=o>=</span><span class=s2>&quot;slow_sma&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>real</span>
</span><span id=__span-40-30><a id=__codelineno-40-30 name=__codelineno-40-30 href=#__codelineno-40-30></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-40-31><a id=__codelineno-40-31 name=__codelineno-40-31 href=#__codelineno-40-31></a><span class=gp>... </span>    <span class=n>data</span><span class=p>,</span>
</span><span id=__span-40-32><a id=__codelineno-40-32 name=__codelineno-40-32 href=#__codelineno-40-32></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-40-33><a id=__codelineno-40-33 name=__codelineno-40-33 href=#__codelineno-40-33></a><span class=gp>... </span>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-40-34><a id=__codelineno-40-34 name=__codelineno-40-34 href=#__codelineno-40-34></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;fast_sma&quot;</span><span class=p>),</span>
</span><span id=__span-40-35><a id=__codelineno-40-35 name=__codelineno-40-35 href=#__codelineno-40-35></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;slow_sma&quot;</span><span class=p>),</span>
</span><span id=__span-40-36><a id=__codelineno-40-36 name=__codelineno-40-36 href=#__codelineno-40-36></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;wait&quot;</span><span class=p>)</span>
</span><span id=__span-40-37><a id=__codelineno-40-37 name=__codelineno-40-37 href=#__codelineno-40-37></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-40-38><a id=__codelineno-40-38 name=__codelineno-40-38 href=#__codelineno-40-38></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-40-39><a id=__codelineno-40-39 name=__codelineno-40-39 href=#__codelineno-40-39></a><span class=gp>... </span>        <span class=n>fast_sma</span><span class=o>=</span><span class=n>fast_sma</span><span class=p>,</span>
</span><span id=__span-40-40><a id=__codelineno-40-40 name=__codelineno-40-40 href=#__codelineno-40-40></a><span class=gp>... </span>        <span class=n>slow_sma</span><span class=o>=</span><span class=n>slow_sma</span><span class=p>,</span>
</span><span id=__span-40-41><a id=__codelineno-40-41 name=__codelineno-40-41 href=#__codelineno-40-41></a><span class=gp>... </span>        <span class=n>wait</span><span class=o>=</span><span class=mi>0</span>  <span class=c1># (7)!</span>
</span><span id=__span-40-42><a id=__codelineno-40-42 name=__codelineno-40-42 href=#__codelineno-40-42></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-40-43><a id=__codelineno-40-43 name=__codelineno-40-43 href=#__codelineno-40-43></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-40-44><a id=__codelineno-40-44 name=__codelineno-40-44 href=#__codelineno-40-44></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>count</span><span class=p>()</span>
</span><span id=__span-40-45><a id=__codelineno-40-45 name=__codelineno-40-45 href=#__codelineno-40-45></a><span class=go>fast_sma_timeperiod  slow_sma_timeperiod  symbol </span>
</span><span id=__span-40-46><a id=__codelineno-40-46 name=__codelineno-40-46 href=#__codelineno-40-46></a><span class=go>20                   50                   BTCUSDT    40</span>
</span><span id=__span-40-47><a id=__codelineno-40-47 name=__codelineno-40-47 href=#__codelineno-40-47></a><span class=go>                                          ETHUSDT    32</span>
</span><span id=__span-40-48><a id=__codelineno-40-48 name=__codelineno-40-48 href=#__codelineno-40-48></a><span class=go>Name: count, dtype: int64</span>
</span></code></pre></div> <ol> <li>Since the confirmation period is an array-like parameter, get the value defined for the current row and column.</li> <li>Calculate the row where the crossover should have occurred.</li> <li>If the current period is less than the confirmation period, return no signal.</li> <li>Check whether the fast SMA has crossed above the slow SMA at the current bar.</li> <li>If true, loop over the confirmation period (including the current bar) and verify that the fast SMA has always stayed above the slow SMA for confirmation.</li> <li>Apply the same logic for the below-crossover.</li> <li>The waiting period is a flexible parameter that broadcasts with other arrays.</li> </ol> <p>To confirm that our strategy has produced the correct number of orders, let's manually count the total number of crossover signals:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-41-1><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>n_crossed_above</span> <span class=o>=</span> <span class=n>fast_sma</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>crossed_above</span><span class=p>(</span><span class=n>slow_sma</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-41-2><a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>n_crossed_below</span> <span class=o>=</span> <span class=n>fast_sma</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>crossed_below</span><span class=p>(</span><span class=n>slow_sma</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-41-3><a id=__codelineno-41-3 name=__codelineno-41-3 href=#__codelineno-41-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>n_crossed_above</span> <span class=o>+</span> <span class=n>n_crossed_below</span>
</span><span id=__span-41-4><a id=__codelineno-41-4 name=__codelineno-41-4 href=#__codelineno-41-4></a><span class=go>fast_sma_timeperiod  slow_sma_timeperiod  symbol </span>
</span><span id=__span-41-5><a id=__codelineno-41-5 name=__codelineno-41-5 href=#__codelineno-41-5></a><span class=go>20                   50                   BTCUSDT    40</span>
</span><span id=__span-41-6><a id=__codelineno-41-6 name=__codelineno-41-6 href=#__codelineno-41-6></a><span class=go>                                          ETHUSDT    32</span>
</span><span id=__span-41-7><a id=__codelineno-41-7 name=__codelineno-41-7 href=#__codelineno-41-7></a><span class=go>Name: count, dtype: int64</span>
</span></code></pre></div> <p>To demonstrate the full power of VBT's broadcaster, let's test the confirmation period with 0, 1, 7, and 30 bars by wrapping the parameter using <a href=https://vectorbt.pro/pvt_41531c19/api/utils/params/#vectorbtpro.utils.params.Param>Param</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-42-1><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-42-2><a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a><span class=gp>... </span>    <span class=n>data</span><span class=p>,</span>
</span><span id=__span-42-3><a id=__codelineno-42-3 name=__codelineno-42-3 href=#__codelineno-42-3></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-42-4><a id=__codelineno-42-4 name=__codelineno-42-4 href=#__codelineno-42-4></a><span class=gp>... </span>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-42-5><a id=__codelineno-42-5 name=__codelineno-42-5 href=#__codelineno-42-5></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;fast_sma&quot;</span><span class=p>),</span>
</span><span id=__span-42-6><a id=__codelineno-42-6 name=__codelineno-42-6 href=#__codelineno-42-6></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;slow_sma&quot;</span><span class=p>),</span>
</span><span id=__span-42-7><a id=__codelineno-42-7 name=__codelineno-42-7 href=#__codelineno-42-7></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;wait&quot;</span><span class=p>)</span>
</span><span id=__span-42-8><a id=__codelineno-42-8 name=__codelineno-42-8 href=#__codelineno-42-8></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-42-9><a id=__codelineno-42-9 name=__codelineno-42-9 href=#__codelineno-42-9></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-42-10><a id=__codelineno-42-10 name=__codelineno-42-10 href=#__codelineno-42-10></a><span class=gp>... </span>        <span class=n>fast_sma</span><span class=o>=</span><span class=n>fast_sma</span><span class=p>,</span>
</span><span id=__span-42-11><a id=__codelineno-42-11 name=__codelineno-42-11 href=#__codelineno-42-11></a><span class=gp>... </span>        <span class=n>slow_sma</span><span class=o>=</span><span class=n>slow_sma</span><span class=p>,</span>
</span><span id=__span-42-12><a id=__codelineno-42-12 name=__codelineno-42-12 href=#__codelineno-42-12></a><span class=gp>... </span>        <span class=n>wait</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=mi>30</span><span class=p>])</span>
</span><span id=__span-42-13><a id=__codelineno-42-13 name=__codelineno-42-13 href=#__codelineno-42-13></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-42-14><a id=__codelineno-42-14 name=__codelineno-42-14 href=#__codelineno-42-14></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-42-15><a id=__codelineno-42-15 name=__codelineno-42-15 href=#__codelineno-42-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>count</span><span class=p>()</span>
</span><span id=__span-42-16><a id=__codelineno-42-16 name=__codelineno-42-16 href=#__codelineno-42-16></a><span class=go>wait  fast_sma_timeperiod  slow_sma_timeperiod  symbol </span>
</span><span id=__span-42-17><a id=__codelineno-42-17 name=__codelineno-42-17 href=#__codelineno-42-17></a><span class=go>0     20                   50                   BTCUSDT    40</span>
</span><span id=__span-42-18><a id=__codelineno-42-18 name=__codelineno-42-18 href=#__codelineno-42-18></a><span class=go>                                                ETHUSDT    32</span>
</span><span id=__span-42-19><a id=__codelineno-42-19 name=__codelineno-42-19 href=#__codelineno-42-19></a><span class=go>1     20                   50                   BTCUSDT    38</span>
</span><span id=__span-42-20><a id=__codelineno-42-20 name=__codelineno-42-20 href=#__codelineno-42-20></a><span class=go>                                                ETHUSDT    32</span>
</span><span id=__span-42-21><a id=__codelineno-42-21 name=__codelineno-42-21 href=#__codelineno-42-21></a><span class=go>7     20                   50                   BTCUSDT    36</span>
</span><span id=__span-42-22><a id=__codelineno-42-22 name=__codelineno-42-22 href=#__codelineno-42-22></a><span class=go>                                                ETHUSDT    30</span>
</span><span id=__span-42-23><a id=__codelineno-42-23 name=__codelineno-42-23 href=#__codelineno-42-23></a><span class=go>30    20                   50                   BTCUSDT    14</span>
</span><span id=__span-42-24><a id=__codelineno-42-24 name=__codelineno-42-24 href=#__codelineno-42-24></a><span class=go>                                                ETHUSDT    16</span>
</span><span id=__span-42-25><a id=__codelineno-42-25 name=__codelineno-42-25 href=#__codelineno-42-25></a><span class=go>Name: count, dtype: int64</span>
</span></code></pre></div> <p>We can see that the number of orders gradually decreases as the confirmation period increases. If you appreciate VBT for its performance, you might notice that although the number of crossovers is low, having a second loop is not ideal for performance. We can rewrite the logic to iterate over the data only once. To do this, we need to introduce a temporary array that stores the index of the latest crossover confirmed so far, and once the confirmation period is complete, we can issue a signal. This is a perfect example of how to temporarily store and then share data between multiple calls to the signal function!</p> <p>The temporary array we create will be a one-dimensional NumPy array where the latest crossover index is stored for each column. While a regular typed list could work, remember that NumPy arrays have advantages when used with Numba. Why store data per column and not just one value? Using a single value works for ungrouped portfolios, where columns are processed one after another. However, if the portfolio is grouped, columns are processed in a zigzag manner within their groups, so you should always structure your temporary data per column to be safe. Another challenge is creating such an array: how do we know the number of columns in advance? Fortunately, we can use a template!</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-43-1><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-43-2><a id=__codelineno-43-2 name=__codelineno-43-2 href=#__codelineno-43-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>fast_sma</span><span class=p>,</span> <span class=n>slow_sma</span><span class=p>,</span> <span class=n>wait</span><span class=p>,</span> <span class=n>temp_coi</span><span class=p>):</span>  <span class=c1># (1)!</span>
</span><span id=__span-43-3><a id=__codelineno-43-3 name=__codelineno-43-3 href=#__codelineno-43-3></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>temp_coi</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>:</span>  <span class=c1># (2)!</span>
</span><span id=__span-43-4><a id=__codelineno-43-4 name=__codelineno-43-4 href=#__codelineno-43-4></a><span class=gp>... </span>        <span class=n>crossed_above</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>iter_crossed_above_nb</span><span class=p>(</span>
</span><span id=__span-43-5><a id=__codelineno-43-5 name=__codelineno-43-5 href=#__codelineno-43-5></a><span class=gp>... </span>            <span class=n>fast_sma</span><span class=p>,</span> <span class=n>slow_sma</span><span class=p>,</span> <span class=n>temp_coi</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>],</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span>
</span><span id=__span-43-6><a id=__codelineno-43-6 name=__codelineno-43-6 href=#__codelineno-43-6></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-43-7><a id=__codelineno-43-7 name=__codelineno-43-7 href=#__codelineno-43-7></a><span class=gp>... </span>        <span class=n>crossed_below</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>iter_crossed_below_nb</span><span class=p>(</span>
</span><span id=__span-43-8><a id=__codelineno-43-8 name=__codelineno-43-8 href=#__codelineno-43-8></a><span class=gp>... </span>            <span class=n>fast_sma</span><span class=p>,</span> <span class=n>slow_sma</span><span class=p>,</span> <span class=n>temp_coi</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>],</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span>
</span><span id=__span-43-9><a id=__codelineno-43-9 name=__codelineno-43-9 href=#__codelineno-43-9></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-43-10><a id=__codelineno-43-10 name=__codelineno-43-10 href=#__codelineno-43-10></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>crossed_above</span><span class=p>:</span>  <span class=c1># (3)!</span>
</span><span id=__span-43-11><a id=__codelineno-43-11 name=__codelineno-43-11 href=#__codelineno-43-11></a><span class=gp>... </span>            <span class=k>if</span> <span class=ow>not</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>iter_above_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>fast_sma</span><span class=p>,</span> <span class=n>slow_sma</span><span class=p>):</span>  <span class=c1># (4)!</span>
</span><span id=__span-43-12><a id=__codelineno-43-12 name=__codelineno-43-12 href=#__codelineno-43-12></a><span class=gp>... </span>                <span class=n>temp_coi</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>
</span><span id=__span-43-13><a id=__codelineno-43-13 name=__codelineno-43-13 href=#__codelineno-43-13></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>crossed_below</span><span class=p>:</span>
</span><span id=__span-43-14><a id=__codelineno-43-14 name=__codelineno-43-14 href=#__codelineno-43-14></a><span class=gp>... </span>            <span class=k>if</span> <span class=ow>not</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>iter_below_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>fast_sma</span><span class=p>,</span> <span class=n>slow_sma</span><span class=p>):</span>
</span><span id=__span-43-15><a id=__codelineno-43-15 name=__codelineno-43-15 href=#__codelineno-43-15></a><span class=gp>... </span>                <span class=n>temp_coi</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>
</span><span id=__span-43-16><a id=__codelineno-43-16 name=__codelineno-43-16 href=#__codelineno-43-16></a><span class=gp>...</span>
</span><span id=__span-43-17><a id=__codelineno-43-17 name=__codelineno-43-17 href=#__codelineno-43-17></a><span class=gp>... </span>    <span class=n>curr_wait</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>wait</span><span class=p>)</span>
</span><span id=__span-43-18><a id=__codelineno-43-18 name=__codelineno-43-18 href=#__codelineno-43-18></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>temp_coi</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>:</span>  <span class=c1># (5)!</span>
</span><span id=__span-43-19><a id=__codelineno-43-19 name=__codelineno-43-19 href=#__codelineno-43-19></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>-</span> <span class=n>temp_coi</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>==</span> <span class=n>curr_wait</span><span class=p>:</span>
</span><span id=__span-43-20><a id=__codelineno-43-20 name=__codelineno-43-20 href=#__codelineno-43-20></a><span class=gp>... </span>            <span class=k>if</span> <span class=n>crossed_above</span><span class=p>:</span>
</span><span id=__span-43-21><a id=__codelineno-43-21 name=__codelineno-43-21 href=#__codelineno-43-21></a><span class=gp>... </span>                <span class=n>temp_coi</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>
</span><span id=__span-43-22><a id=__codelineno-43-22 name=__codelineno-43-22 href=#__codelineno-43-22></a><span class=gp>... </span>                <span class=k>return</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-43-23><a id=__codelineno-43-23 name=__codelineno-43-23 href=#__codelineno-43-23></a><span class=gp>... </span>            <span class=k>if</span> <span class=n>crossed_below</span><span class=p>:</span>
</span><span id=__span-43-24><a id=__codelineno-43-24 name=__codelineno-43-24 href=#__codelineno-43-24></a><span class=gp>... </span>                <span class=n>temp_coi</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>
</span><span id=__span-43-25><a id=__codelineno-43-25 name=__codelineno-43-25 href=#__codelineno-43-25></a><span class=gp>... </span>                <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-43-26><a id=__codelineno-43-26 name=__codelineno-43-26 href=#__codelineno-43-26></a><span class=gp>... </span>    <span class=k>else</span><span class=p>:</span>  <span class=c1># (6)!</span>
</span><span id=__span-43-27><a id=__codelineno-43-27 name=__codelineno-43-27 href=#__codelineno-43-27></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>iter_crossed_above_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>fast_sma</span><span class=p>,</span> <span class=n>slow_sma</span><span class=p>):</span>
</span><span id=__span-43-28><a id=__codelineno-43-28 name=__codelineno-43-28 href=#__codelineno-43-28></a><span class=gp>... </span>            <span class=k>if</span> <span class=n>curr_wait</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-43-29><a id=__codelineno-43-29 name=__codelineno-43-29 href=#__codelineno-43-29></a><span class=gp>... </span>                <span class=k>return</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-43-30><a id=__codelineno-43-30 name=__codelineno-43-30 href=#__codelineno-43-30></a><span class=gp>... </span>            <span class=n>temp_coi</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span>
</span><span id=__span-43-31><a id=__codelineno-43-31 name=__codelineno-43-31 href=#__codelineno-43-31></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>iter_crossed_below_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>fast_sma</span><span class=p>,</span> <span class=n>slow_sma</span><span class=p>):</span>
</span><span id=__span-43-32><a id=__codelineno-43-32 name=__codelineno-43-32 href=#__codelineno-43-32></a><span class=gp>... </span>            <span class=k>if</span> <span class=n>curr_wait</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-43-33><a id=__codelineno-43-33 name=__codelineno-43-33 href=#__codelineno-43-33></a><span class=gp>... </span>                <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-43-34><a id=__codelineno-43-34 name=__codelineno-43-34 href=#__codelineno-43-34></a><span class=gp>... </span>            <span class=n>temp_coi</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span>
</span><span id=__span-43-35><a id=__codelineno-43-35 name=__codelineno-43-35 href=#__codelineno-43-35></a><span class=gp>...</span>
</span><span id=__span-43-36><a id=__codelineno-43-36 name=__codelineno-43-36 href=#__codelineno-43-36></a><span class=gp>... </span>    <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-43-37><a id=__codelineno-43-37 name=__codelineno-43-37 href=#__codelineno-43-37></a>
</span><span id=__span-43-38><a id=__codelineno-43-38 name=__codelineno-43-38 href=#__codelineno-43-38></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-43-39><a id=__codelineno-43-39 name=__codelineno-43-39 href=#__codelineno-43-39></a><span class=gp>... </span>    <span class=n>data</span><span class=p>,</span>
</span><span id=__span-43-40><a id=__codelineno-43-40 name=__codelineno-43-40 href=#__codelineno-43-40></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-43-41><a id=__codelineno-43-41 name=__codelineno-43-41 href=#__codelineno-43-41></a><span class=gp>... </span>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-43-42><a id=__codelineno-43-42 name=__codelineno-43-42 href=#__codelineno-43-42></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;fast_sma&quot;</span><span class=p>),</span>
</span><span id=__span-43-43><a id=__codelineno-43-43 name=__codelineno-43-43 href=#__codelineno-43-43></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;slow_sma&quot;</span><span class=p>),</span>
</span><span id=__span-43-44><a id=__codelineno-43-44 name=__codelineno-43-44 href=#__codelineno-43-44></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;wait&quot;</span><span class=p>),</span>
</span><span id=__span-43-45><a id=__codelineno-43-45 name=__codelineno-43-45 href=#__codelineno-43-45></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;np.full(wrapper.shape_2d[1], -1)&quot;</span><span class=p>)</span>  <span class=c1># (7)!</span>
</span><span id=__span-43-46><a id=__codelineno-43-46 name=__codelineno-43-46 href=#__codelineno-43-46></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-43-47><a id=__codelineno-43-47 name=__codelineno-43-47 href=#__codelineno-43-47></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-43-48><a id=__codelineno-43-48 name=__codelineno-43-48 href=#__codelineno-43-48></a><span class=gp>... </span>        <span class=n>fast_sma</span><span class=o>=</span><span class=n>fast_sma</span><span class=p>,</span>
</span><span id=__span-43-49><a id=__codelineno-43-49 name=__codelineno-43-49 href=#__codelineno-43-49></a><span class=gp>... </span>        <span class=n>slow_sma</span><span class=o>=</span><span class=n>slow_sma</span><span class=p>,</span>
</span><span id=__span-43-50><a id=__codelineno-43-50 name=__codelineno-43-50 href=#__codelineno-43-50></a><span class=gp>... </span>        <span class=n>wait</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=mi>30</span><span class=p>])</span>
</span><span id=__span-43-51><a id=__codelineno-43-51 name=__codelineno-43-51 href=#__codelineno-43-51></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-43-52><a id=__codelineno-43-52 name=__codelineno-43-52 href=#__codelineno-43-52></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-43-53><a id=__codelineno-43-53 name=__codelineno-43-53 href=#__codelineno-43-53></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>count</span><span class=p>()</span>
</span><span id=__span-43-54><a id=__codelineno-43-54 name=__codelineno-43-54 href=#__codelineno-43-54></a><span class=go>wait  fast_sma_timeperiod  slow_sma_timeperiod  symbol </span>
</span><span id=__span-43-55><a id=__codelineno-43-55 name=__codelineno-43-55 href=#__codelineno-43-55></a><span class=go>0     20                   50                   BTCUSDT    40</span>
</span><span id=__span-43-56><a id=__codelineno-43-56 name=__codelineno-43-56 href=#__codelineno-43-56></a><span class=go>                                                ETHUSDT    32</span>
</span><span id=__span-43-57><a id=__codelineno-43-57 name=__codelineno-43-57 href=#__codelineno-43-57></a><span class=go>1     20                   50                   BTCUSDT    38</span>
</span><span id=__span-43-58><a id=__codelineno-43-58 name=__codelineno-43-58 href=#__codelineno-43-58></a><span class=go>                                                ETHUSDT    32</span>
</span><span id=__span-43-59><a id=__codelineno-43-59 name=__codelineno-43-59 href=#__codelineno-43-59></a><span class=go>7     20                   50                   BTCUSDT    36</span>
</span><span id=__span-43-60><a id=__codelineno-43-60 name=__codelineno-43-60 href=#__codelineno-43-60></a><span class=go>                                                ETHUSDT    30</span>
</span><span id=__span-43-61><a id=__codelineno-43-61 name=__codelineno-43-61 href=#__codelineno-43-61></a><span class=go>30    20                   50                   BTCUSDT    14</span>
</span><span id=__span-43-62><a id=__codelineno-43-62 name=__codelineno-43-62 href=#__codelineno-43-62></a><span class=go>                                                ETHUSDT    16</span>
</span><span id=__span-43-63><a id=__codelineno-43-63 name=__codelineno-43-63 href=#__codelineno-43-63></a><span class=go>Name: count, dtype: int64</span>
</span></code></pre></div> <ol> <li>The temporary array is taken as a regular argument.</li> <li>Check whether there is a crossover index stored for this column.</li> <li>If true, check the type of the crossover and whether it can still be confirmed. If it cannot be confirmed at this bar, remove the index.</li> <li>Use generic iterative functions (those starting with <code>vbt.nb.iter_</code>; see <a href=https://vectorbt.pro/pvt_41531c19/api/generic/nb/iter_>generic.iter_</a>) when you need to operate on a custom row or column, and portfolio iterative functions (those starting with <code>vbt.pf_nb.iter_</code>; see <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/iter_>portfolio.iter_</a>) to operate on the current row or column from the context.</li> <li>If there is still an index in the temporary array, the crossover has been confirmed so far, so check if the confirmation period is over, and if so, return the signal.</li> <li>If there is no crossover index, check for a crossover at this bar. If true, store it in the temporary array and continue. If the confirmation period is zero, return the signal immediately.</li> <li>Create the temporary array <code>temp_coi</code> using an evaluation template that runs a code expression after all arrays have been broadcast and the final shape is established. Use <code>wrapper</code> to access the shape information.</li> </ol> <p>This code is not even complicated: you would need about the same number of lines to implement this logic in traditional backtesting software. The main difference is that VBT relies on functional programming, while other frameworks are object-oriented, where functions like <code>crossed_above_nb</code> are methods of the backtesting instance (<code>self.crossed_above()</code>) and variables like <code>temp_coi</code> are instance attributes (<code>self.temp_coi</code>).</p> <h3 id=conflicts>Conflicts<a class=headerlink href=#conflicts title="Permanent link">&para;</a></h3> <p>When signals are generated automatically, it is common for multiple signals of the same type to occur one after another, or for multiple signals of different types to appear at the same bar. The first case is handled by the <abbr title="From-signals simulation method">FS</abbr> method, which considers only the first signal and ignores the rest (unless <a href=#accumulation>accumulation</a> is enabled), as shown in this example where we issue a long entry signal multiple times:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-44-1><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=n>sub_data</span><span class=p>,</span> <span class=n>entries</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-44-2><a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-44-3><a id=__codelineno-44-3 name=__codelineno-44-3 href=#__codelineno-44-3></a><span class=go>symbol                     BTCUSDT   ETHUSDT</span>
</span><span id=__span-44-4><a id=__codelineno-44-4 name=__codelineno-44-4 href=#__codelineno-44-4></a><span class=go>Open time                                   </span>
</span><span id=__span-44-5><a id=__codelineno-44-5 name=__codelineno-44-5 href=#__codelineno-44-5></a><span class=go>2021-02-18 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-44-6><a id=__codelineno-44-6 name=__codelineno-44-6 href=#__codelineno-44-6></a><span class=go>2021-02-19 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-44-7><a id=__codelineno-44-7 name=__codelineno-44-7 href=#__codelineno-44-7></a><span class=go>2021-02-20 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-44-8><a id=__codelineno-44-8 name=__codelineno-44-8 href=#__codelineno-44-8></a><span class=go>2021-02-21 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-44-9><a id=__codelineno-44-9 name=__codelineno-44-9 href=#__codelineno-44-9></a><span class=go>2021-02-22 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-44-10><a id=__codelineno-44-10 name=__codelineno-44-10 href=#__codelineno-44-10></a><span class=go>2021-02-23 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-44-11><a id=__codelineno-44-11 name=__codelineno-44-11 href=#__codelineno-44-11></a><span class=go>2021-02-24 00:00:00+00:00  0.00000  0.000000</span>
</span></code></pre></div> <ol> <li>When signals are supplied as a single value, that value is broadcast across the entire data shape, so it appears in every row and column.</li> </ol> <p>But what happens if we start issuing a long exit signal at the same time?</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-45-1><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span><span class=n>sub_data</span><span class=p>,</span> <span class=n>entries</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>exits</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-45-2><a id=__codelineno-45-2 name=__codelineno-45-2 href=#__codelineno-45-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-45-3><a id=__codelineno-45-3 name=__codelineno-45-3 href=#__codelineno-45-3></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-45-4><a id=__codelineno-45-4 name=__codelineno-45-4 href=#__codelineno-45-4></a><span class=go>Open time                                  </span>
</span><span id=__span-45-5><a id=__codelineno-45-5 name=__codelineno-45-5 href=#__codelineno-45-5></a><span class=go>2021-02-18 00:00:00+00:00      0.0      0.0</span>
</span><span id=__span-45-6><a id=__codelineno-45-6 name=__codelineno-45-6 href=#__codelineno-45-6></a><span class=go>2021-02-19 00:00:00+00:00      0.0      0.0</span>
</span><span id=__span-45-7><a id=__codelineno-45-7 name=__codelineno-45-7 href=#__codelineno-45-7></a><span class=go>2021-02-20 00:00:00+00:00      0.0      0.0</span>
</span><span id=__span-45-8><a id=__codelineno-45-8 name=__codelineno-45-8 href=#__codelineno-45-8></a><span class=go>2021-02-21 00:00:00+00:00      0.0      0.0</span>
</span><span id=__span-45-9><a id=__codelineno-45-9 name=__codelineno-45-9 href=#__codelineno-45-9></a><span class=go>2021-02-22 00:00:00+00:00      0.0      0.0</span>
</span><span id=__span-45-10><a id=__codelineno-45-10 name=__codelineno-45-10 href=#__codelineno-45-10></a><span class=go>2021-02-23 00:00:00+00:00      0.0      0.0</span>
</span><span id=__span-45-11><a id=__codelineno-45-11 name=__codelineno-45-11 href=#__codelineno-45-11></a><span class=go>2021-02-24 00:00:00+00:00      0.0      0.0</span>
</span></code></pre></div> <p>We can see that the simulator simply ignored conflicting signals. However, there are times when you may want to give preference to one signal type over another. In the previous example, we encountered a "long signal conflict," which you can resolve using the <code>upon_long_conflict</code> argument of type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.ConflictMode>ConflictMode</a>. For example, if long entries are more important to you than long exits:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-46-1><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-46-2><a id=__codelineno-46-2 name=__codelineno-46-2 href=#__codelineno-46-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span> 
</span><span id=__span-46-3><a id=__codelineno-46-3 name=__codelineno-46-3 href=#__codelineno-46-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> 
</span><span id=__span-46-4><a id=__codelineno-46-4 name=__codelineno-46-4 href=#__codelineno-46-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-46-5><a id=__codelineno-46-5 name=__codelineno-46-5 href=#__codelineno-46-5></a><span class=gp>... </span>    <span class=n>upon_long_conflict</span><span class=o>=</span><span class=s2>&quot;entry&quot;</span>
</span><span id=__span-46-6><a id=__codelineno-46-6 name=__codelineno-46-6 href=#__codelineno-46-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-46-7><a id=__codelineno-46-7 name=__codelineno-46-7 href=#__codelineno-46-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-46-8><a id=__codelineno-46-8 name=__codelineno-46-8 href=#__codelineno-46-8></a><span class=go>symbol                     BTCUSDT   ETHUSDT</span>
</span><span id=__span-46-9><a id=__codelineno-46-9 name=__codelineno-46-9 href=#__codelineno-46-9></a><span class=go>Open time                                   </span>
</span><span id=__span-46-10><a id=__codelineno-46-10 name=__codelineno-46-10 href=#__codelineno-46-10></a><span class=go>2021-02-18 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-46-11><a id=__codelineno-46-11 name=__codelineno-46-11 href=#__codelineno-46-11></a><span class=go>2021-02-19 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-46-12><a id=__codelineno-46-12 name=__codelineno-46-12 href=#__codelineno-46-12></a><span class=go>2021-02-20 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-46-13><a id=__codelineno-46-13 name=__codelineno-46-13 href=#__codelineno-46-13></a><span class=go>2021-02-21 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-46-14><a id=__codelineno-46-14 name=__codelineno-46-14 href=#__codelineno-46-14></a><span class=go>2021-02-22 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-46-15><a id=__codelineno-46-15 name=__codelineno-46-15 href=#__codelineno-46-15></a><span class=go>2021-02-23 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-46-16><a id=__codelineno-46-16 name=__codelineno-46-16 href=#__codelineno-46-16></a><span class=go>2021-02-24 00:00:00+00:00  0.00000  0.000000</span>
</span></code></pre></div> <p>What if we want to allow both directions, so that an exit signal can become a short entry signal? In this case, we have a "signal direction conflict," which is controlled by the argument <code>upon_dir_conflict</code> of type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.DirectionConflictMode>DirectionConflictMode</a>. Let's choose to prefer short signals over long signals in any direction:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-47-1><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-47-2><a id=__codelineno-47-2 name=__codelineno-47-2 href=#__codelineno-47-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span> 
</span><span id=__span-47-3><a id=__codelineno-47-3 name=__codelineno-47-3 href=#__codelineno-47-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> 
</span><span id=__span-47-4><a id=__codelineno-47-4 name=__codelineno-47-4 href=#__codelineno-47-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-47-5><a id=__codelineno-47-5 name=__codelineno-47-5 href=#__codelineno-47-5></a><span class=gp>... </span>    <span class=n>direction</span><span class=o>=</span><span class=s2>&quot;both&quot;</span><span class=p>,</span>
</span><span id=__span-47-6><a id=__codelineno-47-6 name=__codelineno-47-6 href=#__codelineno-47-6></a><span class=gp>... </span>    <span class=n>upon_dir_conflict</span><span class=o>=</span><span class=s2>&quot;short&quot;</span>
</span><span id=__span-47-7><a id=__codelineno-47-7 name=__codelineno-47-7 href=#__codelineno-47-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-47-8><a id=__codelineno-47-8 name=__codelineno-47-8 href=#__codelineno-47-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-47-9><a id=__codelineno-47-9 name=__codelineno-47-9 href=#__codelineno-47-9></a><span class=go>symbol                     BTCUSDT   ETHUSDT</span>
</span><span id=__span-47-10><a id=__codelineno-47-10 name=__codelineno-47-10 href=#__codelineno-47-10></a><span class=go>Open time                                   </span>
</span><span id=__span-47-11><a id=__codelineno-47-11 name=__codelineno-47-11 href=#__codelineno-47-11></a><span class=go>2021-02-18 00:00:00+00:00 -0.00194 -0.051557</span>
</span><span id=__span-47-12><a id=__codelineno-47-12 name=__codelineno-47-12 href=#__codelineno-47-12></a><span class=go>2021-02-19 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-47-13><a id=__codelineno-47-13 name=__codelineno-47-13 href=#__codelineno-47-13></a><span class=go>2021-02-20 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-47-14><a id=__codelineno-47-14 name=__codelineno-47-14 href=#__codelineno-47-14></a><span class=go>2021-02-21 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-47-15><a id=__codelineno-47-15 name=__codelineno-47-15 href=#__codelineno-47-15></a><span class=go>2021-02-22 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-47-16><a id=__codelineno-47-16 name=__codelineno-47-16 href=#__codelineno-47-16></a><span class=go>2021-02-23 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-47-17><a id=__codelineno-47-17 name=__codelineno-47-17 href=#__codelineno-47-17></a><span class=go>2021-02-24 00:00:00+00:00  0.00000  0.000000</span>
</span></code></pre></div> <p>We can see that both orders became sell orders. Now, let's combine both cases and apply this knowledge to a scenario where all four signals are provided! We will open a long position at the first bar, and on each subsequent bar, only the signal opposite to the current position will win and reverse the position:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-48-1><a id=__codelineno-48-1 name=__codelineno-48-1 href=#__codelineno-48-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-48-2><a id=__codelineno-48-2 name=__codelineno-48-2 href=#__codelineno-48-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span> 
</span><span id=__span-48-3><a id=__codelineno-48-3 name=__codelineno-48-3 href=#__codelineno-48-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> 
</span><span id=__span-48-4><a id=__codelineno-48-4 name=__codelineno-48-4 href=#__codelineno-48-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>index_dict</span><span class=p>({</span><span class=mi>0</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span> <span class=s2>&quot;_def&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>}),</span>
</span><span id=__span-48-5><a id=__codelineno-48-5 name=__codelineno-48-5 href=#__codelineno-48-5></a><span class=gp>... </span>    <span class=n>short_entries</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>index_dict</span><span class=p>({</span><span class=mi>0</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span> <span class=s2>&quot;_def&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>}),</span>
</span><span id=__span-48-6><a id=__codelineno-48-6 name=__codelineno-48-6 href=#__codelineno-48-6></a><span class=gp>... </span>    <span class=n>short_exits</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>index_dict</span><span class=p>({</span><span class=mi>0</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span> <span class=s2>&quot;_def&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>}),</span>
</span><span id=__span-48-7><a id=__codelineno-48-7 name=__codelineno-48-7 href=#__codelineno-48-7></a><span class=gp>... </span>    <span class=n>upon_long_conflict</span><span class=o>=</span><span class=s2>&quot;entry&quot;</span><span class=p>,</span>
</span><span id=__span-48-8><a id=__codelineno-48-8 name=__codelineno-48-8 href=#__codelineno-48-8></a><span class=gp>... </span>    <span class=n>upon_short_conflict</span><span class=o>=</span><span class=s2>&quot;entry&quot;</span><span class=p>,</span>
</span><span id=__span-48-9><a id=__codelineno-48-9 name=__codelineno-48-9 href=#__codelineno-48-9></a><span class=gp>... </span>    <span class=n>upon_dir_conflict</span><span class=o>=</span><span class=s2>&quot;opposite&quot;</span><span class=p>,</span>
</span><span id=__span-48-10><a id=__codelineno-48-10 name=__codelineno-48-10 href=#__codelineno-48-10></a><span class=gp>... </span>    <span class=n>upon_opposite_entry</span><span class=o>=</span><span class=s2>&quot;reverse&quot;</span>
</span><span id=__span-48-11><a id=__codelineno-48-11 name=__codelineno-48-11 href=#__codelineno-48-11></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-48-12><a id=__codelineno-48-12 name=__codelineno-48-12 href=#__codelineno-48-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-48-13><a id=__codelineno-48-13 name=__codelineno-48-13 href=#__codelineno-48-13></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-48-14><a id=__codelineno-48-14 name=__codelineno-48-14 href=#__codelineno-48-14></a><span class=go>Open time                                    </span>
</span><span id=__span-48-15><a id=__codelineno-48-15 name=__codelineno-48-15 href=#__codelineno-48-15></a><span class=go>2021-02-18 00:00:00+00:00  0.001940  0.051557</span>
</span><span id=__span-48-16><a id=__codelineno-48-16 name=__codelineno-48-16 href=#__codelineno-48-16></a><span class=go>2021-02-19 00:00:00+00:00 -0.003880 -0.103114</span>
</span><span id=__span-48-17><a id=__codelineno-48-17 name=__codelineno-48-17 href=#__codelineno-48-17></a><span class=go>2021-02-20 00:00:00+00:00  0.003884  0.105377</span>
</span><span id=__span-48-18><a id=__codelineno-48-18 name=__codelineno-48-18 href=#__codelineno-48-18></a><span class=go>2021-02-21 00:00:00+00:00 -0.003889 -0.107641</span>
</span><span id=__span-48-19><a id=__codelineno-48-19 name=__codelineno-48-19 href=#__codelineno-48-19></a><span class=go>2021-02-22 00:00:00+00:00  0.004127  0.117085</span>
</span><span id=__span-48-20><a id=__codelineno-48-20 name=__codelineno-48-20 href=#__codelineno-48-20></a><span class=go>2021-02-23 00:00:00+00:00 -0.004366 -0.126528</span>
</span><span id=__span-48-21><a id=__codelineno-48-21 name=__codelineno-48-21 href=#__codelineno-48-21></a><span class=go>2021-02-24 00:00:00+00:00  0.004297  0.122982</span>
</span></code></pre></div> <p>Great, we have forced VBT to reverse the position at each bar <img alt=ðŸ¥¶ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f976.svg title=:cold_face:></p> <h2 id=orders>Orders<a class=headerlink href=#orders title="Permanent link">&para;</a></h2> <p>As we have learned, signals are simply another abstraction layer over orders; they control the timing and direction of orders. But how do you specify the parameters of a typical order that a signal should be converted into? Just like <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_orders>Portfolio.from_orders</a>, the class method <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a> accepts a variety of order-related arguments. In fact, it takes all the arguments that can be found as fields in the class <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.Order>Order</a>. If any argument is set to <code>None</code>, the method will use the default value defined in the <a href=https://vectorbt.pro/pvt_41531c19/api/_settings/#vectorbtpro._settings.portfolio>portfolio settings</a>. For example, the default size is <code>np.inf</code>, which means that each signal instructs the simulator to use the entire available capital. Also, each order-related argument is array-like and broadcasts together with the signals. This allows you to set an argument to a single value and have it apply to each signal. Let's make each entry signal order $1 worth of each asset by adjusting the size and size type arguments:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-49-1><a id=__codelineno-49-1 name=__codelineno-49-1 href=#__codelineno-49-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-49-2><a id=__codelineno-49-2 name=__codelineno-49-2 href=#__codelineno-49-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-49-3><a id=__codelineno-49-3 name=__codelineno-49-3 href=#__codelineno-49-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-49-4><a id=__codelineno-49-4 name=__codelineno-49-4 href=#__codelineno-49-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-49-5><a id=__codelineno-49-5 name=__codelineno-49-5 href=#__codelineno-49-5></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span><span id=__span-49-6><a id=__codelineno-49-6 name=__codelineno-49-6 href=#__codelineno-49-6></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;value&quot;</span>
</span><span id=__span-49-7><a id=__codelineno-49-7 name=__codelineno-49-7 href=#__codelineno-49-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-49-8><a id=__codelineno-49-8 name=__codelineno-49-8 href=#__codelineno-49-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-49-9><a id=__codelineno-49-9 name=__codelineno-49-9 href=#__codelineno-49-9></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-49-10><a id=__codelineno-49-10 name=__codelineno-49-10 href=#__codelineno-49-10></a><span class=go>Open time                                    </span>
</span><span id=__span-49-11><a id=__codelineno-49-11 name=__codelineno-49-11 href=#__codelineno-49-11></a><span class=go>2021-02-18 00:00:00+00:00  0.000019  0.000516</span>
</span><span id=__span-49-12><a id=__codelineno-49-12 name=__codelineno-49-12 href=#__codelineno-49-12></a><span class=go>2021-02-19 00:00:00+00:00  0.000019  0.000516</span>
</span><span id=__span-49-13><a id=__codelineno-49-13 name=__codelineno-49-13 href=#__codelineno-49-13></a><span class=go>2021-02-20 00:00:00+00:00  0.000019  0.000516</span>
</span><span id=__span-49-14><a id=__codelineno-49-14 name=__codelineno-49-14 href=#__codelineno-49-14></a><span class=go>2021-02-21 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-49-15><a id=__codelineno-49-15 name=__codelineno-49-15 href=#__codelineno-49-15></a><span class=go>2021-02-22 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-49-16><a id=__codelineno-49-16 name=__codelineno-49-16 href=#__codelineno-49-16></a><span class=go>2021-02-23 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-49-17><a id=__codelineno-49-17 name=__codelineno-49-17 href=#__codelineno-49-17></a><span class=go>2021-02-24 00:00:00+00:00  0.000000  0.000000</span>
</span></code></pre></div> <p>As we can see, the simulator ordered <code>1 / 51552.60 = 0.000019</code> units of <code>BTCUSDT</code> and then closed the position. For more granular control over any order parameter, you can specify this information as an array. For example, let's enter a position with 50% of the available cash, close the position, then open a new position in the opposite direction with 25% of the available cash, and close that position again:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-50-1><a id=__codelineno-50-1 name=__codelineno-50-1 href=#__codelineno-50-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-50-2><a id=__codelineno-50-2 name=__codelineno-50-2 href=#__codelineno-50-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-50-3><a id=__codelineno-50-3 name=__codelineno-50-3 href=#__codelineno-50-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span>      <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span>   <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span>    <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-50-4><a id=__codelineno-50-4 name=__codelineno-50-4 href=#__codelineno-50-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>        <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span>   <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span>    <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-50-5><a id=__codelineno-50-5 name=__codelineno-50-5 href=#__codelineno-50-5></a><span class=gp>... </span>    <span class=n>short_entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span>   <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span>    <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-50-6><a id=__codelineno-50-6 name=__codelineno-50-6 href=#__codelineno-50-6></a><span class=gp>... </span>    <span class=n>short_exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span>   <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span>    <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>]),</span>
</span><span id=__span-50-7><a id=__codelineno-50-7 name=__codelineno-50-7 href=#__codelineno-50-7></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span>         <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=mf>0.5</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mf>0.25</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]),</span>
</span><span id=__span-50-8><a id=__codelineno-50-8 name=__codelineno-50-8 href=#__codelineno-50-8></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;valuepercent&quot;</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-50-9><a id=__codelineno-50-9 name=__codelineno-50-9 href=#__codelineno-50-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-50-10><a id=__codelineno-50-10 name=__codelineno-50-10 href=#__codelineno-50-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_value</span> <span class=o>/</span> <span class=n>pf</span><span class=o>.</span><span class=n>value</span>  <span class=c1># (2)!</span>
</span><span id=__span-50-11><a id=__codelineno-50-11 name=__codelineno-50-11 href=#__codelineno-50-11></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-50-12><a id=__codelineno-50-12 name=__codelineno-50-12 href=#__codelineno-50-12></a><span class=go>Open time                                    </span>
</span><span id=__span-50-13><a id=__codelineno-50-13 name=__codelineno-50-13 href=#__codelineno-50-13></a><span class=go>2021-02-18 00:00:00+00:00  0.500000  0.500000  &lt;&lt; long entry of 50%</span>
</span><span id=__span-50-14><a id=__codelineno-50-14 name=__codelineno-50-14 href=#__codelineno-50-14></a><span class=go>2021-02-19 00:00:00+00:00  0.520256  0.501976</span>
</span><span id=__span-50-15><a id=__codelineno-50-15 name=__codelineno-50-15 href=#__codelineno-50-15></a><span class=go>2021-02-20 00:00:00+00:00  0.519967  0.496546</span>
</span><span id=__span-50-16><a id=__codelineno-50-16 name=__codelineno-50-16 href=#__codelineno-50-16></a><span class=go>2021-02-21 00:00:00+00:00  0.000000  0.000000  &lt;&lt; long exit</span>
</span><span id=__span-50-17><a id=__codelineno-50-17 name=__codelineno-50-17 href=#__codelineno-50-17></a><span class=go>2021-02-22 00:00:00+00:00 -0.250000 -0.250000  &lt;&lt; short entry of 25%</span>
</span><span id=__span-50-18><a id=__codelineno-50-18 name=__codelineno-50-18 href=#__codelineno-50-18></a><span class=go>2021-02-23 00:00:00+00:00 -0.220680 -0.215853</span>
</span><span id=__span-50-19><a id=__codelineno-50-19 name=__codelineno-50-19 href=#__codelineno-50-19></a><span class=go>2021-02-24 00:00:00+00:00  0.000000  0.000000  &lt;&lt; short exit</span>
</span></code></pre></div> <ol> <li>Treat the size as a percentage of the total portfolio value.</li> <li>Get the allocation at each bar, that is, the ratio of the asset value to the total portfolio value.</li> </ol> <p>Thanks to VBT's powerful broadcasting mechanism, you can backtest arbitrary configurations with just a couple of lines of code. Below, we are testing three different mutual configurations of the size and size type arguments:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-51-1><a id=__codelineno-51-1 name=__codelineno-51-1 href=#__codelineno-51-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-51-2><a id=__codelineno-51-2 name=__codelineno-51-2 href=#__codelineno-51-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-51-3><a id=__codelineno-51-3 name=__codelineno-51-3 href=#__codelineno-51-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-51-4><a id=__codelineno-51-4 name=__codelineno-51-4 href=#__codelineno-51-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-51-5><a id=__codelineno-51-5 name=__codelineno-51-5 href=#__codelineno-51-5></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span>     <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span>   <span class=mi>1</span><span class=p>,</span>       <span class=mf>0.5</span><span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=mi>0</span><span class=p>),</span>  <span class=c1># (1)!</span>
</span><span id=__span-51-6><a id=__codelineno-51-6 name=__codelineno-51-6 href=#__codelineno-51-6></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=s2>&quot;amount&quot;</span><span class=p>,</span> <span class=s2>&quot;value&quot;</span><span class=p>,</span> <span class=s2>&quot;valuepercent&quot;</span><span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-51-7><a id=__codelineno-51-7 name=__codelineno-51-7 href=#__codelineno-51-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-51-8><a id=__codelineno-51-8 name=__codelineno-51-8 href=#__codelineno-51-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>total_return</span>
</span><span id=__span-51-9><a id=__codelineno-51-9 name=__codelineno-51-9 href=#__codelineno-51-9></a><span class=go>size  size_type     symbol </span>
</span><span id=__span-51-10><a id=__codelineno-51-10 name=__codelineno-51-10 href=#__codelineno-51-10></a><span class=go>inf   amount        BTCUSDT    0.113592</span>
</span><span id=__span-51-11><a id=__codelineno-51-11 name=__codelineno-51-11 href=#__codelineno-51-11></a><span class=go>                    ETHUSDT   -0.003135</span>
</span><span id=__span-51-12><a id=__codelineno-51-12 name=__codelineno-51-12 href=#__codelineno-51-12></a><span class=go>1.0   value         BTCUSDT    0.001136</span>
</span><span id=__span-51-13><a id=__codelineno-51-13 name=__codelineno-51-13 href=#__codelineno-51-13></a><span class=go>                    ETHUSDT   -0.000031</span>
</span><span id=__span-51-14><a id=__codelineno-51-14 name=__codelineno-51-14 href=#__codelineno-51-14></a><span class=go>0.5   valuepercent  BTCUSDT    0.056796</span>
</span><span id=__span-51-15><a id=__codelineno-51-15 name=__codelineno-51-15 href=#__codelineno-51-15></a><span class=go>                    ETHUSDT   -0.001567</span>
</span><span id=__span-51-16><a id=__codelineno-51-16 name=__codelineno-51-16 href=#__codelineno-51-16></a><span class=go>Name: total_return, dtype: float64</span>
</span></code></pre></div> <ol> <li>Without sharing the same <code>level</code>, both parameters would build a Cartesian product.</li> </ol> <p>Each configuration is applied to the entire set of signal arrays.</p> <h3 id=accumulation>Accumulation<a class=headerlink href=#accumulation title="Permanent link">&para;</a></h3> <p>If you want to sell $1 worth of each asset instead of closing the entire position whenever an exit signal is encountered, you need to enable accumulation:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-52-1><a id=__codelineno-52-1 name=__codelineno-52-1 href=#__codelineno-52-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-52-2><a id=__codelineno-52-2 name=__codelineno-52-2 href=#__codelineno-52-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-52-3><a id=__codelineno-52-3 name=__codelineno-52-3 href=#__codelineno-52-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-52-4><a id=__codelineno-52-4 name=__codelineno-52-4 href=#__codelineno-52-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-52-5><a id=__codelineno-52-5 name=__codelineno-52-5 href=#__codelineno-52-5></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span><span id=__span-52-6><a id=__codelineno-52-6 name=__codelineno-52-6 href=#__codelineno-52-6></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;value&quot;</span><span class=p>,</span>
</span><span id=__span-52-7><a id=__codelineno-52-7 name=__codelineno-52-7 href=#__codelineno-52-7></a><span class=gp>... </span>    <span class=n>accumulate</span><span class=o>=</span><span class=kc>True</span>  <span class=c1># (1)!</span>
</span><span id=__span-52-8><a id=__codelineno-52-8 name=__codelineno-52-8 href=#__codelineno-52-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-52-9><a id=__codelineno-52-9 name=__codelineno-52-9 href=#__codelineno-52-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-52-10><a id=__codelineno-52-10 name=__codelineno-52-10 href=#__codelineno-52-10></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-52-11><a id=__codelineno-52-11 name=__codelineno-52-11 href=#__codelineno-52-11></a><span class=go>Open time                                    </span>
</span><span id=__span-52-12><a id=__codelineno-52-12 name=__codelineno-52-12 href=#__codelineno-52-12></a><span class=go>2021-02-18 00:00:00+00:00  0.000019  0.000516</span>
</span><span id=__span-52-13><a id=__codelineno-52-13 name=__codelineno-52-13 href=#__codelineno-52-13></a><span class=go>2021-02-19 00:00:00+00:00  0.000019  0.000516</span>
</span><span id=__span-52-14><a id=__codelineno-52-14 name=__codelineno-52-14 href=#__codelineno-52-14></a><span class=go>2021-02-20 00:00:00+00:00  0.000019  0.000516</span>
</span><span id=__span-52-15><a id=__codelineno-52-15 name=__codelineno-52-15 href=#__codelineno-52-15></a><span class=go>2021-02-21 00:00:00+00:00  0.000002  0.000000</span>
</span><span id=__span-52-16><a id=__codelineno-52-16 name=__codelineno-52-16 href=#__codelineno-52-16></a><span class=go>2021-02-22 00:00:00+00:00  0.000002  0.000000</span>
</span><span id=__span-52-17><a id=__codelineno-52-17 name=__codelineno-52-17 href=#__codelineno-52-17></a><span class=go>2021-02-23 00:00:00+00:00  0.000002  0.000000</span>
</span><span id=__span-52-18><a id=__codelineno-52-18 name=__codelineno-52-18 href=#__codelineno-52-18></a><span class=go>2021-02-24 00:00:00+00:00  0.000002  0.000000</span>
</span></code></pre></div> <ol> <li>See <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.AccumulationMode>AccumulationMode</a>.</li> </ol> <p>There is a leftover in the <code>BTCUSDT</code> column since we made a profit, while the position has been closed entirely in the <code>ETHUSDT</code> column since we made a loss ($1 is worth less than at the beginning of the simulation). There is also another implication: whenever accumulation is enabled, the method starts working similarly to <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_orders>Portfolio.from_orders</a>. For instance, it treats each signal as an order, regardless of whether we are already in the market. This is best illustrated by the following example, where we issue a long entry signal at every single bar, both without and with accumulation:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-53-1><a id=__codelineno-53-1 name=__codelineno-53-1 href=#__codelineno-53-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-53-2><a id=__codelineno-53-2 name=__codelineno-53-2 href=#__codelineno-53-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-53-3><a id=__codelineno-53-3 name=__codelineno-53-3 href=#__codelineno-53-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-53-4><a id=__codelineno-53-4 name=__codelineno-53-4 href=#__codelineno-53-4></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span><span id=__span-53-5><a id=__codelineno-53-5 name=__codelineno-53-5 href=#__codelineno-53-5></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;value&quot;</span><span class=p>,</span>
</span><span id=__span-53-6><a id=__codelineno-53-6 name=__codelineno-53-6 href=#__codelineno-53-6></a><span class=gp>... </span>    <span class=n>accumulate</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>])</span>
</span><span id=__span-53-7><a id=__codelineno-53-7 name=__codelineno-53-7 href=#__codelineno-53-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-53-8><a id=__codelineno-53-8 name=__codelineno-53-8 href=#__codelineno-53-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>  <span class=c1># (1)!</span>
</span><span id=__span-53-9><a id=__codelineno-53-9 name=__codelineno-53-9 href=#__codelineno-53-9></a><span class=go>accumulate                    False                True          </span>
</span><span id=__span-53-10><a id=__codelineno-53-10 name=__codelineno-53-10 href=#__codelineno-53-10></a><span class=go>symbol                      BTCUSDT   ETHUSDT   BTCUSDT   ETHUSDT</span>
</span><span id=__span-53-11><a id=__codelineno-53-11 name=__codelineno-53-11 href=#__codelineno-53-11></a><span class=go>Open time                                                        </span>
</span><span id=__span-53-12><a id=__codelineno-53-12 name=__codelineno-53-12 href=#__codelineno-53-12></a><span class=go>2021-02-18 00:00:00+00:00  0.000019  0.000516  0.000019  0.000516</span>
</span><span id=__span-53-13><a id=__codelineno-53-13 name=__codelineno-53-13 href=#__codelineno-53-13></a><span class=go>2021-02-19 00:00:00+00:00  0.000000  0.000000  0.000018  0.000512</span>
</span><span id=__span-53-14><a id=__codelineno-53-14 name=__codelineno-53-14 href=#__codelineno-53-14></a><span class=go>2021-02-20 00:00:00+00:00  0.000000  0.000000  0.000018  0.000523</span>
</span><span id=__span-53-15><a id=__codelineno-53-15 name=__codelineno-53-15 href=#__codelineno-53-15></a><span class=go>2021-02-21 00:00:00+00:00  0.000000  0.000000  0.000017  0.000517</span>
</span><span id=__span-53-16><a id=__codelineno-53-16 name=__codelineno-53-16 href=#__codelineno-53-16></a><span class=go>2021-02-22 00:00:00+00:00  0.000000  0.000000  0.000018  0.000563</span>
</span><span id=__span-53-17><a id=__codelineno-53-17 name=__codelineno-53-17 href=#__codelineno-53-17></a><span class=go>2021-02-23 00:00:00+00:00  0.000000  0.000000  0.000020  0.000634</span>
</span><span id=__span-53-18><a id=__codelineno-53-18 name=__codelineno-53-18 href=#__codelineno-53-18></a><span class=go>2021-02-24 00:00:00+00:00  0.000000  0.000000  0.000020  0.000616</span>
</span></code></pre></div> <ol> <li>Calculate and print the asset flow at each bar, that is, the absolute number of units bought (positive) or sold (negative).</li> </ol> <p>As you can see, without accumulation, only the first signal is executed and all following signals are ignored since we are already in a position. With accumulation enabled, each signal is executed regardless of the current position. This allows for pyramiding and other trading strategies that do not require binary position restrictions.</p> <h3 id=size-types>Size types<a class=headerlink href=#size-types title="Permanent link">&para;</a></h3> <p>A variety of size types are supported. To see the full list, refer to the enumerated type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.SizeType>SizeType</a>. Each size type can be specified either as a (case-insensitive) string representing the field name or as an integer representing the value. For example, both <code>size_type="value"</code> and <code>size_type=SizeType.Value</code> behave identically. Most size types will be internally converted to the size type <code>Amount</code>, which represents the absolute number of units to order. This conversion is mainly done using the valuation price <code>val_price</code>, which defaults to the order price and is intended to represent the latest price at the time of decision-making.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>When working directly with Numba-compiled functions, only the integer format is supported.</p> </div> <p>However, not all size types are supported in <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a>. Any target size type that defines a target, such as <code>TargetAmount</code>, <code>TargetValue</code>, and <code>TargetPercent(100)</code>, cannot be safely used since the final order size might contradict the signal. For example, if you are in a position of 10 units and issue an entry signal with a size of 3 units and a size type of <code>TargetAmount</code>, the actual order will be a sell order of size 7, which is opposite to the direction of the signal issued. Additionally, the size type <code>Percent</code> cannot be used in certain situations when both directions are allowed, such as when reversing a position, because such a percentage cannot simply be "flipped".</p> <h3 id=size-granularity>Size granularity<a class=headerlink href=#size-granularity title="Permanent link">&para;</a></h3> <p>Size is always represented as a (usually 64-bit) floating-point number, and the entire simulation logic of VBT is also built upon this number format. However, as you might know, floating point numbers are not ideal for monetary calculations because their arithmetic often leads to a loss of precision. Since Numba does not allow the use of fixed-point numbers, VBT is forced to use floating-point numbers and applies several techniques to compare them reliably, such as using <a href=https://numpy.org/doc/stable/reference/generated/numpy.isclose.html>numpy.isclose</a> and <a href=https://numpy.org/doc/stable/reference/generated/numpy.round_.html>numpy.round_</a>.</p> <p>But what if the size needs to be an integer, such as when trading stocks? For this, you can use the <code>size_granularity</code> argument, which will round the final absolute size to a certain number of decimal places. As a rule of thumb: use <code>1</code> for whole shares, <code>0.001</code> for fractional shares, or a custom value for crypto. For example, Binance provides the step size for each trading pair, which can be directly used as <code>size_granularity</code>.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-54-1><a id=__codelineno-54-1 name=__codelineno-54-1 href=#__codelineno-54-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-54-2><a id=__codelineno-54-2 name=__codelineno-54-2 href=#__codelineno-54-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-54-3><a id=__codelineno-54-3 name=__codelineno-54-3 href=#__codelineno-54-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-54-4><a id=__codelineno-54-4 name=__codelineno-54-4 href=#__codelineno-54-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-54-5><a id=__codelineno-54-5 name=__codelineno-54-5 href=#__codelineno-54-5></a><span class=gp>... </span>    <span class=n>size_granularity</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.001</span><span class=p>]),</span>
</span><span id=__span-54-6><a id=__codelineno-54-6 name=__codelineno-54-6 href=#__codelineno-54-6></a><span class=gp>... </span>    <span class=n>init_cash</span><span class=o>=</span><span class=mi>1000_000</span>
</span><span id=__span-54-7><a id=__codelineno-54-7 name=__codelineno-54-7 href=#__codelineno-54-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-54-8><a id=__codelineno-54-8 name=__codelineno-54-8 href=#__codelineno-54-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-54-9><a id=__codelineno-54-9 name=__codelineno-54-9 href=#__codelineno-54-9></a><span class=go>size_granularity            1.000           0.001         </span>
</span><span id=__span-54-10><a id=__codelineno-54-10 name=__codelineno-54-10 href=#__codelineno-54-10></a><span class=go>symbol                    BTCUSDT ETHUSDT BTCUSDT  ETHUSDT</span>
</span><span id=__span-54-11><a id=__codelineno-54-11 name=__codelineno-54-11 href=#__codelineno-54-11></a><span class=go>Open time                                                 </span>
</span><span id=__span-54-12><a id=__codelineno-54-12 name=__codelineno-54-12 href=#__codelineno-54-12></a><span class=go>2021-02-18 00:00:00+00:00    19.0   515.0  19.397  515.567</span>
</span><span id=__span-54-13><a id=__codelineno-54-13 name=__codelineno-54-13 href=#__codelineno-54-13></a><span class=go>2021-02-19 00:00:00+00:00     0.0     0.0   0.000    0.000</span>
</span><span id=__span-54-14><a id=__codelineno-54-14 name=__codelineno-54-14 href=#__codelineno-54-14></a><span class=go>2021-02-20 00:00:00+00:00     0.0     0.0   0.000    0.000</span>
</span><span id=__span-54-15><a id=__codelineno-54-15 name=__codelineno-54-15 href=#__codelineno-54-15></a><span class=go>2021-02-21 00:00:00+00:00   -19.0  -515.0 -19.397 -515.566</span>
</span><span id=__span-54-16><a id=__codelineno-54-16 name=__codelineno-54-16 href=#__codelineno-54-16></a><span class=go>2021-02-22 00:00:00+00:00     0.0     0.0   0.000    0.000</span>
</span><span id=__span-54-17><a id=__codelineno-54-17 name=__codelineno-54-17 href=#__codelineno-54-17></a><span class=go>2021-02-23 00:00:00+00:00     0.0     0.0   0.000    0.000</span>
</span><span id=__span-54-18><a id=__codelineno-54-18 name=__codelineno-54-18 href=#__codelineno-54-18></a><span class=go>2021-02-24 00:00:00+00:00     0.0     0.0   0.000    0.000</span>
</span></code></pre></div> <div class="admonition info"> <p class=admonition-title>Info</p> <p>Even though the traded size appears as an integer, it is still represented as a float.</p> </div> <h3 id=price>Price<a class=headerlink href=#price title="Permanent link">&para;</a></h3> <p>By default, VBT executes an order immediately using the current closing price. This behavior can be changed by adjusting the <code>price</code> argument, which can accept either a price array or a price option of type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.PriceType>PriceType</a>. If you look into the portfolio settings, you will notice that <code>price</code> is set to the string <code>"close"</code>, which is translated at runtime into the option <code>PriceType.Close</code>. This option is simply an alias for the value <code>np.inf</code> (positive infinity). What does infinity do here? Since an order price must fall within the price bounds of a bar, negative and positive infinity represent the opening and closing prices, respectively (see <a href=https://vectorbt.pro/pvt_41531c19/documentation/portfolio/#price-resolution>Price resolution</a>); both can be used within arrays. The other two options, <code>NextOpen</code> and <code>NextClose</code>, are standalone options and cannot be used within arrays because they require other arguments.</p> <div class="admonition important"> <p class=admonition-title>Important</p> <p>Which option to choose depends on the price you used to generate your signals. Most of the time, signals are both generated and executed using the same closing price. To account for potential time gaps between signal generation and execution, you can use the next open or close, or shift your signals manually. If you generated signals using the opening price or another price that comes before it, you can also use the option <code>"open"</code> along with a bit of slippage.</p> </div> <p>Let's execute entries using the open and exits using the close. Remember that each order-related argument is defined for all signal types: long entries and exits, and short entries and exits. This means there is no argument that defines the price specifically for exits; otherwise, the number of arguments would become too large. To make any argument value apply only to a subset of signal types, you should set it using the signal types as a mask:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-55-1><a id=__codelineno-55-1 name=__codelineno-55-1 href=#__codelineno-55-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>price</span> <span class=o>=</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>()</span>  <span class=c1># (1)!</span>
</span><span id=__span-55-2><a id=__codelineno-55-2 name=__codelineno-55-2 href=#__codelineno-55-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entries</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>broadcast_to</span><span class=p>(</span><span class=n>price</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-55-3><a id=__codelineno-55-3 name=__codelineno-55-3 href=#__codelineno-55-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span> <span class=o>=</span>   <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>broadcast_to</span><span class=p>(</span><span class=n>price</span><span class=p>)</span>
</span><span id=__span-55-4><a id=__codelineno-55-4 name=__codelineno-55-4 href=#__codelineno-55-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>price</span><span class=p>[</span><span class=n>entries</span><span class=p>]</span> <span class=o>=</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>open</span>  <span class=c1># (3)!</span>
</span><span id=__span-55-5><a id=__codelineno-55-5 name=__codelineno-55-5 href=#__codelineno-55-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>price</span><span class=p>[</span><span class=n>exits</span><span class=p>]</span> <span class=o>=</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>close</span>
</span><span id=__span-55-6><a id=__codelineno-55-6 name=__codelineno-55-6 href=#__codelineno-55-6></a>
</span><span id=__span-55-7><a id=__codelineno-55-7 name=__codelineno-55-7 href=#__codelineno-55-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-55-8><a id=__codelineno-55-8 name=__codelineno-55-8 href=#__codelineno-55-8></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-55-9><a id=__codelineno-55-9 name=__codelineno-55-9 href=#__codelineno-55-9></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>entries</span><span class=p>,</span>
</span><span id=__span-55-10><a id=__codelineno-55-10 name=__codelineno-55-10 href=#__codelineno-55-10></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span><span class=n>exits</span><span class=p>,</span>
</span><span id=__span-55-11><a id=__codelineno-55-11 name=__codelineno-55-11 href=#__codelineno-55-11></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>price</span>
</span><span id=__span-55-12><a id=__codelineno-55-12 name=__codelineno-55-12 href=#__codelineno-55-12></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-55-13><a id=__codelineno-55-13 name=__codelineno-55-13 href=#__codelineno-55-13></a>
</span><span id=__span-55-14><a id=__codelineno-55-14 name=__codelineno-55-14 href=#__codelineno-55-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span> <span class=o>==</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>open</span>  <span class=c1># (4)!</span>
</span><span id=__span-55-15><a id=__codelineno-55-15 name=__codelineno-55-15 href=#__codelineno-55-15></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-55-16><a id=__codelineno-55-16 name=__codelineno-55-16 href=#__codelineno-55-16></a><span class=go>Open time                                  </span>
</span><span id=__span-55-17><a id=__codelineno-55-17 name=__codelineno-55-17 href=#__codelineno-55-17></a><span class=go>2021-02-18 00:00:00+00:00     True     True</span>
</span><span id=__span-55-18><a id=__codelineno-55-18 name=__codelineno-55-18 href=#__codelineno-55-18></a><span class=go>2021-02-19 00:00:00+00:00    False    False</span>
</span><span id=__span-55-19><a id=__codelineno-55-19 name=__codelineno-55-19 href=#__codelineno-55-19></a><span class=go>2021-02-20 00:00:00+00:00    False    False</span>
</span><span id=__span-55-20><a id=__codelineno-55-20 name=__codelineno-55-20 href=#__codelineno-55-20></a><span class=go>2021-02-21 00:00:00+00:00    False    False</span>
</span><span id=__span-55-21><a id=__codelineno-55-21 name=__codelineno-55-21 href=#__codelineno-55-21></a><span class=go>2021-02-22 00:00:00+00:00    False    False</span>
</span><span id=__span-55-22><a id=__codelineno-55-22 name=__codelineno-55-22 href=#__codelineno-55-22></a><span class=go>2021-02-23 00:00:00+00:00    False    False</span>
</span><span id=__span-55-23><a id=__codelineno-55-23 name=__codelineno-55-23 href=#__codelineno-55-23></a><span class=go>2021-02-24 00:00:00+00:00    False    False</span>
</span><span id=__span-55-24><a id=__codelineno-55-24 name=__codelineno-55-24 href=#__codelineno-55-24></a>
</span><span id=__span-55-25><a id=__codelineno-55-25 name=__codelineno-55-25 href=#__codelineno-55-25></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span> <span class=o>==</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>close</span>  <span class=c1># (5)!</span>
</span><span id=__span-55-26><a id=__codelineno-55-26 name=__codelineno-55-26 href=#__codelineno-55-26></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-55-27><a id=__codelineno-55-27 name=__codelineno-55-27 href=#__codelineno-55-27></a><span class=go>Open time                                  </span>
</span><span id=__span-55-28><a id=__codelineno-55-28 name=__codelineno-55-28 href=#__codelineno-55-28></a><span class=go>2021-02-18 00:00:00+00:00    False    False</span>
</span><span id=__span-55-29><a id=__codelineno-55-29 name=__codelineno-55-29 href=#__codelineno-55-29></a><span class=go>2021-02-19 00:00:00+00:00    False    False</span>
</span><span id=__span-55-30><a id=__codelineno-55-30 name=__codelineno-55-30 href=#__codelineno-55-30></a><span class=go>2021-02-20 00:00:00+00:00    False    False</span>
</span><span id=__span-55-31><a id=__codelineno-55-31 name=__codelineno-55-31 href=#__codelineno-55-31></a><span class=go>2021-02-21 00:00:00+00:00     True     True</span>
</span><span id=__span-55-32><a id=__codelineno-55-32 name=__codelineno-55-32 href=#__codelineno-55-32></a><span class=go>2021-02-22 00:00:00+00:00    False    False</span>
</span><span id=__span-55-33><a id=__codelineno-55-33 name=__codelineno-55-33 href=#__codelineno-55-33></a><span class=go>2021-02-23 00:00:00+00:00    False    False</span>
</span><span id=__span-55-34><a id=__codelineno-55-34 name=__codelineno-55-34 href=#__codelineno-55-34></a><span class=go>2021-02-24 00:00:00+00:00    False    False</span>
</span></code></pre></div> <ol> <li>Create a new price array with the same shape as the data.</li> <li>Define signals and broadcast them to the price array so they can be used as a mask.</li> <li>Set any element in the price array that corresponds to an entry signal to the opening price.</li> <li>Generate a mask of filled orders whose price is open (this comparison works only if slippage is zero!).</li> <li>Generate a mask of filled orders whose price is close.</li> </ol> <p>Now, let's execute orders using the opening price of the next bar instead:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-56-1><a id=__codelineno-56-1 name=__codelineno-56-1 href=#__codelineno-56-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-56-2><a id=__codelineno-56-2 name=__codelineno-56-2 href=#__codelineno-56-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-56-3><a id=__codelineno-56-3 name=__codelineno-56-3 href=#__codelineno-56-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-56-4><a id=__codelineno-56-4 name=__codelineno-56-4 href=#__codelineno-56-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-56-5><a id=__codelineno-56-5 name=__codelineno-56-5 href=#__codelineno-56-5></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=s2>&quot;nextopen&quot;</span>
</span><span id=__span-56-6><a id=__codelineno-56-6 name=__codelineno-56-6 href=#__codelineno-56-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-56-7><a id=__codelineno-56-7 name=__codelineno-56-7 href=#__codelineno-56-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span> <span class=o>==</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>open</span>
</span><span id=__span-56-8><a id=__codelineno-56-8 name=__codelineno-56-8 href=#__codelineno-56-8></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-56-9><a id=__codelineno-56-9 name=__codelineno-56-9 href=#__codelineno-56-9></a><span class=go>Open time                                  </span>
</span><span id=__span-56-10><a id=__codelineno-56-10 name=__codelineno-56-10 href=#__codelineno-56-10></a><span class=go>2021-02-18 00:00:00+00:00    False    False</span>
</span><span id=__span-56-11><a id=__codelineno-56-11 name=__codelineno-56-11 href=#__codelineno-56-11></a><span class=go>2021-02-19 00:00:00+00:00     True     True</span>
</span><span id=__span-56-12><a id=__codelineno-56-12 name=__codelineno-56-12 href=#__codelineno-56-12></a><span class=go>2021-02-20 00:00:00+00:00    False    False</span>
</span><span id=__span-56-13><a id=__codelineno-56-13 name=__codelineno-56-13 href=#__codelineno-56-13></a><span class=go>2021-02-21 00:00:00+00:00    False    False</span>
</span><span id=__span-56-14><a id=__codelineno-56-14 name=__codelineno-56-14 href=#__codelineno-56-14></a><span class=go>2021-02-22 00:00:00+00:00     True     True</span>
</span><span id=__span-56-15><a id=__codelineno-56-15 name=__codelineno-56-15 href=#__codelineno-56-15></a><span class=go>2021-02-23 00:00:00+00:00    False    False</span>
</span><span id=__span-56-16><a id=__codelineno-56-16 name=__codelineno-56-16 href=#__codelineno-56-16></a><span class=go>2021-02-24 00:00:00+00:00    False    False</span>
</span></code></pre></div> <p>As we can see, the simulator waited for one bar and then executed each signal using the opening price. This is one of the safest approaches for backtesting because it allows you the freedom to run indicators on any price without worrying about look-ahead bias during execution. The most bulletproof approach is to use the next close, as the difference between the previous close and the next open is usually negligible.</p> <h3 id=shifting>Shifting<a class=headerlink href=#shifting title="Permanent link">&para;</a></h3> <p>We could have achieved the same result as above by manually shifting the signal arrays by one bar:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-57-1><a id=__codelineno-57-1 name=__codelineno-57-1 href=#__codelineno-57-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-57-2><a id=__codelineno-57-2 name=__codelineno-57-2 href=#__codelineno-57-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-57-3><a id=__codelineno-57-3 name=__codelineno-57-3 href=#__codelineno-57-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>fshift</span><span class=p>(),</span>
</span><span id=__span-57-4><a id=__codelineno-57-4 name=__codelineno-57-4 href=#__codelineno-57-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>fshift</span><span class=p>(),</span>
</span><span id=__span-57-5><a id=__codelineno-57-5 name=__codelineno-57-5 href=#__codelineno-57-5></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=s2>&quot;open&quot;</span>  <span class=c1># (1)!</span>
</span><span id=__span-57-6><a id=__codelineno-57-6 name=__codelineno-57-6 href=#__codelineno-57-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-57-7><a id=__codelineno-57-7 name=__codelineno-57-7 href=#__codelineno-57-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span> <span class=o>==</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>open</span>
</span><span id=__span-57-8><a id=__codelineno-57-8 name=__codelineno-57-8 href=#__codelineno-57-8></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-57-9><a id=__codelineno-57-9 name=__codelineno-57-9 href=#__codelineno-57-9></a><span class=go>Open time                                  </span>
</span><span id=__span-57-10><a id=__codelineno-57-10 name=__codelineno-57-10 href=#__codelineno-57-10></a><span class=go>2021-02-18 00:00:00+00:00    False    False</span>
</span><span id=__span-57-11><a id=__codelineno-57-11 name=__codelineno-57-11 href=#__codelineno-57-11></a><span class=go>2021-02-19 00:00:00+00:00     True     True</span>
</span><span id=__span-57-12><a id=__codelineno-57-12 name=__codelineno-57-12 href=#__codelineno-57-12></a><span class=go>2021-02-20 00:00:00+00:00    False    False</span>
</span><span id=__span-57-13><a id=__codelineno-57-13 name=__codelineno-57-13 href=#__codelineno-57-13></a><span class=go>2021-02-21 00:00:00+00:00    False    False</span>
</span><span id=__span-57-14><a id=__codelineno-57-14 name=__codelineno-57-14 href=#__codelineno-57-14></a><span class=go>2021-02-22 00:00:00+00:00     True     True</span>
</span><span id=__span-57-15><a id=__codelineno-57-15 name=__codelineno-57-15 href=#__codelineno-57-15></a><span class=go>2021-02-23 00:00:00+00:00    False    False</span>
</span><span id=__span-57-16><a id=__codelineno-57-16 name=__codelineno-57-16 href=#__codelineno-57-16></a><span class=go>2021-02-24 00:00:00+00:00    False    False</span>
</span></code></pre></div> <ol> <li>When shifting manually, use the open or close of the current bar.</li> </ol> <p>This is one of the most underrated features of VBT: since you are working with array data, you can shift the data so that any current bar uses information from the past. In the example above, after forward-shifting the signal arrays, the long entry signal on February 18 moves to February 19, but the index remains the same. Thus, the surrounding price information in the form of OHLC (the <code>open</code>, <code>high</code>, <code>low</code>, and <code>close</code> arguments) must be left unchanged and should never be shifted. This also means you not only have to shift the signals but also any information linked to those signals, such as the order direction and price.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-58-1><a id=__codelineno-58-1 name=__codelineno-58-1 href=#__codelineno-58-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-58-2><a id=__codelineno-58-2 name=__codelineno-58-2 href=#__codelineno-58-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-58-3><a id=__codelineno-58-3 name=__codelineno-58-3 href=#__codelineno-58-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>])</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>fshift</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=kc>False</span><span class=p>),</span>
</span><span id=__span-58-4><a id=__codelineno-58-4 name=__codelineno-58-4 href=#__codelineno-58-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>    <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>])</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>fshift</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=kc>False</span><span class=p>),</span>
</span><span id=__span-58-5><a id=__codelineno-58-5 name=__codelineno-58-5 href=#__codelineno-58-5></a><span class=gp>... </span>    <span class=n>direction</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>L</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>S</span><span class=p>,</span> <span class=n>S</span><span class=p>,</span> <span class=n>S</span><span class=p>])</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>fshift</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-58-6><a id=__codelineno-58-6 name=__codelineno-58-6 href=#__codelineno-58-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-58-7><a id=__codelineno-58-7 name=__codelineno-58-7 href=#__codelineno-58-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-58-8><a id=__codelineno-58-8 name=__codelineno-58-8 href=#__codelineno-58-8></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-58-9><a id=__codelineno-58-9 name=__codelineno-58-9 href=#__codelineno-58-9></a><span class=go>Open time                                    </span>
</span><span id=__span-58-10><a id=__codelineno-58-10 name=__codelineno-58-10 href=#__codelineno-58-10></a><span class=go>2021-02-18 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-58-11><a id=__codelineno-58-11 name=__codelineno-58-11 href=#__codelineno-58-11></a><span class=go>2021-02-19 00:00:00+00:00  0.001789  0.051151</span>
</span><span id=__span-58-12><a id=__codelineno-58-12 name=__codelineno-58-12 href=#__codelineno-58-12></a><span class=go>2021-02-20 00:00:00+00:00  0.001789  0.051151</span>
</span><span id=__span-58-13><a id=__codelineno-58-13 name=__codelineno-58-13 href=#__codelineno-58-13></a><span class=go>2021-02-21 00:00:00+00:00  0.001789  0.051151</span>
</span><span id=__span-58-14><a id=__codelineno-58-14 name=__codelineno-58-14 href=#__codelineno-58-14></a><span class=go>2021-02-22 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-58-15><a id=__codelineno-58-15 name=__codelineno-58-15 href=#__codelineno-58-15></a><span class=go>2021-02-23 00:00:00+00:00 -0.001979 -0.057624</span>
</span><span id=__span-58-16><a id=__codelineno-58-16 name=__codelineno-58-16 href=#__codelineno-58-16></a><span class=go>2021-02-24 00:00:00+00:00 -0.001979 -0.057624</span>
</span></code></pre></div> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>As a rule of thumb: if an argument is signal-anchored, it should be shifted as well. If an argument is date-anchored, it should remain unchanged.</p> </div> <p>To reduce the need for manual shifting, VBT can handle it for us automatically! To enable this, provide the <code>from_ago</code> argument, which represents how many bars ago all the signal and order information should be taken from. For example, when <code>from_ago=1</code>, the related information is taken from the previous bar:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-59-1><a id=__codelineno-59-1 name=__codelineno-59-1 href=#__codelineno-59-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-59-2><a id=__codelineno-59-2 name=__codelineno-59-2 href=#__codelineno-59-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-59-3><a id=__codelineno-59-3 name=__codelineno-59-3 href=#__codelineno-59-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-59-4><a id=__codelineno-59-4 name=__codelineno-59-4 href=#__codelineno-59-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>    <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>]),</span>
</span><span id=__span-59-5><a id=__codelineno-59-5 name=__codelineno-59-5 href=#__codelineno-59-5></a><span class=gp>... </span>    <span class=n>direction</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>L</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>S</span><span class=p>,</span> <span class=n>S</span><span class=p>,</span> <span class=n>S</span><span class=p>]),</span>
</span><span id=__span-59-6><a id=__codelineno-59-6 name=__codelineno-59-6 href=#__codelineno-59-6></a><span class=gp>... </span>    <span class=n>from_ago</span><span class=o>=</span><span class=mi>1</span>
</span><span id=__span-59-7><a id=__codelineno-59-7 name=__codelineno-59-7 href=#__codelineno-59-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-59-8><a id=__codelineno-59-8 name=__codelineno-59-8 href=#__codelineno-59-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>assets</span>
</span><span id=__span-59-9><a id=__codelineno-59-9 name=__codelineno-59-9 href=#__codelineno-59-9></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-59-10><a id=__codelineno-59-10 name=__codelineno-59-10 href=#__codelineno-59-10></a><span class=go>Open time                                    </span>
</span><span id=__span-59-11><a id=__codelineno-59-11 name=__codelineno-59-11 href=#__codelineno-59-11></a><span class=go>2021-02-18 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-59-12><a id=__codelineno-59-12 name=__codelineno-59-12 href=#__codelineno-59-12></a><span class=go>2021-02-19 00:00:00+00:00  0.001789  0.051151</span>
</span><span id=__span-59-13><a id=__codelineno-59-13 name=__codelineno-59-13 href=#__codelineno-59-13></a><span class=go>2021-02-20 00:00:00+00:00  0.001789  0.051151</span>
</span><span id=__span-59-14><a id=__codelineno-59-14 name=__codelineno-59-14 href=#__codelineno-59-14></a><span class=go>2021-02-21 00:00:00+00:00  0.001789  0.051151</span>
</span><span id=__span-59-15><a id=__codelineno-59-15 name=__codelineno-59-15 href=#__codelineno-59-15></a><span class=go>2021-02-22 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-59-16><a id=__codelineno-59-16 name=__codelineno-59-16 href=#__codelineno-59-16></a><span class=go>2021-02-23 00:00:00+00:00 -0.001979 -0.057624</span>
</span><span id=__span-59-17><a id=__codelineno-59-17 name=__codelineno-59-17 href=#__codelineno-59-17></a><span class=go>2021-02-24 00:00:00+00:00 -0.001979 -0.057624</span>
</span></code></pre></div> <p>This argument can also be supplied as an array.</p> <h3 id=slippage>Slippage<a class=headerlink href=#slippage title="Permanent link">&para;</a></h3> <p>By default, an order is executed as a market order. You can see this in the portfolio settings under the key <code>order_type</code>. Market orders are transactions meant to execute as quickly as possible at the current market price, which is always <code>price</code> (by default, the closing price). In reality, however, the price at which an order is executed often does not match the price at which it was requested. To account for this difference, we need to introduce slippage. Assuming the trading volume is high, we should see less slippage. When the trading volume is low, we should expect to see more slippage. An optimal slippage value can be calculated from order book data (see <a href=https://www.hodlbot.io/blog/an-analysis-of-slippage-on-the-binance-exchange>this blog</a>).</p> <p>But let's assume for a moment that the average slippage is 0.5%. Using this together with the default price is generally not recommended, since the closing price is meant to be the latest price seen at each bar. To make the simulation more realistic, we should apply slippage to the next open instead:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-60-1><a id=__codelineno-60-1 name=__codelineno-60-1 href=#__codelineno-60-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-60-2><a id=__codelineno-60-2 name=__codelineno-60-2 href=#__codelineno-60-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-60-3><a id=__codelineno-60-3 name=__codelineno-60-3 href=#__codelineno-60-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-60-4><a id=__codelineno-60-4 name=__codelineno-60-4 href=#__codelineno-60-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-60-5><a id=__codelineno-60-5 name=__codelineno-60-5 href=#__codelineno-60-5></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=s2>&quot;nextopen&quot;</span><span class=p>,</span>
</span><span id=__span-60-6><a id=__codelineno-60-6 name=__codelineno-60-6 href=#__codelineno-60-6></a><span class=gp>... </span>    <span class=n>slippage</span><span class=o>=</span><span class=mf>0.005</span>  <span class=c1># (1)!</span>
</span><span id=__span-60-7><a id=__codelineno-60-7 name=__codelineno-60-7 href=#__codelineno-60-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-60-8><a id=__codelineno-60-8 name=__codelineno-60-8 href=#__codelineno-60-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>  <span class=c1># (2)!</span>
</span><span id=__span-60-9><a id=__codelineno-60-9 name=__codelineno-60-9 href=#__codelineno-60-9></a><span class=go>symbol                         BTCUSDT     ETHUSDT</span>
</span><span id=__span-60-10><a id=__codelineno-60-10 name=__codelineno-60-10 href=#__codelineno-60-10></a><span class=go>Open time                                         </span>
</span><span id=__span-60-11><a id=__codelineno-60-11 name=__codelineno-60-11 href=#__codelineno-60-11></a><span class=go>2021-02-18 00:00:00+00:00          NaN         NaN</span>
</span><span id=__span-60-12><a id=__codelineno-60-12 name=__codelineno-60-12 href=#__codelineno-60-12></a><span class=go>2021-02-19 00:00:00+00:00  51810.37305  1948.60455</span>
</span><span id=__span-60-13><a id=__codelineno-60-13 name=__codelineno-60-13 href=#__codelineno-60-13></a><span class=go>2021-02-20 00:00:00+00:00          NaN         NaN</span>
</span><span id=__span-60-14><a id=__codelineno-60-14 name=__codelineno-60-14 href=#__codelineno-60-14></a><span class=go>2021-02-21 00:00:00+00:00          NaN         NaN</span>
</span><span id=__span-60-15><a id=__codelineno-60-15 name=__codelineno-60-15 href=#__codelineno-60-15></a><span class=go>2021-02-22 00:00:00+00:00  57125.28825  1923.87230</span>
</span><span id=__span-60-16><a id=__codelineno-60-16 name=__codelineno-60-16 href=#__codelineno-60-16></a><span class=go>2021-02-23 00:00:00+00:00          NaN         NaN</span>
</span><span id=__span-60-17><a id=__codelineno-60-17 name=__codelineno-60-17 href=#__codelineno-60-17></a><span class=go>2021-02-24 00:00:00+00:00          NaN         NaN</span>
</span><span id=__span-60-18><a id=__codelineno-60-18 name=__codelineno-60-18 href=#__codelineno-60-18></a>
</span><span id=__span-60-19><a id=__codelineno-60-19 name=__codelineno-60-19 href=#__codelineno-60-19></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span> <span class=o>/</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>open</span>  <span class=c1># (3)!</span>
</span><span id=__span-60-20><a id=__codelineno-60-20 name=__codelineno-60-20 href=#__codelineno-60-20></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-60-21><a id=__codelineno-60-21 name=__codelineno-60-21 href=#__codelineno-60-21></a><span class=go>Open time                                  </span>
</span><span id=__span-60-22><a id=__codelineno-60-22 name=__codelineno-60-22 href=#__codelineno-60-22></a><span class=go>2021-02-18 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-60-23><a id=__codelineno-60-23 name=__codelineno-60-23 href=#__codelineno-60-23></a><span class=go>2021-02-19 00:00:00+00:00    1.005    1.005</span>
</span><span id=__span-60-24><a id=__codelineno-60-24 name=__codelineno-60-24 href=#__codelineno-60-24></a><span class=go>2021-02-20 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-60-25><a id=__codelineno-60-25 name=__codelineno-60-25 href=#__codelineno-60-25></a><span class=go>2021-02-21 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-60-26><a id=__codelineno-60-26 name=__codelineno-60-26 href=#__codelineno-60-26></a><span class=go>2021-02-22 00:00:00+00:00    0.995    0.995</span>
</span><span id=__span-60-27><a id=__codelineno-60-27 name=__codelineno-60-27 href=#__codelineno-60-27></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-60-28><a id=__codelineno-60-28 name=__codelineno-60-28 href=#__codelineno-60-28></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN</span>
</span></code></pre></div> <ol> <li>0.01 is 1%.</li> <li>Get the filled order price.</li> <li>Get the filled order price relative to the opening price.</li> </ol> <p>We can see that slippage increased the price by 0.5% when buying and decreased the price by 0.5% when selling. Adding slippage will always result in a fixed price penalty, so the slippage value should always reflect the average penalty recorded in the market for transactions of this size. Since slippage is not static and depends on many factors, it can be provided as an array.</p> <h3 id=limit-orders>Limit orders<a class=headerlink href=#limit-orders title="Permanent link">&para;</a></h3> <p>To help reduce or eliminate slippage, traders use limit orders instead of market orders. A limit order only fills at the price we want, or better. Unlike a market order, it will never fill at a worse price. However, there is a catch: while the price is guaranteed, the filling of the order is not, and limit orders will not be executed unless the asset price meets the order requirements. If the asset does not reach the specified price, the order does not get filled, and we may miss out on the trading opportunity. So, what happens when we execute our signals using limit orders? Let's change the default order type by setting the <code>order_type</code> argument to <code>"limit"</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-61-1><a id=__codelineno-61-1 name=__codelineno-61-1 href=#__codelineno-61-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-61-2><a id=__codelineno-61-2 name=__codelineno-61-2 href=#__codelineno-61-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-61-3><a id=__codelineno-61-3 name=__codelineno-61-3 href=#__codelineno-61-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-61-4><a id=__codelineno-61-4 name=__codelineno-61-4 href=#__codelineno-61-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-61-5><a id=__codelineno-61-5 name=__codelineno-61-5 href=#__codelineno-61-5></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span>
</span><span id=__span-61-6><a id=__codelineno-61-6 name=__codelineno-61-6 href=#__codelineno-61-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-61-7><a id=__codelineno-61-7 name=__codelineno-61-7 href=#__codelineno-61-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-61-8><a id=__codelineno-61-8 name=__codelineno-61-8 href=#__codelineno-61-8></a><span class=go>symbol                      BTCUSDT  ETHUSDT</span>
</span><span id=__span-61-9><a id=__codelineno-61-9 name=__codelineno-61-9 href=#__codelineno-61-9></a><span class=go>Open time                                   </span>
</span><span id=__span-61-10><a id=__codelineno-61-10 name=__codelineno-61-10 href=#__codelineno-61-10></a><span class=go>2021-02-18 00:00:00+00:00       NaN      NaN</span>
</span><span id=__span-61-11><a id=__codelineno-61-11 name=__codelineno-61-11 href=#__codelineno-61-11></a><span class=go>2021-02-19 00:00:00+00:00  51552.60  1938.91</span>
</span><span id=__span-61-12><a id=__codelineno-61-12 name=__codelineno-61-12 href=#__codelineno-61-12></a><span class=go>2021-02-20 00:00:00+00:00       NaN      NaN</span>
</span><span id=__span-61-13><a id=__codelineno-61-13 name=__codelineno-61-13 href=#__codelineno-61-13></a><span class=go>2021-02-21 00:00:00+00:00       NaN      NaN</span>
</span><span id=__span-61-14><a id=__codelineno-61-14 name=__codelineno-61-14 href=#__codelineno-61-14></a><span class=go>2021-02-22 00:00:00+00:00  57412.35  1933.54</span>
</span><span id=__span-61-15><a id=__codelineno-61-15 name=__codelineno-61-15 href=#__codelineno-61-15></a><span class=go>2021-02-23 00:00:00+00:00       NaN      NaN</span>
</span><span id=__span-61-16><a id=__codelineno-61-16 name=__codelineno-61-16 href=#__codelineno-61-16></a><span class=go>2021-02-24 00:00:00+00:00       NaN      NaN</span>
</span></code></pre></div> <p>Since the default order price is the closing price, the simulator used it as the target limit price and skipped the entry bar. On the next bar, the simulator checked if the limit price was reached by comparing it against the full candle. As shown above, each of the target prices could be met as early as the next bar, which is similar to using the next opening price as the order execution price. However, such a rapid match does not always happen: what if we want to enter a short trade on February 22 using the previous high as the limit price?</p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>To skip the entry bar regardless of the price, you can set the <code>limit_delay</code> argument to <code>True</code>.</p> </div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-62-1><a id=__codelineno-62-1 name=__codelineno-62-1 href=#__codelineno-62-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-62-2><a id=__codelineno-62-2 name=__codelineno-62-2 href=#__codelineno-62-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-62-3><a id=__codelineno-62-3 name=__codelineno-62-3 href=#__codelineno-62-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-62-4><a id=__codelineno-62-4 name=__codelineno-62-4 href=#__codelineno-62-4></a><span class=gp>... </span>    <span class=n>direction</span><span class=o>=</span><span class=s2>&quot;shortonly&quot;</span><span class=p>,</span>
</span><span id=__span-62-5><a id=__codelineno-62-5 name=__codelineno-62-5 href=#__codelineno-62-5></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>sub_data</span><span class=o>.</span><span class=n>high</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>fshift</span><span class=p>(),</span>  <span class=c1># (1)!</span>
</span><span id=__span-62-6><a id=__codelineno-62-6 name=__codelineno-62-6 href=#__codelineno-62-6></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span>
</span><span id=__span-62-7><a id=__codelineno-62-7 name=__codelineno-62-7 href=#__codelineno-62-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-62-8><a id=__codelineno-62-8 name=__codelineno-62-8 href=#__codelineno-62-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-62-9><a id=__codelineno-62-9 name=__codelineno-62-9 href=#__codelineno-62-9></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-62-10><a id=__codelineno-62-10 name=__codelineno-62-10 href=#__codelineno-62-10></a><span class=go>Open time                                  </span>
</span><span id=__span-62-11><a id=__codelineno-62-11 name=__codelineno-62-11 href=#__codelineno-62-11></a><span class=go>2021-02-18 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-62-12><a id=__codelineno-62-12 name=__codelineno-62-12 href=#__codelineno-62-12></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-62-13><a id=__codelineno-62-13 name=__codelineno-62-13 href=#__codelineno-62-13></a><span class=go>2021-02-20 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-62-14><a id=__codelineno-62-14 name=__codelineno-62-14 href=#__codelineno-62-14></a><span class=go>2021-02-21 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-62-15><a id=__codelineno-62-15 name=__codelineno-62-15 href=#__codelineno-62-15></a><span class=go>2021-02-22 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-62-16><a id=__codelineno-62-16 name=__codelineno-62-16 href=#__codelineno-62-16></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-62-17><a id=__codelineno-62-17 name=__codelineno-62-17 href=#__codelineno-62-17></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN</span>
</span></code></pre></div> <ol> <li>Shift the high price by one bar to use the previous high price.</li> </ol> <p>In this case, no limit order could be filled since the same price or higher (we are selling) could not be found at any time during or after February 22. Now we have an order that could potentially remain pending forever. How can we limit its lifetime? There are several possibilities.</p> <h4 id=time-in-force>Time in force<a class=headerlink href=#time-in-force title="Permanent link">&para;</a></h4> <p>Time-in-force orders can be created using the <code>limit_tif</code> argument, which expects a time delta in any format that can be converted to <code>np.timedelta64</code> and then to a 64-bit integer representing nanoseconds. Accepted formats include a string, <code>pd.Timedelta</code>, <code>datetime.timedelta</code>, <code>np.timedelta64</code>, or an integer. The time-in-force period begins counting at the <strong>start</strong> of the entry bar (even if the limit order was placed at the end of the bar) and will be checked at the beginning of each bar, starting with the second one. Let's create a buy limit order on February 20 using the previous low price:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-63-1><a id=__codelineno-63-1 name=__codelineno-63-1 href=#__codelineno-63-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-63-2><a id=__codelineno-63-2 name=__codelineno-63-2 href=#__codelineno-63-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-63-3><a id=__codelineno-63-3 name=__codelineno-63-3 href=#__codelineno-63-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-63-4><a id=__codelineno-63-4 name=__codelineno-63-4 href=#__codelineno-63-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>sub_data</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>fshift</span><span class=p>(),</span>
</span><span id=__span-63-5><a id=__codelineno-63-5 name=__codelineno-63-5 href=#__codelineno-63-5></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span>
</span><span id=__span-63-6><a id=__codelineno-63-6 name=__codelineno-63-6 href=#__codelineno-63-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-63-7><a id=__codelineno-63-7 name=__codelineno-63-7 href=#__codelineno-63-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-63-8><a id=__codelineno-63-8 name=__codelineno-63-8 href=#__codelineno-63-8></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-63-9><a id=__codelineno-63-9 name=__codelineno-63-9 href=#__codelineno-63-9></a><span class=go>Open time                                  </span>
</span><span id=__span-63-10><a id=__codelineno-63-10 name=__codelineno-63-10 href=#__codelineno-63-10></a><span class=go>2021-02-18 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-63-11><a id=__codelineno-63-11 name=__codelineno-63-11 href=#__codelineno-63-11></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-63-12><a id=__codelineno-63-12 name=__codelineno-63-12 href=#__codelineno-63-12></a><span class=go>2021-02-20 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-63-13><a id=__codelineno-63-13 name=__codelineno-63-13 href=#__codelineno-63-13></a><span class=go>2021-02-21 00:00:00+00:00      NaN   1891.0</span>
</span><span id=__span-63-14><a id=__codelineno-63-14 name=__codelineno-63-14 href=#__codelineno-63-14></a><span class=go>2021-02-22 00:00:00+00:00  50710.2      NaN</span>
</span><span id=__span-63-15><a id=__codelineno-63-15 name=__codelineno-63-15 href=#__codelineno-63-15></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-63-16><a id=__codelineno-63-16 name=__codelineno-63-16 href=#__codelineno-63-16></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN</span>
</span></code></pre></div> <p>We can see that the limit order in the <code>BTCUSDT</code> column was executed in two bars, while the limit order in the <code>ETHUSDT</code> column was executed in just one bar. Below, we test a TIF option passed as a frequency string, which is supported only outside of arrays:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-64-1><a id=__codelineno-64-1 name=__codelineno-64-1 href=#__codelineno-64-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-64-2><a id=__codelineno-64-2 name=__codelineno-64-2 href=#__codelineno-64-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-64-3><a id=__codelineno-64-3 name=__codelineno-64-3 href=#__codelineno-64-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-64-4><a id=__codelineno-64-4 name=__codelineno-64-4 href=#__codelineno-64-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>sub_data</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>fshift</span><span class=p>(),</span>
</span><span id=__span-64-5><a id=__codelineno-64-5 name=__codelineno-64-5 href=#__codelineno-64-5></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span><span class=p>,</span>
</span><span id=__span-64-6><a id=__codelineno-64-6 name=__codelineno-64-6 href=#__codelineno-64-6></a><span class=gp>... </span>    <span class=n>limit_tif</span><span class=o>=</span><span class=s2>&quot;2d&quot;</span>  <span class=c1># (1)!</span>
</span><span id=__span-64-7><a id=__codelineno-64-7 name=__codelineno-64-7 href=#__codelineno-64-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-64-8><a id=__codelineno-64-8 name=__codelineno-64-8 href=#__codelineno-64-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-64-9><a id=__codelineno-64-9 name=__codelineno-64-9 href=#__codelineno-64-9></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-64-10><a id=__codelineno-64-10 name=__codelineno-64-10 href=#__codelineno-64-10></a><span class=go>Open time                                  </span>
</span><span id=__span-64-11><a id=__codelineno-64-11 name=__codelineno-64-11 href=#__codelineno-64-11></a><span class=go>2021-02-18 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-64-12><a id=__codelineno-64-12 name=__codelineno-64-12 href=#__codelineno-64-12></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-64-13><a id=__codelineno-64-13 name=__codelineno-64-13 href=#__codelineno-64-13></a><span class=go>2021-02-20 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-64-14><a id=__codelineno-64-14 name=__codelineno-64-14 href=#__codelineno-64-14></a><span class=go>2021-02-21 00:00:00+00:00      NaN   1891.0</span>
</span><span id=__span-64-15><a id=__codelineno-64-15 name=__codelineno-64-15 href=#__codelineno-64-15></a><span class=go>2021-02-22 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-64-16><a id=__codelineno-64-16 name=__codelineno-64-16 href=#__codelineno-64-16></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-64-17><a id=__codelineno-64-17 name=__codelineno-64-17 href=#__codelineno-64-17></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN</span>
</span></code></pre></div> <ol> <li>Gets translated into a time delta using <a href=https://vectorbt.pro/pvt_41531c19/api/utils/datetime_/#vectorbtpro.utils.datetime_.to_timedelta64>to_timedelta64</a>.</li> </ol> <p>Why is there no order in <code>BTCUSDT</code>? Because 2 days from <code>2021-02-20 00:00:00</code> is <code>2021-02-22 00:00:00</code>, which is when the order is canceled. Since each timestamp represents the opening time of a bar, the pending order no longer exists in the fifth bar. To specify TIF inside an array or to test multiple configurations, use a Pandas or NumPy format, or specify the total duration in nanoseconds instead of a string. Let's test all formats at once!</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-65-1><a id=__codelineno-65-1 name=__codelineno-65-1 href=#__codelineno-65-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-65-2><a id=__codelineno-65-2 name=__codelineno-65-2 href=#__codelineno-65-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-65-3><a id=__codelineno-65-3 name=__codelineno-65-3 href=#__codelineno-65-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-65-4><a id=__codelineno-65-4 name=__codelineno-65-4 href=#__codelineno-65-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>sub_data</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>fshift</span><span class=p>(),</span>
</span><span id=__span-65-5><a id=__codelineno-65-5 name=__codelineno-65-5 href=#__codelineno-65-5></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span><span class=p>,</span>
</span><span id=__span-65-6><a id=__codelineno-65-6 name=__codelineno-65-6 href=#__codelineno-65-6></a><span class=gp>... </span>    <span class=n>limit_tif</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span>
</span><span id=__span-65-7><a id=__codelineno-65-7 name=__codelineno-65-7 href=#__codelineno-65-7></a><span class=gp>... </span>        <span class=o>-</span><span class=mi>1</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-65-8><a id=__codelineno-65-8 name=__codelineno-65-8 href=#__codelineno-65-8></a><span class=gp>... </span>        <span class=n>pd</span><span class=o>.</span><span class=n>Timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>  <span class=c1># (2)!</span>
</span><span id=__span-65-9><a id=__codelineno-65-9 name=__codelineno-65-9 href=#__codelineno-65-9></a><span class=gp>... </span>        <span class=mi>2</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>timedelta64</span><span class=p>(</span><span class=mi>86400000000000</span><span class=p>),</span>  <span class=c1># (3)!</span>
</span><span id=__span-65-10><a id=__codelineno-65-10 name=__codelineno-65-10 href=#__codelineno-65-10></a><span class=gp>... </span>        <span class=mi>3</span> <span class=o>*</span> <span class=n>vbt</span><span class=o>.</span><span class=n>dt_nb</span><span class=o>.</span><span class=n>d_ns</span>  <span class=c1># (4)!</span>
</span><span id=__span-65-11><a id=__codelineno-65-11 name=__codelineno-65-11 href=#__codelineno-65-11></a><span class=gp>... </span>    <span class=p>],</span> <span class=n>keys</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;none&quot;</span><span class=p>,</span> <span class=s2>&quot;1 days&quot;</span><span class=p>,</span> <span class=s2>&quot;2 days&quot;</span><span class=p>,</span> <span class=s2>&quot;3 days&quot;</span><span class=p>])</span>
</span><span id=__span-65-12><a id=__codelineno-65-12 name=__codelineno-65-12 href=#__codelineno-65-12></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-65-13><a id=__codelineno-65-13 name=__codelineno-65-13 href=#__codelineno-65-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-65-14><a id=__codelineno-65-14 name=__codelineno-65-14 href=#__codelineno-65-14></a><span class=go>limit_tif                     none          1 days          2 days          \</span>
</span><span id=__span-65-15><a id=__codelineno-65-15 name=__codelineno-65-15 href=#__codelineno-65-15></a><span class=go>symbol                     BTCUSDT ETHUSDT BTCUSDT ETHUSDT BTCUSDT ETHUSDT   </span>
</span><span id=__span-65-16><a id=__codelineno-65-16 name=__codelineno-65-16 href=#__codelineno-65-16></a><span class=go>Open time                                                                    </span>
</span><span id=__span-65-17><a id=__codelineno-65-17 name=__codelineno-65-17 href=#__codelineno-65-17></a><span class=go>2021-02-18 00:00:00+00:00      NaN     NaN     NaN     NaN     NaN     NaN   </span>
</span><span id=__span-65-18><a id=__codelineno-65-18 name=__codelineno-65-18 href=#__codelineno-65-18></a><span class=go>2021-02-19 00:00:00+00:00      NaN     NaN     NaN     NaN     NaN     NaN   </span>
</span><span id=__span-65-19><a id=__codelineno-65-19 name=__codelineno-65-19 href=#__codelineno-65-19></a><span class=go>2021-02-20 00:00:00+00:00      NaN     NaN     NaN     NaN     NaN     NaN   </span>
</span><span id=__span-65-20><a id=__codelineno-65-20 name=__codelineno-65-20 href=#__codelineno-65-20></a><span class=go>2021-02-21 00:00:00+00:00      NaN  1891.0     NaN     NaN     NaN  1891.0   </span>
</span><span id=__span-65-21><a id=__codelineno-65-21 name=__codelineno-65-21 href=#__codelineno-65-21></a><span class=go>2021-02-22 00:00:00+00:00  50710.2     NaN     NaN     NaN     NaN     NaN   </span>
</span><span id=__span-65-22><a id=__codelineno-65-22 name=__codelineno-65-22 href=#__codelineno-65-22></a><span class=go>2021-02-23 00:00:00+00:00      NaN     NaN     NaN     NaN     NaN     NaN   </span>
</span><span id=__span-65-23><a id=__codelineno-65-23 name=__codelineno-65-23 href=#__codelineno-65-23></a><span class=go>2021-02-24 00:00:00+00:00      NaN     NaN     NaN     NaN     NaN     NaN   </span>
</span><span id=__span-65-24><a id=__codelineno-65-24 name=__codelineno-65-24 href=#__codelineno-65-24></a>
</span><span id=__span-65-25><a id=__codelineno-65-25 name=__codelineno-65-25 href=#__codelineno-65-25></a><span class=go>limit_tif                   3 days          </span>
</span><span id=__span-65-26><a id=__codelineno-65-26 name=__codelineno-65-26 href=#__codelineno-65-26></a><span class=go>symbol                     BTCUSDT ETHUSDT  </span>
</span><span id=__span-65-27><a id=__codelineno-65-27 name=__codelineno-65-27 href=#__codelineno-65-27></a><span class=go>Open time                                   </span>
</span><span id=__span-65-28><a id=__codelineno-65-28 name=__codelineno-65-28 href=#__codelineno-65-28></a><span class=go>2021-02-18 00:00:00+00:00      NaN     NaN  </span>
</span><span id=__span-65-29><a id=__codelineno-65-29 name=__codelineno-65-29 href=#__codelineno-65-29></a><span class=go>2021-02-19 00:00:00+00:00      NaN     NaN  </span>
</span><span id=__span-65-30><a id=__codelineno-65-30 name=__codelineno-65-30 href=#__codelineno-65-30></a><span class=go>2021-02-20 00:00:00+00:00      NaN     NaN  </span>
</span><span id=__span-65-31><a id=__codelineno-65-31 name=__codelineno-65-31 href=#__codelineno-65-31></a><span class=go>2021-02-21 00:00:00+00:00      NaN  1891.0  </span>
</span><span id=__span-65-32><a id=__codelineno-65-32 name=__codelineno-65-32 href=#__codelineno-65-32></a><span class=go>2021-02-22 00:00:00+00:00  50710.2     NaN  </span>
</span><span id=__span-65-33><a id=__codelineno-65-33 name=__codelineno-65-33 href=#__codelineno-65-33></a><span class=go>2021-02-23 00:00:00+00:00      NaN     NaN  </span>
</span><span id=__span-65-34><a id=__codelineno-65-34 name=__codelineno-65-34 href=#__codelineno-65-34></a><span class=go>2021-02-24 00:00:00+00:00      NaN     NaN  </span>
</span></code></pre></div> <ol> <li>Do not use TIF.</li> <li>TIF of 1 day in Pandas format.</li> <li>TIF of 2 days in NumPy format.</li> <li>TIF of 3 days in integer format (nanoseconds).</li> </ol> <div class="admonition note"> <p class=admonition-title>Note</p> <p>NumPy and integer formats are preferred when building large arrays.</p> </div> <p>You can also specify the number of rows instead of a time delta by adjusting the time delta format (<code>time_delta_format</code>), which uses the enumerated type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.TimeDeltaFormat>TimeDeltaFormat</a>. This is needed when the index is not datetime-like, such as after splitting the data for cross-validation. Let's switch the time delta format to <code>Rows</code> and do the same as above, but now wait for a specific number of rows to pass:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-66-1><a id=__codelineno-66-1 name=__codelineno-66-1 href=#__codelineno-66-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-66-2><a id=__codelineno-66-2 name=__codelineno-66-2 href=#__codelineno-66-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-66-3><a id=__codelineno-66-3 name=__codelineno-66-3 href=#__codelineno-66-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-66-4><a id=__codelineno-66-4 name=__codelineno-66-4 href=#__codelineno-66-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>sub_data</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>fshift</span><span class=p>(),</span>
</span><span id=__span-66-5><a id=__codelineno-66-5 name=__codelineno-66-5 href=#__codelineno-66-5></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span><span class=p>,</span>
</span><span id=__span-66-6><a id=__codelineno-66-6 name=__codelineno-66-6 href=#__codelineno-66-6></a><span class=gp>... </span>    <span class=n>limit_tif</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span>
</span><span id=__span-66-7><a id=__codelineno-66-7 name=__codelineno-66-7 href=#__codelineno-66-7></a><span class=gp>... </span>        <span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>],</span> 
</span><span id=__span-66-8><a id=__codelineno-66-8 name=__codelineno-66-8 href=#__codelineno-66-8></a><span class=gp>... </span>        <span class=n>keys</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;none&quot;</span><span class=p>,</span> <span class=s2>&quot;1 rows&quot;</span><span class=p>,</span> <span class=s2>&quot;2 rows&quot;</span><span class=p>,</span> <span class=s2>&quot;3 rows&quot;</span><span class=p>]</span>
</span><span id=__span-66-9><a id=__codelineno-66-9 name=__codelineno-66-9 href=#__codelineno-66-9></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-66-10><a id=__codelineno-66-10 name=__codelineno-66-10 href=#__codelineno-66-10></a><span class=gp>... </span>    <span class=n>time_delta_format</span><span class=o>=</span><span class=s2>&quot;rows&quot;</span>
</span><span id=__span-66-11><a id=__codelineno-66-11 name=__codelineno-66-11 href=#__codelineno-66-11></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <p>If you are confident that your index has a fixed frequency (for example, days instead of business days) and does not have gaps, you can also calculate the number of rows by dividing time deltas:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-67-1><a id=__codelineno-67-1 name=__codelineno-67-1 href=#__codelineno-67-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>index_td</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s2>&quot;1 minute&quot;</span><span class=p>)</span>
</span><span id=__span-67-2><a id=__codelineno-67-2 name=__codelineno-67-2 href=#__codelineno-67-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>tif_td</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s2>&quot;1 day&quot;</span><span class=p>)</span>
</span><span id=__span-67-3><a id=__codelineno-67-3 name=__codelineno-67-3 href=#__codelineno-67-3></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>int</span><span class=p>(</span><span class=n>tif_td</span> <span class=o>/</span> <span class=n>index_td</span><span class=p>)</span>
</span><span id=__span-67-4><a id=__codelineno-67-4 name=__codelineno-67-4 href=#__codelineno-67-4></a><span class=go>1440</span>
</span></code></pre></div> <h4 id=expiration-date>Expiration date<a class=headerlink href=#expiration-date title="Permanent link">&para;</a></h4> <p>Another way to let limit orders expire based on dates and times is by setting an expiration date with <code>limit_expiry</code>. There are two main options: set a frequency at which limit orders should expire, or provide a datetime-like array that can include <code>pd.Timestamp</code>, <code>datetime.datetime</code>, and <code>np.datetime64</code> objects. The argument will be converted into the 64-bit integer format representing Unix time (total nanoseconds since 1970). Let's start with the first option by making limit orders behave like day orders. When passed a frequency, the simulation method will determine the right bound of each timestamp by using <a href=https://vectorbt.pro/pvt_41531c19/api/base/wrapping/#vectorbtpro.base.wrapping.ArrayWrapper.get_period_ns_index>ArrayWrapper.get_period_ns_index</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-68-1><a id=__codelineno-68-1 name=__codelineno-68-1 href=#__codelineno-68-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sub_data</span><span class=o>.</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>get_period_ns_index</span><span class=p>(</span><span class=s2>&quot;1d&quot;</span><span class=p>)</span>
</span><span id=__span-68-2><a id=__codelineno-68-2 name=__codelineno-68-2 href=#__codelineno-68-2></a><span class=go>array([1613692800000000000, 1613779200000000000, 1613865600000000000,</span>
</span><span id=__span-68-3><a id=__codelineno-68-3 name=__codelineno-68-3 href=#__codelineno-68-3></a><span class=go>       1613952000000000000, 1614038400000000000, 1614124800000000000,</span>
</span><span id=__span-68-4><a id=__codelineno-68-4 name=__codelineno-68-4 href=#__codelineno-68-4></a><span class=go>       1614211200000000000])</span>
</span></code></pre></div> <p>Since our data is already daily, let's make a pending limit order expire at the end of the week in which it was created:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-69-1><a id=__codelineno-69-1 name=__codelineno-69-1 href=#__codelineno-69-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-69-2><a id=__codelineno-69-2 name=__codelineno-69-2 href=#__codelineno-69-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-69-3><a id=__codelineno-69-3 name=__codelineno-69-3 href=#__codelineno-69-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-69-4><a id=__codelineno-69-4 name=__codelineno-69-4 href=#__codelineno-69-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>sub_data</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>fshift</span><span class=p>(),</span>
</span><span id=__span-69-5><a id=__codelineno-69-5 name=__codelineno-69-5 href=#__codelineno-69-5></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span><span class=p>,</span>
</span><span id=__span-69-6><a id=__codelineno-69-6 name=__codelineno-69-6 href=#__codelineno-69-6></a><span class=gp>... </span>    <span class=n>limit_expiry</span><span class=o>=</span><span class=s2>&quot;monday&quot;</span>  <span class=c1># (1)!</span>
</span><span id=__span-69-7><a id=__codelineno-69-7 name=__codelineno-69-7 href=#__codelineno-69-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-69-8><a id=__codelineno-69-8 name=__codelineno-69-8 href=#__codelineno-69-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-69-9><a id=__codelineno-69-9 name=__codelineno-69-9 href=#__codelineno-69-9></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-69-10><a id=__codelineno-69-10 name=__codelineno-69-10 href=#__codelineno-69-10></a><span class=go>Open time                                  </span>
</span><span id=__span-69-11><a id=__codelineno-69-11 name=__codelineno-69-11 href=#__codelineno-69-11></a><span class=go>2021-02-18 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-69-12><a id=__codelineno-69-12 name=__codelineno-69-12 href=#__codelineno-69-12></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-69-13><a id=__codelineno-69-13 name=__codelineno-69-13 href=#__codelineno-69-13></a><span class=go>2021-02-20 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-69-14><a id=__codelineno-69-14 name=__codelineno-69-14 href=#__codelineno-69-14></a><span class=go>2021-02-21 00:00:00+00:00      NaN   1891.0</span>
</span><span id=__span-69-15><a id=__codelineno-69-15 name=__codelineno-69-15 href=#__codelineno-69-15></a><span class=go>2021-02-22 00:00:00+00:00  50710.2      NaN</span>
</span><span id=__span-69-16><a id=__codelineno-69-16 name=__codelineno-69-16 href=#__codelineno-69-16></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-69-17><a id=__codelineno-69-17 name=__codelineno-69-17 href=#__codelineno-69-17></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-69-18><a id=__codelineno-69-18 name=__codelineno-69-18 href=#__codelineno-69-18></a>
</span><span id=__span-69-19><a id=__codelineno-69-19 name=__codelineno-69-19 href=#__codelineno-69-19></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sub_data</span><span class=o>.</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>to_period</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>offset</span><span class=p>(</span><span class=s2>&quot;monday&quot;</span><span class=p>))</span>  <span class=c1># (2)!</span>
</span><span id=__span-69-20><a id=__codelineno-69-20 name=__codelineno-69-20 href=#__codelineno-69-20></a><span class=go>PeriodIndex([&#39;2021-02-16/2021-02-22&#39;, &#39;2021-02-16/2021-02-22&#39;,</span>
</span><span id=__span-69-21><a id=__codelineno-69-21 name=__codelineno-69-21 href=#__codelineno-69-21></a><span class=go>             &#39;2021-02-16/2021-02-22&#39;, &#39;2021-02-16/2021-02-22&#39;,</span>
</span><span id=__span-69-22><a id=__codelineno-69-22 name=__codelineno-69-22 href=#__codelineno-69-22></a><span class=go>             &#39;2021-02-16/2021-02-22&#39;, &#39;2021-02-23/2021-03-01&#39;,</span>
</span><span id=__span-69-23><a id=__codelineno-69-23 name=__codelineno-69-23 href=#__codelineno-69-23></a><span class=go>             &#39;2021-02-23/2021-03-01&#39;],</span>
</span><span id=__span-69-24><a id=__codelineno-69-24 name=__codelineno-69-24 href=#__codelineno-69-24></a><span class=go>            dtype=&#39;period[W-MON]&#39;, name=&#39;Open time&#39;)</span>
</span></code></pre></div> <ol> <li>See <a href=https://pandas.pydata.org/docs/user_guide/timeseries.html#anchored-offsets>Anchored offsets</a>.</li> <li>The user warning "Converting to PeriodArray/Index representation will drop timezone information" can be ignored.</li> </ol> <p>Both orders could be executed because the dates <code>2021-02-20</code>, <code>2021-02-21</code>, and <code>2021-02-22</code> are part of the same week, <code>2021-02-16/2021-02-22</code>. If we change the week layout to start on a Sunday, only the first two dates belong to the same week, resulting in the expiration of the pending order in the <code>BTCUSDT</code> column:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-70-1><a id=__codelineno-70-1 name=__codelineno-70-1 href=#__codelineno-70-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-70-2><a id=__codelineno-70-2 name=__codelineno-70-2 href=#__codelineno-70-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-70-3><a id=__codelineno-70-3 name=__codelineno-70-3 href=#__codelineno-70-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-70-4><a id=__codelineno-70-4 name=__codelineno-70-4 href=#__codelineno-70-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>sub_data</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>fshift</span><span class=p>(),</span>
</span><span id=__span-70-5><a id=__codelineno-70-5 name=__codelineno-70-5 href=#__codelineno-70-5></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span><span class=p>,</span>
</span><span id=__span-70-6><a id=__codelineno-70-6 name=__codelineno-70-6 href=#__codelineno-70-6></a><span class=gp>... </span>    <span class=n>limit_expiry</span><span class=o>=</span><span class=s2>&quot;sunday&quot;</span>
</span><span id=__span-70-7><a id=__codelineno-70-7 name=__codelineno-70-7 href=#__codelineno-70-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-70-8><a id=__codelineno-70-8 name=__codelineno-70-8 href=#__codelineno-70-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-70-9><a id=__codelineno-70-9 name=__codelineno-70-9 href=#__codelineno-70-9></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-70-10><a id=__codelineno-70-10 name=__codelineno-70-10 href=#__codelineno-70-10></a><span class=go>Open time                                  </span>
</span><span id=__span-70-11><a id=__codelineno-70-11 name=__codelineno-70-11 href=#__codelineno-70-11></a><span class=go>2021-02-18 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-70-12><a id=__codelineno-70-12 name=__codelineno-70-12 href=#__codelineno-70-12></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-70-13><a id=__codelineno-70-13 name=__codelineno-70-13 href=#__codelineno-70-13></a><span class=go>2021-02-20 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-70-14><a id=__codelineno-70-14 name=__codelineno-70-14 href=#__codelineno-70-14></a><span class=go>2021-02-21 00:00:00+00:00      NaN   1891.0</span>
</span><span id=__span-70-15><a id=__codelineno-70-15 name=__codelineno-70-15 href=#__codelineno-70-15></a><span class=go>2021-02-22 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-70-16><a id=__codelineno-70-16 name=__codelineno-70-16 href=#__codelineno-70-16></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-70-17><a id=__codelineno-70-17 name=__codelineno-70-17 href=#__codelineno-70-17></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-70-18><a id=__codelineno-70-18 name=__codelineno-70-18 href=#__codelineno-70-18></a>
</span><span id=__span-70-19><a id=__codelineno-70-19 name=__codelineno-70-19 href=#__codelineno-70-19></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sub_data</span><span class=o>.</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>to_period</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>offset</span><span class=p>(</span><span class=s2>&quot;sunday&quot;</span><span class=p>))</span>
</span><span id=__span-70-20><a id=__codelineno-70-20 name=__codelineno-70-20 href=#__codelineno-70-20></a><span class=go>PeriodIndex([&#39;2021-02-15/2021-02-21&#39;, &#39;2021-02-15/2021-02-21&#39;,</span>
</span><span id=__span-70-21><a id=__codelineno-70-21 name=__codelineno-70-21 href=#__codelineno-70-21></a><span class=go>             &#39;2021-02-15/2021-02-21&#39;, &#39;2021-02-15/2021-02-21&#39;,</span>
</span><span id=__span-70-22><a id=__codelineno-70-22 name=__codelineno-70-22 href=#__codelineno-70-22></a><span class=go>             &#39;2021-02-22/2021-02-28&#39;, &#39;2021-02-22/2021-02-28&#39;,</span>
</span><span id=__span-70-23><a id=__codelineno-70-23 name=__codelineno-70-23 href=#__codelineno-70-23></a><span class=go>             &#39;2021-02-22/2021-02-28&#39;],</span>
</span><span id=__span-70-24><a id=__codelineno-70-24 name=__codelineno-70-24 href=#__codelineno-70-24></a><span class=go>            dtype=&#39;period[W-SUN]&#39;, name=&#39;Open time&#39;)</span>
</span></code></pre></div> <p>We can also build our own <code>limit_expiry</code> array. For example, let's simulate a TIF of 2 days by relying only on the expiration dates, just as if we used <code>limit_tif="2d"</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-71-1><a id=__codelineno-71-1 name=__codelineno-71-1 href=#__codelineno-71-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-71-2><a id=__codelineno-71-2 name=__codelineno-71-2 href=#__codelineno-71-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-71-3><a id=__codelineno-71-3 name=__codelineno-71-3 href=#__codelineno-71-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-71-4><a id=__codelineno-71-4 name=__codelineno-71-4 href=#__codelineno-71-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>sub_data</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>fshift</span><span class=p>(),</span>
</span><span id=__span-71-5><a id=__codelineno-71-5 name=__codelineno-71-5 href=#__codelineno-71-5></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span><span class=p>,</span>
</span><span id=__span-71-6><a id=__codelineno-71-6 name=__codelineno-71-6 href=#__codelineno-71-6></a><span class=gp>... </span>    <span class=n>limit_expiry</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;&quot;&quot;</span>
</span><span id=__span-71-7><a id=__codelineno-71-7 name=__codelineno-71-7 href=#__codelineno-71-7></a><span class=gp>... </span><span class=s2>    expiry_index = wrapper.index + pd.Timedelta(days=2)</span>
</span><span id=__span-71-8><a id=__codelineno-71-8 name=__codelineno-71-8 href=#__codelineno-71-8></a><span class=gp>... </span><span class=s2>    expiry_arr = vbt.to_2d_array(vbt.dt.to_ns(expiry_index))</span>
</span><span id=__span-71-9><a id=__codelineno-71-9 name=__codelineno-71-9 href=#__codelineno-71-9></a><span class=gp>... </span><span class=s2>    expiry_arr</span>
</span><span id=__span-71-10><a id=__codelineno-71-10 name=__codelineno-71-10 href=#__codelineno-71-10></a><span class=gp>... </span><span class=s2>    &quot;&quot;&quot;</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-71-11><a id=__codelineno-71-11 name=__codelineno-71-11 href=#__codelineno-71-11></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-71-12><a id=__codelineno-71-12 name=__codelineno-71-12 href=#__codelineno-71-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-71-13><a id=__codelineno-71-13 name=__codelineno-71-13 href=#__codelineno-71-13></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-71-14><a id=__codelineno-71-14 name=__codelineno-71-14 href=#__codelineno-71-14></a><span class=go>Open time                                  </span>
</span><span id=__span-71-15><a id=__codelineno-71-15 name=__codelineno-71-15 href=#__codelineno-71-15></a><span class=go>2021-02-18 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-71-16><a id=__codelineno-71-16 name=__codelineno-71-16 href=#__codelineno-71-16></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-71-17><a id=__codelineno-71-17 name=__codelineno-71-17 href=#__codelineno-71-17></a><span class=go>2021-02-20 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-71-18><a id=__codelineno-71-18 name=__codelineno-71-18 href=#__codelineno-71-18></a><span class=go>2021-02-21 00:00:00+00:00      NaN   1891.0</span>
</span><span id=__span-71-19><a id=__codelineno-71-19 name=__codelineno-71-19 href=#__codelineno-71-19></a><span class=go>2021-02-22 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-71-20><a id=__codelineno-71-20 name=__codelineno-71-20 href=#__codelineno-71-20></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-71-21><a id=__codelineno-71-21 name=__codelineno-71-21 href=#__codelineno-71-21></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN</span>
</span></code></pre></div> <ol> <li>After broadcasting, the final index may be different from the original one, so we need to create a template that adds 2 days to the final index and converts it into a two-dimensional array. Leaving it as one-dimensional will broadcast values per column.</li> </ol> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Do not attempt to pass a <code>pd.Index</code> directly, as it will be converted into parameters. Use <code>pd.Series</code> instead.</p> </div> <h4 id=conflicts_1>Conflicts<a class=headerlink href=#conflicts_1 title="Permanent link">&para;</a></h4> <p>What happens if you issue a signal while a limit order is pending? Since <abbr title="From-signals simulation method">FS</abbr> can track only one limit order per column at a time, it must choose a winner. Two arguments are relevant here: <code>upon_adj_limit_conflict</code> and <code>upon_opp_limit_conflict</code>, both of type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.PendingConflictMode>PendingConflictMode</a>. The first controls the decision if both orders attempt to go in the same direction, and the second applies when their directions are opposite. Let's introduce a sell market order on February 21 and test various conflict resolution options:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-72-1><a id=__codelineno-72-1 name=__codelineno-72-1 href=#__codelineno-72-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>all_conflict_modes</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>PendingConflictMode</span><span class=o>.</span><span class=n>_fields</span>  <span class=c1># (1)!</span>
</span><span id=__span-72-2><a id=__codelineno-72-2 name=__codelineno-72-2 href=#__codelineno-72-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-72-3><a id=__codelineno-72-3 name=__codelineno-72-3 href=#__codelineno-72-3></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>),</span>
</span><span id=__span-72-4><a id=__codelineno-72-4 name=__codelineno-72-4 href=#__codelineno-72-4></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span>      <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-72-5><a id=__codelineno-72-5 name=__codelineno-72-5 href=#__codelineno-72-5></a><span class=gp>... </span>    <span class=n>short_entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-72-6><a id=__codelineno-72-6 name=__codelineno-72-6 href=#__codelineno-72-6></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>sub_data</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>fshift</span><span class=p>(),</span>
</span><span id=__span-72-7><a id=__codelineno-72-7 name=__codelineno-72-7 href=#__codelineno-72-7></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>index_dict</span><span class=p>({</span><span class=mi>2</span><span class=p>:</span> <span class=s2>&quot;limit&quot;</span><span class=p>,</span> <span class=s2>&quot;_def&quot;</span><span class=p>:</span> <span class=s2>&quot;market&quot;</span><span class=p>}),</span>  <span class=c1># (2)!</span>
</span><span id=__span-72-8><a id=__codelineno-72-8 name=__codelineno-72-8 href=#__codelineno-72-8></a><span class=gp>... </span>    <span class=n>upon_opp_limit_conflict</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span><span class=n>all_conflict_modes</span><span class=p>)</span>
</span><span id=__span-72-9><a id=__codelineno-72-9 name=__codelineno-72-9 href=#__codelineno-72-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-72-10><a id=__codelineno-72-10 name=__codelineno-72-10 href=#__codelineno-72-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-72-11><a id=__codelineno-72-11 name=__codelineno-72-11 href=#__codelineno-72-11></a><span class=go>upon_opp_limit_conflict    KeepIgnore  KeepExecute  CancelIgnore  \</span>
</span><span id=__span-72-12><a id=__codelineno-72-12 name=__codelineno-72-12 href=#__codelineno-72-12></a><span class=go>Open time                                                          </span>
</span><span id=__span-72-13><a id=__codelineno-72-13 name=__codelineno-72-13 href=#__codelineno-72-13></a><span class=go>2021-02-18 00:00:00+00:00         NaN          NaN           NaN   </span>
</span><span id=__span-72-14><a id=__codelineno-72-14 name=__codelineno-72-14 href=#__codelineno-72-14></a><span class=go>2021-02-19 00:00:00+00:00         NaN          NaN           NaN   </span>
</span><span id=__span-72-15><a id=__codelineno-72-15 name=__codelineno-72-15 href=#__codelineno-72-15></a><span class=go>2021-02-20 00:00:00+00:00         NaN          NaN           NaN   </span>
</span><span id=__span-72-16><a id=__codelineno-72-16 name=__codelineno-72-16 href=#__codelineno-72-16></a><span class=go>2021-02-21 00:00:00+00:00         NaN     53863.93           NaN   </span>
</span><span id=__span-72-17><a id=__codelineno-72-17 name=__codelineno-72-17 href=#__codelineno-72-17></a><span class=go>2021-02-22 00:00:00+00:00     50710.2     50710.20           NaN   </span>
</span><span id=__span-72-18><a id=__codelineno-72-18 name=__codelineno-72-18 href=#__codelineno-72-18></a><span class=go>2021-02-23 00:00:00+00:00         NaN          NaN           NaN   </span>
</span><span id=__span-72-19><a id=__codelineno-72-19 name=__codelineno-72-19 href=#__codelineno-72-19></a><span class=go>2021-02-24 00:00:00+00:00         NaN          NaN           NaN   </span>
</span><span id=__span-72-20><a id=__codelineno-72-20 name=__codelineno-72-20 href=#__codelineno-72-20></a>
</span><span id=__span-72-21><a id=__codelineno-72-21 name=__codelineno-72-21 href=#__codelineno-72-21></a><span class=go>upon_opp_limit_conflict    CancelExecute  </span>
</span><span id=__span-72-22><a id=__codelineno-72-22 name=__codelineno-72-22 href=#__codelineno-72-22></a><span class=go>Open time                                 </span>
</span><span id=__span-72-23><a id=__codelineno-72-23 name=__codelineno-72-23 href=#__codelineno-72-23></a><span class=go>2021-02-18 00:00:00+00:00            NaN  </span>
</span><span id=__span-72-24><a id=__codelineno-72-24 name=__codelineno-72-24 href=#__codelineno-72-24></a><span class=go>2021-02-19 00:00:00+00:00            NaN  </span>
</span><span id=__span-72-25><a id=__codelineno-72-25 name=__codelineno-72-25 href=#__codelineno-72-25></a><span class=go>2021-02-20 00:00:00+00:00            NaN  </span>
</span><span id=__span-72-26><a id=__codelineno-72-26 name=__codelineno-72-26 href=#__codelineno-72-26></a><span class=go>2021-02-21 00:00:00+00:00       53863.93  </span>
</span><span id=__span-72-27><a id=__codelineno-72-27 name=__codelineno-72-27 href=#__codelineno-72-27></a><span class=go>2021-02-22 00:00:00+00:00            NaN  </span>
</span><span id=__span-72-28><a id=__codelineno-72-28 name=__codelineno-72-28 href=#__codelineno-72-28></a><span class=go>2021-02-23 00:00:00+00:00            NaN  </span>
</span><span id=__span-72-29><a id=__codelineno-72-29 name=__codelineno-72-29 href=#__codelineno-72-29></a><span class=go>2021-02-24 00:00:00+00:00            NaN  </span>
</span></code></pre></div> <ol> <li>Get the list of all available options.</li> <li>Only the first order should be a limit order.</li> </ol> <p>As you may have noticed, the first word in the option's name indicates what to do with the pending limit order, and the second word indicates what to do with the user-defined order. By default, the limit order wins when the user-defined signal is in the same direction (buy and buy, or sell and sell; option <code>KeepIgnore</code>) to avoid repeated execution of similar signals. The user-defined signal wins when the two orders are in opposite directions (buy and sell, or sell and buy; option <code>CancelExecute</code>) to account for a change in market regime.</p> <h4 id=delta>Delta<a class=headerlink href=#delta title="Permanent link">&para;</a></h4> <p>The target price of a limit order comes from the <code>price</code> argument. But what if you want to place a limit order at a price a certain distance (also called "delta") above or below another price, such as 10 percent away from the current closing price? For this, you need to know in advance whether the signal is a buy or a sell: if it is a buy order, the price should be below the closing price, and if it is a sell order, the price should be above the closing price. To avoid figuring this out ahead of time and building a price array manually, you can use the <code>limit_delta</code> argument, which specifies how far from <code>price</code> the target limit price should be. This argument's format is controlled by another option, <code>delta_format</code>, of type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.DeltaFormat>DeltaFormat</a>. The default format is a percentage (<code>Percent</code>), so passing <code>limit_delta=0.1</code> is interpreted as 10 percent. Let's try different deltas for a buy limit order on the very first bar:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-73-1><a id=__codelineno-73-1 name=__codelineno-73-1 href=#__codelineno-73-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-73-2><a id=__codelineno-73-2 name=__codelineno-73-2 href=#__codelineno-73-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-73-3><a id=__codelineno-73-3 name=__codelineno-73-3 href=#__codelineno-73-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-73-4><a id=__codelineno-73-4 name=__codelineno-73-4 href=#__codelineno-73-4></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span><span class=p>,</span>
</span><span id=__span-73-5><a id=__codelineno-73-5 name=__codelineno-73-5 href=#__codelineno-73-5></a><span class=gp>... </span>    <span class=n>limit_delta</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>])</span>
</span><span id=__span-73-6><a id=__codelineno-73-6 name=__codelineno-73-6 href=#__codelineno-73-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-73-7><a id=__codelineno-73-7 name=__codelineno-73-7 href=#__codelineno-73-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-73-8><a id=__codelineno-73-8 name=__codelineno-73-8 href=#__codelineno-73-8></a><span class=go>limit_delta                    0.0                0.1               0.5  \</span>
</span><span id=__span-73-9><a id=__codelineno-73-9 name=__codelineno-73-9 href=#__codelineno-73-9></a><span class=go>symbol                     BTCUSDT  ETHUSDT   BTCUSDT   ETHUSDT BTCUSDT   </span>
</span><span id=__span-73-10><a id=__codelineno-73-10 name=__codelineno-73-10 href=#__codelineno-73-10></a><span class=go>Open time                                                                 </span>
</span><span id=__span-73-11><a id=__codelineno-73-11 name=__codelineno-73-11 href=#__codelineno-73-11></a><span class=go>2021-02-18 00:00:00+00:00      NaN      NaN       NaN       NaN     NaN   </span>
</span><span id=__span-73-12><a id=__codelineno-73-12 name=__codelineno-73-12 href=#__codelineno-73-12></a><span class=go>2021-02-19 00:00:00+00:00  51552.6  1938.91       NaN       NaN     NaN   </span>
</span><span id=__span-73-13><a id=__codelineno-73-13 name=__codelineno-73-13 href=#__codelineno-73-13></a><span class=go>2021-02-20 00:00:00+00:00      NaN      NaN       NaN       NaN     NaN   </span>
</span><span id=__span-73-14><a id=__codelineno-73-14 name=__codelineno-73-14 href=#__codelineno-73-14></a><span class=go>2021-02-21 00:00:00+00:00      NaN      NaN       NaN       NaN     NaN   </span>
</span><span id=__span-73-15><a id=__codelineno-73-15 name=__codelineno-73-15 href=#__codelineno-73-15></a><span class=go>2021-02-22 00:00:00+00:00      NaN      NaN       NaN  1745.649     NaN   </span>
</span><span id=__span-73-16><a id=__codelineno-73-16 name=__codelineno-73-16 href=#__codelineno-73-16></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN  46397.34       NaN     NaN   </span>
</span><span id=__span-73-17><a id=__codelineno-73-17 name=__codelineno-73-17 href=#__codelineno-73-17></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN       NaN       NaN     NaN   </span>
</span><span id=__span-73-18><a id=__codelineno-73-18 name=__codelineno-73-18 href=#__codelineno-73-18></a>
</span><span id=__span-73-19><a id=__codelineno-73-19 name=__codelineno-73-19 href=#__codelineno-73-19></a><span class=go>limit_delta                        </span>
</span><span id=__span-73-20><a id=__codelineno-73-20 name=__codelineno-73-20 href=#__codelineno-73-20></a><span class=go>symbol                    ETHUSDT  </span>
</span><span id=__span-73-21><a id=__codelineno-73-21 name=__codelineno-73-21 href=#__codelineno-73-21></a><span class=go>Open time                          </span>
</span><span id=__span-73-22><a id=__codelineno-73-22 name=__codelineno-73-22 href=#__codelineno-73-22></a><span class=go>2021-02-18 00:00:00+00:00     NaN  </span>
</span><span id=__span-73-23><a id=__codelineno-73-23 name=__codelineno-73-23 href=#__codelineno-73-23></a><span class=go>2021-02-19 00:00:00+00:00     NaN  </span>
</span><span id=__span-73-24><a id=__codelineno-73-24 name=__codelineno-73-24 href=#__codelineno-73-24></a><span class=go>2021-02-20 00:00:00+00:00     NaN  </span>
</span><span id=__span-73-25><a id=__codelineno-73-25 name=__codelineno-73-25 href=#__codelineno-73-25></a><span class=go>2021-02-21 00:00:00+00:00     NaN  </span>
</span><span id=__span-73-26><a id=__codelineno-73-26 name=__codelineno-73-26 href=#__codelineno-73-26></a><span class=go>2021-02-22 00:00:00+00:00     NaN  </span>
</span><span id=__span-73-27><a id=__codelineno-73-27 name=__codelineno-73-27 href=#__codelineno-73-27></a><span class=go>2021-02-23 00:00:00+00:00     NaN  </span>
</span><span id=__span-73-28><a id=__codelineno-73-28 name=__codelineno-73-28 href=#__codelineno-73-28></a><span class=go>2021-02-24 00:00:00+00:00     NaN  </span>
</span></code></pre></div> <p>As we can see, without a delta, the target limit price is just the current closing price. With a limit delta of 10 percent, the target limit price becomes <code>close * (1 - limit_delta)</code>, which in this example was only matched after a few bars. The final limit delta of 50 percent was not matched at all, since the selected price window does not include dips of that magnitude. If the limit order were a sell, the calculation would be <code>close * (1 + limit_delta)</code>.</p> <h4 id=reversing>Reversing<a class=headerlink href=#reversing title="Permanent link">&para;</a></h4> <p>So far, we have looked at regular buy/sell limit orders that fill whenever the price reaches or drops below/exceeds the target price. Now, you can reverse the matching logic with the <code>limit_reverse</code> argument to simulate buy/sell <strong>stop</strong> orders. For example, a buy stop order with an absolute delta of $100 searches for a price $100 higher (instead of lower) than the current closing price and executes the limit order at that price:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-74-1><a id=__codelineno-74-1 name=__codelineno-74-1 href=#__codelineno-74-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-74-2><a id=__codelineno-74-2 name=__codelineno-74-2 href=#__codelineno-74-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>),</span>
</span><span id=__span-74-3><a id=__codelineno-74-3 name=__codelineno-74-3 href=#__codelineno-74-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-74-4><a id=__codelineno-74-4 name=__codelineno-74-4 href=#__codelineno-74-4></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span><span class=p>,</span>
</span><span id=__span-74-5><a id=__codelineno-74-5 name=__codelineno-74-5 href=#__codelineno-74-5></a><span class=gp>... </span>    <span class=n>limit_delta</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=mi>5000</span><span class=p>,</span> <span class=mi>10000</span><span class=p>]),</span>
</span><span id=__span-74-6><a id=__codelineno-74-6 name=__codelineno-74-6 href=#__codelineno-74-6></a><span class=gp>... </span>    <span class=n>delta_format</span><span class=o>=</span><span class=s2>&quot;absolute&quot;</span><span class=p>,</span>
</span><span id=__span-74-7><a id=__codelineno-74-7 name=__codelineno-74-7 href=#__codelineno-74-7></a><span class=gp>... </span>    <span class=n>limit_reverse</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-74-8><a id=__codelineno-74-8 name=__codelineno-74-8 href=#__codelineno-74-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-74-9><a id=__codelineno-74-9 name=__codelineno-74-9 href=#__codelineno-74-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-74-10><a id=__codelineno-74-10 name=__codelineno-74-10 href=#__codelineno-74-10></a><span class=go>limit_delta                   0        100      5000   10000</span>
</span><span id=__span-74-11><a id=__codelineno-74-11 name=__codelineno-74-11 href=#__codelineno-74-11></a><span class=go>Open time                                                   </span>
</span><span id=__span-74-12><a id=__codelineno-74-12 name=__codelineno-74-12 href=#__codelineno-74-12></a><span class=go>2021-02-18 00:00:00+00:00       NaN      NaN      NaN    NaN</span>
</span><span id=__span-74-13><a id=__codelineno-74-13 name=__codelineno-74-13 href=#__codelineno-74-13></a><span class=go>2021-02-19 00:00:00+00:00  51552.61  51652.6      NaN    NaN</span>
</span><span id=__span-74-14><a id=__codelineno-74-14 name=__codelineno-74-14 href=#__codelineno-74-14></a><span class=go>2021-02-20 00:00:00+00:00       NaN      NaN  56552.6    NaN</span>
</span><span id=__span-74-15><a id=__codelineno-74-15 name=__codelineno-74-15 href=#__codelineno-74-15></a><span class=go>2021-02-21 00:00:00+00:00       NaN      NaN      NaN    NaN</span>
</span><span id=__span-74-16><a id=__codelineno-74-16 name=__codelineno-74-16 href=#__codelineno-74-16></a><span class=go>2021-02-22 00:00:00+00:00       NaN      NaN      NaN    NaN</span>
</span><span id=__span-74-17><a id=__codelineno-74-17 name=__codelineno-74-17 href=#__codelineno-74-17></a><span class=go>2021-02-23 00:00:00+00:00       NaN      NaN      NaN    NaN</span>
</span><span id=__span-74-18><a id=__codelineno-74-18 name=__codelineno-74-18 href=#__codelineno-74-18></a><span class=go>2021-02-24 00:00:00+00:00       NaN      NaN      NaN    NaN</span>
</span></code></pre></div> <div class="admonition info"> <p class=admonition-title>Info</p> <p>Why does a delta of zero result in a different fill price with and without reversing? When reaching the second bar, the limit price is compared to the opening price. In the first example, the opening price is higher than the limit price, so the limit order is executed using the limit price. In the second example, because the opening price is higher, the limit order is executed using the opening price.</p> </div> <h4 id=adjustment>Adjustment<a class=headerlink href=#adjustment title="Permanent link">&para;</a></h4> <p>In the theoretical section, we discussed how you can modify any limit order from a callback. There are four callbacks you can use: a signal function (<code>signal_func_nb</code>), an adjustment function (<code>adjust_func_nb</code>), a post-signal function (<code>post_signal_func_nb</code>), and a post-segment function (<code>post_segment_func_nb</code>). The signal function is called at the beginning of a bar and should only be used if you need to define the four user-defined signals dynamically. The adjustment function is called at the beginning of the default signal function <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.dir_signal_func_nb>dir_signal_func_nb</a> for direction-unaware and <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.ls_signal_func_nb>ls_signal_func_nb</a> for direction-aware signals, which are provided using boolean arrays (statically). The post-segment function is called at the end of a bar, useful for tasks such as pre-calculating metrics like portfolio returns.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>The adjustment function is called only if the signals are provided statically, meaning <code>signal_func_nb</code> has not been overridden. Also, note that overriding any of the above functions will disable caching of <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a>!</p> </div> <p>Each of these functions accepts a named tuple representing the current simulation context, which includes a one-dimensional record array <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.SignalContext.last_limit_info>SignalContext.last_limit_info</a> with the latest limit order information defined per column. By changing this array, you can modify the limit order that is yet to be processed at this bar (or the next one, for the post-segment function). We will focus on the adjustment function since it is designed to work with signal arrays. This function should be Numba-compiled, take the current context variable (usually named <code>c</code>) and any custom arguments (<code>adjust_args</code>), and return nothing (<code>None</code>). Why nothing? Because all relevant information can be changed directly in the context. Let's create a function that cancels any pending limit order (that is, one that has not been executed at the entry bar). Limit orders will be created using the opening price and a parameterized custom delta:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-75-1><a id=__codelineno-75-1 name=__codelineno-75-1 href=#__codelineno-75-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-75-2><a id=__codelineno-75-2 name=__codelineno-75-2 href=#__codelineno-75-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>adjust_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>  <span class=c1># (1)!</span>
</span><span id=__span-75-3><a id=__codelineno-75-3 name=__codelineno-75-3 href=#__codelineno-75-3></a><span class=gp>... </span>    <span class=n>limit_info</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_limit_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>  <span class=c1># (2)!</span>
</span><span id=__span-75-4><a id=__codelineno-75-4 name=__codelineno-75-4 href=#__codelineno-75-4></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>limit_info</span><span class=o>.</span><span class=n>creation_idx</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>:</span>  <span class=c1># (3)!</span>
</span><span id=__span-75-5><a id=__codelineno-75-5 name=__codelineno-75-5 href=#__codelineno-75-5></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>-</span> <span class=n>limit_info</span><span class=o>.</span><span class=n>creation_idx</span> <span class=o>&gt;=</span> <span class=mi>1</span><span class=p>:</span>  <span class=c1># (4)!</span>
</span><span id=__span-75-6><a id=__codelineno-75-6 name=__codelineno-75-6 href=#__codelineno-75-6></a><span class=gp>... </span>            <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>clear_limit_info_nb</span><span class=p>(</span><span class=n>limit_info</span><span class=p>)</span>  <span class=c1># (5)!</span>
</span><span id=__span-75-7><a id=__codelineno-75-7 name=__codelineno-75-7 href=#__codelineno-75-7></a>
</span><span id=__span-75-8><a id=__codelineno-75-8 name=__codelineno-75-8 href=#__codelineno-75-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-75-9><a id=__codelineno-75-9 name=__codelineno-75-9 href=#__codelineno-75-9></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-75-10><a id=__codelineno-75-10 name=__codelineno-75-10 href=#__codelineno-75-10></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-75-11><a id=__codelineno-75-11 name=__codelineno-75-11 href=#__codelineno-75-11></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=s2>&quot;open&quot;</span><span class=p>,</span>
</span><span id=__span-75-12><a id=__codelineno-75-12 name=__codelineno-75-12 href=#__codelineno-75-12></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span><span class=p>,</span>
</span><span id=__span-75-13><a id=__codelineno-75-13 name=__codelineno-75-13 href=#__codelineno-75-13></a><span class=gp>... </span>    <span class=n>limit_delta</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>]),</span>
</span><span id=__span-75-14><a id=__codelineno-75-14 name=__codelineno-75-14 href=#__codelineno-75-14></a><span class=gp>... </span>    <span class=n>adjust_func_nb</span><span class=o>=</span><span class=n>adjust_func_nb</span>
</span><span id=__span-75-15><a id=__codelineno-75-15 name=__codelineno-75-15 href=#__codelineno-75-15></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-75-16><a id=__codelineno-75-16 name=__codelineno-75-16 href=#__codelineno-75-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-75-17><a id=__codelineno-75-17 name=__codelineno-75-17 href=#__codelineno-75-17></a><span class=go>limit_delta                     0.0             0.1        </span>
</span><span id=__span-75-18><a id=__codelineno-75-18 name=__codelineno-75-18 href=#__codelineno-75-18></a><span class=go>symbol                      BTCUSDT ETHUSDT BTCUSDT ETHUSDT</span>
</span><span id=__span-75-19><a id=__codelineno-75-19 name=__codelineno-75-19 href=#__codelineno-75-19></a><span class=go>Open time                                                  </span>
</span><span id=__span-75-20><a id=__codelineno-75-20 name=__codelineno-75-20 href=#__codelineno-75-20></a><span class=go>2021-02-18 00:00:00+00:00  52117.67  1849.7     NaN     NaN</span>
</span><span id=__span-75-21><a id=__codelineno-75-21 name=__codelineno-75-21 href=#__codelineno-75-21></a><span class=go>2021-02-19 00:00:00+00:00       NaN     NaN     NaN     NaN</span>
</span><span id=__span-75-22><a id=__codelineno-75-22 name=__codelineno-75-22 href=#__codelineno-75-22></a><span class=go>2021-02-20 00:00:00+00:00       NaN     NaN     NaN     NaN</span>
</span><span id=__span-75-23><a id=__codelineno-75-23 name=__codelineno-75-23 href=#__codelineno-75-23></a><span class=go>2021-02-21 00:00:00+00:00       NaN     NaN     NaN     NaN</span>
</span><span id=__span-75-24><a id=__codelineno-75-24 name=__codelineno-75-24 href=#__codelineno-75-24></a><span class=go>2021-02-22 00:00:00+00:00       NaN     NaN     NaN     NaN</span>
</span><span id=__span-75-25><a id=__codelineno-75-25 name=__codelineno-75-25 href=#__codelineno-75-25></a><span class=go>2021-02-23 00:00:00+00:00       NaN     NaN     NaN     NaN</span>
</span><span id=__span-75-26><a id=__codelineno-75-26 name=__codelineno-75-26 href=#__codelineno-75-26></a><span class=go>2021-02-24 00:00:00+00:00       NaN     NaN     NaN     NaN</span>
</span></code></pre></div> <ol> <li>Must take <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.SignalContext>SignalContext</a>.</li> <li>Get the pending limit order information for the current column (asset).</li> <li>Check whether there is a pending limit order.</li> <li>Check whether the order has been pending for one bar or longer.</li> <li>Use <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.clear_limit_info_nb>clear_limit_info_nb</a> to cancel the order.</li> </ol> <p>As we can see, without a delta, each order could be filled already at the entry bar. With a delta of 10 percent, the orders could not be filled at the entry bar and thus were canceled at the beginning of the second bar (February 19). Now, let's do the opposite: if a limit order is still pending, override its price with the valuation price and set the delta to 1 percent so it executes at this bar:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-76-1><a id=__codelineno-76-1 name=__codelineno-76-1 href=#__codelineno-76-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-76-2><a id=__codelineno-76-2 name=__codelineno-76-2 href=#__codelineno-76-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>adjust_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span><span id=__span-76-3><a id=__codelineno-76-3 name=__codelineno-76-3 href=#__codelineno-76-3></a><span class=gp>... </span>    <span class=n>limit_info</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_limit_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-76-4><a id=__codelineno-76-4 name=__codelineno-76-4 href=#__codelineno-76-4></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>limit_info</span><span class=o>.</span><span class=n>creation_idx</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>:</span>
</span><span id=__span-76-5><a id=__codelineno-76-5 name=__codelineno-76-5 href=#__codelineno-76-5></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>-</span> <span class=n>limit_info</span><span class=o>.</span><span class=n>creation_idx</span> <span class=o>&gt;=</span> <span class=mi>1</span><span class=p>:</span>
</span><span id=__span-76-6><a id=__codelineno-76-6 name=__codelineno-76-6 href=#__codelineno-76-6></a><span class=gp>... </span>            <span class=n>limit_info</span><span class=o>.</span><span class=n>init_price</span> <span class=o>=</span> <span class=o>-</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span>  <span class=c1># (1)!</span>
</span><span id=__span-76-7><a id=__codelineno-76-7 name=__codelineno-76-7 href=#__codelineno-76-7></a><span class=gp>... </span>            <span class=n>limit_info</span><span class=o>.</span><span class=n>delta</span> <span class=o>=</span> <span class=mf>0.01</span>
</span><span id=__span-76-8><a id=__codelineno-76-8 name=__codelineno-76-8 href=#__codelineno-76-8></a>
</span><span id=__span-76-9><a id=__codelineno-76-9 name=__codelineno-76-9 href=#__codelineno-76-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-76-10><a id=__codelineno-76-10 name=__codelineno-76-10 href=#__codelineno-76-10></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-76-11><a id=__codelineno-76-11 name=__codelineno-76-11 href=#__codelineno-76-11></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-76-12><a id=__codelineno-76-12 name=__codelineno-76-12 href=#__codelineno-76-12></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=s2>&quot;open&quot;</span><span class=p>,</span>
</span><span id=__span-76-13><a id=__codelineno-76-13 name=__codelineno-76-13 href=#__codelineno-76-13></a><span class=gp>... </span>    <span class=n>order_type</span><span class=o>=</span><span class=s2>&quot;limit&quot;</span><span class=p>,</span>
</span><span id=__span-76-14><a id=__codelineno-76-14 name=__codelineno-76-14 href=#__codelineno-76-14></a><span class=gp>... </span>    <span class=n>limit_delta</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>]),</span>
</span><span id=__span-76-15><a id=__codelineno-76-15 name=__codelineno-76-15 href=#__codelineno-76-15></a><span class=gp>... </span>    <span class=n>adjust_func_nb</span><span class=o>=</span><span class=n>adjust_func_nb</span>
</span><span id=__span-76-16><a id=__codelineno-76-16 name=__codelineno-76-16 href=#__codelineno-76-16></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-76-17><a id=__codelineno-76-17 name=__codelineno-76-17 href=#__codelineno-76-17></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-76-18><a id=__codelineno-76-18 name=__codelineno-76-18 href=#__codelineno-76-18></a><span class=go>limit_delta                       0.1                    0.2           </span>
</span><span id=__span-76-19><a id=__codelineno-76-19 name=__codelineno-76-19 href=#__codelineno-76-19></a><span class=go>symbol                        BTCUSDT    ETHUSDT     BTCUSDT    ETHUSDT</span>
</span><span id=__span-76-20><a id=__codelineno-76-20 name=__codelineno-76-20 href=#__codelineno-76-20></a><span class=go>Open time                                                              </span>
</span><span id=__span-76-21><a id=__codelineno-76-21 name=__codelineno-76-21 href=#__codelineno-76-21></a><span class=go>2021-02-18 00:00:00+00:00         NaN        NaN         NaN        NaN</span>
</span><span id=__span-76-22><a id=__codelineno-76-22 name=__codelineno-76-22 href=#__codelineno-76-22></a><span class=go>2021-02-19 00:00:00+00:00  51037.0839  1919.5209  51037.0839  1919.5209</span>
</span><span id=__span-76-23><a id=__codelineno-76-23 name=__codelineno-76-23 href=#__codelineno-76-23></a><span class=go>2021-02-20 00:00:00+00:00         NaN        NaN         NaN        NaN</span>
</span><span id=__span-76-24><a id=__codelineno-76-24 name=__codelineno-76-24 href=#__codelineno-76-24></a><span class=go>2021-02-21 00:00:00+00:00         NaN        NaN         NaN        NaN</span>
</span><span id=__span-76-25><a id=__codelineno-76-25 name=__codelineno-76-25 href=#__codelineno-76-25></a><span class=go>2021-02-22 00:00:00+00:00         NaN        NaN         NaN        NaN</span>
</span><span id=__span-76-26><a id=__codelineno-76-26 name=__codelineno-76-26 href=#__codelineno-76-26></a><span class=go>2021-02-23 00:00:00+00:00         NaN        NaN         NaN        NaN</span>
</span><span id=__span-76-27><a id=__codelineno-76-27 name=__codelineno-76-27 href=#__codelineno-76-27></a><span class=go>2021-02-24 00:00:00+00:00         NaN        NaN         NaN        NaN</span>
</span></code></pre></div> <ol> <li>Negative infinity will be translated into the valuation price, which is the latest known price at the time the callback is called: the opening price for adjustment and signal callbacks, and the closing price for post-segment callbacks. Note that you cannot use positive infinity for the closing price because it is unknown!</li> </ol> <p>Just as we canceled an order, we can also create a new order without the need for user-defined signalsâ€”essentially, out of nothing!</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-77-1><a id=__codelineno-77-1 name=__codelineno-77-1 href=#__codelineno-77-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-77-2><a id=__codelineno-77-2 name=__codelineno-77-2 href=#__codelineno-77-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>adjust_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>custom_delta</span><span class=p>):</span>
</span><span id=__span-77-3><a id=__codelineno-77-3 name=__codelineno-77-3 href=#__codelineno-77-3></a><span class=gp>... </span>    <span class=n>limit_info</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_limit_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-77-4><a id=__codelineno-77-4 name=__codelineno-77-4 href=#__codelineno-77-4></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>  <span class=c1># (1)!</span>
</span><span id=__span-77-5><a id=__codelineno-77-5 name=__codelineno-77-5 href=#__codelineno-77-5></a><span class=gp>... </span>        <span class=n>curr_delta</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>custom_delta</span><span class=p>)</span>
</span><span id=__span-77-6><a id=__codelineno-77-6 name=__codelineno-77-6 href=#__codelineno-77-6></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>set_limit_info_nb</span><span class=p>(</span><span class=n>limit_info</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>delta</span><span class=o>=</span><span class=n>curr_delta</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-77-7><a id=__codelineno-77-7 name=__codelineno-77-7 href=#__codelineno-77-7></a>
</span><span id=__span-77-8><a id=__codelineno-77-8 name=__codelineno-77-8 href=#__codelineno-77-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-77-9><a id=__codelineno-77-9 name=__codelineno-77-9 href=#__codelineno-77-9></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-77-10><a id=__codelineno-77-10 name=__codelineno-77-10 href=#__codelineno-77-10></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>custom_delta</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>])),</span>  <span class=c1># (3)!</span>
</span><span id=__span-77-11><a id=__codelineno-77-11 name=__codelineno-77-11 href=#__codelineno-77-11></a><span class=gp>... </span>    <span class=n>adjust_func_nb</span><span class=o>=</span><span class=n>adjust_func_nb</span><span class=p>,</span>
</span><span id=__span-77-12><a id=__codelineno-77-12 name=__codelineno-77-12 href=#__codelineno-77-12></a><span class=gp>... </span>    <span class=n>adjust_args</span><span class=o>=</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;custom_delta&quot;</span><span class=p>),)</span>  <span class=c1># (4)!</span>
</span><span id=__span-77-13><a id=__codelineno-77-13 name=__codelineno-77-13 href=#__codelineno-77-13></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-77-14><a id=__codelineno-77-14 name=__codelineno-77-14 href=#__codelineno-77-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-77-15><a id=__codelineno-77-15 name=__codelineno-77-15 href=#__codelineno-77-15></a><span class=go>custom_delta                    0.0                0.1         </span>
</span><span id=__span-77-16><a id=__codelineno-77-16 name=__codelineno-77-16 href=#__codelineno-77-16></a><span class=go>symbol                      BTCUSDT ETHUSDT    BTCUSDT  ETHUSDT</span>
</span><span id=__span-77-17><a id=__codelineno-77-17 name=__codelineno-77-17 href=#__codelineno-77-17></a><span class=go>Open time                                                      </span>
</span><span id=__span-77-18><a id=__codelineno-77-18 name=__codelineno-77-18 href=#__codelineno-77-18></a><span class=go>2021-02-18 00:00:00+00:00  52117.67  1849.7        NaN      NaN</span>
</span><span id=__span-77-19><a id=__codelineno-77-19 name=__codelineno-77-19 href=#__codelineno-77-19></a><span class=go>2021-02-19 00:00:00+00:00       NaN     NaN        NaN      NaN</span>
</span><span id=__span-77-20><a id=__codelineno-77-20 name=__codelineno-77-20 href=#__codelineno-77-20></a><span class=go>2021-02-20 00:00:00+00:00       NaN     NaN        NaN      NaN</span>
</span><span id=__span-77-21><a id=__codelineno-77-21 name=__codelineno-77-21 href=#__codelineno-77-21></a><span class=go>2021-02-21 00:00:00+00:00       NaN     NaN        NaN      NaN</span>
</span><span id=__span-77-22><a id=__codelineno-77-22 name=__codelineno-77-22 href=#__codelineno-77-22></a><span class=go>2021-02-22 00:00:00+00:00       NaN     NaN        NaN  1664.73</span>
</span><span id=__span-77-23><a id=__codelineno-77-23 name=__codelineno-77-23 href=#__codelineno-77-23></a><span class=go>2021-02-23 00:00:00+00:00       NaN     NaN  46905.903      NaN</span>
</span><span id=__span-77-24><a id=__codelineno-77-24 name=__codelineno-77-24 href=#__codelineno-77-24></a><span class=go>2021-02-24 00:00:00+00:00       NaN     NaN        NaN      NaN</span>
</span></code></pre></div> <ol> <li>Create a signal order only at the very first bar.</li> <li>Use <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.set_limit_info_nb>set_limit_info_nb</a>. Check its signature to learn more about the default values. For example, it uses the current valuation price, infinite size, and both directions by default.</li> <li>To make a custom argument parameterizable, define it as a flexible argument in <code>broadcast_named_args</code>. This means it should be set up to be specified per element.</li> <li>Remember to put a comma after a single element in a tuple.</li> </ol> <p>We just created limit orders dynamically, without any signals <img alt=âœ¨ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2728.svg title=:sparkles:></p> <h3 id=stop-orders>Stop orders<a class=headerlink href=#stop-orders title="Permanent link">&para;</a></h3> <p>Like limit orders, stop orders are executed only when a price condition is met. Their information is also stored per column inside a one-dimensional record array. However, unlike limit orders, stop orders are deferred user-defined signals that result in a market or limit order, mainly to close out an existing position. They are created after a successful entry order that either opens, increases, or reverses a position (that is, closes out and then opens a new position in the opposite direction). There are three types of stop orders: <abbr title="Stop loss">SL</abbr> (<code>sl_stop</code>), <abbr title="Trailing stop loss">TSL</abbr> and <abbr title="Trailing take profit">TTP</abbr> (<code>tsl_stop</code> and <code>tsl_th</code>, which act as a single order), and <abbr title="Take profit">TP</abbr> (<code>tp_stop</code>). Each type is stored and tracked separately, but all operate as a one-cancels-all (OCA) order, meaning that triggering one order fully cancels the others automatically. Any pending stop orders will also be canceled if the entered position is closed out by other means.</p> <p>Let's place a stop loss order at 10%:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-78-1><a id=__codelineno-78-1 name=__codelineno-78-1 href=#__codelineno-78-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-78-2><a id=__codelineno-78-2 name=__codelineno-78-2 href=#__codelineno-78-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-78-3><a id=__codelineno-78-3 name=__codelineno-78-3 href=#__codelineno-78-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-78-4><a id=__codelineno-78-4 name=__codelineno-78-4 href=#__codelineno-78-4></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
</span><span id=__span-78-5><a id=__codelineno-78-5 name=__codelineno-78-5 href=#__codelineno-78-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-78-6><a id=__codelineno-78-6 name=__codelineno-78-6 href=#__codelineno-78-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-78-7><a id=__codelineno-78-7 name=__codelineno-78-7 href=#__codelineno-78-7></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-78-8><a id=__codelineno-78-8 name=__codelineno-78-8 href=#__codelineno-78-8></a><span class=go>Open time                                    </span>
</span><span id=__span-78-9><a id=__codelineno-78-9 name=__codelineno-78-9 href=#__codelineno-78-9></a><span class=go>2021-02-18 00:00:00+00:00  51552.60  1939.610</span>
</span><span id=__span-78-10><a id=__codelineno-78-10 name=__codelineno-78-10 href=#__codelineno-78-10></a><span class=go>2021-02-19 00:00:00+00:00       NaN       NaN</span>
</span><span id=__span-78-11><a id=__codelineno-78-11 name=__codelineno-78-11 href=#__codelineno-78-11></a><span class=go>2021-02-20 00:00:00+00:00       NaN       NaN</span>
</span><span id=__span-78-12><a id=__codelineno-78-12 name=__codelineno-78-12 href=#__codelineno-78-12></a><span class=go>2021-02-21 00:00:00+00:00       NaN       NaN</span>
</span><span id=__span-78-13><a id=__codelineno-78-13 name=__codelineno-78-13 href=#__codelineno-78-13></a><span class=go>2021-02-22 00:00:00+00:00       NaN  1745.649</span>
</span><span id=__span-78-14><a id=__codelineno-78-14 name=__codelineno-78-14 href=#__codelineno-78-14></a><span class=go>2021-02-23 00:00:00+00:00  46397.34       NaN</span>
</span><span id=__span-78-15><a id=__codelineno-78-15 name=__codelineno-78-15 href=#__codelineno-78-15></a><span class=go>2021-02-24 00:00:00+00:00       NaN       NaN</span>
</span></code></pre></div> <div class="admonition important"> <p class=admonition-title>Important</p> <p>When passing an instance of <a href=https://vectorbt.pro/pvt_41531c19/api/data/base/#vectorbtpro.data.base.Data>Data</a> as the first argument (as shown with <code>sub_data</code>), the method will automatically extract OHLC from it. If you pass the closing price as the first argument instead, make sure to also provide the other price features (OHL) using the <code>open</code>, <code>high</code>, and <code>low</code> arguments. Without them, candles will be incomplete and VBT will make decisions based only on <code>close</code>!</p> </div> <p>We can see that the entered long position was exited at the price <code>51552.60 * 0.9 = 46397.34</code>. To test multiple stop values, we can wrap them with the <a href=https://vectorbt.pro/pvt_41531c19/api/utils/params/#vectorbtpro.utils.params.Param>Param</a> class:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-79-1><a id=__codelineno-79-1 name=__codelineno-79-1 href=#__codelineno-79-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-79-2><a id=__codelineno-79-2 name=__codelineno-79-2 href=#__codelineno-79-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-79-3><a id=__codelineno-79-3 name=__codelineno-79-3 href=#__codelineno-79-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-79-4><a id=__codelineno-79-4 name=__codelineno-79-4 href=#__codelineno-79-4></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>]),</span>  <span class=c1># (1)!</span>
</span><span id=__span-79-5><a id=__codelineno-79-5 name=__codelineno-79-5 href=#__codelineno-79-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-79-6><a id=__codelineno-79-6 name=__codelineno-79-6 href=#__codelineno-79-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-79-7><a id=__codelineno-79-7 name=__codelineno-79-7 href=#__codelineno-79-7></a><span class=go>sl_stop                        NaN                0.1                0.2  \</span>
</span><span id=__span-79-8><a id=__codelineno-79-8 name=__codelineno-79-8 href=#__codelineno-79-8></a><span class=go>symbol                     BTCUSDT  ETHUSDT   BTCUSDT   ETHUSDT  BTCUSDT   </span>
</span><span id=__span-79-9><a id=__codelineno-79-9 name=__codelineno-79-9 href=#__codelineno-79-9></a><span class=go>Open time                                                                  </span>
</span><span id=__span-79-10><a id=__codelineno-79-10 name=__codelineno-79-10 href=#__codelineno-79-10></a><span class=go>2021-02-18 00:00:00+00:00  51552.6  1939.61  51552.60  1939.610  51552.6   </span>
</span><span id=__span-79-11><a id=__codelineno-79-11 name=__codelineno-79-11 href=#__codelineno-79-11></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN       NaN       NaN      NaN   </span>
</span><span id=__span-79-12><a id=__codelineno-79-12 name=__codelineno-79-12 href=#__codelineno-79-12></a><span class=go>2021-02-20 00:00:00+00:00      NaN      NaN       NaN       NaN      NaN   </span>
</span><span id=__span-79-13><a id=__codelineno-79-13 name=__codelineno-79-13 href=#__codelineno-79-13></a><span class=go>2021-02-21 00:00:00+00:00      NaN      NaN       NaN       NaN      NaN   </span>
</span><span id=__span-79-14><a id=__codelineno-79-14 name=__codelineno-79-14 href=#__codelineno-79-14></a><span class=go>2021-02-22 00:00:00+00:00      NaN      NaN       NaN  1745.649      NaN   </span>
</span><span id=__span-79-15><a id=__codelineno-79-15 name=__codelineno-79-15 href=#__codelineno-79-15></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN  46397.34       NaN      NaN   </span>
</span><span id=__span-79-16><a id=__codelineno-79-16 name=__codelineno-79-16 href=#__codelineno-79-16></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN       NaN       NaN      NaN   </span>
</span><span id=__span-79-17><a id=__codelineno-79-17 name=__codelineno-79-17 href=#__codelineno-79-17></a>
</span><span id=__span-79-18><a id=__codelineno-79-18 name=__codelineno-79-18 href=#__codelineno-79-18></a><span class=go>sl_stop                              </span>
</span><span id=__span-79-19><a id=__codelineno-79-19 name=__codelineno-79-19 href=#__codelineno-79-19></a><span class=go>symbol                      ETHUSDT  </span>
</span><span id=__span-79-20><a id=__codelineno-79-20 name=__codelineno-79-20 href=#__codelineno-79-20></a><span class=go>Open time                            </span>
</span><span id=__span-79-21><a id=__codelineno-79-21 name=__codelineno-79-21 href=#__codelineno-79-21></a><span class=go>2021-02-18 00:00:00+00:00  1939.610  </span>
</span><span id=__span-79-22><a id=__codelineno-79-22 name=__codelineno-79-22 href=#__codelineno-79-22></a><span class=go>2021-02-19 00:00:00+00:00       NaN  </span>
</span><span id=__span-79-23><a id=__codelineno-79-23 name=__codelineno-79-23 href=#__codelineno-79-23></a><span class=go>2021-02-20 00:00:00+00:00       NaN  </span>
</span><span id=__span-79-24><a id=__codelineno-79-24 name=__codelineno-79-24 href=#__codelineno-79-24></a><span class=go>2021-02-21 00:00:00+00:00       NaN  </span>
</span><span id=__span-79-25><a id=__codelineno-79-25 name=__codelineno-79-25 href=#__codelineno-79-25></a><span class=go>2021-02-22 00:00:00+00:00  1551.688  </span>
</span><span id=__span-79-26><a id=__codelineno-79-26 name=__codelineno-79-26 href=#__codelineno-79-26></a><span class=go>2021-02-23 00:00:00+00:00       NaN  </span>
</span><span id=__span-79-27><a id=__codelineno-79-27 name=__codelineno-79-27 href=#__codelineno-79-27></a><span class=go>2021-02-24 00:00:00+00:00       NaN  </span>
</span></code></pre></div> <ol> <li>NaN means no stop order.</li> </ol> <p>Since each stop argument and its accompanying information broadcast together with the data, we can provide them as fully-fledged arrays. Below, we define a stop loss based on the ATR:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-80-1><a id=__codelineno-80-1 name=__codelineno-80-1 href=#__codelineno-80-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>atr</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=s2>&quot;atr&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>atr</span>
</span><span id=__span-80-2><a id=__codelineno-80-2 name=__codelineno-80-2 href=#__codelineno-80-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sub_atr</span> <span class=o>=</span> <span class=n>atr</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=s2>&quot;2021-02-18&quot;</span><span class=p>:</span><span class=s2>&quot;2021-02-24&quot;</span><span class=p>]</span>
</span><span id=__span-80-3><a id=__codelineno-80-3 name=__codelineno-80-3 href=#__codelineno-80-3></a>
</span><span id=__span-80-4><a id=__codelineno-80-4 name=__codelineno-80-4 href=#__codelineno-80-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-80-5><a id=__codelineno-80-5 name=__codelineno-80-5 href=#__codelineno-80-5></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-80-6><a id=__codelineno-80-6 name=__codelineno-80-6 href=#__codelineno-80-6></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-80-7><a id=__codelineno-80-7 name=__codelineno-80-7 href=#__codelineno-80-7></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=n>sub_atr</span> <span class=o>/</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>close</span>
</span><span id=__span-80-8><a id=__codelineno-80-8 name=__codelineno-80-8 href=#__codelineno-80-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-80-9><a id=__codelineno-80-9 name=__codelineno-80-9 href=#__codelineno-80-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-80-10><a id=__codelineno-80-10 name=__codelineno-80-10 href=#__codelineno-80-10></a><span class=go>symbol                          BTCUSDT      ETHUSDT</span>
</span><span id=__span-80-11><a id=__codelineno-80-11 name=__codelineno-80-11 href=#__codelineno-80-11></a><span class=go>Open time                                           </span>
</span><span id=__span-80-12><a id=__codelineno-80-12 name=__codelineno-80-12 href=#__codelineno-80-12></a><span class=go>2021-02-18 00:00:00+00:00  51552.600000  1939.610000</span>
</span><span id=__span-80-13><a id=__codelineno-80-13 name=__codelineno-80-13 href=#__codelineno-80-13></a><span class=go>2021-02-19 00:00:00+00:00           NaN          NaN</span>
</span><span id=__span-80-14><a id=__codelineno-80-14 name=__codelineno-80-14 href=#__codelineno-80-14></a><span class=go>2021-02-20 00:00:00+00:00           NaN  1805.283249</span>
</span><span id=__span-80-15><a id=__codelineno-80-15 name=__codelineno-80-15 href=#__codelineno-80-15></a><span class=go>2021-02-21 00:00:00+00:00           NaN          NaN</span>
</span><span id=__span-80-16><a id=__codelineno-80-16 name=__codelineno-80-16 href=#__codelineno-80-16></a><span class=go>2021-02-22 00:00:00+00:00  48335.716826          NaN</span>
</span><span id=__span-80-17><a id=__codelineno-80-17 name=__codelineno-80-17 href=#__codelineno-80-17></a><span class=go>2021-02-23 00:00:00+00:00           NaN          NaN</span>
</span><span id=__span-80-18><a id=__codelineno-80-18 name=__codelineno-80-18 href=#__codelineno-80-18></a><span class=go>2021-02-24 00:00:00+00:00           NaN          NaN</span>
</span></code></pre></div> <p>What about absolute stop values? They can be specified just like for limit orders:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-81-1><a id=__codelineno-81-1 name=__codelineno-81-1 href=#__codelineno-81-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-81-2><a id=__codelineno-81-2 name=__codelineno-81-2 href=#__codelineno-81-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>),</span>
</span><span id=__span-81-3><a id=__codelineno-81-3 name=__codelineno-81-3 href=#__codelineno-81-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-81-4><a id=__codelineno-81-4 name=__codelineno-81-4 href=#__codelineno-81-4></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>
</span><span id=__span-81-5><a id=__codelineno-81-5 name=__codelineno-81-5 href=#__codelineno-81-5></a><span class=gp>... </span>    <span class=n>delta_format</span><span class=o>=</span><span class=s2>&quot;absolute&quot;</span>
</span><span id=__span-81-6><a id=__codelineno-81-6 name=__codelineno-81-6 href=#__codelineno-81-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-81-7><a id=__codelineno-81-7 name=__codelineno-81-7 href=#__codelineno-81-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-81-8><a id=__codelineno-81-8 name=__codelineno-81-8 href=#__codelineno-81-8></a><span class=go>Open time</span>
</span><span id=__span-81-9><a id=__codelineno-81-9 name=__codelineno-81-9 href=#__codelineno-81-9></a><span class=go>2021-02-18 00:00:00+00:00    51552.6</span>
</span><span id=__span-81-10><a id=__codelineno-81-10 name=__codelineno-81-10 href=#__codelineno-81-10></a><span class=go>2021-02-19 00:00:00+00:00    51452.6</span>
</span><span id=__span-81-11><a id=__codelineno-81-11 name=__codelineno-81-11 href=#__codelineno-81-11></a><span class=go>2021-02-20 00:00:00+00:00        NaN</span>
</span><span id=__span-81-12><a id=__codelineno-81-12 name=__codelineno-81-12 href=#__codelineno-81-12></a><span class=go>2021-02-21 00:00:00+00:00        NaN</span>
</span><span id=__span-81-13><a id=__codelineno-81-13 name=__codelineno-81-13 href=#__codelineno-81-13></a><span class=go>2021-02-22 00:00:00+00:00        NaN</span>
</span><span id=__span-81-14><a id=__codelineno-81-14 name=__codelineno-81-14 href=#__codelineno-81-14></a><span class=go>2021-02-23 00:00:00+00:00        NaN</span>
</span><span id=__span-81-15><a id=__codelineno-81-15 name=__codelineno-81-15 href=#__codelineno-81-15></a><span class=go>2021-02-24 00:00:00+00:00        NaN</span>
</span><span id=__span-81-16><a id=__codelineno-81-16 name=__codelineno-81-16 href=#__codelineno-81-16></a><span class=go>Freq: D, dtype: float64</span>
</span></code></pre></div> <p>You can also provide a target stop price directly:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-82-1><a id=__codelineno-82-1 name=__codelineno-82-1 href=#__codelineno-82-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-82-2><a id=__codelineno-82-2 name=__codelineno-82-2 href=#__codelineno-82-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>),</span>
</span><span id=__span-82-3><a id=__codelineno-82-3 name=__codelineno-82-3 href=#__codelineno-82-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-82-4><a id=__codelineno-82-4 name=__codelineno-82-4 href=#__codelineno-82-4></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=mf>51452.6</span><span class=p>,</span>
</span><span id=__span-82-5><a id=__codelineno-82-5 name=__codelineno-82-5 href=#__codelineno-82-5></a><span class=gp>... </span>    <span class=n>delta_format</span><span class=o>=</span><span class=s2>&quot;target&quot;</span>
</span><span id=__span-82-6><a id=__codelineno-82-6 name=__codelineno-82-6 href=#__codelineno-82-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-82-7><a id=__codelineno-82-7 name=__codelineno-82-7 href=#__codelineno-82-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-82-8><a id=__codelineno-82-8 name=__codelineno-82-8 href=#__codelineno-82-8></a><span class=go>Open time</span>
</span><span id=__span-82-9><a id=__codelineno-82-9 name=__codelineno-82-9 href=#__codelineno-82-9></a><span class=go>2021-02-18 00:00:00+00:00    51552.6</span>
</span><span id=__span-82-10><a id=__codelineno-82-10 name=__codelineno-82-10 href=#__codelineno-82-10></a><span class=go>2021-02-19 00:00:00+00:00    51452.6</span>
</span><span id=__span-82-11><a id=__codelineno-82-11 name=__codelineno-82-11 href=#__codelineno-82-11></a><span class=go>2021-02-20 00:00:00+00:00        NaN</span>
</span><span id=__span-82-12><a id=__codelineno-82-12 name=__codelineno-82-12 href=#__codelineno-82-12></a><span class=go>2021-02-21 00:00:00+00:00        NaN</span>
</span><span id=__span-82-13><a id=__codelineno-82-13 name=__codelineno-82-13 href=#__codelineno-82-13></a><span class=go>2021-02-22 00:00:00+00:00        NaN</span>
</span><span id=__span-82-14><a id=__codelineno-82-14 name=__codelineno-82-14 href=#__codelineno-82-14></a><span class=go>2021-02-23 00:00:00+00:00        NaN</span>
</span><span id=__span-82-15><a id=__codelineno-82-15 name=__codelineno-82-15 href=#__codelineno-82-15></a><span class=go>2021-02-24 00:00:00+00:00        NaN</span>
</span><span id=__span-82-16><a id=__codelineno-82-16 name=__codelineno-82-16 href=#__codelineno-82-16></a><span class=go>Freq: D, dtype: float64</span>
</span></code></pre></div> <p>Since the simulator can track multiple stop types at the same time, we can simulate a specific risk-to-reward (R/R) ratio by setting both a stop loss and a take profit. For example, let's simulate a risk-to-reward ratio of 1/2 based on the ATR:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-83-1><a id=__codelineno-83-1 name=__codelineno-83-1 href=#__codelineno-83-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-83-2><a id=__codelineno-83-2 name=__codelineno-83-2 href=#__codelineno-83-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-83-3><a id=__codelineno-83-3 name=__codelineno-83-3 href=#__codelineno-83-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-83-4><a id=__codelineno-83-4 name=__codelineno-83-4 href=#__codelineno-83-4></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=mi>1</span> <span class=o>*</span> <span class=n>sub_atr</span> <span class=o>/</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>close</span><span class=p>,</span>
</span><span id=__span-83-5><a id=__codelineno-83-5 name=__codelineno-83-5 href=#__codelineno-83-5></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=mi>2</span> <span class=o>*</span> <span class=n>sub_atr</span> <span class=o>/</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>close</span>
</span><span id=__span-83-6><a id=__codelineno-83-6 name=__codelineno-83-6 href=#__codelineno-83-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-83-7><a id=__codelineno-83-7 name=__codelineno-83-7 href=#__codelineno-83-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-83-8><a id=__codelineno-83-8 name=__codelineno-83-8 href=#__codelineno-83-8></a><span class=go>symbol                          BTCUSDT      ETHUSDT</span>
</span><span id=__span-83-9><a id=__codelineno-83-9 name=__codelineno-83-9 href=#__codelineno-83-9></a><span class=go>Open time                                           </span>
</span><span id=__span-83-10><a id=__codelineno-83-10 name=__codelineno-83-10 href=#__codelineno-83-10></a><span class=go>2021-02-18 00:00:00+00:00  51552.600000  1939.610000</span>
</span><span id=__span-83-11><a id=__codelineno-83-11 name=__codelineno-83-11 href=#__codelineno-83-11></a><span class=go>2021-02-19 00:00:00+00:00           NaN          NaN</span>
</span><span id=__span-83-12><a id=__codelineno-83-12 name=__codelineno-83-12 href=#__codelineno-83-12></a><span class=go>2021-02-20 00:00:00+00:00           NaN  1805.283249</span>
</span><span id=__span-83-13><a id=__codelineno-83-13 name=__codelineno-83-13 href=#__codelineno-83-13></a><span class=go>2021-02-21 00:00:00+00:00  57986.366348          NaN</span>
</span><span id=__span-83-14><a id=__codelineno-83-14 name=__codelineno-83-14 href=#__codelineno-83-14></a><span class=go>2021-02-22 00:00:00+00:00           NaN          NaN</span>
</span><span id=__span-83-15><a id=__codelineno-83-15 name=__codelineno-83-15 href=#__codelineno-83-15></a><span class=go>2021-02-23 00:00:00+00:00           NaN          NaN</span>
</span><span id=__span-83-16><a id=__codelineno-83-16 name=__codelineno-83-16 href=#__codelineno-83-16></a><span class=go>2021-02-24 00:00:00+00:00           NaN          NaN</span>
</span></code></pre></div> <p>The <abbr title="Take profit">TP</abbr> order won in the first column, while the <abbr title="Stop loss">SL</abbr> order won in the second column. Is there a way to see the order type, and ideally, the date of the signal that initiated it? Absolutely, VBT can handle all of your wishes! <img alt=ðŸ§ž class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f9de.svg title=:genie:></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-84-1><a id=__codelineno-84-1 name=__codelineno-84-1 href=#__codelineno-84-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>readable</span>  <span class=c1># (1)!</span>
</span><span id=__span-84-2><a id=__codelineno-84-2 name=__codelineno-84-2 href=#__codelineno-84-2></a><span class=go>   Order Id   Column              Signal Index            Creation Index  \</span>
</span><span id=__span-84-3><a id=__codelineno-84-3 name=__codelineno-84-3 href=#__codelineno-84-3></a><span class=go>0         0  BTCUSDT 2021-02-18 00:00:00+00:00 2021-02-18 00:00:00+00:00   </span>
</span><span id=__span-84-4><a id=__codelineno-84-4 name=__codelineno-84-4 href=#__codelineno-84-4></a><span class=go>1         1  BTCUSDT 2021-02-18 00:00:00+00:00 2021-02-21 00:00:00+00:00   </span>
</span><span id=__span-84-5><a id=__codelineno-84-5 name=__codelineno-84-5 href=#__codelineno-84-5></a><span class=go>2         0  ETHUSDT 2021-02-18 00:00:00+00:00 2021-02-18 00:00:00+00:00   </span>
</span><span id=__span-84-6><a id=__codelineno-84-6 name=__codelineno-84-6 href=#__codelineno-84-6></a><span class=go>3         1  ETHUSDT 2021-02-18 00:00:00+00:00 2021-02-20 00:00:00+00:00   </span>
</span><span id=__span-84-7><a id=__codelineno-84-7 name=__codelineno-84-7 href=#__codelineno-84-7></a>
</span><span id=__span-84-8><a id=__codelineno-84-8 name=__codelineno-84-8 href=#__codelineno-84-8></a><span class=go>                 Fill Index      Size         Price  Fees  Side    Type  \</span>
</span><span id=__span-84-9><a id=__codelineno-84-9 name=__codelineno-84-9 href=#__codelineno-84-9></a><span class=go>0 2021-02-18 00:00:00+00:00  0.001940  51552.600000   0.0   Buy  Market   </span>
</span><span id=__span-84-10><a id=__codelineno-84-10 name=__codelineno-84-10 href=#__codelineno-84-10></a><span class=go>1 2021-02-21 00:00:00+00:00  0.001940  57986.366348   0.0  Sell  Market   </span>
</span><span id=__span-84-11><a id=__codelineno-84-11 name=__codelineno-84-11 href=#__codelineno-84-11></a><span class=go>2 2021-02-18 00:00:00+00:00  0.051557   1939.610000   0.0   Buy  Market   </span>
</span><span id=__span-84-12><a id=__codelineno-84-12 name=__codelineno-84-12 href=#__codelineno-84-12></a><span class=go>3 2021-02-20 00:00:00+00:00  0.051557   1805.283249   0.0  Sell  Market   </span>
</span><span id=__span-84-13><a id=__codelineno-84-13 name=__codelineno-84-13 href=#__codelineno-84-13></a>
</span><span id=__span-84-14><a id=__codelineno-84-14 name=__codelineno-84-14 href=#__codelineno-84-14></a><span class=go>  Stop Type  </span>
</span><span id=__span-84-15><a id=__codelineno-84-15 name=__codelineno-84-15 href=#__codelineno-84-15></a><span class=go>0      None  </span>
</span><span id=__span-84-16><a id=__codelineno-84-16 name=__codelineno-84-16 href=#__codelineno-84-16></a><span class=go>1        TP  </span>
</span><span id=__span-84-17><a id=__codelineno-84-17 name=__codelineno-84-17 href=#__codelineno-84-17></a><span class=go>2      None  </span>
</span><span id=__span-84-18><a id=__codelineno-84-18 name=__codelineno-84-18 href=#__codelineno-84-18></a><span class=go>3        SL  </span>
</span><span id=__span-84-19><a id=__codelineno-84-19 name=__codelineno-84-19 href=#__codelineno-84-19></a>
</span><span id=__span-84-20><a id=__codelineno-84-20 name=__codelineno-84-20 href=#__codelineno-84-20></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>stop_type</span><span class=o>.</span><span class=n>to_pd</span><span class=p>(</span><span class=n>mapping</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-84-21><a id=__codelineno-84-21 name=__codelineno-84-21 href=#__codelineno-84-21></a><span class=go>symbol                    BTCUSDT ETHUSDT</span>
</span><span id=__span-84-22><a id=__codelineno-84-22 name=__codelineno-84-22 href=#__codelineno-84-22></a><span class=go>Open time                                </span>
</span><span id=__span-84-23><a id=__codelineno-84-23 name=__codelineno-84-23 href=#__codelineno-84-23></a><span class=go>2021-02-18 00:00:00+00:00    None    None</span>
</span><span id=__span-84-24><a id=__codelineno-84-24 name=__codelineno-84-24 href=#__codelineno-84-24></a><span class=go>2021-02-19 00:00:00+00:00    None    None</span>
</span><span id=__span-84-25><a id=__codelineno-84-25 name=__codelineno-84-25 href=#__codelineno-84-25></a><span class=go>2021-02-20 00:00:00+00:00    None      SL</span>
</span><span id=__span-84-26><a id=__codelineno-84-26 name=__codelineno-84-26 href=#__codelineno-84-26></a><span class=go>2021-02-21 00:00:00+00:00      TP    None</span>
</span><span id=__span-84-27><a id=__codelineno-84-27 name=__codelineno-84-27 href=#__codelineno-84-27></a><span class=go>2021-02-22 00:00:00+00:00    None    None</span>
</span><span id=__span-84-28><a id=__codelineno-84-28 name=__codelineno-84-28 href=#__codelineno-84-28></a><span class=go>2021-02-23 00:00:00+00:00    None    None</span>
</span><span id=__span-84-29><a id=__codelineno-84-29 name=__codelineno-84-29 href=#__codelineno-84-29></a><span class=go>2021-02-24 00:00:00+00:00    None    None</span>
</span></code></pre></div> <ol> <li>Orders are represented as rows in a compressed record array. Specific information is included as a column.</li> <li>Specific information as a time series.</li> </ol> <p>From the first DataFrame, we can see that the first order is a buy market order (<code>Side</code> and <code>Type</code>) that was filled on February 18th (<code>Fill Index</code>). The second order in the same column is a sell market order, resulting from a <abbr title="Take profit">TP</abbr> order (<code>Stop Type</code>), that was issued on February 18th (<code>Signal Index</code>) but actually filled on February 21st (<code>Fill Index</code>). The <code>Creation Index</code> column is the same as the <code>Fill Index</code> column because all orders are market orders. The second DataFrame shows a typical representation of a single piece of information by time and asset; it is best used when the information should be analyzed as a time series with Pandas.</p> <p>Now, let's discuss multiple stop configurations. Here is how to test each stop type independently: that is, <abbr title="Stop loss">SL</abbr> at 10%, <abbr title="Trailing stop loss">TSL</abbr> at 10%, <abbr title="Trailing take profit">TTP</abbr> at 10% with a 10% threshold, and <abbr title="Take profit">TP</abbr> at 10%:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-85-1><a id=__codelineno-85-1 name=__codelineno-85-1 href=#__codelineno-85-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-85-2><a id=__codelineno-85-2 name=__codelineno-85-2 href=#__codelineno-85-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-85-3><a id=__codelineno-85-3 name=__codelineno-85-3 href=#__codelineno-85-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-85-4><a id=__codelineno-85-4 name=__codelineno-85-4 href=#__codelineno-85-4></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mf>0.1</span><span class=p>,</span>    <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=mi>0</span><span class=p>),</span>
</span><span id=__span-85-5><a id=__codelineno-85-5 name=__codelineno-85-5 href=#__codelineno-85-5></a><span class=gp>... </span>    <span class=n>tsl_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span>    <span class=mf>0.1</span><span class=p>,</span>    <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=mi>0</span><span class=p>),</span>
</span><span id=__span-85-6><a id=__codelineno-85-6 name=__codelineno-85-6 href=#__codelineno-85-6></a><span class=gp>... </span>    <span class=n>tsl_th</span><span class=o>=</span>  <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span>    <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=mi>0</span><span class=p>),</span>
</span><span id=__span-85-7><a id=__codelineno-85-7 name=__codelineno-85-7 href=#__codelineno-85-7></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mf>0.1</span>   <span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=mi>0</span><span class=p>),</span>
</span><span id=__span-85-8><a id=__codelineno-85-8 name=__codelineno-85-8 href=#__codelineno-85-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-85-9><a id=__codelineno-85-9 name=__codelineno-85-9 href=#__codelineno-85-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>total_return</span>
</span><span id=__span-85-10><a id=__codelineno-85-10 name=__codelineno-85-10 href=#__codelineno-85-10></a><span class=go>sl_stop  tsl_stop  tsl_th  tp_stop  symbol </span>
</span><span id=__span-85-11><a id=__codelineno-85-11 name=__codelineno-85-11 href=#__codelineno-85-11></a><span class=go>0.1      NaN       NaN     NaN      BTCUSDT   -0.100000</span>
</span><span id=__span-85-12><a id=__codelineno-85-12 name=__codelineno-85-12 href=#__codelineno-85-12></a><span class=go>                                    ETHUSDT   -0.100000</span>
</span><span id=__span-85-13><a id=__codelineno-85-13 name=__codelineno-85-13 href=#__codelineno-85-13></a><span class=go>NaN      0.1       NaN     NaN      BTCUSDT    0.018717</span>
</span><span id=__span-85-14><a id=__codelineno-85-14 name=__codelineno-85-14 href=#__codelineno-85-14></a><span class=go>                                    ETHUSDT   -0.052332</span>
</span><span id=__span-85-15><a id=__codelineno-85-15 name=__codelineno-85-15 href=#__codelineno-85-15></a><span class=go>NaN      0.1       0.1     NaN      BTCUSDT    0.018717</span>
</span><span id=__span-85-16><a id=__codelineno-85-16 name=__codelineno-85-16 href=#__codelineno-85-16></a><span class=go>                                    ETHUSDT   -0.163033</span>
</span><span id=__span-85-17><a id=__codelineno-85-17 name=__codelineno-85-17 href=#__codelineno-85-17></a><span class=go>NaN      NaN       NaN     0.1      BTCUSDT    0.100000</span>
</span><span id=__span-85-18><a id=__codelineno-85-18 name=__codelineno-85-18 href=#__codelineno-85-18></a><span class=go>                                    ETHUSDT   -0.163033</span>
</span><span id=__span-85-19><a id=__codelineno-85-19 name=__codelineno-85-19 href=#__codelineno-85-19></a><span class=go>Name: total_return, dtype: float64</span>
</span></code></pre></div> <p>To build a product of various stop types, we can specify unique (non-repeating) values and omit the <code>level</code> argument:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-86-1><a id=__codelineno-86-1 name=__codelineno-86-1 href=#__codelineno-86-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-86-2><a id=__codelineno-86-2 name=__codelineno-86-2 href=#__codelineno-86-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-86-3><a id=__codelineno-86-3 name=__codelineno-86-3 href=#__codelineno-86-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-86-4><a id=__codelineno-86-4 name=__codelineno-86-4 href=#__codelineno-86-4></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>]),</span>
</span><span id=__span-86-5><a id=__codelineno-86-5 name=__codelineno-86-5 href=#__codelineno-86-5></a><span class=gp>... </span>    <span class=n>tsl_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>]),</span>
</span><span id=__span-86-6><a id=__codelineno-86-6 name=__codelineno-86-6 href=#__codelineno-86-6></a><span class=gp>... </span>    <span class=n>tsl_th</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>]),</span>
</span><span id=__span-86-7><a id=__codelineno-86-7 name=__codelineno-86-7 href=#__codelineno-86-7></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>]),</span>
</span><span id=__span-86-8><a id=__codelineno-86-8 name=__codelineno-86-8 href=#__codelineno-86-8></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <div class="admonition warning"> <p class=admonition-title>Warning</p> <p>The number of columns generated from a Cartesian product of multiple parameter combinations grows exponentially with the number of parameter combinations. Please show mercy to your RAM!</p> </div> <p>However, this would include a combination where <code>tsl_th</code> is not NaN but <code>tsl_stop</code> is NaN, which does not make sense. What we want are three combinations: no <abbr title="Trailing stop loss">TSL</abbr>/<abbr title="Trailing take profit">TTP</abbr> stop, <abbr title="Trailing stop loss">TSL</abbr> stop, and <abbr title="Trailing take profit">TTP</abbr> stop. Therefore, we need to combine these two arguments manually and link them by the same <code>level</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-87-1><a id=__codelineno-87-1 name=__codelineno-87-1 href=#__codelineno-87-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-87-2><a id=__codelineno-87-2 name=__codelineno-87-2 href=#__codelineno-87-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-87-3><a id=__codelineno-87-3 name=__codelineno-87-3 href=#__codelineno-87-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-87-4><a id=__codelineno-87-4 name=__codelineno-87-4 href=#__codelineno-87-4></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=mi>0</span><span class=p>),</span>
</span><span id=__span-87-5><a id=__codelineno-87-5 name=__codelineno-87-5 href=#__codelineno-87-5></a><span class=gp>... </span>    <span class=n>tsl_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>
</span><span id=__span-87-6><a id=__codelineno-87-6 name=__codelineno-87-6 href=#__codelineno-87-6></a><span class=gp>... </span>    <span class=n>tsl_th</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>
</span><span id=__span-87-7><a id=__codelineno-87-7 name=__codelineno-87-7 href=#__codelineno-87-7></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=mi>2</span><span class=p>),</span>
</span><span id=__span-87-8><a id=__codelineno-87-8 name=__codelineno-87-8 href=#__codelineno-87-8></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>If any arguments require a level, you must define a level for all arguments.</p> </div> <p>We can then call a metric and analyze it using Pandas. For example, let's calculate the average return for 1) positions using either <abbr title="Stop loss">SL</abbr> or <abbr title="Take profit">TP</abbr>, or 2) positions using both <abbr title="Stop loss">SL</abbr> and <abbr title="Take profit">TP</abbr> together:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-88-1><a id=__codelineno-88-1 name=__codelineno-88-1 href=#__codelineno-88-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>total_return</span> <span class=o>=</span> <span class=n>pf</span><span class=o>.</span><span class=n>total_return</span>
</span><span id=__span-88-2><a id=__codelineno-88-2 name=__codelineno-88-2 href=#__codelineno-88-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sl_stops</span> <span class=o>=</span> <span class=n>total_return</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>get_level_values</span><span class=p>(</span><span class=s2>&quot;sl_stop&quot;</span><span class=p>)</span>
</span><span id=__span-88-3><a id=__codelineno-88-3 name=__codelineno-88-3 href=#__codelineno-88-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>tp_stops</span> <span class=o>=</span> <span class=n>total_return</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>get_level_values</span><span class=p>(</span><span class=s2>&quot;tp_stop&quot;</span><span class=p>)</span>
</span><span id=__span-88-4><a id=__codelineno-88-4 name=__codelineno-88-4 href=#__codelineno-88-4></a>
</span><span id=__span-88-5><a id=__codelineno-88-5 name=__codelineno-88-5 href=#__codelineno-88-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>total_return</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>sl_stops</span><span class=p>)</span> <span class=o>|</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>tp_stops</span><span class=p>)]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span><span id=__span-88-6><a id=__codelineno-88-6 name=__codelineno-88-6 href=#__codelineno-88-6></a><span class=go>-0.045462468872515135</span>
</span><span id=__span-88-7><a id=__codelineno-88-7 name=__codelineno-88-7 href=#__codelineno-88-7></a>
</span><span id=__span-88-8><a id=__codelineno-88-8 name=__codelineno-88-8 href=#__codelineno-88-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>total_return</span><span class=p>[</span><span class=o>~</span><span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>sl_stops</span><span class=p>)</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>tp_stops</span><span class=p>)]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span><span id=__span-88-9><a id=__codelineno-88-9 name=__codelineno-88-9 href=#__codelineno-88-9></a><span class=go>0.0</span>
</span></code></pre></div> <p>Seems like combining <abbr title="Stop loss">SL</abbr> and <abbr title="Take profit">TP</abbr> works better on our "huge" time series with just 7 data points <img alt=ðŸ™ƒ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f643.svg title=:upside_down_face:></p> <p>The examples above only work if you are testing arguments provided as scalars (single values). But what if you want to backtest different combinations of stop values given as arrays, such as those calculated from the ATR? Doing this manually would be quite difficult, since you would need to tile each stop type array by the number of stop values and then combine all stop type arrays using a Cartesian product.</p> <p>A simpler solution is to build a basic indicator that prepares the arrays for us:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-89-1><a id=__codelineno-89-1 name=__codelineno-89-1 href=#__codelineno-89-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>StopOrderPrep</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>IF</span><span class=o>.</span><span class=n>from_expr</span><span class=p>(</span><span class=s2>&quot;&quot;&quot;</span>
</span><span id=__span-89-2><a id=__codelineno-89-2 name=__codelineno-89-2 href=#__codelineno-89-2></a><span class=gp>... </span><span class=s2>    sl_stop = @p_sl_mult * @in_atr / @in_close</span>
</span><span id=__span-89-3><a id=__codelineno-89-3 name=__codelineno-89-3 href=#__codelineno-89-3></a><span class=gp>... </span><span class=s2>    tp_stop = @p_tp_mult * @in_atr / @in_close</span>
</span><span id=__span-89-4><a id=__codelineno-89-4 name=__codelineno-89-4 href=#__codelineno-89-4></a><span class=gp>... </span><span class=s2>    sl_stop, tp_stop</span>
</span><span id=__span-89-5><a id=__codelineno-89-5 name=__codelineno-89-5 href=#__codelineno-89-5></a><span class=gp>... </span><span class=s2>&quot;&quot;&quot;</span><span class=p>)</span>
</span><span id=__span-89-6><a id=__codelineno-89-6 name=__codelineno-89-6 href=#__codelineno-89-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>stop_order_prep</span> <span class=o>=</span> <span class=n>StopOrderPrep</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span><span id=__span-89-7><a id=__codelineno-89-7 name=__codelineno-89-7 href=#__codelineno-89-7></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=n>sub_data</span><span class=o>.</span><span class=n>close</span><span class=p>,</span> 
</span><span id=__span-89-8><a id=__codelineno-89-8 name=__codelineno-89-8 href=#__codelineno-89-8></a><span class=gp>... </span>    <span class=n>atr</span><span class=o>=</span><span class=n>sub_atr</span><span class=p>,</span>
</span><span id=__span-89-9><a id=__codelineno-89-9 name=__codelineno-89-9 href=#__codelineno-89-9></a><span class=gp>... </span>    <span class=n>sl_mult</span><span class=o>=</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mi>1</span><span class=p>],</span>  <span class=c1># (1)!</span>
</span><span id=__span-89-10><a id=__codelineno-89-10 name=__codelineno-89-10 href=#__codelineno-89-10></a><span class=gp>... </span>    <span class=n>tp_mult</span><span class=o>=</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mi>1</span><span class=p>],</span>
</span><span id=__span-89-11><a id=__codelineno-89-11 name=__codelineno-89-11 href=#__codelineno-89-11></a><span class=gp>... </span>    <span class=n>param_product</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-89-12><a id=__codelineno-89-12 name=__codelineno-89-12 href=#__codelineno-89-12></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-89-13><a id=__codelineno-89-13 name=__codelineno-89-13 href=#__codelineno-89-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-89-14><a id=__codelineno-89-14 name=__codelineno-89-14 href=#__codelineno-89-14></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-89-15><a id=__codelineno-89-15 name=__codelineno-89-15 href=#__codelineno-89-15></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-89-16><a id=__codelineno-89-16 name=__codelineno-89-16 href=#__codelineno-89-16></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=n>stop_order_prep</span><span class=o>.</span><span class=n>sl_stop</span><span class=p>,</span>
</span><span id=__span-89-17><a id=__codelineno-89-17 name=__codelineno-89-17 href=#__codelineno-89-17></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=n>stop_order_prep</span><span class=o>.</span><span class=n>tp_stop</span><span class=p>,</span>
</span><span id=__span-89-18><a id=__codelineno-89-18 name=__codelineno-89-18 href=#__codelineno-89-18></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-89-19><a id=__codelineno-89-19 name=__codelineno-89-19 href=#__codelineno-89-19></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>total_return</span>
</span><span id=__span-89-20><a id=__codelineno-89-20 name=__codelineno-89-20 href=#__codelineno-89-20></a><span class=go>custom_sl_mult  custom_tp_mult  symbol </span>
</span><span id=__span-89-21><a id=__codelineno-89-21 name=__codelineno-89-21 href=#__codelineno-89-21></a><span class=go>NaN             NaN             BTCUSDT   -0.036398</span>
</span><span id=__span-89-22><a id=__codelineno-89-22 name=__codelineno-89-22 href=#__codelineno-89-22></a><span class=go>                                ETHUSDT   -0.163033</span>
</span><span id=__span-89-23><a id=__codelineno-89-23 name=__codelineno-89-23 href=#__codelineno-89-23></a><span class=go>NaN             1.0             BTCUSDT    0.062400</span>
</span><span id=__span-89-24><a id=__codelineno-89-24 name=__codelineno-89-24 href=#__codelineno-89-24></a><span class=go>                                ETHUSDT   -0.163033</span>
</span><span id=__span-89-25><a id=__codelineno-89-25 name=__codelineno-89-25 href=#__codelineno-89-25></a><span class=go>1.0             NaN             BTCUSDT   -0.062400</span>
</span><span id=__span-89-26><a id=__codelineno-89-26 name=__codelineno-89-26 href=#__codelineno-89-26></a><span class=go>                                ETHUSDT   -0.069255</span>
</span><span id=__span-89-27><a id=__codelineno-89-27 name=__codelineno-89-27 href=#__codelineno-89-27></a><span class=go>1.0             1.0             BTCUSDT    0.062400</span>
</span><span id=__span-89-28><a id=__codelineno-89-28 name=__codelineno-89-28 href=#__codelineno-89-28></a><span class=go>                                ETHUSDT   -0.069255</span>
</span><span id=__span-89-29><a id=__codelineno-89-29 name=__codelineno-89-29 href=#__codelineno-89-29></a><span class=go>Name: total_return, dtype: float64</span>
</span></code></pre></div> <ol> <li>NaN means no order, while 1 means one ATR divided by the close.</li> </ol> <h4 id=entry-point>Entry point<a class=headerlink href=#entry-point title="Permanent link">&para;</a></h4> <p>You can set the entry price of stop orders using the <code>stop_entry_price</code> argument. This argument accepts either the price itself or any option from the enumerated type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.StopEntryPrice>StopEntryPrice</a>. To separate real prices from options, the options use a negative sign. By default, the entry price is the closing price, even if the entry order was actually filled before the closing price, such as at the opening price. This is because a stop order cannot be filled on the same bar as the entry order, so the first check is postponed to the next bar. Let's see what happens if we define a stop order that can be executed as early as the first bar:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-90-1><a id=__codelineno-90-1 name=__codelineno-90-1 href=#__codelineno-90-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-90-2><a id=__codelineno-90-2 name=__codelineno-90-2 href=#__codelineno-90-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-90-3><a id=__codelineno-90-3 name=__codelineno-90-3 href=#__codelineno-90-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-90-4><a id=__codelineno-90-4 name=__codelineno-90-4 href=#__codelineno-90-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=s2>&quot;open&quot;</span><span class=p>,</span>
</span><span id=__span-90-5><a id=__codelineno-90-5 name=__codelineno-90-5 href=#__codelineno-90-5></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=mf>0.005</span><span class=p>,</span>
</span><span id=__span-90-6><a id=__codelineno-90-6 name=__codelineno-90-6 href=#__codelineno-90-6></a><span class=gp>... </span>    <span class=n>stop_entry_price</span><span class=o>=</span><span class=s2>&quot;fillprice&quot;</span>
</span><span id=__span-90-7><a id=__codelineno-90-7 name=__codelineno-90-7 href=#__codelineno-90-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-90-8><a id=__codelineno-90-8 name=__codelineno-90-8 href=#__codelineno-90-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-90-9><a id=__codelineno-90-9 name=__codelineno-90-9 href=#__codelineno-90-9></a><span class=go>symbol                         BTCUSDT  ETHUSDT</span>
</span><span id=__span-90-10><a id=__codelineno-90-10 name=__codelineno-90-10 href=#__codelineno-90-10></a><span class=go>Open time                                      </span>
</span><span id=__span-90-11><a id=__codelineno-90-11 name=__codelineno-90-11 href=#__codelineno-90-11></a><span class=go>2021-02-18 00:00:00+00:00  52117.67000  1849.70</span>
</span><span id=__span-90-12><a id=__codelineno-90-12 name=__codelineno-90-12 href=#__codelineno-90-12></a><span class=go>2021-02-19 00:00:00+00:00  52378.25835  1938.91</span>
</span><span id=__span-90-13><a id=__codelineno-90-13 name=__codelineno-90-13 href=#__codelineno-90-13></a><span class=go>2021-02-20 00:00:00+00:00          NaN      NaN</span>
</span><span id=__span-90-14><a id=__codelineno-90-14 name=__codelineno-90-14 href=#__codelineno-90-14></a><span class=go>2021-02-21 00:00:00+00:00          NaN      NaN</span>
</span><span id=__span-90-15><a id=__codelineno-90-15 name=__codelineno-90-15 href=#__codelineno-90-15></a><span class=go>2021-02-22 00:00:00+00:00          NaN      NaN</span>
</span><span id=__span-90-16><a id=__codelineno-90-16 name=__codelineno-90-16 href=#__codelineno-90-16></a><span class=go>2021-02-23 00:00:00+00:00          NaN      NaN</span>
</span><span id=__span-90-17><a id=__codelineno-90-17 name=__codelineno-90-17 href=#__codelineno-90-17></a><span class=go>2021-02-24 00:00:00+00:00          NaN      NaN</span>
</span></code></pre></div> <p>As we can see, even though the target price <code>52378.26</code> could theoretically be filled at the first bar, since it is lower than the highest price of <code>52530.00</code> on that bar, the check was still postponed to the next bar. This happens because the <abbr title="From-signals simulation method">FS</abbr> only allows one order per bar and asset.</p> <h4 id=exit-point>Exit point<a class=headerlink href=#exit-point title="Permanent link">&para;</a></h4> <p>There are only a few options for defining a stop <strong>exit</strong> price: the stop price and the closing price. If the stop is triggered at the beginning of a bar, the stop price will become the opening price, and the same applies for the closing price. By default, a stop order is executed using the stop price, but if you want to run the entire simulation using only closing prices, the closing price option may be more suitable.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-91-1><a id=__codelineno-91-1 name=__codelineno-91-1 href=#__codelineno-91-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-91-2><a id=__codelineno-91-2 name=__codelineno-91-2 href=#__codelineno-91-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-91-3><a id=__codelineno-91-3 name=__codelineno-91-3 href=#__codelineno-91-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-91-4><a id=__codelineno-91-4 name=__codelineno-91-4 href=#__codelineno-91-4></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span>
</span><span id=__span-91-5><a id=__codelineno-91-5 name=__codelineno-91-5 href=#__codelineno-91-5></a><span class=gp>... </span>    <span class=n>stop_exit_price</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=s2>&quot;stop&quot;</span><span class=p>,</span> <span class=s2>&quot;close&quot;</span><span class=p>])</span>
</span><span id=__span-91-6><a id=__codelineno-91-6 name=__codelineno-91-6 href=#__codelineno-91-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-91-7><a id=__codelineno-91-7 name=__codelineno-91-7 href=#__codelineno-91-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-91-8><a id=__codelineno-91-8 name=__codelineno-91-8 href=#__codelineno-91-8></a><span class=go>stop_exit_price                stop               close         </span>
</span><span id=__span-91-9><a id=__codelineno-91-9 name=__codelineno-91-9 href=#__codelineno-91-9></a><span class=go>symbol                      BTCUSDT    ETHUSDT  BTCUSDT  ETHUSDT</span>
</span><span id=__span-91-10><a id=__codelineno-91-10 name=__codelineno-91-10 href=#__codelineno-91-10></a><span class=go>Open time                                                       </span>
</span><span id=__span-91-11><a id=__codelineno-91-11 name=__codelineno-91-11 href=#__codelineno-91-11></a><span class=go>2021-02-18 00:00:00+00:00  51552.60  1939.6100  51552.6  1939.61</span>
</span><span id=__span-91-12><a id=__codelineno-91-12 name=__codelineno-91-12 href=#__codelineno-91-12></a><span class=go>2021-02-19 00:00:00+00:00  54130.23        NaN  55906.0      NaN</span>
</span><span id=__span-91-13><a id=__codelineno-91-13 name=__codelineno-91-13 href=#__codelineno-91-13></a><span class=go>2021-02-20 00:00:00+00:00       NaN  2036.5905      NaN  1913.00</span>
</span><span id=__span-91-14><a id=__codelineno-91-14 name=__codelineno-91-14 href=#__codelineno-91-14></a><span class=go>2021-02-21 00:00:00+00:00       NaN        NaN      NaN      NaN</span>
</span><span id=__span-91-15><a id=__codelineno-91-15 name=__codelineno-91-15 href=#__codelineno-91-15></a><span class=go>2021-02-22 00:00:00+00:00       NaN        NaN      NaN      NaN</span>
</span><span id=__span-91-16><a id=__codelineno-91-16 name=__codelineno-91-16 href=#__codelineno-91-16></a><span class=go>2021-02-23 00:00:00+00:00       NaN        NaN      NaN      NaN</span>
</span><span id=__span-91-17><a id=__codelineno-91-17 name=__codelineno-91-17 href=#__codelineno-91-17></a><span class=go>2021-02-24 00:00:00+00:00       NaN        NaN      NaN      NaN</span>
</span></code></pre></div> <p>By doing this, we effectively delay the execution of a stop order until the end of a bar. Not only can we change the default stop exit price, but we can also change the default stop exit behavior. Using the <code>stop_exit_type</code> argument of type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.StopExitType>StopExitType</a>, we can reduce, reverse, or reverse and reduce the position, instead of just closing it. By default, the position is closed by issuing an exit signal and disabling accumulation. Alternatively, we can reverse it by issuing an opposite entry signal, and/or reduce it by keeping accumulation enabled.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-92-1><a id=__codelineno-92-1 name=__codelineno-92-1 href=#__codelineno-92-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-92-2><a id=__codelineno-92-2 name=__codelineno-92-2 href=#__codelineno-92-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-92-3><a id=__codelineno-92-3 name=__codelineno-92-3 href=#__codelineno-92-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-92-4><a id=__codelineno-92-4 name=__codelineno-92-4 href=#__codelineno-92-4></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=mf>0.01</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-92-5><a id=__codelineno-92-5 name=__codelineno-92-5 href=#__codelineno-92-5></a><span class=gp>... </span>    <span class=n>stop_exit_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=s2>&quot;close&quot;</span><span class=p>,</span> <span class=s2>&quot;reverse&quot;</span><span class=p>])</span>
</span><span id=__span-92-6><a id=__codelineno-92-6 name=__codelineno-92-6 href=#__codelineno-92-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-92-7><a id=__codelineno-92-7 name=__codelineno-92-7 href=#__codelineno-92-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-92-8><a id=__codelineno-92-8 name=__codelineno-92-8 href=#__codelineno-92-8></a><span class=go>stop_exit_type                 close                reverse           </span>
</span><span id=__span-92-9><a id=__codelineno-92-9 name=__codelineno-92-9 href=#__codelineno-92-9></a><span class=go>symbol                       BTCUSDT    ETHUSDT     BTCUSDT    ETHUSDT</span>
</span><span id=__span-92-10><a id=__codelineno-92-10 name=__codelineno-92-10 href=#__codelineno-92-10></a><span class=go>Open time                                                             </span>
</span><span id=__span-92-11><a id=__codelineno-92-11 name=__codelineno-92-11 href=#__codelineno-92-11></a><span class=go>2021-02-18 00:00:00+00:00  51552.600  1939.6100  51552.6000  1939.6100</span>
</span><span id=__span-92-12><a id=__codelineno-92-12 name=__codelineno-92-12 href=#__codelineno-92-12></a><span class=go>2021-02-19 00:00:00+00:00  52068.126  1959.0061  52068.1260  1959.0061</span>
</span><span id=__span-92-13><a id=__codelineno-92-13 name=__codelineno-92-13 href=#__codelineno-92-13></a><span class=go>2021-02-20 00:00:00+00:00        NaN        NaN  55346.9400  1935.4500</span>
</span><span id=__span-92-14><a id=__codelineno-92-14 name=__codelineno-92-14 href=#__codelineno-92-14></a><span class=go>2021-02-21 00:00:00+00:00        NaN        NaN  56399.6019  1932.1300</span>
</span><span id=__span-92-15><a id=__codelineno-92-15 name=__codelineno-92-15 href=#__codelineno-92-15></a><span class=go>2021-02-22 00:00:00+00:00        NaN        NaN  56834.4843  1914.1947</span>
</span><span id=__span-92-16><a id=__codelineno-92-16 name=__codelineno-92-16 href=#__codelineno-92-16></a><span class=go>2021-02-23 00:00:00+00:00        NaN        NaN         NaN        NaN</span>
</span><span id=__span-92-17><a id=__codelineno-92-17 name=__codelineno-92-17 href=#__codelineno-92-17></a><span class=go>2021-02-24 00:00:00+00:00        NaN        NaN         NaN        NaN</span>
</span></code></pre></div> <ol> <li><abbr title="Take profit">TP</abbr> of 1%.</li> </ol> <p>Look at the columns under the parameter value <code>reverse</code>: they now contain five orders instead of two. Why is that? By reversing, we close the current position and open a new one in the opposite direction, using a single order. Opening a new position also creates a new stop order, which results in a never-ending cycle of conditional reversals <img alt=ðŸ˜¬ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f62c.svg title=:grimacing:> If you do not want this cycle, you can define <code>stop_exit_type</code> as an array where only a specific stop is closed or reversed. Each value in this array should be linked to the entry point rather than the exit point, since this information (along with <code>stop_exit_price</code>) is order-anchored, not date-anchored. For example, let's reverse only the first order:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-93-1><a id=__codelineno-93-1 name=__codelineno-93-1 href=#__codelineno-93-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-93-2><a id=__codelineno-93-2 name=__codelineno-93-2 href=#__codelineno-93-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-93-3><a id=__codelineno-93-3 name=__codelineno-93-3 href=#__codelineno-93-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-93-4><a id=__codelineno-93-4 name=__codelineno-93-4 href=#__codelineno-93-4></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=mf>0.01</span><span class=p>,</span>
</span><span id=__span-93-5><a id=__codelineno-93-5 name=__codelineno-93-5 href=#__codelineno-93-5></a><span class=gp>... </span>    <span class=n>stop_exit_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>index_dict</span><span class=p>({</span><span class=mi>0</span><span class=p>:</span> <span class=s2>&quot;reverse&quot;</span><span class=p>,</span> <span class=s2>&quot;_def&quot;</span><span class=p>:</span> <span class=s2>&quot;close&quot;</span><span class=p>})</span>
</span><span id=__span-93-6><a id=__codelineno-93-6 name=__codelineno-93-6 href=#__codelineno-93-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-93-7><a id=__codelineno-93-7 name=__codelineno-93-7 href=#__codelineno-93-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-93-8><a id=__codelineno-93-8 name=__codelineno-93-8 href=#__codelineno-93-8></a><span class=go>symbol                       BTCUSDT    ETHUSDT</span>
</span><span id=__span-93-9><a id=__codelineno-93-9 name=__codelineno-93-9 href=#__codelineno-93-9></a><span class=go>Open time                                      </span>
</span><span id=__span-93-10><a id=__codelineno-93-10 name=__codelineno-93-10 href=#__codelineno-93-10></a><span class=go>2021-02-18 00:00:00+00:00  51552.600  1939.6100</span>
</span><span id=__span-93-11><a id=__codelineno-93-11 name=__codelineno-93-11 href=#__codelineno-93-11></a><span class=go>2021-02-19 00:00:00+00:00  52068.126  1959.0061</span>
</span><span id=__span-93-12><a id=__codelineno-93-12 name=__codelineno-93-12 href=#__codelineno-93-12></a><span class=go>2021-02-20 00:00:00+00:00  55346.940  1935.4500</span>
</span><span id=__span-93-13><a id=__codelineno-93-13 name=__codelineno-93-13 href=#__codelineno-93-13></a><span class=go>2021-02-21 00:00:00+00:00        NaN        NaN</span>
</span><span id=__span-93-14><a id=__codelineno-93-14 name=__codelineno-93-14 href=#__codelineno-93-14></a><span class=go>2021-02-22 00:00:00+00:00        NaN        NaN</span>
</span><span id=__span-93-15><a id=__codelineno-93-15 name=__codelineno-93-15 href=#__codelineno-93-15></a><span class=go>2021-02-23 00:00:00+00:00        NaN        NaN</span>
</span><span id=__span-93-16><a id=__codelineno-93-16 name=__codelineno-93-16 href=#__codelineno-93-16></a><span class=go>2021-02-24 00:00:00+00:00        NaN        NaN</span>
</span></code></pre></div> <p>The first position was reversed, while the second position was simply exited.</p> <p>What about the order type? Upon exit, the order type becomes either a market or a limit order. This behavior is controlled by the <code>stop_order_type</code> argument of type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.OrderType>OrderType</a>. There is also a <code>stop_limit_delta</code> argument to specify a delta for the resulting limit order. Let's compare a 5% <abbr title="Take profit">TP</abbr> order as a stop market order versus a stop limit order with a 1% delta:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-94-1><a id=__codelineno-94-1 name=__codelineno-94-1 href=#__codelineno-94-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-94-2><a id=__codelineno-94-2 name=__codelineno-94-2 href=#__codelineno-94-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-94-3><a id=__codelineno-94-3 name=__codelineno-94-3 href=#__codelineno-94-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-94-4><a id=__codelineno-94-4 name=__codelineno-94-4 href=#__codelineno-94-4></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span>
</span><span id=__span-94-5><a id=__codelineno-94-5 name=__codelineno-94-5 href=#__codelineno-94-5></a><span class=gp>... </span>    <span class=n>stop_order_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=s2>&quot;market&quot;</span><span class=p>,</span> <span class=s2>&quot;limit&quot;</span><span class=p>]),</span>
</span><span id=__span-94-6><a id=__codelineno-94-6 name=__codelineno-94-6 href=#__codelineno-94-6></a><span class=gp>... </span>    <span class=n>stop_limit_delta</span><span class=o>=</span><span class=mf>0.01</span>
</span><span id=__span-94-7><a id=__codelineno-94-7 name=__codelineno-94-7 href=#__codelineno-94-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-94-8><a id=__codelineno-94-8 name=__codelineno-94-8 href=#__codelineno-94-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-94-9><a id=__codelineno-94-9 name=__codelineno-94-9 href=#__codelineno-94-9></a><span class=go>stop_order_type              market                  limit         </span>
</span><span id=__span-94-10><a id=__codelineno-94-10 name=__codelineno-94-10 href=#__codelineno-94-10></a><span class=go>symbol                      BTCUSDT    ETHUSDT     BTCUSDT  ETHUSDT</span>
</span><span id=__span-94-11><a id=__codelineno-94-11 name=__codelineno-94-11 href=#__codelineno-94-11></a><span class=go>Open time                                                          </span>
</span><span id=__span-94-12><a id=__codelineno-94-12 name=__codelineno-94-12 href=#__codelineno-94-12></a><span class=go>2021-02-18 00:00:00+00:00  51552.60  1939.6100  51552.6000  1939.61</span>
</span><span id=__span-94-13><a id=__codelineno-94-13 name=__codelineno-94-13 href=#__codelineno-94-13></a><span class=go>2021-02-19 00:00:00+00:00  54130.23        NaN  54671.5323      NaN</span>
</span><span id=__span-94-14><a id=__codelineno-94-14 name=__codelineno-94-14 href=#__codelineno-94-14></a><span class=go>2021-02-20 00:00:00+00:00       NaN  2036.5905         NaN      NaN</span>
</span><span id=__span-94-15><a id=__codelineno-94-15 name=__codelineno-94-15 href=#__codelineno-94-15></a><span class=go>2021-02-21 00:00:00+00:00       NaN        NaN         NaN      NaN</span>
</span><span id=__span-94-16><a id=__codelineno-94-16 name=__codelineno-94-16 href=#__codelineno-94-16></a><span class=go>2021-02-22 00:00:00+00:00       NaN        NaN         NaN      NaN</span>
</span><span id=__span-94-17><a id=__codelineno-94-17 name=__codelineno-94-17 href=#__codelineno-94-17></a><span class=go>2021-02-23 00:00:00+00:00       NaN        NaN         NaN      NaN</span>
</span><span id=__span-94-18><a id=__codelineno-94-18 name=__codelineno-94-18 href=#__codelineno-94-18></a><span class=go>2021-02-24 00:00:00+00:00       NaN        NaN         NaN      NaN</span>
</span></code></pre></div> <p>The latest stop limit order could not be filled because the highest price in the entire <code>ETHUSDT</code> column is <code>2042.34</code>, while the requested limit price is <code>1939.61 * 1.05 * 1.01 = 2056.96</code>. Even if a higher price existed on February 20, unless the stop price was triggered at open, the simulator would not be able to use the entire candle to match the limit price since there is no intra-bar data to confirm that the limit price was reached strictly after the stop price. The only information the simulator can check in this case is the closing price. Only if the closing price is higher than the limit price can we be sure the limit price was actually hit.</p> <h4 id=conflicts_2>Conflicts<a class=headerlink href=#conflicts_2 title="Permanent link">&para;</a></h4> <p>Conflicts between stop orders and user-defined signals follow the same resolution logic as limit orders, with the only difference being in the argument naming: <code>upon_adj_stop_conflict</code> and <code>upon_opp_stop_conflict</code>. By default, when a user-defined signal in any direction is encountered, nothing happens. Any stop order remains pending, and the signal is executed as usual. This is because pending stop orders are automatically canceled whenever the position is closed out. Let's now cancel any signal when there is a stop order pending:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-95-1><a id=__codelineno-95-1 name=__codelineno-95-1 href=#__codelineno-95-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-95-2><a id=__codelineno-95-2 name=__codelineno-95-2 href=#__codelineno-95-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-95-3><a id=__codelineno-95-3 name=__codelineno-95-3 href=#__codelineno-95-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>]),</span>
</span><span id=__span-95-4><a id=__codelineno-95-4 name=__codelineno-95-4 href=#__codelineno-95-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-95-5><a id=__codelineno-95-5 name=__codelineno-95-5 href=#__codelineno-95-5></a><span class=gp>... </span>    <span class=n>direction</span><span class=o>=</span><span class=s2>&quot;both&quot;</span><span class=p>,</span>
</span><span id=__span-95-6><a id=__codelineno-95-6 name=__codelineno-95-6 href=#__codelineno-95-6></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
</span><span id=__span-95-7><a id=__codelineno-95-7 name=__codelineno-95-7 href=#__codelineno-95-7></a><span class=gp>... </span>    <span class=n>upon_adj_stop_conflict</span><span class=o>=</span><span class=s2>&quot;keepignore&quot;</span><span class=p>,</span>
</span><span id=__span-95-8><a id=__codelineno-95-8 name=__codelineno-95-8 href=#__codelineno-95-8></a><span class=gp>... </span>    <span class=n>upon_opp_stop_conflict</span><span class=o>=</span><span class=s2>&quot;keepignore&quot;</span><span class=p>,</span>
</span><span id=__span-95-9><a id=__codelineno-95-9 name=__codelineno-95-9 href=#__codelineno-95-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-95-10><a id=__codelineno-95-10 name=__codelineno-95-10 href=#__codelineno-95-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>price</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-95-11><a id=__codelineno-95-11 name=__codelineno-95-11 href=#__codelineno-95-11></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-95-12><a id=__codelineno-95-12 name=__codelineno-95-12 href=#__codelineno-95-12></a><span class=go>Open time                                    </span>
</span><span id=__span-95-13><a id=__codelineno-95-13 name=__codelineno-95-13 href=#__codelineno-95-13></a><span class=go>2021-02-18 00:00:00+00:00  51552.60  1939.610</span>
</span><span id=__span-95-14><a id=__codelineno-95-14 name=__codelineno-95-14 href=#__codelineno-95-14></a><span class=go>2021-02-19 00:00:00+00:00       NaN       NaN</span>
</span><span id=__span-95-15><a id=__codelineno-95-15 name=__codelineno-95-15 href=#__codelineno-95-15></a><span class=go>2021-02-20 00:00:00+00:00       NaN       NaN</span>
</span><span id=__span-95-16><a id=__codelineno-95-16 name=__codelineno-95-16 href=#__codelineno-95-16></a><span class=go>2021-02-21 00:00:00+00:00       NaN       NaN</span>
</span><span id=__span-95-17><a id=__codelineno-95-17 name=__codelineno-95-17 href=#__codelineno-95-17></a><span class=go>2021-02-22 00:00:00+00:00       NaN  1745.649</span>
</span><span id=__span-95-18><a id=__codelineno-95-18 name=__codelineno-95-18 href=#__codelineno-95-18></a><span class=go>2021-02-23 00:00:00+00:00  46397.34  1577.890</span>
</span><span id=__span-95-19><a id=__codelineno-95-19 name=__codelineno-95-19 href=#__codelineno-95-19></a><span class=go>2021-02-24 00:00:00+00:00  49676.20       NaN</span>
</span></code></pre></div> <h4 id=adjustment_1>Adjustment<a class=headerlink href=#adjustment_1 title="Permanent link">&para;</a></h4> <p>Similar to limit orders, stop orders are stored in one-dimensional record arrays where information is organized by column: <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.SignalContext.last_sl_info>SignalContext.last_sl_info</a> for <abbr title="Stop loss">SL</abbr>, <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.SignalContext.last_tsl_info>SignalContext.last_tsl_info</a> for <abbr title="Trailing stop loss">TSL</abbr> and <abbr title="Trailing take profit">TTP</abbr>, and <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.SignalContext.last_tp_info>SignalContext.last_tp_info</a> for <abbr title="Take profit">TP</abbr>. For example, you can create an adjustment function that creates both a <abbr title="Take profit">TP</abbr> and an <abbr title="Stop loss">SL</abbr> order based on the maximum allowed, absolute, parameterizable profit and loss (PnL):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-96-1><a id=__codelineno-96-1 name=__codelineno-96-1 href=#__codelineno-96-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-96-2><a id=__codelineno-96-2 name=__codelineno-96-2 href=#__codelineno-96-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>adjust_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>max_loss</span><span class=p>,</span> <span class=n>max_profit</span><span class=p>):</span>
</span><span id=__span-96-3><a id=__codelineno-96-3 name=__codelineno-96-3 href=#__codelineno-96-3></a><span class=gp>... </span>    <span class=n>position_now</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_position</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>  <span class=c1># (1)!</span>
</span><span id=__span-96-4><a id=__codelineno-96-4 name=__codelineno-96-4 href=#__codelineno-96-4></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>position_now</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>  <span class=c1># (2)!</span>
</span><span id=__span-96-5><a id=__codelineno-96-5 name=__codelineno-96-5 href=#__codelineno-96-5></a><span class=gp>... </span>        <span class=n>sl_info</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_sl_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-96-6><a id=__codelineno-96-6 name=__codelineno-96-6 href=#__codelineno-96-6></a><span class=gp>... </span>        <span class=n>tp_info</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_tp_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-96-7><a id=__codelineno-96-7 name=__codelineno-96-7 href=#__codelineno-96-7></a><span class=gp>... </span>        <span class=n>ml</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>max_loss</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-96-8><a id=__codelineno-96-8 name=__codelineno-96-8 href=#__codelineno-96-8></a><span class=gp>... </span>        <span class=n>mp</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>max_profit</span><span class=p>)</span>
</span><span id=__span-96-9><a id=__codelineno-96-9 name=__codelineno-96-9 href=#__codelineno-96-9></a><span class=gp>...</span>
</span><span id=__span-96-10><a id=__codelineno-96-10 name=__codelineno-96-10 href=#__codelineno-96-10></a><span class=gp>... </span>        <span class=k>if</span> <span class=ow>not</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>is_stop_info_active_nb</span><span class=p>(</span><span class=n>sl_info</span><span class=p>):</span>  <span class=c1># (4)!</span>
</span><span id=__span-96-11><a id=__codelineno-96-11 name=__codelineno-96-11 href=#__codelineno-96-11></a><span class=gp>... </span>            <span class=n>sl_info</span><span class=o>.</span><span class=n>stop</span> <span class=o>=</span> <span class=n>ml</span> <span class=o>/</span> <span class=p>(</span><span class=n>sl_info</span><span class=o>.</span><span class=n>init_price</span> <span class=o>*</span> <span class=n>position_now</span><span class=p>)</span>  <span class=c1># (5)!</span>
</span><span id=__span-96-12><a id=__codelineno-96-12 name=__codelineno-96-12 href=#__codelineno-96-12></a><span class=gp>... </span>        <span class=k>if</span> <span class=ow>not</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>is_stop_info_active_nb</span><span class=p>(</span><span class=n>tp_info</span><span class=p>):</span>
</span><span id=__span-96-13><a id=__codelineno-96-13 name=__codelineno-96-13 href=#__codelineno-96-13></a><span class=gp>... </span>            <span class=n>tp_info</span><span class=o>.</span><span class=n>stop</span> <span class=o>=</span> <span class=n>mp</span> <span class=o>/</span> <span class=p>(</span><span class=n>sl_info</span><span class=o>.</span><span class=n>init_price</span> <span class=o>*</span> <span class=n>position_now</span><span class=p>)</span>
</span><span id=__span-96-14><a id=__codelineno-96-14 name=__codelineno-96-14 href=#__codelineno-96-14></a>
</span><span id=__span-96-15><a id=__codelineno-96-15 name=__codelineno-96-15 href=#__codelineno-96-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-96-16><a id=__codelineno-96-16 name=__codelineno-96-16 href=#__codelineno-96-16></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-96-17><a id=__codelineno-96-17 name=__codelineno-96-17 href=#__codelineno-96-17></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-96-18><a id=__codelineno-96-18 name=__codelineno-96-18 href=#__codelineno-96-18></a><span class=gp>... </span>    <span class=n>adjust_func_nb</span><span class=o>=</span><span class=n>adjust_func_nb</span><span class=p>,</span>
</span><span id=__span-96-19><a id=__codelineno-96-19 name=__codelineno-96-19 href=#__codelineno-96-19></a><span class=gp>... </span>    <span class=n>adjust_args</span><span class=o>=</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;max_loss&quot;</span><span class=p>),</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;max_profit&quot;</span><span class=p>)),</span>
</span><span id=__span-96-20><a id=__codelineno-96-20 name=__codelineno-96-20 href=#__codelineno-96-20></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-96-21><a id=__codelineno-96-21 name=__codelineno-96-21 href=#__codelineno-96-21></a><span class=gp>... </span>        <span class=n>max_loss</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>
</span><span id=__span-96-22><a id=__codelineno-96-22 name=__codelineno-96-22 href=#__codelineno-96-22></a><span class=gp>... </span>        <span class=n>max_profit</span><span class=o>=</span><span class=mi>10</span>
</span><span id=__span-96-23><a id=__codelineno-96-23 name=__codelineno-96-23 href=#__codelineno-96-23></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-96-24><a id=__codelineno-96-24 name=__codelineno-96-24 href=#__codelineno-96-24></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-96-25><a id=__codelineno-96-25 name=__codelineno-96-25 href=#__codelineno-96-25></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>exit_trades</span><span class=o>.</span><span class=n>pnl</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>  <span class=c1># (6)!</span>
</span><span id=__span-96-26><a id=__codelineno-96-26 name=__codelineno-96-26 href=#__codelineno-96-26></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-96-27><a id=__codelineno-96-27 name=__codelineno-96-27 href=#__codelineno-96-27></a><span class=go>Open time                                  </span>
</span><span id=__span-96-28><a id=__codelineno-96-28 name=__codelineno-96-28 href=#__codelineno-96-28></a><span class=go>2021-02-18 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-96-29><a id=__codelineno-96-29 name=__codelineno-96-29 href=#__codelineno-96-29></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-96-30><a id=__codelineno-96-30 name=__codelineno-96-30 href=#__codelineno-96-30></a><span class=go>2021-02-20 00:00:00+00:00     10.0      NaN</span>
</span><span id=__span-96-31><a id=__codelineno-96-31 name=__codelineno-96-31 href=#__codelineno-96-31></a><span class=go>2021-02-21 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-96-32><a id=__codelineno-96-32 name=__codelineno-96-32 href=#__codelineno-96-32></a><span class=go>2021-02-22 00:00:00+00:00      NaN    -10.0</span>
</span><span id=__span-96-33><a id=__codelineno-96-33 name=__codelineno-96-33 href=#__codelineno-96-33></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-96-34><a id=__codelineno-96-34 name=__codelineno-96-34 href=#__codelineno-96-34></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN</span>
</span></code></pre></div> <ol> <li>Get the size of the current position. Remember that fields not associated with cash are accessible via column.</li> <li>We are in the market when the position is not zero.</li> <li>Our parameters broadcast against the data, so we need to select the current element flexibly.</li> <li>There is a useful function <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.is_stop_info_active_nb>is_stop_info_active_nb</a> that checks whether the current stop information record is active (the stop value is not NaN).</li> <li>Divide the maximum loss or profit by the notional value to get the optimal stop loss or take profit.</li> <li>Get the PnL of each trade as a time series.</li> </ol> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>To avoid recompiling the entire simulation function with each new run, define the adjustment function in a different cell or even a separate file. Caching does not help, because Numba does not allow caching callbacks.</p> </div> <p>Our losses and profits are now capped at $10! Here is what happened. Whenever you provide a custom adjustment function or any other callback, the simulator switches to flexible mode and enables stop orders. Whenever a new position is opened or an existing one is increased, the simulator initializes each stop type with the provided arguments. However, since we have not passed anything related to <abbr title="Stop loss">SL</abbr> and <abbr title="Take profit">TP</abbr>, their default stop value is NaN, so they are inactive by default. Regardless, they still contain valuable information, such as the initial price. Therefore, all that is left is to check whether the respective stop is inactive and override the stop value to activate it. You could also use the functions <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.set_sl_info_nb>set_sl_info_nb</a> and <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.set_tp_info_nb>set_tp_info_nb</a> to set the entire information, but in this case, it was not necessary.</p> <h4 id=laddering>Laddering <img alt=ðŸªœ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1fa9c.svg title=:ladder:><a class=headerlink href=#laddering title="Permanent link">&para;</a></h4> <details class=youtube> <summary>Take Profit Ladders on YouTube</summary> <p><iframe class=youtube-video src="https://www.youtube.com/embed/u4RABJMXhXc?si=wkwT18xYQt4EUw0A" title="YouTube video player" frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe></p> </details> <p>We know how to define a single stop to close out an entire position, but what if we want to exit a position gradually? For this, we need a way to provide multiple stop values. However, there is a challenge: stop arguments should broadcast together with other broadcastable arguments, so when providing (for example) <code>tp_stop</code> as an array, the first axis should represent time and the second axis should represent columns. Thanks to a new single-axis broadcasting feature, we can now notify the broadcaster that the array's rows do not represent time, but something different.</p> <p>In practice, <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a> has a <code>stop_ladder</code> argument. When enabled, it switches to single-axis broadcasting, so that providing a list (or one-dimensional array) of values is treated as a single ladder. You can also provide a two-dimensional array to specify the ladder for each column.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Enabling this argument causes <strong>all</strong> stop arguments to behave like ladders. There is no way to make one argument a ladder series and another a time series. Also, the <code>stop_ladder</code> argument affects all columns and cannot be specified per column.</p> </div> <p>In a ladder, each value is a step with a stop value. Just like steps on a real ladder, steps must be ordered from low to high, so that a step is executed only after the previous one has been executed. There is no limit to the number of steps. Let's enable laddering using the <code>stop_ladder</code> argument and create our first <abbr title="Take profit">TP</abbr> ladder with two values: 1% and 5%.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-97-1><a id=__codelineno-97-1 name=__codelineno-97-1 href=#__codelineno-97-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-97-2><a id=__codelineno-97-2 name=__codelineno-97-2 href=#__codelineno-97-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-97-3><a id=__codelineno-97-3 name=__codelineno-97-3 href=#__codelineno-97-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-97-4><a id=__codelineno-97-4 name=__codelineno-97-4 href=#__codelineno-97-4></a><span class=gp>... </span>    <span class=n>stop_ladder</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-97-5><a id=__codelineno-97-5 name=__codelineno-97-5 href=#__codelineno-97-5></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=p>[</span><span class=mf>0.01</span><span class=p>,</span> <span class=mf>0.05</span><span class=p>]</span>
</span><span id=__span-97-6><a id=__codelineno-97-6 name=__codelineno-97-6 href=#__codelineno-97-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-97-7><a id=__codelineno-97-7 name=__codelineno-97-7 href=#__codelineno-97-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-97-8><a id=__codelineno-97-8 name=__codelineno-97-8 href=#__codelineno-97-8></a><span class=go>symbol                     BTCUSDT   ETHUSDT</span>
</span><span id=__span-97-9><a id=__codelineno-97-9 name=__codelineno-97-9 href=#__codelineno-97-9></a><span class=go>Open time                                   </span>
</span><span id=__span-97-10><a id=__codelineno-97-10 name=__codelineno-97-10 href=#__codelineno-97-10></a><span class=go>2021-02-18 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-97-11><a id=__codelineno-97-11 name=__codelineno-97-11 href=#__codelineno-97-11></a><span class=go>2021-02-19 00:00:00+00:00 -0.00097 -0.025778</span>
</span><span id=__span-97-12><a id=__codelineno-97-12 name=__codelineno-97-12 href=#__codelineno-97-12></a><span class=go>2021-02-20 00:00:00+00:00 -0.00097 -0.025778</span>
</span><span id=__span-97-13><a id=__codelineno-97-13 name=__codelineno-97-13 href=#__codelineno-97-13></a><span class=go>2021-02-21 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-97-14><a id=__codelineno-97-14 name=__codelineno-97-14 href=#__codelineno-97-14></a><span class=go>2021-02-22 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-97-15><a id=__codelineno-97-15 name=__codelineno-97-15 href=#__codelineno-97-15></a><span class=go>2021-02-23 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-97-16><a id=__codelineno-97-16 name=__codelineno-97-16 href=#__codelineno-97-16></a><span class=go>2021-02-24 00:00:00+00:00  0.00000  0.000000</span>
</span></code></pre></div> <p>Both ladder steps were successfully executed and removed equal portions of the position. By default, the exit size distribution of the steps is uniform: the exit size depends only on the number of steps. But what if you want to remove an amount from the position that is proportional to the step size? In this context, step size refers to the difference between the current stop price and the previous stop price (the step range), relative to the difference between the last stop price and the entry price (the full range). To achieve this, you can provide the <code>stop_ladder</code> argument with the value "weighted", which corresponds to the mode <code>StopLadderMode.Weighted</code> (for possible ladder modes, see <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.StopLadderMode>StopLadderMode</a>):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-98-1><a id=__codelineno-98-1 name=__codelineno-98-1 href=#__codelineno-98-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-98-2><a id=__codelineno-98-2 name=__codelineno-98-2 href=#__codelineno-98-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-98-3><a id=__codelineno-98-3 name=__codelineno-98-3 href=#__codelineno-98-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-98-4><a id=__codelineno-98-4 name=__codelineno-98-4 href=#__codelineno-98-4></a><span class=gp>... </span>    <span class=n>stop_ladder</span><span class=o>=</span><span class=s2>&quot;weighted&quot;</span><span class=p>,</span>
</span><span id=__span-98-5><a id=__codelineno-98-5 name=__codelineno-98-5 href=#__codelineno-98-5></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=p>[</span><span class=mf>0.01</span><span class=p>,</span> <span class=mf>0.05</span><span class=p>]</span>
</span><span id=__span-98-6><a id=__codelineno-98-6 name=__codelineno-98-6 href=#__codelineno-98-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-98-7><a id=__codelineno-98-7 name=__codelineno-98-7 href=#__codelineno-98-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-98-8><a id=__codelineno-98-8 name=__codelineno-98-8 href=#__codelineno-98-8></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-98-9><a id=__codelineno-98-9 name=__codelineno-98-9 href=#__codelineno-98-9></a><span class=go>Open time                                    </span>
</span><span id=__span-98-10><a id=__codelineno-98-10 name=__codelineno-98-10 href=#__codelineno-98-10></a><span class=go>2021-02-18 00:00:00+00:00  0.001940  0.051557</span>
</span><span id=__span-98-11><a id=__codelineno-98-11 name=__codelineno-98-11 href=#__codelineno-98-11></a><span class=go>2021-02-19 00:00:00+00:00 -0.000388 -0.010311</span>
</span><span id=__span-98-12><a id=__codelineno-98-12 name=__codelineno-98-12 href=#__codelineno-98-12></a><span class=go>2021-02-20 00:00:00+00:00 -0.001552 -0.041245</span>
</span><span id=__span-98-13><a id=__codelineno-98-13 name=__codelineno-98-13 href=#__codelineno-98-13></a><span class=go>2021-02-21 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-98-14><a id=__codelineno-98-14 name=__codelineno-98-14 href=#__codelineno-98-14></a><span class=go>2021-02-22 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-98-15><a id=__codelineno-98-15 name=__codelineno-98-15 href=#__codelineno-98-15></a><span class=go>2021-02-23 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-98-16><a id=__codelineno-98-16 name=__codelineno-98-16 href=#__codelineno-98-16></a><span class=go>2021-02-24 00:00:00+00:00  0.000000  0.000000</span>
</span></code></pre></div> <p>The first step removed <code>(0.01 - 0) / (0.05 - 0) = 20%</code> of the initial position, while the second stop removed the remaining <code>(0.05 - 0.01) / (0.05 - 0) = 80%</code>.</p> <p>Suppose you want to have two parallel ladders: <abbr title="Stop loss">SL</abbr> and <abbr title="Take profit">TP</abbr>. What happens to the exit size distribution if both ladders are partially executed?</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-99-1><a id=__codelineno-99-1 name=__codelineno-99-1 href=#__codelineno-99-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-99-2><a id=__codelineno-99-2 name=__codelineno-99-2 href=#__codelineno-99-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-99-3><a id=__codelineno-99-3 name=__codelineno-99-3 href=#__codelineno-99-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-99-4><a id=__codelineno-99-4 name=__codelineno-99-4 href=#__codelineno-99-4></a><span class=gp>... </span>    <span class=n>stop_ladder</span><span class=o>=</span><span class=s2>&quot;uniform&quot;</span><span class=p>,</span>
</span><span id=__span-99-5><a id=__codelineno-99-5 name=__codelineno-99-5 href=#__codelineno-99-5></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=p>[</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>],</span>
</span><span id=__span-99-6><a id=__codelineno-99-6 name=__codelineno-99-6 href=#__codelineno-99-6></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=p>[</span><span class=mf>0.05</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.15</span><span class=p>]</span>
</span><span id=__span-99-7><a id=__codelineno-99-7 name=__codelineno-99-7 href=#__codelineno-99-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-99-8><a id=__codelineno-99-8 name=__codelineno-99-8 href=#__codelineno-99-8></a>
</span><span id=__span-99-9><a id=__codelineno-99-9 name=__codelineno-99-9 href=#__codelineno-99-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>stop_type</span><span class=o>.</span><span class=n>to_pd</span><span class=p>(</span><span class=n>mapping</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-99-10><a id=__codelineno-99-10 name=__codelineno-99-10 href=#__codelineno-99-10></a><span class=go>symbol                    BTCUSDT ETHUSDT</span>
</span><span id=__span-99-11><a id=__codelineno-99-11 name=__codelineno-99-11 href=#__codelineno-99-11></a><span class=go>Open time                                </span>
</span><span id=__span-99-12><a id=__codelineno-99-12 name=__codelineno-99-12 href=#__codelineno-99-12></a><span class=go>2021-02-18 00:00:00+00:00    None    None</span>
</span><span id=__span-99-13><a id=__codelineno-99-13 name=__codelineno-99-13 href=#__codelineno-99-13></a><span class=go>2021-02-19 00:00:00+00:00    None    None</span>
</span><span id=__span-99-14><a id=__codelineno-99-14 name=__codelineno-99-14 href=#__codelineno-99-14></a><span class=go>2021-02-20 00:00:00+00:00      TP      SL</span>
</span><span id=__span-99-15><a id=__codelineno-99-15 name=__codelineno-99-15 href=#__codelineno-99-15></a><span class=go>2021-02-21 00:00:00+00:00    None    None</span>
</span><span id=__span-99-16><a id=__codelineno-99-16 name=__codelineno-99-16 href=#__codelineno-99-16></a><span class=go>2021-02-22 00:00:00+00:00      SL      SL</span>
</span><span id=__span-99-17><a id=__codelineno-99-17 name=__codelineno-99-17 href=#__codelineno-99-17></a><span class=go>2021-02-23 00:00:00+00:00      SL      SL</span>
</span><span id=__span-99-18><a id=__codelineno-99-18 name=__codelineno-99-18 href=#__codelineno-99-18></a><span class=go>2021-02-24 00:00:00+00:00    None    None</span>
</span><span id=__span-99-19><a id=__codelineno-99-19 name=__codelineno-99-19 href=#__codelineno-99-19></a>
</span><span id=__span-99-20><a id=__codelineno-99-20 name=__codelineno-99-20 href=#__codelineno-99-20></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-99-21><a id=__codelineno-99-21 name=__codelineno-99-21 href=#__codelineno-99-21></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-99-22><a id=__codelineno-99-22 name=__codelineno-99-22 href=#__codelineno-99-22></a><span class=go>Open time                                    </span>
</span><span id=__span-99-23><a id=__codelineno-99-23 name=__codelineno-99-23 href=#__codelineno-99-23></a><span class=go>2021-02-18 00:00:00+00:00  0.001940  0.051557</span>
</span><span id=__span-99-24><a id=__codelineno-99-24 name=__codelineno-99-24 href=#__codelineno-99-24></a><span class=go>2021-02-19 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-99-25><a id=__codelineno-99-25 name=__codelineno-99-25 href=#__codelineno-99-25></a><span class=go>2021-02-20 00:00:00+00:00 -0.000970 -0.017186</span>
</span><span id=__span-99-26><a id=__codelineno-99-26 name=__codelineno-99-26 href=#__codelineno-99-26></a><span class=go>2021-02-21 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-99-27><a id=__codelineno-99-27 name=__codelineno-99-27 href=#__codelineno-99-27></a><span class=go>2021-02-22 00:00:00+00:00 -0.000647 -0.017186</span>
</span><span id=__span-99-28><a id=__codelineno-99-28 name=__codelineno-99-28 href=#__codelineno-99-28></a><span class=go>2021-02-23 00:00:00+00:00 -0.000323 -0.017186</span>
</span><span id=__span-99-29><a id=__codelineno-99-29 name=__codelineno-99-29 href=#__codelineno-99-29></a><span class=go>2021-02-24 00:00:00+00:00  0.000000  0.000000</span>
</span></code></pre></div> <p>You can see that the first <abbr title="Take profit">TP</abbr> step in the <code>BTCUSDT</code> column removed half of the position because there are only two steps in the <abbr title="Take profit">TP</abbr> ladder. Then, an <abbr title="Stop loss">SL</abbr> step was hit and removed 33.3% of the initial position, as there are three steps in the <abbr title="Stop loss">SL</abbr> ladder. The final step then removed the rest of the position. But what if your intention is to exit according to the current position size and not the initial one? If the position changes suddenly, the exit sizes will be redistributed based on this change. This can be achieved by providing the <code>StopLadderMode.AdaptUniform</code> or <code>StopLadderMode.AdaptWeighted</code> mode:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-100-1><a id=__codelineno-100-1 name=__codelineno-100-1 href=#__codelineno-100-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-100-2><a id=__codelineno-100-2 name=__codelineno-100-2 href=#__codelineno-100-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-100-3><a id=__codelineno-100-3 name=__codelineno-100-3 href=#__codelineno-100-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-100-4><a id=__codelineno-100-4 name=__codelineno-100-4 href=#__codelineno-100-4></a><span class=gp>... </span>    <span class=n>stop_ladder</span><span class=o>=</span><span class=s2>&quot;adaptuniform&quot;</span><span class=p>,</span>
</span><span id=__span-100-5><a id=__codelineno-100-5 name=__codelineno-100-5 href=#__codelineno-100-5></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=p>[</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>],</span>
</span><span id=__span-100-6><a id=__codelineno-100-6 name=__codelineno-100-6 href=#__codelineno-100-6></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=p>[</span><span class=mf>0.05</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.15</span><span class=p>]</span>
</span><span id=__span-100-7><a id=__codelineno-100-7 name=__codelineno-100-7 href=#__codelineno-100-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-100-8><a id=__codelineno-100-8 name=__codelineno-100-8 href=#__codelineno-100-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>stop_type</span><span class=o>.</span><span class=n>to_pd</span><span class=p>(</span><span class=n>mapping</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-100-9><a id=__codelineno-100-9 name=__codelineno-100-9 href=#__codelineno-100-9></a><span class=go>symbol                    BTCUSDT ETHUSDT</span>
</span><span id=__span-100-10><a id=__codelineno-100-10 name=__codelineno-100-10 href=#__codelineno-100-10></a><span class=go>Open time                                </span>
</span><span id=__span-100-11><a id=__codelineno-100-11 name=__codelineno-100-11 href=#__codelineno-100-11></a><span class=go>2021-02-18 00:00:00+00:00    None    None</span>
</span><span id=__span-100-12><a id=__codelineno-100-12 name=__codelineno-100-12 href=#__codelineno-100-12></a><span class=go>2021-02-19 00:00:00+00:00    None    None</span>
</span><span id=__span-100-13><a id=__codelineno-100-13 name=__codelineno-100-13 href=#__codelineno-100-13></a><span class=go>2021-02-20 00:00:00+00:00      TP      SL</span>
</span><span id=__span-100-14><a id=__codelineno-100-14 name=__codelineno-100-14 href=#__codelineno-100-14></a><span class=go>2021-02-21 00:00:00+00:00    None    None</span>
</span><span id=__span-100-15><a id=__codelineno-100-15 name=__codelineno-100-15 href=#__codelineno-100-15></a><span class=go>2021-02-22 00:00:00+00:00      SL      SL</span>
</span><span id=__span-100-16><a id=__codelineno-100-16 name=__codelineno-100-16 href=#__codelineno-100-16></a><span class=go>2021-02-23 00:00:00+00:00      SL      SL</span>
</span><span id=__span-100-17><a id=__codelineno-100-17 name=__codelineno-100-17 href=#__codelineno-100-17></a><span class=go>2021-02-24 00:00:00+00:00    None    None</span>
</span><span id=__span-100-18><a id=__codelineno-100-18 name=__codelineno-100-18 href=#__codelineno-100-18></a>
</span><span id=__span-100-19><a id=__codelineno-100-19 name=__codelineno-100-19 href=#__codelineno-100-19></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-100-20><a id=__codelineno-100-20 name=__codelineno-100-20 href=#__codelineno-100-20></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-100-21><a id=__codelineno-100-21 name=__codelineno-100-21 href=#__codelineno-100-21></a><span class=go>Open time                                    </span>
</span><span id=__span-100-22><a id=__codelineno-100-22 name=__codelineno-100-22 href=#__codelineno-100-22></a><span class=go>2021-02-18 00:00:00+00:00  0.001940  0.051557</span>
</span><span id=__span-100-23><a id=__codelineno-100-23 name=__codelineno-100-23 href=#__codelineno-100-23></a><span class=go>2021-02-19 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-100-24><a id=__codelineno-100-24 name=__codelineno-100-24 href=#__codelineno-100-24></a><span class=go>2021-02-20 00:00:00+00:00 -0.000970 -0.017186</span>
</span><span id=__span-100-25><a id=__codelineno-100-25 name=__codelineno-100-25 href=#__codelineno-100-25></a><span class=go>2021-02-21 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-100-26><a id=__codelineno-100-26 name=__codelineno-100-26 href=#__codelineno-100-26></a><span class=go>2021-02-22 00:00:00+00:00 -0.000323 -0.017186</span>
</span><span id=__span-100-27><a id=__codelineno-100-27 name=__codelineno-100-27 href=#__codelineno-100-27></a><span class=go>2021-02-23 00:00:00+00:00 -0.000323 -0.017186</span>
</span><span id=__span-100-28><a id=__codelineno-100-28 name=__codelineno-100-28 href=#__codelineno-100-28></a><span class=go>2021-02-24 00:00:00+00:00  0.000000  0.000000</span>
</span></code></pre></div> <p>Both <abbr title="Stop loss">SL</abbr> steps in the first column now remove exactly <code>1 / 3</code> of the new position and act as if they were created right after the position changed due to the first <abbr title="Take profit">TP</abbr> step.</p> <p>Now, let's illustrate how to specify a different ladder for a different column. To do this, we need to construct a two-dimensional array. Since some ladders may have fewer steps than others, we need to pad them with NaN:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-101-1><a id=__codelineno-101-1 name=__codelineno-101-1 href=#__codelineno-101-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-101-2><a id=__codelineno-101-2 name=__codelineno-101-2 href=#__codelineno-101-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-101-3><a id=__codelineno-101-3 name=__codelineno-101-3 href=#__codelineno-101-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-101-4><a id=__codelineno-101-4 name=__codelineno-101-4 href=#__codelineno-101-4></a><span class=gp>... </span>    <span class=n>stop_ladder</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-101-5><a id=__codelineno-101-5 name=__codelineno-101-5 href=#__codelineno-101-5></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>column_stack</span><span class=p>((</span>
</span><span id=__span-101-6><a id=__codelineno-101-6 name=__codelineno-101-6 href=#__codelineno-101-6></a><span class=gp>... </span>        <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>]),</span>  <span class=c1># (1)!</span>
</span><span id=__span-101-7><a id=__codelineno-101-7 name=__codelineno-101-7 href=#__codelineno-101-7></a><span class=gp>... </span>        <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mf>0.01</span><span class=p>,</span> <span class=mf>0.02</span><span class=p>,</span> <span class=mf>0.03</span><span class=p>])</span>  <span class=c1># (2)!</span>
</span><span id=__span-101-8><a id=__codelineno-101-8 name=__codelineno-101-8 href=#__codelineno-101-8></a><span class=gp>... </span>    <span class=p>))</span>
</span><span id=__span-101-9><a id=__codelineno-101-9 name=__codelineno-101-9 href=#__codelineno-101-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-101-10><a id=__codelineno-101-10 name=__codelineno-101-10 href=#__codelineno-101-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-101-11><a id=__codelineno-101-11 name=__codelineno-101-11 href=#__codelineno-101-11></a><span class=go>symbol                     BTCUSDT   ETHUSDT</span>
</span><span id=__span-101-12><a id=__codelineno-101-12 name=__codelineno-101-12 href=#__codelineno-101-12></a><span class=go>Open time                                   </span>
</span><span id=__span-101-13><a id=__codelineno-101-13 name=__codelineno-101-13 href=#__codelineno-101-13></a><span class=go>2021-02-18 00:00:00+00:00  0.00194  0.051557</span>
</span><span id=__span-101-14><a id=__codelineno-101-14 name=__codelineno-101-14 href=#__codelineno-101-14></a><span class=go>2021-02-19 00:00:00+00:00  0.00000 -0.017186</span>
</span><span id=__span-101-15><a id=__codelineno-101-15 name=__codelineno-101-15 href=#__codelineno-101-15></a><span class=go>2021-02-20 00:00:00+00:00 -0.00097 -0.017186</span>
</span><span id=__span-101-16><a id=__codelineno-101-16 name=__codelineno-101-16 href=#__codelineno-101-16></a><span class=go>2021-02-21 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-101-17><a id=__codelineno-101-17 name=__codelineno-101-17 href=#__codelineno-101-17></a><span class=go>2021-02-22 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-101-18><a id=__codelineno-101-18 name=__codelineno-101-18 href=#__codelineno-101-18></a><span class=go>2021-02-23 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-101-19><a id=__codelineno-101-19 name=__codelineno-101-19 href=#__codelineno-101-19></a><span class=go>2021-02-24 00:00:00+00:00  0.00000  0.000000</span>
</span></code></pre></div> <ol> <li>Gets applied on <code>BTCUSDT</code>.</li> <li>Gets applied on <code>ETHUSDT</code>.</li> </ol> <p>Padding would not be necessary if we provided the ladders as parameters:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-102-1><a id=__codelineno-102-1 name=__codelineno-102-1 href=#__codelineno-102-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-102-2><a id=__codelineno-102-2 name=__codelineno-102-2 href=#__codelineno-102-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-102-3><a id=__codelineno-102-3 name=__codelineno-102-3 href=#__codelineno-102-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-102-4><a id=__codelineno-102-4 name=__codelineno-102-4 href=#__codelineno-102-4></a><span class=gp>... </span>    <span class=n>stop_ladder</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-102-5><a id=__codelineno-102-5 name=__codelineno-102-5 href=#__codelineno-102-5></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span>
</span><span id=__span-102-6><a id=__codelineno-102-6 name=__codelineno-102-6 href=#__codelineno-102-6></a><span class=gp>... </span>        <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>]),</span>  <span class=c1># (1)!</span>
</span><span id=__span-102-7><a id=__codelineno-102-7 name=__codelineno-102-7 href=#__codelineno-102-7></a><span class=gp>... </span>        <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mf>0.01</span><span class=p>,</span> <span class=mf>0.02</span><span class=p>,</span> <span class=mf>0.03</span><span class=p>])</span>  <span class=c1># (2)!</span>
</span><span id=__span-102-8><a id=__codelineno-102-8 name=__codelineno-102-8 href=#__codelineno-102-8></a><span class=gp>... </span>    <span class=p>])</span>
</span><span id=__span-102-9><a id=__codelineno-102-9 name=__codelineno-102-9 href=#__codelineno-102-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-102-10><a id=__codelineno-102-10 name=__codelineno-102-10 href=#__codelineno-102-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-102-11><a id=__codelineno-102-11 name=__codelineno-102-11 href=#__codelineno-102-11></a><span class=go>tp_stop                    array_0             array_1          </span>
</span><span id=__span-102-12><a id=__codelineno-102-12 name=__codelineno-102-12 href=#__codelineno-102-12></a><span class=go>symbol                     BTCUSDT   ETHUSDT   BTCUSDT   ETHUSDT</span>
</span><span id=__span-102-13><a id=__codelineno-102-13 name=__codelineno-102-13 href=#__codelineno-102-13></a><span class=go>Open time                                                       </span>
</span><span id=__span-102-14><a id=__codelineno-102-14 name=__codelineno-102-14 href=#__codelineno-102-14></a><span class=go>2021-02-18 00:00:00+00:00  0.00194  0.051557  0.001940  0.051557</span>
</span><span id=__span-102-15><a id=__codelineno-102-15 name=__codelineno-102-15 href=#__codelineno-102-15></a><span class=go>2021-02-19 00:00:00+00:00  0.00000  0.000000 -0.000647 -0.017186</span>
</span><span id=__span-102-16><a id=__codelineno-102-16 name=__codelineno-102-16 href=#__codelineno-102-16></a><span class=go>2021-02-20 00:00:00+00:00 -0.00097  0.000000 -0.000647 -0.017186</span>
</span><span id=__span-102-17><a id=__codelineno-102-17 name=__codelineno-102-17 href=#__codelineno-102-17></a><span class=go>2021-02-21 00:00:00+00:00  0.00000  0.000000 -0.000647  0.000000</span>
</span><span id=__span-102-18><a id=__codelineno-102-18 name=__codelineno-102-18 href=#__codelineno-102-18></a><span class=go>2021-02-22 00:00:00+00:00  0.00000  0.000000  0.000000  0.000000</span>
</span><span id=__span-102-19><a id=__codelineno-102-19 name=__codelineno-102-19 href=#__codelineno-102-19></a><span class=go>2021-02-23 00:00:00+00:00  0.00000  0.000000  0.000000  0.000000</span>
</span><span id=__span-102-20><a id=__codelineno-102-20 name=__codelineno-102-20 href=#__codelineno-102-20></a><span class=go>2021-02-24 00:00:00+00:00  0.00000  0.000000  0.000000  0.000000</span>
</span></code></pre></div> <ol> <li>Gets applied on both columns.</li> <li>Gets applied on both columns.</li> </ol> <p>Finally, let's discuss how to specify your own exit size for each ladder step. Since there are no arguments for specifying the exit size, you need to modify it inside an adjustment or signal function. Remember to use an adjustment function if you already have signal arrays, and a signal function if you generate your signals dynamically. Inside the callback, you need to 1) retrieve the current information record of the stop type for which you have defined the ladder, 2) select the exit size corresponding to the current step (available via the record field <code>step</code>), and 3) write the exit size to the record. Once the step is hit, your user-defined exit size will be used instead of the default.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>The default size and size type in any record are NaN and -1, respectively. Only once the step is hit will these be internally replaced by the calculated values. Therefore, you can check whether the ladder uses the default exit size by testing these fields against these values.</p> </div> <p>In the following example, we enter a trade with 6 units and then test two <abbr title="Take profit">TP</abbr> ladders:</p> <ol> <li>Remove 3 units at the 10% level and the remaining 3 units at the 20% level.</li> <li>Remove 1 unit at the 1% level, another 2 units at the 2% level, and the remaining 3 units at the 3% level.</li> </ol> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-103-1><a id=__codelineno-103-1 name=__codelineno-103-1 href=#__codelineno-103-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-103-2><a id=__codelineno-103-2 name=__codelineno-103-2 href=#__codelineno-103-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>adjust_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>exit_size</span><span class=p>,</span> <span class=n>exit_size_type</span><span class=p>):</span>
</span><span id=__span-103-3><a id=__codelineno-103-3 name=__codelineno-103-3 href=#__codelineno-103-3></a><span class=gp>... </span>    <span class=n>tp_info</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_tp_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-103-4><a id=__codelineno-103-4 name=__codelineno-103-4 href=#__codelineno-103-4></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>is_stop_info_ladder_active_nb</span><span class=p>(</span><span class=n>tp_info</span><span class=p>):</span>  <span class=c1># (1)!</span>
</span><span id=__span-103-5><a id=__codelineno-103-5 name=__codelineno-103-5 href=#__codelineno-103-5></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>tp_info</span><span class=o>.</span><span class=n>exit_size</span><span class=p>):</span>  <span class=c1># (2)!</span>
</span><span id=__span-103-6><a id=__codelineno-103-6 name=__codelineno-103-6 href=#__codelineno-103-6></a><span class=gp>... </span>            <span class=n>tp_info</span><span class=o>.</span><span class=n>exit_size</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>exit_size</span><span class=p>,</span> <span class=n>i</span><span class=o>=</span><span class=n>tp_info</span><span class=o>.</span><span class=n>step</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-103-7><a id=__codelineno-103-7 name=__codelineno-103-7 href=#__codelineno-103-7></a><span class=gp>... </span>            <span class=n>tp_info</span><span class=o>.</span><span class=n>exit_size_type</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>exit_size_type</span><span class=p>,</span> <span class=n>i</span><span class=o>=</span><span class=n>tp_info</span><span class=o>.</span><span class=n>step</span><span class=p>)</span>
</span><span id=__span-103-8><a id=__codelineno-103-8 name=__codelineno-103-8 href=#__codelineno-103-8></a>
</span><span id=__span-103-9><a id=__codelineno-103-9 name=__codelineno-103-9 href=#__codelineno-103-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-103-10><a id=__codelineno-103-10 name=__codelineno-103-10 href=#__codelineno-103-10></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-103-11><a id=__codelineno-103-11 name=__codelineno-103-11 href=#__codelineno-103-11></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-103-12><a id=__codelineno-103-12 name=__codelineno-103-12 href=#__codelineno-103-12></a><span class=gp>... </span>    <span class=n>adjust_func_nb</span><span class=o>=</span><span class=n>adjust_func_nb</span><span class=p>,</span>
</span><span id=__span-103-13><a id=__codelineno-103-13 name=__codelineno-103-13 href=#__codelineno-103-13></a><span class=gp>... </span>    <span class=n>adjust_args</span><span class=o>=</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;exit_size&quot;</span><span class=p>),</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;exit_size_type&quot;</span><span class=p>)),</span>  <span class=c1># (4)!</span>
</span><span id=__span-103-14><a id=__codelineno-103-14 name=__codelineno-103-14 href=#__codelineno-103-14></a><span class=gp>... </span>    <span class=n>stop_ladder</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-103-15><a id=__codelineno-103-15 name=__codelineno-103-15 href=#__codelineno-103-15></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span>
</span><span id=__span-103-16><a id=__codelineno-103-16 name=__codelineno-103-16 href=#__codelineno-103-16></a><span class=gp>... </span>        <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>]),</span>
</span><span id=__span-103-17><a id=__codelineno-103-17 name=__codelineno-103-17 href=#__codelineno-103-17></a><span class=gp>... </span>        <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mf>0.01</span><span class=p>,</span> <span class=mf>0.02</span><span class=p>,</span> <span class=mf>0.03</span><span class=p>])</span>
</span><span id=__span-103-18><a id=__codelineno-103-18 name=__codelineno-103-18 href=#__codelineno-103-18></a><span class=gp>... </span>    <span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=mi>0</span><span class=p>),</span>  <span class=c1># (5)!</span>
</span><span id=__span-103-19><a id=__codelineno-103-19 name=__codelineno-103-19 href=#__codelineno-103-19></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-103-20><a id=__codelineno-103-20 name=__codelineno-103-20 href=#__codelineno-103-20></a><span class=gp>... </span>        <span class=n>exit_size</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>BCO</span><span class=p>(</span>  <span class=c1># (6)!</span>
</span><span id=__span-103-21><a id=__codelineno-103-21 name=__codelineno-103-21 href=#__codelineno-103-21></a><span class=gp>... </span>            <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span>
</span><span id=__span-103-22><a id=__codelineno-103-22 name=__codelineno-103-22 href=#__codelineno-103-22></a><span class=gp>... </span>                <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>]),</span>
</span><span id=__span-103-23><a id=__codelineno-103-23 name=__codelineno-103-23 href=#__codelineno-103-23></a><span class=gp>... </span>                <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>])</span>
</span><span id=__span-103-24><a id=__codelineno-103-24 name=__codelineno-103-24 href=#__codelineno-103-24></a><span class=gp>... </span>            <span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>hide</span><span class=o>=</span><span class=kc>True</span><span class=p>),</span>  <span class=c1># (7)!</span>
</span><span id=__span-103-25><a id=__codelineno-103-25 name=__codelineno-103-25 href=#__codelineno-103-25></a><span class=gp>... </span>            <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span><span id=__span-103-26><a id=__codelineno-103-26 name=__codelineno-103-26 href=#__codelineno-103-26></a><span class=gp>... </span>            <span class=n>merge_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>  <span class=c1># (8)!</span>
</span><span id=__span-103-27><a id=__codelineno-103-27 name=__codelineno-103-27 href=#__codelineno-103-27></a><span class=gp>... </span>                <span class=n>reset_index</span><span class=o>=</span><span class=s2>&quot;from_start&quot;</span><span class=p>,</span> 
</span><span id=__span-103-28><a id=__codelineno-103-28 name=__codelineno-103-28 href=#__codelineno-103-28></a><span class=gp>... </span>                <span class=n>fill_value</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-103-29><a id=__codelineno-103-29 name=__codelineno-103-29 href=#__codelineno-103-29></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-103-30><a id=__codelineno-103-30 name=__codelineno-103-30 href=#__codelineno-103-30></a><span class=gp>... </span>        <span class=p>),</span>
</span><span id=__span-103-31><a id=__codelineno-103-31 name=__codelineno-103-31 href=#__codelineno-103-31></a><span class=gp>... </span>        <span class=n>exit_size_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>BCO</span><span class=p>(</span>
</span><span id=__span-103-32><a id=__codelineno-103-32 name=__codelineno-103-32 href=#__codelineno-103-32></a><span class=gp>... </span>            <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>SizeType</span><span class=o>.</span><span class=n>Amount</span><span class=p>,</span>  <span class=c1># (9)!</span>
</span><span id=__span-103-33><a id=__codelineno-103-33 name=__codelineno-103-33 href=#__codelineno-103-33></a><span class=gp>... </span>            <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span><span id=__span-103-34><a id=__codelineno-103-34 name=__codelineno-103-34 href=#__codelineno-103-34></a><span class=gp>... </span>            <span class=n>merge_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-103-35><a id=__codelineno-103-35 name=__codelineno-103-35 href=#__codelineno-103-35></a><span class=gp>... </span>                <span class=n>reset_index</span><span class=o>=</span><span class=s2>&quot;from_start&quot;</span><span class=p>,</span> 
</span><span id=__span-103-36><a id=__codelineno-103-36 name=__codelineno-103-36 href=#__codelineno-103-36></a><span class=gp>... </span>                <span class=n>fill_value</span><span class=o>=-</span><span class=mi>1</span><span class=p>,</span>
</span><span id=__span-103-37><a id=__codelineno-103-37 name=__codelineno-103-37 href=#__codelineno-103-37></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-103-38><a id=__codelineno-103-38 name=__codelineno-103-38 href=#__codelineno-103-38></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-103-39><a id=__codelineno-103-39 name=__codelineno-103-39 href=#__codelineno-103-39></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-103-40><a id=__codelineno-103-40 name=__codelineno-103-40 href=#__codelineno-103-40></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mi>6</span><span class=p>,</span>
</span><span id=__span-103-41><a id=__codelineno-103-41 name=__codelineno-103-41 href=#__codelineno-103-41></a><span class=gp>... </span>    <span class=n>init_cash</span><span class=o>=</span><span class=s2>&quot;auto&quot;</span>
</span><span id=__span-103-42><a id=__codelineno-103-42 name=__codelineno-103-42 href=#__codelineno-103-42></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-103-43><a id=__codelineno-103-43 name=__codelineno-103-43 href=#__codelineno-103-43></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-103-44><a id=__codelineno-103-44 name=__codelineno-103-44 href=#__codelineno-103-44></a><span class=go>tp_stop                   array_0         array_1        </span>
</span><span id=__span-103-45><a id=__codelineno-103-45 name=__codelineno-103-45 href=#__codelineno-103-45></a><span class=go>symbol                    BTCUSDT ETHUSDT BTCUSDT ETHUSDT</span>
</span><span id=__span-103-46><a id=__codelineno-103-46 name=__codelineno-103-46 href=#__codelineno-103-46></a><span class=go>Open time                                                </span>
</span><span id=__span-103-47><a id=__codelineno-103-47 name=__codelineno-103-47 href=#__codelineno-103-47></a><span class=go>2021-02-18 00:00:00+00:00     6.0     6.0     6.0     6.0</span>
</span><span id=__span-103-48><a id=__codelineno-103-48 name=__codelineno-103-48 href=#__codelineno-103-48></a><span class=go>2021-02-19 00:00:00+00:00     0.0     0.0    -1.0    -1.0</span>
</span><span id=__span-103-49><a id=__codelineno-103-49 name=__codelineno-103-49 href=#__codelineno-103-49></a><span class=go>2021-02-20 00:00:00+00:00    -3.0     0.0    -2.0    -2.0</span>
</span><span id=__span-103-50><a id=__codelineno-103-50 name=__codelineno-103-50 href=#__codelineno-103-50></a><span class=go>2021-02-21 00:00:00+00:00     0.0     0.0    -3.0     0.0</span>
</span><span id=__span-103-51><a id=__codelineno-103-51 name=__codelineno-103-51 href=#__codelineno-103-51></a><span class=go>2021-02-22 00:00:00+00:00     0.0     0.0     0.0     0.0</span>
</span><span id=__span-103-52><a id=__codelineno-103-52 name=__codelineno-103-52 href=#__codelineno-103-52></a><span class=go>2021-02-23 00:00:00+00:00     0.0     0.0     0.0     0.0</span>
</span><span id=__span-103-53><a id=__codelineno-103-53 name=__codelineno-103-53 href=#__codelineno-103-53></a><span class=go>2021-02-24 00:00:00+00:00     0.0     0.0     0.0     0.0</span>
</span></code></pre></div> <ol> <li>Check whether the <abbr title="Take profit">TP</abbr> ladder is active using <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.is_stop_info_ladder_active_nb>is_stop_info_ladder_active_nb</a>.</li> <li>We want to override the exit size and type only once per step. If the exit size is not NaN, then it has already been overridden.</li> <li>Because the exit size and type arrays at least partially broadcast to the target shape, we can use <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/iter_/#vectorbtpro.portfolio.nb.iter_.select_nb>select_nb</a> by providing the current step as <code>i</code>.</li> <li>Exit size and type are passed to <code>broadcast_named_args</code>. These templates are then replaced by the actual arrays once broadcasting is complete.</li> <li>Specify the same level to avoid building the product between <code>tp_stop</code>, <code>exit_size</code>, and <code>exit_size_type</code>. This way, the three parameters are treated as a single parameter.</li> <li>Exit size and type must broadcast in the same way as our ladders, so we use <a href=https://vectorbt.pro/pvt_41531c19/api/base/reshaping/#vectorbtpro.base.reshaping.BCO>BCO</a> to change the default behavior.</li> <li>The exit size should be provided in the same manner as <code>tp_stop</code>. Additionally, we hide the parameter from the final columns since it is redundant.</li> <li>These keyword arguments are needed if parameter arrays have different shapes. In this case, smaller arrays are padded with NaN to match the length of the longest array.</li> <li>In our example, the size type is the same for all sizes, so we can use a single value here.</li> </ol> <h3 id=dynamic>Dynamic<a class=headerlink href=#dynamic title="Permanent link">&para;</a></h3> <p>We have learned that order-related arguments such as <code>size</code> serve as a facade for the backtesting process with <abbr title="From-signals simulation method">FS</abbr>. They are designed to be anchored by time rather than signals, so we cannot change them dynamically. This is demonstrated by the fact that any signal function (<code>signal_func_nb</code>) returns only signals and nothing else. But what if a signal needs to have a size or other order information different from the default?</p> <p>Remember that VBT takes order information as arrays and processes them iteratively. It goes through each row and column, reads the current element, and uses this element along with the returned signals. In theory, if we override the current element in the signal function, VBT should pick it up and use it as the new order information. The only question is how to access the respective array if the context (<code>c</code>) does not list it. To do this, use templates! For example, by passing <code>vbt.Rep("size")</code> in <code>signal_args</code>, the method will look for a variable named <code>size</code> in its template context and pass it to the signal function. Conveniently, the template context contains all the information passed to the method, including the order-related arguments.</p> <p>However, there is a catch: to avoid using too much memory, VBT keeps most array-like arguments as two-dimensional arrays with only one element and uses flexible indexing (see <a href=https://vectorbt.pro/pvt_41531c19/documentation/fundamentals/#flexible-indexing>this</a> and <a href=https://vectorbt.pro/pvt_41531c19/documentation/portfolio/#flexible-indexing>this</a>) to select that one element for each row and column. That means we either have to tell the broadcaster to build the full array and then override each element (<code>arr[c.i, c.col] = ...</code>), which is wasteful but could be useful if you also need to keep track of all values used previously. Or, we can create an array with only one element per column and override only that element (<code>arr[0, c.col] = ...</code>) so VBT uses flexible indexing.</p> <p>Let's demonstrate both approaches by buying $10 worth of units when a long signal occurs and selling $5 worth of units when a short signal occurs. Here is the first approach using a full-sized array:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-104-1><a id=__codelineno-104-1 name=__codelineno-104-1 href=#__codelineno-104-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-104-2><a id=__codelineno-104-2 name=__codelineno-104-2 href=#__codelineno-104-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>long_signals</span><span class=p>,</span> <span class=n>short_signals</span><span class=p>,</span> <span class=n>size</span><span class=p>):</span>
</span><span id=__span-104-3><a id=__codelineno-104-3 name=__codelineno-104-3 href=#__codelineno-104-3></a><span class=gp>... </span>    <span class=n>long_signal</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>long_signals</span><span class=p>)</span>
</span><span id=__span-104-4><a id=__codelineno-104-4 name=__codelineno-104-4 href=#__codelineno-104-4></a><span class=gp>... </span>    <span class=n>short_signal</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>short_signals</span><span class=p>)</span>
</span><span id=__span-104-5><a id=__codelineno-104-5 name=__codelineno-104-5 href=#__codelineno-104-5></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>long_signal</span><span class=p>:</span>
</span><span id=__span-104-6><a id=__codelineno-104-6 name=__codelineno-104-6 href=#__codelineno-104-6></a><span class=gp>... </span>        <span class=n>size</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=mi>10</span>  <span class=c1># (1)!</span>
</span><span id=__span-104-7><a id=__codelineno-104-7 name=__codelineno-104-7 href=#__codelineno-104-7></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>short_signal</span><span class=p>:</span>
</span><span id=__span-104-8><a id=__codelineno-104-8 name=__codelineno-104-8 href=#__codelineno-104-8></a><span class=gp>... </span>        <span class=n>size</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=mi>5</span>
</span><span id=__span-104-9><a id=__codelineno-104-9 name=__codelineno-104-9 href=#__codelineno-104-9></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>long_signal</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=n>short_signal</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-104-10><a id=__codelineno-104-10 name=__codelineno-104-10 href=#__codelineno-104-10></a>
</span><span id=__span-104-11><a id=__codelineno-104-11 name=__codelineno-104-11 href=#__codelineno-104-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-104-12><a id=__codelineno-104-12 name=__codelineno-104-12 href=#__codelineno-104-12></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-104-13><a id=__codelineno-104-13 name=__codelineno-104-13 href=#__codelineno-104-13></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-104-14><a id=__codelineno-104-14 name=__codelineno-104-14 href=#__codelineno-104-14></a><span class=gp>... </span>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-104-15><a id=__codelineno-104-15 name=__codelineno-104-15 href=#__codelineno-104-15></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;long_signals&quot;</span><span class=p>),</span>
</span><span id=__span-104-16><a id=__codelineno-104-16 name=__codelineno-104-16 href=#__codelineno-104-16></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;short_signals&quot;</span><span class=p>),</span>
</span><span id=__span-104-17><a id=__codelineno-104-17 name=__codelineno-104-17 href=#__codelineno-104-17></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;size&quot;</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-104-18><a id=__codelineno-104-18 name=__codelineno-104-18 href=#__codelineno-104-18></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-104-19><a id=__codelineno-104-19 name=__codelineno-104-19 href=#__codelineno-104-19></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;np.full(wrapper.shape_2d, np.nan)&quot;</span><span class=p>),</span>  <span class=c1># (3)!</span>
</span><span id=__span-104-20><a id=__codelineno-104-20 name=__codelineno-104-20 href=#__codelineno-104-20></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;value&quot;</span><span class=p>,</span>
</span><span id=__span-104-21><a id=__codelineno-104-21 name=__codelineno-104-21 href=#__codelineno-104-21></a><span class=gp>... </span>    <span class=n>accumulate</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-104-22><a id=__codelineno-104-22 name=__codelineno-104-22 href=#__codelineno-104-22></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-104-23><a id=__codelineno-104-23 name=__codelineno-104-23 href=#__codelineno-104-23></a><span class=gp>... </span>        <span class=n>long_signals</span><span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-104-24><a id=__codelineno-104-24 name=__codelineno-104-24 href=#__codelineno-104-24></a><span class=gp>... </span>        <span class=n>short_signals</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>]),</span>
</span><span id=__span-104-25><a id=__codelineno-104-25 name=__codelineno-104-25 href=#__codelineno-104-25></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-104-26><a id=__codelineno-104-26 name=__codelineno-104-26 href=#__codelineno-104-26></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-104-27><a id=__codelineno-104-27 name=__codelineno-104-27 href=#__codelineno-104-27></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>value</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-104-28><a id=__codelineno-104-28 name=__codelineno-104-28 href=#__codelineno-104-28></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-104-29><a id=__codelineno-104-29 name=__codelineno-104-29 href=#__codelineno-104-29></a><span class=go>Open time                                  </span>
</span><span id=__span-104-30><a id=__codelineno-104-30 name=__codelineno-104-30 href=#__codelineno-104-30></a><span class=go>2021-02-18 00:00:00+00:00     10.0     10.0</span>
</span><span id=__span-104-31><a id=__codelineno-104-31 name=__codelineno-104-31 href=#__codelineno-104-31></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-104-32><a id=__codelineno-104-32 name=__codelineno-104-32 href=#__codelineno-104-32></a><span class=go>2021-02-20 00:00:00+00:00     -5.0     -5.0</span>
</span><span id=__span-104-33><a id=__codelineno-104-33 name=__codelineno-104-33 href=#__codelineno-104-33></a><span class=go>2021-02-21 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-104-34><a id=__codelineno-104-34 name=__codelineno-104-34 href=#__codelineno-104-34></a><span class=go>2021-02-22 00:00:00+00:00     10.0     10.0</span>
</span><span id=__span-104-35><a id=__codelineno-104-35 name=__codelineno-104-35 href=#__codelineno-104-35></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-104-36><a id=__codelineno-104-36 name=__codelineno-104-36 href=#__codelineno-104-36></a><span class=go>2021-02-24 00:00:00+00:00     -5.0     -5.0</span>
</span></code></pre></div> <ol> <li>Set the value under the current row and column to be picked by VBT.</li> <li>Forward the <code>size</code> array we built below to the signal function using templates.</li> <li>With this template, we can delay the creation of the array until the target shape is known (that is, after broadcasting all arrays), which is available via <code>wrapper.shape</code>.</li> </ol> <div class="admonition example"> <p class=admonition-title>Example</p> <p>Can we access the filled array after the simulation? Yes! The trick is to create an empty dictionary, pass it to the template, and save the created array to the dictionary inside the template expression:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-105-1><a id=__codelineno-105-1 name=__codelineno-105-1 href=#__codelineno-105-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>memory</span> <span class=o>=</span> <span class=p>{}</span>
</span><span id=__span-105-2><a id=__codelineno-105-2 name=__codelineno-105-2 href=#__codelineno-105-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-105-3><a id=__codelineno-105-3 name=__codelineno-105-3 href=#__codelineno-105-3></a><span class=gp>... </span>    <span class=c1># ...</span>
</span><span id=__span-105-4><a id=__codelineno-105-4 name=__codelineno-105-4 href=#__codelineno-105-4></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;&quot;&quot;</span>
</span><span id=__span-105-5><a id=__codelineno-105-5 name=__codelineno-105-5 href=#__codelineno-105-5></a><span class=gp>... </span><span class=s2>        size = np.full(wrapper.shape_2d, np.nan)</span>
</span><span id=__span-105-6><a id=__codelineno-105-6 name=__codelineno-105-6 href=#__codelineno-105-6></a><span class=gp>... </span><span class=s2>        memory[&quot;size&quot;] = size</span>
</span><span id=__span-105-7><a id=__codelineno-105-7 name=__codelineno-105-7 href=#__codelineno-105-7></a><span class=gp>... </span><span class=s2>        return size</span>
</span><span id=__span-105-8><a id=__codelineno-105-8 name=__codelineno-105-8 href=#__codelineno-105-8></a><span class=gp>... </span><span class=s2>        &quot;&quot;&quot;</span><span class=p>,</span>
</span><span id=__span-105-9><a id=__codelineno-105-9 name=__codelineno-105-9 href=#__codelineno-105-9></a><span class=gp>... </span>        <span class=n>context</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>memory</span><span class=o>=</span><span class=n>memory</span><span class=p>),</span>  <span class=c1># (1)!</span>
</span><span id=__span-105-10><a id=__codelineno-105-10 name=__codelineno-105-10 href=#__codelineno-105-10></a><span class=gp>... </span>        <span class=n>context_merge_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>nested</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-105-11><a id=__codelineno-105-11 name=__codelineno-105-11 href=#__codelineno-105-11></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-105-12><a id=__codelineno-105-12 name=__codelineno-105-12 href=#__codelineno-105-12></a><span class=gp>... </span>    <span class=c1># ...</span>
</span><span id=__span-105-13><a id=__codelineno-105-13 name=__codelineno-105-13 href=#__codelineno-105-13></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-105-14><a id=__codelineno-105-14 name=__codelineno-105-14 href=#__codelineno-105-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>memory</span><span class=p>[</span><span class=s2>&quot;size&quot;</span><span class=p>]</span>
</span><span id=__span-105-15><a id=__codelineno-105-15 name=__codelineno-105-15 href=#__codelineno-105-15></a><span class=go>[[10. 10.]</span>
</span><span id=__span-105-16><a id=__codelineno-105-16 name=__codelineno-105-16 href=#__codelineno-105-16></a><span class=go> [nan nan]</span>
</span><span id=__span-105-17><a id=__codelineno-105-17 name=__codelineno-105-17 href=#__codelineno-105-17></a><span class=go> [ 5.  5.]</span>
</span><span id=__span-105-18><a id=__codelineno-105-18 name=__codelineno-105-18 href=#__codelineno-105-18></a><span class=go> [nan nan]</span>
</span><span id=__span-105-19><a id=__codelineno-105-19 name=__codelineno-105-19 href=#__codelineno-105-19></a><span class=go> [10. 10.]</span>
</span><span id=__span-105-20><a id=__codelineno-105-20 name=__codelineno-105-20 href=#__codelineno-105-20></a><span class=go> [nan nan]</span>
</span><span id=__span-105-21><a id=__codelineno-105-21 name=__codelineno-105-21 href=#__codelineno-105-21></a><span class=go> [ 5.  5.]]</span>
</span></code></pre></div> <ol> <li>Everything passed as <code>context</code> will be available as a variable in the template.</li> <li>To avoid losing the reference to the <code>memory</code> dictionary, disable nested dictionary merging when the local context is merged with the global context.</li> </ol> </div> <p>Here is the second approach using a one-element array:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-106-1><a id=__codelineno-106-1 name=__codelineno-106-1 href=#__codelineno-106-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-106-2><a id=__codelineno-106-2 name=__codelineno-106-2 href=#__codelineno-106-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>long_signals</span><span class=p>,</span> <span class=n>short_signals</span><span class=p>,</span> <span class=n>size</span><span class=p>):</span>
</span><span id=__span-106-3><a id=__codelineno-106-3 name=__codelineno-106-3 href=#__codelineno-106-3></a><span class=gp>... </span>    <span class=n>long_signal</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>long_signals</span><span class=p>)</span>
</span><span id=__span-106-4><a id=__codelineno-106-4 name=__codelineno-106-4 href=#__codelineno-106-4></a><span class=gp>... </span>    <span class=n>short_signal</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>short_signals</span><span class=p>)</span>
</span><span id=__span-106-5><a id=__codelineno-106-5 name=__codelineno-106-5 href=#__codelineno-106-5></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>long_signal</span><span class=p>:</span>
</span><span id=__span-106-6><a id=__codelineno-106-6 name=__codelineno-106-6 href=#__codelineno-106-6></a><span class=gp>... </span>        <span class=n>size</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=mi>10</span>  <span class=c1># (1)!</span>
</span><span id=__span-106-7><a id=__codelineno-106-7 name=__codelineno-106-7 href=#__codelineno-106-7></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>short_signal</span><span class=p>:</span>
</span><span id=__span-106-8><a id=__codelineno-106-8 name=__codelineno-106-8 href=#__codelineno-106-8></a><span class=gp>... </span>        <span class=n>size</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=mi>5</span>
</span><span id=__span-106-9><a id=__codelineno-106-9 name=__codelineno-106-9 href=#__codelineno-106-9></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>long_signal</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=n>short_signal</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-106-10><a id=__codelineno-106-10 name=__codelineno-106-10 href=#__codelineno-106-10></a>
</span><span id=__span-106-11><a id=__codelineno-106-11 name=__codelineno-106-11 href=#__codelineno-106-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-106-12><a id=__codelineno-106-12 name=__codelineno-106-12 href=#__codelineno-106-12></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-106-13><a id=__codelineno-106-13 name=__codelineno-106-13 href=#__codelineno-106-13></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-106-14><a id=__codelineno-106-14 name=__codelineno-106-14 href=#__codelineno-106-14></a><span class=gp>... </span>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-106-15><a id=__codelineno-106-15 name=__codelineno-106-15 href=#__codelineno-106-15></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;long_signals&quot;</span><span class=p>),</span>
</span><span id=__span-106-16><a id=__codelineno-106-16 name=__codelineno-106-16 href=#__codelineno-106-16></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;short_signals&quot;</span><span class=p>),</span>
</span><span id=__span-106-17><a id=__codelineno-106-17 name=__codelineno-106-17 href=#__codelineno-106-17></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;size&quot;</span><span class=p>)</span>
</span><span id=__span-106-18><a id=__codelineno-106-18 name=__codelineno-106-18 href=#__codelineno-106-18></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-106-19><a id=__codelineno-106-19 name=__codelineno-106-19 href=#__codelineno-106-19></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;np.full((1, wrapper.shape_2d[1]), np.nan)&quot;</span><span class=p>),</span>  <span class=c1># (2)!</span>
</span><span id=__span-106-20><a id=__codelineno-106-20 name=__codelineno-106-20 href=#__codelineno-106-20></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;value&quot;</span><span class=p>,</span>
</span><span id=__span-106-21><a id=__codelineno-106-21 name=__codelineno-106-21 href=#__codelineno-106-21></a><span class=gp>... </span>    <span class=n>accumulate</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-106-22><a id=__codelineno-106-22 name=__codelineno-106-22 href=#__codelineno-106-22></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-106-23><a id=__codelineno-106-23 name=__codelineno-106-23 href=#__codelineno-106-23></a><span class=gp>... </span>        <span class=n>long_signals</span><span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-106-24><a id=__codelineno-106-24 name=__codelineno-106-24 href=#__codelineno-106-24></a><span class=gp>... </span>        <span class=n>short_signals</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>]),</span>
</span><span id=__span-106-25><a id=__codelineno-106-25 name=__codelineno-106-25 href=#__codelineno-106-25></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-106-26><a id=__codelineno-106-26 name=__codelineno-106-26 href=#__codelineno-106-26></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-106-27><a id=__codelineno-106-27 name=__codelineno-106-27 href=#__codelineno-106-27></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>value</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-106-28><a id=__codelineno-106-28 name=__codelineno-106-28 href=#__codelineno-106-28></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-106-29><a id=__codelineno-106-29 name=__codelineno-106-29 href=#__codelineno-106-29></a><span class=go>Open time                                  </span>
</span><span id=__span-106-30><a id=__codelineno-106-30 name=__codelineno-106-30 href=#__codelineno-106-30></a><span class=go>2021-02-18 00:00:00+00:00     10.0     10.0</span>
</span><span id=__span-106-31><a id=__codelineno-106-31 name=__codelineno-106-31 href=#__codelineno-106-31></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-106-32><a id=__codelineno-106-32 name=__codelineno-106-32 href=#__codelineno-106-32></a><span class=go>2021-02-20 00:00:00+00:00     -5.0     -5.0</span>
</span><span id=__span-106-33><a id=__codelineno-106-33 name=__codelineno-106-33 href=#__codelineno-106-33></a><span class=go>2021-02-21 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-106-34><a id=__codelineno-106-34 name=__codelineno-106-34 href=#__codelineno-106-34></a><span class=go>2021-02-22 00:00:00+00:00     10.0     10.0</span>
</span><span id=__span-106-35><a id=__codelineno-106-35 name=__codelineno-106-35 href=#__codelineno-106-35></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-106-36><a id=__codelineno-106-36 name=__codelineno-106-36 href=#__codelineno-106-36></a><span class=go>2021-02-24 00:00:00+00:00     -5.0     -5.0</span>
</span></code></pre></div> <ol> <li>Since our array has only one row, VBT will pick its value for any row and column. Thus, we need to override this exact element.</li> <li>Unlike in the previous example, here we only need one row.</li> </ol> <h4 id=entry-laddering>Entry laddering<a class=headerlink href=#entry-laddering title="Permanent link">&para;</a></h4> <p>To showcase the full power of this trick, we will create a custom entry ladder! Whenever a user-defined entry signal is detected, it will be split into multiple smaller entry signals. Each of these signals will be executed after a predefined number of bars and will add a predefined percentage of resources to the current position. We will also demonstrate how to group arguments using named tuples and define custom record arrays to hold complex temporary information. Finally, we will show how to parameterize the ladder and test two completely different ladders in a single simulation.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-107-1><a id=__codelineno-107-1 name=__codelineno-107-1 href=#__codelineno-107-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>Signals</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s2>&quot;Signals&quot;</span><span class=p>,</span> <span class=p>[</span>  <span class=c1># (1)!</span>
</span><span id=__span-107-2><a id=__codelineno-107-2 name=__codelineno-107-2 href=#__codelineno-107-2></a><span class=gp>... </span>    <span class=s2>&quot;entries&quot;</span><span class=p>,</span>
</span><span id=__span-107-3><a id=__codelineno-107-3 name=__codelineno-107-3 href=#__codelineno-107-3></a><span class=gp>... </span>    <span class=s2>&quot;exits&quot;</span>
</span><span id=__span-107-4><a id=__codelineno-107-4 name=__codelineno-107-4 href=#__codelineno-107-4></a><span class=gp>... </span><span class=p>])</span>
</span><span id=__span-107-5><a id=__codelineno-107-5 name=__codelineno-107-5 href=#__codelineno-107-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>Order</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s2>&quot;Order&quot;</span><span class=p>,</span> <span class=p>[</span>  <span class=c1># (2)!</span>
</span><span id=__span-107-6><a id=__codelineno-107-6 name=__codelineno-107-6 href=#__codelineno-107-6></a><span class=gp>... </span>    <span class=s2>&quot;size&quot;</span><span class=p>,</span>
</span><span id=__span-107-7><a id=__codelineno-107-7 name=__codelineno-107-7 href=#__codelineno-107-7></a><span class=gp>... </span>    <span class=s2>&quot;size_type&quot;</span>
</span><span id=__span-107-8><a id=__codelineno-107-8 name=__codelineno-107-8 href=#__codelineno-107-8></a><span class=gp>... </span><span class=p>])</span>
</span><span id=__span-107-9><a id=__codelineno-107-9 name=__codelineno-107-9 href=#__codelineno-107-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>ladder_dt</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>dtype</span><span class=p>([</span>  <span class=c1># (3)!</span>
</span><span id=__span-107-10><a id=__codelineno-107-10 name=__codelineno-107-10 href=#__codelineno-107-10></a><span class=gp>... </span>    <span class=p>(</span><span class=s2>&quot;after_n_bars&quot;</span><span class=p>,</span> <span class=n>int_</span><span class=p>),</span>
</span><span id=__span-107-11><a id=__codelineno-107-11 name=__codelineno-107-11 href=#__codelineno-107-11></a><span class=gp>... </span>    <span class=p>(</span><span class=s2>&quot;exit_pct&quot;</span><span class=p>,</span> <span class=n>float_</span><span class=p>)</span>
</span><span id=__span-107-12><a id=__codelineno-107-12 name=__codelineno-107-12 href=#__codelineno-107-12></a><span class=gp>... </span><span class=p>])</span>
</span><span id=__span-107-13><a id=__codelineno-107-13 name=__codelineno-107-13 href=#__codelineno-107-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>ladder_info_dt</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>dtype</span><span class=p>([</span>  <span class=c1># (4)!</span>
</span><span id=__span-107-14><a id=__codelineno-107-14 name=__codelineno-107-14 href=#__codelineno-107-14></a><span class=gp>... </span>    <span class=p>(</span><span class=s2>&quot;init_idx&quot;</span><span class=p>,</span> <span class=n>int_</span><span class=p>),</span>
</span><span id=__span-107-15><a id=__codelineno-107-15 name=__codelineno-107-15 href=#__codelineno-107-15></a><span class=gp>... </span>    <span class=p>(</span><span class=s2>&quot;step&quot;</span><span class=p>,</span> <span class=n>int_</span><span class=p>)</span>
</span><span id=__span-107-16><a id=__codelineno-107-16 name=__codelineno-107-16 href=#__codelineno-107-16></a><span class=gp>... </span><span class=p>],</span> <span class=n>align</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-107-17><a id=__codelineno-107-17 name=__codelineno-107-17 href=#__codelineno-107-17></a>
</span><span id=__span-107-18><a id=__codelineno-107-18 name=__codelineno-107-18 href=#__codelineno-107-18></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>  <span class=c1># (5)!</span>
</span><span id=__span-107-19><a id=__codelineno-107-19 name=__codelineno-107-19 href=#__codelineno-107-19></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>signals</span><span class=p>,</span> <span class=n>order</span><span class=p>,</span> <span class=n>ladders</span><span class=p>,</span> <span class=n>last_ladder_info</span><span class=p>):</span>  <span class=c1># (6)!</span>
</span><span id=__span-107-20><a id=__codelineno-107-20 name=__codelineno-107-20 href=#__codelineno-107-20></a><span class=gp>... </span>    <span class=n>is_entry</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>signals</span><span class=o>.</span><span class=n>entries</span><span class=p>)</span>
</span><span id=__span-107-21><a id=__codelineno-107-21 name=__codelineno-107-21 href=#__codelineno-107-21></a><span class=gp>... </span>    <span class=n>is_exit</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>signals</span><span class=o>.</span><span class=n>exits</span><span class=p>)</span>
</span><span id=__span-107-22><a id=__codelineno-107-22 name=__codelineno-107-22 href=#__codelineno-107-22></a><span class=gp>... </span>    <span class=n>position_now</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_position</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-107-23><a id=__codelineno-107-23 name=__codelineno-107-23 href=#__codelineno-107-23></a><span class=gp>... </span>    <span class=n>ladder_info</span> <span class=o>=</span> <span class=n>last_ladder_info</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>  <span class=c1># (7)!</span>
</span><span id=__span-107-24><a id=__codelineno-107-24 name=__codelineno-107-24 href=#__codelineno-107-24></a><span class=gp>... </span>    
</span><span id=__span-107-25><a id=__codelineno-107-25 name=__codelineno-107-25 href=#__codelineno-107-25></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>position_now</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>is_exit</span><span class=p>:</span>  <span class=c1># (8)!</span>
</span><span id=__span-107-26><a id=__codelineno-107-26 name=__codelineno-107-26 href=#__codelineno-107-26></a><span class=gp>... </span>        <span class=n>ladder_info</span><span class=p>[</span><span class=s2>&quot;init_idx&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>  <span class=c1># (9)!</span>
</span><span id=__span-107-27><a id=__codelineno-107-27 name=__codelineno-107-27 href=#__codelineno-107-27></a><span class=gp>... </span>        <span class=n>ladder_info</span><span class=p>[</span><span class=s2>&quot;step&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>
</span><span id=__span-107-28><a id=__codelineno-107-28 name=__codelineno-107-28 href=#__codelineno-107-28></a><span class=gp>... </span>        <span class=n>order</span><span class=o>.</span><span class=n>size</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>inf</span>  <span class=c1># (10)!</span>
</span><span id=__span-107-29><a id=__codelineno-107-29 name=__codelineno-107-29 href=#__codelineno-107-29></a><span class=gp>... </span>        <span class=n>order</span><span class=o>.</span><span class=n>size_type</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>SizeType</span><span class=o>.</span><span class=n>Amount</span>
</span><span id=__span-107-30><a id=__codelineno-107-30 name=__codelineno-107-30 href=#__codelineno-107-30></a><span class=gp>... </span>        <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>  <span class=c1># (11)!</span>
</span><span id=__span-107-31><a id=__codelineno-107-31 name=__codelineno-107-31 href=#__codelineno-107-31></a><span class=gp>... </span>    
</span><span id=__span-107-32><a id=__codelineno-107-32 name=__codelineno-107-32 href=#__codelineno-107-32></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>is_entry</span><span class=p>:</span>  <span class=c1># (12)!</span>
</span><span id=__span-107-33><a id=__codelineno-107-33 name=__codelineno-107-33 href=#__codelineno-107-33></a><span class=gp>... </span>        <span class=n>ladder_info</span><span class=p>[</span><span class=s2>&quot;init_idx&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span>
</span><span id=__span-107-34><a id=__codelineno-107-34 name=__codelineno-107-34 href=#__codelineno-107-34></a><span class=gp>... </span>        <span class=n>ladder_info</span><span class=p>[</span><span class=s2>&quot;step&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-107-35><a id=__codelineno-107-35 name=__codelineno-107-35 href=#__codelineno-107-35></a><span class=gp>... </span>        <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-107-36><a id=__codelineno-107-36 name=__codelineno-107-36 href=#__codelineno-107-36></a><span class=gp>... </span>        
</span><span id=__span-107-37><a id=__codelineno-107-37 name=__codelineno-107-37 href=#__codelineno-107-37></a><span class=gp>... </span>    <span class=n>step</span> <span class=o>=</span> <span class=n>ladder_info</span><span class=p>[</span><span class=s2>&quot;step&quot;</span><span class=p>]</span>
</span><span id=__span-107-38><a id=__codelineno-107-38 name=__codelineno-107-38 href=#__codelineno-107-38></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>step</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span> <span class=ow>and</span> <span class=n>step</span> <span class=o>&lt;</span> <span class=n>ladders</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]:</span>  <span class=c1># (13)!</span>
</span><span id=__span-107-39><a id=__codelineno-107-39 name=__codelineno-107-39 href=#__codelineno-107-39></a><span class=gp>... </span>        <span class=n>after_n_bars</span> <span class=o>=</span> <span class=n>ladders</span><span class=o>.</span><span class=n>after_n_bars</span><span class=p>[</span><span class=n>step</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>  <span class=c1># (14)!</span>
</span><span id=__span-107-40><a id=__codelineno-107-40 name=__codelineno-107-40 href=#__codelineno-107-40></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>after_n_bars</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span> <span class=ow>and</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>&gt;=</span> <span class=n>ladder_info</span><span class=p>[</span><span class=s2>&quot;init_idx&quot;</span><span class=p>]</span> <span class=o>+</span> <span class=n>after_n_bars</span><span class=p>:</span>  <span class=c1># (15)!</span>
</span><span id=__span-107-41><a id=__codelineno-107-41 name=__codelineno-107-41 href=#__codelineno-107-41></a><span class=gp>... </span>            <span class=n>ladder_info</span><span class=p>[</span><span class=s2>&quot;step&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>step</span> <span class=o>+</span> <span class=mi>1</span>  <span class=c1># (16)!</span>
</span><span id=__span-107-42><a id=__codelineno-107-42 name=__codelineno-107-42 href=#__codelineno-107-42></a><span class=gp>... </span>            <span class=n>order</span><span class=o>.</span><span class=n>size</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>ladders</span><span class=o>.</span><span class=n>exit_pct</span><span class=p>[</span><span class=n>step</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>  <span class=c1># (17)!</span>
</span><span id=__span-107-43><a id=__codelineno-107-43 name=__codelineno-107-43 href=#__codelineno-107-43></a><span class=gp>... </span>            <span class=n>order</span><span class=o>.</span><span class=n>size_type</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>SizeType</span><span class=o>.</span><span class=n>Percent</span>
</span><span id=__span-107-44><a id=__codelineno-107-44 name=__codelineno-107-44 href=#__codelineno-107-44></a><span class=gp>... </span>            <span class=k>return</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>  <span class=c1># (18)!</span>
</span><span id=__span-107-45><a id=__codelineno-107-45 name=__codelineno-107-45 href=#__codelineno-107-45></a><span class=gp>... </span>    
</span><span id=__span-107-46><a id=__codelineno-107-46 name=__codelineno-107-46 href=#__codelineno-107-46></a><span class=gp>... </span>    <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>  <span class=c1># (19)!</span>
</span><span id=__span-107-47><a id=__codelineno-107-47 name=__codelineno-107-47 href=#__codelineno-107-47></a>
</span><span id=__span-107-48><a id=__codelineno-107-48 name=__codelineno-107-48 href=#__codelineno-107-48></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-107-49><a id=__codelineno-107-49 name=__codelineno-107-49 href=#__codelineno-107-49></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>),</span>
</span><span id=__span-107-50><a id=__codelineno-107-50 name=__codelineno-107-50 href=#__codelineno-107-50></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-107-51><a id=__codelineno-107-51 name=__codelineno-107-51 href=#__codelineno-107-51></a><span class=gp>... </span>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>  <span class=c1># (20)!</span>
</span><span id=__span-107-52><a id=__codelineno-107-52 name=__codelineno-107-52 href=#__codelineno-107-52></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span>
</span><span id=__span-107-53><a id=__codelineno-107-53 name=__codelineno-107-53 href=#__codelineno-107-53></a><span class=gp>... </span>            <span class=s2>&quot;Signals(entries, exits)&quot;</span><span class=p>,</span>
</span><span id=__span-107-54><a id=__codelineno-107-54 name=__codelineno-107-54 href=#__codelineno-107-54></a><span class=gp>... </span>            <span class=n>context</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>Signals</span><span class=o>=</span><span class=n>Signals</span><span class=p>)</span>  <span class=c1># (21)!</span>
</span><span id=__span-107-55><a id=__codelineno-107-55 name=__codelineno-107-55 href=#__codelineno-107-55></a><span class=gp>... </span>        <span class=p>),</span>
</span><span id=__span-107-56><a id=__codelineno-107-56 name=__codelineno-107-56 href=#__codelineno-107-56></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span>
</span><span id=__span-107-57><a id=__codelineno-107-57 name=__codelineno-107-57 href=#__codelineno-107-57></a><span class=gp>... </span>            <span class=s2>&quot;Order(size, size_type)&quot;</span><span class=p>,</span>
</span><span id=__span-107-58><a id=__codelineno-107-58 name=__codelineno-107-58 href=#__codelineno-107-58></a><span class=gp>... </span>            <span class=n>context</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>Order</span><span class=o>=</span><span class=n>Order</span><span class=p>)</span>
</span><span id=__span-107-59><a id=__codelineno-107-59 name=__codelineno-107-59 href=#__codelineno-107-59></a><span class=gp>... </span>        <span class=p>),</span>
</span><span id=__span-107-60><a id=__codelineno-107-60 name=__codelineno-107-60 href=#__codelineno-107-60></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;ladders&quot;</span><span class=p>),</span>  <span class=c1># (22)!</span>
</span><span id=__span-107-61><a id=__codelineno-107-61 name=__codelineno-107-61 href=#__codelineno-107-61></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span>  <span class=c1># (23)!</span>
</span><span id=__span-107-62><a id=__codelineno-107-62 name=__codelineno-107-62 href=#__codelineno-107-62></a><span class=gp>... </span>            <span class=s2>&quot;np.full(wrapper.shape_2d[1], np.array((-1, -1), ladder_info_dt))&quot;</span><span class=p>,</span>
</span><span id=__span-107-63><a id=__codelineno-107-63 name=__codelineno-107-63 href=#__codelineno-107-63></a><span class=gp>... </span>            <span class=n>context</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>ladder_info_dt</span><span class=o>=</span><span class=n>ladder_info_dt</span><span class=p>)</span>
</span><span id=__span-107-64><a id=__codelineno-107-64 name=__codelineno-107-64 href=#__codelineno-107-64></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-107-65><a id=__codelineno-107-65 name=__codelineno-107-65 href=#__codelineno-107-65></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-107-66><a id=__codelineno-107-66 name=__codelineno-107-66 href=#__codelineno-107-66></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;np.full(wrapper.shape_2d, np.nan)&quot;</span><span class=p>),</span>  <span class=c1># (24)!</span>
</span><span id=__span-107-67><a id=__codelineno-107-67 name=__codelineno-107-67 href=#__codelineno-107-67></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;np.full(wrapper.shape_2d, -1)&quot;</span><span class=p>),</span>
</span><span id=__span-107-68><a id=__codelineno-107-68 name=__codelineno-107-68 href=#__codelineno-107-68></a><span class=gp>... </span>    <span class=n>accumulate</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>  <span class=c1># (25)!</span>
</span><span id=__span-107-69><a id=__codelineno-107-69 name=__codelineno-107-69 href=#__codelineno-107-69></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-107-70><a id=__codelineno-107-70 name=__codelineno-107-70 href=#__codelineno-107-70></a><span class=gp>... </span>        <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-107-71><a id=__codelineno-107-71 name=__codelineno-107-71 href=#__codelineno-107-71></a><span class=gp>... </span>        <span class=n>exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-107-72><a id=__codelineno-107-72 name=__codelineno-107-72 href=#__codelineno-107-72></a><span class=gp>... </span>        <span class=n>ladders</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>BCO</span><span class=p>(</span>  <span class=c1># (26)!</span>
</span><span id=__span-107-73><a id=__codelineno-107-73 name=__codelineno-107-73 href=#__codelineno-107-73></a><span class=gp>... </span>            <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span>  <span class=c1># (27)!</span>
</span><span id=__span-107-74><a id=__codelineno-107-74 name=__codelineno-107-74 href=#__codelineno-107-74></a><span class=gp>... </span>                <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span>  <span class=c1># (28)!</span>
</span><span id=__span-107-75><a id=__codelineno-107-75 name=__codelineno-107-75 href=#__codelineno-107-75></a><span class=gp>... </span>                    <span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=o>/</span><span class=mi>4</span><span class=p>),</span>  <span class=c1># (29)!</span>
</span><span id=__span-107-76><a id=__codelineno-107-76 name=__codelineno-107-76 href=#__codelineno-107-76></a><span class=gp>... </span>                    <span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>1</span><span class=o>/</span><span class=mi>3</span><span class=p>),</span>
</span><span id=__span-107-77><a id=__codelineno-107-77 name=__codelineno-107-77 href=#__codelineno-107-77></a><span class=gp>... </span>                    <span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mi>1</span><span class=o>/</span><span class=mi>2</span><span class=p>),</span>
</span><span id=__span-107-78><a id=__codelineno-107-78 name=__codelineno-107-78 href=#__codelineno-107-78></a><span class=gp>... </span>                    <span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=mi>1</span><span class=o>/</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-107-79><a id=__codelineno-107-79 name=__codelineno-107-79 href=#__codelineno-107-79></a><span class=gp>... </span>                <span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>ladder_dt</span><span class=p>),</span>
</span><span id=__span-107-80><a id=__codelineno-107-80 name=__codelineno-107-80 href=#__codelineno-107-80></a><span class=gp>... </span>                <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span>
</span><span id=__span-107-81><a id=__codelineno-107-81 name=__codelineno-107-81 href=#__codelineno-107-81></a><span class=gp>... </span>                    <span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=o>/</span><span class=mi>2</span><span class=p>),</span>
</span><span id=__span-107-82><a id=__codelineno-107-82 name=__codelineno-107-82 href=#__codelineno-107-82></a><span class=gp>... </span>                    <span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mi>1</span><span class=o>/</span><span class=mi>1</span><span class=p>),</span>
</span><span id=__span-107-83><a id=__codelineno-107-83 name=__codelineno-107-83 href=#__codelineno-107-83></a><span class=gp>... </span>                <span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>ladder_dt</span><span class=p>),</span>
</span><span id=__span-107-84><a id=__codelineno-107-84 name=__codelineno-107-84 href=#__codelineno-107-84></a><span class=gp>... </span>            <span class=p>]),</span>
</span><span id=__span-107-85><a id=__codelineno-107-85 name=__codelineno-107-85 href=#__codelineno-107-85></a><span class=gp>... </span>            <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>  <span class=c1># (30)!</span>
</span><span id=__span-107-86><a id=__codelineno-107-86 name=__codelineno-107-86 href=#__codelineno-107-86></a><span class=gp>... </span>            <span class=n>merge_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>  <span class=c1># (31)!</span>
</span><span id=__span-107-87><a id=__codelineno-107-87 name=__codelineno-107-87 href=#__codelineno-107-87></a><span class=gp>... </span>                <span class=n>reset_index</span><span class=o>=</span><span class=s2>&quot;from_start&quot;</span><span class=p>,</span> 
</span><span id=__span-107-88><a id=__codelineno-107-88 name=__codelineno-107-88 href=#__codelineno-107-88></a><span class=gp>... </span>                <span class=n>fill_value</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>((</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>),</span> <span class=n>dtype</span><span class=o>=</span><span class=n>ladder_dt</span><span class=p>),</span>
</span><span id=__span-107-89><a id=__codelineno-107-89 name=__codelineno-107-89 href=#__codelineno-107-89></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-107-90><a id=__codelineno-107-90 name=__codelineno-107-90 href=#__codelineno-107-90></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-107-91><a id=__codelineno-107-91 name=__codelineno-107-91 href=#__codelineno-107-91></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-107-92><a id=__codelineno-107-92 name=__codelineno-107-92 href=#__codelineno-107-92></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-107-93><a id=__codelineno-107-93 name=__codelineno-107-93 href=#__codelineno-107-93></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-107-94><a id=__codelineno-107-94 name=__codelineno-107-94 href=#__codelineno-107-94></a><span class=go>ladder                      array_0   array_1</span>
</span><span id=__span-107-95><a id=__codelineno-107-95 name=__codelineno-107-95 href=#__codelineno-107-95></a><span class=go>Open time                                    </span>
</span><span id=__span-107-96><a id=__codelineno-107-96 name=__codelineno-107-96 href=#__codelineno-107-96></a><span class=go>2021-02-18 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-107-97><a id=__codelineno-107-97 name=__codelineno-107-97 href=#__codelineno-107-97></a><span class=go>2021-02-19 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-107-98><a id=__codelineno-107-98 name=__codelineno-107-98 href=#__codelineno-107-98></a><span class=go>2021-02-20 00:00:00+00:00  0.000448  0.000895</span>
</span><span id=__span-107-99><a id=__codelineno-107-99 name=__codelineno-107-99 href=#__codelineno-107-99></a><span class=go>2021-02-21 00:00:00+00:00  0.000435  0.000000</span>
</span><span id=__span-107-100><a id=__codelineno-107-100 name=__codelineno-107-100 href=#__codelineno-107-100></a><span class=go>2021-02-22 00:00:00+00:00  0.000462  0.000924</span>
</span><span id=__span-107-101><a id=__codelineno-107-101 name=__codelineno-107-101 href=#__codelineno-107-101></a><span class=go>2021-02-23 00:00:00+00:00  0.000511  0.000000</span>
</span><span id=__span-107-102><a id=__codelineno-107-102 name=__codelineno-107-102 href=#__codelineno-107-102></a><span class=go>2021-02-24 00:00:00+00:00  0.000000  0.000000</span>
</span></code></pre></div> <ol> <li>Create a <a href=https://realpython.com/python-namedtuple/ >namedtuple</a> to store multiple arrays in a single container. Passing several arrays to the signal function can take up a lot of space and make the code harder to read. This named tuple holds two signal arrays: entries and exits.</li> <li>The second named tuple holds order-related arrays, which are intended to be overridden in the signal function: size and size type. You can add more fields if needed.</li> <li>Ladders are stored in a two-dimensional array where each column represents a ladder and each row corresponds to a step within that ladder. Each step specifies how many bars must pass and how much to order (essentially as a tuple). Regular NumPy arrays cannot store this information, but structured arrays can. Here, we define the data type for such an array.</li> <li>We also need to track the index of the user-defined entry and the current step being processed. We need this per ladder (per column), so we create a one-dimensional structured array.</li> <li>If you have finished the function, remember to put it in a separate cell to avoid re-compilation. Also, do not cache it because it might break if you modify any of the named tuples.</li> <li>Our function takes the context, as well as the initialized named tuples and structured arrays we defined above.</li> <li>Similar to built-in information arrays like <code>last_position</code> and <code>last_sl_info</code>, our latest ladder information is also structured per column.</li> <li>If we encounter a user-defined exit signal, we close out the position.</li> <li>Reset the temporary information to deactivate our laddering logic in the upcoming bars.</li> <li>Override the order-related information for this signal; here, we go all out.</li> <li>Long exit.</li> <li>If we encounter a user-defined entry signal, record the current bar index in the temporary information, set the current step to zero to activate our laddering logic, and return no signal to skip to the next bar.</li> <li>Check whether the ladder is active and the current step is less than the total number of steps.</li> <li>Remember, ladders are stored in a two-dimensional array with one ladder per column. The first axis represents steps and the second axis represents columns.</li> <li>Next, check whether the condition for the current step is met, meaning whether the current bar index is after the target bar index. But first, check if the value is defined. This is important because ladders may have different numbers of steps.</li> <li>Increment the current step.</li> <li>Execute the signal by ordering the requested percentage of available resources.</li> <li>Long entry.</li> <li>If no action occurred during this bar, return no signal.</li> <li>Use templates to construct named tuples and record arrays. The arrays defined in <code>broadcast_named_args</code> will be automatically available to use in template expressions.</li> <li>We need to provide the classes through the context, since they are not automatically available in expressions.</li> <li>We define ladders in <code>broadcast_named_args</code> to broadcast it along with the data.</li> <li>Create a structured NumPy array to hold temporary information per ladder (per column). Here, <code>np.array((-1, -1), ladder_info_dt)</code> is a single value that instructs NumPy to use the data type <code>ladder_info_dt</code> and fill both fields with -1.</li> <li>Size and size type are built-in arguments that we want to override, so make them match the full shape.</li> <li>Do not forget to enable accumulation to allow gradual increases in the position.</li> <li>Use <a href=https://vectorbt.pro/pvt_41531c19/api/base/reshaping/#vectorbtpro.base.reshaping.BCO>BCO</a> to control broadcasting of a single argument.</li> <li>Use <a href=https://vectorbt.pro/pvt_41531c19/api/utils/params/#vectorbtpro.utils.params.Param>Param</a> to test multiple values (such as different ladder arrays).</li> <li>Any structured array can be initialized using regular tuples.</li> <li>For example, in the first step, once we are two bars away from the user-defined entry signal, place an order for 25% of the available cash balance.</li> <li>Remember, the first axis represents steps, not bars. Therefore, the array is not broadcastable along the time axis (<code>axis=0</code>), only along the column axis (<code>axis=1</code>).</li> <li>What if one array has fewer steps than another? Internally, both arrays will be stacked along columns, but stacking will not work if they have different shapes. Here, we specify that whenever an array has too few rows, it should be padded using <code>fill_value</code>.</li> </ol> <p>The strategy has successfully split the entry signal into several smaller entry orders distributed over time. The code above is a great template for defining dynamic signal strategies of any complexity.</p> <h2 id=grouping>Grouping<a class=headerlink href=#grouping title="Permanent link">&para;</a></h2> <p>Until now, we have processed the columns <code>BTCUSDT</code> and <code>ETHUSDT</code> separately, meaning the second column is always processed after the first column. However, you may want to include both columns in the same portfolio for analysis. By introducing grouping, you can combine multiple columns to be treated as a single column (read more <a href=https://vectorbt.pro/pvt_41531c19/documentation/portfolio/from-orders/#grouping_1>here</a>). In this context, it is important to distinguish between grouping after the simulation and grouping before the simulation.</p> <h3 id=after-simulation>After simulation<a class=headerlink href=#after-simulation title="Permanent link">&para;</a></h3> <p>When your main scenario is to simulate columns <strong>separately</strong> and then analyze them together, you can group the columns after the simulation. This can be done when querying a specific metric of interest:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-108-1><a id=__codelineno-108-1 name=__codelineno-108-1 href=#__codelineno-108-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-108-2><a id=__codelineno-108-2 name=__codelineno-108-2 href=#__codelineno-108-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-108-3><a id=__codelineno-108-3 name=__codelineno-108-3 href=#__codelineno-108-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span>      <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-108-4><a id=__codelineno-108-4 name=__codelineno-108-4 href=#__codelineno-108-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>        <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-108-5><a id=__codelineno-108-5 name=__codelineno-108-5 href=#__codelineno-108-5></a><span class=gp>... </span>    <span class=n>short_entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-108-6><a id=__codelineno-108-6 name=__codelineno-108-6 href=#__codelineno-108-6></a><span class=gp>... </span>    <span class=n>short_exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>]),</span>
</span><span id=__span-108-7><a id=__codelineno-108-7 name=__codelineno-108-7 href=#__codelineno-108-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-108-8><a id=__codelineno-108-8 name=__codelineno-108-8 href=#__codelineno-108-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>get_value</span><span class=p>(</span><span class=n>group_by</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-108-9><a id=__codelineno-108-9 name=__codelineno-108-9 href=#__codelineno-108-9></a><span class=go>Open time</span>
</span><span id=__span-108-10><a id=__codelineno-108-10 name=__codelineno-108-10 href=#__codelineno-108-10></a><span class=go>2021-02-18 00:00:00+00:00    200.000000</span>
</span><span id=__span-108-11><a id=__codelineno-108-11 name=__codelineno-108-11 href=#__codelineno-108-11></a><span class=go>2021-02-19 00:00:00+00:00    209.238037</span>
</span><span id=__span-108-12><a id=__codelineno-108-12 name=__codelineno-108-12 href=#__codelineno-108-12></a><span class=go>2021-02-20 00:00:00+00:00    206.946937</span>
</span><span id=__span-108-13><a id=__codelineno-108-13 name=__codelineno-108-13 href=#__codelineno-108-13></a><span class=go>2021-02-21 00:00:00+00:00    211.045749</span>
</span><span id=__span-108-14><a id=__codelineno-108-14 name=__codelineno-108-14 href=#__codelineno-108-14></a><span class=go>2021-02-22 00:00:00+00:00    211.045749</span>
</span><span id=__span-108-15><a id=__codelineno-108-15 name=__codelineno-108-15 href=#__codelineno-108-15></a><span class=go>2021-02-23 00:00:00+00:00    232.943589</span>
</span><span id=__span-108-16><a id=__codelineno-108-16 name=__codelineno-108-16 href=#__codelineno-108-16></a><span class=go>2021-02-24 00:00:00+00:00    228.775332</span>
</span><span id=__span-108-17><a id=__codelineno-108-17 name=__codelineno-108-17 href=#__codelineno-108-17></a><span class=go>Freq: D, Name: group, dtype: float64</span>
</span></code></pre></div> <p>Or by updating the entire portfolio:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-109-1><a id=__codelineno-109-1 name=__codelineno-109-1 href=#__codelineno-109-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>grouped_pf</span> <span class=o>=</span> <span class=n>pf</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=n>wrapper</span><span class=o>=</span><span class=n>pf</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=n>group_by</span><span class=o>=</span><span class=kc>True</span><span class=p>))</span>  <span class=c1># (1)!</span>
</span><span id=__span-109-2><a id=__codelineno-109-2 name=__codelineno-109-2 href=#__codelineno-109-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>grouped_pf</span><span class=o>.</span><span class=n>value</span>
</span><span id=__span-109-3><a id=__codelineno-109-3 name=__codelineno-109-3 href=#__codelineno-109-3></a><span class=go>Open time</span>
</span><span id=__span-109-4><a id=__codelineno-109-4 name=__codelineno-109-4 href=#__codelineno-109-4></a><span class=go>2021-02-18 00:00:00+00:00    200.000000</span>
</span><span id=__span-109-5><a id=__codelineno-109-5 name=__codelineno-109-5 href=#__codelineno-109-5></a><span class=go>2021-02-19 00:00:00+00:00    209.238037</span>
</span><span id=__span-109-6><a id=__codelineno-109-6 name=__codelineno-109-6 href=#__codelineno-109-6></a><span class=go>2021-02-20 00:00:00+00:00    206.946937</span>
</span><span id=__span-109-7><a id=__codelineno-109-7 name=__codelineno-109-7 href=#__codelineno-109-7></a><span class=go>2021-02-21 00:00:00+00:00    211.045749</span>
</span><span id=__span-109-8><a id=__codelineno-109-8 name=__codelineno-109-8 href=#__codelineno-109-8></a><span class=go>2021-02-22 00:00:00+00:00    211.045749</span>
</span><span id=__span-109-9><a id=__codelineno-109-9 name=__codelineno-109-9 href=#__codelineno-109-9></a><span class=go>2021-02-23 00:00:00+00:00    232.943589</span>
</span><span id=__span-109-10><a id=__codelineno-109-10 name=__codelineno-109-10 href=#__codelineno-109-10></a><span class=go>2021-02-24 00:00:00+00:00    228.775332</span>
</span><span id=__span-109-11><a id=__codelineno-109-11 name=__codelineno-109-11 href=#__codelineno-109-11></a><span class=go>Freq: D, Name: group, dtype: float64</span>
</span></code></pre></div> <ol> <li>The group-by instruction is part of the portfolio's wrapper.</li> </ol> <p>In this case, the portfolio aggregates various metrics, such as the initial capital and time series like cash flows, along the column axis. However, some time series cannot be aggregated, such as asset flows:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-110-1><a id=__codelineno-110-1 name=__codelineno-110-1 href=#__codelineno-110-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>grouped_pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-110-2><a id=__codelineno-110-2 name=__codelineno-110-2 href=#__codelineno-110-2></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-110-3><a id=__codelineno-110-3 name=__codelineno-110-3 href=#__codelineno-110-3></a><span class=go>Open time                                    </span>
</span><span id=__span-110-4><a id=__codelineno-110-4 name=__codelineno-110-4 href=#__codelineno-110-4></a><span class=go>2021-02-18 00:00:00+00:00  0.001940  0.051557</span>
</span><span id=__span-110-5><a id=__codelineno-110-5 name=__codelineno-110-5 href=#__codelineno-110-5></a><span class=go>2021-02-19 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-110-6><a id=__codelineno-110-6 name=__codelineno-110-6 href=#__codelineno-110-6></a><span class=go>2021-02-20 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-110-7><a id=__codelineno-110-7 name=__codelineno-110-7 href=#__codelineno-110-7></a><span class=go>2021-02-21 00:00:00+00:00 -0.001940 -0.051557</span>
</span><span id=__span-110-8><a id=__codelineno-110-8 name=__codelineno-110-8 href=#__codelineno-110-8></a><span class=go>2021-02-22 00:00:00+00:00 -0.002059 -0.056080</span>
</span><span id=__span-110-9><a id=__codelineno-110-9 name=__codelineno-110-9 href=#__codelineno-110-9></a><span class=go>2021-02-23 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-110-10><a id=__codelineno-110-10 name=__codelineno-110-10 href=#__codelineno-110-10></a><span class=go>2021-02-24 00:00:00+00:00  0.002059  0.056080</span>
</span></code></pre></div> <p>You can disable grouping for individual metrics by passing <code>group_by=False</code>. However, you cannot introduce cash sharing after the simulation, as it must be applied during the simulation to have any real impact on the trading logic.</p> <h3 id=before-simulation>Before simulation<a class=headerlink href=#before-simulation title="Permanent link">&para;</a></h3> <p>Adding a group-by instruction before the simulation may or may not affect the simulation results. For example, grouping with cash sharing will always affect the outcome, while grouping without cash sharing will only affect the simulation when <abbr title="From-signals simulation method">FS</abbr> is run in flexible mode (that is, when any default callbacks are overridden). In this case, columns are grouped so users can leverage grouping in the callbacks, while all calculations are still performed on a per-column basis as if there were no grouping. Let's use this feature to limit the number of active positions to just one in each group:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-111-1><a id=__codelineno-111-1 name=__codelineno-111-1 href=#__codelineno-111-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-111-2><a id=__codelineno-111-2 name=__codelineno-111-2 href=#__codelineno-111-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>entries</span><span class=p>,</span> <span class=n>exits</span><span class=p>):</span>
</span><span id=__span-111-3><a id=__codelineno-111-3 name=__codelineno-111-3 href=#__codelineno-111-3></a><span class=gp>... </span>    <span class=n>is_entry</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>entries</span><span class=p>)</span>
</span><span id=__span-111-4><a id=__codelineno-111-4 name=__codelineno-111-4 href=#__codelineno-111-4></a><span class=gp>... </span>    <span class=n>is_exit</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>exits</span><span class=p>)</span>
</span><span id=__span-111-5><a id=__codelineno-111-5 name=__codelineno-111-5 href=#__codelineno-111-5></a><span class=gp>... </span>    <span class=n>other_in_position</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-111-6><a id=__codelineno-111-6 name=__codelineno-111-6 href=#__codelineno-111-6></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>from_col</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>to_col</span><span class=p>):</span>  <span class=c1># (1)!</span>
</span><span id=__span-111-7><a id=__codelineno-111-7 name=__codelineno-111-7 href=#__codelineno-111-7></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>col</span> <span class=o>!=</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span> <span class=ow>and</span> <span class=n>c</span><span class=o>.</span><span class=n>last_position</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-111-8><a id=__codelineno-111-8 name=__codelineno-111-8 href=#__codelineno-111-8></a><span class=gp>... </span>            <span class=n>other_in_position</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-111-9><a id=__codelineno-111-9 name=__codelineno-111-9 href=#__codelineno-111-9></a><span class=gp>... </span>            <span class=k>break</span>
</span><span id=__span-111-10><a id=__codelineno-111-10 name=__codelineno-111-10 href=#__codelineno-111-10></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>other_in_position</span><span class=p>:</span>  <span class=c1># (2)!</span>
</span><span id=__span-111-11><a id=__codelineno-111-11 name=__codelineno-111-11 href=#__codelineno-111-11></a><span class=gp>... </span>        <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-111-12><a id=__codelineno-111-12 name=__codelineno-111-12 href=#__codelineno-111-12></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>is_entry</span><span class=p>,</span> <span class=n>is_exit</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>  <span class=c1># (3)!</span>
</span><span id=__span-111-13><a id=__codelineno-111-13 name=__codelineno-111-13 href=#__codelineno-111-13></a>
</span><span id=__span-111-14><a id=__codelineno-111-14 name=__codelineno-111-14 href=#__codelineno-111-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-111-15><a id=__codelineno-111-15 name=__codelineno-111-15 href=#__codelineno-111-15></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-111-16><a id=__codelineno-111-16 name=__codelineno-111-16 href=#__codelineno-111-16></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>
</span><span id=__span-111-17><a id=__codelineno-111-17 name=__codelineno-111-17 href=#__codelineno-111-17></a><span class=gp>... </span>    <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;entries&quot;</span><span class=p>),</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;exits&quot;</span><span class=p>)),</span>
</span><span id=__span-111-18><a id=__codelineno-111-18 name=__codelineno-111-18 href=#__codelineno-111-18></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-111-19><a id=__codelineno-111-19 name=__codelineno-111-19 href=#__codelineno-111-19></a><span class=gp>... </span>        <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
</span><span id=__span-111-20><a id=__codelineno-111-20 name=__codelineno-111-20 href=#__codelineno-111-20></a><span class=gp>... </span>            <span class=mi>0</span><span class=p>:</span> <span class=p>[</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>],</span> 
</span><span id=__span-111-21><a id=__codelineno-111-21 name=__codelineno-111-21 href=#__codelineno-111-21></a><span class=gp>... </span>            <span class=mi>1</span><span class=p>:</span> <span class=p>[</span><span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]</span>
</span><span id=__span-111-22><a id=__codelineno-111-22 name=__codelineno-111-22 href=#__codelineno-111-22></a><span class=gp>... </span>        <span class=p>}),</span> 
</span><span id=__span-111-23><a id=__codelineno-111-23 name=__codelineno-111-23 href=#__codelineno-111-23></a><span class=gp>... </span>        <span class=n>exits</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
</span><span id=__span-111-24><a id=__codelineno-111-24 name=__codelineno-111-24 href=#__codelineno-111-24></a><span class=gp>... </span>            <span class=mi>0</span><span class=p>:</span> <span class=p>[</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>],</span> 
</span><span id=__span-111-25><a id=__codelineno-111-25 name=__codelineno-111-25 href=#__codelineno-111-25></a><span class=gp>... </span>            <span class=mi>1</span><span class=p>:</span> <span class=p>[</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>]</span>
</span><span id=__span-111-26><a id=__codelineno-111-26 name=__codelineno-111-26 href=#__codelineno-111-26></a><span class=gp>... </span>        <span class=p>})</span>
</span><span id=__span-111-27><a id=__codelineno-111-27 name=__codelineno-111-27 href=#__codelineno-111-27></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-111-28><a id=__codelineno-111-28 name=__codelineno-111-28 href=#__codelineno-111-28></a><span class=gp>... </span>    <span class=n>group_by</span><span class=o>=</span><span class=kc>True</span>  <span class=c1># (4)!</span>
</span><span id=__span-111-29><a id=__codelineno-111-29 name=__codelineno-111-29 href=#__codelineno-111-29></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-111-30><a id=__codelineno-111-30 name=__codelineno-111-30 href=#__codelineno-111-30></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>asset_flow</span>
</span><span id=__span-111-31><a id=__codelineno-111-31 name=__codelineno-111-31 href=#__codelineno-111-31></a><span class=go>symbol                     BTCUSDT   ETHUSDT</span>
</span><span id=__span-111-32><a id=__codelineno-111-32 name=__codelineno-111-32 href=#__codelineno-111-32></a><span class=go>Open time                                   </span>
</span><span id=__span-111-33><a id=__codelineno-111-33 name=__codelineno-111-33 href=#__codelineno-111-33></a><span class=go>2021-02-18 00:00:00+00:00  0.00194  0.000000</span>
</span><span id=__span-111-34><a id=__codelineno-111-34 name=__codelineno-111-34 href=#__codelineno-111-34></a><span class=go>2021-02-19 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-111-35><a id=__codelineno-111-35 name=__codelineno-111-35 href=#__codelineno-111-35></a><span class=go>2021-02-20 00:00:00+00:00 -0.00194  0.000000</span>
</span><span id=__span-111-36><a id=__codelineno-111-36 name=__codelineno-111-36 href=#__codelineno-111-36></a><span class=go>2021-02-21 00:00:00+00:00  0.00000  0.051719</span>
</span><span id=__span-111-37><a id=__codelineno-111-37 name=__codelineno-111-37 href=#__codelineno-111-37></a><span class=go>2021-02-22 00:00:00+00:00  0.00000  0.000000</span>
</span><span id=__span-111-38><a id=__codelineno-111-38 name=__codelineno-111-38 href=#__codelineno-111-38></a><span class=go>2021-02-23 00:00:00+00:00  0.00000 -0.051719</span>
</span><span id=__span-111-39><a id=__codelineno-111-39 name=__codelineno-111-39 href=#__codelineno-111-39></a><span class=go>2021-02-24 00:00:00+00:00  0.00218  0.000000</span>
</span></code></pre></div> <ol> <li>Loop through the columns in this group and check whether there are open positions apart from this one.</li> <li>If true, return no signal.</li> <li>If false, return the signal.</li> <li>Group all columns together. For multiple groups, use <code>vbt.ExceptLevel("symbol")</code>.</li> </ol> <p>The first signal in the column <code>ETHUSDT</code> could not execute because there was already a position open in column <code>BTCUSDT</code>. However, once the position was closed, the second signal was able to go through.</p> <h4 id=sorting>Sorting<a class=headerlink href=#sorting title="Permanent link">&para;</a></h4> <p>Orders are only sorted in groups with cash sharing and in two situations: when orders in different columns must be executed in different bar zones (that is, at different times) and need to be sorted by time, and when orders are set to be sorted by order value as part of the automatic call sequence enabled with <code>call_seq="auto"</code>. These two cases cannot be combined.</p> <p>Let's look at the first case, where the first column is executed using the closing price and the second column is executed using the opening price:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-112-1><a id=__codelineno-112-1 name=__codelineno-112-1 href=#__codelineno-112-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-112-2><a id=__codelineno-112-2 name=__codelineno-112-2 href=#__codelineno-112-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-112-3><a id=__codelineno-112-3 name=__codelineno-112-3 href=#__codelineno-112-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-112-4><a id=__codelineno-112-4 name=__codelineno-112-4 href=#__codelineno-112-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=p>[[</span><span class=s2>&quot;close&quot;</span><span class=p>,</span> <span class=s2>&quot;open&quot;</span><span class=p>]],</span>  <span class=c1># (1)!</span>
</span><span id=__span-112-5><a id=__codelineno-112-5 name=__codelineno-112-5 href=#__codelineno-112-5></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=p>[[</span><span class=mi>100</span><span class=p>,</span> <span class=mi>50</span><span class=p>]],</span>
</span><span id=__span-112-6><a id=__codelineno-112-6 name=__codelineno-112-6 href=#__codelineno-112-6></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;value&quot;</span><span class=p>,</span>
</span><span id=__span-112-7><a id=__codelineno-112-7 name=__codelineno-112-7 href=#__codelineno-112-7></a><span class=gp>... </span>    <span class=n>group_by</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-112-8><a id=__codelineno-112-8 name=__codelineno-112-8 href=#__codelineno-112-8></a><span class=gp>... </span>    <span class=n>cash_sharing</span><span class=o>=</span><span class=kc>True</span>  <span class=c1># (2)!</span>
</span><span id=__span-112-9><a id=__codelineno-112-9 name=__codelineno-112-9 href=#__codelineno-112-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-112-10><a id=__codelineno-112-10 name=__codelineno-112-10 href=#__codelineno-112-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>get_value</span><span class=p>(</span><span class=n>group_by</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-112-11><a id=__codelineno-112-11 name=__codelineno-112-11 href=#__codelineno-112-11></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-112-12><a id=__codelineno-112-12 name=__codelineno-112-12 href=#__codelineno-112-12></a><span class=go>Open time                                  </span>
</span><span id=__span-112-13><a id=__codelineno-112-13 name=__codelineno-112-13 href=#__codelineno-112-13></a><span class=go>2021-02-18 00:00:00+00:00     50.0     50.0</span>
</span><span id=__span-112-14><a id=__codelineno-112-14 name=__codelineno-112-14 href=#__codelineno-112-14></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-112-15><a id=__codelineno-112-15 name=__codelineno-112-15 href=#__codelineno-112-15></a><span class=go>2021-02-20 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-112-16><a id=__codelineno-112-16 name=__codelineno-112-16 href=#__codelineno-112-16></a><span class=go>2021-02-21 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-112-17><a id=__codelineno-112-17 name=__codelineno-112-17 href=#__codelineno-112-17></a><span class=go>2021-02-22 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-112-18><a id=__codelineno-112-18 name=__codelineno-112-18 href=#__codelineno-112-18></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-112-19><a id=__codelineno-112-19 name=__codelineno-112-19 href=#__codelineno-112-19></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN</span>
</span></code></pre></div> <ol> <li>If you want to provide information per column, build a two-dimensional array with exactly one row. (Any array-like object is converted to a NumPy array, so a list works as well.)</li> <li>Enable cash sharing.</li> </ol> <p>As you can see, the second column was executed first and ended up using half of the available capital. If both assets were executed in the same bar zone, they would not be sorted and would be executed in order from the left column to the right:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-113-1><a id=__codelineno-113-1 name=__codelineno-113-1 href=#__codelineno-113-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-113-2><a id=__codelineno-113-2 name=__codelineno-113-2 href=#__codelineno-113-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-113-3><a id=__codelineno-113-3 name=__codelineno-113-3 href=#__codelineno-113-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-113-4><a id=__codelineno-113-4 name=__codelineno-113-4 href=#__codelineno-113-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=s2>&quot;close&quot;</span><span class=p>,</span>
</span><span id=__span-113-5><a id=__codelineno-113-5 name=__codelineno-113-5 href=#__codelineno-113-5></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=p>[[</span><span class=mi>100</span><span class=p>,</span> <span class=mi>50</span><span class=p>]],</span>
</span><span id=__span-113-6><a id=__codelineno-113-6 name=__codelineno-113-6 href=#__codelineno-113-6></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;value&quot;</span><span class=p>,</span>
</span><span id=__span-113-7><a id=__codelineno-113-7 name=__codelineno-113-7 href=#__codelineno-113-7></a><span class=gp>... </span>    <span class=n>group_by</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-113-8><a id=__codelineno-113-8 name=__codelineno-113-8 href=#__codelineno-113-8></a><span class=gp>... </span>    <span class=n>cash_sharing</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-113-9><a id=__codelineno-113-9 name=__codelineno-113-9 href=#__codelineno-113-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-113-10><a id=__codelineno-113-10 name=__codelineno-113-10 href=#__codelineno-113-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>get_value</span><span class=p>(</span><span class=n>group_by</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-113-11><a id=__codelineno-113-11 name=__codelineno-113-11 href=#__codelineno-113-11></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-113-12><a id=__codelineno-113-12 name=__codelineno-113-12 href=#__codelineno-113-12></a><span class=go>Open time                                  </span>
</span><span id=__span-113-13><a id=__codelineno-113-13 name=__codelineno-113-13 href=#__codelineno-113-13></a><span class=go>2021-02-18 00:00:00+00:00    100.0      NaN</span>
</span><span id=__span-113-14><a id=__codelineno-113-14 name=__codelineno-113-14 href=#__codelineno-113-14></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-113-15><a id=__codelineno-113-15 name=__codelineno-113-15 href=#__codelineno-113-15></a><span class=go>2021-02-20 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-113-16><a id=__codelineno-113-16 name=__codelineno-113-16 href=#__codelineno-113-16></a><span class=go>2021-02-21 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-113-17><a id=__codelineno-113-17 name=__codelineno-113-17 href=#__codelineno-113-17></a><span class=go>2021-02-22 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-113-18><a id=__codelineno-113-18 name=__codelineno-113-18 href=#__codelineno-113-18></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-113-19><a id=__codelineno-113-19 name=__codelineno-113-19 href=#__codelineno-113-19></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN</span>
</span></code></pre></div> <p>Even though the second column requested $50 worth of assets, the simulator could not fulfill the request because the default initial capital is $100, which was fully allocated to the first column.</p> <p>To sort by order value, use the automatic call sequence:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-114-1><a id=__codelineno-114-1 name=__codelineno-114-1 href=#__codelineno-114-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-114-2><a id=__codelineno-114-2 name=__codelineno-114-2 href=#__codelineno-114-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-114-3><a id=__codelineno-114-3 name=__codelineno-114-3 href=#__codelineno-114-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-114-4><a id=__codelineno-114-4 name=__codelineno-114-4 href=#__codelineno-114-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=s2>&quot;close&quot;</span><span class=p>,</span>
</span><span id=__span-114-5><a id=__codelineno-114-5 name=__codelineno-114-5 href=#__codelineno-114-5></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=p>[[</span><span class=mi>100</span><span class=p>,</span> <span class=mi>50</span><span class=p>]],</span>
</span><span id=__span-114-6><a id=__codelineno-114-6 name=__codelineno-114-6 href=#__codelineno-114-6></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;value&quot;</span><span class=p>,</span>
</span><span id=__span-114-7><a id=__codelineno-114-7 name=__codelineno-114-7 href=#__codelineno-114-7></a><span class=gp>... </span>    <span class=n>group_by</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-114-8><a id=__codelineno-114-8 name=__codelineno-114-8 href=#__codelineno-114-8></a><span class=gp>... </span>    <span class=n>cash_sharing</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-114-9><a id=__codelineno-114-9 name=__codelineno-114-9 href=#__codelineno-114-9></a><span class=gp>... </span>    <span class=n>call_seq</span><span class=o>=</span><span class=s2>&quot;auto&quot;</span>  <span class=c1># (1)!</span>
</span><span id=__span-114-10><a id=__codelineno-114-10 name=__codelineno-114-10 href=#__codelineno-114-10></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-114-11><a id=__codelineno-114-11 name=__codelineno-114-11 href=#__codelineno-114-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>get_value</span><span class=p>(</span><span class=n>group_by</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>to_pd</span><span class=p>()</span>
</span><span id=__span-114-12><a id=__codelineno-114-12 name=__codelineno-114-12 href=#__codelineno-114-12></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-114-13><a id=__codelineno-114-13 name=__codelineno-114-13 href=#__codelineno-114-13></a><span class=go>Open time                                  </span>
</span><span id=__span-114-14><a id=__codelineno-114-14 name=__codelineno-114-14 href=#__codelineno-114-14></a><span class=go>2021-02-18 00:00:00+00:00     50.0     50.0</span>
</span><span id=__span-114-15><a id=__codelineno-114-15 name=__codelineno-114-15 href=#__codelineno-114-15></a><span class=go>2021-02-19 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-114-16><a id=__codelineno-114-16 name=__codelineno-114-16 href=#__codelineno-114-16></a><span class=go>2021-02-20 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-114-17><a id=__codelineno-114-17 name=__codelineno-114-17 href=#__codelineno-114-17></a><span class=go>2021-02-21 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-114-18><a id=__codelineno-114-18 name=__codelineno-114-18 href=#__codelineno-114-18></a><span class=go>2021-02-22 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-114-19><a id=__codelineno-114-19 name=__codelineno-114-19 href=#__codelineno-114-19></a><span class=go>2021-02-23 00:00:00+00:00      NaN      NaN</span>
</span><span id=__span-114-20><a id=__codelineno-114-20 name=__codelineno-114-20 href=#__codelineno-114-20></a><span class=go>2021-02-24 00:00:00+00:00      NaN      NaN</span>
</span></code></pre></div> <ol> <li>This enables the automatic call sequence.</li> </ol> <p>With this, the second column was executed first. However, if you attempt to sort by order value when columns need to execute orders at different times, the simulation will fail:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-115-1><a id=__codelineno-115-1 name=__codelineno-115-1 href=#__codelineno-115-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-115-2><a id=__codelineno-115-2 name=__codelineno-115-2 href=#__codelineno-115-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-115-3><a id=__codelineno-115-3 name=__codelineno-115-3 href=#__codelineno-115-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-115-4><a id=__codelineno-115-4 name=__codelineno-115-4 href=#__codelineno-115-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=p>[[</span><span class=s2>&quot;close&quot;</span><span class=p>,</span> <span class=s2>&quot;open&quot;</span><span class=p>]],</span>
</span><span id=__span-115-5><a id=__codelineno-115-5 name=__codelineno-115-5 href=#__codelineno-115-5></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=p>[[</span><span class=mi>100</span><span class=p>,</span> <span class=mi>50</span><span class=p>]],</span>
</span><span id=__span-115-6><a id=__codelineno-115-6 name=__codelineno-115-6 href=#__codelineno-115-6></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;value&quot;</span><span class=p>,</span>
</span><span id=__span-115-7><a id=__codelineno-115-7 name=__codelineno-115-7 href=#__codelineno-115-7></a><span class=gp>... </span>    <span class=n>group_by</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-115-8><a id=__codelineno-115-8 name=__codelineno-115-8 href=#__codelineno-115-8></a><span class=gp>... </span>    <span class=n>cash_sharing</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-115-9><a id=__codelineno-115-9 name=__codelineno-115-9 href=#__codelineno-115-9></a><span class=gp>... </span>    <span class=n>call_seq</span><span class=o>=</span><span class=s2>&quot;auto&quot;</span>
</span><span id=__span-115-10><a id=__codelineno-115-10 name=__codelineno-115-10 href=#__codelineno-115-10></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-115-11><a id=__codelineno-115-11 name=__codelineno-115-11 href=#__codelineno-115-11></a><span class=go>ValueError: Cannot sort orders by value if they are executed at different times</span>
</span></code></pre></div> <p>This makes sense if you think about it: if the simulator tries to sort both columns by value, the second column would come first, but that is not possible if it should execute at the start of the bar. Recall that each bar is divided into three zones: open, middle, and close. The only way to sort orders by value is to use either the opening or the closing point of the bar. Sorting cannot use the middle of the bar because its events are unknown. In VBT, you indicate where in the bar an order should execute by setting the price to <code>-np.inf</code> (bar open) or <code>np.inf</code> (bar close). Passing custom prices is considered to happen in the middle of the bar, which causes the operation to fail:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-116-1><a id=__codelineno-116-1 name=__codelineno-116-1 href=#__codelineno-116-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-116-2><a id=__codelineno-116-2 name=__codelineno-116-2 href=#__codelineno-116-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-116-3><a id=__codelineno-116-3 name=__codelineno-116-3 href=#__codelineno-116-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-116-4><a id=__codelineno-116-4 name=__codelineno-116-4 href=#__codelineno-116-4></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>sub_data</span><span class=o>.</span><span class=n>close</span><span class=p>,</span>
</span><span id=__span-116-5><a id=__codelineno-116-5 name=__codelineno-116-5 href=#__codelineno-116-5></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=p>[[</span><span class=mi>100</span><span class=p>,</span> <span class=mi>50</span><span class=p>]],</span>
</span><span id=__span-116-6><a id=__codelineno-116-6 name=__codelineno-116-6 href=#__codelineno-116-6></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;value&quot;</span><span class=p>,</span>
</span><span id=__span-116-7><a id=__codelineno-116-7 name=__codelineno-116-7 href=#__codelineno-116-7></a><span class=gp>... </span>    <span class=n>group_by</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-116-8><a id=__codelineno-116-8 name=__codelineno-116-8 href=#__codelineno-116-8></a><span class=gp>... </span>    <span class=n>cash_sharing</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-116-9><a id=__codelineno-116-9 name=__codelineno-116-9 href=#__codelineno-116-9></a><span class=gp>... </span>    <span class=n>call_seq</span><span class=o>=</span><span class=s2>&quot;auto&quot;</span>
</span><span id=__span-116-10><a id=__codelineno-116-10 name=__codelineno-116-10 href=#__codelineno-116-10></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-116-11><a id=__codelineno-116-11 name=__codelineno-116-11 href=#__codelineno-116-11></a><span class=go>ValueError: Cannot sort orders by value if they are executed at different times</span>
</span></code></pre></div> <p>Even if you know the provided array represents the closing price, VBT is not aware of this. Therefore, always use an option from <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.PriceType>PriceType</a> when the automatic call sequence should be enabled. If you are using stop orders, set both <code>PriceType.Close</code> and <code>StopExitPrice.Close</code> to execute all orders at the closing price, such as when rebalancing. Limit orders, however, are never executed at the closing price, so using them with the automatic call sequence is generally not possible.</p> <h2 id=custom-outputs>Custom outputs<a class=headerlink href=#custom-outputs title="Permanent link">&para;</a></h2> <p>After simulating the portfolio and obtaining your new portfolio instance, the first thing you usually do is run various statistics. Since most statistics rely on returns, the portfolio instance may sometimes need to recalculate returns multiple times. This process can be slow, as it requires translating order records into asset flows, cash flows, assets, cash, asset value, portfolio value, and finally, returns. These operations are called "reconstructions" because they derive a specific property of the simulation after it is complete. As a result, performance analysis often becomes the main bottleneck in a typical backtesting workflow. Fortunately, there is a <code>save_returns</code> argument that, when enabled, pre-calculates returns during simulation and makes them available to all metrics that need them (see more <a href=https://vectorbt.pro/pvt_41531c19/documentation/portfolio/from-orders/#filling-returns>here</a>):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-117-1><a id=__codelineno-117-1 name=__codelineno-117-1 href=#__codelineno-117-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-117-2><a id=__codelineno-117-2 name=__codelineno-117-2 href=#__codelineno-117-2></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-117-3><a id=__codelineno-117-3 name=__codelineno-117-3 href=#__codelineno-117-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span>      <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-117-4><a id=__codelineno-117-4 name=__codelineno-117-4 href=#__codelineno-117-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>        <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-117-5><a id=__codelineno-117-5 name=__codelineno-117-5 href=#__codelineno-117-5></a><span class=gp>... </span>    <span class=n>short_entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-117-6><a id=__codelineno-117-6 name=__codelineno-117-6 href=#__codelineno-117-6></a><span class=gp>... </span>    <span class=n>short_exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>]),</span>
</span><span id=__span-117-7><a id=__codelineno-117-7 name=__codelineno-117-7 href=#__codelineno-117-7></a><span class=gp>... </span>    <span class=n>save_returns</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-117-8><a id=__codelineno-117-8 name=__codelineno-117-8 href=#__codelineno-117-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-117-9><a id=__codelineno-117-9 name=__codelineno-117-9 href=#__codelineno-117-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>returns</span>
</span><span id=__span-117-10><a id=__codelineno-117-10 name=__codelineno-117-10 href=#__codelineno-117-10></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-117-11><a id=__codelineno-117-11 name=__codelineno-117-11 href=#__codelineno-117-11></a><span class=go>Open time                                    </span>
</span><span id=__span-117-12><a id=__codelineno-117-12 name=__codelineno-117-12 href=#__codelineno-117-12></a><span class=go>2021-02-18 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-117-13><a id=__codelineno-117-13 name=__codelineno-117-13 href=#__codelineno-117-13></a><span class=go>2021-02-19 00:00:00+00:00  0.084446  0.007935</span>
</span><span id=__span-117-14><a id=__codelineno-117-14 name=__codelineno-117-14 href=#__codelineno-117-14></a><span class=go>2021-02-20 00:00:00+00:00 -0.001159 -0.021483</span>
</span><span id=__span-117-15><a id=__codelineno-117-15 name=__codelineno-117-15 href=#__codelineno-117-15></a><span class=go>2021-02-21 00:00:00+00:00  0.028069  0.010732</span>
</span><span id=__span-117-16><a id=__codelineno-117-16 name=__codelineno-117-16 href=#__codelineno-117-16></a><span class=go>2021-02-22 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-117-17><a id=__codelineno-117-17 name=__codelineno-117-17 href=#__codelineno-117-17></a><span class=go>2021-02-23 00:00:00+00:00  0.096079  0.112338</span>
</span><span id=__span-117-18><a id=__codelineno-117-18 name=__codelineno-117-18 href=#__codelineno-117-18></a><span class=go>2021-02-24 00:00:00+00:00 -0.013245 -0.023012</span>
</span></code></pre></div> <p>To verify these values, compare them to the reconstructed returns:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-118-1><a id=__codelineno-118-1 name=__codelineno-118-1 href=#__codelineno-118-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>get_returns</span><span class=p>()</span>  <span class=c1># (1)!</span>
</span><span id=__span-118-2><a id=__codelineno-118-2 name=__codelineno-118-2 href=#__codelineno-118-2></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-118-3><a id=__codelineno-118-3 name=__codelineno-118-3 href=#__codelineno-118-3></a><span class=go>Open time                                    </span>
</span><span id=__span-118-4><a id=__codelineno-118-4 name=__codelineno-118-4 href=#__codelineno-118-4></a><span class=go>2021-02-18 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-118-5><a id=__codelineno-118-5 name=__codelineno-118-5 href=#__codelineno-118-5></a><span class=go>2021-02-19 00:00:00+00:00  0.084446  0.007935</span>
</span><span id=__span-118-6><a id=__codelineno-118-6 name=__codelineno-118-6 href=#__codelineno-118-6></a><span class=go>2021-02-20 00:00:00+00:00 -0.001159 -0.021483</span>
</span><span id=__span-118-7><a id=__codelineno-118-7 name=__codelineno-118-7 href=#__codelineno-118-7></a><span class=go>2021-02-21 00:00:00+00:00  0.028069  0.010732</span>
</span><span id=__span-118-8><a id=__codelineno-118-8 name=__codelineno-118-8 href=#__codelineno-118-8></a><span class=go>2021-02-22 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-118-9><a id=__codelineno-118-9 name=__codelineno-118-9 href=#__codelineno-118-9></a><span class=go>2021-02-23 00:00:00+00:00  0.096079  0.112338</span>
</span><span id=__span-118-10><a id=__codelineno-118-10 name=__codelineno-118-10 href=#__codelineno-118-10></a><span class=go>2021-02-24 00:00:00+00:00 -0.013245 -0.023012</span>
</span></code></pre></div> <ol> <li>Every attribute with <code>get_</code> triggers a reconstruction.</li> </ol> <p>Internally, <abbr title="From-signals simulation method">FS</abbr> creates a named tuple with an uninitialized returns array and gradually fills it at the end of each bar. Once the simulation is finished, this tuple is attached to the portfolio instance under the attribute <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.in_outputs>Portfolio.in_outputs</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-119-1><a id=__codelineno-119-1 name=__codelineno-119-1 href=#__codelineno-119-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>in_outputs</span>
</span><span id=__span-119-2><a id=__codelineno-119-2 name=__codelineno-119-2 href=#__codelineno-119-2></a><span class=go>FSInOutputs(returns=array([[ 0.        ,  0.        ],</span>
</span><span id=__span-119-3><a id=__codelineno-119-3 name=__codelineno-119-3 href=#__codelineno-119-3></a><span class=go>                           [ 0.08444579,  0.00793458],</span>
</span><span id=__span-119-4><a id=__codelineno-119-4 name=__codelineno-119-4 href=#__codelineno-119-4></a><span class=go>                           [-0.00115927, -0.02148338],</span>
</span><span id=__span-119-5><a id=__codelineno-119-5 name=__codelineno-119-5 href=#__codelineno-119-5></a><span class=go>                           [ 0.02806853,  0.01073183],</span>
</span><span id=__span-119-6><a id=__codelineno-119-6 name=__codelineno-119-6 href=#__codelineno-119-6></a><span class=go>                           [ 0.        ,  0.        ],</span>
</span><span id=__span-119-7><a id=__codelineno-119-7 name=__codelineno-119-7 href=#__codelineno-119-7></a><span class=go>                           [ 0.09607864,  0.11233812],</span>
</span><span id=__span-119-8><a id=__codelineno-119-8 name=__codelineno-119-8 href=#__codelineno-119-8></a><span class=go>                           [-0.01324464, -0.02301153]]))</span>
</span></code></pre></div> <p>Since most outputs from the simulator are in NumPy format, you can use the method <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.get_in_output>Portfolio.get_in_output</a> to wrap any array with Pandas:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-120-1><a id=__codelineno-120-1 name=__codelineno-120-1 href=#__codelineno-120-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>get_in_output</span><span class=p>(</span><span class=s2>&quot;returns&quot;</span><span class=p>)</span>
</span><span id=__span-120-2><a id=__codelineno-120-2 name=__codelineno-120-2 href=#__codelineno-120-2></a><span class=go>symbol                      BTCUSDT   ETHUSDT</span>
</span><span id=__span-120-3><a id=__codelineno-120-3 name=__codelineno-120-3 href=#__codelineno-120-3></a><span class=go>Open time                                    </span>
</span><span id=__span-120-4><a id=__codelineno-120-4 name=__codelineno-120-4 href=#__codelineno-120-4></a><span class=go>2021-02-18 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-120-5><a id=__codelineno-120-5 name=__codelineno-120-5 href=#__codelineno-120-5></a><span class=go>2021-02-19 00:00:00+00:00  0.084446  0.007935</span>
</span><span id=__span-120-6><a id=__codelineno-120-6 name=__codelineno-120-6 href=#__codelineno-120-6></a><span class=go>2021-02-20 00:00:00+00:00 -0.001159 -0.021483</span>
</span><span id=__span-120-7><a id=__codelineno-120-7 name=__codelineno-120-7 href=#__codelineno-120-7></a><span class=go>2021-02-21 00:00:00+00:00  0.028069  0.010732</span>
</span><span id=__span-120-8><a id=__codelineno-120-8 name=__codelineno-120-8 href=#__codelineno-120-8></a><span class=go>2021-02-22 00:00:00+00:00  0.000000  0.000000</span>
</span><span id=__span-120-9><a id=__codelineno-120-9 name=__codelineno-120-9 href=#__codelineno-120-9></a><span class=go>2021-02-23 00:00:00+00:00  0.096079  0.112338</span>
</span><span id=__span-120-10><a id=__codelineno-120-10 name=__codelineno-120-10 href=#__codelineno-120-10></a><span class=go>2021-02-24 00:00:00+00:00 -0.013245 -0.023012</span>
</span></code></pre></div> <p>There is one catch: the <code>save_returns</code> argument is available only in the fixed simulation mode, which means that none of the default callbacks have been overridden. As soon as you switch to flexible mode, you must define your own in-place output tuple using the <code>in_outputs</code> argument and fill it with any information you want, usually in the segment post-processing function <code>post_segment_func</code>. This callback receives the context <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.SignalSegmentContext>SignalSegmentContext</a>, which is similar to <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.SignalContext>SignalContext</a> but does not include information on the current column, since a segment can include multiple columns within a particular group at a given row. Therefore, you need to iterate over the columns in the current segment manually.</p> <p>For demonstration, here is a post-segment callback that fills the portfolio returns in the same way as the fixed <abbr title="From-signals simulation method">FS</abbr> mode does. Additionally, it stores the total portfolio return per column to avoid reconstructing it during post-analysis:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-121-1><a id=__codelineno-121-1 name=__codelineno-121-1 href=#__codelineno-121-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-121-2><a id=__codelineno-121-2 name=__codelineno-121-2 href=#__codelineno-121-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>post_segment_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span><span id=__span-121-3><a id=__codelineno-121-3 name=__codelineno-121-3 href=#__codelineno-121-3></a><span class=gp>... </span>    <span class=n>returns</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>returns</span>  <span class=c1># (1)!</span>
</span><span id=__span-121-4><a id=__codelineno-121-4 name=__codelineno-121-4 href=#__codelineno-121-4></a><span class=gp>... </span>    <span class=n>total_return</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>total_return</span>
</span><span id=__span-121-5><a id=__codelineno-121-5 name=__codelineno-121-5 href=#__codelineno-121-5></a><span class=gp>... </span>    <span class=n>i</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span>
</span><span id=__span-121-6><a id=__codelineno-121-6 name=__codelineno-121-6 href=#__codelineno-121-6></a><span class=gp>... </span>    <span class=n>g</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>group</span>
</span><span id=__span-121-7><a id=__codelineno-121-7 name=__codelineno-121-7 href=#__codelineno-121-7></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>cash_sharing</span><span class=p>:</span>  <span class=c1># (2)!</span>
</span><span id=__span-121-8><a id=__codelineno-121-8 name=__codelineno-121-8 href=#__codelineno-121-8></a><span class=gp>... </span>        <span class=n>returns</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>g</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_return</span><span class=p>[</span><span class=n>g</span><span class=p>]</span>
</span><span id=__span-121-9><a id=__codelineno-121-9 name=__codelineno-121-9 href=#__codelineno-121-9></a><span class=gp>... </span>        <span class=n>total_return</span><span class=p>[</span><span class=n>g</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_value</span><span class=p>[</span><span class=n>g</span><span class=p>]</span> <span class=o>/</span> <span class=n>c</span><span class=o>.</span><span class=n>init_cash</span><span class=p>[</span><span class=n>g</span><span class=p>]</span> <span class=o>-</span> <span class=mi>1</span>
</span><span id=__span-121-10><a id=__codelineno-121-10 name=__codelineno-121-10 href=#__codelineno-121-10></a><span class=gp>... </span>    <span class=k>else</span><span class=p>:</span>  <span class=c1># (3)!</span>
</span><span id=__span-121-11><a id=__codelineno-121-11 name=__codelineno-121-11 href=#__codelineno-121-11></a><span class=gp>... </span>        <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>from_col</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>to_col</span><span class=p>):</span>  <span class=c1># (4)!</span>
</span><span id=__span-121-12><a id=__codelineno-121-12 name=__codelineno-121-12 href=#__codelineno-121-12></a><span class=gp>... </span>            <span class=n>returns</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_return</span><span class=p>[</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-121-13><a id=__codelineno-121-13 name=__codelineno-121-13 href=#__codelineno-121-13></a><span class=gp>... </span>            <span class=n>total_return</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_value</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>/</span> <span class=n>c</span><span class=o>.</span><span class=n>init_cash</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>-</span> <span class=mi>1</span>
</span><span id=__span-121-14><a id=__codelineno-121-14 name=__codelineno-121-14 href=#__codelineno-121-14></a>
</span><span id=__span-121-15><a id=__codelineno-121-15 name=__codelineno-121-15 href=#__codelineno-121-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-121-16><a id=__codelineno-121-16 name=__codelineno-121-16 href=#__codelineno-121-16></a><span class=gp>... </span>    <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-121-17><a id=__codelineno-121-17 name=__codelineno-121-17 href=#__codelineno-121-17></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span>      <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-121-18><a id=__codelineno-121-18 name=__codelineno-121-18 href=#__codelineno-121-18></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span>        <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-121-19><a id=__codelineno-121-19 name=__codelineno-121-19 href=#__codelineno-121-19></a><span class=gp>... </span>    <span class=n>short_entries</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>]),</span>
</span><span id=__span-121-20><a id=__codelineno-121-20 name=__codelineno-121-20 href=#__codelineno-121-20></a><span class=gp>... </span>    <span class=n>short_exits</span><span class=o>=</span>  <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>O</span><span class=p>,</span> <span class=n>X</span><span class=p>]),</span>
</span><span id=__span-121-21><a id=__codelineno-121-21 name=__codelineno-121-21 href=#__codelineno-121-21></a><span class=gp>... </span>    <span class=n>post_segment_func_nb</span><span class=o>=</span><span class=n>post_segment_func_nb</span><span class=p>,</span>  <span class=c1># (5)!</span>
</span><span id=__span-121-22><a id=__codelineno-121-22 name=__codelineno-121-22 href=#__codelineno-121-22></a><span class=gp>... </span>    <span class=n>in_outputs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>  <span class=c1># (6)!</span>
</span><span id=__span-121-23><a id=__codelineno-121-23 name=__codelineno-121-23 href=#__codelineno-121-23></a><span class=gp>... </span>        <span class=n>returns</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span>  <span class=c1># (7)!</span>
</span><span id=__span-121-24><a id=__codelineno-121-24 name=__codelineno-121-24 href=#__codelineno-121-24></a><span class=gp>... </span>            <span class=s2>&quot;np.full((target_shape[0], len(cs_group_lens)), np.nan)&quot;</span>
</span><span id=__span-121-25><a id=__codelineno-121-25 name=__codelineno-121-25 href=#__codelineno-121-25></a><span class=gp>... </span>        <span class=p>),</span>
</span><span id=__span-121-26><a id=__codelineno-121-26 name=__codelineno-121-26 href=#__codelineno-121-26></a><span class=gp>... </span>        <span class=n>total_return</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span>
</span><span id=__span-121-27><a id=__codelineno-121-27 name=__codelineno-121-27 href=#__codelineno-121-27></a><span class=gp>... </span>            <span class=s2>&quot;np.full(len(cs_group_lens), np.nan)&quot;</span>
</span><span id=__span-121-28><a id=__codelineno-121-28 name=__codelineno-121-28 href=#__codelineno-121-28></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-121-29><a id=__codelineno-121-29 name=__codelineno-121-29 href=#__codelineno-121-29></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-121-30><a id=__codelineno-121-30 name=__codelineno-121-30 href=#__codelineno-121-30></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-121-31><a id=__codelineno-121-31 name=__codelineno-121-31 href=#__codelineno-121-31></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pd</span><span class=o>.</span><span class=n>testing</span><span class=o>.</span><span class=n>assert_frame_equal</span><span class=p>(</span>  <span class=c1># (8)!</span>
</span><span id=__span-121-32><a id=__codelineno-121-32 name=__codelineno-121-32 href=#__codelineno-121-32></a><span class=gp>... </span>    <span class=n>pf</span><span class=o>.</span><span class=n>get_in_output</span><span class=p>(</span><span class=s2>&quot;returns&quot;</span><span class=p>),</span>
</span><span id=__span-121-33><a id=__codelineno-121-33 name=__codelineno-121-33 href=#__codelineno-121-33></a><span class=gp>... </span>    <span class=n>pf</span><span class=o>.</span><span class=n>get_returns</span><span class=p>()</span>
</span><span id=__span-121-34><a id=__codelineno-121-34 name=__codelineno-121-34 href=#__codelineno-121-34></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-121-35><a id=__codelineno-121-35 name=__codelineno-121-35 href=#__codelineno-121-35></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pd</span><span class=o>.</span><span class=n>testing</span><span class=o>.</span><span class=n>assert_series_equal</span><span class=p>(</span>
</span><span id=__span-121-36><a id=__codelineno-121-36 name=__codelineno-121-36 href=#__codelineno-121-36></a><span class=gp>... </span>    <span class=n>pf</span><span class=o>.</span><span class=n>get_in_output</span><span class=p>(</span><span class=s2>&quot;total_return&quot;</span><span class=p>),</span>
</span><span id=__span-121-37><a id=__codelineno-121-37 name=__codelineno-121-37 href=#__codelineno-121-37></a><span class=gp>... </span>    <span class=n>pf</span><span class=o>.</span><span class=n>get_total_return</span><span class=p>()</span>
</span><span id=__span-121-38><a id=__codelineno-121-38 name=__codelineno-121-38 href=#__codelineno-121-38></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <ol> <li><a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.SignalSegmentContext.in_outputs>SignalSegmentContext.in_outputs</a> contains exactly the in-place output tuple that we provided.</li> <li>If cash sharing is enabled, returns must be computed per group.</li> <li>If cash sharing is disabled, returns must be computed per column.</li> <li>Iterate over each column in the current group.</li> <li>Overriding this callback is enough to switch to flexible mode.</li> <li>The in-place output tuple can be provided as either a named tuple or a dict. If provided as a dict, it will be automatically transformed into a named tuple by the method.</li> <li>Use expression evaluation templates to build arrays only after the target shape is established. Use <code>len(cs_group_lens)</code> to get the number of groups when cash sharing is enabled, and the number of columns when cash sharing is disabled.</li> <li>Check the pre-computed and reconstructed arrays for equality.</li> </ol> <p>The most impressive aspect of the approach above is that any pre-computed metric found among the attributes of the <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio>Portfolio</a> class is automatically used by any built-in property or method that requires it, such as <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.stats>Portfolio.stats</a>. The only limitation is that you cannot change the grouping after the array has been created; when that happens, the reconstructed version of the metric will be returned instead.</p> <h2 id=summary>Summary<a class=headerlink href=#summary title="Permanent link">&para;</a></h2> <p>Backtesting should not be complicated! One of the most crucial factors in successful trading is having proper entry and exit timing. By parametrizing both the timing and direction of our trades, we can theoretically achieve the worst and best possible returns in any market. Thus, representing a trading strategy as a permutation of buy, sell, short-sell, and short-cover signals is almost "<a href=https://en.wikipedia.org/wiki/Turing_completeness>Turing-complete</a>" in this sense. Reducing complex strategies to such a simple signal set has another advantage: it enables and standardizes backtesting for many trading strategies using the same code base. The method <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a> not only makes this possible, but also encourages you to adjust the simulation to define your own trading logic or to customize the default simulation behavior, making it a combination of both vectorized and event-driven approaches. However, not everything should be represented using signals: strategies that heavily rely on order details, such as rebalancing strategies, are best implemented using other methods. Fortunately, VBT provides solutions for these problems as well <img alt=ðŸ¥· class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f977.svg title=:ninja:></p> <p><a class=md-button href=https://vectorbt.pro/pvt_41531c19/assets/jupytext/documentation/portfolio/from-signals.py.txt target=blank_><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19.14 7.5A2.86 2.86 0 0 1 22 10.36v3.78A2.86 2.86 0 0 1 19.14 17H12c0 .39.32.96.71.96H17v1.68a2.86 2.86 0 0 1-2.86 2.86H9.86A2.86 2.86 0 0 1 7 19.64v-3.75a2.85 2.85 0 0 1 2.86-2.85h5.25a2.85 2.85 0 0 0 2.85-2.86V7.5zm-4.28 11.79c-.4 0-.72.3-.72.89s.32.71.72.71a.71.71 0 0 0 .71-.71c0-.59-.32-.89-.71-.89m-10-1.79A2.86 2.86 0 0 1 2 14.64v-3.78A2.86 2.86 0 0 1 4.86 8H12c0-.39-.32-.96-.71-.96H7V5.36A2.86 2.86 0 0 1 9.86 2.5h4.28A2.86 2.86 0 0 1 17 5.36v3.75a2.85 2.85 0 0 1-2.86 2.85H8.89a2.85 2.85 0 0 0-2.85 2.86v2.68zM9.14 5.71c.4 0 .72-.3.72-.89s-.32-.71-.72-.71c-.39 0-.71.12-.71.71s.32.89.71.89"/></svg></span> Python code</a></p> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=https://vectorbt.pro/pvt_41531c19/documentation/portfolio/from-orders/ class="md-footer__link md-footer__link--prev" aria-label="Previous: From orders"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> From orders </div> </div> </a> <a href=https://vectorbt.pro/pvt_41531c19/documentation/to-be-continued/ class="md-footer__link md-footer__link--next" aria-label="Next: To be continued..."> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> To be continued... </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2021-2025 Oleg Polakow. All rights reserved. </div> </div> <div class=md-social> <a href=https://www.linkedin.com/in/polakowo target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> <a href=https://github.com/polakowo target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <div class=md-consent data-md-component=consent id=__consent hidden> <div class=md-consent__overlay></div> <aside class=md-consent__inner> <form class="md-consent__form md-grid md-typeset" name=consent> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class=md-toggle type=checkbox id=__settings> <div class=md-consent__settings> <ul class=task-list> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=analytics checked> <span class=task-list-indicator></span> Google Analytics </label> </li> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=github checked> <span class=task-list-indicator></span> GitHub </label> </li> </ul> </div> <div class=md-consent__controls> <button class="md-button md-button--primary">Accept</button> <label class=md-button for=__settings>Manage settings</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script> <script id=__config type=application/json>{"annotate": null, "base": "../../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.instant", "navigation.instant.progress", "navigation.top", "navigation.prune", "navigation.path", "navigation.footer", "search.suggest", "search.share", "content.code.annotate", "content.code.copy", "content.code.select", "content.tooltips", "content.tabs.link", "toc.follow", "toc.integrate", "announce.dismiss"], "search": "../../../assets/javascripts/workers/search.26099bd0.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=https://vectorbt.pro/pvt_41531c19/assets/javascripts/bundle.9d1edc04.min.js></script> <script src=https://vectorbt.pro/pvt_41531c19/assets/scripts/extra.js></script> <script src=https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js></script> </body> 
<!-- Mirrored from vectorbt.pro/pvt_41531c19/documentation/portfolio/from-signals/ by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 22 Nov 2025 03:46:39 GMT -->
</html>