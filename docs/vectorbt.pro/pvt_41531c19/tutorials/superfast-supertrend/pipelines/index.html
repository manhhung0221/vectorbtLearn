<!doctype html><html lang=en class=no-js> 
<!-- Mirrored from vectorbt.pro/pvt_41531c19/tutorials/superfast-supertrend/pipelines/ by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 22 Nov 2025 03:46:49 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Learn how to backtest a SuperTrend indicator using VectorBT PRO"><meta name=author content="Oleg Polakow"><link href=https://vectorbt.pro/tutorials/superfast-supertrend/pipelines/ rel=canonical><link href=../multithreading/index.html rel=prev><link href=../../signal-development/generation/index.html rel=next><link rel=icon href=../../../assets/logo/favicon.png><meta name=generator content="mkdocs-1.6.0, mkdocs-material-9.6.21+insiders-4.53.17"><title>Pipelines - VectorBT® PRO</title><link rel=stylesheet href=../../../assets/stylesheets/main.010a373c.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=../../../../../fonts.gstatic.com/index.html crossorigin><link rel=stylesheet href="../../../../../fonts.googleapis.com/cssbe43.css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../assets/stylesheets/extra.css><link rel=stylesheet href=../../../assets/stylesheets/custom-light.css><link rel=stylesheet href=../../../assets/stylesheets/custom-dark.css><link rel=stylesheet href=../../../assets/stylesheets/pygments-light.css><link rel=stylesheet href=../../../assets/stylesheets/pygments-dark.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-0C5VNYCFHL"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-0C5VNYCFHL",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="../../../../../www.googletagmanager.com/gtag/jsc6c8?id=G-0C5VNYCFHL",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script><meta name=robots content="noindex, nofollow"><meta property=og:title content=Pipelines><meta property=og:type content=website><meta content=https://vectorbt.pro/tutorials/superfast-supertrend/pipelines/ property=og:url><meta property=og:image:url content=https://vectorbt.pro/pvt_41531c19/assets/logo/social-new.png><meta property=og:image:type content=image/png><meta property=og:description content="Learn how to backtest a SuperTrend indicator using VectorBT PRO"><meta property=og:locale content=en-GB><link rel=apple-touch-icon sizes=180x180 href=https://vectorbt.pro/pvt_41531c19/assets/logo/apple-touch-icon.png><link rel=icon type=image/svg+xml href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon.svg><link rel=icon type=image/png sizes=32x32 href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon-16x16.png><link rel=manifest href=https://vectorbt.pro/pvt_41531c19/assets/logo/site.webmanifest><link rel=mask-icon href=https://vectorbt.pro/pvt_41531c19/assets/logo/safari-pinned-tab.svg color=#1e1f22><link rel="shortcut icon" href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon.ico><meta name=msapplication-TileColor content=#1e1f22><meta name=msapplication-config content=https://vectorbt.pro/pvt_41531c19/assets/logo/browserconfig.xml><meta name=theme-color content=#1e1f22><link href=https://unpkg.com/aos@2.3.4/dist/aos.css rel=stylesheet><script src=https://unpkg.com/aos@2.3.4/dist/aos.js></script><link href=http://fonts.cdnfonts.com/css/uni-neue rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/js/all.min.js integrity="sha512-8pHNiqTlsrRjVD4A/3va++W1sMbUHwWxxRPWNyVlql3T+Hgfd81Qc6FC5WMXDC+tSauxxzp1tgiAvSKFu1qIlA==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js integrity="sha512-q583ppKrCRc7N5O0n2nzUiJ+suUv7Et1JGels4bXOaMFQcamPk9HjdUknZuuFjBNs7tsMuadge5k9RzdmO+1GQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><link rel=preconnect href=https://fonts.googleapis.com/><link rel=preconnect href=https://fonts.gstatic.com/ crossorigin></head> <body dir=ltr data-md-color-scheme=custom-dark data-md-color-primary=custom-dark data-md-color-accent=custom-dark> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#pipelines class=md-skip> Skip to content </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> <button class="md-banner__button md-icon" aria-label="Don't show this again"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> <i>What's new</i>: New LLM providers, reasoning steps, function calling, YAML & TOML support, and <a href=https://vectorbt.pro/pvt_41531c19/getting-started/release-notes><strong>more</strong></a> <span class="twemoji announce-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m153.6 29.9 16-21.3c4-5.4 10.4-8.6 17.1-8.6C198.4 0 208 9.6 208 21.3v22.1c0 13.1 5.4 25.7 14.9 34.7l84.7 80.9c48.8 46.6 76.4 111.2 76.4 178.7C384 434 306 512 209.7 512H192C86 512 0 426 0 320v-3.8c0-48.8 19.4-95.6 53.9-130.1l3.5-3.5c4.2-4.2 10-6.6 16-6.6 12.5 0 22.6 10.1 22.6 22.6V288c0 35.3 28.7 64 64 64s64-28.7 64-64v-3.9c0-18-7.2-35.3-19.9-48l-38.6-38.6c-24-24-37.5-56.7-37.5-90.7 0-27.7 9-54.8 25.6-76.9"/></svg></span> </div> <script>var el=document.querySelector("[data-md-component=announce]");if(el){var content=el.querySelector(".md-typeset");__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0)}</script> </aside> </div> <!-- Determine class according to configuration --> <!-- Header --> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=header.title> <!-- Link to home --> <a href=https://vectorbt.pro/pvt_41531c19/ title="VectorBT® PRO" class="md-header__button md-logo" aria-label="VectorBT® PRO" data-md-component=logo> <img src=https://vectorbt.pro/pvt_41531c19/assets/logo/logo.svg alt=logo class=logo> </a> <!-- Button to open drawer --> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <!-- Header title --> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> VectorBT® PRO <span class=md-version> v2025.10.15 </span> <span class=unlock-icon><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M192 32c-35.3 0-64 28.7-64 64v64h192c35.3 0 64 28.7 64 64v224c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V224c0-35.3 28.7-64 64-64V96c0-70.7 57.3-128 128-128 63.5 0 116.1 46.1 126.2 106.7 2.9 17.4-8.8 33.9-26.3 36.9S258 102.8 255 85.3C250 55.1 223.7 32 192 32m40 328c13.3 0 24-10.7 24-24s-10.7-24-24-24h-80c-13.3 0-24 10.7-24 24s10.7 24 24 24z"/></svg></span> </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Pipelines </span> </div> </div> </div> <!-- Color palette --> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=custom-dark data-md-color-primary=custom-dark data-md-color-accent=custom-dark aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=custom-light data-md-color-primary=custom-light data-md-color-accent=custom-light aria-label="Switch to dark mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <!-- Site language selector --> <!-- Button to open search modal --> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <!-- Search interface --> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <!-- Repository information --> <div class=md-header__source> <a href=https://github.com/polakowo/vectorbt.pro title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> vectorbt.pro </div> </a> </div> </nav> <!-- Navigation tabs (sticky) --> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/ class=md-tabs__link> Getting started </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/features/overview/ class=md-tabs__link> Features </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/overview/ class=md-tabs__link> Tutorials </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/documentation/overview/ class=md-tabs__link> Documentation </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/overview/ class=md-tabs__link> Cookbook </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/api/ class=md-tabs__link> API </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/terms/terms-of-use/ class=md-tabs__link> Terms </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://vectorbt.pro/pvt_41531c19/ title="VectorBT® PRO" class="md-nav__button md-logo" aria-label="VectorBT® PRO" data-md-component=logo> <img src=https://vectorbt.pro/pvt_41531c19/assets/logo/logo.svg alt=logo class=logo> </a> VectorBT® PRO </label> <div class=md-nav__source> <a href=https://github.com/polakowo/vectorbt.pro title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> vectorbt.pro </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/ class=md-nav__link> <span class=md-ellipsis> Getting started </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/features/overview/ class=md-nav__link> <span class=md-ellipsis> Features </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Tutorials </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Tutorials </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/overview/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/basic-rsi/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m3.5 18.5 6-6 4 4L22 6.92 20.59 5.5l-7.09 8-4-4L2 17z"/></svg> <span class=md-ellipsis> Basic RSI strategy </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3 checked> <label class=md-nav__link for=__nav_3_3 id=__nav_3_3_label tabindex=0> <span class=md-ellipsis> SuperFast SuperTrend </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> SuperFast SuperTrend </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/superfast-supertrend/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M11 9.47V11h3.76L13 14.53V13H9.24zM13 1 6 15h5v8l7-14h-5z"/></svg> <span class=md-ellipsis> SuperFast SuperTrend </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/superfast-supertrend/streaming/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M11 9.47V11h3.76L13 14.53V13H9.24zM13 1 6 15h5v8l7-14h-5z"/></svg> <span class=md-ellipsis> Streaming </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/superfast-supertrend/multithreading/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M11 9.47V11h3.76L13 14.53V13H9.24zM13 1 6 15h5v8l7-14h-5z"/></svg> <span class=md-ellipsis> Multithreading </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M11 9.47V11h3.76L13 14.53V13H9.24zM13 1 6 15h5v8l7-14h-5z"/></svg> <span class=md-ellipsis> Pipelines </span> <span class="md-nav__icon md-icon"></span> </label> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/superfast-supertrend/pipelines/ class="md-nav__link md-nav__link--active"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M11 9.47V11h3.76L13 14.53V13H9.24zM13 1 6 15h5v8l7-14h-5z"/></svg> <span class=md-ellipsis> Pipelines </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#chunked-pipeline class=md-nav__link> <span class=md-ellipsis> Chunked pipeline </span> </a> </li> <li class=md-nav__item> <a href=#numba-pipeline class=md-nav__link> <span class=md-ellipsis> Numba pipeline </span> </a> </li> <li class=md-nav__item> <a href=#contextualized-pipeline class=md-nav__link> <span class=md-ellipsis> Contextualized pipeline </span> </a> <nav class=md-nav aria-label="Contextualized pipeline"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#streaming-sharpe class=md-nav__link> <span class=md-ellipsis> Streaming Sharpe </span> </a> </li> <li class=md-nav__item> <a href=#callbacks class=md-nav__link> <span class=md-ellipsis> Callbacks </span> </a> </li> <li class=md-nav__item> <a href=#pipeline class=md-nav__link> <span class=md-ellipsis> Pipeline </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#bonus-own-simulator class=md-nav__link> <span class=md-ellipsis> Bonus: Own simulator </span> </a> </li> <li class=md-nav__item> <a href=#summary class=md-nav__link> <span class=md-ellipsis> Summary </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/signal-development/generation/ class=md-nav__link> <span class=md-ellipsis> Signal development </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/stop-signals/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 23h-2V1h2zm-4-4H5V5h4V3H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h4zM19 7v2h2V7zm0-2h2a2 2 0 0 0-2-2zm2 10h-2v2h2zm-2-4v2h2v-2zm-2-8h-2v2h2zm2 18c1.11 0 2-.89 2-2h-2zm-2-2h-2v2h2z"/></svg> <span class=md-ellipsis> Stop signals </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/mtf-analysis/ class=md-nav__link> <span class=md-ellipsis> MTF analysis </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/portfolio-optimization/ class=md-nav__link> <span class=md-ellipsis> Portfolio optimization </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/pairs-trading/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22 6.92 20.59 5.5l-2.85 3.22C15.68 6.4 12.83 5 9.61 5 6.72 5 4.07 6.16 2 8l1.42 1.42C5.12 7.93 7.27 7 9.61 7c2.74 0 5.09 1.26 6.77 3.24L13.5 13.5l-4-4L2 17l1.5 1.5 6-6 4 4 4.05-4.57c.75 1.35 1.25 2.9 1.45 4.57h2c-.22-2.32-.95-4.41-2.04-6.16z"/></svg> <span class=md-ellipsis> Pairs trading </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/patterns-and-projections/patterns/ class=md-nav__link> <span class=md-ellipsis> Patterns and projections </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/cross-validation/ class=md-nav__link> <span class=md-ellipsis> Cross-validation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/more-tutorials/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10.6 13.4a1 1 0 0 1-1.4 1.4 4.8 4.8 0 0 1 0-7l3.5-3.6a5.1 5.1 0 0 1 7.1 0 5.1 5.1 0 0 1 0 7.1l-1.5 1.5a6.4 6.4 0 0 0-.4-2.4l.5-.5a3.2 3.2 0 0 0 0-4.3 3.2 3.2 0 0 0-4.3 0l-3.5 3.6a2.9 2.9 0 0 0 0 4.2M23 18v2h-3v3h-2v-3h-3v-2h3v-3h2v3m-3.8-4.3a4.8 4.8 0 0 0-1.4-4.5 1 1 0 0 0-1.4 1.4 2.9 2.9 0 0 1 0 4.2l-3.5 3.6a3.2 3.2 0 0 1-4.3 0 3.2 3.2 0 0 1 0-4.3l.5-.4a7.3 7.3 0 0 1-.4-2.5l-1.5 1.5a5.1 5.1 0 0 0 0 7.1 5.1 5.1 0 0 0 7.1 0l1.8-1.8a6 6 0 0 1 3.1-4.3"/></svg> <span class=md-ellipsis> More tutorials </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/to-be-continued/ class=md-nav__link> <span class=md-ellipsis> To be continued... </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/documentation/overview/ class=md-nav__link> <span class=md-ellipsis> Documentation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/overview/ class=md-nav__link> <span class=md-ellipsis> Cookbook </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/api/ class=md-nav__link> <span class=md-ellipsis> API </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/terms/terms-of-use/ class=md-nav__link> <span class=md-ellipsis> Terms </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <nav class=md-path aria-label=Navigation> <ol class=md-path__list> <li class=md-path__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/overview/ class=md-path__link> <span class=md-ellipsis> Tutorials </span> </a> </li> <li class=md-path__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/superfast-supertrend/ class=md-path__link> <span class=md-ellipsis> SuperFast SuperTrend </span> </a> </li> </ol> </nav> <article class="md-content__inner md-typeset"> <h1 id=pipelines><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M11 9.47V11h3.76L13 14.53V13H9.24zM13 1 6 15h5v8l7-14h-5z"/></svg></span> Pipelines<a class=headerlink href=#pipelines title="Permanent link">&para;</a></h1> <p>Often, we need to consider not just the performance of deployed indicators, but also the overall health of the backtesting pipeline. An ultrafast indicator is not very helpful if the primary bottleneck is the portfolio simulator itself.</p> <p>Let's create a simple pipeline that accepts input data and strategy parameters, and returns the Sharpe ratio for each symbol and parameter combination:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>pipeline</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>period</span><span class=o>=</span><span class=mi>7</span><span class=p>,</span> <span class=n>multiplier</span><span class=o>=</span><span class=mi>3</span><span class=p>):</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>... </span>    <span class=n>high</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;High&#39;</span><span class=p>)</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>low</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;Low&#39;</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>close</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;Close&#39;</span><span class=p>)</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>st</span> <span class=o>=</span> <span class=n>SuperTrend</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span>        <span class=n>high</span><span class=p>,</span> 
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>... </span>        <span class=n>low</span><span class=p>,</span> 
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=gp>... </span>        <span class=n>close</span><span class=p>,</span> 
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=gp>... </span>        <span class=n>period</span><span class=o>=</span><span class=n>period</span><span class=p>,</span> 
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=gp>... </span>        <span class=n>multiplier</span><span class=o>=</span><span class=n>multiplier</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=gp>... </span>    <span class=n>entries</span> <span class=o>=</span> <span class=p>(</span><span class=o>~</span><span class=n>st</span><span class=o>.</span><span class=n>superl</span><span class=o>.</span><span class=n>isnull</span><span class=p>())</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>fshift</span><span class=p>()</span>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=gp>... </span>    <span class=n>exits</span> <span class=o>=</span> <span class=p>(</span><span class=o>~</span><span class=n>st</span><span class=o>.</span><span class=n>supers</span><span class=o>.</span><span class=n>isnull</span><span class=p>())</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>fshift</span><span class=p>()</span>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a><span class=gp>... </span>    <span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a><span class=gp>... </span>        <span class=n>close</span><span class=p>,</span> 
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a><span class=gp>... </span>        <span class=n>entries</span><span class=o>=</span><span class=n>entries</span><span class=p>,</span> 
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a><span class=gp>... </span>        <span class=n>exits</span><span class=o>=</span><span class=n>exits</span><span class=p>,</span> 
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a><span class=gp>... </span>        <span class=n>fees</span><span class=o>=</span><span class=mf>0.001</span><span class=p>,</span>
</span><span id=__span-0-19><a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a><span class=gp>... </span>        <span class=n>save_returns</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-0-20><a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a><span class=gp>... </span>        <span class=n>max_order_records</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-0-21><a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a><span class=gp>... </span>        <span class=n>freq</span><span class=o>=</span><span class=s1>&#39;1h&#39;</span>
</span><span id=__span-0-22><a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-0-23><a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>pf</span><span class=o>.</span><span class=n>sharpe_ratio</span>  <span class=c1># (3)!</span>
</span><span id=__span-0-24><a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a>
</span><span id=__span-0-25><a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pipeline</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-0-26><a id=__codelineno-0-26 name=__codelineno-0-26 href=#__codelineno-0-26></a><span class=go>st_period  st_multiplier  symbol </span>
</span><span id=__span-0-27><a id=__codelineno-0-27 name=__codelineno-0-27 href=#__codelineno-0-27></a><span class=go>7          3              BTCUSDT    1.521221</span>
</span><span id=__span-0-28><a id=__codelineno-0-28 name=__codelineno-0-28 href=#__codelineno-0-28></a><span class=go>                          ETHUSDT    2.258501</span>
</span><span id=__span-0-29><a id=__codelineno-0-29 name=__codelineno-0-29 href=#__codelineno-0-29></a><span class=go>Name: sharpe_ratio, dtype: float64</span>
</span><span id=__span-0-30><a id=__codelineno-0-30 name=__codelineno-0-30 href=#__codelineno-0-30></a>
</span><span id=__span-0-31><a id=__codelineno-0-31 name=__codelineno-0-31 href=#__codelineno-0-31></a><span class=gp>&gt;&gt;&gt; </span><span class=o>%%</span><span class=n>timeit</span>
</span><span id=__span-0-32><a id=__codelineno-0-32 name=__codelineno-0-32 href=#__codelineno-0-32></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pipeline</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-0-33><a id=__codelineno-0-33 name=__codelineno-0-33 href=#__codelineno-0-33></a><span class=go>32.5 ms ± 1.12 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)</span>
</span></code></pre></div> <ol> <li>Pre-calculate the returns.</li> <li>Do not generate order records since we only need the returns.</li> <li><a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio>Portfolio</a> can automatically recognize that the returns were pre-calculated and use them instead of computing them from scratch.</li> </ol> <p>The indicator takes roughly 3 milliseconds for both columns, or about 10% of the total execution time. The remaining 90% is spent selecting the data, creating <code>entries</code> and <code>exits</code>, running the simulation, and calculating the Sharpe ratios.</p> <p>As you might expect, most of the processing occurs during the simulation: VBT must update the cash balance, group value, and other metrics at each time step to maintain the trading environment. After the simulation, it processes the data one or more times to reconstruct the attributes required for various statistics, such as cash flow, cash, asset flow, assets, asset value, portfolio value, and finally, returns. If all this information were stored during the simulation, memory would be exhausted quickly. Fortunately, we can avoid this reconstruction phase by pre-computing the returns, as shown above.</p> <p>Now, what do you think the execution time would be if you ran the same pipeline 336 times? Would you guess 10 seconds?</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>op_tree</span> <span class=o>=</span> <span class=p>(</span><span class=n>product</span><span class=p>,</span> <span class=n>periods</span><span class=p>,</span> <span class=n>multipliers</span><span class=p>)</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>period_product</span><span class=p>,</span> <span class=n>multiplier_product</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>generate_param_combs</span><span class=p>(</span><span class=n>op_tree</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>period_product</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>period_product</span><span class=p>)</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>multiplier_product</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>multiplier_product</span><span class=p>)</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=gp>&gt;&gt;&gt; </span><span class=o>%%</span><span class=n>timeit</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pipeline</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>period_product</span><span class=p>,</span> <span class=n>multiplier_product</span><span class=p>)</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=go>2.38 s ± 142 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</span></code></pre></div> <ol> <li>Using <a href=https://vectorbt.pro/pvt_41531c19/api/utils/params/#vectorbtpro.utils.params.generate_param_combs>generate_param_combs</a>.</li> </ol> <p>That's only 1/5 of your estimate. This is because VBT can process wide arrays efficiently. However, as you begin testing thousands of parameter combinations, performance will start to drop. Generally, stacking many columns at once consumes much more memory than looping through them, and once your system uses all available memory, it may switch to swap memory, which is much slower than RAM. How do we solve this?</p> <h3 id=chunked-pipeline>Chunked pipeline<a class=headerlink href=#chunked-pipeline title="Permanent link">&para;</a></h3> <p>To avoid memory issues, let's make our pipeline chunkable. Chunking in VBT allows you to split arguments (in this case, parameter combinations) so that only one group of argument values is passed to the pipeline function at a time. This is done using the <a href=https://vectorbt.pro/pvt_41531c19/api/utils/chunking/#vectorbtpro.utils.chunking.chunked>chunked</a> decorator:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>chunked_pipeline</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>chunked</span><span class=p>(</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>LenSizer</span><span class=p>(</span><span class=n>arg_query</span><span class=o>=</span><span class=s1>&#39;period&#39;</span><span class=p>,</span> <span class=n>single_type</span><span class=o>=</span><span class=nb>int</span><span class=p>),</span>  <span class=c1># (1)!</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=gp>... </span>    <span class=n>arg_take_spec</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>  <span class=c1># (2)!</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=gp>... </span>        <span class=n>data</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>  <span class=c1># (3)!</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=gp>... </span>        <span class=n>period</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>ChunkSlicer</span><span class=p>(),</span>  <span class=c1># (4)!</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=gp>... </span>        <span class=n>multiplier</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>ChunkSlicer</span><span class=p>()</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=gp>... </span>    <span class=n>merge_func</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>(</span><span class=n>x</span><span class=p>)</span><span class=o>.</span><span class=n>sort_index</span><span class=p>()</span>  <span class=c1># (5)!</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=gp>... </span><span class=p>)(</span><span class=n>pipeline</span><span class=p>)</span>
</span></code></pre></div> <ol> <li>Get the total number of values to be chunked by measuring the length of <code>period</code> using <a href=https://vectorbt.pro/pvt_41531c19/api/utils/chunking/#vectorbtpro.utils.chunking.LenSizer>LenSizer</a>. If <code>period</code> is an integer, it is treated as a single value.</li> <li>Specification for splitting any argument passed to the <code>pipeline</code> function.</li> <li>Pass the data as-is (without splitting).</li> <li>Slice the values of each parameter into chunks using <a href=https://vectorbt.pro/pvt_41531c19/api/utils/chunking/#vectorbtpro.utils.chunking.ChunkSlicer>ChunkSlicer</a>.</li> <li>Each chunk returns a Series with Sharpe values. Concatenate the list of Series returned by all chunks using Pandas and sort the resulting Series.</li> </ol> <p>The returned <code>chunked_pipeline</code> function has the same signature (accepted arguments and their order) as the original <code>pipeline</code>, but now it can internally split all arguments thanks to the chunking specification we provided. It measures the number of elements in <code>period</code> and, by default, creates the same number of chunks as there are CPU cores. Each chunk receives the same input data as <code>data</code> (only a reference, not a copy!), and a slice of the values in <code>period</code> and <code>multiplier</code>. After processing all chunks, it merges their results using Pandas, giving you the same output as if all parameter combinations were processed at once. Impressive, right?</p> <p>Let's test the chunked pipeline on a single combination:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=go>st_period  st_multiplier  symbol </span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=go>7          3              BTCUSDT    1.521221</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=go>                          ETHUSDT    2.258501</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=go>Name: sharpe_ratio, dtype: float64</span>
</span></code></pre></div> <p>We get the same results as with <code>pipeline</code>, which is expected. How about multiple combinations? Let's run <code>chunked_pipeline</code> on 4 combinations, split into 2 chunks, and also display the progress bar:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>chunked_pipeline</span><span class=p>(</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=gp>... </span>    <span class=n>data</span><span class=p>,</span> 
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=gp>... </span>    <span class=n>period_product</span><span class=p>[:</span><span class=mi>4</span><span class=p>],</span> 
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=gp>... </span>    <span class=n>multiplier_product</span><span class=p>[:</span><span class=mi>4</span><span class=p>],</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=gp>... </span>    <span class=n>_n_chunks</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <ol> <li>Any argument passed to the <a href=https://vectorbt.pro/pvt_41531c19/api/utils/chunking/#vectorbtpro.utils.chunking.chunked>chunked</a> decorator can be overridden at runtime by using the same argument name prefixed with an underscore <code>_</code>.</li> </ol> <p> <div class="progress progress-100plus candystripe candystripe-animate"> <div class=progress-bar style=width:100.00%> <p class=progress-label>Chunk 2/2</p> </div> </div> </p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=go>st_period  st_multiplier  symbol </span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=go>4          2.0            BTCUSDT    0.451699</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=go>                          ETHUSDT    1.391032</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=go>           2.1            BTCUSDT    0.495387</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=go>                          ETHUSDT    1.134741</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=go>           2.2            BTCUSDT    0.985946</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=go>                          ETHUSDT    0.955616</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=go>           2.3            BTCUSDT    1.193179</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=go>                          ETHUSDT    1.307505</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=go>Name: sharpe_ratio, dtype: float64</span>
</span></code></pre></div> <p>How can we check if the arguments were split correctly?</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>chunk_meta</span><span class=p>,</span> <span class=n>tasks</span> <span class=o>=</span> <span class=n>chunked_pipeline</span><span class=p>(</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=gp>... </span>    <span class=n>data</span><span class=p>,</span> 
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=gp>... </span>    <span class=n>period_product</span><span class=p>[:</span><span class=mi>4</span><span class=p>],</span> 
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=gp>... </span>    <span class=n>multiplier_product</span><span class=p>[:</span><span class=mi>4</span><span class=p>],</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=gp>... </span>    <span class=n>_n_chunks</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=gp>... </span>    <span class=n>_return_raw_chunks</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>chunk_meta</span>  <span class=c1># (1)!</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=go>[ChunkMeta(uuid=&#39;0882b000-52ab-4694-bb7c-341a9370937b&#39;, idx=0, start=0, end=2, indices=None),</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a><span class=go> ChunkMeta(uuid=&#39;1d5a74d9-d517-437d-a20a-4580f601a280&#39;, idx=1, start=2, end=4, indices=None)]</span>
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a>
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>list</span><span class=p>(</span><span class=n>tasks</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-6-14><a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a><span class=go>[(&lt;function __main__.pipeline(data, period=7, multiplier=3)&gt;,</span>
</span><span id=__span-6-15><a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a><span class=go>  (&lt;vectorbtpro.data.custom.hdf.HDFData at 0x7f7b30509a60&gt;,</span>
</span><span id=__span-6-16><a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a><span class=go>   array([4, 4]),</span>
</span><span id=__span-6-17><a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a><span class=go>   array([2., 2.1])),</span>
</span><span id=__span-6-18><a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a><span class=go>  {}),</span>
</span><span id=__span-6-19><a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a><span class=go> (&lt;function __main__.pipeline(data, period=7, multiplier=3)&gt;,</span>
</span><span id=__span-6-20><a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a><span class=go>  (&lt;vectorbtpro.data.custom.hdf.HDFData at 0x7f7b30509a60&gt;,</span>
</span><span id=__span-6-21><a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a><span class=go>   array([4, 4]),</span>
</span><span id=__span-6-22><a id=__codelineno-6-22 name=__codelineno-6-22 href=#__codelineno-6-22></a><span class=go>   array([2.2, 2.3])),</span>
</span><span id=__span-6-23><a id=__codelineno-6-23 name=__codelineno-6-23 href=#__codelineno-6-23></a><span class=go>  {})]</span>
</span></code></pre></div> <ol> <li>Generated chunks of type <a href=https://vectorbt.pro/pvt_41531c19/api/utils/chunking/#vectorbtpro.utils.chunking.ChunkMeta>ChunkMeta</a>. Arguments <code>period</code> and <code>multiplier</code> were sliced based on <code>start</code> and <code>end</code>.</li> <li>Each chunk receives the same data but a different set of parameter combinations.</li> </ol> <p>The first chunk contains the combinations <code>(4, 2.0)</code> and <code>(4, 2.1)</code>. The second chunk contains the combinations <code>(4, 2.2)</code> and <code>(4, 2.3)</code>.</p> <p>Here is how long it takes to run all parameter combinations:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=gp>&gt;&gt;&gt; </span><span class=o>%%</span><span class=n>timeit</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>chunked_pipeline</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>period_product</span><span class=p>,</span> <span class=n>multiplier_product</span><span class=p>)</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=go>2.33 s ± 50.9 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</span></code></pre></div> <p>We do not observe any performance increase because there is no multiprocessing or multithreading occurring, but chunking is mainly about memory savings and maintaining memory health. However, do not overdo it! Looping over all parameter combinations and processing just one at a time is much slower because VBT cannot leverage multidimensionality:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=gp>&gt;&gt;&gt; </span><span class=o>%%</span><span class=n>timeit</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>chunked_pipeline</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>period_product</span><span class=p>,</span> <span class=n>multiplier_product</span><span class=p>,</span> <span class=n>_chunk_len</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=go>11.4 s ± 965 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</span></code></pre></div> <p>What is best? Usually, something in between. The default values are generally sufficient.</p> <h2 id=numba-pipeline>Numba pipeline<a class=headerlink href=#numba-pipeline title="Permanent link">&para;</a></h2> <p>Wouldn't it be great if we could parallelize our pipeline just like we did with the indicator? Unfortunately, our Python code cannot achieve concurrency because it holds the GIL. But remember, Numba can release the GIL to enable multithreading! If only we could write the entire pipeline in Numba... Let's do it!</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span><span class=p>(</span><span class=n>nogil</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>pipeline_nb</span><span class=p>(</span><span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span> <span class=n>close</span><span class=p>,</span> 
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=gp>... </span>                <span class=n>periods</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>([</span><span class=mi>7</span><span class=p>]),</span>  <span class=c1># (1)!</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=gp>... </span>                <span class=n>multipliers</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>([</span><span class=mi>3</span><span class=p>]),</span> 
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=gp>... </span>                <span class=n>ann_factor</span><span class=o>=</span><span class=mi>365</span><span class=p>):</span>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=gp>...</span>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=gp>... </span>    <span class=c1># (2)!</span>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=gp>... </span>    <span class=n>sharpe</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>periods</span><span class=o>.</span><span class=n>size</span> <span class=o>*</span> <span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>float_</span><span class=p>)</span>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a><span class=gp>... </span>    <span class=n>long_entries</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>bool_</span><span class=p>)</span>
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=gp>... </span>    <span class=n>long_exits</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>bool_</span><span class=p>)</span>
</span><span id=__span-9-11><a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a><span class=gp>... </span>    <span class=n>group_lens</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mi>1</span><span class=p>)</span>
</span><span id=__span-9-12><a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a><span class=gp>... </span>    <span class=n>init_cash</span> <span class=o>=</span> <span class=mf>100.</span>
</span><span id=__span-9-13><a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a><span class=gp>... </span>    <span class=n>fees</span> <span class=o>=</span> <span class=mf>0.001</span>
</span><span id=__span-9-14><a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a><span class=gp>... </span>    <span class=n>k</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-9-15><a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a><span class=gp>... </span>    
</span><span id=__span-9-16><a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>periods</span><span class=o>.</span><span class=n>size</span><span class=p>):</span>
</span><span id=__span-9-17><a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a><span class=gp>... </span>        <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]):</span>
</span><span id=__span-9-18><a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a><span class=gp>... </span>            <span class=n>_</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>superl</span><span class=p>,</span> <span class=n>supers</span> <span class=o>=</span> <span class=n>superfast_supertrend_nb</span><span class=p>(</span>  <span class=c1># (3)!</span>
</span><span id=__span-9-19><a id=__codelineno-9-19 name=__codelineno-9-19 href=#__codelineno-9-19></a><span class=gp>... </span>                <span class=n>high</span><span class=p>[:,</span> <span class=n>col</span><span class=p>],</span> 
</span><span id=__span-9-20><a id=__codelineno-9-20 name=__codelineno-9-20 href=#__codelineno-9-20></a><span class=gp>... </span>                <span class=n>low</span><span class=p>[:,</span> <span class=n>col</span><span class=p>],</span> 
</span><span id=__span-9-21><a id=__codelineno-9-21 name=__codelineno-9-21 href=#__codelineno-9-21></a><span class=gp>... </span>                <span class=n>close</span><span class=p>[:,</span> <span class=n>col</span><span class=p>],</span> 
</span><span id=__span-9-22><a id=__codelineno-9-22 name=__codelineno-9-22 href=#__codelineno-9-22></a><span class=gp>... </span>                <span class=n>periods</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> 
</span><span id=__span-9-23><a id=__codelineno-9-23 name=__codelineno-9-23 href=#__codelineno-9-23></a><span class=gp>... </span>                <span class=n>multipliers</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-9-24><a id=__codelineno-9-24 name=__codelineno-9-24 href=#__codelineno-9-24></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-9-25><a id=__codelineno-9-25 name=__codelineno-9-25 href=#__codelineno-9-25></a><span class=gp>... </span>            <span class=n>long_entries</span><span class=p>[:,</span> <span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>fshift_1d_nb</span><span class=p>(</span>  <span class=c1># (4)!</span>
</span><span id=__span-9-26><a id=__codelineno-9-26 name=__codelineno-9-26 href=#__codelineno-9-26></a><span class=gp>... </span>                <span class=o>~</span><span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>superl</span><span class=p>),</span> 
</span><span id=__span-9-27><a id=__codelineno-9-27 name=__codelineno-9-27 href=#__codelineno-9-27></a><span class=gp>... </span>                <span class=n>fill_value</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-9-28><a id=__codelineno-9-28 name=__codelineno-9-28 href=#__codelineno-9-28></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-9-29><a id=__codelineno-9-29 name=__codelineno-9-29 href=#__codelineno-9-29></a><span class=gp>... </span>            <span class=n>long_exits</span><span class=p>[:,</span> <span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>fshift_1d_nb</span><span class=p>(</span>
</span><span id=__span-9-30><a id=__codelineno-9-30 name=__codelineno-9-30 href=#__codelineno-9-30></a><span class=gp>... </span>                <span class=o>~</span><span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>supers</span><span class=p>),</span> 
</span><span id=__span-9-31><a id=__codelineno-9-31 name=__codelineno-9-31 href=#__codelineno-9-31></a><span class=gp>... </span>                <span class=n>fill_value</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-9-32><a id=__codelineno-9-32 name=__codelineno-9-32 href=#__codelineno-9-32></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-9-33><a id=__codelineno-9-33 name=__codelineno-9-33 href=#__codelineno-9-33></a><span class=gp>... </span>            
</span><span id=__span-9-34><a id=__codelineno-9-34 name=__codelineno-9-34 href=#__codelineno-9-34></a><span class=gp>... </span>        <span class=n>sim_out</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>from_signals_nb</span><span class=p>(</span>  <span class=c1># (5)!</span>
</span><span id=__span-9-35><a id=__codelineno-9-35 name=__codelineno-9-35 href=#__codelineno-9-35></a><span class=gp>... </span>            <span class=n>target_shape</span><span class=o>=</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span>
</span><span id=__span-9-36><a id=__codelineno-9-36 name=__codelineno-9-36 href=#__codelineno-9-36></a><span class=gp>... </span>            <span class=n>group_lens</span><span class=o>=</span><span class=n>group_lens</span><span class=p>,</span>
</span><span id=__span-9-37><a id=__codelineno-9-37 name=__codelineno-9-37 href=#__codelineno-9-37></a><span class=gp>... </span>            <span class=n>init_cash</span><span class=o>=</span><span class=n>init_cash</span><span class=p>,</span>
</span><span id=__span-9-38><a id=__codelineno-9-38 name=__codelineno-9-38 href=#__codelineno-9-38></a><span class=gp>... </span>            <span class=n>high</span><span class=o>=</span><span class=n>high</span><span class=p>,</span>
</span><span id=__span-9-39><a id=__codelineno-9-39 name=__codelineno-9-39 href=#__codelineno-9-39></a><span class=gp>... </span>            <span class=n>low</span><span class=o>=</span><span class=n>low</span><span class=p>,</span>
</span><span id=__span-9-40><a id=__codelineno-9-40 name=__codelineno-9-40 href=#__codelineno-9-40></a><span class=gp>... </span>            <span class=n>close</span><span class=o>=</span><span class=n>close</span><span class=p>,</span>
</span><span id=__span-9-41><a id=__codelineno-9-41 name=__codelineno-9-41 href=#__codelineno-9-41></a><span class=gp>... </span>            <span class=n>long_entries</span><span class=o>=</span><span class=n>long_entries</span><span class=p>,</span>
</span><span id=__span-9-42><a id=__codelineno-9-42 name=__codelineno-9-42 href=#__codelineno-9-42></a><span class=gp>... </span>            <span class=n>long_exits</span><span class=o>=</span><span class=n>long_exits</span><span class=p>,</span>
</span><span id=__span-9-43><a id=__codelineno-9-43 name=__codelineno-9-43 href=#__codelineno-9-43></a><span class=gp>... </span>            <span class=n>fees</span><span class=o>=</span><span class=n>fees</span><span class=p>,</span>
</span><span id=__span-9-44><a id=__codelineno-9-44 name=__codelineno-9-44 href=#__codelineno-9-44></a><span class=gp>... </span>            <span class=n>save_returns</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-9-45><a id=__codelineno-9-45 name=__codelineno-9-45 href=#__codelineno-9-45></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-9-46><a id=__codelineno-9-46 name=__codelineno-9-46 href=#__codelineno-9-46></a><span class=gp>... </span>        <span class=n>returns</span> <span class=o>=</span> <span class=n>sim_out</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>returns</span>
</span><span id=__span-9-47><a id=__codelineno-9-47 name=__codelineno-9-47 href=#__codelineno-9-47></a><span class=gp>... </span>        <span class=n>_sharpe</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>ret_nb</span><span class=o>.</span><span class=n>sharpe_ratio_nb</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>ann_factor</span><span class=p>,</span> <span class=n>ddof</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># (6)!</span>
</span><span id=__span-9-48><a id=__codelineno-9-48 name=__codelineno-9-48 href=#__codelineno-9-48></a><span class=gp>... </span>        <span class=n>sharpe</span><span class=p>[</span><span class=n>k</span><span class=p>:</span><span class=n>k</span> <span class=o>+</span> <span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]]</span> <span class=o>=</span> <span class=n>_sharpe</span>  <span class=c1># (7)!</span>
</span><span id=__span-9-49><a id=__codelineno-9-49 name=__codelineno-9-49 href=#__codelineno-9-49></a><span class=gp>... </span>        <span class=n>k</span> <span class=o>+=</span> <span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-9-50><a id=__codelineno-9-50 name=__codelineno-9-50 href=#__codelineno-9-50></a><span class=gp>... </span>        
</span><span id=__span-9-51><a id=__codelineno-9-51 name=__codelineno-9-51 href=#__codelineno-9-51></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>sharpe</span>
</span></code></pre></div> <ol> <li>When using Numba, arguments cannot be both scalars and arrays. You need to select one data type, so we switch to using arrays only.</li> <li>Since many arrays have fixed shapes, create them outside the loop.</li> <li>Run <code>superfast_supertrend_nb</code> on each column.</li> <li>Shift the signals one tick forward.</li> <li>Use <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.from_signals_nb>from_signals_nb</a>.</li> <li>Use <a href=https://vectorbt.pro/pvt_41531c19/api/returns/nb/#vectorbtpro.returns.nb.sharpe_ratio_nb>sharpe_ratio_nb</a>.</li> <li>The output array <code>sharpe</code> stores one element per column and parameter combination.</li> </ol> <p>Running this pipeline on one parameter combination yields two familiar Sharpe values, one for each column in <code>high</code>, <code>low</code>, and <code>close</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>ann_factor</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pd_acc</span><span class=o>.</span><span class=n>returns</span><span class=o>.</span><span class=n>get_ann_factor</span><span class=p>(</span><span class=n>freq</span><span class=o>=</span><span class=s1>&#39;1h&#39;</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pipeline_nb</span><span class=p>(</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=gp>... </span>    <span class=n>high</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=gp>... </span>    <span class=n>low</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=gp>... </span>    <span class=n>close</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=gp>... </span>    <span class=n>ann_factor</span><span class=o>=</span><span class=n>ann_factor</span>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a><span class=go>array([1.521221, 2.25850084])</span>
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a>
</span><span id=__span-10-10><a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a><span class=gp>&gt;&gt;&gt; </span><span class=o>%%</span><span class=n>timeit</span>
</span><span id=__span-10-11><a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pipeline_nb</span><span class=p>(</span>
</span><span id=__span-10-12><a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a><span class=gp>... </span>    <span class=n>high</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-10-13><a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a><span class=gp>... </span>    <span class=n>low</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-10-14><a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a><span class=gp>... </span>    <span class=n>close</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-10-15><a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a><span class=gp>... </span>    <span class=n>ann_factor</span><span class=o>=</span><span class=n>ann_factor</span>
</span><span id=__span-10-16><a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-10-17><a id=__codelineno-10-17 name=__codelineno-10-17 href=#__codelineno-10-17></a><span class=go>3.13 ms ± 544 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)</span>
</span></code></pre></div> <ol> <li>Get the annualization factor using <a href=https://vectorbt.pro/pvt_41531c19/api/returns/accessors/#vectorbtpro.returns.accessors.ReturnsAccessor.get_ann_factor>ReturnsAccessor.get_ann_factor</a>.</li> </ol> <p>One iteration of <code>pipeline_nb</code> is already 10x faster than one iteration of <code>pipeline</code>.</p> <p>The next step is to create a chunked pipeline. Since the returned values are no longer Pandas Series, we cannot simply join them and expect everything to work. We need to manually concatenate them and build a multi-level index for further analysis.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>merge_func</span><span class=p>(</span><span class=n>arrs</span><span class=p>,</span> <span class=n>ann_args</span><span class=p>,</span> <span class=n>input_columns</span><span class=p>):</span>  <span class=c1># (1)!</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=gp>... </span>    <span class=n>arr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>(</span><span class=n>arrs</span><span class=p>)</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=gp>... </span>    <span class=n>param_index</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>stack_indexes</span><span class=p>((</span>  <span class=c1># (2)!</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=gp>... </span>        <span class=n>pd</span><span class=o>.</span><span class=n>Index</span><span class=p>(</span><span class=n>ann_args</span><span class=p>[</span><span class=s1>&#39;periods&#39;</span><span class=p>][</span><span class=s1>&#39;value&#39;</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;st_period&#39;</span><span class=p>),</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=gp>... </span>        <span class=n>pd</span><span class=o>.</span><span class=n>Index</span><span class=p>(</span><span class=n>ann_args</span><span class=p>[</span><span class=s1>&#39;multipliers&#39;</span><span class=p>][</span><span class=s1>&#39;value&#39;</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;st_multiplier&#39;</span><span class=p>)</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=gp>... </span>    <span class=p>))</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=gp>... </span>    <span class=n>index</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>combine_indexes</span><span class=p>((</span>  <span class=c1># (3)!</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=gp>... </span>        <span class=n>param_index</span><span class=p>,</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a><span class=gp>... </span>        <span class=n>input_columns</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a><span class=gp>... </span>    <span class=p>))</span>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>(</span><span class=n>arr</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=n>index</span><span class=p>)</span>  <span class=c1># (4)!</span>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>nb_chunked</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>chunked</span><span class=p>(</span>
</span><span id=__span-11-14><a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>ArraySizer</span><span class=p>(</span><span class=n>arg_query</span><span class=o>=</span><span class=s1>&#39;periods&#39;</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>),</span>  <span class=c1># (5)!</span>
</span><span id=__span-11-15><a id=__codelineno-11-15 name=__codelineno-11-15 href=#__codelineno-11-15></a><span class=gp>... </span>    <span class=n>arg_take_spec</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-11-16><a id=__codelineno-11-16 name=__codelineno-11-16 href=#__codelineno-11-16></a><span class=gp>... </span>        <span class=n>high</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>  <span class=c1># (6)!</span>
</span><span id=__span-11-17><a id=__codelineno-11-17 name=__codelineno-11-17 href=#__codelineno-11-17></a><span class=gp>... </span>        <span class=n>low</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span><span id=__span-11-18><a id=__codelineno-11-18 name=__codelineno-11-18 href=#__codelineno-11-18></a><span class=gp>... </span>        <span class=n>close</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span><span id=__span-11-19><a id=__codelineno-11-19 name=__codelineno-11-19 href=#__codelineno-11-19></a><span class=gp>... </span>        <span class=n>periods</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>ArraySlicer</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>),</span>
</span><span id=__span-11-20><a id=__codelineno-11-20 name=__codelineno-11-20 href=#__codelineno-11-20></a><span class=gp>... </span>        <span class=n>multipliers</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>ArraySlicer</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>),</span>
</span><span id=__span-11-21><a id=__codelineno-11-21 name=__codelineno-11-21 href=#__codelineno-11-21></a><span class=gp>... </span>        <span class=n>ann_factor</span><span class=o>=</span><span class=kc>None</span>
</span><span id=__span-11-22><a id=__codelineno-11-22 name=__codelineno-11-22 href=#__codelineno-11-22></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-11-23><a id=__codelineno-11-23 name=__codelineno-11-23 href=#__codelineno-11-23></a><span class=gp>... </span>    <span class=n>merge_func</span><span class=o>=</span><span class=n>merge_func</span><span class=p>,</span>
</span><span id=__span-11-24><a id=__codelineno-11-24 name=__codelineno-11-24 href=#__codelineno-11-24></a><span class=gp>... </span>    <span class=n>merge_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-11-25><a id=__codelineno-11-25 name=__codelineno-11-25 href=#__codelineno-11-25></a><span class=gp>... </span>        <span class=n>ann_args</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;ann_args&quot;</span><span class=p>)</span>
</span><span id=__span-11-26><a id=__codelineno-11-26 name=__codelineno-11-26 href=#__codelineno-11-26></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-11-27><a id=__codelineno-11-27 name=__codelineno-11-27 href=#__codelineno-11-27></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-11-28><a id=__codelineno-11-28 name=__codelineno-11-28 href=#__codelineno-11-28></a><span class=gp>&gt;&gt;&gt; </span><span class=n>chunked_pipeline_nb</span> <span class=o>=</span> <span class=n>nb_chunked</span><span class=p>(</span><span class=n>pipeline_nb</span><span class=p>)</span>
</span></code></pre></div> <ol> <li>The merging function takes a list of one-dimensional NumPy arrays returned by the pipeline, one per chunk. With <code>merge_kwargs</code>, we also request the annotated arguments to access the passed parameter values. Additionally, to combine parameter labels with column labels, we need the column labels specified at each run.</li> <li>Stack the parameter labels since all parameter values at the same position form a parameter combination.</li> <li>Build the product of the parameter labels and symbol labels, since each parameter combination is applied to each symbol.</li> <li>Return the final array as a Series.</li> <li>We do not provide a <code>single_type</code> argument anymore to accept only arrays.</li> <li>We need to pass three two-dimensional NumPy arrays instead of <code>data</code>, which has a complex Python type not recognized by Numba.</li> </ol> <p>Let's test the pipeline on four parameter combinations, as we did with the previous pipeline:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>chunked_pipeline_nb</span><span class=p>(</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=gp>... </span>    <span class=n>high</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=gp>... </span>    <span class=n>low</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=gp>... </span>    <span class=n>close</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a><span class=gp>... </span>    <span class=n>periods</span><span class=o>=</span><span class=n>period_product</span><span class=p>[:</span><span class=mi>4</span><span class=p>],</span> 
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=gp>... </span>    <span class=n>multipliers</span><span class=o>=</span><span class=n>multiplier_product</span><span class=p>[:</span><span class=mi>4</span><span class=p>],</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a><span class=gp>... </span>    <span class=n>ann_factor</span><span class=o>=</span><span class=n>ann_factor</span><span class=p>,</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=gp>... </span>    <span class=n>_n_chunks</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a><span class=gp>... </span>    <span class=n>_merge_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>input_columns</span><span class=o>=</span><span class=n>close</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span>
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <p> <div class="progress progress-100plus candystripe candystripe-animate"> <div class=progress-bar style=width:100.00%> <p class=progress-label>Chunk 2/2</p> </div> </div> </p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=go>st_period  st_multiplier  symbol </span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=go>4          2.0            BTCUSDT    0.451699</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=go>                          ETHUSDT    1.391032</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=go>           2.1            BTCUSDT    0.495387</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=go>                          ETHUSDT    1.134741</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=go>           2.2            BTCUSDT    0.985946</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=go>                          ETHUSDT    0.955616</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=go>           2.3            BTCUSDT    1.193179</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=go>                          ETHUSDT    1.307505</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a><span class=go>dtype: float64</span>
</span></code></pre></div> <p>We instantly recognize the values produced by the previous pipeline. Additionally, if you run the code, you will notice that <code>chunked_pipeline_nb</code> averages 50 iterations per second, compared to 15 per second with <code>chunked_pipeline</code>—a remarkable performance jump. But there is more: let's benchmark this pipeline without and with parallelization enabled.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=gp>&gt;&gt;&gt; </span><span class=o>%%</span><span class=n>timeit</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>chunked_pipeline_nb</span><span class=p>(</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=gp>... </span>    <span class=n>high</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=gp>... </span>    <span class=n>low</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=gp>... </span>    <span class=n>close</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a><span class=gp>... </span>    <span class=n>periods</span><span class=o>=</span><span class=n>period_product</span><span class=p>,</span> 
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=gp>... </span>    <span class=n>multipliers</span><span class=o>=</span><span class=n>multiplier_product</span><span class=p>,</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a><span class=gp>... </span>    <span class=n>ann_factor</span><span class=o>=</span><span class=n>ann_factor</span><span class=p>,</span>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a><span class=gp>... </span>    <span class=n>_merge_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>input_columns</span><span class=o>=</span><span class=n>close</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a><span class=go>894 ms ± 14.6 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a><span class=gp>&gt;&gt;&gt; </span><span class=o>%%</span><span class=n>timeit</span>
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14 href=#__codelineno-14-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>chunked_pipeline_nb</span><span class=p>(</span>
</span><span id=__span-14-15><a id=__codelineno-14-15 name=__codelineno-14-15 href=#__codelineno-14-15></a><span class=gp>... </span>    <span class=n>high</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-14-16><a id=__codelineno-14-16 name=__codelineno-14-16 href=#__codelineno-14-16></a><span class=gp>... </span>    <span class=n>low</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-14-17><a id=__codelineno-14-17 name=__codelineno-14-17 href=#__codelineno-14-17></a><span class=gp>... </span>    <span class=n>close</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-14-18><a id=__codelineno-14-18 name=__codelineno-14-18 href=#__codelineno-14-18></a><span class=gp>... </span>    <span class=n>periods</span><span class=o>=</span><span class=n>period_product</span><span class=p>,</span> 
</span><span id=__span-14-19><a id=__codelineno-14-19 name=__codelineno-14-19 href=#__codelineno-14-19></a><span class=gp>... </span>    <span class=n>multipliers</span><span class=o>=</span><span class=n>multiplier_product</span><span class=p>,</span>
</span><span id=__span-14-20><a id=__codelineno-14-20 name=__codelineno-14-20 href=#__codelineno-14-20></a><span class=gp>... </span>    <span class=n>ann_factor</span><span class=o>=</span><span class=n>ann_factor</span><span class=p>,</span>
</span><span id=__span-14-21><a id=__codelineno-14-21 name=__codelineno-14-21 href=#__codelineno-14-21></a><span class=gp>... </span>    <span class=n>_execute_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>engine</span><span class=o>=</span><span class=s2>&quot;dask&quot;</span><span class=p>),</span>
</span><span id=__span-14-22><a id=__codelineno-14-22 name=__codelineno-14-22 href=#__codelineno-14-22></a><span class=gp>... </span>    <span class=n>_merge_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>input_columns</span><span class=o>=</span><span class=n>close</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span>
</span><span id=__span-14-23><a id=__codelineno-14-23 name=__codelineno-14-23 href=#__codelineno-14-23></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-14-24><a id=__codelineno-14-24 name=__codelineno-14-24 href=#__codelineno-14-24></a><span class=go>217 ms ± 4.67 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</span></code></pre></div> <p>We just processed 12 million data points in 217 milliseconds, and that is in Python! <img alt=😎 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f60e.svg title=:sunglasses:></p> <h2 id=contextualized-pipeline>Contextualized pipeline<a class=headerlink href=#contextualized-pipeline title="Permanent link">&para;</a></h2> <p>Performance is not always the only concern. Imagine a scenario where we need to know the Sharpe ratio at every single time step to guide our trading decisions. This is not possible with the pipelines we wrote above, because we have introduced a path dependency—the current Sharpe now directly depends on the previous Sharpe.</p> <p>For such cases, VBT introduces the concept of a custom order function—a regular callback that can be executed at any point during the simulation. It receives the surrounding simulation context, such as the current cash balance, and decides whether to issue an order. Order functions are not the only callbacks in VBT: there is a wide range of callbacks that can be called at specific checkpoints during runtime. Using these callbacks usually comes with a noticeable performance hit (though still very fast), but they enable event-driven backtesting in a package otherwise focused on array operations.</p> <p>To maximize simulation speed, we will calculate both the SuperTrend and the Sharpe ratio in a single pass. This way, we will not only know both values at each time step, but also maintain full control over how they are calculated.</p> <h3 id=streaming-sharpe>Streaming Sharpe<a class=headerlink href=#streaming-sharpe title="Permanent link">&para;</a></h3> <p>We have already created a streaming SuperTrend indicator, but what about Sharpe? Turning Sharpe ratio calculation into a one-pass algorithm involves building an accumulator, which is fairly straightforward since the Sharpe ratio mainly depends on the rolling mean and standard deviation. We can create an accumulator by simply combining two other accumulators: <a href=https://vectorbt.pro/pvt_41531c19/api/generic/nb/rolling/#vectorbtpro.generic.nb.rolling.rolling_mean_acc_nb>rolling_mean_acc_nb</a> and <a href=https://vectorbt.pro/pvt_41531c19/api/generic/nb/rolling/#vectorbtpro.generic.nb.rolling.rolling_std_acc_nb>rolling_std_acc_nb</a>. If you followed along with the streaming SuperTrend implementation, you should have no trouble understanding the code below:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span><span class=w> </span><span class=nc>RollSharpeAIS</span><span class=p>(</span><span class=n>tp</span><span class=o>.</span><span class=n>NamedTuple</span><span class=p>):</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=gp>... </span>    <span class=n>i</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=gp>... </span>    <span class=n>ret</span><span class=p>:</span> <span class=nb>float</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=gp>... </span>    <span class=n>pre_window_ret</span><span class=p>:</span> <span class=nb>float</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=gp>... </span>    <span class=n>cumsum</span><span class=p>:</span> <span class=nb>float</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a><span class=gp>... </span>    <span class=n>cumsum_sq</span><span class=p>:</span> <span class=nb>float</span>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a><span class=gp>... </span>    <span class=n>nancnt</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a><span class=gp>... </span>    <span class=n>window</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-15-9><a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a><span class=gp>... </span>    <span class=n>minp</span><span class=p>:</span> <span class=n>tp</span><span class=o>.</span><span class=n>Optional</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span>
</span><span id=__span-15-10><a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a><span class=gp>... </span>    <span class=n>ddof</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-15-11><a id=__codelineno-15-11 name=__codelineno-15-11 href=#__codelineno-15-11></a><span class=gp>... </span>    <span class=n>ann_factor</span><span class=p>:</span> <span class=nb>float</span>
</span><span id=__span-15-12><a id=__codelineno-15-12 name=__codelineno-15-12 href=#__codelineno-15-12></a>
</span><span id=__span-15-13><a id=__codelineno-15-13 name=__codelineno-15-13 href=#__codelineno-15-13></a><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span><span class=w> </span><span class=nc>RollSharpeAOS</span><span class=p>(</span><span class=n>tp</span><span class=o>.</span><span class=n>NamedTuple</span><span class=p>):</span>
</span><span id=__span-15-14><a id=__codelineno-15-14 name=__codelineno-15-14 href=#__codelineno-15-14></a><span class=gp>... </span>    <span class=n>cumsum</span><span class=p>:</span> <span class=nb>float</span>
</span><span id=__span-15-15><a id=__codelineno-15-15 name=__codelineno-15-15 href=#__codelineno-15-15></a><span class=gp>... </span>    <span class=n>cumsum_sq</span><span class=p>:</span> <span class=nb>float</span>
</span><span id=__span-15-16><a id=__codelineno-15-16 name=__codelineno-15-16 href=#__codelineno-15-16></a><span class=gp>... </span>    <span class=n>nancnt</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-15-17><a id=__codelineno-15-17 name=__codelineno-15-17 href=#__codelineno-15-17></a><span class=gp>... </span>    <span class=n>value</span><span class=p>:</span> <span class=nb>float</span>
</span><span id=__span-15-18><a id=__codelineno-15-18 name=__codelineno-15-18 href=#__codelineno-15-18></a>
</span><span id=__span-15-19><a id=__codelineno-15-19 name=__codelineno-15-19 href=#__codelineno-15-19></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span><span class=p>(</span><span class=n>nogil</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-15-20><a id=__codelineno-15-20 name=__codelineno-15-20 href=#__codelineno-15-20></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>rolling_sharpe_acc_nb</span><span class=p>(</span><span class=n>in_state</span><span class=p>):</span>
</span><span id=__span-15-21><a id=__codelineno-15-21 name=__codelineno-15-21 href=#__codelineno-15-21></a><span class=gp>... </span>    <span class=c1># (1)!</span>
</span><span id=__span-15-22><a id=__codelineno-15-22 name=__codelineno-15-22 href=#__codelineno-15-22></a><span class=gp>... </span>    <span class=n>mean_in_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>RollMeanAIS</span><span class=p>(</span>
</span><span id=__span-15-23><a id=__codelineno-15-23 name=__codelineno-15-23 href=#__codelineno-15-23></a><span class=gp>... </span>        <span class=n>i</span><span class=o>=</span><span class=n>in_state</span><span class=o>.</span><span class=n>i</span><span class=p>,</span>
</span><span id=__span-15-24><a id=__codelineno-15-24 name=__codelineno-15-24 href=#__codelineno-15-24></a><span class=gp>... </span>        <span class=n>value</span><span class=o>=</span><span class=n>in_state</span><span class=o>.</span><span class=n>ret</span><span class=p>,</span>
</span><span id=__span-15-25><a id=__codelineno-15-25 name=__codelineno-15-25 href=#__codelineno-15-25></a><span class=gp>... </span>        <span class=n>pre_window_value</span><span class=o>=</span><span class=n>in_state</span><span class=o>.</span><span class=n>pre_window_ret</span><span class=p>,</span>
</span><span id=__span-15-26><a id=__codelineno-15-26 name=__codelineno-15-26 href=#__codelineno-15-26></a><span class=gp>... </span>        <span class=n>cumsum</span><span class=o>=</span><span class=n>in_state</span><span class=o>.</span><span class=n>cumsum</span><span class=p>,</span>
</span><span id=__span-15-27><a id=__codelineno-15-27 name=__codelineno-15-27 href=#__codelineno-15-27></a><span class=gp>... </span>        <span class=n>nancnt</span><span class=o>=</span><span class=n>in_state</span><span class=o>.</span><span class=n>nancnt</span><span class=p>,</span>
</span><span id=__span-15-28><a id=__codelineno-15-28 name=__codelineno-15-28 href=#__codelineno-15-28></a><span class=gp>... </span>        <span class=n>window</span><span class=o>=</span><span class=n>in_state</span><span class=o>.</span><span class=n>window</span><span class=p>,</span>
</span><span id=__span-15-29><a id=__codelineno-15-29 name=__codelineno-15-29 href=#__codelineno-15-29></a><span class=gp>... </span>        <span class=n>minp</span><span class=o>=</span><span class=n>in_state</span><span class=o>.</span><span class=n>minp</span>
</span><span id=__span-15-30><a id=__codelineno-15-30 name=__codelineno-15-30 href=#__codelineno-15-30></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-15-31><a id=__codelineno-15-31 name=__codelineno-15-31 href=#__codelineno-15-31></a><span class=gp>... </span>    <span class=n>mean_out_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>rolling_mean_acc_nb</span><span class=p>(</span><span class=n>mean_in_state</span><span class=p>)</span>
</span><span id=__span-15-32><a id=__codelineno-15-32 name=__codelineno-15-32 href=#__codelineno-15-32></a><span class=gp>... </span>    
</span><span id=__span-15-33><a id=__codelineno-15-33 name=__codelineno-15-33 href=#__codelineno-15-33></a><span class=gp>... </span>    <span class=c1># (2)!</span>
</span><span id=__span-15-34><a id=__codelineno-15-34 name=__codelineno-15-34 href=#__codelineno-15-34></a><span class=gp>... </span>    <span class=n>std_in_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>RollStdAIS</span><span class=p>(</span>
</span><span id=__span-15-35><a id=__codelineno-15-35 name=__codelineno-15-35 href=#__codelineno-15-35></a><span class=gp>... </span>        <span class=n>i</span><span class=o>=</span><span class=n>in_state</span><span class=o>.</span><span class=n>i</span><span class=p>,</span>
</span><span id=__span-15-36><a id=__codelineno-15-36 name=__codelineno-15-36 href=#__codelineno-15-36></a><span class=gp>... </span>        <span class=n>value</span><span class=o>=</span><span class=n>in_state</span><span class=o>.</span><span class=n>ret</span><span class=p>,</span>
</span><span id=__span-15-37><a id=__codelineno-15-37 name=__codelineno-15-37 href=#__codelineno-15-37></a><span class=gp>... </span>        <span class=n>pre_window_value</span><span class=o>=</span><span class=n>in_state</span><span class=o>.</span><span class=n>pre_window_ret</span><span class=p>,</span>
</span><span id=__span-15-38><a id=__codelineno-15-38 name=__codelineno-15-38 href=#__codelineno-15-38></a><span class=gp>... </span>        <span class=n>cumsum</span><span class=o>=</span><span class=n>in_state</span><span class=o>.</span><span class=n>cumsum</span><span class=p>,</span>
</span><span id=__span-15-39><a id=__codelineno-15-39 name=__codelineno-15-39 href=#__codelineno-15-39></a><span class=gp>... </span>        <span class=n>cumsum_sq</span><span class=o>=</span><span class=n>in_state</span><span class=o>.</span><span class=n>cumsum_sq</span><span class=p>,</span>
</span><span id=__span-15-40><a id=__codelineno-15-40 name=__codelineno-15-40 href=#__codelineno-15-40></a><span class=gp>... </span>        <span class=n>nancnt</span><span class=o>=</span><span class=n>in_state</span><span class=o>.</span><span class=n>nancnt</span><span class=p>,</span>
</span><span id=__span-15-41><a id=__codelineno-15-41 name=__codelineno-15-41 href=#__codelineno-15-41></a><span class=gp>... </span>        <span class=n>window</span><span class=o>=</span><span class=n>in_state</span><span class=o>.</span><span class=n>window</span><span class=p>,</span>
</span><span id=__span-15-42><a id=__codelineno-15-42 name=__codelineno-15-42 href=#__codelineno-15-42></a><span class=gp>... </span>        <span class=n>minp</span><span class=o>=</span><span class=n>in_state</span><span class=o>.</span><span class=n>minp</span><span class=p>,</span>
</span><span id=__span-15-43><a id=__codelineno-15-43 name=__codelineno-15-43 href=#__codelineno-15-43></a><span class=gp>... </span>        <span class=n>ddof</span><span class=o>=</span><span class=n>in_state</span><span class=o>.</span><span class=n>ddof</span>
</span><span id=__span-15-44><a id=__codelineno-15-44 name=__codelineno-15-44 href=#__codelineno-15-44></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-15-45><a id=__codelineno-15-45 name=__codelineno-15-45 href=#__codelineno-15-45></a><span class=gp>... </span>    <span class=n>std_out_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>rolling_std_acc_nb</span><span class=p>(</span><span class=n>std_in_state</span><span class=p>)</span>
</span><span id=__span-15-46><a id=__codelineno-15-46 name=__codelineno-15-46 href=#__codelineno-15-46></a><span class=gp>... </span>    
</span><span id=__span-15-47><a id=__codelineno-15-47 name=__codelineno-15-47 href=#__codelineno-15-47></a><span class=gp>... </span>    <span class=c1># (3)!</span>
</span><span id=__span-15-48><a id=__codelineno-15-48 name=__codelineno-15-48 href=#__codelineno-15-48></a><span class=gp>... </span>    <span class=n>mean</span> <span class=o>=</span> <span class=n>mean_out_state</span><span class=o>.</span><span class=n>value</span>
</span><span id=__span-15-49><a id=__codelineno-15-49 name=__codelineno-15-49 href=#__codelineno-15-49></a><span class=gp>... </span>    <span class=n>std</span> <span class=o>=</span> <span class=n>std_out_state</span><span class=o>.</span><span class=n>value</span>
</span><span id=__span-15-50><a id=__codelineno-15-50 name=__codelineno-15-50 href=#__codelineno-15-50></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>std</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-15-51><a id=__codelineno-15-51 name=__codelineno-15-51 href=#__codelineno-15-51></a><span class=gp>... </span>        <span class=n>sharpe</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span>
</span><span id=__span-15-52><a id=__codelineno-15-52 name=__codelineno-15-52 href=#__codelineno-15-52></a><span class=gp>... </span>    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-15-53><a id=__codelineno-15-53 name=__codelineno-15-53 href=#__codelineno-15-53></a><span class=gp>... </span>        <span class=n>sharpe</span> <span class=o>=</span> <span class=n>mean</span> <span class=o>/</span> <span class=n>std</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>in_state</span><span class=o>.</span><span class=n>ann_factor</span><span class=p>)</span>
</span><span id=__span-15-54><a id=__codelineno-15-54 name=__codelineno-15-54 href=#__codelineno-15-54></a><span class=gp>...</span>
</span><span id=__span-15-55><a id=__codelineno-15-55 name=__codelineno-15-55 href=#__codelineno-15-55></a><span class=gp>... </span>    <span class=c1># (4)!</span>
</span><span id=__span-15-56><a id=__codelineno-15-56 name=__codelineno-15-56 href=#__codelineno-15-56></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>RollSharpeAOS</span><span class=p>(</span>
</span><span id=__span-15-57><a id=__codelineno-15-57 name=__codelineno-15-57 href=#__codelineno-15-57></a><span class=gp>... </span>        <span class=n>cumsum</span><span class=o>=</span><span class=n>std_out_state</span><span class=o>.</span><span class=n>cumsum</span><span class=p>,</span>
</span><span id=__span-15-58><a id=__codelineno-15-58 name=__codelineno-15-58 href=#__codelineno-15-58></a><span class=gp>... </span>        <span class=n>cumsum_sq</span><span class=o>=</span><span class=n>std_out_state</span><span class=o>.</span><span class=n>cumsum_sq</span><span class=p>,</span>
</span><span id=__span-15-59><a id=__codelineno-15-59 name=__codelineno-15-59 href=#__codelineno-15-59></a><span class=gp>... </span>        <span class=n>nancnt</span><span class=o>=</span><span class=n>std_out_state</span><span class=o>.</span><span class=n>nancnt</span><span class=p>,</span>
</span><span id=__span-15-60><a id=__codelineno-15-60 name=__codelineno-15-60 href=#__codelineno-15-60></a><span class=gp>... </span>        <span class=n>value</span><span class=o>=</span><span class=n>sharpe</span>
</span><span id=__span-15-61><a id=__codelineno-15-61 name=__codelineno-15-61 href=#__codelineno-15-61></a><span class=gp>... </span>    <span class=p>)</span>
</span></code></pre></div> <ol> <li>Calculate the mean of the window.</li> <li>Calculate the standard deviation of the window.</li> <li>Calculate the Sharpe ratio of the window.</li> <li>Return the output state to be used in the next iteration.</li> </ol> <p>To ensure the calculation above is correct, let's create a simple function <code>rolling_sharpe_ratio_nb</code> that computes the rolling Sharpe ratio using our accumulator. We will compare its output to another function with a completely different implementation: <a href=https://vectorbt.pro/pvt_41531c19/api/returns/accessors/#vectorbtpro.returns.accessors.ReturnsAccessor.rolling_sharpe_ratio>ReturnsAccessor.rolling_sharpe_ratio</a>.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span><span class=p>(</span><span class=n>nogil</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>rolling_sharpe_ratio_nb</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>window</span><span class=p>,</span> <span class=n>minp</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>ddof</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>ann_factor</span><span class=o>=</span><span class=mi>365</span><span class=p>):</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>window</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=gp>... </span>        <span class=n>window</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>  <span class=c1># (1)!</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>minp</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=gp>... </span>        <span class=n>minp</span> <span class=o>=</span> <span class=n>window</span>  <span class=c1># (2)!</span>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=gp>... </span>    <span class=n>out</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>returns</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>float_</span><span class=p>)</span>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a><span class=gp>... </span>    
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>returns</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-16-10><a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a><span class=gp>... </span>        <span class=k>return</span> <span class=n>out</span>
</span><span id=__span-16-11><a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a><span class=gp>... </span>
</span><span id=__span-16-12><a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a><span class=gp>... </span>    <span class=n>cumsum</span> <span class=o>=</span> <span class=mf>0.</span>
</span><span id=__span-16-13><a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a><span class=gp>... </span>    <span class=n>cumsum_sq</span> <span class=o>=</span> <span class=mf>0.</span>
</span><span id=__span-16-14><a id=__codelineno-16-14 name=__codelineno-16-14 href=#__codelineno-16-14></a><span class=gp>... </span>    <span class=n>nancnt</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-16-15><a id=__codelineno-16-15 name=__codelineno-16-15 href=#__codelineno-16-15></a><span class=gp>... </span>
</span><span id=__span-16-16><a id=__codelineno-16-16 name=__codelineno-16-16 href=#__codelineno-16-16></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>returns</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
</span><span id=__span-16-17><a id=__codelineno-16-17 name=__codelineno-16-17 href=#__codelineno-16-17></a><span class=gp>... </span>        <span class=n>in_state</span> <span class=o>=</span> <span class=n>RollSharpeAIS</span><span class=p>(</span>
</span><span id=__span-16-18><a id=__codelineno-16-18 name=__codelineno-16-18 href=#__codelineno-16-18></a><span class=gp>... </span>            <span class=n>i</span><span class=o>=</span><span class=n>i</span><span class=p>,</span>
</span><span id=__span-16-19><a id=__codelineno-16-19 name=__codelineno-16-19 href=#__codelineno-16-19></a><span class=gp>... </span>            <span class=n>ret</span><span class=o>=</span><span class=n>returns</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span><span id=__span-16-20><a id=__codelineno-16-20 name=__codelineno-16-20 href=#__codelineno-16-20></a><span class=gp>... </span>            <span class=n>pre_window_ret</span><span class=o>=</span><span class=n>returns</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=n>window</span><span class=p>]</span> <span class=k>if</span> <span class=n>i</span> <span class=o>-</span> <span class=n>window</span> <span class=o>&gt;=</span> <span class=mi>0</span> <span class=k>else</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-16-21><a id=__codelineno-16-21 name=__codelineno-16-21 href=#__codelineno-16-21></a><span class=gp>... </span>            <span class=n>cumsum</span><span class=o>=</span><span class=n>cumsum</span><span class=p>,</span>
</span><span id=__span-16-22><a id=__codelineno-16-22 name=__codelineno-16-22 href=#__codelineno-16-22></a><span class=gp>... </span>            <span class=n>cumsum_sq</span><span class=o>=</span><span class=n>cumsum_sq</span><span class=p>,</span>
</span><span id=__span-16-23><a id=__codelineno-16-23 name=__codelineno-16-23 href=#__codelineno-16-23></a><span class=gp>... </span>            <span class=n>nancnt</span><span class=o>=</span><span class=n>nancnt</span><span class=p>,</span>
</span><span id=__span-16-24><a id=__codelineno-16-24 name=__codelineno-16-24 href=#__codelineno-16-24></a><span class=gp>... </span>            <span class=n>window</span><span class=o>=</span><span class=n>window</span><span class=p>,</span>
</span><span id=__span-16-25><a id=__codelineno-16-25 name=__codelineno-16-25 href=#__codelineno-16-25></a><span class=gp>... </span>            <span class=n>minp</span><span class=o>=</span><span class=n>minp</span><span class=p>,</span>
</span><span id=__span-16-26><a id=__codelineno-16-26 name=__codelineno-16-26 href=#__codelineno-16-26></a><span class=gp>... </span>            <span class=n>ddof</span><span class=o>=</span><span class=n>ddof</span><span class=p>,</span>
</span><span id=__span-16-27><a id=__codelineno-16-27 name=__codelineno-16-27 href=#__codelineno-16-27></a><span class=gp>... </span>            <span class=n>ann_factor</span><span class=o>=</span><span class=n>ann_factor</span>
</span><span id=__span-16-28><a id=__codelineno-16-28 name=__codelineno-16-28 href=#__codelineno-16-28></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-16-29><a id=__codelineno-16-29 name=__codelineno-16-29 href=#__codelineno-16-29></a><span class=gp>... </span>        
</span><span id=__span-16-30><a id=__codelineno-16-30 name=__codelineno-16-30 href=#__codelineno-16-30></a><span class=gp>... </span>        <span class=n>out_state</span> <span class=o>=</span> <span class=n>rolling_sharpe_acc_nb</span><span class=p>(</span><span class=n>in_state</span><span class=p>)</span>
</span><span id=__span-16-31><a id=__codelineno-16-31 name=__codelineno-16-31 href=#__codelineno-16-31></a><span class=gp>... </span>        
</span><span id=__span-16-32><a id=__codelineno-16-32 name=__codelineno-16-32 href=#__codelineno-16-32></a><span class=gp>... </span>        <span class=n>cumsum</span> <span class=o>=</span> <span class=n>out_state</span><span class=o>.</span><span class=n>cumsum</span>
</span><span id=__span-16-33><a id=__codelineno-16-33 name=__codelineno-16-33 href=#__codelineno-16-33></a><span class=gp>... </span>        <span class=n>cumsum_sq</span> <span class=o>=</span> <span class=n>out_state</span><span class=o>.</span><span class=n>cumsum_sq</span>
</span><span id=__span-16-34><a id=__codelineno-16-34 name=__codelineno-16-34 href=#__codelineno-16-34></a><span class=gp>... </span>        <span class=n>nancnt</span> <span class=o>=</span> <span class=n>out_state</span><span class=o>.</span><span class=n>nancnt</span>
</span><span id=__span-16-35><a id=__codelineno-16-35 name=__codelineno-16-35 href=#__codelineno-16-35></a><span class=gp>... </span>        <span class=n>out</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>out_state</span><span class=o>.</span><span class=n>value</span>
</span><span id=__span-16-36><a id=__codelineno-16-36 name=__codelineno-16-36 href=#__codelineno-16-36></a><span class=gp>... </span>        
</span><span id=__span-16-37><a id=__codelineno-16-37 name=__codelineno-16-37 href=#__codelineno-16-37></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>out</span>
</span><span id=__span-16-38><a id=__codelineno-16-38 name=__codelineno-16-38 href=#__codelineno-16-38></a>
</span><span id=__span-16-39><a id=__codelineno-16-39 name=__codelineno-16-39 href=#__codelineno-16-39></a><span class=gp>&gt;&gt;&gt; </span><span class=n>ann_factor</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pd_acc</span><span class=o>.</span><span class=n>returns</span><span class=o>.</span><span class=n>get_ann_factor</span><span class=p>(</span><span class=n>freq</span><span class=o>=</span><span class=s1>&#39;1h&#39;</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-16-40><a id=__codelineno-16-40 name=__codelineno-16-40 href=#__codelineno-16-40></a>
</span><span id=__span-16-41><a id=__codelineno-16-41 name=__codelineno-16-41 href=#__codelineno-16-41></a><span class=gp>&gt;&gt;&gt; </span><span class=n>returns</span> <span class=o>=</span> <span class=n>close</span><span class=p>[</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>to_returns</span><span class=p>()</span>  <span class=c1># (4)!</span>
</span><span id=__span-16-42><a id=__codelineno-16-42 name=__codelineno-16-42 href=#__codelineno-16-42></a>
</span><span id=__span-16-43><a id=__codelineno-16-43 name=__codelineno-16-43 href=#__codelineno-16-43></a><span class=gp>&gt;&gt;&gt; </span><span class=n>np</span><span class=o>.</span><span class=n>testing</span><span class=o>.</span><span class=n>assert_allclose</span><span class=p>(</span>
</span><span id=__span-16-44><a id=__codelineno-16-44 name=__codelineno-16-44 href=#__codelineno-16-44></a><span class=gp>... </span>    <span class=n>rolling_sharpe_ratio_nb</span><span class=p>(</span>
</span><span id=__span-16-45><a id=__codelineno-16-45 name=__codelineno-16-45 href=#__codelineno-16-45></a><span class=gp>... </span>        <span class=n>returns</span><span class=o>=</span><span class=n>returns</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-16-46><a id=__codelineno-16-46 name=__codelineno-16-46 href=#__codelineno-16-46></a><span class=gp>... </span>        <span class=n>window</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> 
</span><span id=__span-16-47><a id=__codelineno-16-47 name=__codelineno-16-47 href=#__codelineno-16-47></a><span class=gp>... </span>        <span class=n>ddof</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>  <span class=c1># (5)!</span>
</span><span id=__span-16-48><a id=__codelineno-16-48 name=__codelineno-16-48 href=#__codelineno-16-48></a><span class=gp>... </span>        <span class=n>ann_factor</span><span class=o>=</span><span class=n>ann_factor</span><span class=p>),</span>
</span><span id=__span-16-49><a id=__codelineno-16-49 name=__codelineno-16-49 href=#__codelineno-16-49></a><span class=gp>... </span>    <span class=n>returns</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>returns</span><span class=p>(</span><span class=n>freq</span><span class=o>=</span><span class=s1>&#39;1h&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>rolling_sharpe_ratio</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-16-50><a id=__codelineno-16-50 name=__codelineno-16-50 href=#__codelineno-16-50></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <ol> <li>A window size of <code>None</code> makes the window expanding.</li> <li>A minimum number of observations of <code>None</code> defaults to the window size.</li> <li>Get the annualization factor using <a href=https://vectorbt.pro/pvt_41531c19/api/returns/accessors/#vectorbtpro.returns.accessors.ReturnsAccessor.get_ann_factor>ReturnsAccessor.get_ann_factor</a>.</li> <li>Calculate the returns using <a href=https://vectorbt.pro/pvt_41531c19/api/generic/accessors/#vectorbtpro.generic.accessors.GenericAccessor.to_returns>GenericAccessor.to_returns</a>.</li> <li>The default <code>ddof</code> is <code>1</code> in accessors (like Pandas) and <code>0</code> in Numba-compiled functions (like NumPy).</li> </ol> <p>Everything checks out—both functions return identical arrays!</p> <h3 id=callbacks>Callbacks<a class=headerlink href=#callbacks title="Permanent link">&para;</a></h3> <p>In a contextualized simulation using <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_order_func/#vectorbtpro.portfolio.nb.from_order_func.from_order_func_nb>from_order_func_nb</a>, we can use several callbacks to define our logic. The simulator receives a shape <code>target_shape</code> and iterates over the columns and rows of this shape in a specific way. Think of this shape as a two-dimensional array where columns represent assets (denoted as <code>col</code>) and rows represent time steps (denoted as <code>i</code>). For each element in this shape, we call an order function. This is similar to live trading: 1 trade on BTC and 0 trades on ETH yesterday, 0 trades on BTC and 0 trades on ETH today, and so on.</p> <table> <thead> <tr> <th>Date</th> <th>BTCUSDT (<code>col=0</code>)</th> <th>ETHUSDT (<code>col=1</code>)</th> </tr> </thead> <tbody> <tr> <td>2020-01-01 (<code>i=0</code>)</td> <td>1</td> <td>0</td> </tr> <tr> <td>2020-01-02 (<code>i=1</code>)</td> <td>0</td> <td>1</td> </tr> <tr> <td>...</td> <td>...</td> <td>...</td> </tr> <tr> <td>today (<code>i=n</code>)</td> <td>1</td> <td>1</td> </tr> </tbody> </table> <p>Since the simulator now works on multiple columns, any information we need to manage for the streaming SuperTrend, such as <code>cumsum</code> and <code>cumsum_sq</code>, should be maintained per column. That means we are moving from scalars to one-dimensional arrays. Why use arrays and not lists, dicts, or tuples? Arrays are faster than lists and dicts, they can be modified (unlike tuples), and they are native data structures in Numba, making them ideal to hold and update data.</p> <p>In traditional backtesting, we typically store our variables, such as arrays, on the instance we are working with. But in a VBT simulation, we do not have classes and instances (Numba does support jitted classes, but these are too heavy-weight). The only way to pass any information is by having a callback return it as a tuple, which can then be consumed by other callbacks down the execution stack. As you can imagine, managing large tuples is not very intuitive. The best solution is to create a named tuple, which acts as a container (also called "memory") that works seamlessly with Numba. We can then conveniently access any array by its name.</p> <p>Where do we define this memory? At the start of each simulation, the simulator calls the <code>pre_sim_func_nb</code> callback, which is simply a regular preprocessing function invoked before the main simulation. Whatever this function returns is passed to other callbacks. Sounds like the perfect place, right?</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span><span class=w> </span><span class=nc>Memory</span><span class=p>(</span><span class=n>tp</span><span class=o>.</span><span class=n>NamedTuple</span><span class=p>):</span>  <span class=c1># (1)!</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=gp>... </span>    <span class=n>nobs</span><span class=p>:</span> <span class=n>tp</span><span class=o>.</span><span class=n>Array1d</span>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=gp>... </span>    <span class=n>old_wt</span><span class=p>:</span> <span class=n>tp</span><span class=o>.</span><span class=n>Array1d</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=gp>... </span>    <span class=n>weighted_avg</span><span class=p>:</span> <span class=n>tp</span><span class=o>.</span><span class=n>Array1d</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=gp>... </span>    <span class=n>prev_upper</span><span class=p>:</span> <span class=n>tp</span><span class=o>.</span><span class=n>Array1d</span>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=gp>... </span>    <span class=n>prev_lower</span><span class=p>:</span> <span class=n>tp</span><span class=o>.</span><span class=n>Array1d</span>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a><span class=gp>... </span>    <span class=n>prev_dir_</span><span class=p>:</span> <span class=n>tp</span><span class=o>.</span><span class=n>Array1d</span>
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a><span class=gp>... </span>    <span class=n>cumsum</span><span class=p>:</span> <span class=n>tp</span><span class=o>.</span><span class=n>Array1d</span>
</span><span id=__span-17-9><a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a><span class=gp>... </span>    <span class=n>cumsum_sq</span><span class=p>:</span> <span class=n>tp</span><span class=o>.</span><span class=n>Array1d</span>
</span><span id=__span-17-10><a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a><span class=gp>... </span>    <span class=n>nancnt</span><span class=p>:</span> <span class=n>tp</span><span class=o>.</span><span class=n>Array1d</span>
</span><span id=__span-17-11><a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a><span class=gp>... </span>    <span class=n>was_entry</span><span class=p>:</span> <span class=n>tp</span><span class=o>.</span><span class=n>Array1d</span>
</span><span id=__span-17-12><a id=__codelineno-17-12 name=__codelineno-17-12 href=#__codelineno-17-12></a><span class=gp>... </span>    <span class=n>was_exit</span><span class=p>:</span> <span class=n>tp</span><span class=o>.</span><span class=n>Array1d</span>
</span><span id=__span-17-13><a id=__codelineno-17-13 name=__codelineno-17-13 href=#__codelineno-17-13></a>
</span><span id=__span-17-14><a id=__codelineno-17-14 name=__codelineno-17-14 href=#__codelineno-17-14></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span><span class=p>(</span><span class=n>nogil</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-17-15><a id=__codelineno-17-15 name=__codelineno-17-15 href=#__codelineno-17-15></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>pre_sim_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span><span id=__span-17-16><a id=__codelineno-17-16 name=__codelineno-17-16 href=#__codelineno-17-16></a><span class=gp>... </span>    <span class=n>memory</span> <span class=o>=</span> <span class=n>Memory</span><span class=p>(</span>  <span class=c1># (2)!</span>
</span><span id=__span-17-17><a id=__codelineno-17-17 name=__codelineno-17-17 href=#__codelineno-17-17></a><span class=gp>... </span>        <span class=n>nobs</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>target_shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mi>0</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>int_</span><span class=p>),</span>
</span><span id=__span-17-18><a id=__codelineno-17-18 name=__codelineno-17-18 href=#__codelineno-17-18></a><span class=gp>... </span>        <span class=n>old_wt</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>target_shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mf>1.</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>float_</span><span class=p>),</span>
</span><span id=__span-17-19><a id=__codelineno-17-19 name=__codelineno-17-19 href=#__codelineno-17-19></a><span class=gp>... </span>        <span class=n>weighted_avg</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>target_shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>float_</span><span class=p>),</span>
</span><span id=__span-17-20><a id=__codelineno-17-20 name=__codelineno-17-20 href=#__codelineno-17-20></a><span class=gp>... </span>        <span class=n>prev_upper</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>target_shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>float_</span><span class=p>),</span>
</span><span id=__span-17-21><a id=__codelineno-17-21 name=__codelineno-17-21 href=#__codelineno-17-21></a><span class=gp>... </span>        <span class=n>prev_lower</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>target_shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>float_</span><span class=p>),</span>
</span><span id=__span-17-22><a id=__codelineno-17-22 name=__codelineno-17-22 href=#__codelineno-17-22></a><span class=gp>... </span>        <span class=n>prev_dir_</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>target_shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>float_</span><span class=p>),</span>
</span><span id=__span-17-23><a id=__codelineno-17-23 name=__codelineno-17-23 href=#__codelineno-17-23></a><span class=gp>... </span>        <span class=n>cumsum</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>target_shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mf>0.</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>float_</span><span class=p>),</span>
</span><span id=__span-17-24><a id=__codelineno-17-24 name=__codelineno-17-24 href=#__codelineno-17-24></a><span class=gp>... </span>        <span class=n>cumsum_sq</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>target_shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mf>0.</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>float_</span><span class=p>),</span>
</span><span id=__span-17-25><a id=__codelineno-17-25 name=__codelineno-17-25 href=#__codelineno-17-25></a><span class=gp>... </span>        <span class=n>nancnt</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>target_shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mi>0</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>int_</span><span class=p>),</span>
</span><span id=__span-17-26><a id=__codelineno-17-26 name=__codelineno-17-26 href=#__codelineno-17-26></a><span class=gp>... </span>        <span class=n>was_entry</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>target_shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=kc>False</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>bool_</span><span class=p>),</span>
</span><span id=__span-17-27><a id=__codelineno-17-27 name=__codelineno-17-27 href=#__codelineno-17-27></a><span class=gp>... </span>        <span class=n>was_exit</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>target_shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=kc>False</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>bool_</span><span class=p>)</span>
</span><span id=__span-17-28><a id=__codelineno-17-28 name=__codelineno-17-28 href=#__codelineno-17-28></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-17-29><a id=__codelineno-17-29 name=__codelineno-17-29 href=#__codelineno-17-29></a><span class=gp>... </span>    <span class=k>return</span> <span class=p>(</span><span class=n>memory</span><span class=p>,)</span>
</span></code></pre></div> <ol> <li>Container for our variables.</li> <li>Initialize variables and place them into the container. Notice that all variables have the same length as the number of columns—<code>target_shape[1]</code>.</li> </ol> <p>The memory returned by the simulation pre-processing function is automatically prepended to the arguments of every other callback, unless callbacks higher in the call chain choose not to and limit memory access. Now, let's write the main part of our simulation— the order function. This function takes the current context, the memory, and the parameter values set by the user, computes the current SuperTrend values, and uses them to decide whether to enter or exit a position. This signal is stored in memory and is executed only at the next time step (as intended):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span><span class=p>(</span><span class=n>nogil</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>order_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>memory</span><span class=p>,</span> <span class=n>period</span><span class=p>,</span> <span class=n>multiplier</span><span class=p>):</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=gp>... </span>    <span class=c1># (1)!</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=gp>... </span>    <span class=n>is_entry</span> <span class=o>=</span> <span class=n>memory</span><span class=o>.</span><span class=n>was_entry</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=gp>... </span>    <span class=n>is_exit</span> <span class=o>=</span> <span class=n>memory</span><span class=o>.</span><span class=n>was_exit</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a><span class=gp>...</span>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a><span class=gp>... </span>    <span class=c1># (2)!</span>
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a><span class=gp>... </span>    <span class=n>in_state</span> <span class=o>=</span> <span class=n>SuperTrendAIS</span><span class=p>(</span>
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a><span class=gp>... </span>        <span class=n>i</span><span class=o>=</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span>
</span><span id=__span-18-10><a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a><span class=gp>... </span>        <span class=n>high</span><span class=o>=</span><span class=n>c</span><span class=o>.</span><span class=n>high</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-18-11><a id=__codelineno-18-11 name=__codelineno-18-11 href=#__codelineno-18-11></a><span class=gp>... </span>        <span class=n>low</span><span class=o>=</span><span class=n>c</span><span class=o>.</span><span class=n>low</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-18-12><a id=__codelineno-18-12 name=__codelineno-18-12 href=#__codelineno-18-12></a><span class=gp>... </span>        <span class=n>close</span><span class=o>=</span><span class=n>c</span><span class=o>.</span><span class=n>close</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-18-13><a id=__codelineno-18-13 name=__codelineno-18-13 href=#__codelineno-18-13></a><span class=gp>... </span>        <span class=n>prev_close</span><span class=o>=</span><span class=n>c</span><span class=o>.</span><span class=n>close</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-18-14><a id=__codelineno-18-14 name=__codelineno-18-14 href=#__codelineno-18-14></a><span class=gp>... </span>        <span class=n>prev_upper</span><span class=o>=</span><span class=n>memory</span><span class=o>.</span><span class=n>prev_upper</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-18-15><a id=__codelineno-18-15 name=__codelineno-18-15 href=#__codelineno-18-15></a><span class=gp>... </span>        <span class=n>prev_lower</span><span class=o>=</span><span class=n>memory</span><span class=o>.</span><span class=n>prev_lower</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-18-16><a id=__codelineno-18-16 name=__codelineno-18-16 href=#__codelineno-18-16></a><span class=gp>... </span>        <span class=n>prev_dir_</span><span class=o>=</span><span class=n>memory</span><span class=o>.</span><span class=n>prev_dir_</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-18-17><a id=__codelineno-18-17 name=__codelineno-18-17 href=#__codelineno-18-17></a><span class=gp>... </span>        <span class=n>nobs</span><span class=o>=</span><span class=n>memory</span><span class=o>.</span><span class=n>nobs</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-18-18><a id=__codelineno-18-18 name=__codelineno-18-18 href=#__codelineno-18-18></a><span class=gp>... </span>        <span class=n>weighted_avg</span><span class=o>=</span><span class=n>memory</span><span class=o>.</span><span class=n>weighted_avg</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-18-19><a id=__codelineno-18-19 name=__codelineno-18-19 href=#__codelineno-18-19></a><span class=gp>... </span>        <span class=n>old_wt</span><span class=o>=</span><span class=n>memory</span><span class=o>.</span><span class=n>old_wt</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-18-20><a id=__codelineno-18-20 name=__codelineno-18-20 href=#__codelineno-18-20></a><span class=gp>... </span>        <span class=n>period</span><span class=o>=</span><span class=n>period</span><span class=p>,</span>
</span><span id=__span-18-21><a id=__codelineno-18-21 name=__codelineno-18-21 href=#__codelineno-18-21></a><span class=gp>... </span>        <span class=n>multiplier</span><span class=o>=</span><span class=n>multiplier</span>
</span><span id=__span-18-22><a id=__codelineno-18-22 name=__codelineno-18-22 href=#__codelineno-18-22></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-18-23><a id=__codelineno-18-23 name=__codelineno-18-23 href=#__codelineno-18-23></a><span class=gp>... </span>
</span><span id=__span-18-24><a id=__codelineno-18-24 name=__codelineno-18-24 href=#__codelineno-18-24></a><span class=gp>... </span>    <span class=c1># (3)!</span>
</span><span id=__span-18-25><a id=__codelineno-18-25 name=__codelineno-18-25 href=#__codelineno-18-25></a><span class=gp>... </span>    <span class=n>out_state</span> <span class=o>=</span> <span class=n>superfast_supertrend_acc_nb</span><span class=p>(</span><span class=n>in_state</span><span class=p>)</span>
</span><span id=__span-18-26><a id=__codelineno-18-26 name=__codelineno-18-26 href=#__codelineno-18-26></a><span class=gp>... </span>
</span><span id=__span-18-27><a id=__codelineno-18-27 name=__codelineno-18-27 href=#__codelineno-18-27></a><span class=gp>... </span>    <span class=c1># (4)!</span>
</span><span id=__span-18-28><a id=__codelineno-18-28 name=__codelineno-18-28 href=#__codelineno-18-28></a><span class=gp>... </span>    <span class=n>memory</span><span class=o>.</span><span class=n>nobs</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>out_state</span><span class=o>.</span><span class=n>nobs</span>
</span><span id=__span-18-29><a id=__codelineno-18-29 name=__codelineno-18-29 href=#__codelineno-18-29></a><span class=gp>... </span>    <span class=n>memory</span><span class=o>.</span><span class=n>weighted_avg</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>out_state</span><span class=o>.</span><span class=n>weighted_avg</span>
</span><span id=__span-18-30><a id=__codelineno-18-30 name=__codelineno-18-30 href=#__codelineno-18-30></a><span class=gp>... </span>    <span class=n>memory</span><span class=o>.</span><span class=n>old_wt</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>out_state</span><span class=o>.</span><span class=n>old_wt</span>
</span><span id=__span-18-31><a id=__codelineno-18-31 name=__codelineno-18-31 href=#__codelineno-18-31></a><span class=gp>... </span>    <span class=n>memory</span><span class=o>.</span><span class=n>prev_upper</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>out_state</span><span class=o>.</span><span class=n>upper</span>
</span><span id=__span-18-32><a id=__codelineno-18-32 name=__codelineno-18-32 href=#__codelineno-18-32></a><span class=gp>... </span>    <span class=n>memory</span><span class=o>.</span><span class=n>prev_lower</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>out_state</span><span class=o>.</span><span class=n>lower</span>
</span><span id=__span-18-33><a id=__codelineno-18-33 name=__codelineno-18-33 href=#__codelineno-18-33></a><span class=gp>... </span>    <span class=n>memory</span><span class=o>.</span><span class=n>prev_dir_</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>out_state</span><span class=o>.</span><span class=n>dir_</span>
</span><span id=__span-18-34><a id=__codelineno-18-34 name=__codelineno-18-34 href=#__codelineno-18-34></a><span class=gp>... </span>    <span class=n>memory</span><span class=o>.</span><span class=n>was_entry</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>out_state</span><span class=o>.</span><span class=n>long</span><span class=p>)</span>
</span><span id=__span-18-35><a id=__codelineno-18-35 name=__codelineno-18-35 href=#__codelineno-18-35></a><span class=gp>... </span>    <span class=n>memory</span><span class=o>.</span><span class=n>was_exit</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>out_state</span><span class=o>.</span><span class=n>short</span><span class=p>)</span>
</span><span id=__span-18-36><a id=__codelineno-18-36 name=__codelineno-18-36 href=#__codelineno-18-36></a><span class=gp>... </span>    
</span><span id=__span-18-37><a id=__codelineno-18-37 name=__codelineno-18-37 href=#__codelineno-18-37></a><span class=gp>... </span>    <span class=c1># (5)!</span>
</span><span id=__span-18-38><a id=__codelineno-18-38 name=__codelineno-18-38 href=#__codelineno-18-38></a><span class=gp>... </span>    <span class=n>in_position</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>position_now</span> <span class=o>&gt;</span> <span class=mi>0</span>
</span><span id=__span-18-39><a id=__codelineno-18-39 name=__codelineno-18-39 href=#__codelineno-18-39></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>is_entry</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>in_position</span><span class=p>:</span>
</span><span id=__span-18-40><a id=__codelineno-18-40 name=__codelineno-18-40 href=#__codelineno-18-40></a><span class=gp>... </span>        <span class=n>size</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>inf</span>
</span><span id=__span-18-41><a id=__codelineno-18-41 name=__codelineno-18-41 href=#__codelineno-18-41></a><span class=gp>... </span>    <span class=k>elif</span> <span class=n>is_exit</span> <span class=ow>and</span> <span class=n>in_position</span><span class=p>:</span>
</span><span id=__span-18-42><a id=__codelineno-18-42 name=__codelineno-18-42 href=#__codelineno-18-42></a><span class=gp>... </span>        <span class=n>size</span> <span class=o>=</span> <span class=o>-</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span>
</span><span id=__span-18-43><a id=__codelineno-18-43 name=__codelineno-18-43 href=#__codelineno-18-43></a><span class=gp>... </span>    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-18-44><a id=__codelineno-18-44 name=__codelineno-18-44 href=#__codelineno-18-44></a><span class=gp>... </span>        <span class=n>size</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span>
</span><span id=__span-18-45><a id=__codelineno-18-45 name=__codelineno-18-45 href=#__codelineno-18-45></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nb</span><span class=p>(</span>
</span><span id=__span-18-46><a id=__codelineno-18-46 name=__codelineno-18-46 href=#__codelineno-18-46></a><span class=gp>... </span>        <span class=n>size</span><span class=o>=</span><span class=n>size</span><span class=p>,</span> 
</span><span id=__span-18-47><a id=__codelineno-18-47 name=__codelineno-18-47 href=#__codelineno-18-47></a><span class=gp>... </span>        <span class=n>direction</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>Direction</span><span class=o>.</span><span class=n>LongOnly</span><span class=p>,</span>
</span><span id=__span-18-48><a id=__codelineno-18-48 name=__codelineno-18-48 href=#__codelineno-18-48></a><span class=gp>... </span>        <span class=n>fees</span><span class=o>=</span><span class=mf>0.001</span>
</span><span id=__span-18-49><a id=__codelineno-18-49 name=__codelineno-18-49 href=#__codelineno-18-49></a><span class=gp>... </span>    <span class=p>)</span>
</span></code></pre></div> <ol> <li>Access the signals generated at the previous time step (shifting).</li> <li>Build the input state for <code>superfast_supertrend_acc_nb</code> from the context and memory.</li> <li>Run the SuperTrend accumulator for this step.</li> <li>Write the returned state back into memory.</li> <li>Decide whether to buy (<code>np.inf</code>), sell (<code>-np.inf</code>), or do nothing (<code>np.nan</code>).</li> </ol> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>If the execution time needs to be shifted by more than one tick, consider creating a complete array for the <code>long</code> and <code>short</code> values returned by <code>superfast_supertrend_acc_nb</code>, and access any previous element in those arrays to generate a signal.</p> <p>If an order decision (such as <code>is_entry</code>) is based on a value from an array (such as <code>memory.was_entry</code>), temporarily store the element in a constant variable—Numba prefers it.</p> </div> <p>The last callback is the segment post-processing function. A segment is a group of columns at a single time step, primarily used for managing orders of assets that share the same capital or are linked in other ways. Since our portfolio is not grouped, each column (<code>BTCUSDT</code> and <code>ETHUSDT</code>) forms its own group, so each segment contains just one column. After all columns in a segment are processed, the simulator updates the current group value and the return. The return is then used by our callback to calculate the Sharpe ratio:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span><span class=p>(</span><span class=n>nogil</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>post_segment_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>memory</span><span class=p>,</span> <span class=n>ann_factor</span><span class=p>):</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>from_col</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>to_col</span><span class=p>):</span>  <span class=c1># (1)!</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=gp>... </span>        <span class=n>in_state</span> <span class=o>=</span> <span class=n>RollSharpeAIS</span><span class=p>(</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=gp>... </span>            <span class=n>i</span><span class=o>=</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=gp>... </span>            <span class=n>ret</span><span class=o>=</span><span class=n>c</span><span class=o>.</span><span class=n>last_return</span><span class=p>[</span><span class=n>col</span><span class=p>],</span>  <span class=c1># (2)!</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a><span class=gp>... </span>            <span class=n>pre_window_ret</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a><span class=gp>... </span>            <span class=n>cumsum</span><span class=o>=</span><span class=n>memory</span><span class=o>.</span><span class=n>cumsum</span><span class=p>[</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-19-9><a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a><span class=gp>... </span>            <span class=n>cumsum_sq</span><span class=o>=</span><span class=n>memory</span><span class=o>.</span><span class=n>cumsum_sq</span><span class=p>[</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-19-10><a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a><span class=gp>... </span>            <span class=n>nancnt</span><span class=o>=</span><span class=n>memory</span><span class=o>.</span><span class=n>nancnt</span><span class=p>[</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-19-11><a id=__codelineno-19-11 name=__codelineno-19-11 href=#__codelineno-19-11></a><span class=gp>... </span>            <span class=n>window</span><span class=o>=</span><span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span>  <span class=c1># (3)!</span>
</span><span id=__span-19-12><a id=__codelineno-19-12 name=__codelineno-19-12 href=#__codelineno-19-12></a><span class=gp>... </span>            <span class=n>minp</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span><span id=__span-19-13><a id=__codelineno-19-13 name=__codelineno-19-13 href=#__codelineno-19-13></a><span class=gp>... </span>            <span class=n>ddof</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span><span id=__span-19-14><a id=__codelineno-19-14 name=__codelineno-19-14 href=#__codelineno-19-14></a><span class=gp>... </span>            <span class=n>ann_factor</span><span class=o>=</span><span class=n>ann_factor</span>
</span><span id=__span-19-15><a id=__codelineno-19-15 name=__codelineno-19-15 href=#__codelineno-19-15></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-19-16><a id=__codelineno-19-16 name=__codelineno-19-16 href=#__codelineno-19-16></a><span class=gp>... </span>        <span class=n>out_state</span> <span class=o>=</span> <span class=n>rolling_sharpe_acc_nb</span><span class=p>(</span><span class=n>in_state</span><span class=p>)</span>
</span><span id=__span-19-17><a id=__codelineno-19-17 name=__codelineno-19-17 href=#__codelineno-19-17></a><span class=gp>... </span>        <span class=n>memory</span><span class=o>.</span><span class=n>cumsum</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>out_state</span><span class=o>.</span><span class=n>cumsum</span>
</span><span id=__span-19-18><a id=__codelineno-19-18 name=__codelineno-19-18 href=#__codelineno-19-18></a><span class=gp>... </span>        <span class=n>memory</span><span class=o>.</span><span class=n>cumsum_sq</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>out_state</span><span class=o>.</span><span class=n>cumsum_sq</span>
</span><span id=__span-19-19><a id=__codelineno-19-19 name=__codelineno-19-19 href=#__codelineno-19-19></a><span class=gp>... </span>        <span class=n>memory</span><span class=o>.</span><span class=n>nancnt</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>out_state</span><span class=o>.</span><span class=n>nancnt</span>
</span><span id=__span-19-20><a id=__codelineno-19-20 name=__codelineno-19-20 href=#__codelineno-19-20></a><span class=gp>... </span>        <span class=n>c</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>sharpe</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>out_state</span><span class=o>.</span><span class=n>value</span>  <span class=c1># (4)!</span>
</span></code></pre></div> <ol> <li>Iterate over all columns in the current segment. In our case, each segment contains just one column.</li> <li>Get the return effective at the end of the current time step.</li> <li>Use an expanding window.</li> <li>Write the Sharpe value to the in-place output array defined below.</li> </ol> <p>Here is a short illustration of how the functions call each other:</p> <pre class=mermaid><code>flowchart TD;
    id1["pre_sim_func_nb"]

    id1 --&gt;|"memory"| id2;
    id1 --&gt;|"memory"| id8;

    subgraph " "
    id2["order_func_nb"]
    id3["superfast_supertrend_acc_nb"]
    id4["SuperTrend"]
    id5["Signal"]
    id6["Order"]
    id2 --&gt;|"calls"| id3;
    id3 --&gt;|"calculates"| id4;
    id4 --&gt;|"generates"| id5;
    id5 --&gt;|"issues"| id6;

    id7["Return"]
    id6 --&gt;|"updates"| id7;
    id7 --&gt;|"consumed by"| id8;

    id8["post_segment_func_nb"]
    id9["rolling_sharpe_acc_nb"]
    id10["Sharpe"]
    id8 --&gt;|"calls"| id9;
    id9 --&gt;|"calculates"| id10;
    end</code></pre> <p>(Reload the page if the diagram does not appear.)</p> <div class="admonition info"> <p class=admonition-title>Info</p> <p>The operation flow inside the rectangle is executed at each time step.</p> </div> <h3 id=pipeline>Pipeline<a class=headerlink href=#pipeline title="Permanent link">&para;</a></h3> <p>Let's put all the parts together and define our super-flexible pipeline:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span><span class=w> </span><span class=nc>InOutputs</span><span class=p>(</span><span class=n>tp</span><span class=o>.</span><span class=n>NamedTuple</span><span class=p>):</span>  <span class=c1># (1)!</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=gp>... </span>    <span class=n>sharpe</span><span class=p>:</span> <span class=n>tp</span><span class=o>.</span><span class=n>Array1d</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span><span class=p>(</span><span class=n>nogil</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>ctx_pipeline_nb</span><span class=p>(</span><span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span> <span class=n>close</span><span class=p>,</span> 
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a><span class=gp>... </span>                    <span class=n>periods</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>([</span><span class=mi>7</span><span class=p>]),</span> 
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a><span class=gp>... </span>                    <span class=n>multipliers</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>([</span><span class=mi>3</span><span class=p>]),</span> 
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a><span class=gp>... </span>                    <span class=n>ann_factor</span><span class=o>=</span><span class=mi>365</span><span class=p>):</span>
</span><span id=__span-20-9><a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a><span class=gp>...</span>
</span><span id=__span-20-10><a id=__codelineno-20-10 name=__codelineno-20-10 href=#__codelineno-20-10></a><span class=gp>... </span>    <span class=n>in_outputs</span> <span class=o>=</span> <span class=n>InOutputs</span><span class=p>(</span><span class=n>sharpe</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>float_</span><span class=p>))</span>
</span><span id=__span-20-11><a id=__codelineno-20-11 name=__codelineno-20-11 href=#__codelineno-20-11></a><span class=gp>... </span>    <span class=n>sharpe</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>periods</span><span class=o>.</span><span class=n>size</span> <span class=o>*</span> <span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>float_</span><span class=p>)</span>
</span><span id=__span-20-12><a id=__codelineno-20-12 name=__codelineno-20-12 href=#__codelineno-20-12></a><span class=gp>... </span>    <span class=n>group_lens</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mi>1</span><span class=p>)</span>
</span><span id=__span-20-13><a id=__codelineno-20-13 name=__codelineno-20-13 href=#__codelineno-20-13></a><span class=gp>... </span>    <span class=n>init_cash</span> <span class=o>=</span> <span class=mf>100.</span>
</span><span id=__span-20-14><a id=__codelineno-20-14 name=__codelineno-20-14 href=#__codelineno-20-14></a><span class=gp>... </span>    <span class=n>k</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-20-15><a id=__codelineno-20-15 name=__codelineno-20-15 href=#__codelineno-20-15></a><span class=gp>... </span>    
</span><span id=__span-20-16><a id=__codelineno-20-16 name=__codelineno-20-16 href=#__codelineno-20-16></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>periods</span><span class=o>.</span><span class=n>size</span><span class=p>):</span>
</span><span id=__span-20-17><a id=__codelineno-20-17 name=__codelineno-20-17 href=#__codelineno-20-17></a><span class=gp>... </span>        <span class=n>sim_out</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>from_order_func_nb</span><span class=p>(</span>
</span><span id=__span-20-18><a id=__codelineno-20-18 name=__codelineno-20-18 href=#__codelineno-20-18></a><span class=gp>... </span>            <span class=n>target_shape</span><span class=o>=</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span>
</span><span id=__span-20-19><a id=__codelineno-20-19 name=__codelineno-20-19 href=#__codelineno-20-19></a><span class=gp>... </span>            <span class=n>group_lens</span><span class=o>=</span><span class=n>group_lens</span><span class=p>,</span>
</span><span id=__span-20-20><a id=__codelineno-20-20 name=__codelineno-20-20 href=#__codelineno-20-20></a><span class=gp>... </span>            <span class=n>cash_sharing</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-20-21><a id=__codelineno-20-21 name=__codelineno-20-21 href=#__codelineno-20-21></a><span class=gp>... </span>            <span class=n>init_cash</span><span class=o>=</span><span class=n>init_cash</span><span class=p>,</span>
</span><span id=__span-20-22><a id=__codelineno-20-22 name=__codelineno-20-22 href=#__codelineno-20-22></a><span class=gp>... </span>            <span class=n>pre_sim_func_nb</span><span class=o>=</span><span class=n>pre_sim_func_nb</span><span class=p>,</span>
</span><span id=__span-20-23><a id=__codelineno-20-23 name=__codelineno-20-23 href=#__codelineno-20-23></a><span class=gp>... </span>            <span class=n>order_func_nb</span><span class=o>=</span><span class=n>order_func_nb</span><span class=p>,</span>
</span><span id=__span-20-24><a id=__codelineno-20-24 name=__codelineno-20-24 href=#__codelineno-20-24></a><span class=gp>... </span>            <span class=n>order_args</span><span class=o>=</span><span class=p>(</span><span class=n>periods</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>multipliers</span><span class=p>[</span><span class=n>i</span><span class=p>]),</span>
</span><span id=__span-20-25><a id=__codelineno-20-25 name=__codelineno-20-25 href=#__codelineno-20-25></a><span class=gp>... </span>            <span class=n>post_segment_func_nb</span><span class=o>=</span><span class=n>post_segment_func_nb</span><span class=p>,</span>
</span><span id=__span-20-26><a id=__codelineno-20-26 name=__codelineno-20-26 href=#__codelineno-20-26></a><span class=gp>... </span>            <span class=n>post_segment_args</span><span class=o>=</span><span class=p>(</span><span class=n>ann_factor</span><span class=p>,),</span>
</span><span id=__span-20-27><a id=__codelineno-20-27 name=__codelineno-20-27 href=#__codelineno-20-27></a><span class=gp>... </span>            <span class=n>high</span><span class=o>=</span><span class=n>high</span><span class=p>,</span>
</span><span id=__span-20-28><a id=__codelineno-20-28 name=__codelineno-20-28 href=#__codelineno-20-28></a><span class=gp>... </span>            <span class=n>low</span><span class=o>=</span><span class=n>low</span><span class=p>,</span>
</span><span id=__span-20-29><a id=__codelineno-20-29 name=__codelineno-20-29 href=#__codelineno-20-29></a><span class=gp>... </span>            <span class=n>close</span><span class=o>=</span><span class=n>close</span><span class=p>,</span>
</span><span id=__span-20-30><a id=__codelineno-20-30 name=__codelineno-20-30 href=#__codelineno-20-30></a><span class=gp>... </span>            <span class=n>in_outputs</span><span class=o>=</span><span class=n>in_outputs</span><span class=p>,</span>
</span><span id=__span-20-31><a id=__codelineno-20-31 name=__codelineno-20-31 href=#__codelineno-20-31></a><span class=gp>... </span>            <span class=n>fill_pos_info</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-20-32><a id=__codelineno-20-32 name=__codelineno-20-32 href=#__codelineno-20-32></a><span class=gp>... </span>            <span class=n>max_order_records</span><span class=o>=</span><span class=mi>0</span>  <span class=c1># (3)!</span>
</span><span id=__span-20-33><a id=__codelineno-20-33 name=__codelineno-20-33 href=#__codelineno-20-33></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-20-34><a id=__codelineno-20-34 name=__codelineno-20-34 href=#__codelineno-20-34></a><span class=gp>... </span>        <span class=n>sharpe</span><span class=p>[</span><span class=n>k</span><span class=p>:</span><span class=n>k</span> <span class=o>+</span> <span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]]</span> <span class=o>=</span> <span class=n>in_outputs</span><span class=o>.</span><span class=n>sharpe</span>
</span><span id=__span-20-35><a id=__codelineno-20-35 name=__codelineno-20-35 href=#__codelineno-20-35></a><span class=gp>... </span>        <span class=n>k</span> <span class=o>+=</span> <span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-20-36><a id=__codelineno-20-36 name=__codelineno-20-36 href=#__codelineno-20-36></a><span class=gp>... </span>        
</span><span id=__span-20-37><a id=__codelineno-20-37 name=__codelineno-20-37 href=#__codelineno-20-37></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>sharpe</span>
</span></code></pre></div> <ol> <li>A named tuple containing any array you want to write during the simulation and access afterwards.</li> <li>Disables filling position records to speed up the simulation.</li> <li>Disables filling order records to speed up the simulation.</li> </ol> <p>This function has the same signature as <code>pipeline_nb</code> and, conveniently, produces the same results!</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>ctx_pipeline_nb</span><span class=p>(</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=gp>... </span>    <span class=n>high</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=gp>... </span>    <span class=n>low</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=gp>... </span>    <span class=n>close</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a><span class=gp>... </span>    <span class=n>ann_factor</span><span class=o>=</span><span class=n>ann_factor</span>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a><span class=go>array([1.521221, 2.25850084])</span>
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a>
</span><span id=__span-21-9><a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>chunked_ctx_pipeline_nb</span> <span class=o>=</span> <span class=n>nb_chunked</span><span class=p>(</span><span class=n>ctx_pipeline_nb</span><span class=p>)</span>
</span><span id=__span-21-10><a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>chunked_ctx_pipeline_nb</span><span class=p>(</span>
</span><span id=__span-21-11><a id=__codelineno-21-11 name=__codelineno-21-11 href=#__codelineno-21-11></a><span class=gp>... </span>    <span class=n>high</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-21-12><a id=__codelineno-21-12 name=__codelineno-21-12 href=#__codelineno-21-12></a><span class=gp>... </span>    <span class=n>low</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-21-13><a id=__codelineno-21-13 name=__codelineno-21-13 href=#__codelineno-21-13></a><span class=gp>... </span>    <span class=n>close</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-21-14><a id=__codelineno-21-14 name=__codelineno-21-14 href=#__codelineno-21-14></a><span class=gp>... </span>    <span class=n>periods</span><span class=o>=</span><span class=n>period_product</span><span class=p>[:</span><span class=mi>4</span><span class=p>],</span> 
</span><span id=__span-21-15><a id=__codelineno-21-15 name=__codelineno-21-15 href=#__codelineno-21-15></a><span class=gp>... </span>    <span class=n>multipliers</span><span class=o>=</span><span class=n>multiplier_product</span><span class=p>[:</span><span class=mi>4</span><span class=p>],</span>
</span><span id=__span-21-16><a id=__codelineno-21-16 name=__codelineno-21-16 href=#__codelineno-21-16></a><span class=gp>... </span>    <span class=n>ann_factor</span><span class=o>=</span><span class=n>ann_factor</span><span class=p>,</span>
</span><span id=__span-21-17><a id=__codelineno-21-17 name=__codelineno-21-17 href=#__codelineno-21-17></a><span class=gp>... </span>    <span class=n>_n_chunks</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span>
</span><span id=__span-21-18><a id=__codelineno-21-18 name=__codelineno-21-18 href=#__codelineno-21-18></a><span class=gp>... </span>    <span class=n>_merge_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>input_columns</span><span class=o>=</span><span class=n>close</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span>
</span><span id=__span-21-19><a id=__codelineno-21-19 name=__codelineno-21-19 href=#__codelineno-21-19></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <p> <div class="progress progress-100plus candystripe candystripe-animate"> <div class=progress-bar style=width:100.00%> <p class=progress-label>Chunk 2/2</p> </div> </div> </p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=go>st_period  st_multiplier  symbol </span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=go>4          2.0            BTCUSDT    0.451699</span>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a><span class=go>                          ETHUSDT    1.391032</span>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a><span class=go>           2.1            BTCUSDT    0.495387</span>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a><span class=go>                          ETHUSDT    1.134741</span>
</span><span id=__span-22-6><a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a><span class=go>           2.2            BTCUSDT    0.985946</span>
</span><span id=__span-22-7><a id=__codelineno-22-7 name=__codelineno-22-7 href=#__codelineno-22-7></a><span class=go>                          ETHUSDT    0.955616</span>
</span><span id=__span-22-8><a id=__codelineno-22-8 name=__codelineno-22-8 href=#__codelineno-22-8></a><span class=go>           2.3            BTCUSDT    1.193179</span>
</span><span id=__span-22-9><a id=__codelineno-22-9 name=__codelineno-22-9 href=#__codelineno-22-9></a><span class=go>                          ETHUSDT    1.307505</span>
</span><span id=__span-22-10><a id=__codelineno-22-10 name=__codelineno-22-10 href=#__codelineno-22-10></a><span class=go>dtype: float64</span>
</span></code></pre></div> <p>However, compared to the previous pipeline, this one is several times slower:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=gp>&gt;&gt;&gt; </span><span class=o>%%</span><span class=n>timeit</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>chunked_ctx_pipeline_nb</span><span class=p>(</span>
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a><span class=gp>... </span>    <span class=n>high</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a><span class=gp>... </span>    <span class=n>low</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a><span class=gp>... </span>    <span class=n>close</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-23-6><a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a><span class=gp>... </span>    <span class=n>periods</span><span class=o>=</span><span class=n>period_product</span><span class=p>,</span> 
</span><span id=__span-23-7><a id=__codelineno-23-7 name=__codelineno-23-7 href=#__codelineno-23-7></a><span class=gp>... </span>    <span class=n>multipliers</span><span class=o>=</span><span class=n>multiplier_product</span><span class=p>,</span>
</span><span id=__span-23-8><a id=__codelineno-23-8 name=__codelineno-23-8 href=#__codelineno-23-8></a><span class=gp>... </span>    <span class=n>ann_factor</span><span class=o>=</span><span class=n>ann_factor</span><span class=p>,</span>
</span><span id=__span-23-9><a id=__codelineno-23-9 name=__codelineno-23-9 href=#__codelineno-23-9></a><span class=gp>... </span>    <span class=n>_merge_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>input_columns</span><span class=o>=</span><span class=n>close</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span>
</span><span id=__span-23-10><a id=__codelineno-23-10 name=__codelineno-23-10 href=#__codelineno-23-10></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-23-11><a id=__codelineno-23-11 name=__codelineno-23-11 href=#__codelineno-23-11></a><span class=go>6.4 s ± 45.7 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</span><span id=__span-23-12><a id=__codelineno-23-12 name=__codelineno-23-12 href=#__codelineno-23-12></a>
</span><span id=__span-23-13><a id=__codelineno-23-13 name=__codelineno-23-13 href=#__codelineno-23-13></a><span class=gp>&gt;&gt;&gt; </span><span class=o>%%</span><span class=n>timeit</span>
</span><span id=__span-23-14><a id=__codelineno-23-14 name=__codelineno-23-14 href=#__codelineno-23-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>chunked_ctx_pipeline_nb</span><span class=p>(</span>
</span><span id=__span-23-15><a id=__codelineno-23-15 name=__codelineno-23-15 href=#__codelineno-23-15></a><span class=gp>... </span>    <span class=n>high</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-23-16><a id=__codelineno-23-16 name=__codelineno-23-16 href=#__codelineno-23-16></a><span class=gp>... </span>    <span class=n>low</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-23-17><a id=__codelineno-23-17 name=__codelineno-23-17 href=#__codelineno-23-17></a><span class=gp>... </span>    <span class=n>close</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-23-18><a id=__codelineno-23-18 name=__codelineno-23-18 href=#__codelineno-23-18></a><span class=gp>... </span>    <span class=n>periods</span><span class=o>=</span><span class=n>period_product</span><span class=p>,</span> 
</span><span id=__span-23-19><a id=__codelineno-23-19 name=__codelineno-23-19 href=#__codelineno-23-19></a><span class=gp>... </span>    <span class=n>multipliers</span><span class=o>=</span><span class=n>multiplier_product</span><span class=p>,</span>
</span><span id=__span-23-20><a id=__codelineno-23-20 name=__codelineno-23-20 href=#__codelineno-23-20></a><span class=gp>... </span>    <span class=n>ann_factor</span><span class=o>=</span><span class=n>ann_factor</span><span class=p>,</span>
</span><span id=__span-23-21><a id=__codelineno-23-21 name=__codelineno-23-21 href=#__codelineno-23-21></a><span class=gp>... </span>    <span class=n>_execute_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>engine</span><span class=o>=</span><span class=s2>&quot;dask&quot;</span><span class=p>),</span>
</span><span id=__span-23-22><a id=__codelineno-23-22 name=__codelineno-23-22 href=#__codelineno-23-22></a><span class=gp>... </span>    <span class=n>_merge_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>input_columns</span><span class=o>=</span><span class=n>close</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span>
</span><span id=__span-23-23><a id=__codelineno-23-23 name=__codelineno-23-23 href=#__codelineno-23-23></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-23-24><a id=__codelineno-23-24 name=__codelineno-23-24 href=#__codelineno-23-24></a><span class=go>1.38 s ± 26.1 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</span></code></pre></div> <p>We sacrificed a bit of performance for complete flexibility. But even with this setup, event-driven backtesting of a <strong>full grid</strong> of parameter combinations with VBT is as fast as a <strong>single</strong> SuperTrend calculation with Pandas <img alt=😅 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f605.svg title=:sweat_smile:></p> <h2 id=bonus-own-simulator>Bonus: Own simulator<a class=headerlink href=#bonus-own-simulator title="Permanent link">&para;</a></h2> <p>If your top priority is maximum performance, you have a perfect streaming algorithm, and you know exactly how to compute your desired metrics on the fly, you can skip simulation with the <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio>Portfolio</a> class entirely. Instead, define the core logic using a set of primitive, pure, and ultra-fast Numba-compiled for-loops. With this approach, you can directly use VBT's core features for handling order execution:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span><span class=p>(</span><span class=n>nogil</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>raw_pipeline_nb</span><span class=p>(</span><span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span> <span class=n>close</span><span class=p>,</span> 
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=gp>... </span>                    <span class=n>periods</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>7</span><span class=p>]),</span> 
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=gp>... </span>                    <span class=n>multipliers</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>3</span><span class=p>]),</span> 
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a><span class=gp>... </span>                    <span class=n>ann_factor</span><span class=o>=</span><span class=mi>365</span><span class=p>):</span>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a><span class=gp>... </span>    <span class=n>out</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>periods</span><span class=o>.</span><span class=n>size</span> <span class=o>*</span> <span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>float_</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=gp>... </span>    
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-24-9><a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a><span class=gp>... </span>        <span class=k>return</span> <span class=n>out</span>
</span><span id=__span-24-10><a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a><span class=gp>... </span>
</span><span id=__span-24-11><a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>periods</span><span class=p>)):</span>  <span class=c1># (2)!</span>
</span><span id=__span-24-12><a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a><span class=gp>... </span>        
</span><span id=__span-24-13><a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a><span class=gp>... </span>        <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]):</span>  <span class=c1># (3)!</span>
</span><span id=__span-24-14><a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a><span class=gp>... </span>            <span class=c1># (4)!</span>
</span><span id=__span-24-15><a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a><span class=gp>... </span>            <span class=n>nobs</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-24-16><a id=__codelineno-24-16 name=__codelineno-24-16 href=#__codelineno-24-16></a><span class=gp>... </span>            <span class=n>old_wt</span> <span class=o>=</span> <span class=mf>1.</span>
</span><span id=__span-24-17><a id=__codelineno-24-17 name=__codelineno-24-17 href=#__codelineno-24-17></a><span class=gp>... </span>            <span class=n>weighted_avg</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span>
</span><span id=__span-24-18><a id=__codelineno-24-18 name=__codelineno-24-18 href=#__codelineno-24-18></a><span class=gp>... </span>            <span class=n>prev_close_</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span>
</span><span id=__span-24-19><a id=__codelineno-24-19 name=__codelineno-24-19 href=#__codelineno-24-19></a><span class=gp>... </span>            <span class=n>prev_upper</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span>
</span><span id=__span-24-20><a id=__codelineno-24-20 name=__codelineno-24-20 href=#__codelineno-24-20></a><span class=gp>... </span>            <span class=n>prev_lower</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span>
</span><span id=__span-24-21><a id=__codelineno-24-21 name=__codelineno-24-21 href=#__codelineno-24-21></a><span class=gp>... </span>            <span class=n>prev_dir_</span> <span class=o>=</span> <span class=mi>1</span>
</span><span id=__span-24-22><a id=__codelineno-24-22 name=__codelineno-24-22 href=#__codelineno-24-22></a><span class=gp>... </span>            <span class=n>cumsum</span> <span class=o>=</span> <span class=mf>0.</span>
</span><span id=__span-24-23><a id=__codelineno-24-23 name=__codelineno-24-23 href=#__codelineno-24-23></a><span class=gp>... </span>            <span class=n>cumsum_sq</span> <span class=o>=</span> <span class=mf>0.</span>
</span><span id=__span-24-24><a id=__codelineno-24-24 name=__codelineno-24-24 href=#__codelineno-24-24></a><span class=gp>... </span>            <span class=n>nancnt</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-24-25><a id=__codelineno-24-25 name=__codelineno-24-25 href=#__codelineno-24-25></a><span class=gp>... </span>            <span class=n>was_entry</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-24-26><a id=__codelineno-24-26 name=__codelineno-24-26 href=#__codelineno-24-26></a><span class=gp>... </span>            <span class=n>was_exit</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-24-27><a id=__codelineno-24-27 name=__codelineno-24-27 href=#__codelineno-24-27></a><span class=gp>... </span>
</span><span id=__span-24-28><a id=__codelineno-24-28 name=__codelineno-24-28 href=#__codelineno-24-28></a><span class=gp>... </span>            <span class=c1># (5)!</span>
</span><span id=__span-24-29><a id=__codelineno-24-29 name=__codelineno-24-29 href=#__codelineno-24-29></a><span class=gp>... </span>            <span class=n>init_cash</span> <span class=o>=</span> <span class=mf>100.</span>
</span><span id=__span-24-30><a id=__codelineno-24-30 name=__codelineno-24-30 href=#__codelineno-24-30></a><span class=gp>... </span>            <span class=n>cash</span> <span class=o>=</span> <span class=n>init_cash</span>
</span><span id=__span-24-31><a id=__codelineno-24-31 name=__codelineno-24-31 href=#__codelineno-24-31></a><span class=gp>... </span>            <span class=n>position</span> <span class=o>=</span> <span class=mf>0.</span>
</span><span id=__span-24-32><a id=__codelineno-24-32 name=__codelineno-24-32 href=#__codelineno-24-32></a><span class=gp>... </span>            <span class=n>debt</span> <span class=o>=</span> <span class=mf>0.</span>
</span><span id=__span-24-33><a id=__codelineno-24-33 name=__codelineno-24-33 href=#__codelineno-24-33></a><span class=gp>... </span>            <span class=n>locked_cash</span> <span class=o>=</span> <span class=mf>0.</span>
</span><span id=__span-24-34><a id=__codelineno-24-34 name=__codelineno-24-34 href=#__codelineno-24-34></a><span class=gp>... </span>            <span class=n>free_cash</span> <span class=o>=</span> <span class=n>init_cash</span>
</span><span id=__span-24-35><a id=__codelineno-24-35 name=__codelineno-24-35 href=#__codelineno-24-35></a><span class=gp>... </span>            <span class=n>val_price</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span>
</span><span id=__span-24-36><a id=__codelineno-24-36 name=__codelineno-24-36 href=#__codelineno-24-36></a><span class=gp>... </span>            <span class=n>value</span> <span class=o>=</span> <span class=n>init_cash</span>
</span><span id=__span-24-37><a id=__codelineno-24-37 name=__codelineno-24-37 href=#__codelineno-24-37></a><span class=gp>... </span>            <span class=n>prev_value</span> <span class=o>=</span> <span class=n>init_cash</span>
</span><span id=__span-24-38><a id=__codelineno-24-38 name=__codelineno-24-38 href=#__codelineno-24-38></a><span class=gp>... </span>            <span class=n>return_</span> <span class=o>=</span> <span class=mf>0.</span>
</span><span id=__span-24-39><a id=__codelineno-24-39 name=__codelineno-24-39 href=#__codelineno-24-39></a><span class=gp>... </span>
</span><span id=__span-24-40><a id=__codelineno-24-40 name=__codelineno-24-40 href=#__codelineno-24-40></a><span class=gp>... </span>            <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>  <span class=c1># (6)!</span>
</span><span id=__span-24-41><a id=__codelineno-24-41 name=__codelineno-24-41 href=#__codelineno-24-41></a><span class=gp>... </span>                <span class=c1># (7)!</span>
</span><span id=__span-24-42><a id=__codelineno-24-42 name=__codelineno-24-42 href=#__codelineno-24-42></a><span class=gp>... </span>                <span class=n>is_entry</span> <span class=o>=</span> <span class=n>was_entry</span>
</span><span id=__span-24-43><a id=__codelineno-24-43 name=__codelineno-24-43 href=#__codelineno-24-43></a><span class=gp>... </span>                <span class=n>is_exit</span> <span class=o>=</span> <span class=n>was_exit</span>
</span><span id=__span-24-44><a id=__codelineno-24-44 name=__codelineno-24-44 href=#__codelineno-24-44></a><span class=gp>... </span>
</span><span id=__span-24-45><a id=__codelineno-24-45 name=__codelineno-24-45 href=#__codelineno-24-45></a><span class=gp>... </span>                <span class=n>st_in_state</span> <span class=o>=</span> <span class=n>SuperTrendAIS</span><span class=p>(</span>
</span><span id=__span-24-46><a id=__codelineno-24-46 name=__codelineno-24-46 href=#__codelineno-24-46></a><span class=gp>... </span>                    <span class=n>i</span><span class=o>=</span><span class=n>i</span><span class=p>,</span>
</span><span id=__span-24-47><a id=__codelineno-24-47 name=__codelineno-24-47 href=#__codelineno-24-47></a><span class=gp>... </span>                    <span class=n>high</span><span class=o>=</span><span class=n>high</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>],</span>
</span><span id=__span-24-48><a id=__codelineno-24-48 name=__codelineno-24-48 href=#__codelineno-24-48></a><span class=gp>... </span>                    <span class=n>low</span><span class=o>=</span><span class=n>low</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>],</span>
</span><span id=__span-24-49><a id=__codelineno-24-49 name=__codelineno-24-49 href=#__codelineno-24-49></a><span class=gp>... </span>                    <span class=n>close</span><span class=o>=</span><span class=n>close</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>],</span>
</span><span id=__span-24-50><a id=__codelineno-24-50 name=__codelineno-24-50 href=#__codelineno-24-50></a><span class=gp>... </span>                    <span class=n>prev_close</span><span class=o>=</span><span class=n>prev_close_</span><span class=p>,</span>
</span><span id=__span-24-51><a id=__codelineno-24-51 name=__codelineno-24-51 href=#__codelineno-24-51></a><span class=gp>... </span>                    <span class=n>prev_upper</span><span class=o>=</span><span class=n>prev_upper</span><span class=p>,</span>
</span><span id=__span-24-52><a id=__codelineno-24-52 name=__codelineno-24-52 href=#__codelineno-24-52></a><span class=gp>... </span>                    <span class=n>prev_lower</span><span class=o>=</span><span class=n>prev_lower</span><span class=p>,</span>
</span><span id=__span-24-53><a id=__codelineno-24-53 name=__codelineno-24-53 href=#__codelineno-24-53></a><span class=gp>... </span>                    <span class=n>prev_dir_</span><span class=o>=</span><span class=n>prev_dir_</span><span class=p>,</span>
</span><span id=__span-24-54><a id=__codelineno-24-54 name=__codelineno-24-54 href=#__codelineno-24-54></a><span class=gp>... </span>                    <span class=n>nobs</span><span class=o>=</span><span class=n>nobs</span><span class=p>,</span>
</span><span id=__span-24-55><a id=__codelineno-24-55 name=__codelineno-24-55 href=#__codelineno-24-55></a><span class=gp>... </span>                    <span class=n>weighted_avg</span><span class=o>=</span><span class=n>weighted_avg</span><span class=p>,</span>
</span><span id=__span-24-56><a id=__codelineno-24-56 name=__codelineno-24-56 href=#__codelineno-24-56></a><span class=gp>... </span>                    <span class=n>old_wt</span><span class=o>=</span><span class=n>old_wt</span><span class=p>,</span>
</span><span id=__span-24-57><a id=__codelineno-24-57 name=__codelineno-24-57 href=#__codelineno-24-57></a><span class=gp>... </span>                    <span class=n>period</span><span class=o>=</span><span class=n>periods</span><span class=p>[</span><span class=n>k</span><span class=p>],</span>
</span><span id=__span-24-58><a id=__codelineno-24-58 name=__codelineno-24-58 href=#__codelineno-24-58></a><span class=gp>... </span>                    <span class=n>multiplier</span><span class=o>=</span><span class=n>multipliers</span><span class=p>[</span><span class=n>k</span><span class=p>]</span>
</span><span id=__span-24-59><a id=__codelineno-24-59 name=__codelineno-24-59 href=#__codelineno-24-59></a><span class=gp>... </span>                <span class=p>)</span>
</span><span id=__span-24-60><a id=__codelineno-24-60 name=__codelineno-24-60 href=#__codelineno-24-60></a><span class=gp>... </span>
</span><span id=__span-24-61><a id=__codelineno-24-61 name=__codelineno-24-61 href=#__codelineno-24-61></a><span class=gp>... </span>                <span class=n>st_out_state</span> <span class=o>=</span> <span class=n>superfast_supertrend_acc_nb</span><span class=p>(</span><span class=n>st_in_state</span><span class=p>)</span>
</span><span id=__span-24-62><a id=__codelineno-24-62 name=__codelineno-24-62 href=#__codelineno-24-62></a><span class=gp>... </span>
</span><span id=__span-24-63><a id=__codelineno-24-63 name=__codelineno-24-63 href=#__codelineno-24-63></a><span class=gp>... </span>                <span class=n>nobs</span> <span class=o>=</span> <span class=n>st_out_state</span><span class=o>.</span><span class=n>nobs</span>
</span><span id=__span-24-64><a id=__codelineno-24-64 name=__codelineno-24-64 href=#__codelineno-24-64></a><span class=gp>... </span>                <span class=n>weighted_avg</span> <span class=o>=</span> <span class=n>st_out_state</span><span class=o>.</span><span class=n>weighted_avg</span>
</span><span id=__span-24-65><a id=__codelineno-24-65 name=__codelineno-24-65 href=#__codelineno-24-65></a><span class=gp>... </span>                <span class=n>old_wt</span> <span class=o>=</span> <span class=n>st_out_state</span><span class=o>.</span><span class=n>old_wt</span>
</span><span id=__span-24-66><a id=__codelineno-24-66 name=__codelineno-24-66 href=#__codelineno-24-66></a><span class=gp>... </span>                <span class=n>prev_close_</span> <span class=o>=</span> <span class=n>close</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>]</span>
</span><span id=__span-24-67><a id=__codelineno-24-67 name=__codelineno-24-67 href=#__codelineno-24-67></a><span class=gp>... </span>                <span class=n>prev_upper</span> <span class=o>=</span> <span class=n>st_out_state</span><span class=o>.</span><span class=n>upper</span>
</span><span id=__span-24-68><a id=__codelineno-24-68 name=__codelineno-24-68 href=#__codelineno-24-68></a><span class=gp>... </span>                <span class=n>prev_lower</span> <span class=o>=</span> <span class=n>st_out_state</span><span class=o>.</span><span class=n>lower</span>
</span><span id=__span-24-69><a id=__codelineno-24-69 name=__codelineno-24-69 href=#__codelineno-24-69></a><span class=gp>... </span>                <span class=n>prev_dir_</span> <span class=o>=</span> <span class=n>st_out_state</span><span class=o>.</span><span class=n>dir_</span>
</span><span id=__span-24-70><a id=__codelineno-24-70 name=__codelineno-24-70 href=#__codelineno-24-70></a><span class=gp>... </span>                <span class=n>was_entry</span> <span class=o>=</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>st_out_state</span><span class=o>.</span><span class=n>long</span><span class=p>)</span>
</span><span id=__span-24-71><a id=__codelineno-24-71 name=__codelineno-24-71 href=#__codelineno-24-71></a><span class=gp>... </span>                <span class=n>was_exit</span> <span class=o>=</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>st_out_state</span><span class=o>.</span><span class=n>short</span><span class=p>)</span>
</span><span id=__span-24-72><a id=__codelineno-24-72 name=__codelineno-24-72 href=#__codelineno-24-72></a><span class=gp>... </span>
</span><span id=__span-24-73><a id=__codelineno-24-73 name=__codelineno-24-73 href=#__codelineno-24-73></a><span class=gp>... </span>                <span class=k>if</span> <span class=n>is_entry</span> <span class=ow>and</span> <span class=n>position</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-24-74><a id=__codelineno-24-74 name=__codelineno-24-74 href=#__codelineno-24-74></a><span class=gp>... </span>                    <span class=n>size</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>inf</span>
</span><span id=__span-24-75><a id=__codelineno-24-75 name=__codelineno-24-75 href=#__codelineno-24-75></a><span class=gp>... </span>                <span class=k>elif</span> <span class=n>is_exit</span> <span class=ow>and</span> <span class=n>position</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-24-76><a id=__codelineno-24-76 name=__codelineno-24-76 href=#__codelineno-24-76></a><span class=gp>... </span>                    <span class=n>size</span> <span class=o>=</span> <span class=o>-</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span>
</span><span id=__span-24-77><a id=__codelineno-24-77 name=__codelineno-24-77 href=#__codelineno-24-77></a><span class=gp>... </span>                <span class=k>else</span><span class=p>:</span>
</span><span id=__span-24-78><a id=__codelineno-24-78 name=__codelineno-24-78 href=#__codelineno-24-78></a><span class=gp>... </span>                    <span class=n>size</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span>
</span><span id=__span-24-79><a id=__codelineno-24-79 name=__codelineno-24-79 href=#__codelineno-24-79></a><span class=gp>... </span>
</span><span id=__span-24-80><a id=__codelineno-24-80 name=__codelineno-24-80 href=#__codelineno-24-80></a><span class=gp>... </span>                <span class=c1># (8)!</span>
</span><span id=__span-24-81><a id=__codelineno-24-81 name=__codelineno-24-81 href=#__codelineno-24-81></a><span class=gp>... </span>                <span class=n>val_price</span> <span class=o>=</span> <span class=n>close</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>]</span>
</span><span id=__span-24-82><a id=__codelineno-24-82 name=__codelineno-24-82 href=#__codelineno-24-82></a><span class=gp>... </span>                <span class=n>value</span> <span class=o>=</span> <span class=n>cash</span> <span class=o>+</span> <span class=n>position</span> <span class=o>*</span> <span class=n>val_price</span>
</span><span id=__span-24-83><a id=__codelineno-24-83 name=__codelineno-24-83 href=#__codelineno-24-83></a><span class=gp>... </span>                <span class=k>if</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>size</span><span class=p>):</span>
</span><span id=__span-24-84><a id=__codelineno-24-84 name=__codelineno-24-84 href=#__codelineno-24-84></a><span class=gp>... </span>                    <span class=n>exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>ExecState</span><span class=p>(</span>  <span class=c1># (9)!</span>
</span><span id=__span-24-85><a id=__codelineno-24-85 name=__codelineno-24-85 href=#__codelineno-24-85></a><span class=gp>... </span>                        <span class=n>cash</span><span class=o>=</span><span class=n>cash</span><span class=p>,</span>
</span><span id=__span-24-86><a id=__codelineno-24-86 name=__codelineno-24-86 href=#__codelineno-24-86></a><span class=gp>... </span>                        <span class=n>position</span><span class=o>=</span><span class=n>position</span><span class=p>,</span>
</span><span id=__span-24-87><a id=__codelineno-24-87 name=__codelineno-24-87 href=#__codelineno-24-87></a><span class=gp>... </span>                        <span class=n>debt</span><span class=o>=</span><span class=n>debt</span><span class=p>,</span>
</span><span id=__span-24-88><a id=__codelineno-24-88 name=__codelineno-24-88 href=#__codelineno-24-88></a><span class=gp>... </span>                        <span class=n>locked_cash</span><span class=o>=</span><span class=n>locked_cash</span><span class=p>,</span>
</span><span id=__span-24-89><a id=__codelineno-24-89 name=__codelineno-24-89 href=#__codelineno-24-89></a><span class=gp>... </span>                        <span class=n>free_cash</span><span class=o>=</span><span class=n>free_cash</span><span class=p>,</span>
</span><span id=__span-24-90><a id=__codelineno-24-90 name=__codelineno-24-90 href=#__codelineno-24-90></a><span class=gp>... </span>                        <span class=n>val_price</span><span class=o>=</span><span class=n>val_price</span><span class=p>,</span>
</span><span id=__span-24-91><a id=__codelineno-24-91 name=__codelineno-24-91 href=#__codelineno-24-91></a><span class=gp>... </span>                        <span class=n>value</span><span class=o>=</span><span class=n>value</span>
</span><span id=__span-24-92><a id=__codelineno-24-92 name=__codelineno-24-92 href=#__codelineno-24-92></a><span class=gp>... </span>                    <span class=p>)</span>
</span><span id=__span-24-93><a id=__codelineno-24-93 name=__codelineno-24-93 href=#__codelineno-24-93></a><span class=gp>... </span>                    <span class=n>price_area</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>PriceArea</span><span class=p>(</span>  <span class=c1># (10)!</span>
</span><span id=__span-24-94><a id=__codelineno-24-94 name=__codelineno-24-94 href=#__codelineno-24-94></a><span class=gp>... </span>                        <span class=nb>open</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-24-95><a id=__codelineno-24-95 name=__codelineno-24-95 href=#__codelineno-24-95></a><span class=gp>... </span>                        <span class=n>high</span><span class=o>=</span><span class=n>high</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>],</span>
</span><span id=__span-24-96><a id=__codelineno-24-96 name=__codelineno-24-96 href=#__codelineno-24-96></a><span class=gp>... </span>                        <span class=n>low</span><span class=o>=</span><span class=n>low</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>],</span>
</span><span id=__span-24-97><a id=__codelineno-24-97 name=__codelineno-24-97 href=#__codelineno-24-97></a><span class=gp>... </span>                        <span class=n>close</span><span class=o>=</span><span class=n>close</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>]</span>
</span><span id=__span-24-98><a id=__codelineno-24-98 name=__codelineno-24-98 href=#__codelineno-24-98></a><span class=gp>... </span>                    <span class=p>)</span>
</span><span id=__span-24-99><a id=__codelineno-24-99 name=__codelineno-24-99 href=#__codelineno-24-99></a><span class=gp>... </span>                    <span class=n>order</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nb</span><span class=p>(</span>  <span class=c1># (11)!</span>
</span><span id=__span-24-100><a id=__codelineno-24-100 name=__codelineno-24-100 href=#__codelineno-24-100></a><span class=gp>... </span>                        <span class=n>size</span><span class=o>=</span><span class=n>size</span><span class=p>,</span> 
</span><span id=__span-24-101><a id=__codelineno-24-101 name=__codelineno-24-101 href=#__codelineno-24-101></a><span class=gp>... </span>                        <span class=n>direction</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>Direction</span><span class=o>.</span><span class=n>LongOnly</span><span class=p>,</span>
</span><span id=__span-24-102><a id=__codelineno-24-102 name=__codelineno-24-102 href=#__codelineno-24-102></a><span class=gp>... </span>                        <span class=n>fees</span><span class=o>=</span><span class=mf>0.001</span>
</span><span id=__span-24-103><a id=__codelineno-24-103 name=__codelineno-24-103 href=#__codelineno-24-103></a><span class=gp>... </span>                    <span class=p>)</span>
</span><span id=__span-24-104><a id=__codelineno-24-104 name=__codelineno-24-104 href=#__codelineno-24-104></a><span class=gp>... </span>                    <span class=n>_</span><span class=p>,</span> <span class=n>new_exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>execute_order_nb</span><span class=p>(</span>  <span class=c1># (12)!</span>
</span><span id=__span-24-105><a id=__codelineno-24-105 name=__codelineno-24-105 href=#__codelineno-24-105></a><span class=gp>... </span>                        <span class=n>exec_state</span><span class=p>,</span> <span class=n>order</span><span class=p>,</span> <span class=n>price_area</span><span class=p>)</span>
</span><span id=__span-24-106><a id=__codelineno-24-106 name=__codelineno-24-106 href=#__codelineno-24-106></a><span class=gp>... </span>                    <span class=n>cash</span><span class=p>,</span> <span class=n>position</span><span class=p>,</span> <span class=n>debt</span><span class=p>,</span> <span class=n>locked_cash</span><span class=p>,</span> <span class=n>free_cash</span><span class=p>,</span> <span class=n>val_price</span><span class=p>,</span> <span class=n>value</span> <span class=o>=</span> <span class=n>new_exec_state</span>
</span><span id=__span-24-107><a id=__codelineno-24-107 name=__codelineno-24-107 href=#__codelineno-24-107></a><span class=gp>... </span>
</span><span id=__span-24-108><a id=__codelineno-24-108 name=__codelineno-24-108 href=#__codelineno-24-108></a><span class=gp>... </span>                <span class=n>value</span> <span class=o>=</span> <span class=n>cash</span> <span class=o>+</span> <span class=n>position</span> <span class=o>*</span> <span class=n>val_price</span>
</span><span id=__span-24-109><a id=__codelineno-24-109 name=__codelineno-24-109 href=#__codelineno-24-109></a><span class=gp>... </span>                <span class=n>return_</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>ret_nb</span><span class=o>.</span><span class=n>get_return_nb</span><span class=p>(</span><span class=n>prev_value</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>  <span class=c1># (13)!</span>
</span><span id=__span-24-110><a id=__codelineno-24-110 name=__codelineno-24-110 href=#__codelineno-24-110></a><span class=gp>... </span>                <span class=n>prev_value</span> <span class=o>=</span> <span class=n>value</span>
</span><span id=__span-24-111><a id=__codelineno-24-111 name=__codelineno-24-111 href=#__codelineno-24-111></a><span class=gp>... </span>
</span><span id=__span-24-112><a id=__codelineno-24-112 name=__codelineno-24-112 href=#__codelineno-24-112></a><span class=gp>... </span>                <span class=c1># (14)!</span>
</span><span id=__span-24-113><a id=__codelineno-24-113 name=__codelineno-24-113 href=#__codelineno-24-113></a><span class=gp>... </span>                <span class=n>sharpe_in_state</span> <span class=o>=</span> <span class=n>RollSharpeAIS</span><span class=p>(</span>
</span><span id=__span-24-114><a id=__codelineno-24-114 name=__codelineno-24-114 href=#__codelineno-24-114></a><span class=gp>... </span>                    <span class=n>i</span><span class=o>=</span><span class=n>i</span><span class=p>,</span>
</span><span id=__span-24-115><a id=__codelineno-24-115 name=__codelineno-24-115 href=#__codelineno-24-115></a><span class=gp>... </span>                    <span class=n>ret</span><span class=o>=</span><span class=n>return_</span><span class=p>,</span>
</span><span id=__span-24-116><a id=__codelineno-24-116 name=__codelineno-24-116 href=#__codelineno-24-116></a><span class=gp>... </span>                    <span class=n>pre_window_ret</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-24-117><a id=__codelineno-24-117 name=__codelineno-24-117 href=#__codelineno-24-117></a><span class=gp>... </span>                    <span class=n>cumsum</span><span class=o>=</span><span class=n>cumsum</span><span class=p>,</span>
</span><span id=__span-24-118><a id=__codelineno-24-118 name=__codelineno-24-118 href=#__codelineno-24-118></a><span class=gp>... </span>                    <span class=n>cumsum_sq</span><span class=o>=</span><span class=n>cumsum_sq</span><span class=p>,</span>
</span><span id=__span-24-119><a id=__codelineno-24-119 name=__codelineno-24-119 href=#__codelineno-24-119></a><span class=gp>... </span>                    <span class=n>nancnt</span><span class=o>=</span><span class=n>nancnt</span><span class=p>,</span>
</span><span id=__span-24-120><a id=__codelineno-24-120 name=__codelineno-24-120 href=#__codelineno-24-120></a><span class=gp>... </span>                    <span class=n>window</span><span class=o>=</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span>
</span><span id=__span-24-121><a id=__codelineno-24-121 name=__codelineno-24-121 href=#__codelineno-24-121></a><span class=gp>... </span>                    <span class=n>minp</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span><span id=__span-24-122><a id=__codelineno-24-122 name=__codelineno-24-122 href=#__codelineno-24-122></a><span class=gp>... </span>                    <span class=n>ddof</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span><span id=__span-24-123><a id=__codelineno-24-123 name=__codelineno-24-123 href=#__codelineno-24-123></a><span class=gp>... </span>                    <span class=n>ann_factor</span><span class=o>=</span><span class=n>ann_factor</span>
</span><span id=__span-24-124><a id=__codelineno-24-124 name=__codelineno-24-124 href=#__codelineno-24-124></a><span class=gp>... </span>                <span class=p>)</span>
</span><span id=__span-24-125><a id=__codelineno-24-125 name=__codelineno-24-125 href=#__codelineno-24-125></a><span class=gp>... </span>                <span class=n>sharpe_out_state</span> <span class=o>=</span> <span class=n>rolling_sharpe_acc_nb</span><span class=p>(</span><span class=n>sharpe_in_state</span><span class=p>)</span>
</span><span id=__span-24-126><a id=__codelineno-24-126 name=__codelineno-24-126 href=#__codelineno-24-126></a><span class=gp>... </span>                <span class=n>cumsum</span> <span class=o>=</span> <span class=n>sharpe_out_state</span><span class=o>.</span><span class=n>cumsum</span>
</span><span id=__span-24-127><a id=__codelineno-24-127 name=__codelineno-24-127 href=#__codelineno-24-127></a><span class=gp>... </span>                <span class=n>cumsum_sq</span> <span class=o>=</span> <span class=n>sharpe_out_state</span><span class=o>.</span><span class=n>cumsum_sq</span>
</span><span id=__span-24-128><a id=__codelineno-24-128 name=__codelineno-24-128 href=#__codelineno-24-128></a><span class=gp>... </span>                <span class=n>nancnt</span> <span class=o>=</span> <span class=n>sharpe_out_state</span><span class=o>.</span><span class=n>nancnt</span>
</span><span id=__span-24-129><a id=__codelineno-24-129 name=__codelineno-24-129 href=#__codelineno-24-129></a><span class=gp>... </span>                <span class=n>sharpe</span> <span class=o>=</span> <span class=n>sharpe_out_state</span><span class=o>.</span><span class=n>value</span>
</span><span id=__span-24-130><a id=__codelineno-24-130 name=__codelineno-24-130 href=#__codelineno-24-130></a><span class=gp>... </span>
</span><span id=__span-24-131><a id=__codelineno-24-131 name=__codelineno-24-131 href=#__codelineno-24-131></a><span class=gp>... </span>            <span class=n>out</span><span class=p>[</span><span class=n>k</span> <span class=o>*</span> <span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>sharpe</span>  <span class=c1># (15)!</span>
</span><span id=__span-24-132><a id=__codelineno-24-132 name=__codelineno-24-132 href=#__codelineno-24-132></a><span class=gp>... </span>        
</span><span id=__span-24-133><a id=__codelineno-24-133 name=__codelineno-24-133 href=#__codelineno-24-133></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>out</span>
</span></code></pre></div> <ol> <li>The number of Sharpe ratios matches the number of parameter combinations times the number of columns.</li> <li>Iterate over each parameter combination (period and multiplier).</li> <li>Iterate over each column (asset).</li> <li>Define the initial values for the SuperTrend and Sharpe accumulators.</li> <li>Set the initial state of the backtesting environment, such as the initial cash balance.</li> <li>Iterate over each row (time step).</li> <li>Compute the SuperTrend values at this time step, generate a signal from them, and convert the signal into an order size.</li> <li>Build and execute an order, then update the return at the end of this time step.</li> <li>Pack the current environment state into an instance of <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.ExecState>ExecState</a>.</li> <li>Pack the current price bounds into an instance of <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.PriceArea>PriceArea</a>.</li> <li>Get an <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.Order>Order</a> instance using <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/core/#vectorbtpro.portfolio.nb.core.order_nb>order_nb</a>.</li> <li>Execute the order using <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/core/#vectorbtpro.portfolio.nb.core.execute_order_nb>execute_order_nb</a>, which returns an <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.OrderResult>OrderResult</a> and the updated backtesting environment as an <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.AccountState>AccountState</a>.</li> <li>Return is calculated as the percentage change from the previous value to the current value.</li> <li>Calculate the Sharpe ratio based on the updated return.</li> <li>Store the Sharpe ratio from the latest time step in the output array.</li> </ol> <p>We have just built our own simulator, optimized for one specific task. Unsurprisingly, its speed is incredible! <img alt=🤯 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f92f.svg title=:exploding_head:></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>chunked_raw_pipeline_nb</span> <span class=o>=</span> <span class=n>nb_chunked</span><span class=p>(</span><span class=n>raw_pipeline_nb</span><span class=p>)</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=gp>&gt;&gt;&gt; </span><span class=o>%%</span><span class=n>timeit</span>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>chunked_raw_pipeline_nb</span><span class=p>(</span>
</span><span id=__span-25-5><a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a><span class=gp>... </span>    <span class=n>high</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-25-6><a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a><span class=gp>... </span>    <span class=n>low</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-25-7><a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a><span class=gp>... </span>    <span class=n>close</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-25-8><a id=__codelineno-25-8 name=__codelineno-25-8 href=#__codelineno-25-8></a><span class=gp>... </span>    <span class=n>periods</span><span class=o>=</span><span class=n>period_product</span><span class=p>,</span> 
</span><span id=__span-25-9><a id=__codelineno-25-9 name=__codelineno-25-9 href=#__codelineno-25-9></a><span class=gp>... </span>    <span class=n>multipliers</span><span class=o>=</span><span class=n>multiplier_product</span><span class=p>,</span>
</span><span id=__span-25-10><a id=__codelineno-25-10 name=__codelineno-25-10 href=#__codelineno-25-10></a><span class=gp>... </span>    <span class=n>ann_factor</span><span class=o>=</span><span class=n>ann_factor</span><span class=p>,</span>
</span><span id=__span-25-11><a id=__codelineno-25-11 name=__codelineno-25-11 href=#__codelineno-25-11></a><span class=gp>... </span>    <span class=n>_merge_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>input_columns</span><span class=o>=</span><span class=n>close</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span>
</span><span id=__span-25-12><a id=__codelineno-25-12 name=__codelineno-25-12 href=#__codelineno-25-12></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-25-13><a id=__codelineno-25-13 name=__codelineno-25-13 href=#__codelineno-25-13></a><span class=go>225 ms ± 464 µs per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</span><span id=__span-25-14><a id=__codelineno-25-14 name=__codelineno-25-14 href=#__codelineno-25-14></a>
</span><span id=__span-25-15><a id=__codelineno-25-15 name=__codelineno-25-15 href=#__codelineno-25-15></a><span class=gp>&gt;&gt;&gt; </span><span class=o>%%</span><span class=n>timeit</span>
</span><span id=__span-25-16><a id=__codelineno-25-16 name=__codelineno-25-16 href=#__codelineno-25-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>chunked_raw_pipeline_nb</span><span class=p>(</span>
</span><span id=__span-25-17><a id=__codelineno-25-17 name=__codelineno-25-17 href=#__codelineno-25-17></a><span class=gp>... </span>    <span class=n>high</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-25-18><a id=__codelineno-25-18 name=__codelineno-25-18 href=#__codelineno-25-18></a><span class=gp>... </span>    <span class=n>low</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-25-19><a id=__codelineno-25-19 name=__codelineno-25-19 href=#__codelineno-25-19></a><span class=gp>... </span>    <span class=n>close</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-25-20><a id=__codelineno-25-20 name=__codelineno-25-20 href=#__codelineno-25-20></a><span class=gp>... </span>    <span class=n>periods</span><span class=o>=</span><span class=n>period_product</span><span class=p>,</span> 
</span><span id=__span-25-21><a id=__codelineno-25-21 name=__codelineno-25-21 href=#__codelineno-25-21></a><span class=gp>... </span>    <span class=n>multipliers</span><span class=o>=</span><span class=n>multiplier_product</span><span class=p>,</span>
</span><span id=__span-25-22><a id=__codelineno-25-22 name=__codelineno-25-22 href=#__codelineno-25-22></a><span class=gp>... </span>    <span class=n>ann_factor</span><span class=o>=</span><span class=n>ann_factor</span><span class=p>,</span>
</span><span id=__span-25-23><a id=__codelineno-25-23 name=__codelineno-25-23 href=#__codelineno-25-23></a><span class=gp>... </span>    <span class=n>_execute_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>engine</span><span class=o>=</span><span class=s2>&quot;dask&quot;</span><span class=p>),</span>
</span><span id=__span-25-24><a id=__codelineno-25-24 name=__codelineno-25-24 href=#__codelineno-25-24></a><span class=gp>... </span>    <span class=n>_merge_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>input_columns</span><span class=o>=</span><span class=n>close</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span>
</span><span id=__span-25-25><a id=__codelineno-25-25 name=__codelineno-25-25 href=#__codelineno-25-25></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-25-26><a id=__codelineno-25-26 name=__codelineno-25-26 href=#__codelineno-25-26></a><span class=go>54 ms ± 1.13 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)</span>
</span></code></pre></div> <p>The reason for the 20x jump in performance compared to the previous pipeline, even though both process the data in a streaming manner, is that VBT must prepare contexts for all callbacks (even those that do nothing by default) and calculate all possible metrics that the user might need. Additionally, Numba does not perform well with complex relationships between objects that are shared or passed between multiple functions, making it quite challenging to design an efficient order function.</p> <p>The best part of the pipeline above is its outstanding memory efficiency. For example, you can roll 100 one-year periods over the entire dataset (a total of 1,752,000 input data points), backtest the full parameter grid on each period, and create an animated GIF of the entire process—all in just 15 seconds!</p> <p>First, let's split the full period into sub-periods:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>range_len</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s1>&#39;365d&#39;</span><span class=p>)</span> <span class=o>/</span> <span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s1>&#39;1h&#39;</span><span class=p>))</span>  <span class=c1># (1)!</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>splitter</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Splitter</span><span class=o>.</span><span class=n>from_n_rolling</span><span class=p>(</span>  <span class=c1># (2)!</span>
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a><span class=gp>... </span>    <span class=n>high</span><span class=o>.</span><span class=n>index</span><span class=p>,</span> 
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a><span class=gp>... </span>    <span class=n>n</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> 
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a><span class=gp>... </span>    <span class=n>length</span><span class=o>=</span><span class=n>range_len</span>
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-26-7><a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a>
</span><span id=__span-26-8><a id=__codelineno-26-8 name=__codelineno-26-8 href=#__codelineno-26-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>roll_high</span> <span class=o>=</span> <span class=n>splitter</span><span class=o>.</span><span class=n>take</span><span class=p>(</span><span class=n>high</span><span class=p>,</span> <span class=n>into</span><span class=o>=</span><span class=s2>&quot;reset_stacked&quot;</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-26-9><a id=__codelineno-26-9 name=__codelineno-26-9 href=#__codelineno-26-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>roll_low</span> <span class=o>=</span> <span class=n>splitter</span><span class=o>.</span><span class=n>take</span><span class=p>(</span><span class=n>low</span><span class=p>,</span> <span class=n>into</span><span class=o>=</span><span class=s2>&quot;reset_stacked&quot;</span><span class=p>)</span>
</span><span id=__span-26-10><a id=__codelineno-26-10 name=__codelineno-26-10 href=#__codelineno-26-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>roll_close</span> <span class=o>=</span> <span class=n>splitter</span><span class=o>.</span><span class=n>take</span><span class=p>(</span><span class=n>close</span><span class=p>,</span> <span class=n>into</span><span class=o>=</span><span class=s2>&quot;reset_stacked&quot;</span><span class=p>)</span>
</span><span id=__span-26-11><a id=__codelineno-26-11 name=__codelineno-26-11 href=#__codelineno-26-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>roll_close</span><span class=o>.</span><span class=n>columns</span>
</span><span id=__span-26-12><a id=__codelineno-26-12 name=__codelineno-26-12 href=#__codelineno-26-12></a><span class=go>MultiIndex([( 0, &#39;BTCUSDT&#39;),</span>
</span><span id=__span-26-13><a id=__codelineno-26-13 name=__codelineno-26-13 href=#__codelineno-26-13></a><span class=go>            ( 0, &#39;ETHUSDT&#39;),</span>
</span><span id=__span-26-14><a id=__codelineno-26-14 name=__codelineno-26-14 href=#__codelineno-26-14></a><span class=go>            ( 1, &#39;BTCUSDT&#39;),</span>
</span><span id=__span-26-15><a id=__codelineno-26-15 name=__codelineno-26-15 href=#__codelineno-26-15></a><span class=go>            ( 1, &#39;ETHUSDT&#39;),</span>
</span><span id=__span-26-16><a id=__codelineno-26-16 name=__codelineno-26-16 href=#__codelineno-26-16></a><span class=go>            ( 2, &#39;BTCUSDT&#39;),</span>
</span><span id=__span-26-17><a id=__codelineno-26-17 name=__codelineno-26-17 href=#__codelineno-26-17></a><span class=go>            ...</span>
</span><span id=__span-26-18><a id=__codelineno-26-18 name=__codelineno-26-18 href=#__codelineno-26-18></a><span class=go>            (97, &#39;ETHUSDT&#39;),</span>
</span><span id=__span-26-19><a id=__codelineno-26-19 name=__codelineno-26-19 href=#__codelineno-26-19></a><span class=go>            (98, &#39;BTCUSDT&#39;),</span>
</span><span id=__span-26-20><a id=__codelineno-26-20 name=__codelineno-26-20 href=#__codelineno-26-20></a><span class=go>            (98, &#39;ETHUSDT&#39;),</span>
</span><span id=__span-26-21><a id=__codelineno-26-21 name=__codelineno-26-21 href=#__codelineno-26-21></a><span class=go>            (99, &#39;BTCUSDT&#39;),</span>
</span><span id=__span-26-22><a id=__codelineno-26-22 name=__codelineno-26-22 href=#__codelineno-26-22></a><span class=go>            (99, &#39;ETHUSDT&#39;)],</span>
</span><span id=__span-26-23><a id=__codelineno-26-23 name=__codelineno-26-23 href=#__codelineno-26-23></a><span class=go>           names=[&#39;split&#39;, &#39;symbol&#39;], length=200)</span>
</span><span id=__span-26-24><a id=__codelineno-26-24 name=__codelineno-26-24 href=#__codelineno-26-24></a>
</span><span id=__span-26-25><a id=__codelineno-26-25 name=__codelineno-26-25 href=#__codelineno-26-25></a><span class=gp>&gt;&gt;&gt; </span><span class=n>range_indexes</span> <span class=o>=</span> <span class=n>splitter</span><span class=o>.</span><span class=n>take</span><span class=p>(</span><span class=n>high</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>  <span class=c1># (4)!</span>
</span><span id=__span-26-26><a id=__codelineno-26-26 name=__codelineno-26-26 href=#__codelineno-26-26></a><span class=gp>&gt;&gt;&gt; </span><span class=n>range_indexes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span><span id=__span-26-27><a id=__codelineno-26-27 name=__codelineno-26-27 href=#__codelineno-26-27></a><span class=go>DatetimeIndex([&#39;2020-01-01 00:00:00+00:00&#39;, &#39;2020-01-01 01:00:00+00:00&#39;,</span>
</span><span id=__span-26-28><a id=__codelineno-26-28 name=__codelineno-26-28 href=#__codelineno-26-28></a><span class=go>               &#39;2020-01-01 02:00:00+00:00&#39;, &#39;2020-01-01 03:00:00+00:00&#39;,</span>
</span><span id=__span-26-29><a id=__codelineno-26-29 name=__codelineno-26-29 href=#__codelineno-26-29></a><span class=go>               &#39;2020-01-01 04:00:00+00:00&#39;, &#39;2020-01-01 05:00:00+00:00&#39;,</span>
</span><span id=__span-26-30><a id=__codelineno-26-30 name=__codelineno-26-30 href=#__codelineno-26-30></a><span class=go>               ...</span>
</span><span id=__span-26-31><a id=__codelineno-26-31 name=__codelineno-26-31 href=#__codelineno-26-31></a><span class=go>               &#39;2020-12-31 12:00:00+00:00&#39;, &#39;2020-12-31 13:00:00+00:00&#39;,</span>
</span><span id=__span-26-32><a id=__codelineno-26-32 name=__codelineno-26-32 href=#__codelineno-26-32></a><span class=go>               &#39;2020-12-31 14:00:00+00:00&#39;, &#39;2020-12-31 15:00:00+00:00&#39;,</span>
</span><span id=__span-26-33><a id=__codelineno-26-33 name=__codelineno-26-33 href=#__codelineno-26-33></a><span class=go>               &#39;2020-12-31 16:00:00+00:00&#39;, &#39;2020-12-31 17:00:00+00:00&#39;],</span>
</span><span id=__span-26-34><a id=__codelineno-26-34 name=__codelineno-26-34 href=#__codelineno-26-34></a><span class=go>              dtype=&#39;datetime64[ns, UTC]&#39;, name=&#39;split_0&#39;, length=8760, freq=None)</span>
</span></code></pre></div> <ol> <li>Get the number of hours in a year.</li> <li>Create an instance of <a href=https://vectorbt.pro/pvt_41531c19/api/generic/splitting/base/#vectorbtpro.generic.splitting.base.Splitter>Splitter</a>.</li> <li>Split the DataFrame into chunks and stack those chunks into a single DataFrame by resetting its index. We reset the index to avoid producing many NaNs.</li> <li>If you need the index of each split, split it the same way as above, but instead of stacking, store it in a Series indexed by the split label.</li> </ol> <p>Next, generate the Sharpe values:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sharpe_ratios</span> <span class=o>=</span> <span class=n>chunked_raw_pipeline_nb</span><span class=p>(</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=gp>... </span>    <span class=n>roll_high</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=gp>... </span>    <span class=n>roll_low</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=gp>... </span>    <span class=n>roll_close</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=gp>... </span>    <span class=n>periods</span><span class=o>=</span><span class=n>period_product</span><span class=p>,</span> 
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a><span class=gp>... </span>    <span class=n>multipliers</span><span class=o>=</span><span class=n>multiplier_product</span><span class=p>,</span>
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a><span class=gp>... </span>    <span class=n>ann_factor</span><span class=o>=</span><span class=n>ann_factor</span><span class=p>,</span>
</span><span id=__span-27-8><a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a><span class=gp>... </span>    <span class=n>_execute_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>engine</span><span class=o>=</span><span class=s2>&quot;dask&quot;</span><span class=p>),</span>
</span><span id=__span-27-9><a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a><span class=gp>... </span>    <span class=n>_merge_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>input_columns</span><span class=o>=</span><span class=n>roll_close</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-27-10><a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-27-11><a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a>
</span><span id=__span-27-12><a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sharpe_ratios</span>
</span><span id=__span-27-13><a id=__codelineno-27-13 name=__codelineno-27-13 href=#__codelineno-27-13></a><span class=go>st_period  st_multiplier  split  symbol </span>
</span><span id=__span-27-14><a id=__codelineno-27-14 name=__codelineno-27-14 href=#__codelineno-27-14></a><span class=go>4          2.0            0      BTCUSDT    1.751331</span>
</span><span id=__span-27-15><a id=__codelineno-27-15 name=__codelineno-27-15 href=#__codelineno-27-15></a><span class=go>                                 ETHUSDT    2.479750</span>
</span><span id=__span-27-16><a id=__codelineno-27-16 name=__codelineno-27-16 href=#__codelineno-27-16></a><span class=go>                          1      BTCUSDT    1.847095</span>
</span><span id=__span-27-17><a id=__codelineno-27-17 name=__codelineno-27-17 href=#__codelineno-27-17></a><span class=go>                                 ETHUSDT    2.736193</span>
</span><span id=__span-27-18><a id=__codelineno-27-18 name=__codelineno-27-18 href=#__codelineno-27-18></a><span class=go>                          2      BTCUSDT    1.739149</span>
</span><span id=__span-27-19><a id=__codelineno-27-19 name=__codelineno-27-19 href=#__codelineno-27-19></a><span class=go>                                                 ...</span>
</span><span id=__span-27-20><a id=__codelineno-27-20 name=__codelineno-27-20 href=#__codelineno-27-20></a><span class=go>19         4.0            97     ETHUSDT    1.503001</span>
</span><span id=__span-27-21><a id=__codelineno-27-21 name=__codelineno-27-21 href=#__codelineno-27-21></a><span class=go>                          98     BTCUSDT    0.954932</span>
</span><span id=__span-27-22><a id=__codelineno-27-22 name=__codelineno-27-22 href=#__codelineno-27-22></a><span class=go>                                 ETHUSDT    1.204134</span>
</span><span id=__span-27-23><a id=__codelineno-27-23 name=__codelineno-27-23 href=#__codelineno-27-23></a><span class=go>                          99     BTCUSDT    0.818209</span>
</span><span id=__span-27-24><a id=__codelineno-27-24 name=__codelineno-27-24 href=#__codelineno-27-24></a><span class=go>                                 ETHUSDT    1.191223</span>
</span><span id=__span-27-25><a id=__codelineno-27-25 name=__codelineno-27-25 href=#__codelineno-27-25></a><span class=go>Length: 67200, dtype: float64</span>
</span></code></pre></div> <ol> <li>Make sure to pass the correct columns.</li> </ol> <p>That's 67,200 backtests in one second <img alt=💨 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f4a8.svg title=:dash:></p> <p>When creating a heatmap for each sub-period, we use the Sharpe ratio for holding during that period as the midpoint of the color scale. Any blue-tinted point indicates that the parameter combination performed better than the market, while a red-tinted point means it performed worse. To do this, we need the Sharpe ratio for holding:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf_hold</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_holding</span><span class=p>(</span><span class=n>roll_close</span><span class=p>,</span> <span class=n>freq</span><span class=o>=</span><span class=s1>&#39;1h&#39;</span><span class=p>)</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sharpe_ratios_hold</span> <span class=o>=</span> <span class=n>pf_hold</span><span class=o>.</span><span class=n>sharpe_ratio</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sharpe_ratios_hold</span>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=go>split  symbol </span>
</span><span id=__span-28-6><a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a><span class=go>0      BTCUSDT    2.229122</span>
</span><span id=__span-28-7><a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a><span class=go>       ETHUSDT    2.370132</span>
</span><span id=__span-28-8><a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a><span class=go>1      BTCUSDT    2.298050</span>
</span><span id=__span-28-9><a id=__codelineno-28-9 name=__codelineno-28-9 href=#__codelineno-28-9></a><span class=go>       ETHUSDT    2.611722</span>
</span><span id=__span-28-10><a id=__codelineno-28-10 name=__codelineno-28-10 href=#__codelineno-28-10></a><span class=go>2      BTCUSDT    2.351417</span>
</span><span id=__span-28-11><a id=__codelineno-28-11 name=__codelineno-28-11 href=#__codelineno-28-11></a><span class=go>                    ...   </span>
</span><span id=__span-28-12><a id=__codelineno-28-12 name=__codelineno-28-12 href=#__codelineno-28-12></a><span class=go>97     ETHUSDT    2.315863</span>
</span><span id=__span-28-13><a id=__codelineno-28-13 name=__codelineno-28-13 href=#__codelineno-28-13></a><span class=go>98     BTCUSDT    1.124489</span>
</span><span id=__span-28-14><a id=__codelineno-28-14 name=__codelineno-28-14 href=#__codelineno-28-14></a><span class=go>       ETHUSDT    2.114297</span>
</span><span id=__span-28-15><a id=__codelineno-28-15 name=__codelineno-28-15 href=#__codelineno-28-15></a><span class=go>99     BTCUSDT    0.975638</span>
</span><span id=__span-28-16><a id=__codelineno-28-16 name=__codelineno-28-16 href=#__codelineno-28-16></a><span class=go>       ETHUSDT    2.008839</span>
</span><span id=__span-28-17><a id=__codelineno-28-17 name=__codelineno-28-17 href=#__codelineno-28-17></a><span class=go>Name: sharpe_ratio, Length: 200, dtype: float64</span>
</span></code></pre></div> <div class="admonition info"> <p class=admonition-title>Info</p> <p>Notice that this multi-index lists no parameter combinations: the performance of holding does not depend on our indicator in any way.</p> </div> <p>Next, let's create a function that plots a sub-period:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>plot_subperiod_sharpe</span><span class=p>(</span><span class=n>index</span><span class=p>,</span> 
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a><span class=gp>... </span>                          <span class=n>sharpe_ratios</span><span class=p>,</span> 
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a><span class=gp>... </span>                          <span class=n>sharpe_ratios_hold</span><span class=p>,</span> 
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a><span class=gp>... </span>                          <span class=n>range_indexes</span><span class=p>,</span> 
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a><span class=gp>... </span>                          <span class=n>symbol</span><span class=p>):</span>
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a><span class=gp>... </span>    <span class=n>split</span> <span class=o>=</span> <span class=n>index</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a><span class=gp>... </span>    <span class=n>sharpe_ratios</span> <span class=o>=</span> <span class=n>sharpe_ratios</span><span class=o>.</span><span class=n>xs</span><span class=p>(</span>  <span class=c1># (1)!</span>
</span><span id=__span-29-8><a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a><span class=gp>... </span>        <span class=n>symbol</span><span class=p>,</span> 
</span><span id=__span-29-9><a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a><span class=gp>... </span>        <span class=n>level</span><span class=o>=</span><span class=s1>&#39;symbol&#39;</span><span class=p>,</span> 
</span><span id=__span-29-10><a id=__codelineno-29-10 name=__codelineno-29-10 href=#__codelineno-29-10></a><span class=gp>... </span>        <span class=n>drop_level</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-29-11><a id=__codelineno-29-11 name=__codelineno-29-11 href=#__codelineno-29-11></a><span class=gp>... </span>    <span class=n>sharpe_ratios</span> <span class=o>=</span> <span class=n>sharpe_ratios</span><span class=o>.</span><span class=n>xs</span><span class=p>(</span>  <span class=c1># (2)!</span>
</span><span id=__span-29-12><a id=__codelineno-29-12 name=__codelineno-29-12 href=#__codelineno-29-12></a><span class=gp>... </span>        <span class=n>split</span><span class=p>,</span> 
</span><span id=__span-29-13><a id=__codelineno-29-13 name=__codelineno-29-13 href=#__codelineno-29-13></a><span class=gp>... </span>        <span class=n>level</span><span class=o>=</span><span class=s1>&#39;split&#39;</span><span class=p>,</span> 
</span><span id=__span-29-14><a id=__codelineno-29-14 name=__codelineno-29-14 href=#__codelineno-29-14></a><span class=gp>... </span>        <span class=n>drop_level</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-29-15><a id=__codelineno-29-15 name=__codelineno-29-15 href=#__codelineno-29-15></a><span class=gp>... </span>    <span class=n>start_date</span> <span class=o>=</span> <span class=n>range_indexes</span><span class=p>[</span><span class=n>split</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>
</span><span id=__span-29-16><a id=__codelineno-29-16 name=__codelineno-29-16 href=#__codelineno-29-16></a><span class=gp>... </span>    <span class=n>end_date</span> <span class=o>=</span> <span class=n>range_indexes</span><span class=p>[</span><span class=n>split</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-29-17><a id=__codelineno-29-17 name=__codelineno-29-17 href=#__codelineno-29-17></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>sharpe_ratios</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>heatmap</span><span class=p>(</span>
</span><span id=__span-29-18><a id=__codelineno-29-18 name=__codelineno-29-18 href=#__codelineno-29-18></a><span class=gp>... </span>        <span class=n>x_level</span><span class=o>=</span><span class=s1>&#39;st_period&#39;</span><span class=p>,</span> 
</span><span id=__span-29-19><a id=__codelineno-29-19 name=__codelineno-29-19 href=#__codelineno-29-19></a><span class=gp>... </span>        <span class=n>y_level</span><span class=o>=</span><span class=s1>&#39;st_multiplier&#39;</span><span class=p>,</span>
</span><span id=__span-29-20><a id=__codelineno-29-20 name=__codelineno-29-20 href=#__codelineno-29-20></a><span class=gp>... </span>        <span class=n>title</span><span class=o>=</span><span class=s2>&quot;</span><span class=si>{}</span><span class=s2> - </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>  <span class=c1># (3)!</span>
</span><span id=__span-29-21><a id=__codelineno-29-21 name=__codelineno-29-21 href=#__codelineno-29-21></a><span class=gp>... </span>            <span class=n>start_date</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&quot;</span><span class=si>%d</span><span class=s2> %b, %Y %H:%M:%S&quot;</span><span class=p>),</span>
</span><span id=__span-29-22><a id=__codelineno-29-22 name=__codelineno-29-22 href=#__codelineno-29-22></a><span class=gp>... </span>            <span class=n>end_date</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&quot;</span><span class=si>%d</span><span class=s2> %b, %Y %H:%M:%S&quot;</span><span class=p>)</span>
</span><span id=__span-29-23><a id=__codelineno-29-23 name=__codelineno-29-23 href=#__codelineno-29-23></a><span class=gp>... </span>        <span class=p>),</span>
</span><span id=__span-29-24><a id=__codelineno-29-24 name=__codelineno-29-24 href=#__codelineno-29-24></a><span class=gp>... </span>        <span class=n>trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>  <span class=c1># (4)!</span>
</span><span id=__span-29-25><a id=__codelineno-29-25 name=__codelineno-29-25 href=#__codelineno-29-25></a><span class=gp>... </span>            <span class=n>zmin</span><span class=o>=</span><span class=n>sharpe_ratios</span><span class=o>.</span><span class=n>min</span><span class=p>(),</span>
</span><span id=__span-29-26><a id=__codelineno-29-26 name=__codelineno-29-26 href=#__codelineno-29-26></a><span class=gp>... </span>            <span class=n>zmid</span><span class=o>=</span><span class=n>sharpe_ratios_hold</span><span class=p>[(</span><span class=n>split</span><span class=p>,</span> <span class=n>symbol</span><span class=p>)],</span>
</span><span id=__span-29-27><a id=__codelineno-29-27 name=__codelineno-29-27 href=#__codelineno-29-27></a><span class=gp>... </span>            <span class=n>zmax</span><span class=o>=</span><span class=n>sharpe_ratios</span><span class=o>.</span><span class=n>max</span><span class=p>(),</span>
</span><span id=__span-29-28><a id=__codelineno-29-28 name=__codelineno-29-28 href=#__codelineno-29-28></a><span class=gp>... </span>            <span class=n>colorscale</span><span class=o>=</span><span class=s1>&#39;Spectral&#39;</span>
</span><span id=__span-29-29><a id=__codelineno-29-29 name=__codelineno-29-29 href=#__codelineno-29-29></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-29-30><a id=__codelineno-29-30 name=__codelineno-29-30 href=#__codelineno-29-30></a><span class=gp>... </span>    <span class=p>)</span>
</span></code></pre></div> <ol> <li>Select the symbol (only one can be plotted at a time).</li> <li>Select the sub-period by its split index.</li> <li>Add the start and end dates of the sub-period to the title.</li> <li>Set up the heatmap's color scale.</li> </ol> <p>Finally, use <a href=https://vectorbt.pro/pvt_41531c19/api/utils/image_/#vectorbtpro.utils.image_.save_animation>save_animation</a> to iterate over each split index, plot the heatmap for each sub-period, and append it as a PNG image to the GIF file:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fname</span> <span class=o>=</span> <span class=s1>&#39;raw_pipeline.gif&#39;</span>
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>level_idx</span> <span class=o>=</span> <span class=n>sharpe_ratios</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>names</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=s1>&#39;split&#39;</span><span class=p>)</span>
</span><span id=__span-30-3><a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>split_indices</span> <span class=o>=</span> <span class=n>sharpe_ratios</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>levels</span><span class=p>[</span><span class=n>level_idx</span><span class=p>]</span>
</span><span id=__span-30-4><a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a>
</span><span id=__span-30-5><a id=__codelineno-30-5 name=__codelineno-30-5 href=#__codelineno-30-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>save_animation</span><span class=p>(</span>
</span><span id=__span-30-6><a id=__codelineno-30-6 name=__codelineno-30-6 href=#__codelineno-30-6></a><span class=gp>... </span>    <span class=n>fname</span><span class=p>,</span>
</span><span id=__span-30-7><a id=__codelineno-30-7 name=__codelineno-30-7 href=#__codelineno-30-7></a><span class=gp>... </span>    <span class=n>split_indices</span><span class=p>,</span> 
</span><span id=__span-30-8><a id=__codelineno-30-8 name=__codelineno-30-8 href=#__codelineno-30-8></a><span class=gp>... </span>    <span class=n>plot_subperiod_sharpe</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-30-9><a id=__codelineno-30-9 name=__codelineno-30-9 href=#__codelineno-30-9></a><span class=gp>... </span>    <span class=n>sharpe_ratios</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-30-10><a id=__codelineno-30-10 name=__codelineno-30-10 href=#__codelineno-30-10></a><span class=gp>... </span>    <span class=n>sharpe_ratios_hold</span><span class=p>,</span>
</span><span id=__span-30-11><a id=__codelineno-30-11 name=__codelineno-30-11 href=#__codelineno-30-11></a><span class=gp>... </span>    <span class=n>range_indexes</span><span class=p>,</span>
</span><span id=__span-30-12><a id=__codelineno-30-12 name=__codelineno-30-12 href=#__codelineno-30-12></a><span class=gp>... </span>    <span class=s1>&#39;BTCUSDT&#39;</span><span class=p>,</span>
</span><span id=__span-30-13><a id=__codelineno-30-13 name=__codelineno-30-13 href=#__codelineno-30-13></a><span class=gp>... </span>    <span class=n>delta</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>  <span class=c1># (3)!</span>
</span><span id=__span-30-14><a id=__codelineno-30-14 name=__codelineno-30-14 href=#__codelineno-30-14></a><span class=gp>... </span>    <span class=n>fps</span><span class=o>=</span><span class=mi>7</span><span class=p>,</span>
</span><span id=__span-30-15><a id=__codelineno-30-15 name=__codelineno-30-15 href=#__codelineno-30-15></a><span class=gp>... </span>    <span class=n>writer_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>loop</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>  <span class=c1># (4)!</span>
</span><span id=__span-30-16><a id=__codelineno-30-16 name=__codelineno-30-16 href=#__codelineno-30-16></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <ol> <li>Plotting function.</li> <li>Variable arguments passed to the plotting function.</li> <li>Keyword arguments for configuring the GIF.</li> <li>Loop the animation indefinitely.</li> </ol> <p> <div class="progress progress-100plus candystripe candystripe-animate"> <div class=progress-bar style=width:100.00%> <p class=progress-label>Heatmap 100/100</p> </div> </div> </p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=gp>&gt;&gt;&gt; </span><span class=kn>from</span><span class=w> </span><span class=nn>IPython.display</span><span class=w> </span><span class=kn>import</span> <span class=n>Image</span><span class=p>,</span> <span class=n>display</span>
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a>
</span><span id=__span-31-3><a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a><span class=gp>&gt;&gt;&gt; </span><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>fname</span><span class=p>,</span><span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span><span id=__span-31-4><a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a><span class=gp>... </span>    <span class=n>display</span><span class=p>(</span><span class=n>Image</span><span class=p>(</span><span class=n>data</span><span class=o>=</span><span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>(),</span> <span class=nb>format</span><span class=o>=</span><span class=s1>&#39;png&#39;</span><span class=p>))</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/supertrend/raw_pipeline.light.gif#only-light style=width:600px> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/supertrend/raw_pipeline.dark.gif#only-dark style=width:600px></p> <p>Any color bluer than yellow beats the market. Just avoid picking values at the bottom <img alt=😉 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f609.svg title=:wink:></p> <h2 id=summary>Summary<a class=headerlink href=#summary title="Permanent link">&para;</a></h2> <p>We have covered a lot of ground, so let's review what we have learned so far.</p> <p>A pipeline is a process that takes data and transforms it into insights. This process can be implemented using various pipeline designs, and you can always rely on VBT throughout the development of each one.</p> <p>The easiest-to-use class of pipelines in VBT uses two main components: the indicator (such as <code>SuperTrend</code>) and the simulator (such as <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a>). Both components can be developed, modified, and run independently. This modular design provides high flexibility when signals and order execution are not path-dependent. The only major drawback is high memory usage, which can only be addressed by chunking—splitting data and/or parameters into groups that are processed sequentially (looped) or in parallel. Chunking also allows you to use all cores with multiprocessing and multithreading. However, multithreading only works when the entire pipeline is Numba-compiled and can release the GIL. Fortunately, VBT provides many utilities that work within Numba, so do not be afraid to write your whole pipeline using Numba—it is easier than it sounds!</p> <p>Once signals become dependent on previous trades, both components must be combined into a monolithic workflow. These workflows are possible using contextualized simulation, such as with <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_order_func>Portfolio.from_order_func</a>, which lets you inject custom trading logic directly into the simulator using callbacks and contexts. This approach is very similar to the event-driven backtesting style found in many frameworks, such as backtrader. The key difference is in how information is stored and managed, which is done using named tuples and arrays rather than classes and variables. These pipelines offer the greatest flexibility but are significantly slower than modular ones (though they still outperform most other backtesting software). For maximum performance, you can switch to a lower-level API and implement the simulator yourself. Does that sound intimidating? It should not, because every simulator is simply a combination of regular for-loops and order management commands.</p> <p>Ultimately, you should choose the design that fits your needs best. There is no point in spending days creating a perfect pipeline if it only saves you five minutes in the end, right? But you will learn how to design efficient Python algorithms that can compete with top-tier algo-trading systems written in Java.</p> <p>As always, happy coding <img alt=❤ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2764.svg title=:heart:></p> <p><a class=md-button href=https://vectorbt.pro/pvt_41531c19/assets/jupytext/tutorials/superfast-supertrend/pipelines.py.txt target=blank_><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19.14 7.5A2.86 2.86 0 0 1 22 10.36v3.78A2.86 2.86 0 0 1 19.14 17H12c0 .39.32.96.71.96H17v1.68a2.86 2.86 0 0 1-2.86 2.86H9.86A2.86 2.86 0 0 1 7 19.64v-3.75a2.85 2.85 0 0 1 2.86-2.85h5.25a2.85 2.85 0 0 0 2.85-2.86V7.5zm-4.28 11.79c-.4 0-.72.3-.72.89s.32.71.72.71a.71.71 0 0 0 .71-.71c0-.59-.32-.89-.71-.89m-10-1.79A2.86 2.86 0 0 1 2 14.64v-3.78A2.86 2.86 0 0 1 4.86 8H12c0-.39-.32-.96-.71-.96H7V5.36A2.86 2.86 0 0 1 9.86 2.5h4.28A2.86 2.86 0 0 1 17 5.36v3.75a2.85 2.85 0 0 1-2.86 2.85H8.89a2.85 2.85 0 0 0-2.85 2.86v2.68zM9.14 5.71c.4 0 .72-.3.72-.89s-.32-.71-.72-.71c-.39 0-.71.12-.71.71s.32.89.71.89"/></svg></span> Python code</a> <a class=md-button href=https://github.com/polakowo/vectorbt.pro/blob/notebooks/SuperTrend.ipynb target=blank_><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 4v6l-2-2-2 2V4H9v16h10V4zM3 7V5h2V4a2 2 0 0 1 2-2h12c1.05 0 2 .95 2 2v16c0 1.05-.95 2-2 2H7c-1.05 0-2-.95-2-2v-1H3v-2h2v-4H3v-2h2V7zm2-2v2h2V5zm0 14h2v-2H5zm0-6h2v-2H5z"/></svg></span> Notebook</a></p> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/superfast-supertrend/multithreading/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Multithreading"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Multithreading </div> </div> </a> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/signal-development/generation/ class="md-footer__link md-footer__link--next" aria-label="Next: Generation"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Generation </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2021-2025 Oleg Polakow. All rights reserved. </div> </div> <div class=md-social> <a href=https://www.linkedin.com/in/polakowo target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> <a href=https://github.com/polakowo target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <div class=md-consent data-md-component=consent id=__consent hidden> <div class=md-consent__overlay></div> <aside class=md-consent__inner> <form class="md-consent__form md-grid md-typeset" name=consent> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class=md-toggle type=checkbox id=__settings> <div class=md-consent__settings> <ul class=task-list> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=analytics checked> <span class=task-list-indicator></span> Google Analytics </label> </li> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=github checked> <span class=task-list-indicator></span> GitHub </label> </li> </ul> </div> <div class=md-consent__controls> <button class="md-button md-button--primary">Accept</button> <label class=md-button for=__settings>Manage settings</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script> <script id=__config type=application/json>{"annotate": null, "base": "../../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.instant", "navigation.instant.progress", "navigation.top", "navigation.prune", "navigation.path", "navigation.footer", "search.suggest", "search.share", "content.code.annotate", "content.code.copy", "content.code.select", "content.tooltips", "content.tabs.link", "toc.follow", "toc.integrate", "announce.dismiss"], "search": "../../../assets/javascripts/workers/search.26099bd0.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=https://vectorbt.pro/pvt_41531c19/assets/javascripts/bundle.9d1edc04.min.js></script> <script src=https://vectorbt.pro/pvt_41531c19/assets/scripts/extra.js></script> <script src=https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js></script> </body> 
<!-- Mirrored from vectorbt.pro/pvt_41531c19/tutorials/superfast-supertrend/pipelines/ by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 22 Nov 2025 03:46:49 GMT -->
</html>