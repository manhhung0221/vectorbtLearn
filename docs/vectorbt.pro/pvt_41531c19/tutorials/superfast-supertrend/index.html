<!doctype html><html lang=en class=no-js> 
<!-- Mirrored from vectorbt.pro/pvt_41531c19/tutorials/superfast-supertrend/ by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 22 Nov 2025 03:46:36 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Learn how to build the fastest SuperTrend indicator in Python using VectorBT PRO"><meta name=author content="Oleg Polakow"><link href=https://vectorbt.pro/tutorials/superfast-supertrend/ rel=canonical><link href=../basic-rsi/index.html rel=prev><link href=streaming/index.html rel=next><link rel=icon href=../../assets/logo/favicon.png><meta name=generator content="mkdocs-1.6.0, mkdocs-material-9.6.21+insiders-4.53.17"><title>SuperFast SuperTrend - VectorBT® PRO</title><link rel=stylesheet href=../../assets/stylesheets/main.010a373c.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=../../../../fonts.gstatic.com/index.html crossorigin><link rel=stylesheet href="../../../../fonts.googleapis.com/cssbe43.css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../assets/stylesheets/extra.css><link rel=stylesheet href=../../assets/stylesheets/custom-light.css><link rel=stylesheet href=../../assets/stylesheets/custom-dark.css><link rel=stylesheet href=../../assets/stylesheets/pygments-light.css><link rel=stylesheet href=../../assets/stylesheets/pygments-dark.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-0C5VNYCFHL"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-0C5VNYCFHL",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="../../../../www.googletagmanager.com/gtag/jsc6c8?id=G-0C5VNYCFHL",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script><meta name=robots content="noindex, nofollow"><meta property=og:title content="SuperFast SuperTrend"><meta property=og:type content=website><meta content=https://vectorbt.pro/tutorials/superfast-supertrend/ property=og:url><meta property=og:image:url content=https://vectorbt.pro/pvt_41531c19/assets/logo/social-new.png><meta property=og:image:type content=image/png><meta property=og:description content="Learn how to build the fastest SuperTrend indicator in Python using VectorBT PRO"><meta property=og:locale content=en-GB><link rel=apple-touch-icon sizes=180x180 href=https://vectorbt.pro/pvt_41531c19/assets/logo/apple-touch-icon.png><link rel=icon type=image/svg+xml href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon.svg><link rel=icon type=image/png sizes=32x32 href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon-16x16.png><link rel=manifest href=https://vectorbt.pro/pvt_41531c19/assets/logo/site.webmanifest><link rel=mask-icon href=https://vectorbt.pro/pvt_41531c19/assets/logo/safari-pinned-tab.svg color=#1e1f22><link rel="shortcut icon" href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon.ico><meta name=msapplication-TileColor content=#1e1f22><meta name=msapplication-config content=https://vectorbt.pro/pvt_41531c19/assets/logo/browserconfig.xml><meta name=theme-color content=#1e1f22><link href=https://unpkg.com/aos@2.3.4/dist/aos.css rel=stylesheet><script src=https://unpkg.com/aos@2.3.4/dist/aos.js></script><link href=http://fonts.cdnfonts.com/css/uni-neue rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/js/all.min.js integrity="sha512-8pHNiqTlsrRjVD4A/3va++W1sMbUHwWxxRPWNyVlql3T+Hgfd81Qc6FC5WMXDC+tSauxxzp1tgiAvSKFu1qIlA==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js integrity="sha512-q583ppKrCRc7N5O0n2nzUiJ+suUv7Et1JGels4bXOaMFQcamPk9HjdUknZuuFjBNs7tsMuadge5k9RzdmO+1GQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><link rel=preconnect href=https://fonts.googleapis.com/><link rel=preconnect href=https://fonts.gstatic.com/ crossorigin></head> <body dir=ltr data-md-color-scheme=custom-dark data-md-color-primary=custom-dark data-md-color-accent=custom-dark> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#superfast-supertrend class=md-skip> Skip to content </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> <button class="md-banner__button md-icon" aria-label="Don't show this again"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> <i>What's new</i>: New LLM providers, reasoning steps, function calling, YAML & TOML support, and <a href=https://vectorbt.pro/pvt_41531c19/getting-started/release-notes><strong>more</strong></a> <span class="twemoji announce-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m153.6 29.9 16-21.3c4-5.4 10.4-8.6 17.1-8.6C198.4 0 208 9.6 208 21.3v22.1c0 13.1 5.4 25.7 14.9 34.7l84.7 80.9c48.8 46.6 76.4 111.2 76.4 178.7C384 434 306 512 209.7 512H192C86 512 0 426 0 320v-3.8c0-48.8 19.4-95.6 53.9-130.1l3.5-3.5c4.2-4.2 10-6.6 16-6.6 12.5 0 22.6 10.1 22.6 22.6V288c0 35.3 28.7 64 64 64s64-28.7 64-64v-3.9c0-18-7.2-35.3-19.9-48l-38.6-38.6c-24-24-37.5-56.7-37.5-90.7 0-27.7 9-54.8 25.6-76.9"/></svg></span> </div> <script>var el=document.querySelector("[data-md-component=announce]");if(el){var content=el.querySelector(".md-typeset");__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0)}</script> </aside> </div> <!-- Determine class according to configuration --> <!-- Header --> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=header.title> <!-- Link to home --> <a href=https://vectorbt.pro/pvt_41531c19/ title="VectorBT® PRO" class="md-header__button md-logo" aria-label="VectorBT® PRO" data-md-component=logo> <img src=https://vectorbt.pro/pvt_41531c19/assets/logo/logo.svg alt=logo class=logo> </a> <!-- Button to open drawer --> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <!-- Header title --> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> VectorBT® PRO <span class=md-version> v2025.10.15 </span> <span class=unlock-icon><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M192 32c-35.3 0-64 28.7-64 64v64h192c35.3 0 64 28.7 64 64v224c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V224c0-35.3 28.7-64 64-64V96c0-70.7 57.3-128 128-128 63.5 0 116.1 46.1 126.2 106.7 2.9 17.4-8.8 33.9-26.3 36.9S258 102.8 255 85.3C250 55.1 223.7 32 192 32m40 328c13.3 0 24-10.7 24-24s-10.7-24-24-24h-80c-13.3 0-24 10.7-24 24s10.7 24 24 24z"/></svg></span> </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> SuperFast SuperTrend </span> </div> </div> </div> <!-- Color palette --> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=custom-dark data-md-color-primary=custom-dark data-md-color-accent=custom-dark aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=custom-light data-md-color-primary=custom-light data-md-color-accent=custom-light aria-label="Switch to dark mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <!-- Site language selector --> <!-- Button to open search modal --> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <!-- Search interface --> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <!-- Repository information --> <div class=md-header__source> <a href=https://github.com/polakowo/vectorbt.pro title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> vectorbt.pro </div> </a> </div> </nav> <!-- Navigation tabs (sticky) --> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/ class=md-tabs__link> Getting started </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/features/overview/ class=md-tabs__link> Features </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/overview/ class=md-tabs__link> Tutorials </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/documentation/overview/ class=md-tabs__link> Documentation </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/overview/ class=md-tabs__link> Cookbook </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/api/ class=md-tabs__link> API </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/terms/terms-of-use/ class=md-tabs__link> Terms </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://vectorbt.pro/pvt_41531c19/ title="VectorBT® PRO" class="md-nav__button md-logo" aria-label="VectorBT® PRO" data-md-component=logo> <img src=https://vectorbt.pro/pvt_41531c19/assets/logo/logo.svg alt=logo class=logo> </a> VectorBT® PRO </label> <div class=md-nav__source> <a href=https://github.com/polakowo/vectorbt.pro title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> vectorbt.pro </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/ class=md-nav__link> <span class=md-ellipsis> Getting started </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/features/overview/ class=md-nav__link> <span class=md-ellipsis> Features </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Tutorials </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Tutorials </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/overview/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/basic-rsi/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m3.5 18.5 6-6 4 4L22 6.92 20.59 5.5l-7.09 8-4-4L2 17z"/></svg> <span class=md-ellipsis> Basic RSI strategy </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3 checked> <label class=md-nav__link for=__nav_3_3 id=__nav_3_3_label tabindex=0> <span class=md-ellipsis> SuperFast SuperTrend </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> SuperFast SuperTrend </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M11 9.47V11h3.76L13 14.53V13H9.24zM13 1 6 15h5v8l7-14h-5z"/></svg> <span class=md-ellipsis> SuperFast SuperTrend </span> <span class="md-nav__icon md-icon"></span> </label> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/superfast-supertrend/ class="md-nav__link md-nav__link--active"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M11 9.47V11h3.76L13 14.53V13H9.24zM13 1 6 15h5v8l7-14h-5z"/></svg> <span class=md-ellipsis> SuperFast SuperTrend </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#data class=md-nav__link> <span class=md-ellipsis> Data </span> </a> </li> <li class=md-nav__item> <a href=#design class=md-nav__link> <span class=md-ellipsis> Design </span> </a> <nav class=md-nav aria-label=Design> <ul class=md-nav__list> <li class=md-nav__item> <a href=#pandas class=md-nav__link> <span class=md-ellipsis> Pandas </span> </a> </li> <li class=md-nav__item> <a href=#numpy-numba class=md-nav__link> <span class=md-ellipsis> NumPy + Numba </span> </a> </li> <li class=md-nav__item> <a href=#numpy-numba-talib class=md-nav__link> <span class=md-ellipsis> NumPy + Numba + TA-Lib </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#indicator-factory class=md-nav__link> <span class=md-ellipsis> Indicator factory </span> </a> <nav class=md-nav aria-label="Indicator factory"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#expressions class=md-nav__link> <span class=md-ellipsis> Expressions </span> </a> </li> <li class=md-nav__item> <a href=#plotting class=md-nav__link> <span class=md-ellipsis> Plotting </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#backtesting class=md-nav__link> <span class=md-ellipsis> Backtesting </span> </a> <nav class=md-nav aria-label=Backtesting> <ul class=md-nav__list> <li class=md-nav__item> <a href=#optimization class=md-nav__link> <span class=md-ellipsis> Optimization </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/superfast-supertrend/streaming/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M11 9.47V11h3.76L13 14.53V13H9.24zM13 1 6 15h5v8l7-14h-5z"/></svg> <span class=md-ellipsis> Streaming </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/superfast-supertrend/multithreading/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M11 9.47V11h3.76L13 14.53V13H9.24zM13 1 6 15h5v8l7-14h-5z"/></svg> <span class=md-ellipsis> Multithreading </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/superfast-supertrend/pipelines/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M11 9.47V11h3.76L13 14.53V13H9.24zM13 1 6 15h5v8l7-14h-5z"/></svg> <span class=md-ellipsis> Pipelines </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/signal-development/generation/ class=md-nav__link> <span class=md-ellipsis> Signal development </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/stop-signals/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 23h-2V1h2zm-4-4H5V5h4V3H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h4zM19 7v2h2V7zm0-2h2a2 2 0 0 0-2-2zm2 10h-2v2h2zm-2-4v2h2v-2zm-2-8h-2v2h2zm2 18c1.11 0 2-.89 2-2h-2zm-2-2h-2v2h2z"/></svg> <span class=md-ellipsis> Stop signals </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/mtf-analysis/ class=md-nav__link> <span class=md-ellipsis> MTF analysis </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/portfolio-optimization/ class=md-nav__link> <span class=md-ellipsis> Portfolio optimization </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/pairs-trading/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22 6.92 20.59 5.5l-2.85 3.22C15.68 6.4 12.83 5 9.61 5 6.72 5 4.07 6.16 2 8l1.42 1.42C5.12 7.93 7.27 7 9.61 7c2.74 0 5.09 1.26 6.77 3.24L13.5 13.5l-4-4L2 17l1.5 1.5 6-6 4 4 4.05-4.57c.75 1.35 1.25 2.9 1.45 4.57h2c-.22-2.32-.95-4.41-2.04-6.16z"/></svg> <span class=md-ellipsis> Pairs trading </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/patterns-and-projections/patterns/ class=md-nav__link> <span class=md-ellipsis> Patterns and projections </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/cross-validation/ class=md-nav__link> <span class=md-ellipsis> Cross-validation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/more-tutorials/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10.6 13.4a1 1 0 0 1-1.4 1.4 4.8 4.8 0 0 1 0-7l3.5-3.6a5.1 5.1 0 0 1 7.1 0 5.1 5.1 0 0 1 0 7.1l-1.5 1.5a6.4 6.4 0 0 0-.4-2.4l.5-.5a3.2 3.2 0 0 0 0-4.3 3.2 3.2 0 0 0-4.3 0l-3.5 3.6a2.9 2.9 0 0 0 0 4.2M23 18v2h-3v3h-2v-3h-3v-2h3v-3h2v3m-3.8-4.3a4.8 4.8 0 0 0-1.4-4.5 1 1 0 0 0-1.4 1.4 2.9 2.9 0 0 1 0 4.2l-3.5 3.6a3.2 3.2 0 0 1-4.3 0 3.2 3.2 0 0 1 0-4.3l.5-.4a7.3 7.3 0 0 1-.4-2.5l-1.5 1.5a5.1 5.1 0 0 0 0 7.1 5.1 5.1 0 0 0 7.1 0l1.8-1.8a6 6 0 0 1 3.1-4.3"/></svg> <span class=md-ellipsis> More tutorials </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/to-be-continued/ class=md-nav__link> <span class=md-ellipsis> To be continued... </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/documentation/overview/ class=md-nav__link> <span class=md-ellipsis> Documentation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/overview/ class=md-nav__link> <span class=md-ellipsis> Cookbook </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/api/ class=md-nav__link> <span class=md-ellipsis> API </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/terms/terms-of-use/ class=md-nav__link> <span class=md-ellipsis> Terms </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <nav class=md-path aria-label=Navigation> <ol class=md-path__list> <li class=md-path__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/overview/ class=md-path__link> <span class=md-ellipsis> Tutorials </span> </a> </li> <li class=md-path__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/superfast-supertrend/ class=md-path__link> <span class=md-ellipsis> SuperFast SuperTrend </span> </a> </li> </ol> </nav> <article class="md-content__inner md-typeset"> <h1 id=superfast-supertrend><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M11 9.47V11h3.76L13 14.53V13H9.24zM13 1 6 15h5v8l7-14h-5z"/></svg></span> SuperFast SuperTrend<a class=headerlink href=#superfast-supertrend title="Permanent link">&para;</a></h1> <p>While Python is slower than many compiled languages, it is easy to use and extremely versatile. For many users, especially in the data science field, Python's practicality outweighs concerns about speed. It serves as a Swiss Army knife for programmers and researchers alike.</p> <p>Unfortunately for quants, Python can become a significant bottleneck when working with large datasets. To address this, an entire ecosystem of scientific packages—such as NumPy and Pandas—exists. These packages are highly optimized for performance, with critical code paths often written in Cython or C. They primarily operate on arrays, providing a consistent interface for efficient data processing.</p> <p>This approach is especially valuable when creating indicators that can be expressed as a set of vectorized operations, such as <a href=https://www.investopedia.com/terms/o/onbalancevolume.asp>OBV</a>. Even for non-vectorized operations like the exponentially weighted moving average (EMA), which is used in many indicators such as <a href=https://www.investopedia.com/terms/m/macd.asp>MACD</a>, implementations are written in compiled languages and exposed as ready-to-use Python functions. However, some indicators are challenging or even impossible to develop solely with standard array operations because they introduce path dependency, where today's decisions depend on those made yesterday. SuperTrend is one such indicator.</p> <p>In this example, you will learn how to design and implement a SuperTrend indicator, and step by step optimize it for exceptional performance using <a href=https://github.com/mrjbq7/ta-lib>TA-Lib</a> and <a href=http://numba.pydata.org/ >Numba</a>. We will also backtest the new indicator across a range of parameters using VBT (PRO).</p> <h2 id=data>Data<a class=headerlink href=#data title="Permanent link">&para;</a></h2> <p>The first step is always obtaining the right data. Specifically, we need enough data to benchmark different SuperTrend implementations. Let's pull 2 years of hourly Bitcoin and Ethereum data from Binance using VBT's <a href=https://vectorbt.pro/pvt_41531c19/api/data/custom/binance/#vectorbtpro.data.custom.binance.BinanceData>BinanceData</a> class:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=kn>from</span><span class=w> </span><span class=nn>vectorbtpro</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>BinanceData</span><span class=o>.</span><span class=n>pull</span><span class=p>(</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=p>[</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>,</span> <span class=s1>&#39;ETHUSDT&#39;</span><span class=p>],</span> 
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>start</span><span class=o>=</span><span class=s1>&#39;2020-01-01 UTC&#39;</span><span class=p>,</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span>    <span class=n>end</span><span class=o>=</span><span class=s1>&#39;2022-01-01 UTC&#39;</span><span class=p>,</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>... </span>    <span class=n>timeframe</span><span class=o>=</span><span class=s1>&#39;1h&#39;</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <p> <div class="progress progress-100plus candystripe candystripe-animate"> <div class=progress-bar style=width:100.00%> <p class=progress-label>Symbol 2/2</p> </div> </div> </p> <p> <div class="progress progress-100plus candystripe candystripe-animate"> <div class=progress-bar style=width:100.00%> <p class=progress-label>Period 36/36</p> </div> </div> </p> <p>Fetching data for both symbols took about 80 seconds to complete. Since Binance, like any other exchange, will not return all the data at once, VBT first requested the maximum amount of data starting from January 1, 2020, and then gradually collected the remaining data, while respecting Binance's API rate limits. In total, this resulted in 36 requests per symbol. Finally, VBT aligned both symbols in case their indexes or columns were different and made the final index timezone-aware (in UTC).</p> <p>To avoid repeatedly hitting the Binance servers every time we start a new Python session, we should save the downloaded data locally using either VBT's <a href=https://vectorbt.pro/pvt_41531c19/api/data/base/#vectorbtpro.data.base.Data.to_csv>Data.to_csv</a> or <a href=https://vectorbt.pro/pvt_41531c19/api/data/base/#vectorbtpro.data.base.Data.to_hdf>Data.to_hdf</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data</span><span class=o>.</span><span class=n>to_hdf</span><span class=p>(</span><span class=s1>&#39;my_data.h5&#39;</span><span class=p>)</span>
</span></code></pre></div> <p>We can then easily access the saved data using <a href=https://vectorbt.pro/pvt_41531c19/api/data/custom/hdf/#vectorbtpro.data.custom.hdf.HDFData>HDFData</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>HDFData</span><span class=o>.</span><span class=n>pull</span><span class=p>(</span><span class=s1>&#39;my_data.h5&#39;</span><span class=p>)</span>
</span></code></pre></div> <p> <div class="progress progress-100plus candystripe candystripe-animate"> <div class=progress-bar style=width:100.00%> <p class=progress-label>Symbol 2/2</p> </div> </div> </p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>We can access any of the symbols in an HDF file using regular path expressions. For example, the same as above: <code>vbt.HDFData.pull(['my_data.h5/BTCUSDT', 'my_data.h5/ETHUSDT'])</code>.</p> </div> <p>Once we have the data, let's take a quick look at what is inside. To get any of the stored DataFrames, use the <a href=https://vectorbt.pro/pvt_41531c19/api/data/custom/#vectorbtpro.data.base.Data.data>Data.data</a> dictionary, where each DataFrame is keyed by symbol:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>info</span><span class=p>()</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=go>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=go>DatetimeIndex: 17514 entries, 2019-12-31 23:00:00+00:00 to 2021-12-31 22:00:00+00:00</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=go>Data columns (total 10 columns):</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=go> #   Column              Non-Null Count  Dtype              </span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=go>---  ------              --------------  -----              </span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=go> 0   Open                17514 non-null  float64            </span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=go> 1   High                17514 non-null  float64            </span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=go> 2   Low                 17514 non-null  float64            </span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=go> 3   Close               17514 non-null  float64            </span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=go> 4   Volume              17514 non-null  float64            </span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=go> 5   Close time          17514 non-null  datetime64[ns, UTC]</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a><span class=go> 6   Quote volume        17514 non-null  float64            </span>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=go> 7   Number of trades    17514 non-null  int64              </span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a><span class=go> 8   Taker base volume   17514 non-null  float64            </span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a><span class=go> 9   Taker quote volume  17514 non-null  float64            </span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a><span class=go>dtypes: datetime64[ns, UTC](1), float64(8), int64(1)</span>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a><span class=go>memory usage: 2.0 MB</span>
</span></code></pre></div> <p>We can also get an overview of all the symbols collected:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data</span><span class=o>.</span><span class=n>stats</span><span class=p>()</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=go>Start                   2020-01-01 00:00:00+00:00</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=go>End                     2021-12-31 23:00:00+00:00</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=go>Period                                      17513</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=go>Total Symbols                                   2</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=go>Last Index: BTCUSDT     2021-12-31 23:00:00+00:00</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=go>Last Index: ETHUSDT     2021-12-31 23:00:00+00:00</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=go>Null Counts: BTCUSDT                            0</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=go>Null Counts: ETHUSDT                            0</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=go>Name: agg_stats, dtype: object</span>
</span></code></pre></div> <p>Each symbol has 17513 data points with no NaNs—perfect!</p> <p>If you have ever worked with VBT, you know that VBT prefers data with symbols as columns (one per backtest) instead of features as columns. Since SuperTrend depends on the high, low, and close price, let's get those three features as separate DataFrames using <a href=https://vectorbt.pro/pvt_41531c19/api/data/custom/#vectorbtpro.data.base.Data.get>Data.get</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>high</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;High&#39;</span><span class=p>)</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>low</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;Low&#39;</span><span class=p>)</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>close</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;Close&#39;</span><span class=p>)</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>close</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=go>symbol                      BTCUSDT  ETHUSDT</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=go>Open time                                   </span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=go>2020-01-01 00:00:00+00:00   7177.02   128.87</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=go>2020-01-01 01:00:00+00:00   7216.27   130.64</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=go>2020-01-01 02:00:00+00:00   7242.85   130.85</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a><span class=go>2020-01-01 03:00:00+00:00   7225.01   130.20</span>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a><span class=go>2020-01-01 04:00:00+00:00   7217.27   130.20</span>
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a><span class=go>...                             ...      ...</span>
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a><span class=go>2021-12-31 19:00:00+00:00  45728.28  3626.27</span>
</span><span id=__span-5-15><a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a><span class=go>2021-12-31 20:00:00+00:00  45879.24  3645.04</span>
</span><span id=__span-5-16><a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a><span class=go>2021-12-31 21:00:00+00:00  46333.86  3688.41</span>
</span><span id=__span-5-17><a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a><span class=go>2021-12-31 22:00:00+00:00  46303.99  3681.80</span>
</span><span id=__span-5-18><a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a><span class=go>2021-12-31 23:00:00+00:00  46216.93  3676.23</span>
</span><span id=__span-5-19><a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a>
</span><span id=__span-5-20><a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a><span class=go>[17513 rows x 2 columns]</span>
</span></code></pre></div> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>To get a column for a specific symbol as a Series, use <code>data.get('Close', 'BTCUSDT')</code>.</p> </div> <p>We are all set to design our first SuperTrend indicator!</p> <h2 id=design>Design<a class=headerlink href=#design title="Permanent link">&para;</a></h2> <p>SuperTrend is a trend-following indicator that uses the Average True Range (<a href=https://en.wikipedia.org/wiki/Average_true_range>ATR</a>) and the <a href=https://www.incrediblecharts.com/indicators/median_price.php>median price</a> to define a set of upper and lower bands. The idea is straightforward: when the close price crosses above the upper band, the asset is considered to be entering an uptrend, which signals a buy. When the close price crosses below the lower band, the asset is considered to have exited the uptrend, which signals a sell.</p> <p>While the concept is simple, the calculation process is a bit more complex:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>BASIC UPPERBAND = (HIGH + LOW) / 2 + Multiplier * ATR
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>BASIC LOWERBAND = (HIGH + LOW) / 2 - Multiplier * ATR
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>FINAL UPPERBAND = IF (Current BASICUPPERBAND &lt; Previous FINAL UPPERBAND) or (Previous Close &gt; Previous FINAL UPPERBAND)
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>                  THEN Current BASIC UPPERBAND
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>                  ELSE Previous FINAL UPPERBAND
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a>FINAL LOWERBAND = IF (Current BASIC LOWERBAND &gt; Previous FINAL LOWERBAND) or (Previous Close &lt; Previous FINAL LOWERBAND)
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a>                  THEN Current BASIC LOWERBAND 
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a>                  ELSE Previous FINAL LOWERBAND
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a>SUPERTREND      = IF (Previous SUPERTREND == Previous FINAL UPPERBAND) and (Current Close &lt;= Current FINAL UPPERBAND)) 
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a>                  THEN Current FINAL UPPERBAND
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a>                  ELIF (Previous SUPERTREND == Previous FINAL UPPERBAND) and (Current Close &gt; Current FINAL UPPERBAND) 
</span><span id=__span-6-14><a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a>                  THEN Current FINAL LOWERBAND
</span><span id=__span-6-15><a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a>                  ELIF (Previous SUPERTREND == Previous FINAL LOWERBAND) and (Current Close &gt;= Current FINAL LOWERBAND) 
</span><span id=__span-6-16><a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a>                  THEN Current FINAL LOWERBAND
</span><span id=__span-6-17><a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a>                  ELIF (Previous SUPERTREND == Previous FINAL LOWERBAND) and (Current Close &lt; Current FINAL LOWERBAND) 
</span><span id=__span-6-18><a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a>                  THEN Current FINAL UPPERBAND
</span></code></pre></div> <p>Even though the basic bands can easily be computed using standard tools, you will likely get a headache when trying to calculate the final bands. Most open-source solutions agree on using a basic Python for-loop to write the array elements one at a time. But is this approach scalable? We are here to find out!</p> <h3 id=pandas>Pandas<a class=headerlink href=#pandas title="Permanent link">&para;</a></h3> <p><a href=https://github.com/pandas-dev/pandas>Pandas</a> is a fast, powerful, flexible, and easy-to-use open source data analysis and manipulation tool. Since it is the go-to library for data processing in Python, let's write our first implementation using only Pandas. This implementation will take one column and one combination of parameters, and return four arrays: one for the SuperTrend (<code>trend</code>), one for the direction (<code>dir_</code>), one for the uptrend (<code>long</code>), and one for the downtrend (<code>short</code>). We will also split the implementation into five parts for readability and so we can optimize any component at any time:</p> <ol> <li>Calculation of the median price - <code>get_med_price</code>.</li> <li>Calculation of the ATR - <code>get_atr</code>.</li> <li>Calculation of the basic bands - <code>get_basic_bands</code>.</li> <li>Calculation of the final bands - <code>get_final_bands</code>.</li> <li>Putting all parts together - <code>supertrend</code>.</li> </ol> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>get_med_price</span><span class=p>(</span><span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=p>):</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=gp>... </span>    <span class=k>return</span> <span class=p>(</span><span class=n>high</span> <span class=o>+</span> <span class=n>low</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>get_atr</span><span class=p>(</span><span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span> <span class=n>close</span><span class=p>,</span> <span class=n>period</span><span class=p>):</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=gp>... </span>    <span class=n>tr0</span> <span class=o>=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>high</span> <span class=o>-</span> <span class=n>low</span><span class=p>)</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=gp>... </span>    <span class=n>tr1</span> <span class=o>=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>high</span> <span class=o>-</span> <span class=n>close</span><span class=o>.</span><span class=n>shift</span><span class=p>())</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=gp>... </span>    <span class=n>tr2</span> <span class=o>=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>low</span> <span class=o>-</span> <span class=n>close</span><span class=o>.</span><span class=n>shift</span><span class=p>())</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a><span class=gp>... </span>    <span class=n>tr</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>((</span><span class=n>tr0</span><span class=p>,</span> <span class=n>tr1</span><span class=p>,</span> <span class=n>tr2</span><span class=p>),</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>max</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a><span class=gp>... </span>    <span class=n>atr</span> <span class=o>=</span> <span class=n>tr</span><span class=o>.</span><span class=n>ewm</span><span class=p>(</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a><span class=gp>... </span>        <span class=n>alpha</span><span class=o>=</span><span class=mi>1</span> <span class=o>/</span> <span class=n>period</span><span class=p>,</span> 
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a><span class=gp>... </span>        <span class=n>adjust</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> 
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a><span class=gp>... </span>        <span class=n>min_periods</span><span class=o>=</span><span class=n>period</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>  <span class=c1># (2)!</span>
</span><span id=__span-7-13><a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>atr</span>
</span><span id=__span-7-14><a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a>
</span><span id=__span-7-15><a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>get_basic_bands</span><span class=p>(</span><span class=n>med_price</span><span class=p>,</span> <span class=n>atr</span><span class=p>,</span> <span class=n>multiplier</span><span class=p>):</span>
</span><span id=__span-7-16><a id=__codelineno-7-16 name=__codelineno-7-16 href=#__codelineno-7-16></a><span class=gp>... </span>    <span class=n>matr</span> <span class=o>=</span> <span class=n>multiplier</span> <span class=o>*</span> <span class=n>atr</span>
</span><span id=__span-7-17><a id=__codelineno-7-17 name=__codelineno-7-17 href=#__codelineno-7-17></a><span class=gp>... </span>    <span class=n>upper</span> <span class=o>=</span> <span class=n>med_price</span> <span class=o>+</span> <span class=n>matr</span>
</span><span id=__span-7-18><a id=__codelineno-7-18 name=__codelineno-7-18 href=#__codelineno-7-18></a><span class=gp>... </span>    <span class=n>lower</span> <span class=o>=</span> <span class=n>med_price</span> <span class=o>-</span> <span class=n>matr</span>
</span><span id=__span-7-19><a id=__codelineno-7-19 name=__codelineno-7-19 href=#__codelineno-7-19></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>upper</span><span class=p>,</span> <span class=n>lower</span>
</span><span id=__span-7-20><a id=__codelineno-7-20 name=__codelineno-7-20 href=#__codelineno-7-20></a>
</span><span id=__span-7-21><a id=__codelineno-7-21 name=__codelineno-7-21 href=#__codelineno-7-21></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>get_final_bands</span><span class=p>(</span><span class=n>close</span><span class=p>,</span> <span class=n>upper</span><span class=p>,</span> <span class=n>lower</span><span class=p>):</span>  <span class=c1># (3)!</span>
</span><span id=__span-7-22><a id=__codelineno-7-22 name=__codelineno-7-22 href=#__codelineno-7-22></a><span class=gp>... </span>    <span class=n>trend</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>),</span> <span class=n>index</span><span class=o>=</span><span class=n>close</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span><span id=__span-7-23><a id=__codelineno-7-23 name=__codelineno-7-23 href=#__codelineno-7-23></a><span class=gp>... </span>    <span class=n>dir_</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=n>index</span><span class=o>=</span><span class=n>close</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span><span id=__span-7-24><a id=__codelineno-7-24 name=__codelineno-7-24 href=#__codelineno-7-24></a><span class=gp>... </span>    <span class=n>long</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>),</span> <span class=n>index</span><span class=o>=</span><span class=n>close</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span><span id=__span-7-25><a id=__codelineno-7-25 name=__codelineno-7-25 href=#__codelineno-7-25></a><span class=gp>... </span>    <span class=n>short</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>),</span> <span class=n>index</span><span class=o>=</span><span class=n>close</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span><span id=__span-7-26><a id=__codelineno-7-26 name=__codelineno-7-26 href=#__codelineno-7-26></a><span class=gp>... </span>
</span><span id=__span-7-27><a id=__codelineno-7-27 name=__codelineno-7-27 href=#__codelineno-7-27></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>  <span class=c1># (4)!</span>
</span><span id=__span-7-28><a id=__codelineno-7-28 name=__codelineno-7-28 href=#__codelineno-7-28></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>close</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>upper</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]:</span>
</span><span id=__span-7-29><a id=__codelineno-7-29 name=__codelineno-7-29 href=#__codelineno-7-29></a><span class=gp>... </span>            <span class=n>dir_</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span>
</span><span id=__span-7-30><a id=__codelineno-7-30 name=__codelineno-7-30 href=#__codelineno-7-30></a><span class=gp>... </span>        <span class=k>elif</span> <span class=n>close</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>lower</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]:</span>
</span><span id=__span-7-31><a id=__codelineno-7-31 name=__codelineno-7-31 href=#__codelineno-7-31></a><span class=gp>... </span>            <span class=n>dir_</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>
</span><span id=__span-7-32><a id=__codelineno-7-32 name=__codelineno-7-32 href=#__codelineno-7-32></a><span class=gp>... </span>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-7-33><a id=__codelineno-7-33 name=__codelineno-7-33 href=#__codelineno-7-33></a><span class=gp>... </span>            <span class=n>dir_</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>dir_</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span>
</span><span id=__span-7-34><a id=__codelineno-7-34 name=__codelineno-7-34 href=#__codelineno-7-34></a><span class=gp>... </span>            <span class=k>if</span> <span class=n>dir_</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>lower</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>lower</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]:</span>
</span><span id=__span-7-35><a id=__codelineno-7-35 name=__codelineno-7-35 href=#__codelineno-7-35></a><span class=gp>... </span>                <span class=n>lower</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>lower</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span>
</span><span id=__span-7-36><a id=__codelineno-7-36 name=__codelineno-7-36 href=#__codelineno-7-36></a><span class=gp>... </span>            <span class=k>if</span> <span class=n>dir_</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>upper</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>upper</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]:</span>
</span><span id=__span-7-37><a id=__codelineno-7-37 name=__codelineno-7-37 href=#__codelineno-7-37></a><span class=gp>... </span>                <span class=n>upper</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>upper</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span>
</span><span id=__span-7-38><a id=__codelineno-7-38 name=__codelineno-7-38 href=#__codelineno-7-38></a><span class=gp>... </span>
</span><span id=__span-7-39><a id=__codelineno-7-39 name=__codelineno-7-39 href=#__codelineno-7-39></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>dir_</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-7-40><a id=__codelineno-7-40 name=__codelineno-7-40 href=#__codelineno-7-40></a><span class=gp>... </span>            <span class=n>trend</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>long</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>lower</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-7-41><a id=__codelineno-7-41 name=__codelineno-7-41 href=#__codelineno-7-41></a><span class=gp>... </span>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-7-42><a id=__codelineno-7-42 name=__codelineno-7-42 href=#__codelineno-7-42></a><span class=gp>... </span>            <span class=n>trend</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>short</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>upper</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-7-43><a id=__codelineno-7-43 name=__codelineno-7-43 href=#__codelineno-7-43></a><span class=gp>... </span>            
</span><span id=__span-7-44><a id=__codelineno-7-44 name=__codelineno-7-44 href=#__codelineno-7-44></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>trend</span><span class=p>,</span> <span class=n>dir_</span><span class=p>,</span> <span class=n>long</span><span class=p>,</span> <span class=n>short</span>
</span><span id=__span-7-45><a id=__codelineno-7-45 name=__codelineno-7-45 href=#__codelineno-7-45></a>
</span><span id=__span-7-46><a id=__codelineno-7-46 name=__codelineno-7-46 href=#__codelineno-7-46></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>supertrend</span><span class=p>(</span><span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span> <span class=n>close</span><span class=p>,</span> <span class=n>period</span><span class=o>=</span><span class=mi>7</span><span class=p>,</span> <span class=n>multiplier</span><span class=o>=</span><span class=mi>3</span><span class=p>):</span>
</span><span id=__span-7-47><a id=__codelineno-7-47 name=__codelineno-7-47 href=#__codelineno-7-47></a><span class=gp>... </span>    <span class=n>med_price</span> <span class=o>=</span> <span class=n>get_med_price</span><span class=p>(</span><span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=p>)</span>
</span><span id=__span-7-48><a id=__codelineno-7-48 name=__codelineno-7-48 href=#__codelineno-7-48></a><span class=gp>... </span>    <span class=n>atr</span> <span class=o>=</span> <span class=n>get_atr</span><span class=p>(</span><span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span> <span class=n>close</span><span class=p>,</span> <span class=n>period</span><span class=p>)</span>
</span><span id=__span-7-49><a id=__codelineno-7-49 name=__codelineno-7-49 href=#__codelineno-7-49></a><span class=gp>... </span>    <span class=n>upper</span><span class=p>,</span> <span class=n>lower</span> <span class=o>=</span> <span class=n>get_basic_bands</span><span class=p>(</span><span class=n>med_price</span><span class=p>,</span> <span class=n>atr</span><span class=p>,</span> <span class=n>multiplier</span><span class=p>)</span>
</span><span id=__span-7-50><a id=__codelineno-7-50 name=__codelineno-7-50 href=#__codelineno-7-50></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>get_final_bands</span><span class=p>(</span><span class=n>close</span><span class=p>,</span> <span class=n>upper</span><span class=p>,</span> <span class=n>lower</span><span class=p>)</span>
</span></code></pre></div> <ol> <li>Take the maximum across three arrays at each time step.</li> <li>Wilder's moving average instead of the standard exponential moving average.</li> <li>This function was heavily inspired by the implementation found in <a href=https://pypi.org/project/pandas-ta/ >Pandas TA</a>.</li> <li>As in the real world, iterate over the entire data one step at a time.</li> </ol> <p>Let's run the <code>supertrend</code> function on the <code>BTCUSDT</code> symbol:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>supert</span><span class=p>,</span> <span class=n>superd</span><span class=p>,</span> <span class=n>superl</span><span class=p>,</span> <span class=n>supers</span> <span class=o>=</span> <span class=n>supertrend</span><span class=p>(</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=gp>... </span>    <span class=n>high</span><span class=p>[</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>],</span> 
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=gp>... </span>    <span class=n>low</span><span class=p>[</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>],</span> 
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=gp>... </span>    <span class=n>close</span><span class=p>[</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>]</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>supert</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=go>Open time</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a><span class=go>2020-01-01 00:00:00+00:00             NaN</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a><span class=go>2020-01-01 01:00:00+00:00             NaN</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a><span class=go>2020-01-01 02:00:00+00:00             NaN</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a><span class=go>                                      ...</span>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a><span class=go>2021-12-31 21:00:00+00:00    47608.346563</span>
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a><span class=go>2021-12-31 22:00:00+00:00    47608.346563</span>
</span><span id=__span-8-15><a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a><span class=go>2021-12-31 23:00:00+00:00    47608.346563</span>
</span><span id=__span-8-16><a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a><span class=go>Length: 17513, dtype: float64</span>
</span><span id=__span-8-17><a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a>
</span><span id=__span-8-18><a id=__codelineno-8-18 name=__codelineno-8-18 href=#__codelineno-8-18></a><span class=gp>&gt;&gt;&gt; </span><span class=n>superd</span>  <span class=c1># (1)!</span>
</span><span id=__span-8-19><a id=__codelineno-8-19 name=__codelineno-8-19 href=#__codelineno-8-19></a><span class=go>Open time</span>
</span><span id=__span-8-20><a id=__codelineno-8-20 name=__codelineno-8-20 href=#__codelineno-8-20></a><span class=go>2020-01-01 00:00:00+00:00    1</span>
</span><span id=__span-8-21><a id=__codelineno-8-21 name=__codelineno-8-21 href=#__codelineno-8-21></a><span class=go>2020-01-01 01:00:00+00:00    1</span>
</span><span id=__span-8-22><a id=__codelineno-8-22 name=__codelineno-8-22 href=#__codelineno-8-22></a><span class=go>2020-01-01 02:00:00+00:00    1</span>
</span><span id=__span-8-23><a id=__codelineno-8-23 name=__codelineno-8-23 href=#__codelineno-8-23></a><span class=go>                           ...</span>
</span><span id=__span-8-24><a id=__codelineno-8-24 name=__codelineno-8-24 href=#__codelineno-8-24></a><span class=go>2021-12-31 21:00:00+00:00   -1</span>
</span><span id=__span-8-25><a id=__codelineno-8-25 name=__codelineno-8-25 href=#__codelineno-8-25></a><span class=go>2021-12-31 22:00:00+00:00   -1</span>
</span><span id=__span-8-26><a id=__codelineno-8-26 name=__codelineno-8-26 href=#__codelineno-8-26></a><span class=go>2021-12-31 23:00:00+00:00   -1</span>
</span><span id=__span-8-27><a id=__codelineno-8-27 name=__codelineno-8-27 href=#__codelineno-8-27></a><span class=go>Length: 17513, dtype: int64</span>
</span><span id=__span-8-28><a id=__codelineno-8-28 name=__codelineno-8-28 href=#__codelineno-8-28></a>
</span><span id=__span-8-29><a id=__codelineno-8-29 name=__codelineno-8-29 href=#__codelineno-8-29></a><span class=gp>&gt;&gt;&gt; </span><span class=n>superl</span>  <span class=c1># (2)!</span>
</span><span id=__span-8-30><a id=__codelineno-8-30 name=__codelineno-8-30 href=#__codelineno-8-30></a><span class=go>Open time</span>
</span><span id=__span-8-31><a id=__codelineno-8-31 name=__codelineno-8-31 href=#__codelineno-8-31></a><span class=go>2020-01-01 00:00:00+00:00   NaN</span>
</span><span id=__span-8-32><a id=__codelineno-8-32 name=__codelineno-8-32 href=#__codelineno-8-32></a><span class=go>2020-01-01 01:00:00+00:00   NaN</span>
</span><span id=__span-8-33><a id=__codelineno-8-33 name=__codelineno-8-33 href=#__codelineno-8-33></a><span class=go>2020-01-01 02:00:00+00:00   NaN</span>
</span><span id=__span-8-34><a id=__codelineno-8-34 name=__codelineno-8-34 href=#__codelineno-8-34></a><span class=go>                            ...</span>
</span><span id=__span-8-35><a id=__codelineno-8-35 name=__codelineno-8-35 href=#__codelineno-8-35></a><span class=go>2021-12-31 21:00:00+00:00   NaN</span>
</span><span id=__span-8-36><a id=__codelineno-8-36 name=__codelineno-8-36 href=#__codelineno-8-36></a><span class=go>2021-12-31 22:00:00+00:00   NaN</span>
</span><span id=__span-8-37><a id=__codelineno-8-37 name=__codelineno-8-37 href=#__codelineno-8-37></a><span class=go>2021-12-31 23:00:00+00:00   NaN</span>
</span><span id=__span-8-38><a id=__codelineno-8-38 name=__codelineno-8-38 href=#__codelineno-8-38></a><span class=go>Length: 17513, dtype: float64</span>
</span><span id=__span-8-39><a id=__codelineno-8-39 name=__codelineno-8-39 href=#__codelineno-8-39></a>
</span><span id=__span-8-40><a id=__codelineno-8-40 name=__codelineno-8-40 href=#__codelineno-8-40></a><span class=gp>&gt;&gt;&gt; </span><span class=n>supers</span>  <span class=c1># (3)!</span>
</span><span id=__span-8-41><a id=__codelineno-8-41 name=__codelineno-8-41 href=#__codelineno-8-41></a><span class=go>Open time</span>
</span><span id=__span-8-42><a id=__codelineno-8-42 name=__codelineno-8-42 href=#__codelineno-8-42></a><span class=go>2020-01-01 00:00:00+00:00             NaN</span>
</span><span id=__span-8-43><a id=__codelineno-8-43 name=__codelineno-8-43 href=#__codelineno-8-43></a><span class=go>2020-01-01 01:00:00+00:00             NaN</span>
</span><span id=__span-8-44><a id=__codelineno-8-44 name=__codelineno-8-44 href=#__codelineno-8-44></a><span class=go>2020-01-01 02:00:00+00:00             NaN</span>
</span><span id=__span-8-45><a id=__codelineno-8-45 name=__codelineno-8-45 href=#__codelineno-8-45></a><span class=go>                                      ...</span>
</span><span id=__span-8-46><a id=__codelineno-8-46 name=__codelineno-8-46 href=#__codelineno-8-46></a><span class=go>2021-12-31 21:00:00+00:00    47608.346563</span>
</span><span id=__span-8-47><a id=__codelineno-8-47 name=__codelineno-8-47 href=#__codelineno-8-47></a><span class=go>2021-12-31 22:00:00+00:00    47608.346563</span>
</span><span id=__span-8-48><a id=__codelineno-8-48 name=__codelineno-8-48 href=#__codelineno-8-48></a><span class=go>2021-12-31 23:00:00+00:00    47608.346563</span>
</span><span id=__span-8-49><a id=__codelineno-8-49 name=__codelineno-8-49 href=#__codelineno-8-49></a><span class=go>Length: 17513, dtype: float64</span>
</span></code></pre></div> <ol> <li>1 = uptrend, -1 = downtrend.</li> <li>Any positive value = uptrend, NaN = downtrend or unknown.</li> <li>Any positive value = downtrend, NaN = uptrend or unknown.</li> </ol> <p>If you print out the head of the <code>supert</code> Series using <code>supert.head(10)</code>, you will notice that the first 6 data points are all NaN. This is because ATR's rolling period is 7, so the first 6 computed windows have incomplete data.</p> <p>A graph is worth 1,000 words. Let's plot the first month of data (January 2020):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>date_range</span> <span class=o>=</span> <span class=nb>slice</span><span class=p>(</span><span class=s1>&#39;2020-01-01&#39;</span><span class=p>,</span> <span class=s1>&#39;2020-02-01&#39;</span><span class=p>)</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span> <span class=o>=</span> <span class=n>close</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>date_range</span><span class=p>,</span> <span class=s1>&#39;BTCUSDT&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=s1>&#39;Close&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>plot</span><span class=p>()</span>  <span class=c1># (1)!</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>supers</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>date_range</span><span class=p>]</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=s1>&#39;Short&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>fig</span><span class=o>=</span><span class=n>fig</span><span class=p>)</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>superl</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>date_range</span><span class=p>]</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=s1>&#39;Long&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>fig</span><span class=o>=</span><span class=n>fig</span><span class=p>)</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <ol> <li>Using <a href=https://vectorbt.pro/pvt_41531c19/api/generic/accessors/#vectorbtpro.generic.accessors.GenericAccessor.plot>GenericAccessor.plot</a>.</li> </ol> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/supertrend/pandas.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/supertrend/pandas.dark.svg#only-dark></p> <p>We have generated and visualized the SuperTrend values, but what about performance? Can we already get our overfitting machine running with thousands of parameter combinations? Not so fast. As you might have guessed, the <code>supertrend</code> function takes some time to compute:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=gp>&gt;&gt;&gt; </span><span class=o>%%</span><span class=n>timeit</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>supertrend</span><span class=p>(</span><span class=n>high</span><span class=p>[</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>],</span> <span class=n>low</span><span class=p>[</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>],</span> <span class=n>close</span><span class=p>[</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>])</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=go>2.15 s ± 19.3 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</span></code></pre></div> <p>Ouch! Running 1000 backtests would take roughly 33 minutes.</p> <p>Let's see what Pandas TA has to say about this:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>SUPERTREND</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pandas_ta</span><span class=p>(</span><span class=s1>&#39;SUPERTREND&#39;</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=gp>&gt;&gt;&gt; </span><span class=o>%%</span><span class=n>timeit</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>SUPERTREND</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>high</span><span class=p>[</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>],</span> <span class=n>low</span><span class=p>[</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>],</span> <span class=n>close</span><span class=p>[</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>])</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=go>784 ms ± 14.3 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</span></code></pre></div> <ol> <li><a href=https://vectorbt.pro/pvt_41531c19/api/indicators/factory/#vectorbtpro.indicators.factory.IndicatorFactory.from_pandas_ta>IndicatorFactory.from_pandas_ta</a>, or the <code>vbt.pandas_ta</code> shortcut, is VBT's function to wrap any Pandas TA indicator so that it can take multiple columns and parameter combinations.</li> </ol> <p>That's a 3x speedup, mainly because Pandas TA uses ATR from TA-Lib.</p> <p>Is this now acceptable? Of course not <img alt=💢 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f4a2.svg title=:anger:> Can we do better than this? Absolutely!</p> <h3 id=numpy-numba>NumPy + Numba = <img alt=❤ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2764.svg title=:heart:><a class=headerlink href=#numpy-numba title="Permanent link">&para;</a></h3> <p>Pandas excels at manipulating heterogeneous tabular data, but is it really suitable for indicators? You might have noticed that even though we used Pandas, none of the operations in our newly defined functions use index or column labels. Additionally, most indicators take, manipulate, and return arrays of the same dimensions and shape. This makes indicator development a purely algebraic problem that can be broken down into multiple vectorized steps or solved on a per-element basis (or both!). Since Pandas extends NumPy, and NumPy is considered a faster (though lower-level) package, let's adapt our logic to NumPy arrays instead.</p> <p>Both <code>get_med_price</code> and <code>get_basic_bands</code> use simple arithmetic operations like addition and multiplication, which can be performed on both Pandas and NumPy arrays and require no further changes. What about <code>get_atr</code> and <code>get_final_bands</code>? The former can be re-implemented using NumPy and VBT's own set of Numba-compiled functions:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>get_atr_np</span><span class=p>(</span><span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span> <span class=n>close</span><span class=p>,</span> <span class=n>period</span><span class=p>):</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=gp>... </span>    <span class=n>shifted_close</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>fshift_1d_nb</span><span class=p>(</span><span class=n>close</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=gp>... </span>    <span class=n>tr0</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>high</span> <span class=o>-</span> <span class=n>low</span><span class=p>)</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=gp>... </span>    <span class=n>tr1</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>high</span> <span class=o>-</span> <span class=n>shifted_close</span><span class=p>)</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a><span class=gp>... </span>    <span class=n>tr2</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>low</span> <span class=o>-</span> <span class=n>shifted_close</span><span class=p>)</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=gp>... </span>    <span class=n>tr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>column_stack</span><span class=p>((</span><span class=n>tr0</span><span class=p>,</span> <span class=n>tr1</span><span class=p>,</span> <span class=n>tr2</span><span class=p>))</span><span class=o>.</span><span class=n>max</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a><span class=gp>... </span>    <span class=n>atr</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>wwm_mean_1d_nb</span><span class=p>(</span><span class=n>tr</span><span class=p>,</span> <span class=n>period</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>atr</span>
</span></code></pre></div> <ol> <li>Uses <a href=https://vectorbt.pro/pvt_41531c19/api/generic/nb/base/#vectorbtpro.generic.nb.base.fshift_1d_nb>fshift_1d_nb</a>, which shifts one-dimensional data by one to <code>n</code> elements forward.</li> <li>Like Pandas, this concatenates three arrays as columns and finds the maximum at each time step.</li> <li>Uses <a href=https://vectorbt.pro/pvt_41531c19/api/generic/nb/rolling/#vectorbtpro.generic.nb.rolling.wwm_mean_1d_nb>wwm_mean_1d_nb</a>, which calculates Wilder's exponentially weighted moving average on one-dimensional data.</li> </ol> <p>The latter, on the other hand, is an iterative algorithm. While this isn't ideal for NumPy, it's a perfect use case for Numba, which can easily run for-loops at machine code speed:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>get_final_bands_nb</span><span class=p>(</span><span class=n>close</span><span class=p>,</span> <span class=n>upper</span><span class=p>,</span> <span class=n>lower</span><span class=p>):</span>  <span class=c1># (1)!</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=gp>... </span>    <span class=n>trend</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=gp>... </span>    <span class=n>dir_</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=gp>... </span>    <span class=n>long</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=gp>... </span>    <span class=n>short</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=gp>... </span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>close</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>upper</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]:</span>  <span class=c1># (3)!</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a><span class=gp>... </span>            <span class=n>dir_</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a><span class=gp>... </span>        <span class=k>elif</span> <span class=n>close</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>lower</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]:</span>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12 href=#__codelineno-13-12></a><span class=gp>... </span>            <span class=n>dir_</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13 href=#__codelineno-13-13></a><span class=gp>... </span>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14 href=#__codelineno-13-14></a><span class=gp>... </span>            <span class=n>dir_</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>dir_</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span>
</span><span id=__span-13-15><a id=__codelineno-13-15 name=__codelineno-13-15 href=#__codelineno-13-15></a><span class=gp>... </span>            <span class=k>if</span> <span class=n>dir_</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>lower</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>lower</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]:</span>
</span><span id=__span-13-16><a id=__codelineno-13-16 name=__codelineno-13-16 href=#__codelineno-13-16></a><span class=gp>... </span>                <span class=n>lower</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>lower</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span>
</span><span id=__span-13-17><a id=__codelineno-13-17 name=__codelineno-13-17 href=#__codelineno-13-17></a><span class=gp>... </span>            <span class=k>if</span> <span class=n>dir_</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>upper</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>upper</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]:</span>
</span><span id=__span-13-18><a id=__codelineno-13-18 name=__codelineno-13-18 href=#__codelineno-13-18></a><span class=gp>... </span>                <span class=n>upper</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>upper</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span>
</span><span id=__span-13-19><a id=__codelineno-13-19 name=__codelineno-13-19 href=#__codelineno-13-19></a><span class=gp>... </span>
</span><span id=__span-13-20><a id=__codelineno-13-20 name=__codelineno-13-20 href=#__codelineno-13-20></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>dir_</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-13-21><a id=__codelineno-13-21 name=__codelineno-13-21 href=#__codelineno-13-21></a><span class=gp>... </span>            <span class=n>trend</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>long</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>lower</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-13-22><a id=__codelineno-13-22 name=__codelineno-13-22 href=#__codelineno-13-22></a><span class=gp>... </span>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-13-23><a id=__codelineno-13-23 name=__codelineno-13-23 href=#__codelineno-13-23></a><span class=gp>... </span>            <span class=n>trend</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>short</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>upper</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-13-24><a id=__codelineno-13-24 name=__codelineno-13-24 href=#__codelineno-13-24></a><span class=gp>... </span>            
</span><span id=__span-13-25><a id=__codelineno-13-25 name=__codelineno-13-25 href=#__codelineno-13-25></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>trend</span><span class=p>,</span> <span class=n>dir_</span><span class=p>,</span> <span class=n>long</span><span class=p>,</span> <span class=n>short</span>
</span></code></pre></div> <ol> <li>The <code>nb</code> suffix is commonly used in VBT for Numba-compiled functions.</li> <li>Removed use of <code>pd.Series</code> everywhere.</li> <li>Replaced all <code>iloc</code> usages.</li> </ol> <p>If you look at the function above, you will see that 1) it is regular Python code that can run even without the <code>@njit</code> decorator, and 2) it's almost identical to the Pandas implementation, except each <code>iloc[...]</code> is replaced by <code>[...]</code>. We can write a simple Python function that works on constants and NumPy arrays, and Numba will try to make it <strong>much</strong> faster—fully automatically. Isn't that impressive?</p> <p>Let's look at the result of this refactoring:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>faster_supertrend</span><span class=p>(</span><span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span> <span class=n>close</span><span class=p>,</span> <span class=n>period</span><span class=o>=</span><span class=mi>7</span><span class=p>,</span> <span class=n>multiplier</span><span class=o>=</span><span class=mi>3</span><span class=p>):</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=gp>... </span>    <span class=n>med_price</span> <span class=o>=</span> <span class=n>get_med_price</span><span class=p>(</span><span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=p>)</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=gp>... </span>    <span class=n>atr</span> <span class=o>=</span> <span class=n>get_atr_np</span><span class=p>(</span><span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span> <span class=n>close</span><span class=p>,</span> <span class=n>period</span><span class=p>)</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=gp>... </span>    <span class=n>upper</span><span class=p>,</span> <span class=n>lower</span> <span class=o>=</span> <span class=n>get_basic_bands</span><span class=p>(</span><span class=n>med_price</span><span class=p>,</span> <span class=n>atr</span><span class=p>,</span> <span class=n>multiplier</span><span class=p>)</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>get_final_bands_nb</span><span class=p>(</span><span class=n>close</span><span class=p>,</span> <span class=n>upper</span><span class=p>,</span> <span class=n>lower</span><span class=p>)</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>supert</span><span class=p>,</span> <span class=n>superd</span><span class=p>,</span> <span class=n>superl</span><span class=p>,</span> <span class=n>supers</span> <span class=o>=</span> <span class=n>faster_supertrend</span><span class=p>(</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a><span class=gp>... </span>    <span class=n>high</span><span class=p>[</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a><span class=gp>... </span>    <span class=n>low</span><span class=p>[</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=gp>... </span>    <span class=n>close</span><span class=p>[</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>supert</span>
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14 href=#__codelineno-14-14></a><span class=go>array([          nan,           nan,           nan, ..., 47608.3465635,</span>
</span><span id=__span-14-15><a id=__codelineno-14-15 name=__codelineno-14-15 href=#__codelineno-14-15></a><span class=go>       47608.3465635, 47608.3465635])</span>
</span><span id=__span-14-16><a id=__codelineno-14-16 name=__codelineno-14-16 href=#__codelineno-14-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>superd</span>
</span><span id=__span-14-17><a id=__codelineno-14-17 name=__codelineno-14-17 href=#__codelineno-14-17></a><span class=go>array([ 1,  1,  1, ..., -1, -1, -1])</span>
</span><span id=__span-14-18><a id=__codelineno-14-18 name=__codelineno-14-18 href=#__codelineno-14-18></a>
</span><span id=__span-14-19><a id=__codelineno-14-19 name=__codelineno-14-19 href=#__codelineno-14-19></a><span class=gp>&gt;&gt;&gt; </span><span class=n>superl</span>
</span><span id=__span-14-20><a id=__codelineno-14-20 name=__codelineno-14-20 href=#__codelineno-14-20></a><span class=go>array([nan, nan, nan, ..., nan, nan, nan])</span>
</span><span id=__span-14-21><a id=__codelineno-14-21 name=__codelineno-14-21 href=#__codelineno-14-21></a>
</span><span id=__span-14-22><a id=__codelineno-14-22 name=__codelineno-14-22 href=#__codelineno-14-22></a><span class=gp>&gt;&gt;&gt; </span><span class=n>supers</span>
</span><span id=__span-14-23><a id=__codelineno-14-23 name=__codelineno-14-23 href=#__codelineno-14-23></a><span class=go>array([          nan,           nan,           nan, ..., 47608.3465635,</span>
</span><span id=__span-14-24><a id=__codelineno-14-24 name=__codelineno-14-24 href=#__codelineno-14-24></a><span class=go>       47608.3465635, 47608.3465635])</span>
</span></code></pre></div> <ol> <li>Access the NumPy array of any Pandas object using <code>values</code>.</li> </ol> <div class="admonition info"> <p class=admonition-title>Info</p> <p>When calling a Numba-decorated function for the first time, execution may take longer due to compilation.</p> </div> <p>As expected, these are arrays similar to the ones returned by the <code>supertrend</code> function, just without any labels. To attach labels, simply do:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>(</span><span class=n>supert</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=n>close</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=go>Open time</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=go>2020-01-01 00:00:00+00:00             NaN</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=go>2020-01-01 01:00:00+00:00             NaN</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=go>2020-01-01 02:00:00+00:00             NaN</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a><span class=go>                                      ...</span>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a><span class=go>2021-12-31 21:00:00+00:00    47608.346563</span>
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a><span class=go>2021-12-31 22:00:00+00:00    47608.346563</span>
</span><span id=__span-15-9><a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a><span class=go>2021-12-31 23:00:00+00:00    47608.346563</span>
</span><span id=__span-15-10><a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a><span class=go>Length: 17513, dtype: float64</span>
</span></code></pre></div> <p>Curious how much our code has improved in performance? Here is the answer:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=go>%%timeit</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>faster_supertrend</span><span class=p>(</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=gp>... </span>    <span class=n>high</span><span class=p>[</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=gp>... </span>    <span class=n>low</span><span class=p>[</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=gp>... </span>    <span class=n>close</span><span class=p>[</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=go>1.11 ms ± 7.05 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)</span>
</span></code></pre></div> <p>That's a 780x speedup over a typical Pandas TA run <img alt=😈 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f608.svg title=:smiling_imp:></p> <h3 id=numpy-numba-talib>NumPy + Numba + TA-Lib = <img alt=⚡ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26a1.svg title=:zap:><a class=headerlink href=#numpy-numba-talib title="Permanent link">&para;</a></h3> <p>If you think this result can't be improved, you may not have tried working with TA-Lib. Even though TA-Lib does not provide a SuperTrend indicator, we can still use its highly optimized functions for intermediate calculations. Specifically, instead of reinventing the wheel by implementing median price and ATR from scratch, we can use the <code>MEDPRICE</code> and <code>ATR</code> TA-Lib functions. They provide two major advantages over our custom implementations:</p> <ol> <li>Single pass through the data.</li> <li>No Numba compilation overhead.</li> </ol> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=gp>&gt;&gt;&gt; </span><span class=kn>import</span><span class=w> </span><span class=nn>talib</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>faster_supertrend_talib</span><span class=p>(</span><span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span> <span class=n>close</span><span class=p>,</span> <span class=n>period</span><span class=o>=</span><span class=mi>7</span><span class=p>,</span> <span class=n>multiplier</span><span class=o>=</span><span class=mi>3</span><span class=p>):</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=gp>... </span>    <span class=n>avg_price</span> <span class=o>=</span> <span class=n>talib</span><span class=o>.</span><span class=n>MEDPRICE</span><span class=p>(</span><span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=gp>... </span>    <span class=n>atr</span> <span class=o>=</span> <span class=n>talib</span><span class=o>.</span><span class=n>ATR</span><span class=p>(</span><span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span> <span class=n>close</span><span class=p>,</span> <span class=n>period</span><span class=p>)</span>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=gp>... </span>    <span class=n>upper</span><span class=p>,</span> <span class=n>lower</span> <span class=o>=</span> <span class=n>get_basic_bands</span><span class=p>(</span><span class=n>avg_price</span><span class=p>,</span> <span class=n>atr</span><span class=p>,</span> <span class=n>multiplier</span><span class=p>)</span>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>get_final_bands_nb</span><span class=p>(</span><span class=n>close</span><span class=p>,</span> <span class=n>upper</span><span class=p>,</span> <span class=n>lower</span><span class=p>)</span>
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a>
</span><span id=__span-17-9><a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>faster_supertrend_talib</span><span class=p>(</span>
</span><span id=__span-17-10><a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a><span class=gp>... </span>    <span class=n>high</span><span class=p>[</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-17-11><a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a><span class=gp>... </span>    <span class=n>low</span><span class=p>[</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-17-12><a id=__codelineno-17-12 name=__codelineno-17-12 href=#__codelineno-17-12></a><span class=gp>... </span>    <span class=n>close</span><span class=p>[</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-17-13><a id=__codelineno-17-13 name=__codelineno-17-13 href=#__codelineno-17-13></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-17-14><a id=__codelineno-17-14 name=__codelineno-17-14 href=#__codelineno-17-14></a><span class=go>(array([          nan,           nan,           nan, ..., 47608.3465635,</span>
</span><span id=__span-17-15><a id=__codelineno-17-15 name=__codelineno-17-15 href=#__codelineno-17-15></a><span class=go>        47608.3465635, 47608.3465635]),</span>
</span><span id=__span-17-16><a id=__codelineno-17-16 name=__codelineno-17-16 href=#__codelineno-17-16></a><span class=go> array([ 1,  1,  1, ..., -1, -1, -1]),</span>
</span><span id=__span-17-17><a id=__codelineno-17-17 name=__codelineno-17-17 href=#__codelineno-17-17></a><span class=go> array([nan, nan, nan, ..., nan, nan, nan]),</span>
</span><span id=__span-17-18><a id=__codelineno-17-18 name=__codelineno-17-18 href=#__codelineno-17-18></a><span class=go> array([          nan,           nan,           nan, ..., 47608.3465635,</span>
</span><span id=__span-17-19><a id=__codelineno-17-19 name=__codelineno-17-19 href=#__codelineno-17-19></a><span class=go>        47608.3465635, 47608.3465635]))</span>
</span><span id=__span-17-20><a id=__codelineno-17-20 name=__codelineno-17-20 href=#__codelineno-17-20></a>
</span><span id=__span-17-21><a id=__codelineno-17-21 name=__codelineno-17-21 href=#__codelineno-17-21></a><span class=gp>&gt;&gt;&gt; </span><span class=o>%%</span><span class=n>timeit</span>
</span><span id=__span-17-22><a id=__codelineno-17-22 name=__codelineno-17-22 href=#__codelineno-17-22></a><span class=gp>&gt;&gt;&gt; </span><span class=n>faster_supertrend_talib</span><span class=p>(</span>
</span><span id=__span-17-23><a id=__codelineno-17-23 name=__codelineno-17-23 href=#__codelineno-17-23></a><span class=gp>... </span>    <span class=n>high</span><span class=p>[</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-17-24><a id=__codelineno-17-24 name=__codelineno-17-24 href=#__codelineno-17-24></a><span class=gp>... </span>    <span class=n>low</span><span class=p>[</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-17-25><a id=__codelineno-17-25 name=__codelineno-17-25 href=#__codelineno-17-25></a><span class=gp>... </span>    <span class=n>close</span><span class=p>[</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-17-26><a id=__codelineno-17-26 name=__codelineno-17-26 href=#__codelineno-17-26></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-17-27><a id=__codelineno-17-27 name=__codelineno-17-27 href=#__codelineno-17-27></a><span class=go>253 µs ± 815 ns per loop (mean ± std. dev. of 7 runs, 1000 loops each)</span>
</span></code></pre></div> <ol> <li>See <a href=https://github.com/TA-Lib/ta-lib/blob/main/docs/functions.md>TA-Lib Functions</a>.</li> </ol> <p>That's another 4x improvement. By the time another trader processes a single column of data, we could have processed about three thousand columns. Admittedly, the speed of our indicator is getting ridiculously high <img alt=😄 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f604.svg title=:smile:></p> <h2 id=indicator-factory>Indicator factory<a class=headerlink href=#indicator-factory title="Permanent link">&para;</a></h2> <p>Let's pause here and consider: why do we need such high performance?</p> <p>This is where parameter optimization becomes important. The two parameters we have, <code>period</code> and <code>multiplier</code>, are the default values commonly used in technical analysis. However, what makes these values universal, and how do we know there are not better values for the markets we are in? Imagine having a pipeline that can backtest hundreds or even thousands of parameter combinations, uncovering configurations and market regimes that, on average, correlate better.</p> <p><a href=https://vectorbt.pro/pvt_41531c19/api/indicators/factory/#vectorbtpro.indicators.factory.IndicatorFactory>IndicatorFactory</a> is VBT's own powerhouse for making any indicator function fully parametrizable. To better understand what this means, let's supercharge the <code>faster_supertrend_talib</code> function:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>SuperTrend</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>IF</span><span class=p>(</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=gp>... </span>    <span class=n>class_name</span><span class=o>=</span><span class=s1>&#39;SuperTrend&#39;</span><span class=p>,</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=gp>... </span>    <span class=n>short_name</span><span class=o>=</span><span class=s1>&#39;st&#39;</span><span class=p>,</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=gp>... </span>    <span class=n>input_names</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>],</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=gp>... </span>    <span class=n>param_names</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;period&#39;</span><span class=p>,</span> <span class=s1>&#39;multiplier&#39;</span><span class=p>],</span>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a><span class=gp>... </span>    <span class=n>output_names</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;supert&#39;</span><span class=p>,</span> <span class=s1>&#39;superd&#39;</span><span class=p>,</span> <span class=s1>&#39;superl&#39;</span><span class=p>,</span> <span class=s1>&#39;supers&#39;</span><span class=p>]</span>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a><span class=gp>... </span><span class=p>)</span><span class=o>.</span><span class=n>with_apply_func</span><span class=p>(</span>
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a><span class=gp>... </span>    <span class=n>faster_supertrend_talib</span><span class=p>,</span> 
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a><span class=gp>... </span>    <span class=n>takes_1d</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-18-10><a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a><span class=gp>... </span>    <span class=n>period</span><span class=o>=</span><span class=mi>7</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-18-11><a id=__codelineno-18-11 name=__codelineno-18-11 href=#__codelineno-18-11></a><span class=gp>... </span>    <span class=n>multiplier</span><span class=o>=</span><span class=mi>3</span>
</span><span id=__span-18-12><a id=__codelineno-18-12 name=__codelineno-18-12 href=#__codelineno-18-12></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <ol> <li>Our function only accepts one-dimensional arrays.</li> <li>Default parameter values.</li> </ol> <p>The indicator factory is a class that can generate what are known as indicator classes. You can think of it as a conveyor belt that takes the specification of your indicator function and produces a standalone Python class for running that function in a very flexible way. In our example, when we called <code>vbt.IF(...)</code>, it internally created the indicator class <code>SuperTrend</code>. Once we supplied <code>faster_supertrend_talib</code> to <a href=https://vectorbt.pro/pvt_41531c19/api/indicators/factory/#vectorbtpro.indicators.factory.IndicatorFactory.with_apply_func>IndicatorFactory.with_apply_func</a>, it attached a <code>SuperTrend.run</code> method for running the indicator. Let's try it out!</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>phelp</span><span class=p>(</span><span class=n>SuperTrend</span><span class=o>.</span><span class=n>run</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=go>SuperTrend.run(</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=go>    high,</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=go>    low,</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=go>    close,</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=go>    period=Default(value=7),</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a><span class=go>    multiplier=Default(value=3),</span>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a><span class=go>    short_name=&#39;st&#39;,</span>
</span><span id=__span-19-9><a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a><span class=go>    hide_params=None,</span>
</span><span id=__span-19-10><a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a><span class=go>    hide_default=True,</span>
</span><span id=__span-19-11><a id=__codelineno-19-11 name=__codelineno-19-11 href=#__codelineno-19-11></a><span class=go>    **kwargs</span>
</span><span id=__span-19-12><a id=__codelineno-19-12 name=__codelineno-19-12 href=#__codelineno-19-12></a><span class=go>):</span>
</span><span id=__span-19-13><a id=__codelineno-19-13 name=__codelineno-19-13 href=#__codelineno-19-13></a><span class=go>    Run `SuperTrend` indicator.</span>
</span><span id=__span-19-14><a id=__codelineno-19-14 name=__codelineno-19-14 href=#__codelineno-19-14></a>
</span><span id=__span-19-15><a id=__codelineno-19-15 name=__codelineno-19-15 href=#__codelineno-19-15></a><span class=go>    * Inputs: `high`, `low`, `close`</span>
</span><span id=__span-19-16><a id=__codelineno-19-16 name=__codelineno-19-16 href=#__codelineno-19-16></a><span class=go>    * Parameters: `period`, `multiplier`</span>
</span><span id=__span-19-17><a id=__codelineno-19-17 name=__codelineno-19-17 href=#__codelineno-19-17></a><span class=go>    * Outputs: `supert`, `superd`, `superl`, `supers`</span>
</span><span id=__span-19-18><a id=__codelineno-19-18 name=__codelineno-19-18 href=#__codelineno-19-18></a>
</span><span id=__span-19-19><a id=__codelineno-19-19 name=__codelineno-19-19 href=#__codelineno-19-19></a><span class=go>    Pass a list of parameter names as `hide_params` to hide their column levels.</span>
</span><span id=__span-19-20><a id=__codelineno-19-20 name=__codelineno-19-20 href=#__codelineno-19-20></a><span class=go>    Set `hide_default` to False to show the column levels of the parameters with a default value.</span>
</span><span id=__span-19-21><a id=__codelineno-19-21 name=__codelineno-19-21 href=#__codelineno-19-21></a>
</span><span id=__span-19-22><a id=__codelineno-19-22 name=__codelineno-19-22 href=#__codelineno-19-22></a><span class=go>    Other keyword arguments are passed to `SuperTrend.run_pipeline`.</span>
</span><span id=__span-19-23><a id=__codelineno-19-23 name=__codelineno-19-23 href=#__codelineno-19-23></a>
</span><span id=__span-19-24><a id=__codelineno-19-24 name=__codelineno-19-24 href=#__codelineno-19-24></a><span class=gp>&gt;&gt;&gt; </span><span class=n>st</span> <span class=o>=</span> <span class=n>SuperTrend</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span> <span class=n>close</span><span class=p>)</span>
</span><span id=__span-19-25><a id=__codelineno-19-25 name=__codelineno-19-25 href=#__codelineno-19-25></a><span class=gp>&gt;&gt;&gt; </span><span class=n>st</span><span class=o>.</span><span class=n>supert</span>
</span><span id=__span-19-26><a id=__codelineno-19-26 name=__codelineno-19-26 href=#__codelineno-19-26></a><span class=go>symbol                          BTCUSDT      ETHUSDT</span>
</span><span id=__span-19-27><a id=__codelineno-19-27 name=__codelineno-19-27 href=#__codelineno-19-27></a><span class=go>Open time                                           </span>
</span><span id=__span-19-28><a id=__codelineno-19-28 name=__codelineno-19-28 href=#__codelineno-19-28></a><span class=go>2020-01-01 00:00:00+00:00           NaN          NaN</span>
</span><span id=__span-19-29><a id=__codelineno-19-29 name=__codelineno-19-29 href=#__codelineno-19-29></a><span class=go>2020-01-01 01:00:00+00:00           NaN          NaN</span>
</span><span id=__span-19-30><a id=__codelineno-19-30 name=__codelineno-19-30 href=#__codelineno-19-30></a><span class=go>2020-01-01 02:00:00+00:00           NaN          NaN</span>
</span><span id=__span-19-31><a id=__codelineno-19-31 name=__codelineno-19-31 href=#__codelineno-19-31></a><span class=go>...                                 ...          ...</span>
</span><span id=__span-19-32><a id=__codelineno-19-32 name=__codelineno-19-32 href=#__codelineno-19-32></a><span class=go>2021-12-31 21:00:00+00:00  47608.346563  3770.258246</span>
</span><span id=__span-19-33><a id=__codelineno-19-33 name=__codelineno-19-33 href=#__codelineno-19-33></a><span class=go>2021-12-31 22:00:00+00:00  47608.346563  3770.258246</span>
</span><span id=__span-19-34><a id=__codelineno-19-34 name=__codelineno-19-34 href=#__codelineno-19-34></a><span class=go>2021-12-31 23:00:00+00:00  47608.346563  3770.258246</span>
</span><span id=__span-19-35><a id=__codelineno-19-35 name=__codelineno-19-35 href=#__codelineno-19-35></a>
</span><span id=__span-19-36><a id=__codelineno-19-36 name=__codelineno-19-36 href=#__codelineno-19-36></a><span class=go>[17513 rows x 2 columns]</span>
</span></code></pre></div> <ol> <li>Use <a href=https://vectorbt.pro/pvt_41531c19/api/utils/formatting/#vectorbtpro.utils.formatting.phelp>phelp</a> to see what arguments are accepted by <code>SuperTrend.run</code>.</li> </ol> <p>Notice how our SuperTrend indicator easily accepted two-dimensional Pandas arrays, even though the underlying function can only process one-dimensional NumPy arrays. Not only did it compute the SuperTrend on each column, but it also conveniently converted the resulting arrays back into Pandas format. Now, how does this affect performance?</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=gp>&gt;&gt;&gt; </span><span class=o>%%</span><span class=n>timeit</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>SuperTrend</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span> <span class=n>close</span><span class=p>)</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=go>2 ms ± 130 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)</span>
</span></code></pre></div> <p>Not much! With all the pre- and post-processing involved, the indicator still needs only about one millisecond to process one column (that is, 17k data points).</p> <h3 id=expressions>Expressions<a class=headerlink href=#expressions title="Permanent link">&para;</a></h3> <p>If you feel that calling <code>vbt.IF(...)</code> and manually providing <code>input_names</code>, <code>param_names</code>, and other information is too much work, VBT has a solution. Our <code>faster_supertrend_talib</code> function acts as a black box to the indicator factory, so the factory cannot inspect it or automatically obtain the required information. However, it could easily do so if we converted <code>faster_supertrend_talib</code> into an <a href=https://realpython.com/python-eval-function/ >expression</a>!</p> <p>Expressions are plain strings that can be evaluated as Python code. By passing such a string to <a href=https://vectorbt.pro/pvt_41531c19/api/indicators/factory/#vectorbtpro.indicators.factory.IndicatorFactory.from_expr>IndicatorFactory.from_expr</a>, the factory can look inside, parse the specification, and generate a full-featured indicator class.</p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>Instance methods prefixed with <code>with</code> (such as <code>with_apply_func</code>) require you to provide the specification manually, while class methods prefixed with <code>from</code> (such as <code>from_expr</code>) can parse this information automatically.</p> </div> <p>Here is an expression for <code>faster_supertrend_talib</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>expr</span> <span class=o>=</span> <span class=s2>&quot;&quot;&quot;</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=gp>... </span><span class=s2>SuperTrend[st]:</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=gp>... </span><span class=s2>medprice = @talib_medprice(high, low)</span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=gp>... </span><span class=s2>atr = @talib_atr(high, low, close, @p_period)</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a><span class=gp>... </span><span class=s2>upper, lower = get_basic_bands(medprice, atr, @p_multiplier)</span>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a><span class=gp>... </span><span class=s2>supert, superd, superl, supers = get_final_bands(close, upper, lower)</span>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a><span class=gp>... </span><span class=s2>supert, superd, superl, supers</span>
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a><span class=gp>... </span><span class=s2>&quot;&quot;&quot;</span>
</span></code></pre></div> <p>By using annotations with <code>@</code>, we tell the factory how to treat specific variables. For example, any variable with the prefix <code>@talib</code> gets replaced by the respective TA-Lib function that has been enhanced for broadcasting and multidimensionality. You can also see that parameters are annotated with <code>@p</code>, while inputs and outputs are left unannotated. The factory can determine that <code>high</code> is the high price and, by the last line, that there are four outputs.</p> <p>For more examples, see the documentation on expression parsing.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>SuperTrend</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>IF</span><span class=o>.</span><span class=n>from_expr</span><span class=p>(</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=gp>... </span>    <span class=n>expr</span><span class=p>,</span> 
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a><span class=gp>... </span>    <span class=n>takes_1d</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a><span class=gp>... </span>    <span class=n>get_basic_bands</span><span class=o>=</span><span class=n>get_basic_bands</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a><span class=gp>... </span>    <span class=n>get_final_bands</span><span class=o>=</span><span class=n>get_final_bands_nb</span><span class=p>,</span>
</span><span id=__span-22-6><a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a><span class=gp>... </span>    <span class=n>period</span><span class=o>=</span><span class=mi>7</span><span class=p>,</span> 
</span><span id=__span-22-7><a id=__codelineno-22-7 name=__codelineno-22-7 href=#__codelineno-22-7></a><span class=gp>... </span>    <span class=n>multiplier</span><span class=o>=</span><span class=mi>3</span>
</span><span id=__span-22-8><a id=__codelineno-22-8 name=__codelineno-22-8 href=#__codelineno-22-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-22-9><a id=__codelineno-22-9 name=__codelineno-22-9 href=#__codelineno-22-9></a>
</span><span id=__span-22-10><a id=__codelineno-22-10 name=__codelineno-22-10 href=#__codelineno-22-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>st</span> <span class=o>=</span> <span class=n>SuperTrend</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span> <span class=n>close</span><span class=p>)</span>
</span><span id=__span-22-11><a id=__codelineno-22-11 name=__codelineno-22-11 href=#__codelineno-22-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>st</span><span class=o>.</span><span class=n>supert</span>
</span><span id=__span-22-12><a id=__codelineno-22-12 name=__codelineno-22-12 href=#__codelineno-22-12></a><span class=go>symbol                          BTCUSDT      ETHUSDT</span>
</span><span id=__span-22-13><a id=__codelineno-22-13 name=__codelineno-22-13 href=#__codelineno-22-13></a><span class=go>Open time                                           </span>
</span><span id=__span-22-14><a id=__codelineno-22-14 name=__codelineno-22-14 href=#__codelineno-22-14></a><span class=go>2020-01-01 00:00:00+00:00           NaN          NaN</span>
</span><span id=__span-22-15><a id=__codelineno-22-15 name=__codelineno-22-15 href=#__codelineno-22-15></a><span class=go>2020-01-01 01:00:00+00:00           NaN          NaN</span>
</span><span id=__span-22-16><a id=__codelineno-22-16 name=__codelineno-22-16 href=#__codelineno-22-16></a><span class=go>2020-01-01 02:00:00+00:00           NaN          NaN</span>
</span><span id=__span-22-17><a id=__codelineno-22-17 name=__codelineno-22-17 href=#__codelineno-22-17></a><span class=go>...                                 ...          ...</span>
</span><span id=__span-22-18><a id=__codelineno-22-18 name=__codelineno-22-18 href=#__codelineno-22-18></a><span class=go>2021-12-31 21:00:00+00:00  47608.346563  3770.258246</span>
</span><span id=__span-22-19><a id=__codelineno-22-19 name=__codelineno-22-19 href=#__codelineno-22-19></a><span class=go>2021-12-31 22:00:00+00:00  47608.346563  3770.258246</span>
</span><span id=__span-22-20><a id=__codelineno-22-20 name=__codelineno-22-20 href=#__codelineno-22-20></a><span class=go>2021-12-31 23:00:00+00:00  47608.346563  3770.258246</span>
</span><span id=__span-22-21><a id=__codelineno-22-21 name=__codelineno-22-21 href=#__codelineno-22-21></a>
</span><span id=__span-22-22><a id=__codelineno-22-22 name=__codelineno-22-22 href=#__codelineno-22-22></a><span class=go>[17513 rows x 2 columns]</span>
</span><span id=__span-22-23><a id=__codelineno-22-23 name=__codelineno-22-23 href=#__codelineno-22-23></a>
</span><span id=__span-22-24><a id=__codelineno-22-24 name=__codelineno-22-24 href=#__codelineno-22-24></a><span class=gp>&gt;&gt;&gt; </span><span class=o>%%</span><span class=n>timeit</span>
</span><span id=__span-22-25><a id=__codelineno-22-25 name=__codelineno-22-25 href=#__codelineno-22-25></a><span class=gp>&gt;&gt;&gt; </span><span class=n>SuperTrend</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span> <span class=n>close</span><span class=p>)</span>
</span><span id=__span-22-26><a id=__codelineno-22-26 name=__codelineno-22-26 href=#__codelineno-22-26></a><span class=go>2.35 ms ± 81.3 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)</span>
</span></code></pre></div> <ol> <li>Expressions do not have access to the current global variables to avoid side effects, so we need to specify the objects that are unknown to the expression.</li> </ol> <p>By the way, this is exactly how WorldQuant's Alphas are implemented in VBT. Never stop loving Python for the magic it enables <img alt=✨ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2728.svg title=:sparkles:></p> <h3 id=plotting>Plotting<a class=headerlink href=#plotting title="Permanent link">&para;</a></h3> <p>Remember how we previously plotted SuperTrend? We had to manually select the date range from each output array and add it to the plot by passing the figure around. Let's subclass <code>SuperTrend</code> and define a <code>plot</code> method that handles all this for us:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span><span class=w> </span><span class=nc>SuperTrend</span><span class=p>(</span><span class=n>SuperTrend</span><span class=p>):</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a><span class=gp>... </span>    <span class=k>def</span><span class=w> </span><span class=nf>plot</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> 
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a><span class=gp>... </span>             <span class=n>column</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a><span class=gp>... </span>             <span class=n>close_kwargs</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a><span class=gp>... </span>             <span class=n>superl_kwargs</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span><span id=__span-23-6><a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a><span class=gp>... </span>             <span class=n>supers_kwargs</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span><span id=__span-23-7><a id=__codelineno-23-7 name=__codelineno-23-7 href=#__codelineno-23-7></a><span class=gp>... </span>             <span class=n>fig</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>  <span class=c1># (3)!</span>
</span><span id=__span-23-8><a id=__codelineno-23-8 name=__codelineno-23-8 href=#__codelineno-23-8></a><span class=gp>... </span>             <span class=o>**</span><span class=n>layout_kwargs</span><span class=p>):</span>  <span class=c1># (4)!</span>
</span><span id=__span-23-9><a id=__codelineno-23-9 name=__codelineno-23-9 href=#__codelineno-23-9></a><span class=gp>... </span>        <span class=n>close_kwargs</span> <span class=o>=</span> <span class=n>close_kwargs</span> <span class=k>if</span> <span class=n>close_kwargs</span> <span class=k>else</span> <span class=p>{}</span>
</span><span id=__span-23-10><a id=__codelineno-23-10 name=__codelineno-23-10 href=#__codelineno-23-10></a><span class=gp>... </span>        <span class=n>superl_kwargs</span> <span class=o>=</span> <span class=n>superl_kwargs</span> <span class=k>if</span> <span class=n>superl_kwargs</span> <span class=k>else</span> <span class=p>{}</span>
</span><span id=__span-23-11><a id=__codelineno-23-11 name=__codelineno-23-11 href=#__codelineno-23-11></a><span class=gp>... </span>        <span class=n>supers_kwargs</span> <span class=o>=</span> <span class=n>supers_kwargs</span> <span class=k>if</span> <span class=n>supers_kwargs</span> <span class=k>else</span> <span class=p>{}</span>
</span><span id=__span-23-12><a id=__codelineno-23-12 name=__codelineno-23-12 href=#__codelineno-23-12></a><span class=gp>... </span>        
</span><span id=__span-23-13><a id=__codelineno-23-13 name=__codelineno-23-13 href=#__codelineno-23-13></a><span class=gp>... </span>        <span class=n>close</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>select_col_from_obj</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>close</span><span class=p>,</span> <span class=n>column</span><span class=p>)</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=s1>&#39;Close&#39;</span><span class=p>)</span>
</span><span id=__span-23-14><a id=__codelineno-23-14 name=__codelineno-23-14 href=#__codelineno-23-14></a><span class=gp>... </span>        <span class=n>supers</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>select_col_from_obj</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>supers</span><span class=p>,</span> <span class=n>column</span><span class=p>)</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=s1>&#39;Short&#39;</span><span class=p>)</span>
</span><span id=__span-23-15><a id=__codelineno-23-15 name=__codelineno-23-15 href=#__codelineno-23-15></a><span class=gp>... </span>        <span class=n>superl</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>select_col_from_obj</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>superl</span><span class=p>,</span> <span class=n>column</span><span class=p>)</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=s1>&#39;Long&#39;</span><span class=p>)</span>
</span><span id=__span-23-16><a id=__codelineno-23-16 name=__codelineno-23-16 href=#__codelineno-23-16></a><span class=gp>... </span>        
</span><span id=__span-23-17><a id=__codelineno-23-17 name=__codelineno-23-17 href=#__codelineno-23-17></a><span class=gp>... </span>        <span class=n>fig</span> <span class=o>=</span> <span class=n>close</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>fig</span><span class=o>=</span><span class=n>fig</span><span class=p>,</span> <span class=o>**</span><span class=n>close_kwargs</span><span class=p>,</span> <span class=o>**</span><span class=n>layout_kwargs</span><span class=p>)</span>  <span class=c1># (5)!</span>
</span><span id=__span-23-18><a id=__codelineno-23-18 name=__codelineno-23-18 href=#__codelineno-23-18></a><span class=gp>... </span>        <span class=n>supers</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>fig</span><span class=o>=</span><span class=n>fig</span><span class=p>,</span> <span class=o>**</span><span class=n>supers_kwargs</span><span class=p>)</span>
</span><span id=__span-23-19><a id=__codelineno-23-19 name=__codelineno-23-19 href=#__codelineno-23-19></a><span class=gp>... </span>        <span class=n>superl</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>fig</span><span class=o>=</span><span class=n>fig</span><span class=p>,</span> <span class=o>**</span><span class=n>superl_kwargs</span><span class=p>)</span>
</span><span id=__span-23-20><a id=__codelineno-23-20 name=__codelineno-23-20 href=#__codelineno-23-20></a><span class=gp>... </span>        
</span><span id=__span-23-21><a id=__codelineno-23-21 name=__codelineno-23-21 href=#__codelineno-23-21></a><span class=gp>... </span>        <span class=k>return</span> <span class=n>fig</span>
</span></code></pre></div> <ol> <li>We can plot only one column of data at a time.</li> <li>Keyword arguments with the suffix <code>kwargs</code> can be used to configure the trace, for example, to change the line color.</li> <li>We can pass our own figure.</li> <li>Any additional keyword argument passed to this method can be used to configure the figure layout.</li> <li>Update the layout only once.</li> </ol> <p>How do we choose the date range to plot? It is simple: the indicator factory made <code>SuperTrend</code> indexable just like any regular Pandas object! Let's plot the same date range and symbol, but change the color palette slightly:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>st</span> <span class=o>=</span> <span class=n>SuperTrend</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span> <span class=n>close</span><span class=p>)</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>st</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>date_range</span><span class=p>,</span> <span class=s1>&#39;BTCUSDT&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=gp>... </span>    <span class=n>superl_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>line_color</span><span class=o>=</span><span class=s1>&#39;limegreen&#39;</span><span class=p>)),</span>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=gp>... </span>    <span class=n>supers_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>line_color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>))</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a><span class=gp>... </span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/supertrend/indicator.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/supertrend/indicator.dark.svg#only-dark></p> <p>Beautiful!</p> <h2 id=backtesting>Backtesting<a class=headerlink href=#backtesting title="Permanent link">&para;</a></h2> <p>Backtesting is usually the simplest step in VBT: convert the indicator values into two signal arrays, <code>entries</code> and <code>exits</code>, and pass them to <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a>. To make the test more realistic, let's make a few adjustments. Since we calculate SuperTrend values based on the current close price and VBT executes orders immediately, we will shift the execution of the signals forward by one tick:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entries</span> <span class=o>=</span> <span class=p>(</span><span class=o>~</span><span class=n>st</span><span class=o>.</span><span class=n>superl</span><span class=o>.</span><span class=n>isnull</span><span class=p>())</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>fshift</span><span class=p>()</span>  <span class=c1># (1)!</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span> <span class=o>=</span> <span class=p>(</span><span class=o>~</span><span class=n>st</span><span class=o>.</span><span class=n>supers</span><span class=o>.</span><span class=n>isnull</span><span class=p>())</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>fshift</span><span class=p>()</span>
</span></code></pre></div> <ol> <li>Using <a href=https://vectorbt.pro/pvt_41531c19/api/signals/accessors/#vectorbtpro.signals.accessors.SignalsAccessor.fshift>SignalsAccessor.fshift</a>.</li> </ol> <p>We will also apply a commission of 0.1%:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=n>close</span><span class=p>,</span> 
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>entries</span><span class=p>,</span> 
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span><span class=n>exits</span><span class=p>,</span> 
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a><span class=gp>... </span>    <span class=n>fees</span><span class=o>=</span><span class=mf>0.001</span><span class=p>,</span> 
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a><span class=gp>... </span>    <span class=n>freq</span><span class=o>=</span><span class=s1>&#39;1h&#39;</span>
</span><span id=__span-26-7><a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <p>Now we have a portfolio with two columns that can be analyzed using numerous built-in tools. For example, let's calculate and display the statistics for the <code>ETHUSDT</code> symbol:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=p>[</span><span class=s1>&#39;ETHUSDT&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>stats</span><span class=p>()</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=go>Start                         2020-01-01 00:00:00+00:00</span>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=go>End                           2021-12-31 23:00:00+00:00</span>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=go>Period                                729 days 17:00:00</span>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=go>Start Value                                       100.0</span>
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a><span class=go>Min Value                                     98.469385</span>
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a><span class=go>Max Value                                   1805.987865</span>
</span><span id=__span-27-8><a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a><span class=go>End Value                                   1135.272383</span>
</span><span id=__span-27-9><a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a><span class=go>Total Return [%]                            1035.272383</span>
</span><span id=__span-27-10><a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a><span class=go>Benchmark Return [%]                        2752.665477</span>
</span><span id=__span-27-11><a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a><span class=go>Total Time Exposure [%]                       51.750128</span>
</span><span id=__span-27-12><a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a><span class=go>Max Gross Exposure [%]                            100.0</span>
</span><span id=__span-27-13><a id=__codelineno-27-13 name=__codelineno-27-13 href=#__codelineno-27-13></a><span class=go>Max Drawdown [%]                               37.39953</span>
</span><span id=__span-27-14><a id=__codelineno-27-14 name=__codelineno-27-14 href=#__codelineno-27-14></a><span class=go>Max Drawdown Duration                  85 days 09:00:00</span>
</span><span id=__span-27-15><a id=__codelineno-27-15 name=__codelineno-27-15 href=#__codelineno-27-15></a><span class=go>Total Orders                                        348</span>
</span><span id=__span-27-16><a id=__codelineno-27-16 name=__codelineno-27-16 href=#__codelineno-27-16></a><span class=go>Total Fees Paid                              272.755758</span>
</span><span id=__span-27-17><a id=__codelineno-27-17 name=__codelineno-27-17 href=#__codelineno-27-17></a><span class=go>Total Trades                                        174</span>
</span><span id=__span-27-18><a id=__codelineno-27-18 name=__codelineno-27-18 href=#__codelineno-27-18></a><span class=go>Win Rate [%]                                  43.103448</span>
</span><span id=__span-27-19><a id=__codelineno-27-19 name=__codelineno-27-19 href=#__codelineno-27-19></a><span class=go>Best Trade [%]                                33.286985</span>
</span><span id=__span-27-20><a id=__codelineno-27-20 name=__codelineno-27-20 href=#__codelineno-27-20></a><span class=go>Worst Trade [%]                              -13.783496</span>
</span><span id=__span-27-21><a id=__codelineno-27-21 name=__codelineno-27-21 href=#__codelineno-27-21></a><span class=go>Avg Winning Trade [%]                          7.815551</span>
</span><span id=__span-27-22><a id=__codelineno-27-22 name=__codelineno-27-22 href=#__codelineno-27-22></a><span class=go>Avg Losing Trade [%]                          -3.021041</span>
</span><span id=__span-27-23><a id=__codelineno-27-23 name=__codelineno-27-23 href=#__codelineno-27-23></a><span class=go>Avg Winning Trade Duration              3 days 06:43:12</span>
</span><span id=__span-27-24><a id=__codelineno-27-24 name=__codelineno-27-24 href=#__codelineno-27-24></a><span class=go>Avg Losing Trade Duration     1 days 07:54:32.727272727</span>
</span><span id=__span-27-25><a id=__codelineno-27-25 name=__codelineno-27-25 href=#__codelineno-27-25></a><span class=go>Profit Factor                                  1.390947</span>
</span><span id=__span-27-26><a id=__codelineno-27-26 name=__codelineno-27-26 href=#__codelineno-27-26></a><span class=go>Expectancy                                     5.949841</span>
</span><span id=__span-27-27><a id=__codelineno-27-27 name=__codelineno-27-27 href=#__codelineno-27-27></a><span class=go>Sharpe Ratio                                   2.258501</span>
</span><span id=__span-27-28><a id=__codelineno-27-28 name=__codelineno-27-28 href=#__codelineno-27-28></a><span class=go>Calmar Ratio                                   6.320363</span>
</span><span id=__span-27-29><a id=__codelineno-27-29 name=__codelineno-27-29 href=#__codelineno-27-29></a><span class=go>Omega Ratio                                    1.103525</span>
</span><span id=__span-27-30><a id=__codelineno-27-30 name=__codelineno-27-30 href=#__codelineno-27-30></a><span class=go>Sortino Ratio                                   3.27869</span>
</span><span id=__span-27-31><a id=__codelineno-27-31 name=__codelineno-27-31 href=#__codelineno-27-31></a><span class=go>Name: ETHUSDT, dtype: object</span>
</span></code></pre></div> <h3 id=optimization>Optimization<a class=headerlink href=#optimization title="Permanent link">&para;</a></h3> <p>Optimization in VBT can be performed in two ways: iteratively and column-wise.</p> <p>The first method uses a simple loop that goes through every combination of the strategy's parameters and runs the entire logic for each. You need to manually generate a suitable parameter grid and concatenate the results for analysis. On the plus side, you can use <a href=http://hyperopt.github.io/hyperopt/ >Hyperopt</a> and other tools that operate on a per-iteration basis.</p> <p>The second method is natively supported by VBT and involves stacking columns. If you have 2 symbols and 5 parameters, VBT will create 10 columns in total: one for each combination of symbol and parameter. It will backtest each column individually without leaving Numba (this is one reason most functions in VBT are designed to process two-dimensional data). This approach not only offers significant performance benefits for small to medium-sized data, but also enables parallelization with Numba and provides results in a Pandas-friendly format.</p> <p>Let's test the period values <code>4, 5, ..., 20</code>, and the multiplier values <code>2, 2.1, 2.2, ..., 4</code>, which will produce 336 parameter combinations in total. Since our indicator is now parameterized, we can pass these two parameter arrays directly to the <code>SuperTrend.run</code> method and instruct it to perform the <a href=https://en.wikipedia.org/wiki/Cartesian_product>Cartesian product</a> using the <code>param_product=True</code> flag:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>periods</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mi>20</span><span class=p>)</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>multipliers</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=mi>20</span><span class=p>,</span> <span class=mi>41</span><span class=p>)</span> <span class=o>/</span> <span class=mi>10</span>  <span class=c1># (1)!</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>st</span> <span class=o>=</span> <span class=n>SuperTrend</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=gp>... </span>    <span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span> <span class=n>close</span><span class=p>,</span> 
</span><span id=__span-28-6><a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a><span class=gp>... </span>    <span class=n>period</span><span class=o>=</span><span class=n>periods</span><span class=p>,</span> 
</span><span id=__span-28-7><a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a><span class=gp>... </span>    <span class=n>multiplier</span><span class=o>=</span><span class=n>multipliers</span><span class=p>,</span>
</span><span id=__span-28-8><a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a><span class=gp>... </span>    <span class=n>param_product</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-28-9><a id=__codelineno-28-9 name=__codelineno-28-9 href=#__codelineno-28-9></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <ol> <li>Using <code>np.arange(2, 4.1, 0.1)</code> produces <code>3.000000000000001</code> instead of <code>3.0</code>, which can make indexing harder later.</li> </ol> <p> <div class="progress progress-100plus candystripe candystripe-animate"> <div class=progress-bar style=width:100.00%> <p class=progress-label>Iteration 672/672</p> </div> </div> </p> <p>The indicator completed 672 iterations, 336 per symbol. Let's see the columns that have been stacked:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>st</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>columns</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a><span class=go>MultiIndex([( 4, 2.0, &#39;BTCUSDT&#39;),</span>
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a><span class=go>            ( 4, 2.0, &#39;ETHUSDT&#39;),</span>
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a><span class=go>            ( 4, 2.1, &#39;BTCUSDT&#39;),</span>
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a><span class=go>            ( 4, 2.1, &#39;ETHUSDT&#39;),</span>
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a><span class=go>            ( 4, 2.2, &#39;BTCUSDT&#39;),</span>
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a><span class=go>            ...</span>
</span><span id=__span-29-8><a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a><span class=go>            (19, 3.8, &#39;ETHUSDT&#39;),</span>
</span><span id=__span-29-9><a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a><span class=go>            (19, 3.9, &#39;BTCUSDT&#39;),</span>
</span><span id=__span-29-10><a id=__codelineno-29-10 name=__codelineno-29-10 href=#__codelineno-29-10></a><span class=go>            (19, 3.9, &#39;ETHUSDT&#39;),</span>
</span><span id=__span-29-11><a id=__codelineno-29-11 name=__codelineno-29-11 href=#__codelineno-29-11></a><span class=go>            (19, 4.0, &#39;BTCUSDT&#39;),</span>
</span><span id=__span-29-12><a id=__codelineno-29-12 name=__codelineno-29-12 href=#__codelineno-29-12></a><span class=go>            (19, 4.0, &#39;ETHUSDT&#39;)],</span>
</span><span id=__span-29-13><a id=__codelineno-29-13 name=__codelineno-29-13 href=#__codelineno-29-13></a><span class=go>           names=[&#39;st_period&#39;, &#39;st_multiplier&#39;, &#39;symbol&#39;], length=672)</span>
</span></code></pre></div> <p>Each DataFrame now has 672 columns. Let's plot the latest combination by specifying the column as a regular tuple:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>st</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>date_range</span><span class=p>,</span> <span class=p>(</span><span class=mi>19</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=s1>&#39;ETHUSDT&#39;</span><span class=p>)]</span><span class=o>.</span><span class=n>plot</span><span class=p>()</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/supertrend/optimization.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/supertrend/optimization.dark.svg#only-dark></p> <p>When stacking a large number of columns, make sure you are not running out of RAM. You can print the size of any pickleable object in VBT using the <a href=https://vectorbt.pro/pvt_41531c19/api/utils/pickling/#vectorbtpro.utils.pickling.Pickleable.getsize>Pickleable.getsize</a> method:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=n>st</span><span class=o>.</span><span class=n>getsize</span><span class=p>())</span>
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a><span class=go>377.6 MB</span>
</span></code></pre></div> <p>You can manually calculate this as follows (without inputs and parameters):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>output_size</span> <span class=o>=</span> <span class=n>st</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>*</span> <span class=n>st</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>n_outputs</span> <span class=o>=</span> <span class=mi>4</span>
</span><span id=__span-32-3><a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data_type_size</span> <span class=o>=</span> <span class=mi>8</span>
</span><span id=__span-32-4><a id=__codelineno-32-4 name=__codelineno-32-4 href=#__codelineno-32-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>input_size</span> <span class=o>*</span> <span class=n>n_outputs</span> <span class=o>*</span> <span class=n>data_type_size</span> <span class=o>/</span> <span class=mi>1024</span> <span class=o>/</span> <span class=mi>1024</span>
</span><span id=__span-32-5><a id=__codelineno-32-5 name=__codelineno-32-5 href=#__codelineno-32-5></a><span class=go>359.173828125</span>
</span></code></pre></div> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>To reduce the memory footprint, change the <code>get_final_bands_nb</code> function to produce the output arrays with lower floating point accuracy, such as <code>np.float32</code> or even <code>np.float16</code>.</p> </div> <p>The backtesting part remains the same, regardless of the number of columns:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entries</span> <span class=o>=</span> <span class=p>(</span><span class=o>~</span><span class=n>st</span><span class=o>.</span><span class=n>superl</span><span class=o>.</span><span class=n>isnull</span><span class=p>())</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>fshift</span><span class=p>()</span>
</span><span id=__span-33-2><a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span> <span class=o>=</span> <span class=p>(</span><span class=o>~</span><span class=n>st</span><span class=o>.</span><span class=n>supers</span><span class=o>.</span><span class=n>isnull</span><span class=p>())</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>fshift</span><span class=p>()</span>
</span><span id=__span-33-3><a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a>
</span><span id=__span-33-4><a id=__codelineno-33-4 name=__codelineno-33-4 href=#__codelineno-33-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-33-5><a id=__codelineno-33-5 name=__codelineno-33-5 href=#__codelineno-33-5></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=n>close</span><span class=p>,</span> 
</span><span id=__span-33-6><a id=__codelineno-33-6 name=__codelineno-33-6 href=#__codelineno-33-6></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>entries</span><span class=p>,</span> 
</span><span id=__span-33-7><a id=__codelineno-33-7 name=__codelineno-33-7 href=#__codelineno-33-7></a><span class=gp>... </span>    <span class=n>exits</span><span class=o>=</span><span class=n>exits</span><span class=p>,</span> 
</span><span id=__span-33-8><a id=__codelineno-33-8 name=__codelineno-33-8 href=#__codelineno-33-8></a><span class=gp>... </span>    <span class=n>fees</span><span class=o>=</span><span class=mf>0.001</span><span class=p>,</span> 
</span><span id=__span-33-9><a id=__codelineno-33-9 name=__codelineno-33-9 href=#__codelineno-33-9></a><span class=gp>... </span>    <span class=n>freq</span><span class=o>=</span><span class=s1>&#39;1h&#39;</span>
</span><span id=__span-33-10><a id=__codelineno-33-10 name=__codelineno-33-10 href=#__codelineno-33-10></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <p>Instead of calculating all the statistics for each combination, let's plot a heatmap of their Sharpe values, with periods laid out horizontally and multipliers vertically. Since we have an extra column level for symbols, we will make it a slider:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>sharpe_ratio</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>heatmap</span><span class=p>(</span>
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a><span class=gp>... </span>    <span class=n>x_level</span><span class=o>=</span><span class=s1>&#39;st_period&#39;</span><span class=p>,</span> 
</span><span id=__span-34-3><a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a><span class=gp>... </span>    <span class=n>y_level</span><span class=o>=</span><span class=s1>&#39;st_multiplier&#39;</span><span class=p>,</span>
</span><span id=__span-34-4><a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a><span class=gp>... </span>    <span class=n>slider_level</span><span class=o>=</span><span class=s1>&#39;symbol&#39;</span>
</span><span id=__span-34-5><a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/supertrend/heatmap.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/supertrend/heatmap.dark.svg#only-dark></p> <p>Now we have a clear overview of which parameter regions performed well during the backtesting period, yay! <img alt=🥳 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f973.svg title=:partying_face:></p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>To see how these Sharpe values compare to holding:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_holding</span><span class=p>(</span><span class=n>close</span><span class=p>,</span> <span class=n>freq</span><span class=o>=</span><span class=s1>&#39;1h&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>sharpe_ratio</span>
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a><span class=go>symbol</span>
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a><span class=go>BTCUSDT    1.561447</span>
</span><span id=__span-35-4><a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a><span class=go>ETHUSDT    2.170813</span>
</span><span id=__span-35-5><a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a><span class=go>Name: sharpe_ratio, dtype: float64</span>
</span></code></pre></div> </div> <p><a class=md-button href=https://vectorbt.pro/pvt_41531c19/assets/jupytext/tutorials/superfast-supertrend/index.py.txt target=blank_><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19.14 7.5A2.86 2.86 0 0 1 22 10.36v3.78A2.86 2.86 0 0 1 19.14 17H12c0 .39.32.96.71.96H17v1.68a2.86 2.86 0 0 1-2.86 2.86H9.86A2.86 2.86 0 0 1 7 19.64v-3.75a2.85 2.85 0 0 1 2.86-2.85h5.25a2.85 2.85 0 0 0 2.85-2.86V7.5zm-4.28 11.79c-.4 0-.72.3-.72.89s.32.71.72.71a.71.71 0 0 0 .71-.71c0-.59-.32-.89-.71-.89m-10-1.79A2.86 2.86 0 0 1 2 14.64v-3.78A2.86 2.86 0 0 1 4.86 8H12c0-.39-.32-.96-.71-.96H7V5.36A2.86 2.86 0 0 1 9.86 2.5h4.28A2.86 2.86 0 0 1 17 5.36v3.75a2.85 2.85 0 0 1-2.86 2.85H8.89a2.85 2.85 0 0 0-2.85 2.86v2.68zM9.14 5.71c.4 0 .72-.3.72-.89s-.32-.71-.72-.71c-.39 0-.71.12-.71.71s.32.89.71.89"/></svg></span> Python code</a> <a class=md-button href=https://github.com/polakowo/vectorbt.pro/blob/notebooks/SuperTrend.ipynb target=blank_><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 4v6l-2-2-2 2V4H9v16h10V4zM3 7V5h2V4a2 2 0 0 1 2-2h12c1.05 0 2 .95 2 2v16c0 1.05-.95 2-2 2H7c-1.05 0-2-.95-2-2v-1H3v-2h2v-4H3v-2h2V7zm2-2v2h2V5zm0 14h2v-2H5zm0-6h2v-2H5z"/></svg></span> Notebook</a></p> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/basic-rsi/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Basic RSI strategy"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Basic RSI strategy </div> </div> </a> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/superfast-supertrend/streaming/ class="md-footer__link md-footer__link--next" aria-label="Next: Streaming"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Streaming </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2021-2025 Oleg Polakow. All rights reserved. </div> </div> <div class=md-social> <a href=https://www.linkedin.com/in/polakowo target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> <a href=https://github.com/polakowo target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <div class=md-consent data-md-component=consent id=__consent hidden> <div class=md-consent__overlay></div> <aside class=md-consent__inner> <form class="md-consent__form md-grid md-typeset" name=consent> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class=md-toggle type=checkbox id=__settings> <div class=md-consent__settings> <ul class=task-list> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=analytics checked> <span class=task-list-indicator></span> Google Analytics </label> </li> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=github checked> <span class=task-list-indicator></span> GitHub </label> </li> </ul> </div> <div class=md-consent__controls> <button class="md-button md-button--primary">Accept</button> <label class=md-button for=__settings>Manage settings</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script> <script id=__config type=application/json>{"annotate": null, "base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.instant", "navigation.instant.progress", "navigation.top", "navigation.prune", "navigation.path", "navigation.footer", "search.suggest", "search.share", "content.code.annotate", "content.code.copy", "content.code.select", "content.tooltips", "content.tabs.link", "toc.follow", "toc.integrate", "announce.dismiss"], "search": "../../assets/javascripts/workers/search.26099bd0.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=https://vectorbt.pro/pvt_41531c19/assets/javascripts/bundle.9d1edc04.min.js></script> <script src=https://vectorbt.pro/pvt_41531c19/assets/scripts/extra.js></script> <script src=https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js></script> </body> 
<!-- Mirrored from vectorbt.pro/pvt_41531c19/tutorials/superfast-supertrend/ by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 22 Nov 2025 03:46:37 GMT -->
</html>