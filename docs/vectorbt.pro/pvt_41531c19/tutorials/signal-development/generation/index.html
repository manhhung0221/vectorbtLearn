<!doctype html><html lang=en class=no-js> 
<!-- Mirrored from vectorbt.pro/pvt_41531c19/tutorials/signal-development/generation/ by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 22 Nov 2025 03:46:52 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Learn about signal generation in VectorBT PRO"><meta name=author content="Oleg Polakow"><link href=https://vectorbt.pro/tutorials/signal-development/generation/ rel=canonical><link href=../../superfast-supertrend/pipelines/index.html rel=prev><link href=../pre-analysis/index.html rel=next><link rel=icon href=../../../assets/logo/favicon.png><meta name=generator content="mkdocs-1.6.0, mkdocs-material-9.6.21+insiders-4.53.17"><title>Generation - VectorBT® PRO</title><link rel=stylesheet href=../../../assets/stylesheets/main.010a373c.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=../../../../../fonts.gstatic.com/index.html crossorigin><link rel=stylesheet href="../../../../../fonts.googleapis.com/cssbe43.css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../assets/stylesheets/extra.css><link rel=stylesheet href=../../../assets/stylesheets/custom-light.css><link rel=stylesheet href=../../../assets/stylesheets/custom-dark.css><link rel=stylesheet href=../../../assets/stylesheets/pygments-light.css><link rel=stylesheet href=../../../assets/stylesheets/pygments-dark.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-0C5VNYCFHL"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-0C5VNYCFHL",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="../../../../../www.googletagmanager.com/gtag/jsc6c8?id=G-0C5VNYCFHL",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script><meta name=robots content="noindex, nofollow"><meta property=og:title content=Generation><meta property=og:type content=website><meta content=https://vectorbt.pro/tutorials/signal-development/generation/ property=og:url><meta property=og:image:url content=https://vectorbt.pro/pvt_41531c19/assets/logo/social-new.png><meta property=og:image:type content=image/png><meta property=og:description content="Learn about signal generation in VectorBT PRO"><meta property=og:locale content=en-GB><link rel=apple-touch-icon sizes=180x180 href=https://vectorbt.pro/pvt_41531c19/assets/logo/apple-touch-icon.png><link rel=icon type=image/svg+xml href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon.svg><link rel=icon type=image/png sizes=32x32 href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon-16x16.png><link rel=manifest href=https://vectorbt.pro/pvt_41531c19/assets/logo/site.webmanifest><link rel=mask-icon href=https://vectorbt.pro/pvt_41531c19/assets/logo/safari-pinned-tab.svg color=#1e1f22><link rel="shortcut icon" href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon.ico><meta name=msapplication-TileColor content=#1e1f22><meta name=msapplication-config content=https://vectorbt.pro/pvt_41531c19/assets/logo/browserconfig.xml><meta name=theme-color content=#1e1f22><link href=https://unpkg.com/aos@2.3.4/dist/aos.css rel=stylesheet><script src=https://unpkg.com/aos@2.3.4/dist/aos.js></script><link href=http://fonts.cdnfonts.com/css/uni-neue rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/js/all.min.js integrity="sha512-8pHNiqTlsrRjVD4A/3va++W1sMbUHwWxxRPWNyVlql3T+Hgfd81Qc6FC5WMXDC+tSauxxzp1tgiAvSKFu1qIlA==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js integrity="sha512-q583ppKrCRc7N5O0n2nzUiJ+suUv7Et1JGels4bXOaMFQcamPk9HjdUknZuuFjBNs7tsMuadge5k9RzdmO+1GQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><link rel=preconnect href=https://fonts.googleapis.com/><link rel=preconnect href=https://fonts.gstatic.com/ crossorigin></head> <body dir=ltr data-md-color-scheme=custom-dark data-md-color-primary=custom-dark data-md-color-accent=custom-dark> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#generation class=md-skip> Skip to content </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> <button class="md-banner__button md-icon" aria-label="Don't show this again"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> <i>What's new</i>: New LLM providers, reasoning steps, function calling, YAML & TOML support, and <a href=https://vectorbt.pro/pvt_41531c19/getting-started/release-notes><strong>more</strong></a> <span class="twemoji announce-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m153.6 29.9 16-21.3c4-5.4 10.4-8.6 17.1-8.6C198.4 0 208 9.6 208 21.3v22.1c0 13.1 5.4 25.7 14.9 34.7l84.7 80.9c48.8 46.6 76.4 111.2 76.4 178.7C384 434 306 512 209.7 512H192C86 512 0 426 0 320v-3.8c0-48.8 19.4-95.6 53.9-130.1l3.5-3.5c4.2-4.2 10-6.6 16-6.6 12.5 0 22.6 10.1 22.6 22.6V288c0 35.3 28.7 64 64 64s64-28.7 64-64v-3.9c0-18-7.2-35.3-19.9-48l-38.6-38.6c-24-24-37.5-56.7-37.5-90.7 0-27.7 9-54.8 25.6-76.9"/></svg></span> </div> <script>var el=document.querySelector("[data-md-component=announce]");if(el){var content=el.querySelector(".md-typeset");__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0)}</script> </aside> </div> <!-- Determine class according to configuration --> <!-- Header --> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=header.title> <!-- Link to home --> <a href=https://vectorbt.pro/pvt_41531c19/ title="VectorBT® PRO" class="md-header__button md-logo" aria-label="VectorBT® PRO" data-md-component=logo> <img src=https://vectorbt.pro/pvt_41531c19/assets/logo/logo.svg alt=logo class=logo> </a> <!-- Button to open drawer --> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <!-- Header title --> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> VectorBT® PRO <span class=md-version> v2025.10.15 </span> <span class=unlock-icon><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M192 32c-35.3 0-64 28.7-64 64v64h192c35.3 0 64 28.7 64 64v224c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V224c0-35.3 28.7-64 64-64V96c0-70.7 57.3-128 128-128 63.5 0 116.1 46.1 126.2 106.7 2.9 17.4-8.8 33.9-26.3 36.9S258 102.8 255 85.3C250 55.1 223.7 32 192 32m40 328c13.3 0 24-10.7 24-24s-10.7-24-24-24h-80c-13.3 0-24 10.7-24 24s10.7 24 24 24z"/></svg></span> </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Generation </span> </div> </div> </div> <!-- Color palette --> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=custom-dark data-md-color-primary=custom-dark data-md-color-accent=custom-dark aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=custom-light data-md-color-primary=custom-light data-md-color-accent=custom-light aria-label="Switch to dark mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <!-- Site language selector --> <!-- Button to open search modal --> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <!-- Search interface --> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <!-- Repository information --> <div class=md-header__source> <a href=https://github.com/polakowo/vectorbt.pro title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> vectorbt.pro </div> </a> </div> </nav> <!-- Navigation tabs (sticky) --> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/ class=md-tabs__link> Getting started </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/features/overview/ class=md-tabs__link> Features </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/overview/ class=md-tabs__link> Tutorials </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/documentation/overview/ class=md-tabs__link> Documentation </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/overview/ class=md-tabs__link> Cookbook </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/api/ class=md-tabs__link> API </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/terms/terms-of-use/ class=md-tabs__link> Terms </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://vectorbt.pro/pvt_41531c19/ title="VectorBT® PRO" class="md-nav__button md-logo" aria-label="VectorBT® PRO" data-md-component=logo> <img src=https://vectorbt.pro/pvt_41531c19/assets/logo/logo.svg alt=logo class=logo> </a> VectorBT® PRO </label> <div class=md-nav__source> <a href=https://github.com/polakowo/vectorbt.pro title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> vectorbt.pro </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/ class=md-nav__link> <span class=md-ellipsis> Getting started </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/features/overview/ class=md-nav__link> <span class=md-ellipsis> Features </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Tutorials </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Tutorials </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/overview/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/basic-rsi/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m3.5 18.5 6-6 4 4L22 6.92 20.59 5.5l-7.09 8-4-4L2 17z"/></svg> <span class=md-ellipsis> Basic RSI strategy </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/superfast-supertrend/ class=md-nav__link> <span class=md-ellipsis> SuperFast SuperTrend </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_4 checked> <label class=md-nav__link for=__nav_3_4 id=__nav_3_4_label tabindex=0> <span class=md-ellipsis> Signal development </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_4_label aria-expanded=true> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> Signal development </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m6 2c0-3.3-2.7-6-6-6s-6 2.7-6 6c0 2.2 1.2 4.1 3 5.2l1-1.7c-1.2-.7-2-2-2-3.4 0-2.2 1.8-4 4-4s4 1.8 4 4c0 1.5-.8 2.8-2 3.4l1 1.7c1.8-1 3-3 3-5.2M12 2C6.5 2 2 6.5 2 12c0 3.7 2 6.9 5 8.6l1-1.7c-2.4-1.4-4-4-4-6.9 0-4.4 3.6-8 8-8s8 3.6 8 8c0 3-1.6 5.5-4 6.9l1 1.7c3-1.7 5-4.9 5-8.6 0-5.5-4.5-10-10-10"/></svg> <span class=md-ellipsis> Generation </span> <span class="md-nav__icon md-icon"></span> </label> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/signal-development/generation/ class="md-nav__link md-nav__link--active"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m6 2c0-3.3-2.7-6-6-6s-6 2.7-6 6c0 2.2 1.2 4.1 3 5.2l1-1.7c-1.2-.7-2-2-2-3.4 0-2.2 1.8-4 4-4s4 1.8 4 4c0 1.5-.8 2.8-2 3.4l1 1.7c1.8-1 3-3 3-5.2M12 2C6.5 2 2 6.5 2 12c0 3.7 2 6.9 5 8.6l1-1.7c-2.4-1.4-4-4-4-6.9 0-4.4 3.6-8 8-8s8 3.6 8 8c0 3-1.6 5.5-4 6.9l1 1.7c3-1.7 5-4.9 5-8.6 0-5.5-4.5-10-10-10"/></svg> <span class=md-ellipsis> Generation </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#comparison class=md-nav__link> <span class=md-ellipsis> Comparison </span> </a> <nav class=md-nav aria-label=Comparison> <ul class=md-nav__list> <li class=md-nav__item> <a href=#thresholds class=md-nav__link> <span class=md-ellipsis> Thresholds </span> </a> </li> <li class=md-nav__item> <a href=#crossovers class=md-nav__link> <span class=md-ellipsis> Crossovers </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#logical-operators class=md-nav__link> <span class=md-ellipsis> Logical operators </span> </a> <nav class=md-nav aria-label="Logical operators"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cartesian-product class=md-nav__link> <span class=md-ellipsis> Cartesian product </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#shifting class=md-nav__link> <span class=md-ellipsis> Shifting </span> </a> </li> <li class=md-nav__item> <a href=#truth-value-testing class=md-nav__link> <span class=md-ellipsis> Truth value testing </span> </a> </li> <li class=md-nav__item> <a href=#periodically class=md-nav__link> <span class=md-ellipsis> Periodically </span> </a> </li> <li class=md-nav__item> <a href=#iteratively class=md-nav__link> <span class=md-ellipsis> Iteratively </span> </a> </li> <li class=md-nav__item> <a href=#generators class=md-nav__link> <span class=md-ellipsis> Generators </span> </a> <nav class=md-nav aria-label=Generators> <ul class=md-nav__list> <li class=md-nav__item> <a href=#exits class=md-nav__link> <span class=md-ellipsis> Exits </span> </a> </li> <li class=md-nav__item> <a href=#both class=md-nav__link> <span class=md-ellipsis> Both </span> </a> </li> <li class=md-nav__item> <a href=#chained-exits class=md-nav__link> <span class=md-ellipsis> Chained exits </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#preset-generators class=md-nav__link> <span class=md-ellipsis> Preset generators </span> </a> <nav class=md-nav aria-label="Preset generators"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#random class=md-nav__link> <span class=md-ellipsis> Random </span> </a> </li> <li class=md-nav__item> <a href=#stops class=md-nav__link> <span class=md-ellipsis> Stops </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/signal-development/pre-analysis/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m6 2c0-3.3-2.7-6-6-6s-6 2.7-6 6c0 2.2 1.2 4.1 3 5.2l1-1.7c-1.2-.7-2-2-2-3.4 0-2.2 1.8-4 4-4s4 1.8 4 4c0 1.5-.8 2.8-2 3.4l1 1.7c1.8-1 3-3 3-5.2M12 2C6.5 2 2 6.5 2 12c0 3.7 2 6.9 5 8.6l1-1.7c-2.4-1.4-4-4-4-6.9 0-4.4 3.6-8 8-8s8 3.6 8 8c0 3-1.6 5.5-4 6.9l1 1.7c3-1.7 5-4.9 5-8.6 0-5.5-4.5-10-10-10"/></svg> <span class=md-ellipsis> Pre-analysis </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/stop-signals/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 23h-2V1h2zm-4-4H5V5h4V3H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h4zM19 7v2h2V7zm0-2h2a2 2 0 0 0-2-2zm2 10h-2v2h2zm-2-4v2h2v-2zm-2-8h-2v2h2zm2 18c1.11 0 2-.89 2-2h-2zm-2-2h-2v2h2z"/></svg> <span class=md-ellipsis> Stop signals </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/mtf-analysis/ class=md-nav__link> <span class=md-ellipsis> MTF analysis </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/portfolio-optimization/ class=md-nav__link> <span class=md-ellipsis> Portfolio optimization </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/pairs-trading/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22 6.92 20.59 5.5l-2.85 3.22C15.68 6.4 12.83 5 9.61 5 6.72 5 4.07 6.16 2 8l1.42 1.42C5.12 7.93 7.27 7 9.61 7c2.74 0 5.09 1.26 6.77 3.24L13.5 13.5l-4-4L2 17l1.5 1.5 6-6 4 4 4.05-4.57c.75 1.35 1.25 2.9 1.45 4.57h2c-.22-2.32-.95-4.41-2.04-6.16z"/></svg> <span class=md-ellipsis> Pairs trading </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/patterns-and-projections/patterns/ class=md-nav__link> <span class=md-ellipsis> Patterns and projections </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/cross-validation/ class=md-nav__link> <span class=md-ellipsis> Cross-validation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/more-tutorials/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10.6 13.4a1 1 0 0 1-1.4 1.4 4.8 4.8 0 0 1 0-7l3.5-3.6a5.1 5.1 0 0 1 7.1 0 5.1 5.1 0 0 1 0 7.1l-1.5 1.5a6.4 6.4 0 0 0-.4-2.4l.5-.5a3.2 3.2 0 0 0 0-4.3 3.2 3.2 0 0 0-4.3 0l-3.5 3.6a2.9 2.9 0 0 0 0 4.2M23 18v2h-3v3h-2v-3h-3v-2h3v-3h2v3m-3.8-4.3a4.8 4.8 0 0 0-1.4-4.5 1 1 0 0 0-1.4 1.4 2.9 2.9 0 0 1 0 4.2l-3.5 3.6a3.2 3.2 0 0 1-4.3 0 3.2 3.2 0 0 1 0-4.3l.5-.4a7.3 7.3 0 0 1-.4-2.5l-1.5 1.5a5.1 5.1 0 0 0 0 7.1 5.1 5.1 0 0 0 7.1 0l1.8-1.8a6 6 0 0 1 3.1-4.3"/></svg> <span class=md-ellipsis> More tutorials </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/to-be-continued/ class=md-nav__link> <span class=md-ellipsis> To be continued... </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/documentation/overview/ class=md-nav__link> <span class=md-ellipsis> Documentation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/overview/ class=md-nav__link> <span class=md-ellipsis> Cookbook </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/api/ class=md-nav__link> <span class=md-ellipsis> API </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/terms/terms-of-use/ class=md-nav__link> <span class=md-ellipsis> Terms </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <nav class=md-path aria-label=Navigation> <ol class=md-path__list> <li class=md-path__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/overview/ class=md-path__link> <span class=md-ellipsis> Tutorials </span> </a> </li> <li class=md-path__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/signal-development/generation/ class=md-path__link> <span class=md-ellipsis> Signal development </span> </a> </li> </ol> </nav> <article class="md-content__inner md-typeset"> <h1 id=generation><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m6 2c0-3.3-2.7-6-6-6s-6 2.7-6 6c0 2.2 1.2 4.1 3 5.2l1-1.7c-1.2-.7-2-2-2-3.4 0-2.2 1.8-4 4-4s4 1.8 4 4c0 1.5-.8 2.8-2 3.4l1 1.7c1.8-1 3-3 3-5.2M12 2C6.5 2 2 6.5 2 12c0 3.7 2 6.9 5 8.6l1-1.7c-2.4-1.4-4-4-4-6.9 0-4.4 3.6-8 8-8s8 3.6 8 8c0 3-1.6 5.5-4 6.9l1 1.7c3-1.7 5-4.9 5-8.6 0-5.5-4.5-10-10-10"/></svg></span> Generation<a class=headerlink href=#generation title="Permanent link">&para;</a></h1> <p>Signals add an extra layer of abstraction on top of orders. Instead of specifying every detail about what needs to be ordered at each timestamp, you can define what a typical order should look like and then decide when to issue such an order. In VBT, this timing decision is made using signals, which are represented as boolean masks: <code>True</code> stands for "order" and <code>False</code> means "no order". The meaning of each signal can be changed either statically or dynamically, depending on the current simulation state. For example, you can instruct the simulator to ignore an "order" signal if you are already in the market, which is not possible with the "from-orders" method alone. Because VBT emphasizes data science, it is much easier to compare multiple strategies with the same trading conditions but different signal permutations (for example, order timings and directions). This approach reduces errors and leads to more fair experiments.</p> <p>Since buying and selling are constant activities, it is ideal to include the order direction within each signal as well. However, because booleans only have two states, they cannot represent the three possibilities: "order to buy", "order to sell", and "no order". As a result, signals are typically distributed across two or more boolean arrays, each representing a different decision dimension. The most common way to define signals is by using two direction-unaware arrays: <img alt=1⃣ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/31-20e3.svg title=:one:> entries and <img alt=2⃣ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/32-20e3.svg title=:two:> exits. The meaning of these two arrays changes based on the direction, which is specified using a separate variable. For instance, when only the long direction is enabled, an entry signal opens a new long position and an exit signal closes it. When both directions are enabled, an entry signal opens a new long position, and an exit signal reverses it to open a short one. For more precise control over whether to reverse a position or simply close it, you can define four direction-aware arrays: <img alt=1⃣ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/31-20e3.svg title=:one:> long entries, <img alt=2⃣ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/32-20e3.svg title=:two:> long exits, <img alt=3⃣ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/33-20e3.svg title=:three:> short entries, and <img alt=4⃣ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/34-20e3.svg title=:four:> short exits. This method provides the greatest flexibility.</p> <p>For example, to open a long position, close it, open a short position, and then reverse it, the signals would look like this:</p> <table> <thead> <tr> <th>Long entry</th> <th>Long exit</th> <th>Short entry</th> <th>Short exit</th> </tr> </thead> <tbody> <tr> <td>True</td> <td>False</td> <td>False</td> <td>False</td> </tr> <tr> <td>False</td> <td>True</td> <td>False</td> <td>False</td> </tr> <tr> <td>False</td> <td>False</td> <td>True</td> <td>False</td> </tr> <tr> <td>True</td> <td>False</td> <td>False</td> <td>False</td> </tr> </tbody> </table> <p>The same strategy can also be defined using an entry signal, an exit signal, and a direction:</p> <table> <thead> <tr> <th>Entry</th> <th>Exit</th> <th>Direction</th> </tr> </thead> <tbody> <tr> <td>True</td> <td>False</td> <td>Long only</td> </tr> <tr> <td>False</td> <td>True</td> <td>Long only</td> </tr> <tr> <td>True/False</td> <td>False/True</td> <td>Short only/Both</td> </tr> <tr> <td>True</td> <td>False</td> <td>Long only/Both</td> </tr> </tbody> </table> <div class="admonition info"> <p class=admonition-title>Info</p> <p>Direction-unaware signals can be easily converted to direction-aware signals:</p> <ul> <li>True, True, Long only <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg></span> True, True, False, False.</li> <li>True, True, Short only <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg></span> False, False, True, True.</li> <li>True, True, Both <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg></span> True, False, True, False.</li> </ul> <p>However, direction-aware signals cannot be converted to direction-unaware signals if both directions are enabled and there is an exit signal present:</p> <ul> <li>False, True, False, True <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg></span> <img alt=❓ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2753.svg title=:question:></li> </ul> <p>Therefore, it is important to carefully evaluate which conditions you are interested in before generating signals.</p> </div> <p>You might wonder why not use an integer data type, where a positive number means "order to buy," a negative number means "order to sell," and zero means "no order," as is done in backtrader. Boolean arrays are much easier for users to generate and maintain. In addition, a boolean NumPy array uses eight times less memory than a 64-bit signed integer NumPy array. Boolean masks are also much more convenient to combine and analyze than integer arrays. For example, you can combine two masks with the logical OR (<code>|</code> in NumPy) operator, or sum the elements in a mask to get the number of signals. Since booleans are a subtype of integers, they behave just like regular integers in most math expressions.</p> <h2 id=comparison>Comparison<a class=headerlink href=#comparison title="Permanent link">&para;</a></h2> <p>Properly generating signals can sometimes be much more challenging than simulating them. This is because you need to consider not only the distribution of signals but also how they interact across multiple boolean arrays. For example, setting both an entry and exit at the same timestamp will effectively cancel both. That's why VBT offers many functions and techniques to support you in this process.</p> <p>Signal generation usually begins by comparing two or more numeric arrays. Remember, when comparing entire arrays, you iterate over each row and column (that is, each element) in a vectorized way and compare their scalar values at each element. Essentially, you run the same comparison operation on every single element across all the arrays being compared. Let's look at an example using Bollinger Bands for two different assets. At each timestamp, we will place a signal whenever the low price is below the lower band, expecting the price to reverse back to its rolling mean:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=kn>from</span><span class=w> </span><span class=nn>vectorbtpro</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>BinanceData</span><span class=o>.</span><span class=n>pull</span><span class=p>(</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=p>[</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>,</span> <span class=s2>&quot;ETHUSDT&quot;</span><span class=p>],</span> 
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>start</span><span class=o>=</span><span class=s2>&quot;2021-01-01&quot;</span><span class=p>,</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span>    <span class=n>end</span><span class=o>=</span><span class=s2>&quot;2022-01-01&quot;</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>)</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=go>symbol                      BTCUSDT  ETHUSDT</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=go>Open time                                   </span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=go>2021-01-01 00:00:00+00:00  28624.57   714.29</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=go>2021-01-02 00:00:00+00:00  28946.53   714.91</span>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=go>2021-01-03 00:00:00+00:00  31962.99   768.71</span>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a><span class=go>...                             ...      ...</span>
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a><span class=go>2021-12-29 00:00:00+00:00  46096.99  3604.20</span>
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a><span class=go>2021-12-30 00:00:00+00:00  45900.00  3585.00</span>
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a><span class=go>2021-12-31 00:00:00+00:00  45678.00  3622.29</span>
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a>
</span><span id=__span-0-19><a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a><span class=go>[365 rows x 2 columns]</span>
</span><span id=__span-0-20><a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a>
</span><span id=__span-0-21><a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a><span class=gp>&gt;&gt;&gt; </span><span class=n>bb</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>talib</span><span class=p>(</span><span class=s2>&quot;BBANDS&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span><span id=__span-0-22><a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>),</span>
</span><span id=__span-0-23><a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a><span class=gp>... </span>    <span class=n>timeperiod</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Default</span><span class=p>(</span><span class=mi>14</span><span class=p>),</span>  <span class=c1># (1)!</span>
</span><span id=__span-0-24><a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a><span class=gp>... </span>    <span class=n>nbdevup</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Default</span><span class=p>(</span><span class=mi>2</span><span class=p>),</span>
</span><span id=__span-0-25><a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a><span class=gp>... </span>    <span class=n>nbdevdn</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Default</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-0-26><a id=__codelineno-0-26 name=__codelineno-0-26 href=#__codelineno-0-26></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-27><a id=__codelineno-0-27 name=__codelineno-0-27 href=#__codelineno-0-27></a><span class=gp>&gt;&gt;&gt; </span><span class=n>bb</span><span class=o>.</span><span class=n>lowerband</span>  <span class=c1># (2)!</span>
</span><span id=__span-0-28><a id=__codelineno-0-28 name=__codelineno-0-28 href=#__codelineno-0-28></a><span class=go>symbol                          BTCUSDT      ETHUSDT</span>
</span><span id=__span-0-29><a id=__codelineno-0-29 name=__codelineno-0-29 href=#__codelineno-0-29></a><span class=go>Open time                                           </span>
</span><span id=__span-0-30><a id=__codelineno-0-30 name=__codelineno-0-30 href=#__codelineno-0-30></a><span class=go>2021-01-01 00:00:00+00:00           NaN          NaN</span>
</span><span id=__span-0-31><a id=__codelineno-0-31 name=__codelineno-0-31 href=#__codelineno-0-31></a><span class=go>2021-01-02 00:00:00+00:00           NaN          NaN</span>
</span><span id=__span-0-32><a id=__codelineno-0-32 name=__codelineno-0-32 href=#__codelineno-0-32></a><span class=go>2021-01-03 00:00:00+00:00           NaN          NaN</span>
</span><span id=__span-0-33><a id=__codelineno-0-33 name=__codelineno-0-33 href=#__codelineno-0-33></a><span class=go>...                                 ...          ...</span>
</span><span id=__span-0-34><a id=__codelineno-0-34 name=__codelineno-0-34 href=#__codelineno-0-34></a><span class=go>2021-12-29 00:00:00+00:00  44943.280004  3712.190071</span>
</span><span id=__span-0-35><a id=__codelineno-0-35 name=__codelineno-0-35 href=#__codelineno-0-35></a><span class=go>2021-12-30 00:00:00+00:00  44861.191483  3662.827659</span>
</span><span id=__span-0-36><a id=__codelineno-0-36 name=__codelineno-0-36 href=#__codelineno-0-36></a><span class=go>2021-12-31 00:00:00+00:00  44882.974796  3617.893036</span>
</span><span id=__span-0-37><a id=__codelineno-0-37 name=__codelineno-0-37 href=#__codelineno-0-37></a>
</span><span id=__span-0-38><a id=__codelineno-0-38 name=__codelineno-0-38 href=#__codelineno-0-38></a><span class=go>[365 rows x 2 columns]</span>
</span><span id=__span-0-39><a id=__codelineno-0-39 name=__codelineno-0-39 href=#__codelineno-0-39></a>
</span><span id=__span-0-40><a id=__codelineno-0-40 name=__codelineno-0-40 href=#__codelineno-0-40></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>bb</span><span class=o>.</span><span class=n>lowerband</span>  <span class=c1># (3)!</span>
</span><span id=__span-0-41><a id=__codelineno-0-41 name=__codelineno-0-41 href=#__codelineno-0-41></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span>
</span><span id=__span-0-42><a id=__codelineno-0-42 name=__codelineno-0-42 href=#__codelineno-0-42></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-0-43><a id=__codelineno-0-43 name=__codelineno-0-43 href=#__codelineno-0-43></a><span class=go>Open time                                  </span>
</span><span id=__span-0-44><a id=__codelineno-0-44 name=__codelineno-0-44 href=#__codelineno-0-44></a><span class=go>2021-01-01 00:00:00+00:00    False    False</span>
</span><span id=__span-0-45><a id=__codelineno-0-45 name=__codelineno-0-45 href=#__codelineno-0-45></a><span class=go>2021-01-02 00:00:00+00:00    False    False</span>
</span><span id=__span-0-46><a id=__codelineno-0-46 name=__codelineno-0-46 href=#__codelineno-0-46></a><span class=go>2021-01-03 00:00:00+00:00    False    False</span>
</span><span id=__span-0-47><a id=__codelineno-0-47 name=__codelineno-0-47 href=#__codelineno-0-47></a><span class=go>...                            ...      ...</span>
</span><span id=__span-0-48><a id=__codelineno-0-48 name=__codelineno-0-48 href=#__codelineno-0-48></a><span class=go>2021-12-29 00:00:00+00:00    False     True</span>
</span><span id=__span-0-49><a id=__codelineno-0-49 name=__codelineno-0-49 href=#__codelineno-0-49></a><span class=go>2021-12-30 00:00:00+00:00    False     True</span>
</span><span id=__span-0-50><a id=__codelineno-0-50 name=__codelineno-0-50 href=#__codelineno-0-50></a><span class=go>2021-12-31 00:00:00+00:00    False    False</span>
</span><span id=__span-0-51><a id=__codelineno-0-51 name=__codelineno-0-51 href=#__codelineno-0-51></a>
</span><span id=__span-0-52><a id=__codelineno-0-52 name=__codelineno-0-52 href=#__codelineno-0-52></a><span class=go>[365 rows x 2 columns]</span>
</span><span id=__span-0-53><a id=__codelineno-0-53 name=__codelineno-0-53 href=#__codelineno-0-53></a>
</span><span id=__span-0-54><a id=__codelineno-0-54 name=__codelineno-0-54 href=#__codelineno-0-54></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>  <span class=c1># (4)!</span>
</span><span id=__span-0-55><a id=__codelineno-0-55 name=__codelineno-0-55 href=#__codelineno-0-55></a><span class=go>symbol</span>
</span><span id=__span-0-56><a id=__codelineno-0-56 name=__codelineno-0-56 href=#__codelineno-0-56></a><span class=go>BTCUSDT    36</span>
</span><span id=__span-0-57><a id=__codelineno-0-57 name=__codelineno-0-57 href=#__codelineno-0-57></a><span class=go>ETHUSDT    28</span>
</span><span id=__span-0-58><a id=__codelineno-0-58 name=__codelineno-0-58 href=#__codelineno-0-58></a><span class=go>dtype: int64</span>
</span></code></pre></div> <ol> <li>Wrap each parameter with <a href=https://vectorbt.pro/pvt_41531c19/api/base/reshaping/#vectorbtpro.base.reshaping.Default>Default</a> to hide its column level. Alternatively, you can pass a list of parameters to hide with <code>hide_params</code>.</li> <li>Get the lower band as a Pandas object. You can list all output names of an indicator using <code>bb.output_names</code>.</li> <li>Compare two numeric arrays element-wise.</li> <li>Get the number of signals in each column for a better overview.</li> </ol> <p>This operation has created a mask that is true whenever the low price dips below the lower band. Such an array can already be used in a simulation! But let's see what happens when we try to compare the lower band generated for multiple combinations of the (upper and lower) multipliers:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>bb_mult</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>talib</span><span class=p>(</span><span class=s2>&quot;BBANDS&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>),</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=gp>... </span>    <span class=n>timeperiod</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Default</span><span class=p>(</span><span class=mi>14</span><span class=p>),</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=gp>... </span>    <span class=n>nbdevup</span><span class=o>=</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>],</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=gp>... </span>    <span class=n>nbdevdn</span><span class=o>=</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>]</span>  <span class=c1># (1)!</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>bb_mult</span><span class=o>.</span><span class=n>lowerband</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=go>ValueError: Can only compare identically-labeled DataFrame objects</span>
</span></code></pre></div> <ol> <li>Two parameter combinations: (14, 2, 2) and (14, 3, 3)</li> </ol> <p>The issue here is that Pandas cannot compare DataFrames with different columns. The left DataFrame contains the columns <code>BTCUSDT</code> and <code>ETHUSDT</code>, while the right DataFrame from the Bollinger Bands indicator now has the columns <code>(2, 2, BTCUSDT)</code>, <code>(2, 2, ETHUSDT)</code>, <code>(3, 3, BTCUSDT)</code>, and <code>(3, 3, ETHUSDT)</code>. So, what is the solution? Right, VBT! By appending <code>vbt</code> to the <em>left</em> operand, you are comparing the accessor object of type <a href=https://vectorbt.pro/pvt_41531c19/api/base/accessors/#vectorbtpro.base.accessors.BaseAccessor>BaseAccessor</a> instead of the DataFrame itself. This triggers the so-called <a href=https://rszalski.github.io/magicmethods/ >magic method</a> <code>__lt__</code> of that accessor. This method takes the DataFrame under the accessor and the DataFrame on the right and combines them using <a href=https://vectorbt.pro/pvt_41531c19/api/base/accessors/#vectorbtpro.base.accessors.BaseAccessor.combine>BaseAccessor.combine</a> and <a href=https://numpy.org/doc/stable/reference/generated/numpy.less.html>numpy.less</a> as the <code>combine_func</code>. As a result, the shapes and indexes of both DataFrames are broadcasted using VBT's powerful broadcasting mechanism, which overcomes the Pandas limitation.</p> <p>As a result, VBT compares <code>(2, 2, BTCUSDT)</code> and <code>(3, 3, BTCUSDT)</code> only with <code>BTCUSDT</code>, and <code>(2, 2, ETHUSDT)</code> and <code>(3, 3, ETHUSDT)</code> only with <code>ETHUSDT</code>, leveraging NumPy for performance!</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span> <span class=o>&lt;</span> <span class=n>bb_mult</span><span class=o>.</span><span class=n>lowerband</span>  <span class=c1># (1)!</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=go>bbands_nbdevup                          2               3</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=go>bbands_nbdevdn                          2               3</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=go>symbol                    BTCUSDT ETHUSDT BTCUSDT ETHUSDT</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=go>Open time                                                </span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=go>2021-01-01 00:00:00+00:00   False   False   False   False</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=go>2021-01-02 00:00:00+00:00   False   False   False   False</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=go>2021-01-03 00:00:00+00:00   False   False   False   False</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=go>...                           ...     ...     ...     ...</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=go>2021-12-29 00:00:00+00:00   False    True   False   False</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=go>2021-12-30 00:00:00+00:00   False    True   False   False</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=go>2021-12-31 00:00:00+00:00   False   False   False   False</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=go>[365 rows x 4 columns]</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-2-18><a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a><span class=go>bbands_nbdevup  bbands_nbdevdn  symbol </span>
</span><span id=__span-2-19><a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a><span class=go>2               2               BTCUSDT    53</span>
</span><span id=__span-2-20><a id=__codelineno-2-20 name=__codelineno-2-20 href=#__codelineno-2-20></a><span class=go>                                ETHUSDT    48</span>
</span><span id=__span-2-21><a id=__codelineno-2-21 name=__codelineno-2-21 href=#__codelineno-2-21></a><span class=go>3               3               BTCUSDT    10</span>
</span><span id=__span-2-22><a id=__codelineno-2-22 name=__codelineno-2-22 href=#__codelineno-2-22></a><span class=go>                                ETHUSDT     9</span>
</span><span id=__span-2-23><a id=__codelineno-2-23 name=__codelineno-2-23 href=#__codelineno-2-23></a><span class=go>dtype: int64</span>
</span></code></pre></div> <ol> <li><code>vbt</code> must always be called on the left operand.</li> </ol> <div class="admonition note"> <p class=admonition-title>Note</p> <p>For VBT to compare shapes that are not broadcastable, both DataFrames must share at least one column level in common, such as <code>symbol</code> in the example above.</p> </div> <p>As you may remember from the indicator documentation, each indicator provides several helper methods for comparison: <code>{name}_above</code>, <code>{name}_equal</code>, and <code>{name}_below</code>, which essentially do the same as what we did above:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>bb_mult</span><span class=o>.</span><span class=n>lowerband_above</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>))</span>  <span class=c1># (1)!</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=go>bbands_nbdevup  bbands_nbdevdn  symbol </span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=go>2               2               BTCUSDT    53</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=go>                                ETHUSDT    48</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=go>3               3               BTCUSDT    10</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=go>                                ETHUSDT     9</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=go>dtype: int64</span>
</span></code></pre></div> <ol> <li>Our indicator does not have an input or output for the low price, so we need to reverse the comparison order and check whether the lower band is above the low price.</li> </ol> <h3 id=thresholds>Thresholds<a class=headerlink href=#thresholds title="Permanent link">&para;</a></h3> <p>To compare a numeric array against two or more scalar thresholds as parameter combinations, we can use the same approach by either appending <code>vbt</code> or by calling the method <a href=https://vectorbt.pro/pvt_41531c19/api/base/accessors/#vectorbtpro.base.accessors.BaseAccessor.combine>BaseAccessor.combine</a>. Let's calculate the bandwidth of our single-combination indicator, which is the upper band minus the lower band divided by the middle band, and check whether it is higher than two different thresholds:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>bandwidth</span> <span class=o>=</span> <span class=p>(</span><span class=n>bb</span><span class=o>.</span><span class=n>upperband</span> <span class=o>-</span> <span class=n>bb</span><span class=o>.</span><span class=n>lowerband</span><span class=p>)</span> <span class=o>/</span> <span class=n>bb</span><span class=o>.</span><span class=n>middleband</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>bandwidth</span><span class=o>.</span><span class=n>vbt</span> <span class=o>&gt;</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mf>0.15</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;threshold&quot;</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=go>threshold  symbol </span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=go>0.15       BTCUSDT    253</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=go>           ETHUSDT    316</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=go>0.30       BTCUSDT     65</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=go>           ETHUSDT    136</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=go>dtype: int64</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>bandwidth</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>combine</span><span class=p>(</span>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a><span class=gp>... </span>    <span class=p>[</span><span class=mf>0.15</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>],</span>  <span class=c1># (2)!</span>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a><span class=gp>... </span>    <span class=n>combine_func</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>greater</span><span class=p>,</span> 
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=gp>... </span>    <span class=n>keys</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Index</span><span class=p>([</span><span class=mf>0.15</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;threshold&quot;</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-4-17><a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-4-18><a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a><span class=go>threshold  symbol </span>
</span><span id=__span-4-19><a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a><span class=go>0.15       BTCUSDT    253</span>
</span><span id=__span-4-20><a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a><span class=go>           ETHUSDT    316</span>
</span><span id=__span-4-21><a id=__codelineno-4-21 name=__codelineno-4-21 href=#__codelineno-4-21></a><span class=go>0.30       BTCUSDT     65</span>
</span><span id=__span-4-22><a id=__codelineno-4-22 name=__codelineno-4-22 href=#__codelineno-4-22></a><span class=go>           ETHUSDT    136</span>
</span><span id=__span-4-23><a id=__codelineno-4-23 name=__codelineno-4-23 href=#__codelineno-4-23></a><span class=go>dtype: int64</span>
</span></code></pre></div> <ol> <li>Passes both objects to <a href=https://vectorbt.pro/pvt_41531c19/api/base/accessors/#vectorbtpro.base.accessors.BaseAccessor.combine>BaseAccessor.combine</a>, broadcasts them using <a href=https://vectorbt.pro/pvt_41531c19/api/base/reshaping/#vectorbtpro.base.reshaping.broadcast>broadcast</a>, and combines them using <a href=https://numpy.org/doc/stable/reference/generated/numpy.greater.html>numpy.greater</a>. With broadcasting, each value in <code>vbt.Param</code> is combined with each column in the array. This works only for scalars.</li> <li>When passing a list, the DataFrame is compared to each item in the list.</li> <li>The <code>keys</code> argument appends a column level describing the items in the list.</li> </ol> <p>The latest example also works with arrays instead of scalars. Alternatively, we can use <a href=https://pandas.pydata.org/docs/reference/api/pandas.concat.html>pandas.concat</a> to manually stack the results of any comparison and treat them as separate combinations:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>(</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=gp>... </span>    <span class=p>(</span><span class=n>bandwidth</span> <span class=o>&gt;</span> <span class=mf>0.15</span><span class=p>,</span> <span class=n>bandwidth</span> <span class=o>&gt;</span> <span class=mf>0.3</span><span class=p>),</span> 
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=gp>... </span>    <span class=n>keys</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Index</span><span class=p>([</span><span class=mf>0.15</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;threshold&quot;</span><span class=p>),</span> 
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=gp>... </span>    <span class=n>axis</span><span class=o>=</span><span class=mi>1</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=go>threshold  symbol </span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=go>0.15       BTCUSDT    253</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=go>           ETHUSDT    316</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=go>0.30       BTCUSDT     65</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a><span class=go>           ETHUSDT    136</span>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a><span class=go>dtype: int64</span>
</span></code></pre></div> <h3 id=crossovers>Crossovers<a class=headerlink href=#crossovers title="Permanent link">&para;</a></h3> <p>So far, we have explored basic vectorized comparison operations, but one operation appears disproportionately often in technical analysis: crossovers. A crossover refers to a situation where two time series cross each other. There are two ways to identify crossovers: naive and native. The naive approach compares both time series in a vectorized way and then selects the first <code>True</code> value from each "partition" of <code>True</code> values. In VBT's terminology, a partition for signal processing is a consecutive sequence of <code>True</code> values produced by the comparison. While we already know how to perform the comparison, the second step can be accomplished with the accessor for signals: <a href=https://vectorbt.pro/pvt_41531c19/api/signals/accessors/#vectorbtpro.signals.accessors.SignalsAccessor>SignalsAccessor</a>, which can be accessed via the attribute <code>vbt.signals</code> on any Pandas object.</p> <p>Specifically, we will use the method <a href=https://vectorbt.pro/pvt_41531c19/api/signals/accessors/#vectorbtpro.signals.accessors.SignalsAccessor.first>SignalsAccessor.first</a>, which takes a mask, assigns a rank to each <code>True</code> value within each partition using <a href=https://vectorbt.pro/pvt_41531c19/api/signals/accessors/#vectorbtpro.signals.accessors.SignalsAccessor.pos_rank>SignalsAccessor.pos_rank</a> (numbered from 0 to the length of the respective partition), and then keeps only those <code>True</code> values that have rank 0. Let's get the crossovers where the low price dips below the lower band:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>low_below_lband</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>bb</span><span class=o>.</span><span class=n>lowerband</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>low_below_lband</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=go>symbol</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=go>BTCUSDT    21</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=go>ETHUSDT    20</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=go>dtype: int64</span>
</span></code></pre></div> <p>To confirm the operation was successful, let's plot the <code>BTCUSDT</code> column of both time series using <a href=https://vectorbt.pro/pvt_41531c19/api/generic/accessors/#vectorbtpro.generic.accessors.GenericAccessor.plot>GenericAccessor.plot</a> and the generated signals with <a href=https://vectorbt.pro/pvt_41531c19/api/signals/accessors/#vectorbtpro.signals.accessors.SignalsSRAccessor.plot_as_markers>SignalsSRAccessor.plot_as_markers</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>btc_low</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>,</span> <span class=s2>&quot;BTCUSDT&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>btc_lowerband</span> <span class=o>=</span> <span class=n>bb</span><span class=o>.</span><span class=n>lowerband</span><span class=p>[</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=s2>&quot;Lower Band&quot;</span><span class=p>)</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>btc_mask</span> <span class=o>=</span> <span class=n>mask</span><span class=p>[</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=s2>&quot;Signals&quot;</span><span class=p>)</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span> <span class=o>=</span> <span class=n>btc_low</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>plot</span><span class=p>()</span>  <span class=c1># (2)!</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>btc_lowerband</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>fig</span><span class=o>=</span><span class=n>fig</span><span class=p>)</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>btc_mask</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>plot_as_markers</span><span class=p>(</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a><span class=gp>... </span>    <span class=n>y</span><span class=o>=</span><span class=n>btc_low</span><span class=p>,</span> 
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a><span class=gp>... </span>    <span class=n>trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a><span class=gp>... </span>        <span class=n>marker</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a><span class=gp>... </span>            <span class=n>color</span><span class=o>=</span><span class=s2>&quot;#DFFF00&quot;</span>
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-7-13><a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-7-14><a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a><span class=gp>... </span>    <span class=n>fig</span><span class=o>=</span><span class=n>fig</span>
</span><span id=__span-7-15><a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a><span class=gp>... </span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-7-16><a id=__codelineno-7-16 name=__codelineno-7-16 href=#__codelineno-7-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <ol> <li>Rename the column for the legend.</li> <li>The first plotting method returns a figure, which must be passed to each subsequent plotting method.</li> <li>We are using <code>btc_low</code> as the Y-values at which to place the markers.</li> </ol> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/signal-dev/crossovers.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/signal-dev/crossovers.dark.svg#only-dark></p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>To wait for a confirmation, use <a href=https://vectorbt.pro/pvt_41531c19/api/signals/accessors/#vectorbtpro.signals.accessors.SignalsAccessor.nth>SignalsAccessor.nth</a> to select the n-th signal in each partition.</p> </div> <p>However, there is a catch: if the first low value is already below the first lower band value, it will also produce a crossover signal. To address this, we need to pass <code>after_false=True</code>, which will discard the first partition if there is no <code>False</code> value beforehand.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>low_below_lband</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>first</span><span class=p>(</span><span class=n>after_false</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=go>symbol</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=go>BTCUSDT    21</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=go>ETHUSDT    20</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=go>dtype: int64</span>
</span></code></pre></div> <p>Here's another catch: if the first values in the indicator are NaN, which results in <code>False</code> values in the mask, and the first value after the last NaN yields <code>True</code>, the <code>after_false</code> argument becomes ineffective. To resolve this, we need to manually set those positions in the mask to <code>True</code>. Let's illustrate this with sample data:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sample_low</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=mi>10</span><span class=p>,</span> <span class=mi>9</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>9</span><span class=p>,</span> <span class=mi>8</span><span class=p>])</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sample_lband</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=mi>9</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>9</span><span class=p>])</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sample_mask</span> <span class=o>=</span> <span class=n>sample_low</span> <span class=o>&lt;</span> <span class=n>sample_lband</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sample_mask</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>first</span><span class=p>(</span><span class=n>after_false</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=go>0    False</span>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=go>1    False</span>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=go>2     True</span>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=go>3    False</span>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a><span class=go>4     True</span>
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=go>dtype: bool</span>
</span><span id=__span-9-11><a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a>
</span><span id=__span-9-12><a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sample_mask</span><span class=p>[</span><span class=n>sample_lband</span><span class=o>.</span><span class=n>ffill</span><span class=p>()</span><span class=o>.</span><span class=n>isnull</span><span class=p>()]</span> <span class=o>=</span> <span class=kc>True</span>  <span class=c1># (2)!</span>
</span><span id=__span-9-13><a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sample_mask</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>first</span><span class=p>(</span><span class=n>after_false</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-9-14><a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a><span class=go>0    False</span>
</span><span id=__span-9-15><a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a><span class=go>1    False</span>
</span><span id=__span-9-16><a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a><span class=go>2    False</span>
</span><span id=__span-9-17><a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a><span class=go>3    False</span>
</span><span id=__span-9-18><a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a><span class=go>4     True</span>
</span><span id=__span-9-19><a id=__codelineno-9-19 name=__codelineno-9-19 href=#__codelineno-9-19></a><span class=go>dtype: bool</span>
</span></code></pre></div> <ol> <li>The first crossover should not occur because we do not know what happens at those NaN values, while the second crossover is valid.</li> <li>Forward fill the indicator values to identify only the initial NaN values, and set the mask to <code>True</code> at those positions to make <code>after_false</code> effective again.</li> </ol> <p>Alternatively, we can remove the buffer, perform the operation, and then add the buffer back:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>buffer</span> <span class=o>=</span> <span class=n>sample_lband</span><span class=o>.</span><span class=n>ffill</span><span class=p>()</span><span class=o>.</span><span class=n>isnull</span><span class=p>()</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>max</span><span class=p>()</span>  <span class=c1># (1)!</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>buffer</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=go>2</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sample_buf_mask</span> <span class=o>=</span> <span class=n>sample_low</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>buffer</span><span class=p>:]</span> <span class=o>&lt;</span> <span class=n>sample_lband</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>buffer</span><span class=p>:]</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sample_buf_mask</span> <span class=o>=</span> <span class=n>sample_buf_mask</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>first</span><span class=p>(</span><span class=n>after_false</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sample_mask</span> <span class=o>=</span> <span class=n>sample_low</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sample_mask</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>sample_buf_mask</span><span class=o>.</span><span class=n>index</span><span class=p>]</span> <span class=o>=</span> <span class=n>sample_buf_mask</span>
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sample_mask</span>
</span><span id=__span-10-10><a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a><span class=go>0    False</span>
</span><span id=__span-10-11><a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a><span class=go>1    False</span>
</span><span id=__span-10-12><a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a><span class=go>2    False</span>
</span><span id=__span-10-13><a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a><span class=go>3    False</span>
</span><span id=__span-10-14><a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a><span class=go>4     True</span>
</span><span id=__span-10-15><a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a><span class=go>dtype: bool</span>
</span></code></pre></div> <ol> <li>Find the maximum length of each first consecutive series of NaN values across all columns.</li> </ol> <div class="admonition info"> <p class=admonition-title>Info</p> <p>We can apply the buffer-exclusive approach described above to almost any operation in VBT.</p> </div> <p>But here comes another issue: what if our data contains gaps and we encounter a NaN in the middle of a partition? In this case, we should set the second part of the partition to <code>False</code>, because forward-filling that NaN value would make waiting for a confirmation difficult. However, performing many operations on larger arrays just to find crossovers can be quite resource-intensive. Fortunately, VBT uses its own Numba-compiled function <a href=https://vectorbt.pro/pvt_41531c19/api/generic/nb/base/#vectorbtpro.generic.nb.base.crossed_above_nb>crossed_above_nb</a> to find crossovers iteratively, which is the second, native method. To use this function, we can use the methods <a href=https://vectorbt.pro/pvt_41531c19/api/generic/accessors/#vectorbtpro.generic.accessors.GenericAccessor.crossed_above>GenericAccessor.crossed_above</a> and <a href=https://vectorbt.pro/pvt_41531c19/api/generic/accessors/#vectorbtpro.generic.accessors.GenericAccessor.crossed_below>GenericAccessor.crossed_below</a>, accessible via the <code>vbt</code> attribute on any Pandas object:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>crossed_below</span><span class=p>(</span><span class=n>bb</span><span class=o>.</span><span class=n>lowerband</span><span class=p>,</span> <span class=n>wait</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=go>symbol</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=go>BTCUSDT    15</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=go>ETHUSDT    11</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=go>dtype: int64</span>
</span></code></pre></div> <ol> <li>Waits one bar for confirmation.</li> </ol> <div class="admonition info"> <p class=admonition-title>Info</p> <p>If the time series crosses back during the confirmation period <code>wait</code>, the signal will not be set. To set the signal anyway, use forward shifting.</p> </div> <p>As with other comparison methods, each indicator comes with helper methods <code>{name}_crossed_above</code> and <code>{name}_crossed_below</code> for generating the crossover masks:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>bb</span><span class=o>.</span><span class=n>lowerband_crossed_above</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>),</span> <span class=n>wait</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=go>symbol</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=go>BTCUSDT    15</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a><span class=go>ETHUSDT    11</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=go>dtype: int64</span>
</span></code></pre></div> <h2 id=logical-operators>Logical operators<a class=headerlink href=#logical-operators title="Permanent link">&para;</a></h2> <p>Once we have generated two or more masks (conditions), we can combine them into a single mask using logical operators. Common logical operators include:</p> <ul> <li><em>AND</em> (<code>&amp;</code> or <a href=https://numpy.org/doc/stable/reference/generated/numpy.logical_and.html>numpy.logical_and</a>): for each element, returns True whenever all the conditions are True.</li> <li><em>OR</em> (<code>|</code> or <a href=https://numpy.org/doc/stable/reference/generated/numpy.logical_or.html>numpy.logical_or</a>): for each element, returns True whenever any of the conditions are True.</li> <li><em>NOT</em> (<code>~</code> or <a href=https://numpy.org/doc/stable/reference/generated/numpy.logical_not.html>numpy.logical_not</a>): for each element, returns True whenever the condition is False.</li> <li><em>XOR</em> (<code>^</code> or <a href=https://numpy.org/doc/stable/reference/generated/numpy.logical_xor.html>numpy.logical_xor</a>): for each element, returns True whenever only one of the conditions is True.</li> </ul> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Do not use <code>and</code>, <code>or</code>, or <code>not</code> on arrays. These only work on single boolean values. For example, instead of <code>mask1 and mask2</code>, use <code>mask1 &amp; mask2</code>. Instead of <code>mask1 or mask2</code>, use <code>mask1 | mask2</code>. Instead of <code>not mask</code>, use <code>~mask</code>.</p> </div> <p>For example, let's combine four conditions for a signal: the low price dips below the lower band <em>AND</em> the bandwidth is above some threshold (a downward breakout while expanding), <em>OR</em> the high price rises above the upper band <em>AND</em> the bandwidth is below some threshold (an upward breakout while squeezing):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond1</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>bb</span><span class=o>.</span><span class=n>lowerband</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond2</span> <span class=o>=</span> <span class=n>bandwidth</span> <span class=o>&gt;</span> <span class=mf>0.3</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond3</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;High&quot;</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>bb</span><span class=o>.</span><span class=n>upperband</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond4</span> <span class=o>=</span> <span class=n>bandwidth</span> <span class=o>&lt;</span> <span class=mf>0.15</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=p>(</span><span class=n>cond1</span> <span class=o>&amp;</span> <span class=n>cond2</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>cond3</span> <span class=o>&amp;</span> <span class=n>cond4</span><span class=p>)</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=go>symbol</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=go>BTCUSDT    25</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a><span class=go>ETHUSDT    13</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a><span class=go>dtype: int64</span>
</span></code></pre></div> <p>To test multiple thresholds and broadcast exclusively using VBT:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond1</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span> <span class=o>&lt;</span> <span class=n>bb</span><span class=o>.</span><span class=n>lowerband</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond2</span> <span class=o>=</span> <span class=n>bandwidth</span><span class=o>.</span><span class=n>vbt</span> <span class=o>&gt;</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mf>0.3</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>,</span> <span class=mf>0.4</span><span class=p>,</span> <span class=mf>0.4</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;cond2_th&quot;</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond3</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;High&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span> <span class=o>&gt;</span> <span class=n>bb</span><span class=o>.</span><span class=n>upperband</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond4</span> <span class=o>=</span> <span class=n>bandwidth</span><span class=o>.</span><span class=n>vbt</span> <span class=o>&lt;</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;cond4_th&quot;</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=p>(</span><span class=n>cond1</span><span class=o>.</span><span class=n>vbt</span> <span class=o>&amp;</span> <span class=n>cond2</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span> <span class=o>|</span> <span class=p>(</span><span class=n>cond3</span><span class=o>.</span><span class=n>vbt</span> <span class=o>&amp;</span> <span class=n>cond4</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a><span class=go>cond2_th  cond4_th  symbol </span>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a><span class=go>0.3       0.1       BTCUSDT    11</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=go>                    ETHUSDT    10</span>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a><span class=go>          0.2       BTCUSDT    28</span>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a><span class=go>                    ETHUSDT    27</span>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a><span class=go>0.4       0.1       BTCUSDT     9</span>
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14 href=#__codelineno-14-14></a><span class=go>                    ETHUSDT     5</span>
</span><span id=__span-14-15><a id=__codelineno-14-15 name=__codelineno-14-15 href=#__codelineno-14-15></a><span class=go>          0.2       BTCUSDT    26</span>
</span><span id=__span-14-16><a id=__codelineno-14-16 name=__codelineno-14-16 href=#__codelineno-14-16></a><span class=go>                    ETHUSDT    22</span>
</span><span id=__span-14-17><a id=__codelineno-14-17 name=__codelineno-14-17 href=#__codelineno-14-17></a><span class=go>dtype: int64</span>
</span></code></pre></div> <ol> <li>Tests two thresholds in the second condition, repeating them so that each is compared with both thresholds in the fourth condition.</li> <li>Tests two thresholds in the fourth condition, tiling them so that each is compared with both thresholds in the second condition.</li> <li>Notice that <code>vbt</code> is appended to each operand on the left. Adding it to any operand on the right is redundant.</li> </ol> <h3 id=cartesian-product>Cartesian product<a class=headerlink href=#cartesian-product title="Permanent link">&para;</a></h3> <p>Combining two or more arrays using a Cartesian product is a bit more complex because each array has the column level <code>symbol</code>, which should not be combined with itself. Here is the trick: First, convert the columns of each array to their integer positions. Then, split each position array into "blocks" (smaller arrays). Blocks will be combined with each other, but the positions within each block will not; that is, each block serves as a parameter combination. Then, combine all blocks using a combinatorial function of your choice (see <a href=https://docs.python.org/3/library/itertools.html>itertools</a> for various options, or <a href=https://vectorbt.pro/pvt_41531c19/api/utils/params/#vectorbtpro.utils.params.generate_param_combs>generate_param_combs</a>), and finally, flatten each array with blocks and use it for column selection. While this may sound complex, it is not difficult to implement!</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond1</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span> <span class=o>&lt;</span> <span class=n>bb</span><span class=o>.</span><span class=n>lowerband</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond2</span> <span class=o>=</span> <span class=n>bandwidth</span><span class=o>.</span><span class=n>vbt</span> <span class=o>&gt;</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mf>0.3</span><span class=p>,</span> <span class=mf>0.4</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;cond2_th&quot;</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond3</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;High&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span> <span class=o>&gt;</span> <span class=n>bb</span><span class=o>.</span><span class=n>upperband</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond4</span> <span class=o>=</span> <span class=n>bandwidth</span><span class=o>.</span><span class=n>vbt</span> <span class=o>&lt;</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;cond4_th&quot;</span><span class=p>)</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>i1</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>cond1</span><span class=o>.</span><span class=n>columns</span><span class=p>)),</span> <span class=nb>len</span><span class=p>(</span><span class=n>cond1</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span> <span class=o>//</span> <span class=mi>2</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>i2</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>cond2</span><span class=o>.</span><span class=n>columns</span><span class=p>)),</span> <span class=nb>len</span><span class=p>(</span><span class=n>cond2</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span> <span class=o>//</span> <span class=mi>2</span><span class=p>)</span>
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>i3</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>cond3</span><span class=o>.</span><span class=n>columns</span><span class=p>)),</span> <span class=nb>len</span><span class=p>(</span><span class=n>cond3</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span> <span class=o>//</span> <span class=mi>2</span><span class=p>)</span>
</span><span id=__span-15-9><a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>i4</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>cond4</span><span class=o>.</span><span class=n>columns</span><span class=p>)),</span> <span class=nb>len</span><span class=p>(</span><span class=n>cond4</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span> <span class=o>//</span> <span class=mi>2</span><span class=p>)</span>
</span><span id=__span-15-10><a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a>
</span><span id=__span-15-11><a id=__codelineno-15-11 name=__codelineno-15-11 href=#__codelineno-15-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>i1</span>
</span><span id=__span-15-12><a id=__codelineno-15-12 name=__codelineno-15-12 href=#__codelineno-15-12></a><span class=go>[array([0, 1])]</span>
</span><span id=__span-15-13><a id=__codelineno-15-13 name=__codelineno-15-13 href=#__codelineno-15-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>i2</span>
</span><span id=__span-15-14><a id=__codelineno-15-14 name=__codelineno-15-14 href=#__codelineno-15-14></a><span class=go>[array([0, 1]), array([2, 3])]</span>
</span><span id=__span-15-15><a id=__codelineno-15-15 name=__codelineno-15-15 href=#__codelineno-15-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>i3</span>
</span><span id=__span-15-16><a id=__codelineno-15-16 name=__codelineno-15-16 href=#__codelineno-15-16></a><span class=go>[array([0, 1])]</span>
</span><span id=__span-15-17><a id=__codelineno-15-17 name=__codelineno-15-17 href=#__codelineno-15-17></a><span class=gp>&gt;&gt;&gt; </span><span class=n>i4</span>
</span><span id=__span-15-18><a id=__codelineno-15-18 name=__codelineno-15-18 href=#__codelineno-15-18></a><span class=go>[array([0, 1]), array([2, 3])]</span>
</span><span id=__span-15-19><a id=__codelineno-15-19 name=__codelineno-15-19 href=#__codelineno-15-19></a>
</span><span id=__span-15-20><a id=__codelineno-15-20 name=__codelineno-15-20 href=#__codelineno-15-20></a><span class=gp>&gt;&gt;&gt; </span><span class=n>i1</span><span class=p>,</span> <span class=n>i2</span><span class=p>,</span> <span class=n>i3</span><span class=p>,</span> <span class=n>i4</span> <span class=o>=</span> <span class=nb>zip</span><span class=p>(</span><span class=o>*</span><span class=n>product</span><span class=p>(</span><span class=n>i1</span><span class=p>,</span> <span class=n>i2</span><span class=p>,</span> <span class=n>i3</span><span class=p>,</span> <span class=n>i4</span><span class=p>))</span>  <span class=c1># (3)!</span>
</span><span id=__span-15-21><a id=__codelineno-15-21 name=__codelineno-15-21 href=#__codelineno-15-21></a>
</span><span id=__span-15-22><a id=__codelineno-15-22 name=__codelineno-15-22 href=#__codelineno-15-22></a><span class=gp>&gt;&gt;&gt; </span><span class=n>i1</span>
</span><span id=__span-15-23><a id=__codelineno-15-23 name=__codelineno-15-23 href=#__codelineno-15-23></a><span class=go>(array([0, 1]), array([0, 1]), array([0, 1]), array([0, 1]))</span>
</span><span id=__span-15-24><a id=__codelineno-15-24 name=__codelineno-15-24 href=#__codelineno-15-24></a><span class=gp>&gt;&gt;&gt; </span><span class=n>i2</span>
</span><span id=__span-15-25><a id=__codelineno-15-25 name=__codelineno-15-25 href=#__codelineno-15-25></a><span class=go>(array([0, 1]), array([0, 1]), array([2, 3]), array([2, 3]))</span>
</span><span id=__span-15-26><a id=__codelineno-15-26 name=__codelineno-15-26 href=#__codelineno-15-26></a><span class=gp>&gt;&gt;&gt; </span><span class=n>i3</span>
</span><span id=__span-15-27><a id=__codelineno-15-27 name=__codelineno-15-27 href=#__codelineno-15-27></a><span class=go>(array([0, 1]), array([0, 1]), array([0, 1]), array([0, 1]))</span>
</span><span id=__span-15-28><a id=__codelineno-15-28 name=__codelineno-15-28 href=#__codelineno-15-28></a><span class=gp>&gt;&gt;&gt; </span><span class=n>i4</span>
</span><span id=__span-15-29><a id=__codelineno-15-29 name=__codelineno-15-29 href=#__codelineno-15-29></a><span class=go>(array([0, 1]), array([2, 3]), array([0, 1]), array([2, 3]))</span>
</span><span id=__span-15-30><a id=__codelineno-15-30 name=__codelineno-15-30 href=#__codelineno-15-30></a>
</span><span id=__span-15-31><a id=__codelineno-15-31 name=__codelineno-15-31 href=#__codelineno-15-31></a><span class=gp>&gt;&gt;&gt; </span><span class=n>i1</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>i1</span><span class=p>)</span><span class=o>.</span><span class=n>flatten</span><span class=p>()</span>  <span class=c1># (4)!</span>
</span><span id=__span-15-32><a id=__codelineno-15-32 name=__codelineno-15-32 href=#__codelineno-15-32></a><span class=gp>&gt;&gt;&gt; </span><span class=n>i2</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>i2</span><span class=p>)</span><span class=o>.</span><span class=n>flatten</span><span class=p>()</span>
</span><span id=__span-15-33><a id=__codelineno-15-33 name=__codelineno-15-33 href=#__codelineno-15-33></a><span class=gp>&gt;&gt;&gt; </span><span class=n>i3</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>i3</span><span class=p>)</span><span class=o>.</span><span class=n>flatten</span><span class=p>()</span>
</span><span id=__span-15-34><a id=__codelineno-15-34 name=__codelineno-15-34 href=#__codelineno-15-34></a><span class=gp>&gt;&gt;&gt; </span><span class=n>i4</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>i4</span><span class=p>)</span><span class=o>.</span><span class=n>flatten</span><span class=p>()</span>
</span><span id=__span-15-35><a id=__codelineno-15-35 name=__codelineno-15-35 href=#__codelineno-15-35></a>
</span><span id=__span-15-36><a id=__codelineno-15-36 name=__codelineno-15-36 href=#__codelineno-15-36></a><span class=gp>&gt;&gt;&gt; </span><span class=n>i1</span>
</span><span id=__span-15-37><a id=__codelineno-15-37 name=__codelineno-15-37 href=#__codelineno-15-37></a><span class=go>[0 1 0 1 0 1 0 1]</span>
</span><span id=__span-15-38><a id=__codelineno-15-38 name=__codelineno-15-38 href=#__codelineno-15-38></a><span class=gp>&gt;&gt;&gt; </span><span class=n>i2</span>
</span><span id=__span-15-39><a id=__codelineno-15-39 name=__codelineno-15-39 href=#__codelineno-15-39></a><span class=go>[0 1 0 1 2 3 2 3]</span>
</span><span id=__span-15-40><a id=__codelineno-15-40 name=__codelineno-15-40 href=#__codelineno-15-40></a><span class=gp>&gt;&gt;&gt; </span><span class=n>i3</span>
</span><span id=__span-15-41><a id=__codelineno-15-41 name=__codelineno-15-41 href=#__codelineno-15-41></a><span class=go>[0 1 0 1 0 1 0 1]</span>
</span><span id=__span-15-42><a id=__codelineno-15-42 name=__codelineno-15-42 href=#__codelineno-15-42></a><span class=gp>&gt;&gt;&gt; </span><span class=n>i4</span>
</span><span id=__span-15-43><a id=__codelineno-15-43 name=__codelineno-15-43 href=#__codelineno-15-43></a><span class=go>[0 1 2 3 0 1 2 3]</span>
</span><span id=__span-15-44><a id=__codelineno-15-44 name=__codelineno-15-44 href=#__codelineno-15-44></a>
</span><span id=__span-15-45><a id=__codelineno-15-45 name=__codelineno-15-45 href=#__codelineno-15-45></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond1</span> <span class=o>=</span> <span class=n>cond1</span><span class=o>.</span><span class=n>iloc</span><span class=p>[:,</span> <span class=n>i1</span><span class=p>]</span>  <span class=c1># (5)!</span>
</span><span id=__span-15-46><a id=__codelineno-15-46 name=__codelineno-15-46 href=#__codelineno-15-46></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond2</span> <span class=o>=</span> <span class=n>cond2</span><span class=o>.</span><span class=n>iloc</span><span class=p>[:,</span> <span class=n>i2</span><span class=p>]</span>
</span><span id=__span-15-47><a id=__codelineno-15-47 name=__codelineno-15-47 href=#__codelineno-15-47></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond3</span> <span class=o>=</span> <span class=n>cond3</span><span class=o>.</span><span class=n>iloc</span><span class=p>[:,</span> <span class=n>i3</span><span class=p>]</span>
</span><span id=__span-15-48><a id=__codelineno-15-48 name=__codelineno-15-48 href=#__codelineno-15-48></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond4</span> <span class=o>=</span> <span class=n>cond4</span><span class=o>.</span><span class=n>iloc</span><span class=p>[:,</span> <span class=n>i4</span><span class=p>]</span>
</span><span id=__span-15-49><a id=__codelineno-15-49 name=__codelineno-15-49 href=#__codelineno-15-49></a>
</span><span id=__span-15-50><a id=__codelineno-15-50 name=__codelineno-15-50 href=#__codelineno-15-50></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=p>(</span><span class=n>cond1</span><span class=o>.</span><span class=n>vbt</span> <span class=o>&amp;</span> <span class=n>cond2</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span> <span class=o>|</span> <span class=p>(</span><span class=n>cond3</span><span class=o>.</span><span class=n>vbt</span> <span class=o>&amp;</span> <span class=n>cond4</span><span class=p>)</span>  <span class=c1># (6)!</span>
</span><span id=__span-15-51><a id=__codelineno-15-51 name=__codelineno-15-51 href=#__codelineno-15-51></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-15-52><a id=__codelineno-15-52 name=__codelineno-15-52 href=#__codelineno-15-52></a><span class=go>cond2_th  cond4_th  symbol </span>
</span><span id=__span-15-53><a id=__codelineno-15-53 name=__codelineno-15-53 href=#__codelineno-15-53></a><span class=go>0.3       0.1       BTCUSDT    11</span>
</span><span id=__span-15-54><a id=__codelineno-15-54 name=__codelineno-15-54 href=#__codelineno-15-54></a><span class=go>                    ETHUSDT    10</span>
</span><span id=__span-15-55><a id=__codelineno-15-55 name=__codelineno-15-55 href=#__codelineno-15-55></a><span class=go>          0.2       BTCUSDT    28</span>
</span><span id=__span-15-56><a id=__codelineno-15-56 name=__codelineno-15-56 href=#__codelineno-15-56></a><span class=go>                    ETHUSDT    27</span>
</span><span id=__span-15-57><a id=__codelineno-15-57 name=__codelineno-15-57 href=#__codelineno-15-57></a><span class=go>0.4       0.1       BTCUSDT     9</span>
</span><span id=__span-15-58><a id=__codelineno-15-58 name=__codelineno-15-58 href=#__codelineno-15-58></a><span class=go>                    ETHUSDT     5</span>
</span><span id=__span-15-59><a id=__codelineno-15-59 name=__codelineno-15-59 href=#__codelineno-15-59></a><span class=go>          0.2       BTCUSDT    26</span>
</span><span id=__span-15-60><a id=__codelineno-15-60 name=__codelineno-15-60 href=#__codelineno-15-60></a><span class=go>                    ETHUSDT    22</span>
</span><span id=__span-15-61><a id=__codelineno-15-61 name=__codelineno-15-61 href=#__codelineno-15-61></a><span class=go>dtype: int64</span>
</span></code></pre></div> <ol> <li>Each DataFrame should contain only unique parameter combinations (and columns in general).</li> <li>Split each position array into blocks with symbols.</li> <li>Combine all blocks (parameter combinations) using the Cartesian product.</li> <li>Flatten each array with blocks to get an array that can be used for indexing.</li> <li>Use the final positions to select the columns from each DataFrame so that each DataFrame has the same number of columns.</li> <li>All columns now have the same length but still different labels <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg></span> let VBT's broadcaster handle the alignment.</li> </ol> <p>In newer versions of VBT, the same effect can be achieved with a single call to <a href=https://vectorbt.pro/pvt_41531c19/api/base/accessors/#vectorbtpro.base.accessors.BaseAccessor.cross>BaseAccessor.cross</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond1</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span> <span class=o>&lt;</span> <span class=n>bb</span><span class=o>.</span><span class=n>lowerband</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond2</span> <span class=o>=</span> <span class=n>bandwidth</span><span class=o>.</span><span class=n>vbt</span> <span class=o>&gt;</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mf>0.3</span><span class=p>,</span> <span class=mf>0.4</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;cond2_th&quot;</span><span class=p>)</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond3</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;High&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span> <span class=o>&gt;</span> <span class=n>bb</span><span class=o>.</span><span class=n>upperband</span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond4</span> <span class=o>=</span> <span class=n>bandwidth</span><span class=o>.</span><span class=n>vbt</span> <span class=o>&lt;</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;cond4_th&quot;</span><span class=p>)</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond1</span><span class=p>,</span> <span class=n>cond2</span><span class=p>,</span> <span class=n>cond3</span><span class=p>,</span> <span class=n>cond4</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pd_acc</span><span class=o>.</span><span class=n>x</span><span class=p>(</span><span class=n>cond1</span><span class=p>,</span> <span class=n>cond2</span><span class=p>,</span> <span class=n>cond3</span><span class=p>,</span> <span class=n>cond4</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=p>(</span><span class=n>cond1</span><span class=o>.</span><span class=n>vbt</span> <span class=o>&amp;</span> <span class=n>cond2</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span> <span class=o>|</span> <span class=p>(</span><span class=n>cond3</span><span class=o>.</span><span class=n>vbt</span> <span class=o>&amp;</span> <span class=n>cond4</span><span class=p>)</span>
</span></code></pre></div> <ol> <li><code>x</code> is an alias for <code>cross</code>. Another option: <code>cond1.vbt.x(cond2, cond3, cond4)</code>.</li> </ol> <p>A simpler and less error-prone approach is to build an indicator that handles parameter combinations for us <img alt=😁 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f601.svg title=:grin:></p> <p>For this, we will write an indicator expression similar to the code we wrote for a single parameter combination, and use <a href=https://vectorbt.pro/pvt_41531c19/api/indicators/factory/#vectorbtpro.indicators.factory.IndicatorFactory.from_expr>IndicatorFactory.from_expr</a> to auto-build an indicator by parsing that expression. The logic, including the specification of all inputs, parameters, and outputs, is contained within the expression itself. We will use the annotation <code>@res_talib_bbands</code> to resolve the inputs and parameters expected by TA-Lib's <code>BBANDS</code> indicator, and "copy" them to our indicator by also adding the prefix <code>talib</code> to the parameter names. Then, we perform the usual signal generation logic, substituting the custom parameters <code>cond2_th</code> and <code>cond4_th</code> with their individual values, and return the entire result as an output <code>mask</code> with the proper annotation.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>MaskGenerator</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>IF</span><span class=o>.</span><span class=n>from_expr</span><span class=p>(</span><span class=s2>&quot;&quot;&quot;</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=gp>... </span><span class=s2>upperband, middleband, lowerband = @res_talib_bbands</span>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=gp>... </span><span class=s2>bandwidth = (upperband - lowerband) / middleband</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=gp>... </span><span class=s2>cond1 = low &lt; lowerband</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=gp>... </span><span class=s2>cond2 = bandwidth &gt; @p_cond2_th</span>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=gp>... </span><span class=s2>cond3 = high &gt; upperband</span>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a><span class=gp>... </span><span class=s2>cond4 = bandwidth &lt; @p_cond4_th</span>
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a><span class=gp>... </span><span class=s2>@out_mask:(cond1 &amp; cond2) | (cond3 &amp; cond4)</span>
</span><span id=__span-17-9><a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a><span class=gp>... </span><span class=s2>&quot;&quot;&quot;</span><span class=p>)</span>
</span><span id=__span-17-10><a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a>
</span><span id=__span-17-11><a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>phelp</span><span class=p>(</span><span class=n>MaskGenerator</span><span class=o>.</span><span class=n>run</span><span class=p>,</span> <span class=n>incl_doc</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-17-12><a id=__codelineno-17-12 name=__codelineno-17-12 href=#__codelineno-17-12></a><span class=go>Indicator.run(</span>
</span><span id=__span-17-13><a id=__codelineno-17-13 name=__codelineno-17-13 href=#__codelineno-17-13></a><span class=go>    high,</span>
</span><span id=__span-17-14><a id=__codelineno-17-14 name=__codelineno-17-14 href=#__codelineno-17-14></a><span class=go>    low,</span>
</span><span id=__span-17-15><a id=__codelineno-17-15 name=__codelineno-17-15 href=#__codelineno-17-15></a><span class=go>    close,</span>
</span><span id=__span-17-16><a id=__codelineno-17-16 name=__codelineno-17-16 href=#__codelineno-17-16></a><span class=go>    cond2_th,</span>
</span><span id=__span-17-17><a id=__codelineno-17-17 name=__codelineno-17-17 href=#__codelineno-17-17></a><span class=go>    cond4_th,</span>
</span><span id=__span-17-18><a id=__codelineno-17-18 name=__codelineno-17-18 href=#__codelineno-17-18></a><span class=go>    bbands_timeperiod=Default(value=5),</span>
</span><span id=__span-17-19><a id=__codelineno-17-19 name=__codelineno-17-19 href=#__codelineno-17-19></a><span class=go>    bbands_nbdevup=Default(value=2),</span>
</span><span id=__span-17-20><a id=__codelineno-17-20 name=__codelineno-17-20 href=#__codelineno-17-20></a><span class=go>    bbands_nbdevdn=Default(value=2),</span>
</span><span id=__span-17-21><a id=__codelineno-17-21 name=__codelineno-17-21 href=#__codelineno-17-21></a><span class=go>    bbands_matype=Default(value=0),</span>
</span><span id=__span-17-22><a id=__codelineno-17-22 name=__codelineno-17-22 href=#__codelineno-17-22></a><span class=go>    bbands_timeframe=Default(value=None),</span>
</span><span id=__span-17-23><a id=__codelineno-17-23 name=__codelineno-17-23 href=#__codelineno-17-23></a><span class=go>    short_name=&#39;custom&#39;,</span>
</span><span id=__span-17-24><a id=__codelineno-17-24 name=__codelineno-17-24 href=#__codelineno-17-24></a><span class=go>    hide_params=None,</span>
</span><span id=__span-17-25><a id=__codelineno-17-25 name=__codelineno-17-25 href=#__codelineno-17-25></a><span class=go>    hide_default=True,</span>
</span><span id=__span-17-26><a id=__codelineno-17-26 name=__codelineno-17-26 href=#__codelineno-17-26></a><span class=go>    **kwargs</span>
</span><span id=__span-17-27><a id=__codelineno-17-27 name=__codelineno-17-27 href=#__codelineno-17-27></a><span class=go>)</span>
</span><span id=__span-17-28><a id=__codelineno-17-28 name=__codelineno-17-28 href=#__codelineno-17-28></a>
</span><span id=__span-17-29><a id=__codelineno-17-29 name=__codelineno-17-29 href=#__codelineno-17-29></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask_generator</span> <span class=o>=</span> <span class=n>MaskGenerator</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span><span id=__span-17-30><a id=__codelineno-17-30 name=__codelineno-17-30 href=#__codelineno-17-30></a><span class=gp>... </span>    <span class=n>high</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;High&quot;</span><span class=p>),</span>
</span><span id=__span-17-31><a id=__codelineno-17-31 name=__codelineno-17-31 href=#__codelineno-17-31></a><span class=gp>... </span>    <span class=n>low</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>),</span>
</span><span id=__span-17-32><a id=__codelineno-17-32 name=__codelineno-17-32 href=#__codelineno-17-32></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>),</span>
</span><span id=__span-17-33><a id=__codelineno-17-33 name=__codelineno-17-33 href=#__codelineno-17-33></a><span class=gp>... </span>    <span class=n>cond2_th</span><span class=o>=</span><span class=p>[</span><span class=mf>0.3</span><span class=p>,</span> <span class=mf>0.4</span><span class=p>],</span>
</span><span id=__span-17-34><a id=__codelineno-17-34 name=__codelineno-17-34 href=#__codelineno-17-34></a><span class=gp>... </span>    <span class=n>cond4_th</span><span class=o>=</span><span class=p>[</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>],</span>
</span><span id=__span-17-35><a id=__codelineno-17-35 name=__codelineno-17-35 href=#__codelineno-17-35></a><span class=gp>... </span>    <span class=n>bbands_timeperiod</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Default</span><span class=p>(</span><span class=mi>14</span><span class=p>),</span>
</span><span id=__span-17-36><a id=__codelineno-17-36 name=__codelineno-17-36 href=#__codelineno-17-36></a><span class=gp>... </span>    <span class=n>param_product</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-17-37><a id=__codelineno-17-37 name=__codelineno-17-37 href=#__codelineno-17-37></a><span class=gp>... </span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-17-38><a id=__codelineno-17-38 name=__codelineno-17-38 href=#__codelineno-17-38></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask_generator</span><span class=o>.</span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-17-39><a id=__codelineno-17-39 name=__codelineno-17-39 href=#__codelineno-17-39></a><span class=go>custom_cond2_th  custom_cond4_th  symbol </span>
</span><span id=__span-17-40><a id=__codelineno-17-40 name=__codelineno-17-40 href=#__codelineno-17-40></a><span class=go>0.3              0.1              BTCUSDT    11</span>
</span><span id=__span-17-41><a id=__codelineno-17-41 name=__codelineno-17-41 href=#__codelineno-17-41></a><span class=go>                                  ETHUSDT    10</span>
</span><span id=__span-17-42><a id=__codelineno-17-42 name=__codelineno-17-42 href=#__codelineno-17-42></a><span class=go>                 0.2              BTCUSDT    28</span>
</span><span id=__span-17-43><a id=__codelineno-17-43 name=__codelineno-17-43 href=#__codelineno-17-43></a><span class=go>                                  ETHUSDT    27</span>
</span><span id=__span-17-44><a id=__codelineno-17-44 name=__codelineno-17-44 href=#__codelineno-17-44></a><span class=go>0.4              0.1              BTCUSDT     9</span>
</span><span id=__span-17-45><a id=__codelineno-17-45 name=__codelineno-17-45 href=#__codelineno-17-45></a><span class=go>                                  ETHUSDT     5</span>
</span><span id=__span-17-46><a id=__codelineno-17-46 name=__codelineno-17-46 href=#__codelineno-17-46></a><span class=go>                 0.2              BTCUSDT    26</span>
</span><span id=__span-17-47><a id=__codelineno-17-47 name=__codelineno-17-47 href=#__codelineno-17-47></a><span class=go>                                  ETHUSDT    22</span>
</span><span id=__span-17-48><a id=__codelineno-17-48 name=__codelineno-17-48 href=#__codelineno-17-48></a><span class=go>dtype: int64</span>
</span></code></pre></div> <ol> <li>See the arguments that the run method expects.</li> <li>Run the indicator on the Cartesian product of all parameters.</li> </ol> <div class="admonition info"> <p class=admonition-title>Info</p> <p>Even though the indicator factory includes "indicator" in its name, we can use it to generate signals just as easily. This is because signals are simply boolean arrays that always match the shape of the input.</p> </div> <h2 id=shifting>Shifting<a class=headerlink href=#shifting title="Permanent link">&para;</a></h2> <p>To compare the current value to any previous (not future!) value, we can use forward shifting. You can also use this to shift the final mask to delay order execution. For example, let's generate a signal whenever the low price dips below the lower band AND the bandwidth change (that is, the difference between the current and previous bandwidth) is positive:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond1</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>bb</span><span class=o>.</span><span class=n>lowerband</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond2</span> <span class=o>=</span> <span class=n>bandwidth</span> <span class=o>&gt;</span> <span class=n>bandwidth</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>cond1</span> <span class=o>&amp;</span> <span class=n>cond2</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a><span class=go>symbol</span>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a><span class=go>BTCUSDT    42</span>
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a><span class=go>ETHUSDT    39</span>
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a><span class=go>dtype: int64</span>
</span></code></pre></div> <ol> <li>The shifted array contains the previous values.</li> </ol> <div class="admonition important"> <p class=admonition-title>Important</p> <p>Never attempt to shift backwards, as this can lead to look-ahead bias! Use either a positive number in <a href=https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.shift.html>DataFrame.shift</a>, or VBT's accessor method <a href=https://vectorbt.pro/pvt_41531c19/api/generic/accessors/#vectorbtpro.generic.accessors.GenericAccessor.fshift>GenericAccessor.fshift</a>.</p> </div> <p>Another way to shift observations is by selecting the first observation within a rolling window. This is especially useful when the rolling window has a variable size based on a frequency. Let's do the same logic as above, but determine the bandwidth change relative to one week ago, instead of yesterday:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond2</span> <span class=o>=</span> <span class=n>bandwidth</span> <span class=o>&gt;</span> <span class=n>bandwidth</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=s2>&quot;7d&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>cond1</span> <span class=o>&amp;</span> <span class=n>cond2</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=go>symbol</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=go>BTCUSDT    33</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a><span class=go>ETHUSDT    28</span>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a><span class=go>dtype: int64</span>
</span></code></pre></div> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>Prefer variable windows over fixed ones if your data contains gaps.</p> </div> <p>The approach above is a step in the right direction, but it introduces two possible issues: all windows will be either 6 days long or less, and the rolling application of a custom Python function in Pandas is not very efficient. The first issue can be solved by rolling a window of 8 days and checking that the first observation is exactly 7 days before the current timestamp:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>exactly_ago</span><span class=p>(</span><span class=n>sr</span><span class=p>):</span>  <span class=c1># (1)!</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>sr</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=n>sr</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s2>&quot;7d&quot;</span><span class=p>):</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=gp>... </span>        <span class=k>return</span> <span class=n>sr</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a>
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond_7d_ago</span> <span class=o>=</span> <span class=n>bandwidth</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=s2>&quot;8d&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>exactly_ago</span><span class=p>,</span> <span class=n>raw</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond2</span> <span class=o>=</span> <span class=n>bandwidth</span> <span class=o>&gt;</span> <span class=n>cond_7d_ago</span>
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a>
</span><span id=__span-20-9><a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>cond1</span> <span class=o>&amp;</span> <span class=n>cond2</span>
</span><span id=__span-20-10><a id=__codelineno-20-10 name=__codelineno-20-10 href=#__codelineno-20-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-20-11><a id=__codelineno-20-11 name=__codelineno-20-11 href=#__codelineno-20-11></a><span class=go>symbol</span>
</span><span id=__span-20-12><a id=__codelineno-20-12 name=__codelineno-20-12 href=#__codelineno-20-12></a><span class=go>BTCUSDT    29</span>
</span><span id=__span-20-13><a id=__codelineno-20-13 name=__codelineno-20-13 href=#__codelineno-20-13></a><span class=go>ETHUSDT    26</span>
</span><span id=__span-20-14><a id=__codelineno-20-14 name=__codelineno-20-14 href=#__codelineno-20-14></a><span class=go>dtype: int64</span>
</span></code></pre></div> <ol> <li>By passing <code>raw=False</code>, the input will be a Pandas Series.</li> </ol> <p>The second issue can be solved by looping with Numba. The main challenge, however, is solving both issues at once, since we want to access the timestamp of the first observation. This requires working on a Pandas Series rather than a NumPy array, but Numba cannot operate on Pandas Series <img alt=😑 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f611.svg title=:expressionless:></p> <p>Therefore, we can use VBT's accessor method <a href=https://vectorbt.pro/pvt_41531c19/api/generic/accessors/#vectorbtpro.generic.accessors.GenericAccessor.rolling_apply>GenericAccessor.rolling_apply</a>, which provides two modes: regular and meta. The regular mode rolls over the data of a Pandas object like Pandas does but does not provide information about the current window <img alt=🙅 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f645.svg title=:no_good:> The meta mode rolls over the <strong>metadata</strong> of a Pandas object, so we can easily select data from any array corresponding to the current window <img alt=👌 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f44c.svg title=:ok_hand:></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>exactly_ago_meta_nb</span><span class=p>(</span><span class=n>from_i</span><span class=p>,</span> <span class=n>to_i</span><span class=p>,</span> <span class=n>col</span><span class=p>,</span> <span class=n>index</span><span class=p>,</span> <span class=n>freq</span><span class=p>,</span> <span class=n>arr</span><span class=p>):</span>  <span class=c1># (1)!</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>index</span><span class=p>[</span><span class=n>from_i</span><span class=p>]</span> <span class=o>==</span> <span class=n>index</span><span class=p>[</span><span class=n>to_i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>freq</span><span class=p>:</span>  <span class=c1># (2)!</span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=gp>... </span>        <span class=k>return</span> <span class=n>arr</span><span class=p>[</span><span class=n>from_i</span><span class=p>,</span> <span class=n>col</span><span class=p>]</span>  <span class=c1># (3)!</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond_7d_ago</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pd_acc</span><span class=o>.</span><span class=n>rolling_apply</span><span class=p>(</span>
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a><span class=gp>... </span>    <span class=s2>&quot;8d&quot;</span><span class=p>,</span>
</span><span id=__span-21-9><a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a><span class=gp>... </span>    <span class=n>exactly_ago_meta_nb</span><span class=p>,</span>
</span><span id=__span-21-10><a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a><span class=gp>... </span>    <span class=n>bandwidth</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>  <span class=c1># (4)!</span>
</span><span id=__span-21-11><a id=__codelineno-21-11 name=__codelineno-21-11 href=#__codelineno-21-11></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s2>&quot;7d&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>to_timedelta64</span><span class=p>(),</span>
</span><span id=__span-21-12><a id=__codelineno-21-12 name=__codelineno-21-12 href=#__codelineno-21-12></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array</span><span class=p>(</span><span class=n>bandwidth</span><span class=p>),</span>
</span><span id=__span-21-13><a id=__codelineno-21-13 name=__codelineno-21-13 href=#__codelineno-21-13></a><span class=gp>... </span>    <span class=n>wrapper</span><span class=o>=</span><span class=n>bandwidth</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>wrapper</span>  <span class=c1># (5)!</span>
</span><span id=__span-21-14><a id=__codelineno-21-14 name=__codelineno-21-14 href=#__codelineno-21-14></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-21-15><a id=__codelineno-21-15 name=__codelineno-21-15 href=#__codelineno-21-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond2</span> <span class=o>=</span> <span class=n>bandwidth</span> <span class=o>&gt;</span> <span class=n>cond_7d_ago</span>
</span><span id=__span-21-16><a id=__codelineno-21-16 name=__codelineno-21-16 href=#__codelineno-21-16></a>
</span><span id=__span-21-17><a id=__codelineno-21-17 name=__codelineno-21-17 href=#__codelineno-21-17></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>cond1</span> <span class=o>&amp;</span> <span class=n>cond2</span>
</span><span id=__span-21-18><a id=__codelineno-21-18 name=__codelineno-21-18 href=#__codelineno-21-18></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-21-19><a id=__codelineno-21-19 name=__codelineno-21-19 href=#__codelineno-21-19></a><span class=go>symbol</span>
</span><span id=__span-21-20><a id=__codelineno-21-20 name=__codelineno-21-20 href=#__codelineno-21-20></a><span class=go>BTCUSDT    29</span>
</span><span id=__span-21-21><a id=__codelineno-21-21 name=__codelineno-21-21 href=#__codelineno-21-21></a><span class=go>ETHUSDT    26</span>
</span><span id=__span-21-22><a id=__codelineno-21-22 name=__codelineno-21-22 href=#__codelineno-21-22></a><span class=go>dtype: int64</span>
</span></code></pre></div> <ol> <li>The meta function must take three arguments: the current window start index, window end index, and column.</li> <li>The window end index is exclusive, so use <code>to_i - 1</code> to get the last index in the window.</li> <li>Use the current column index to select the column. Make sure all arrays are two-dimensional.</li> <li>Here are our three user-defined arguments.</li> <li>The wrapper contains the metadata needed for iterating and building the final Pandas object.</li> </ol> <p>If this approach feels intimidating, there is an even simpler method: <a href=https://vectorbt.pro/pvt_41531c19/api/generic/accessors/#vectorbtpro.generic.accessors.GenericAccessor.ago>GenericAccessor.ago</a>, which can forward-shift the array by any delta:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond2</span> <span class=o>=</span> <span class=n>bandwidth</span> <span class=o>&gt;</span> <span class=n>bandwidth</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>ago</span><span class=p>(</span><span class=s2>&quot;7d&quot;</span><span class=p>)</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>cond1</span> <span class=o>&amp;</span> <span class=n>cond2</span>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a><span class=go>symbol</span>
</span><span id=__span-22-6><a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a><span class=go>BTCUSDT    29</span>
</span><span id=__span-22-7><a id=__codelineno-22-7 name=__codelineno-22-7 href=#__codelineno-22-7></a><span class=go>ETHUSDT    26</span>
</span><span id=__span-22-8><a id=__codelineno-22-8 name=__codelineno-22-8 href=#__codelineno-22-8></a><span class=go>dtype: int64</span>
</span><span id=__span-22-9><a id=__codelineno-22-9 name=__codelineno-22-9 href=#__codelineno-22-9></a>
</span><span id=__span-22-10><a id=__codelineno-22-10 name=__codelineno-22-10 href=#__codelineno-22-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>bandwidth</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>8</span><span class=p>]</span>
</span><span id=__span-22-11><a id=__codelineno-22-11 name=__codelineno-22-11 href=#__codelineno-22-11></a><span class=go>symbol</span>
</span><span id=__span-22-12><a id=__codelineno-22-12 name=__codelineno-22-12 href=#__codelineno-22-12></a><span class=go>BTCUSDT    0.125477</span>
</span><span id=__span-22-13><a id=__codelineno-22-13 name=__codelineno-22-13 href=#__codelineno-22-13></a><span class=go>ETHUSDT    0.096458</span>
</span><span id=__span-22-14><a id=__codelineno-22-14 name=__codelineno-22-14 href=#__codelineno-22-14></a><span class=go>Name: 2021-12-24 00:00:00+00:00, dtype: float64</span>
</span><span id=__span-22-15><a id=__codelineno-22-15 name=__codelineno-22-15 href=#__codelineno-22-15></a>
</span><span id=__span-22-16><a id=__codelineno-22-16 name=__codelineno-22-16 href=#__codelineno-22-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>bandwidth</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>ago</span><span class=p>(</span><span class=s2>&quot;7d&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-22-17><a id=__codelineno-22-17 name=__codelineno-22-17 href=#__codelineno-22-17></a><span class=go>symbol</span>
</span><span id=__span-22-18><a id=__codelineno-22-18 name=__codelineno-22-18 href=#__codelineno-22-18></a><span class=go>BTCUSDT    0.125477</span>
</span><span id=__span-22-19><a id=__codelineno-22-19 name=__codelineno-22-19 href=#__codelineno-22-19></a><span class=go>ETHUSDT    0.096458</span>
</span><span id=__span-22-20><a id=__codelineno-22-20 name=__codelineno-22-20 href=#__codelineno-22-20></a><span class=go>Name: 2021-12-31 00:00:00+00:00, dtype: float64</span>
</span></code></pre></div> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>This method returns exact matches. If there is no exact match, the value will be NaN. To return the previous index value instead, pass <code>method="ffill"</code>. The method also accepts a sequence of deltas that can be applied per element.</p> </div> <h2 id=truth-value-testing>Truth value testing<a class=headerlink href=#truth-value-testing title="Permanent link">&para;</a></h2> <p>What if we want to test whether a certain condition was met within a period of time in the past? To do this, we need to create an expanding or rolling window and use truth value testing with <a href=https://numpy.org/doc/stable/reference/generated/numpy.any.html>numpy.any</a> or <a href=https://numpy.org/doc/stable/reference/generated/numpy.all.html>numpy.all</a> within this window. Because Pandas does not implement rolling aggregation using <code>any</code> and <code>all</code>, we need to be more creative and treat booleans as integers: use <code>max</code> for logical OR and <code>min</code> for logical AND. Also, remember to cast the resulting array to a boolean data type to generate a valid mask.</p> <p>Let's generate a signal whenever the low price goes below the lower band AND there was a downward crossover of the close price with the middle band in the past 5 candles:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond2</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>crossed_below</span><span class=p>(</span><span class=n>bb</span><span class=o>.</span><span class=n>middleband</span><span class=p>)</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond2</span> <span class=o>=</span> <span class=n>cond2</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=n>min_periods</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>max</span><span class=p>()</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>bool</span><span class=p>)</span>
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a>
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>cond1</span> <span class=o>&amp;</span> <span class=n>cond2</span>
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-23-6><a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a><span class=go>symbol</span>
</span><span id=__span-23-7><a id=__codelineno-23-7 name=__codelineno-23-7 href=#__codelineno-23-7></a><span class=go>BTCUSDT    36</span>
</span><span id=__span-23-8><a id=__codelineno-23-8 name=__codelineno-23-8 href=#__codelineno-23-8></a><span class=go>ETHUSDT    28</span>
</span><span id=__span-23-9><a id=__codelineno-23-9 name=__codelineno-23-9 href=#__codelineno-23-9></a><span class=go>dtype: int64</span>
</span></code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Be cautious when setting <code>min_periods</code> to a higher number and converting to a boolean data type: each NaN will become <code>True</code>. Always replace NaNs with zeros before casting.</p> </div> <p>If the window size is fixed, you can also use <a href=https://vectorbt.pro/pvt_41531c19/api/generic/accessors/#vectorbtpro.generic.accessors.GenericAccessor.rolling_any>GenericAccessor.rolling_any</a> and <a href=https://vectorbt.pro/pvt_41531c19/api/generic/accessors/#vectorbtpro.generic.accessors.GenericAccessor.rolling_all>GenericAccessor.rolling_all</a>, which are tailored for rolling truth value testing:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond2</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>crossed_below</span><span class=p>(</span><span class=n>bb</span><span class=o>.</span><span class=n>middleband</span><span class=p>)</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond2</span> <span class=o>=</span> <span class=n>cond2</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>rolling_any</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>cond1</span> <span class=o>&amp;</span> <span class=n>cond2</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a><span class=go>symbol</span>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=go>BTCUSDT    36</span>
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a><span class=go>ETHUSDT    28</span>
</span><span id=__span-24-9><a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a><span class=go>dtype: int64</span>
</span></code></pre></div> <p>Another way to perform the same rolling operations is by using the accessor method <a href=https://vectorbt.pro/pvt_41531c19/api/generic/accessors/#vectorbtpro.generic.accessors.GenericAccessor.rolling_apply>GenericAccessor.rolling_apply</a> and setting <code>reduce_func_nb</code> to "any" or "all". Use the argument <code>wrap_kwargs</code> to instruct VBT to fill NaNs with <code>False</code> and change the data type. This method also allows passing flexible windows. For example, let's roll a window of 5 days:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond2</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>crossed_below</span><span class=p>(</span><span class=n>bb</span><span class=o>.</span><span class=n>middleband</span><span class=p>)</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>cond2</span> <span class=o>=</span> <span class=n>cond2</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>rolling_apply</span><span class=p>(</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=gp>... </span>    <span class=s2>&quot;5d&quot;</span><span class=p>,</span> <span class=s2>&quot;any&quot;</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a><span class=gp>... </span>    <span class=n>minp</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> 
</span><span id=__span-25-5><a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a><span class=gp>... </span>    <span class=n>wrap_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>fillna</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=nb>bool</span><span class=p>)</span>
</span><span id=__span-25-6><a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-25-7><a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a>
</span><span id=__span-25-8><a id=__codelineno-25-8 name=__codelineno-25-8 href=#__codelineno-25-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>cond1</span> <span class=o>&amp;</span> <span class=n>cond2</span>
</span><span id=__span-25-9><a id=__codelineno-25-9 name=__codelineno-25-9 href=#__codelineno-25-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-25-10><a id=__codelineno-25-10 name=__codelineno-25-10 href=#__codelineno-25-10></a><span class=go>symbol</span>
</span><span id=__span-25-11><a id=__codelineno-25-11 name=__codelineno-25-11 href=#__codelineno-25-11></a><span class=go>BTCUSDT    36</span>
</span><span id=__span-25-12><a id=__codelineno-25-12 name=__codelineno-25-12 href=#__codelineno-25-12></a><span class=go>ETHUSDT    28</span>
</span><span id=__span-25-13><a id=__codelineno-25-13 name=__codelineno-25-13 href=#__codelineno-25-13></a><span class=go>dtype: int64</span>
</span></code></pre></div> <ol> <li>"any" is translated to <a href=https://vectorbt.pro/pvt_41531c19/api/generic/nb/apply_reduce/#vectorbtpro.generic.nb.apply_reduce.any_reduce_nb>any_reduce_nb</a>.</li> </ol> <p>Let's try something more complex: check whether the bandwidth contracted to 10% or less at any time within a month using an expanding window, then reset the window at the start of the next month. This approach uses the first timestamp of each month as a time anchor for our condition. We will use VBT's resampling logic, which lets us aggregate values by mapping any source index (anchor points) to any target index (our index).</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>anchor_points</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>get_index_points</span><span class=p>(</span>  <span class=c1># (1)!</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=s2>&quot;M&quot;</span><span class=p>,</span> 
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a><span class=gp>... </span>    <span class=n>start</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a><span class=gp>... </span>    <span class=n>exact_start</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>anchor_points</span>
</span><span id=__span-26-7><a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a><span class=go>array([  0,  31,  59,  90, 120, 151, 181, 212, 243, 273, 304, 334])</span>
</span><span id=__span-26-8><a id=__codelineno-26-8 name=__codelineno-26-8 href=#__codelineno-26-8></a>
</span><span id=__span-26-9><a id=__codelineno-26-9 name=__codelineno-26-9 href=#__codelineno-26-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>left_bound</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>index</span><span class=p>),</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-26-10><a id=__codelineno-26-10 name=__codelineno-26-10 href=#__codelineno-26-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>left_bound</span><span class=p>[</span><span class=n>anchor_points</span><span class=p>]</span> <span class=o>=</span> <span class=n>anchor_points</span>
</span><span id=__span-26-11><a id=__codelineno-26-11 name=__codelineno-26-11 href=#__codelineno-26-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>left_bound</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>ffill_1d_nb</span><span class=p>(</span><span class=n>left_bound</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=n>int_</span><span class=p>)</span>
</span><span id=__span-26-12><a id=__codelineno-26-12 name=__codelineno-26-12 href=#__codelineno-26-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>left_bound</span> <span class=o>=</span> <span class=n>bandwidth</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>left_bound</span><span class=p>]</span>
</span><span id=__span-26-13><a id=__codelineno-26-13 name=__codelineno-26-13 href=#__codelineno-26-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>left_bound</span>
</span><span id=__span-26-14><a id=__codelineno-26-14 name=__codelineno-26-14 href=#__codelineno-26-14></a><span class=go>DatetimeIndex([&#39;2021-01-01 00:00:00+00:00&#39;, &#39;2021-01-01 00:00:00+00:00&#39;,</span>
</span><span id=__span-26-15><a id=__codelineno-26-15 name=__codelineno-26-15 href=#__codelineno-26-15></a><span class=go>               &#39;2021-01-01 00:00:00+00:00&#39;, &#39;2021-01-01 00:00:00+00:00&#39;,</span>
</span><span id=__span-26-16><a id=__codelineno-26-16 name=__codelineno-26-16 href=#__codelineno-26-16></a><span class=go>               &#39;2021-01-01 00:00:00+00:00&#39;, &#39;2021-01-01 00:00:00+00:00&#39;,</span>
</span><span id=__span-26-17><a id=__codelineno-26-17 name=__codelineno-26-17 href=#__codelineno-26-17></a><span class=go>               ...</span>
</span><span id=__span-26-18><a id=__codelineno-26-18 name=__codelineno-26-18 href=#__codelineno-26-18></a><span class=go>               &#39;2021-12-01 00:00:00+00:00&#39;, &#39;2021-12-01 00:00:00+00:00&#39;,</span>
</span><span id=__span-26-19><a id=__codelineno-26-19 name=__codelineno-26-19 href=#__codelineno-26-19></a><span class=go>               &#39;2021-12-01 00:00:00+00:00&#39;, &#39;2021-12-01 00:00:00+00:00&#39;,</span>
</span><span id=__span-26-20><a id=__codelineno-26-20 name=__codelineno-26-20 href=#__codelineno-26-20></a><span class=go>               &#39;2021-12-01 00:00:00+00:00&#39;, &#39;2021-12-01 00:00:00+00:00&#39;],</span>
</span><span id=__span-26-21><a id=__codelineno-26-21 name=__codelineno-26-21 href=#__codelineno-26-21></a><span class=go>              dtype=&#39;datetime64[ns, UTC]&#39;, ...)</span>
</span><span id=__span-26-22><a id=__codelineno-26-22 name=__codelineno-26-22 href=#__codelineno-26-22></a>
</span><span id=__span-26-23><a id=__codelineno-26-23 name=__codelineno-26-23 href=#__codelineno-26-23></a><span class=gp>&gt;&gt;&gt; </span><span class=n>right_bound</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>index</span>  <span class=c1># (4)!</span>
</span><span id=__span-26-24><a id=__codelineno-26-24 name=__codelineno-26-24 href=#__codelineno-26-24></a><span class=gp>&gt;&gt;&gt; </span><span class=n>right_bound</span>
</span><span id=__span-26-25><a id=__codelineno-26-25 name=__codelineno-26-25 href=#__codelineno-26-25></a><span class=go>DatetimeIndex([&#39;2021-01-01 00:00:00+00:00&#39;, &#39;2021-01-02 00:00:00+00:00&#39;,</span>
</span><span id=__span-26-26><a id=__codelineno-26-26 name=__codelineno-26-26 href=#__codelineno-26-26></a><span class=go>               &#39;2021-01-03 00:00:00+00:00&#39;, &#39;2021-01-04 00:00:00+00:00&#39;,</span>
</span><span id=__span-26-27><a id=__codelineno-26-27 name=__codelineno-26-27 href=#__codelineno-26-27></a><span class=go>               &#39;2021-01-05 00:00:00+00:00&#39;, &#39;2021-01-06 00:00:00+00:00&#39;,</span>
</span><span id=__span-26-28><a id=__codelineno-26-28 name=__codelineno-26-28 href=#__codelineno-26-28></a><span class=go>               ...</span>
</span><span id=__span-26-29><a id=__codelineno-26-29 name=__codelineno-26-29 href=#__codelineno-26-29></a><span class=go>               &#39;2021-12-26 00:00:00+00:00&#39;, &#39;2021-12-27 00:00:00+00:00&#39;,</span>
</span><span id=__span-26-30><a id=__codelineno-26-30 name=__codelineno-26-30 href=#__codelineno-26-30></a><span class=go>               &#39;2021-12-28 00:00:00+00:00&#39;, &#39;2021-12-29 00:00:00+00:00&#39;,</span>
</span><span id=__span-26-31><a id=__codelineno-26-31 name=__codelineno-26-31 href=#__codelineno-26-31></a><span class=go>               &#39;2021-12-30 00:00:00+00:00&#39;, &#39;2021-12-31 00:00:00+00:00&#39;],</span>
</span><span id=__span-26-32><a id=__codelineno-26-32 name=__codelineno-26-32 href=#__codelineno-26-32></a><span class=go>              dtype=&#39;datetime64[ns, UTC]&#39;, ...)</span>
</span><span id=__span-26-33><a id=__codelineno-26-33 name=__codelineno-26-33 href=#__codelineno-26-33></a>
</span><span id=__span-26-34><a id=__codelineno-26-34 name=__codelineno-26-34 href=#__codelineno-26-34></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=p>(</span><span class=n>bandwidth</span> <span class=o>&lt;=</span> <span class=mf>0.1</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>resample_between_bounds</span><span class=p>(</span>  <span class=c1># (5)!</span>
</span><span id=__span-26-35><a id=__codelineno-26-35 name=__codelineno-26-35 href=#__codelineno-26-35></a><span class=gp>... </span>    <span class=n>left_bound</span><span class=p>,</span> 
</span><span id=__span-26-36><a id=__codelineno-26-36 name=__codelineno-26-36 href=#__codelineno-26-36></a><span class=gp>... </span>    <span class=n>right_bound</span><span class=p>,</span>
</span><span id=__span-26-37><a id=__codelineno-26-37 name=__codelineno-26-37 href=#__codelineno-26-37></a><span class=gp>... </span>    <span class=s2>&quot;any&quot;</span><span class=p>,</span>
</span><span id=__span-26-38><a id=__codelineno-26-38 name=__codelineno-26-38 href=#__codelineno-26-38></a><span class=gp>... </span>    <span class=n>closed_lbound</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>  <span class=c1># (6)!</span>
</span><span id=__span-26-39><a id=__codelineno-26-39 name=__codelineno-26-39 href=#__codelineno-26-39></a><span class=gp>... </span>    <span class=n>closed_rbound</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-26-40><a id=__codelineno-26-40 name=__codelineno-26-40 href=#__codelineno-26-40></a><span class=gp>... </span>    <span class=n>wrap_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>fillna</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=nb>bool</span><span class=p>)</span>
</span><span id=__span-26-41><a id=__codelineno-26-41 name=__codelineno-26-41 href=#__codelineno-26-41></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-26-42><a id=__codelineno-26-42 name=__codelineno-26-42 href=#__codelineno-26-42></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>index</span> <span class=o>=</span> <span class=n>right_bound</span>
</span><span id=__span-26-43><a id=__codelineno-26-43 name=__codelineno-26-43 href=#__codelineno-26-43></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>ts_heatmap</span><span class=p>()</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <ol> <li>Find the position of the first timestamp in each month using <a href=https://vectorbt.pro/pvt_41531c19/api/base/wrapping/#vectorbtpro.base.wrapping.ArrayWrapper.get_index_ranges>ArrayWrapper.get_index_ranges</a>.</li> <li>Remove this and the next line if you do not want to include the first month, in case it is incomplete.</li> <li>The left bound of each window is the corresponding anchor point (start of each month). Create an integer array the same size as our index, fill the anchor points at their positions, and forward fill them.</li> <li>The right bound of each window is the current index.</li> <li>Use <a href=https://vectorbt.pro/pvt_41531c19/api/generic/accessors/#vectorbtpro.generic.accessors.GenericAccessor.resample_between_bounds>GenericAccessor.resample_between_bounds</a> to map the mask values to their windows and aggregate each window using the "any" operation.</li> <li>Make both bounds inclusive to include every single timestamp in the month.</li> </ol> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/signal-dev/ts_heatmap.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/signal-dev/ts_heatmap.dark.svg#only-dark></p> <p>You can see how the signal for the bandwidth reaching the 10% mark propagates through each month, and then the calculation resets and repeats.</p> <h2 id=periodically>Periodically<a class=headerlink href=#periodically title="Permanent link">&para;</a></h2> <p>To set signals at regular intervals, such as at 18:00 each Tuesday, we have several options. One approach is to compare different attributes of the source and target datetime. For example, to get the timestamps for each Tuesday, you can compare <a href=https://pandas.pydata.org/docs/reference/api/pandas.DatetimeIndex.weekday.html#pandas.DatetimeIndex.weekday>pandas.DatetimeIndex.weekday</a> to 1 (Monday is 0 and Sunday is 6):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>min_data</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>BinanceData</span><span class=o>.</span><span class=n>pull</span><span class=p>(</span>  <span class=c1># (1)!</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=gp>... </span>    <span class=p>[</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>,</span> <span class=s2>&quot;ETHUSDT&quot;</span><span class=p>],</span> 
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=gp>... </span>    <span class=n>start</span><span class=o>=</span><span class=s2>&quot;2021-01-01 UTC&quot;</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=gp>... </span>    <span class=n>end</span><span class=o>=</span><span class=s2>&quot;2021-02-01 UTC&quot;</span><span class=p>,</span>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=gp>... </span>    <span class=n>timeframe</span><span class=o>=</span><span class=s2>&quot;1h&quot;</span>
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>index</span> <span class=o>=</span> <span class=n>min_data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>index</span>
</span><span id=__span-27-8><a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>tuesday_index</span> <span class=o>=</span> <span class=n>index</span><span class=p>[</span><span class=n>index</span><span class=o>.</span><span class=n>weekday</span> <span class=o>==</span> <span class=mi>1</span><span class=p>]</span>
</span><span id=__span-27-9><a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>tuesday_index</span>
</span><span id=__span-27-10><a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a><span class=go>DatetimeIndex([&#39;2021-01-05 00:00:00+00:00&#39;, &#39;2021-01-05 01:00:00+00:00&#39;,</span>
</span><span id=__span-27-11><a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a><span class=go>               &#39;2021-01-05 02:00:00+00:00&#39;, &#39;2021-01-05 03:00:00+00:00&#39;,</span>
</span><span id=__span-27-12><a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a><span class=go>               &#39;2021-01-05 04:00:00+00:00&#39;, &#39;2021-01-05 05:00:00+00:00&#39;,</span>
</span><span id=__span-27-13><a id=__codelineno-27-13 name=__codelineno-27-13 href=#__codelineno-27-13></a><span class=go>               ...</span>
</span><span id=__span-27-14><a id=__codelineno-27-14 name=__codelineno-27-14 href=#__codelineno-27-14></a><span class=go>               &#39;2021-01-26 18:00:00+00:00&#39;, &#39;2021-01-26 19:00:00+00:00&#39;,</span>
</span><span id=__span-27-15><a id=__codelineno-27-15 name=__codelineno-27-15 href=#__codelineno-27-15></a><span class=go>               &#39;2021-01-26 20:00:00+00:00&#39;, &#39;2021-01-26 21:00:00+00:00&#39;,</span>
</span><span id=__span-27-16><a id=__codelineno-27-16 name=__codelineno-27-16 href=#__codelineno-27-16></a><span class=go>               &#39;2021-01-26 22:00:00+00:00&#39;, &#39;2021-01-26 23:00:00+00:00&#39;],</span>
</span><span id=__span-27-17><a id=__codelineno-27-17 name=__codelineno-27-17 href=#__codelineno-27-17></a><span class=go>              dtype=&#39;datetime64[ns, UTC]&#39;, name=&#39;Open time&#39;, freq=None)</span>
</span></code></pre></div> <ol> <li>Fetch hourly data for a better illustration.</li> <li>Remember to use the UTC timezone for crypto data.</li> </ol> <p>Next, we can select only those timestamps that occur at a specific time:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>tuesday_1800_index</span> <span class=o>=</span> <span class=n>tuesday_index</span><span class=p>[</span><span class=n>tuesday_index</span><span class=o>.</span><span class=n>hour</span> <span class=o>==</span> <span class=mi>18</span><span class=p>]</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>tuesday_1800_index</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a><span class=go>DatetimeIndex([&#39;2021-01-05 18:00:00+00:00&#39;, &#39;2021-01-12 18:00:00+00:00&#39;,</span>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a><span class=go>               &#39;2021-01-19 18:00:00+00:00&#39;, &#39;2021-01-26 18:00:00+00:00&#39;],</span>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=go>              dtype=&#39;datetime64[ns, UTC]&#39;, name=&#39;Open time&#39;, freq=None)</span>
</span></code></pre></div> <p>Since each attribute comparison produces a mask, you can obtain your signals using logical operations. For example, to get the timestamps corresponding to each Tuesday at 17:30, compare the weekday to Tuesday AND the hour to 17 AND the minute to 30:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>tuesday_1730_index</span> <span class=o>=</span> <span class=n>index</span><span class=p>[</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a><span class=gp>... </span>    <span class=p>(</span><span class=n>index</span><span class=o>.</span><span class=n>weekday</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;</span> 
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a><span class=gp>... </span>    <span class=p>(</span><span class=n>index</span><span class=o>.</span><span class=n>hour</span> <span class=o>==</span> <span class=mi>17</span><span class=p>)</span> <span class=o>&amp;</span> 
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a><span class=gp>... </span>    <span class=p>(</span><span class=n>index</span><span class=o>.</span><span class=n>minute</span> <span class=o>==</span> <span class=mi>30</span><span class=p>)</span>
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a><span class=gp>... </span><span class=p>]</span>
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>tuesday_1730_index</span>
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a><span class=go>DatetimeIndex([], dtype=&#39;datetime64[ns, UTC]&#39;, name=&#39;Open time&#39;, freq=&#39;H&#39;)</span>
</span></code></pre></div> <p>As we can see, combining these conditions did not produce any exact matches because our index is hourly. But what if we want to get the previous or next timestamp when there is no exact match? In that case, the approach above will not work. Instead, we can use the function <a href=https://pandas.pydata.org/docs/reference/api/pandas.Index.get_indexer.html>pandas.Index.get_indexer</a>, which takes an array of index labels and searches for their corresponding positions in the index. For example, let's get the position of January 7th in our index:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>index</span><span class=o>.</span><span class=n>get_indexer</span><span class=p>([</span><span class=n>vbt</span><span class=o>.</span><span class=n>timestamp</span><span class=p>(</span><span class=s2>&quot;2021-01-07&quot;</span><span class=p>,</span> <span class=n>tz</span><span class=o>=</span><span class=n>index</span><span class=o>.</span><span class=n>tz</span><span class=p>)])</span>  <span class=c1># (1)!</span>
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a><span class=go>array([144])</span>
</span></code></pre></div> <ol> <li>Be sure to provide the timezone if the index is timezone-aware!</li> </ol> <p>If we look for an index that does not exist, it returns <code>-1</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>index</span><span class=o>.</span><span class=n>get_indexer</span><span class=p>([</span><span class=n>vbt</span><span class=o>.</span><span class=n>timestamp</span><span class=p>(</span><span class=s2>&quot;2021-01-07 17:30:00&quot;</span><span class=p>,</span> <span class=n>tz</span><span class=o>=</span><span class=n>index</span><span class=o>.</span><span class=n>tz</span><span class=p>)])</span> 
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a><span class=go>array([-1])</span>
</span></code></pre></div> <div class="admonition warning"> <p class=admonition-title>Warning</p> <p>Do not use the result directly for indexing if there is a chance of no match. For example, if any positions returned are <code>-1</code> and you use them to select timestamps, the position will be replaced by the latest timestamp in the index.</p> </div> <p>To get either the exact match or the previous one, pass <code>method='ffill'</code>. To get the next one, pass <code>method='bfill'</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>index</span><span class=p>[</span><span class=n>index</span><span class=o>.</span><span class=n>get_indexer</span><span class=p>(</span>
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a><span class=gp>... </span>    <span class=p>[</span><span class=n>vbt</span><span class=o>.</span><span class=n>timestamp</span><span class=p>(</span><span class=s2>&quot;2021-01-07 17:30:00&quot;</span><span class=p>,</span> <span class=n>tz</span><span class=o>=</span><span class=n>index</span><span class=o>.</span><span class=n>tz</span><span class=p>)],</span>
</span><span id=__span-32-3><a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a><span class=gp>... </span>    <span class=n>method</span><span class=o>=</span><span class=s2>&quot;ffill&quot;</span>
</span><span id=__span-32-4><a id=__codelineno-32-4 name=__codelineno-32-4 href=#__codelineno-32-4></a><span class=gp>... </span><span class=p>)]</span>
</span><span id=__span-32-5><a id=__codelineno-32-5 name=__codelineno-32-5 href=#__codelineno-32-5></a><span class=go>DatetimeIndex([&#39;2021-01-07 17:00:00+00:00&#39;], ...)</span>
</span><span id=__span-32-6><a id=__codelineno-32-6 name=__codelineno-32-6 href=#__codelineno-32-6></a>
</span><span id=__span-32-7><a id=__codelineno-32-7 name=__codelineno-32-7 href=#__codelineno-32-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>index</span><span class=p>[</span><span class=n>index</span><span class=o>.</span><span class=n>get_indexer</span><span class=p>(</span>
</span><span id=__span-32-8><a id=__codelineno-32-8 name=__codelineno-32-8 href=#__codelineno-32-8></a><span class=gp>... </span>    <span class=p>[</span><span class=n>vbt</span><span class=o>.</span><span class=n>timestamp</span><span class=p>(</span><span class=s2>&quot;2021-01-07 17:30:00&quot;</span><span class=p>,</span> <span class=n>tz</span><span class=o>=</span><span class=n>index</span><span class=o>.</span><span class=n>tz</span><span class=p>)],</span>
</span><span id=__span-32-9><a id=__codelineno-32-9 name=__codelineno-32-9 href=#__codelineno-32-9></a><span class=gp>... </span>    <span class=n>method</span><span class=o>=</span><span class=s2>&quot;bfill&quot;</span>
</span><span id=__span-32-10><a id=__codelineno-32-10 name=__codelineno-32-10 href=#__codelineno-32-10></a><span class=gp>... </span><span class=p>)]</span>
</span><span id=__span-32-11><a id=__codelineno-32-11 name=__codelineno-32-11 href=#__codelineno-32-11></a><span class=go>DatetimeIndex([&#39;2021-01-07 18:00:00+00:00&#39;], ...)</span>
</span></code></pre></div> <p>Returning to our example, we first need to generate the target index for our query to search in the source index. Use <a href=https://pandas.pydata.org/docs/reference/api/pandas.date_range.html>pandas.date_range</a> to get the timestamp for each Tuesday at midnight, then add a timedelta of 17 hours and 30 minutes. Next, convert the target index to positions (row indices) where our signals will be placed. Then, extract the Pandas symbol wrapper from our data instance and use it to create a new mask with the same number of columns as our symbols. Finally, set <code>True</code> at the generated positions of that mask:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>each_tuesday</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>date_range</span><span class=p>(</span><span class=n>index</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>index</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span> <span class=n>freq</span><span class=o>=</span><span class=s2>&quot;tuesday&quot;</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-33-2><a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>each_tuesday_1730</span> <span class=o>=</span> <span class=n>each_tuesday</span> <span class=o>+</span> <span class=n>pd</span><span class=o>.</span><span class=n>Timedelta</span><span class=p>(</span><span class=n>hours</span><span class=o>=</span><span class=mi>17</span><span class=p>,</span> <span class=n>minutes</span><span class=o>=</span><span class=mi>30</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-33-3><a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>each_tuesday_1730</span>
</span><span id=__span-33-4><a id=__codelineno-33-4 name=__codelineno-33-4 href=#__codelineno-33-4></a><span class=go>DatetimeIndex([&#39;2021-01-05 17:30:00+00:00&#39;, &#39;2021-01-12 17:30:00+00:00&#39;,</span>
</span><span id=__span-33-5><a id=__codelineno-33-5 name=__codelineno-33-5 href=#__codelineno-33-5></a><span class=go>               &#39;2021-01-19 17:30:00+00:00&#39;, &#39;2021-01-26 17:30:00+00:00&#39;],</span>
</span><span id=__span-33-6><a id=__codelineno-33-6 name=__codelineno-33-6 href=#__codelineno-33-6></a><span class=go>              dtype=&#39;datetime64[ns, UTC]&#39;, freq=None)</span>
</span><span id=__span-33-7><a id=__codelineno-33-7 name=__codelineno-33-7 href=#__codelineno-33-7></a>
</span><span id=__span-33-8><a id=__codelineno-33-8 name=__codelineno-33-8 href=#__codelineno-33-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>positions</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=n>get_indexer</span><span class=p>(</span><span class=n>each_tuesday_1730</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s2>&quot;bfill&quot;</span><span class=p>)</span>
</span><span id=__span-33-9><a id=__codelineno-33-9 name=__codelineno-33-9 href=#__codelineno-33-9></a>
</span><span id=__span-33-10><a id=__codelineno-33-10 name=__codelineno-33-10 href=#__codelineno-33-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>min_symbol_wrapper</span> <span class=o>=</span> <span class=n>min_data</span><span class=o>.</span><span class=n>get_symbol_wrapper</span><span class=p>()</span>  <span class=c1># (3)!</span>
</span><span id=__span-33-11><a id=__codelineno-33-11 name=__codelineno-33-11 href=#__codelineno-33-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>min_symbol_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=kc>False</span><span class=p>)</span>  <span class=c1># (4)!</span>
</span><span id=__span-33-12><a id=__codelineno-33-12 name=__codelineno-33-12 href=#__codelineno-33-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>positions</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>  <span class=c1># (5)!</span>
</span><span id=__span-33-13><a id=__codelineno-33-13 name=__codelineno-33-13 href=#__codelineno-33-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-33-14><a id=__codelineno-33-14 name=__codelineno-33-14 href=#__codelineno-33-14></a><span class=go>symbol</span>
</span><span id=__span-33-15><a id=__codelineno-33-15 name=__codelineno-33-15 href=#__codelineno-33-15></a><span class=go>BTCUSDT    4</span>
</span><span id=__span-33-16><a id=__codelineno-33-16 name=__codelineno-33-16 href=#__codelineno-33-16></a><span class=go>ETHUSDT    4</span>
</span><span id=__span-33-17><a id=__codelineno-33-17 name=__codelineno-33-17 href=#__codelineno-33-17></a><span class=go>dtype: int64</span>
</span></code></pre></div> <ol> <li>The timezone is included in both timestamps and will be used automatically.</li> <li>Adding a timedelta to a datetime creates a new datetime.</li> <li>Use <a href=https://vectorbt.pro/pvt_41531c19/api/data/base/#vectorbtpro.data.base.Data.get_symbol_wrapper>Data.get_symbol_wrapper</a> to get a Pandas wrapper with symbols as columns.</li> <li>Use <a href=https://vectorbt.pro/pvt_41531c19/api/base/wrapping/#vectorbtpro.base.wrapping.ArrayWrapper.fill>ArrayWrapper.fill</a> to create an array the same shape as the wrapper and fill it with <code>False</code> values.</li> <li>Positions are integer row indices, so use <code>iloc</code> to select the elements at those rows.</li> </ol> <p>Let's confirm that all signals match 18:00 on Tuesday, which is the first date after the requested 17:30 on Tuesday in an hourly index:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=p>[</span><span class=n>mask</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)]</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&quot;%A %T&quot;</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a><span class=go>Index([&#39;Tuesday 18:00:00&#39;, &#39;Tuesday 18:00:00&#39;, &#39;Tuesday 18:00:00&#39;,</span>
</span><span id=__span-34-3><a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a><span class=go>       &#39;Tuesday 18:00:00&#39;],</span>
</span><span id=__span-34-4><a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a><span class=go>      dtype=&#39;object&#39;, name=&#39;Open time&#39;)</span>
</span></code></pre></div> <ol> <li>Details for the string format can be found <a href=https://docs.python.org/3/library/datetime.html#strftime-and-strptime-behavior>here</a>.</li> </ol> <p>The solution above is only needed if you know just a single time boundary. For example, if you want 17:30 on Tuesday or later, you know only the left boundary, while the right boundary is infinity (or there may be no data after this datetime at all). When both time boundaries are known, you can easily use the first approach and combine it with VBT's signal selection mechanism. For example, place a signal at 17:00 on Tuesday or later, but not later than 17:00 on Wednesday. This means placing signals from the left boundary up to the right boundary, then selecting the first signal in that partition:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>tuesday_after_1700</span> <span class=o>=</span> <span class=p>(</span><span class=n>index</span><span class=o>.</span><span class=n>weekday</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>index</span><span class=o>.</span><span class=n>hour</span> <span class=o>&gt;=</span> <span class=mi>17</span><span class=p>)</span>
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>wednesday_before_1700</span> <span class=o>=</span> <span class=p>(</span><span class=n>index</span><span class=o>.</span><span class=n>weekday</span> <span class=o>==</span> <span class=mi>2</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>index</span><span class=o>.</span><span class=n>hour</span> <span class=o>&lt;</span> <span class=mi>17</span><span class=p>)</span>
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>main_cond</span> <span class=o>=</span> <span class=n>tuesday_after_1700</span> <span class=o>|</span> <span class=n>wednesday_before_1700</span>
</span><span id=__span-35-4><a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>min_symbol_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-35-5><a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=p>[</span><span class=n>main_cond</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-35-6><a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>mask</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
</span><span id=__span-35-7><a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=p>[</span><span class=n>mask</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)]</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&quot;%A %T&quot;</span><span class=p>)</span>
</span><span id=__span-35-8><a id=__codelineno-35-8 name=__codelineno-35-8 href=#__codelineno-35-8></a><span class=go>Index([&#39;Tuesday 17:00:00&#39;, &#39;Tuesday 17:00:00&#39;, &#39;Tuesday 17:00:00&#39;,</span>
</span><span id=__span-35-9><a id=__codelineno-35-9 name=__codelineno-35-9 href=#__codelineno-35-9></a><span class=go>       &#39;Tuesday 17:00:00&#39;],</span>
</span><span id=__span-35-10><a id=__codelineno-35-10 name=__codelineno-35-10 href=#__codelineno-35-10></a><span class=go>      dtype=&#39;object&#39;, name=&#39;Open time&#39;)</span>
</span></code></pre></div> <p>The third and final approach is the VBT way <img alt=❤️‍🔥 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2764-fe0f-200d-1f525.svg title=:heart_on_fire:></p> <p>This method uses the two accessor methods <a href=https://vectorbt.pro/pvt_41531c19/api/base/accessors/#vectorbtpro.base.accessors.BaseAccessor.set>BaseAccessor.set</a> and <a href=https://vectorbt.pro/pvt_41531c19/api/base/accessors/#vectorbtpro.base.accessors.BaseAccessor.set_between>BaseAccessor.set_between</a>, which let you set elements of an array conditionally in a more intuitive way.</p> <p>Place a signal at 17:30 each Tuesday or later:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>min_symbol_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-36-2><a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>set</span><span class=p>(</span>
</span><span id=__span-36-3><a id=__codelineno-36-3 name=__codelineno-36-3 href=#__codelineno-36-3></a><span class=gp>... </span>    <span class=kc>True</span><span class=p>,</span> 
</span><span id=__span-36-4><a id=__codelineno-36-4 name=__codelineno-36-4 href=#__codelineno-36-4></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=s2>&quot;tuesday&quot;</span><span class=p>,</span> 
</span><span id=__span-36-5><a id=__codelineno-36-5 name=__codelineno-36-5 href=#__codelineno-36-5></a><span class=gp>... </span>    <span class=n>at_time</span><span class=o>=</span><span class=s2>&quot;17:30&quot;</span><span class=p>,</span> 
</span><span id=__span-36-6><a id=__codelineno-36-6 name=__codelineno-36-6 href=#__codelineno-36-6></a><span class=gp>... </span>    <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-36-7><a id=__codelineno-36-7 name=__codelineno-36-7 href=#__codelineno-36-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-36-8><a id=__codelineno-36-8 name=__codelineno-36-8 href=#__codelineno-36-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=p>[</span><span class=n>mask</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)]</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&quot;%A %T&quot;</span><span class=p>)</span>
</span><span id=__span-36-9><a id=__codelineno-36-9 name=__codelineno-36-9 href=#__codelineno-36-9></a><span class=go>Index([&#39;Tuesday 18:00:00&#39;, &#39;Tuesday 18:00:00&#39;, &#39;Tuesday 18:00:00&#39;,</span>
</span><span id=__span-36-10><a id=__codelineno-36-10 name=__codelineno-36-10 href=#__codelineno-36-10></a><span class=go>       &#39;Tuesday 18:00:00&#39;],</span>
</span><span id=__span-36-11><a id=__codelineno-36-11 name=__codelineno-36-11 href=#__codelineno-36-11></a><span class=go>      dtype=&#39;object&#39;, name=&#39;Open time&#39;)</span>
</span></code></pre></div> <p>Place a signal after 18:00 each Tuesday (exclusive):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>min_symbol_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>set</span><span class=p>(</span>
</span><span id=__span-37-3><a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a><span class=gp>... </span>    <span class=kc>True</span><span class=p>,</span> 
</span><span id=__span-37-4><a id=__codelineno-37-4 name=__codelineno-37-4 href=#__codelineno-37-4></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=s2>&quot;tuesday&quot;</span><span class=p>,</span> 
</span><span id=__span-37-5><a id=__codelineno-37-5 name=__codelineno-37-5 href=#__codelineno-37-5></a><span class=gp>... </span>    <span class=n>at_time</span><span class=o>=</span><span class=s2>&quot;18:00&quot;</span><span class=p>,</span> 
</span><span id=__span-37-6><a id=__codelineno-37-6 name=__codelineno-37-6 href=#__codelineno-37-6></a><span class=gp>... </span>    <span class=n>add_delta</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Timedelta</span><span class=p>(</span><span class=n>nanoseconds</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>  <span class=c1># (1)!</span>
</span><span id=__span-37-7><a id=__codelineno-37-7 name=__codelineno-37-7 href=#__codelineno-37-7></a><span class=gp>... </span>    <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-37-8><a id=__codelineno-37-8 name=__codelineno-37-8 href=#__codelineno-37-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-37-9><a id=__codelineno-37-9 name=__codelineno-37-9 href=#__codelineno-37-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=p>[</span><span class=n>mask</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)]</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&quot;%A %T&quot;</span><span class=p>)</span>
</span><span id=__span-37-10><a id=__codelineno-37-10 name=__codelineno-37-10 href=#__codelineno-37-10></a><span class=go>Index([&#39;Tuesday 19:00:00&#39;, &#39;Tuesday 19:00:00&#39;, &#39;Tuesday 19:00:00&#39;,</span>
</span><span id=__span-37-11><a id=__codelineno-37-11 name=__codelineno-37-11 href=#__codelineno-37-11></a><span class=go>       &#39;Tuesday 19:00:00&#39;],</span>
</span><span id=__span-37-12><a id=__codelineno-37-12 name=__codelineno-37-12 href=#__codelineno-37-12></a><span class=go>      dtype=&#39;object&#39;, name=&#39;Open time&#39;)</span>
</span></code></pre></div> <ol> <li>Add a nanosecond to exclude 18:00.</li> </ol> <p>Fill signals between 12:00 each Monday and 17:00 each Tuesday:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>min_symbol_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>set_between</span><span class=p>(</span>
</span><span id=__span-38-3><a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a><span class=gp>... </span>    <span class=kc>True</span><span class=p>,</span> 
</span><span id=__span-38-4><a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=s2>&quot;monday&quot;</span><span class=p>,</span> 
</span><span id=__span-38-5><a id=__codelineno-38-5 name=__codelineno-38-5 href=#__codelineno-38-5></a><span class=gp>... </span>    <span class=n>start_time</span><span class=o>=</span><span class=s2>&quot;12:00&quot;</span><span class=p>,</span> 
</span><span id=__span-38-6><a id=__codelineno-38-6 name=__codelineno-38-6 href=#__codelineno-38-6></a><span class=gp>... </span>    <span class=n>end_time</span><span class=o>=</span><span class=s2>&quot;17:00&quot;</span><span class=p>,</span> 
</span><span id=__span-38-7><a id=__codelineno-38-7 name=__codelineno-38-7 href=#__codelineno-38-7></a><span class=gp>... </span>    <span class=n>add_end_delta</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>  <span class=c1># (1)!</span>
</span><span id=__span-38-8><a id=__codelineno-38-8 name=__codelineno-38-8 href=#__codelineno-38-8></a><span class=gp>... </span>    <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-38-9><a id=__codelineno-38-9 name=__codelineno-38-9 href=#__codelineno-38-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-38-10><a id=__codelineno-38-10 name=__codelineno-38-10 href=#__codelineno-38-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=p>[</span><span class=n>mask</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)]</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&quot;%A %T&quot;</span><span class=p>)</span>
</span><span id=__span-38-11><a id=__codelineno-38-11 name=__codelineno-38-11 href=#__codelineno-38-11></a><span class=go>Index([&#39;Monday 12:00:00&#39;, &#39;Monday 13:00:00&#39;, &#39;Monday 14:00:00&#39;,</span>
</span><span id=__span-38-12><a id=__codelineno-38-12 name=__codelineno-38-12 href=#__codelineno-38-12></a><span class=go>       &#39;Monday 15:00:00&#39;, &#39;Monday 16:00:00&#39;, &#39;Monday 17:00:00&#39;,</span>
</span><span id=__span-38-13><a id=__codelineno-38-13 name=__codelineno-38-13 href=#__codelineno-38-13></a><span class=go>       &#39;Monday 18:00:00&#39;, &#39;Monday 19:00:00&#39;, &#39;Monday 20:00:00&#39;,</span>
</span><span id=__span-38-14><a id=__codelineno-38-14 name=__codelineno-38-14 href=#__codelineno-38-14></a><span class=go>       ...</span>
</span><span id=__span-38-15><a id=__codelineno-38-15 name=__codelineno-38-15 href=#__codelineno-38-15></a><span class=go>       &#39;Tuesday 10:00:00&#39;, &#39;Tuesday 11:00:00&#39;, &#39;Tuesday 12:00:00&#39;,</span>
</span><span id=__span-38-16><a id=__codelineno-38-16 name=__codelineno-38-16 href=#__codelineno-38-16></a><span class=go>       &#39;Tuesday 13:00:00&#39;, &#39;Tuesday 14:00:00&#39;, &#39;Tuesday 15:00:00&#39;,</span>
</span><span id=__span-38-17><a id=__codelineno-38-17 name=__codelineno-38-17 href=#__codelineno-38-17></a><span class=go>       &#39;Tuesday 16:00:00&#39;],</span>
</span><span id=__span-38-18><a id=__codelineno-38-18 name=__codelineno-38-18 href=#__codelineno-38-18></a><span class=go>      dtype=&#39;object&#39;, name=&#39;Open time&#39;, length=116)</span>
</span></code></pre></div> <ol> <li>Add a day to reach Wednesday.</li> </ol> <p>Place a signal exactly at midnight on January 7th, 2021:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>min_symbol_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-39-2><a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>set</span><span class=p>(</span>
</span><span id=__span-39-3><a id=__codelineno-39-3 name=__codelineno-39-3 href=#__codelineno-39-3></a><span class=gp>... </span>    <span class=kc>True</span><span class=p>,</span> 
</span><span id=__span-39-4><a id=__codelineno-39-4 name=__codelineno-39-4 href=#__codelineno-39-4></a><span class=gp>... </span>    <span class=n>on</span><span class=o>=</span><span class=s2>&quot;January 7th 2021 UTC&quot;</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-39-5><a id=__codelineno-39-5 name=__codelineno-39-5 href=#__codelineno-39-5></a><span class=gp>... </span>    <span class=n>indexer_method</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-39-6><a id=__codelineno-39-6 name=__codelineno-39-6 href=#__codelineno-39-6></a><span class=gp>... </span>    <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-39-7><a id=__codelineno-39-7 name=__codelineno-39-7 href=#__codelineno-39-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-39-8><a id=__codelineno-39-8 name=__codelineno-39-8 href=#__codelineno-39-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=p>[</span><span class=n>mask</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)]</span><span class=o>.</span><span class=n>index</span>
</span><span id=__span-39-9><a id=__codelineno-39-9 name=__codelineno-39-9 href=#__codelineno-39-9></a><span class=go>DatetimeIndex([&#39;2021-01-07 00:00:00+00:00&#39;], ...)</span>
</span></code></pre></div> <ol> <li>Human-readable datetime strings are accepted.</li> <li>The default method is <code>bfill</code>, which selects the next timestamp if there is no exact match.</li> </ol> <p>Fill signals between 12:00 on January 1st/7th and 12:00 on January 2nd/8th, 2021:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-40-1><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>min_symbol_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-40-2><a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>set_between</span><span class=p>(</span>
</span><span id=__span-40-3><a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a><span class=gp>... </span>    <span class=kc>True</span><span class=p>,</span> 
</span><span id=__span-40-4><a id=__codelineno-40-4 name=__codelineno-40-4 href=#__codelineno-40-4></a><span class=gp>... </span>    <span class=n>start</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;2021-01-01 12:00:00&quot;</span><span class=p>,</span> <span class=s2>&quot;2021-01-07 12:00:00&quot;</span><span class=p>],</span>  <span class=c1># (1)!</span>
</span><span id=__span-40-5><a id=__codelineno-40-5 name=__codelineno-40-5 href=#__codelineno-40-5></a><span class=gp>... </span>    <span class=n>end</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;2021-01-02 12:00:00&quot;</span><span class=p>,</span> <span class=s2>&quot;2021-01-08 12:00:00&quot;</span><span class=p>],</span>
</span><span id=__span-40-6><a id=__codelineno-40-6 name=__codelineno-40-6 href=#__codelineno-40-6></a><span class=gp>... </span>    <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-40-7><a id=__codelineno-40-7 name=__codelineno-40-7 href=#__codelineno-40-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-40-8><a id=__codelineno-40-8 name=__codelineno-40-8 href=#__codelineno-40-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=p>[</span><span class=n>mask</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)]</span><span class=o>.</span><span class=n>index</span>
</span><span id=__span-40-9><a id=__codelineno-40-9 name=__codelineno-40-9 href=#__codelineno-40-9></a><span class=go>DatetimeIndex([&#39;2021-01-01 12:00:00+00:00&#39;, &#39;2021-01-01 13:00:00+00:00&#39;,</span>
</span><span id=__span-40-10><a id=__codelineno-40-10 name=__codelineno-40-10 href=#__codelineno-40-10></a><span class=go>               &#39;2021-01-01 14:00:00+00:00&#39;, &#39;2021-01-01 15:00:00+00:00&#39;,</span>
</span><span id=__span-40-11><a id=__codelineno-40-11 name=__codelineno-40-11 href=#__codelineno-40-11></a><span class=go>               &#39;2021-01-01 16:00:00+00:00&#39;, &#39;2021-01-01 17:00:00+00:00&#39;,</span>
</span><span id=__span-40-12><a id=__codelineno-40-12 name=__codelineno-40-12 href=#__codelineno-40-12></a><span class=go>               ...</span>
</span><span id=__span-40-13><a id=__codelineno-40-13 name=__codelineno-40-13 href=#__codelineno-40-13></a><span class=go>               &#39;2021-01-08 06:00:00+00:00&#39;, &#39;2021-01-08 07:00:00+00:00&#39;,</span>
</span><span id=__span-40-14><a id=__codelineno-40-14 name=__codelineno-40-14 href=#__codelineno-40-14></a><span class=go>               &#39;2021-01-08 08:00:00+00:00&#39;, &#39;2021-01-08 09:00:00+00:00&#39;,</span>
</span><span id=__span-40-15><a id=__codelineno-40-15 name=__codelineno-40-15 href=#__codelineno-40-15></a><span class=go>               &#39;2021-01-08 10:00:00+00:00&#39;, &#39;2021-01-08 11:00:00+00:00&#39;],</span>
</span><span id=__span-40-16><a id=__codelineno-40-16 name=__codelineno-40-16 href=#__codelineno-40-16></a><span class=go>              dtype=&#39;datetime64[ns, UTC]&#39;, name=&#39;Open time&#39;, freq=None)</span>
</span></code></pre></div> <ol> <li>The first range is built from the first element in <code>start</code> and <code>end</code>, and the second range is built from the second element. You can also use human-readable datetime strings, but those take extra time to map (to enable, see <a href=https://vectorbt.pro/pvt_41531c19/api/_settings/#vectorbtpro._settings.datetime>settings.datetime</a>).</li> </ol> <p>Fill signals in the first two hours of each week:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-41-1><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>min_symbol_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-41-2><a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>set_between</span><span class=p>(</span>
</span><span id=__span-41-3><a id=__codelineno-41-3 name=__codelineno-41-3 href=#__codelineno-41-3></a><span class=gp>... </span>    <span class=kc>True</span><span class=p>,</span> 
</span><span id=__span-41-4><a id=__codelineno-41-4 name=__codelineno-41-4 href=#__codelineno-41-4></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=s2>&quot;monday&quot;</span><span class=p>,</span>
</span><span id=__span-41-5><a id=__codelineno-41-5 name=__codelineno-41-5 href=#__codelineno-41-5></a><span class=gp>... </span>    <span class=n>split_every</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-41-6><a id=__codelineno-41-6 name=__codelineno-41-6 href=#__codelineno-41-6></a><span class=gp>... </span>    <span class=n>add_end_delta</span><span class=o>=</span><span class=s2>&quot;2h&quot;</span><span class=p>,</span>
</span><span id=__span-41-7><a id=__codelineno-41-7 name=__codelineno-41-7 href=#__codelineno-41-7></a><span class=gp>... </span>    <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-41-8><a id=__codelineno-41-8 name=__codelineno-41-8 href=#__codelineno-41-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-41-9><a id=__codelineno-41-9 name=__codelineno-41-9 href=#__codelineno-41-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=p>[</span><span class=n>mask</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)]</span><span class=o>.</span><span class=n>index</span>
</span><span id=__span-41-10><a id=__codelineno-41-10 name=__codelineno-41-10 href=#__codelineno-41-10></a><span class=go>DatetimeIndex([&#39;2021-01-04 00:00:00+00:00&#39;, &#39;2021-01-04 01:00:00+00:00&#39;,</span>
</span><span id=__span-41-11><a id=__codelineno-41-11 name=__codelineno-41-11 href=#__codelineno-41-11></a><span class=go>               &#39;2021-01-11 00:00:00+00:00&#39;, &#39;2021-01-11 01:00:00+00:00&#39;,</span>
</span><span id=__span-41-12><a id=__codelineno-41-12 name=__codelineno-41-12 href=#__codelineno-41-12></a><span class=go>               &#39;2021-01-18 00:00:00+00:00&#39;, &#39;2021-01-18 01:00:00+00:00&#39;,</span>
</span><span id=__span-41-13><a id=__codelineno-41-13 name=__codelineno-41-13 href=#__codelineno-41-13></a><span class=go>               &#39;2021-01-25 00:00:00+00:00&#39;, &#39;2021-01-25 01:00:00+00:00&#39;],</span>
</span><span id=__span-41-14><a id=__codelineno-41-14 name=__codelineno-41-14 href=#__codelineno-41-14></a><span class=go>              dtype=&#39;datetime64[ns, UTC]&#39;, name=&#39;Open time&#39;, freq=None)</span>
</span></code></pre></div> <ol> <li>Otherwise, ranges will be built from each pair of week starts.</li> </ol> <p>See the API documentation for more examples.</p> <h2 id=iteratively>Iteratively<a class=headerlink href=#iteratively title="Permanent link">&para;</a></h2> <p>With Numba, we can write iterative logic that is just as fast as vectorized counterparts. But which approach is better? There is no definitive answer. Overall, using vectors is often more effective and more user-friendly because it removes the need to loop over data and automates many mechanisms related to indexes and columns. Consider how powerful broadcasting is, and how many extra lines of code it would take to implement the same thing iteratively. Numba also does not allow us to work with labels or complex data types, only with numeric data, which means you need skills and creativity to design efficient algorithms.</p> <p>Most vectorized functions, as well as non-vectorized but compiled functions, are specifically tailored for one particular task and perform it reliably. When writing your own loop, however, you are responsible for fully implementing the required logic. Vectors are like Lego bricks that let you easily build even the most impressive creations, while custom loops require you to learn how to manufacture each Lego brick first <img alt=🧱 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f9f1.svg title=:bricks:></p> <p>Nevertheless, most of the functionality in VBT is powered by loops, not vectors—it should really be called loopbt <img alt=😬 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f62c.svg title=:grimacing:> The main reason is simple: most operations cannot be performed using vectors because they may introduce path dependencies, need complex data structures, require intermediate calculations or data buffers, call third-party functions periodically, or all of these at once. Efficiency is also a factor: you can design algorithms that loop over the data <a href=https://en.wikipedia.org/wiki/One-pass_algorithm>only once</a>, whereas the same logic with vectors may read the whole dataset a dozen times. This also applies to memory usage! Lastly, defining and running a strategy at each time step is exactly how you would do it in the real world (and in any other backtesting framework), and as traders, we should aim to mimic real-world behavior as closely as possible.</p> <p>Enough with theory! Let's implement the first example from <a href=#logical-operators>Logical operators</a> using a custom loop. Unless your signals rely on multiple assets or another column grouping, you should always start with just one column:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-42-1><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>  <span class=c1># (1)!</span>
</span><span id=__span-42-2><a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>generate_mask_1d_nb</span><span class=p>(</span>  <span class=c1># (2)!</span>
</span><span id=__span-42-3><a id=__codelineno-42-3 name=__codelineno-42-3 href=#__codelineno-42-3></a><span class=gp>... </span>    <span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span>  <span class=c1># (3)!</span>
</span><span id=__span-42-4><a id=__codelineno-42-4 name=__codelineno-42-4 href=#__codelineno-42-4></a><span class=gp>... </span>    <span class=n>uband</span><span class=p>,</span> <span class=n>mband</span><span class=p>,</span> <span class=n>lband</span><span class=p>,</span>  <span class=c1># (4)!</span>
</span><span id=__span-42-5><a id=__codelineno-42-5 name=__codelineno-42-5 href=#__codelineno-42-5></a><span class=gp>... </span>    <span class=n>cond2_th</span><span class=p>,</span> <span class=n>cond4_th</span>  <span class=c1># (5)!</span>
</span><span id=__span-42-6><a id=__codelineno-42-6 name=__codelineno-42-6 href=#__codelineno-42-6></a><span class=gp>... </span><span class=p>):</span>
</span><span id=__span-42-7><a id=__codelineno-42-7 name=__codelineno-42-7 href=#__codelineno-42-7></a><span class=gp>... </span>    <span class=n>out</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>high</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=kc>False</span><span class=p>)</span>  <span class=c1># (6)!</span>
</span><span id=__span-42-8><a id=__codelineno-42-8 name=__codelineno-42-8 href=#__codelineno-42-8></a><span class=gp>... </span>    
</span><span id=__span-42-9><a id=__codelineno-42-9 name=__codelineno-42-9 href=#__codelineno-42-9></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>high</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>  <span class=c1># (7)!</span>
</span><span id=__span-42-10><a id=__codelineno-42-10 name=__codelineno-42-10 href=#__codelineno-42-10></a><span class=gp>... </span>        <span class=c1># (8)!</span>
</span><span id=__span-42-11><a id=__codelineno-42-11 name=__codelineno-42-11 href=#__codelineno-42-11></a><span class=gp>... </span>        <span class=n>bandwidth</span> <span class=o>=</span> <span class=p>(</span><span class=n>uband</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>lband</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>/</span> <span class=n>mband</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-42-12><a id=__codelineno-42-12 name=__codelineno-42-12 href=#__codelineno-42-12></a><span class=gp>... </span>        <span class=n>cond1</span> <span class=o>=</span> <span class=n>low</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>lband</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-42-13><a id=__codelineno-42-13 name=__codelineno-42-13 href=#__codelineno-42-13></a><span class=gp>... </span>        <span class=n>cond2</span> <span class=o>=</span> <span class=n>bandwidth</span> <span class=o>&gt;</span> <span class=n>cond2_th</span>
</span><span id=__span-42-14><a id=__codelineno-42-14 name=__codelineno-42-14 href=#__codelineno-42-14></a><span class=gp>... </span>        <span class=n>cond3</span> <span class=o>=</span> <span class=n>high</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>uband</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-42-15><a id=__codelineno-42-15 name=__codelineno-42-15 href=#__codelineno-42-15></a><span class=gp>... </span>        <span class=n>cond4</span> <span class=o>=</span> <span class=n>bandwidth</span> <span class=o>&lt;</span> <span class=n>cond4_th</span>
</span><span id=__span-42-16><a id=__codelineno-42-16 name=__codelineno-42-16 href=#__codelineno-42-16></a><span class=gp>... </span>        <span class=n>signal</span> <span class=o>=</span> <span class=p>(</span><span class=n>cond1</span> <span class=ow>and</span> <span class=n>cond2</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=n>cond3</span> <span class=ow>and</span> <span class=n>cond4</span><span class=p>)</span>  <span class=c1># (9)!</span>
</span><span id=__span-42-17><a id=__codelineno-42-17 name=__codelineno-42-17 href=#__codelineno-42-17></a><span class=gp>... </span>        <span class=n>out</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>signal</span>  <span class=c1># (10)!</span>
</span><span id=__span-42-18><a id=__codelineno-42-18 name=__codelineno-42-18 href=#__codelineno-42-18></a><span class=gp>... </span>        
</span><span id=__span-42-19><a id=__codelineno-42-19 name=__codelineno-42-19 href=#__codelineno-42-19></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>out</span>
</span><span id=__span-42-20><a id=__codelineno-42-20 name=__codelineno-42-20 href=#__codelineno-42-20></a>
</span><span id=__span-42-21><a id=__codelineno-42-21 name=__codelineno-42-21 href=#__codelineno-42-21></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>generate_mask_1d_nb</span><span class=p>(</span>
</span><span id=__span-42-22><a id=__codelineno-42-22 name=__codelineno-42-22 href=#__codelineno-42-22></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;High&quot;</span><span class=p>)[</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>  <span class=c1># (11)!</span>
</span><span id=__span-42-23><a id=__codelineno-42-23 name=__codelineno-42-23 href=#__codelineno-42-23></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>)[</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-42-24><a id=__codelineno-42-24 name=__codelineno-42-24 href=#__codelineno-42-24></a><span class=gp>... </span>    <span class=n>bb</span><span class=o>.</span><span class=n>upperband</span><span class=p>[</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-42-25><a id=__codelineno-42-25 name=__codelineno-42-25 href=#__codelineno-42-25></a><span class=gp>... </span>    <span class=n>bb</span><span class=o>.</span><span class=n>middleband</span><span class=p>[</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-42-26><a id=__codelineno-42-26 name=__codelineno-42-26 href=#__codelineno-42-26></a><span class=gp>... </span>    <span class=n>bb</span><span class=o>.</span><span class=n>lowerband</span><span class=p>[</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-42-27><a id=__codelineno-42-27 name=__codelineno-42-27 href=#__codelineno-42-27></a><span class=gp>... </span>    <span class=mf>0.30</span><span class=p>,</span>
</span><span id=__span-42-28><a id=__codelineno-42-28 name=__codelineno-42-28 href=#__codelineno-42-28></a><span class=gp>... </span>    <span class=mf>0.15</span>
</span><span id=__span-42-29><a id=__codelineno-42-29 name=__codelineno-42-29 href=#__codelineno-42-29></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-42-30><a id=__codelineno-42-30 name=__codelineno-42-30 href=#__codelineno-42-30></a><span class=gp>&gt;&gt;&gt; </span><span class=n>symbol_wrapper</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get_symbol_wrapper</span><span class=p>()</span>
</span><span id=__span-42-31><a id=__codelineno-42-31 name=__codelineno-42-31 href=#__codelineno-42-31></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>symbol_wrapper</span><span class=p>[</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>wrap</span><span class=p>(</span><span class=n>mask</span><span class=p>)</span>  <span class=c1># (12)!</span>
</span><span id=__span-42-32><a id=__codelineno-42-32 name=__codelineno-42-32 href=#__codelineno-42-32></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-42-33><a id=__codelineno-42-33 name=__codelineno-42-33 href=#__codelineno-42-33></a><span class=go>25</span>
</span></code></pre></div> <ol> <li>Remember to use <code>@njit</code> to Numba-compile the function.</li> <li>A good convention is to use the <code>nb</code> suffix for Numba-compiled functions, and <code>1d_nb</code> for those that work on just one column of data.</li> <li>These are the data arrays required for our logic.</li> <li>These are the Bollinger Bands arrays needed by our logic.</li> <li>Thresholds. These can also be set as keyword arguments with default values.</li> <li>Create a boolean array matching the shape of your data arrays, filling it with the default value <code>False</code> (meaning no signal).</li> <li>Iterate over the rows, each representing a timestamp.</li> <li>This is where the main logic goes. Perform all operations one element at a time instead of on arrays, which is great for memory efficiency.</li> <li>When working with single values, use <code>and</code> instead of <code>&amp;</code>, <code>or</code> instead of <code>|</code>, and <code>not</code> instead of <code>~</code>.</li> <li>Write the current signal to the array.</li> <li>Because we are using a one-dimensional Numba-compiled function, we must pass one-dimensional NumPy arrays.</li> <li>Since the mask is generated only for the <code>BTCUSDT</code> symbol, select that column from the wrapper and wrap the array.</li> </ol> <p>We now have the same number of signals as before—magic!</p> <p>To make the function work on multiple columns, you can write another Numba-compiled function that loops over the columns and calls <code>generate_mask_1d_nb</code> for each one:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-43-1><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-43-2><a id=__codelineno-43-2 name=__codelineno-43-2 href=#__codelineno-43-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>generate_mask_nb</span><span class=p>(</span>  <span class=c1># (1)!</span>
</span><span id=__span-43-3><a id=__codelineno-43-3 name=__codelineno-43-3 href=#__codelineno-43-3></a><span class=gp>... </span>    <span class=n>high</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span>
</span><span id=__span-43-4><a id=__codelineno-43-4 name=__codelineno-43-4 href=#__codelineno-43-4></a><span class=gp>... </span>    <span class=n>uband</span><span class=p>,</span> <span class=n>mband</span><span class=p>,</span> <span class=n>lband</span><span class=p>,</span>
</span><span id=__span-43-5><a id=__codelineno-43-5 name=__codelineno-43-5 href=#__codelineno-43-5></a><span class=gp>... </span>    <span class=n>cond2_th</span><span class=p>,</span> <span class=n>cond4_th</span>
</span><span id=__span-43-6><a id=__codelineno-43-6 name=__codelineno-43-6 href=#__codelineno-43-6></a><span class=gp>... </span><span class=p>):</span>
</span><span id=__span-43-7><a id=__codelineno-43-7 name=__codelineno-43-7 href=#__codelineno-43-7></a><span class=gp>... </span>    <span class=n>out</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>high</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>bool_</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-43-8><a id=__codelineno-43-8 name=__codelineno-43-8 href=#__codelineno-43-8></a><span class=gp>... </span>    
</span><span id=__span-43-9><a id=__codelineno-43-9 name=__codelineno-43-9 href=#__codelineno-43-9></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>high</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]):</span>  <span class=c1># (3)!</span>
</span><span id=__span-43-10><a id=__codelineno-43-10 name=__codelineno-43-10 href=#__codelineno-43-10></a><span class=gp>... </span>        <span class=n>out</span><span class=p>[:,</span> <span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>generate_mask_1d_nb</span><span class=p>(</span>  <span class=c1># (4)!</span>
</span><span id=__span-43-11><a id=__codelineno-43-11 name=__codelineno-43-11 href=#__codelineno-43-11></a><span class=gp>... </span>            <span class=n>high</span><span class=p>[:,</span> <span class=n>col</span><span class=p>],</span> <span class=n>low</span><span class=p>[:,</span> <span class=n>col</span><span class=p>],</span>
</span><span id=__span-43-12><a id=__codelineno-43-12 name=__codelineno-43-12 href=#__codelineno-43-12></a><span class=gp>... </span>            <span class=n>uband</span><span class=p>[:,</span> <span class=n>col</span><span class=p>],</span> <span class=n>mband</span><span class=p>[:,</span> <span class=n>col</span><span class=p>],</span> <span class=n>lband</span><span class=p>[:,</span> <span class=n>col</span><span class=p>],</span>
</span><span id=__span-43-13><a id=__codelineno-43-13 name=__codelineno-43-13 href=#__codelineno-43-13></a><span class=gp>... </span>            <span class=n>cond2_th</span><span class=p>,</span> <span class=n>cond4_th</span>
</span><span id=__span-43-14><a id=__codelineno-43-14 name=__codelineno-43-14 href=#__codelineno-43-14></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-43-15><a id=__codelineno-43-15 name=__codelineno-43-15 href=#__codelineno-43-15></a><span class=gp>... </span>        
</span><span id=__span-43-16><a id=__codelineno-43-16 name=__codelineno-43-16 href=#__codelineno-43-16></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>out</span>
</span><span id=__span-43-17><a id=__codelineno-43-17 name=__codelineno-43-17 href=#__codelineno-43-17></a>
</span><span id=__span-43-18><a id=__codelineno-43-18 name=__codelineno-43-18 href=#__codelineno-43-18></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>generate_mask_nb</span><span class=p>(</span>
</span><span id=__span-43-19><a id=__codelineno-43-19 name=__codelineno-43-19 href=#__codelineno-43-19></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;High&quot;</span><span class=p>)),</span>  <span class=c1># (5)!</span>
</span><span id=__span-43-20><a id=__codelineno-43-20 name=__codelineno-43-20 href=#__codelineno-43-20></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>)),</span>
</span><span id=__span-43-21><a id=__codelineno-43-21 name=__codelineno-43-21 href=#__codelineno-43-21></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array</span><span class=p>(</span><span class=n>bb</span><span class=o>.</span><span class=n>upperband</span><span class=p>),</span>
</span><span id=__span-43-22><a id=__codelineno-43-22 name=__codelineno-43-22 href=#__codelineno-43-22></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array</span><span class=p>(</span><span class=n>bb</span><span class=o>.</span><span class=n>middleband</span><span class=p>),</span>
</span><span id=__span-43-23><a id=__codelineno-43-23 name=__codelineno-43-23 href=#__codelineno-43-23></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array</span><span class=p>(</span><span class=n>bb</span><span class=o>.</span><span class=n>lowerband</span><span class=p>),</span>
</span><span id=__span-43-24><a id=__codelineno-43-24 name=__codelineno-43-24 href=#__codelineno-43-24></a><span class=gp>... </span>    <span class=mf>0.30</span><span class=p>,</span>
</span><span id=__span-43-25><a id=__codelineno-43-25 name=__codelineno-43-25 href=#__codelineno-43-25></a><span class=gp>... </span>    <span class=mf>0.15</span>
</span><span id=__span-43-26><a id=__codelineno-43-26 name=__codelineno-43-26 href=#__codelineno-43-26></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-43-27><a id=__codelineno-43-27 name=__codelineno-43-27 href=#__codelineno-43-27></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>wrap</span><span class=p>(</span><span class=n>mask</span><span class=p>)</span>
</span><span id=__span-43-28><a id=__codelineno-43-28 name=__codelineno-43-28 href=#__codelineno-43-28></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-43-29><a id=__codelineno-43-29 name=__codelineno-43-29 href=#__codelineno-43-29></a><span class=go>symbol</span>
</span><span id=__span-43-30><a id=__codelineno-43-30 name=__codelineno-43-30 href=#__codelineno-43-30></a><span class=go>BTCUSDT    25</span>
</span><span id=__span-43-31><a id=__codelineno-43-31 name=__codelineno-43-31 href=#__codelineno-43-31></a><span class=go>ETHUSDT    13</span>
</span><span id=__span-43-32><a id=__codelineno-43-32 name=__codelineno-43-32 href=#__codelineno-43-32></a><span class=go>dtype: int64</span>
</span></code></pre></div> <ol> <li>Remove <code>1d</code> from the name if the function takes two-dimensional arrays.</li> <li>Create an empty boolean array to hold the results from <code>generate_mask_1d_nb</code>. If you use <code>np.empty</code> instead of <code>np.full</code>, be sure to override every value. Otherwise, unevaluated elements will remain uninitialized and be essentially garbage.</li> <li>Iterate over the columns, which represent assets.</li> <li>Select the current column from each array, and call the one-dimensional function.</li> <li>Use <a href=https://vectorbt.pro/pvt_41531c19/api/base/reshaping/#vectorbtpro.base.reshaping.to_2d_array>to_2d_array</a> to cast any array to two dimensions and convert it to NumPy.</li> </ol> <p>A more "vectorbtonic" approach is to create a stand-alone indicator where you specify the function, the required data, and what it returns. The indicator factory then takes care of everything else!</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-44-1><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>MaskGenerator</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>IF</span><span class=p>(</span>  <span class=c1># (1)!</span>
</span><span id=__span-44-2><a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a><span class=gp>... </span>    <span class=n>input_names</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;high&quot;</span><span class=p>,</span> <span class=s2>&quot;low&quot;</span><span class=p>,</span> <span class=s2>&quot;uband&quot;</span><span class=p>,</span> <span class=s2>&quot;mband&quot;</span><span class=p>,</span> <span class=s2>&quot;lband&quot;</span><span class=p>],</span>
</span><span id=__span-44-3><a id=__codelineno-44-3 name=__codelineno-44-3 href=#__codelineno-44-3></a><span class=gp>... </span>    <span class=n>param_names</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;cond2_th&quot;</span><span class=p>,</span> <span class=s2>&quot;cond4_th&quot;</span><span class=p>],</span>
</span><span id=__span-44-4><a id=__codelineno-44-4 name=__codelineno-44-4 href=#__codelineno-44-4></a><span class=gp>... </span>    <span class=n>output_names</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;mask&quot;</span><span class=p>]</span>
</span><span id=__span-44-5><a id=__codelineno-44-5 name=__codelineno-44-5 href=#__codelineno-44-5></a><span class=gp>... </span><span class=p>)</span><span class=o>.</span><span class=n>with_apply_func</span><span class=p>(</span><span class=n>generate_mask_1d_nb</span><span class=p>,</span> <span class=n>takes_1d</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-44-6><a id=__codelineno-44-6 name=__codelineno-44-6 href=#__codelineno-44-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask_generator</span> <span class=o>=</span> <span class=n>MaskGenerator</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>  <span class=c1># (3)!</span>
</span><span id=__span-44-7><a id=__codelineno-44-7 name=__codelineno-44-7 href=#__codelineno-44-7></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;High&quot;</span><span class=p>),</span>
</span><span id=__span-44-8><a id=__codelineno-44-8 name=__codelineno-44-8 href=#__codelineno-44-8></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>),</span>
</span><span id=__span-44-9><a id=__codelineno-44-9 name=__codelineno-44-9 href=#__codelineno-44-9></a><span class=gp>... </span>    <span class=n>bb</span><span class=o>.</span><span class=n>upperband</span><span class=p>,</span>
</span><span id=__span-44-10><a id=__codelineno-44-10 name=__codelineno-44-10 href=#__codelineno-44-10></a><span class=gp>... </span>    <span class=n>bb</span><span class=o>.</span><span class=n>middleband</span><span class=p>,</span>
</span><span id=__span-44-11><a id=__codelineno-44-11 name=__codelineno-44-11 href=#__codelineno-44-11></a><span class=gp>... </span>    <span class=n>bb</span><span class=o>.</span><span class=n>lowerband</span><span class=p>,</span>
</span><span id=__span-44-12><a id=__codelineno-44-12 name=__codelineno-44-12 href=#__codelineno-44-12></a><span class=gp>... </span>    <span class=p>[</span><span class=mf>0.3</span><span class=p>,</span> <span class=mf>0.4</span><span class=p>],</span>
</span><span id=__span-44-13><a id=__codelineno-44-13 name=__codelineno-44-13 href=#__codelineno-44-13></a><span class=gp>... </span>    <span class=p>[</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>],</span>
</span><span id=__span-44-14><a id=__codelineno-44-14 name=__codelineno-44-14 href=#__codelineno-44-14></a><span class=gp>... </span>    <span class=n>param_product</span><span class=o>=</span><span class=kc>True</span>  <span class=c1># (4)!</span>
</span><span id=__span-44-15><a id=__codelineno-44-15 name=__codelineno-44-15 href=#__codelineno-44-15></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-44-16><a id=__codelineno-44-16 name=__codelineno-44-16 href=#__codelineno-44-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask_generator</span><span class=o>.</span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-44-17><a id=__codelineno-44-17 name=__codelineno-44-17 href=#__codelineno-44-17></a><span class=go>custom_cond2_th  custom_cond4_th  symbol </span>
</span><span id=__span-44-18><a id=__codelineno-44-18 name=__codelineno-44-18 href=#__codelineno-44-18></a><span class=go>0.3              0.1              BTCUSDT    11</span>
</span><span id=__span-44-19><a id=__codelineno-44-19 name=__codelineno-44-19 href=#__codelineno-44-19></a><span class=go>                                  ETHUSDT    10</span>
</span><span id=__span-44-20><a id=__codelineno-44-20 name=__codelineno-44-20 href=#__codelineno-44-20></a><span class=go>                 0.2              BTCUSDT    28</span>
</span><span id=__span-44-21><a id=__codelineno-44-21 name=__codelineno-44-21 href=#__codelineno-44-21></a><span class=go>                                  ETHUSDT    27</span>
</span><span id=__span-44-22><a id=__codelineno-44-22 name=__codelineno-44-22 href=#__codelineno-44-22></a><span class=go>0.4              0.1              BTCUSDT     9</span>
</span><span id=__span-44-23><a id=__codelineno-44-23 name=__codelineno-44-23 href=#__codelineno-44-23></a><span class=go>                                  ETHUSDT     5</span>
</span><span id=__span-44-24><a id=__codelineno-44-24 name=__codelineno-44-24 href=#__codelineno-44-24></a><span class=go>                 0.2              BTCUSDT    26</span>
</span><span id=__span-44-25><a id=__codelineno-44-25 name=__codelineno-44-25 href=#__codelineno-44-25></a><span class=go>                                  ETHUSDT    22</span>
</span><span id=__span-44-26><a id=__codelineno-44-26 name=__codelineno-44-26 href=#__codelineno-44-26></a><span class=go>dtype: int64</span>
</span></code></pre></div> <ol> <li>Create the indicator's interface and specify the apply function.</li> <li>You could also use <code>generate_mask_nb</code> with <code>takes_1d=False</code>.</li> <li>Run the indicator. Notice you do not need to worry about the correct type and shape of each array!</li> <li>Test the Cartesian product of different threshold combinations.</li> </ol> <p>How about shifting and testing truth values? Simple use cases like fixed shifts and windows are easy to implement. Below, we compare the current value to the value a certain number of steps earlier:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-45-1><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-45-2><a id=__codelineno-45-2 name=__codelineno-45-2 href=#__codelineno-45-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>value_ago_1d_nb</span><span class=p>(</span><span class=n>arr</span><span class=p>,</span> <span class=n>ago</span><span class=p>):</span>
</span><span id=__span-45-3><a id=__codelineno-45-3 name=__codelineno-45-3 href=#__codelineno-45-3></a><span class=gp>... </span>    <span class=n>out</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>arr</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>float_</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-45-4><a id=__codelineno-45-4 name=__codelineno-45-4 href=#__codelineno-45-4></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>out</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
</span><span id=__span-45-5><a id=__codelineno-45-5 name=__codelineno-45-5 href=#__codelineno-45-5></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>i</span> <span class=o>-</span> <span class=n>ago</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>:</span>  <span class=c1># (2)!</span>
</span><span id=__span-45-6><a id=__codelineno-45-6 name=__codelineno-45-6 href=#__codelineno-45-6></a><span class=gp>... </span>            <span class=n>out</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>arr</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=n>ago</span><span class=p>]</span>
</span><span id=__span-45-7><a id=__codelineno-45-7 name=__codelineno-45-7 href=#__codelineno-45-7></a><span class=gp>... </span>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-45-8><a id=__codelineno-45-8 name=__codelineno-45-8 href=#__codelineno-45-8></a><span class=gp>... </span>            <span class=n>out</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span>  <span class=c1># (3)!</span>
</span><span id=__span-45-9><a id=__codelineno-45-9 name=__codelineno-45-9 href=#__codelineno-45-9></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>out</span>
</span><span id=__span-45-10><a id=__codelineno-45-10 name=__codelineno-45-10 href=#__codelineno-45-10></a>
</span><span id=__span-45-11><a id=__codelineno-45-11 name=__codelineno-45-11 href=#__codelineno-45-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>arr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>])</span>
</span><span id=__span-45-12><a id=__codelineno-45-12 name=__codelineno-45-12 href=#__codelineno-45-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>value_ago_1d_nb</span><span class=p>(</span><span class=n>arr</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span><span id=__span-45-13><a id=__codelineno-45-13 name=__codelineno-45-13 href=#__codelineno-45-13></a><span class=go>array([nan, 1., 2.])</span>
</span></code></pre></div> <ol> <li>Use <code>np.empty</code> only if you guarantee that each array element will be set. Also, when your data involves NaN values, set the dtype to float!</li> <li>Before accessing a previous element, make sure it is within the bounds of the array.</li> <li>If the previous element is outside the array, set its value to NaN.</li> </ol> <div class="admonition important"> <p class=admonition-title>Important</p> <p>Always check that the element you access is within array bounds. Unless you have enabled <code>NUMBA_BOUNDSCHECK</code>, Numba will not raise an error if you try to access a non-existent element. Instead, it will silently continue the calculation, and your kernel may eventually crash. If this happens, restart your kernel, disable Numba, or enable bounds checking to locate the bug and rerun your function.</p> </div> <p>Here is how you can test if any condition was true within a fixed window (a variable time interval):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-46-1><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-46-2><a id=__codelineno-46-2 name=__codelineno-46-2 href=#__codelineno-46-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>any_in_window_1d_nb</span><span class=p>(</span><span class=n>arr</span><span class=p>,</span> <span class=n>window</span><span class=p>):</span>
</span><span id=__span-46-3><a id=__codelineno-46-3 name=__codelineno-46-3 href=#__codelineno-46-3></a><span class=gp>... </span>    <span class=n>out</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>arr</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>bool_</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-46-4><a id=__codelineno-46-4 name=__codelineno-46-4 href=#__codelineno-46-4></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>out</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
</span><span id=__span-46-5><a id=__codelineno-46-5 name=__codelineno-46-5 href=#__codelineno-46-5></a><span class=gp>... </span>        <span class=n>from_i</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>window</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-46-6><a id=__codelineno-46-6 name=__codelineno-46-6 href=#__codelineno-46-6></a><span class=gp>... </span>        <span class=n>to_i</span> <span class=o>=</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span>  <span class=c1># (3)!</span>
</span><span id=__span-46-7><a id=__codelineno-46-7 name=__codelineno-46-7 href=#__codelineno-46-7></a><span class=gp>... </span>        <span class=n>out</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>arr</span><span class=p>[</span><span class=n>from_i</span><span class=p>:</span><span class=n>to_i</span><span class=p>])</span>  <span class=c1># (4)!</span>
</span><span id=__span-46-8><a id=__codelineno-46-8 name=__codelineno-46-8 href=#__codelineno-46-8></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>out</span>
</span><span id=__span-46-9><a id=__codelineno-46-9 name=__codelineno-46-9 href=#__codelineno-46-9></a>
</span><span id=__span-46-10><a id=__codelineno-46-10 name=__codelineno-46-10 href=#__codelineno-46-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>arr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>])</span>
</span><span id=__span-46-11><a id=__codelineno-46-11 name=__codelineno-46-11 href=#__codelineno-46-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>any_in_window_1d_nb</span><span class=p>(</span><span class=n>arr</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span><span id=__span-46-12><a id=__codelineno-46-12 name=__codelineno-46-12 href=#__codelineno-46-12></a><span class=go>array([False, True, True, True, False])</span>
</span></code></pre></div> <ol> <li>You can use a boolean empty array if no NaN values are present.</li> <li>Get the left bound of the window.</li> <li>Get the right bound of the window.</li> <li>Use these bounds to select all elements in the window and check if any of them is <code>True</code>.</li> </ol> <p>Once dates and times are involved, such as when you want to compare the current value to the value exactly 5 days earlier, it is better to pre-calculate as many intermediate steps as possible. However, you can also work directly with a datetime-like index in Numba. Here is how you can test if any condition was true inside a variable window (a fixed time interval):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-47-1><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-47-2><a id=__codelineno-47-2 name=__codelineno-47-2 href=#__codelineno-47-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>any_in_var_window_1d_nb</span><span class=p>(</span><span class=n>arr</span><span class=p>,</span> <span class=n>index</span><span class=p>,</span> <span class=n>freq</span><span class=p>):</span>  <span class=c1># (1)!</span>
</span><span id=__span-47-3><a id=__codelineno-47-3 name=__codelineno-47-3 href=#__codelineno-47-3></a><span class=gp>... </span>    <span class=n>out</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>arr</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>bool_</span><span class=p>)</span>
</span><span id=__span-47-4><a id=__codelineno-47-4 name=__codelineno-47-4 href=#__codelineno-47-4></a><span class=gp>... </span>    <span class=n>from_i</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-47-5><a id=__codelineno-47-5 name=__codelineno-47-5 href=#__codelineno-47-5></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>out</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
</span><span id=__span-47-6><a id=__codelineno-47-6 name=__codelineno-47-6 href=#__codelineno-47-6></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>index</span><span class=p>[</span><span class=n>from_i</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>index</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>freq</span><span class=p>:</span>  <span class=c1># (2)!</span>
</span><span id=__span-47-7><a id=__codelineno-47-7 name=__codelineno-47-7 href=#__codelineno-47-7></a><span class=gp>... </span>            <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>from_i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>index</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>  <span class=c1># (3)!</span>
</span><span id=__span-47-8><a id=__codelineno-47-8 name=__codelineno-47-8 href=#__codelineno-47-8></a><span class=gp>... </span>                <span class=k>if</span> <span class=n>index</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>index</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>freq</span><span class=p>:</span>
</span><span id=__span-47-9><a id=__codelineno-47-9 name=__codelineno-47-9 href=#__codelineno-47-9></a><span class=gp>... </span>                    <span class=n>from_i</span> <span class=o>=</span> <span class=n>j</span>
</span><span id=__span-47-10><a id=__codelineno-47-10 name=__codelineno-47-10 href=#__codelineno-47-10></a><span class=gp>... </span>                    <span class=k>break</span>  <span class=c1># (4)!</span>
</span><span id=__span-47-11><a id=__codelineno-47-11 name=__codelineno-47-11 href=#__codelineno-47-11></a><span class=gp>... </span>        <span class=n>to_i</span> <span class=o>=</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span>
</span><span id=__span-47-12><a id=__codelineno-47-12 name=__codelineno-47-12 href=#__codelineno-47-12></a><span class=gp>... </span>        <span class=n>out</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>arr</span><span class=p>[</span><span class=n>from_i</span><span class=p>:</span><span class=n>to_i</span><span class=p>])</span>
</span><span id=__span-47-13><a id=__codelineno-47-13 name=__codelineno-47-13 href=#__codelineno-47-13></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>out</span>
</span><span id=__span-47-14><a id=__codelineno-47-14 name=__codelineno-47-14 href=#__codelineno-47-14></a>
</span><span id=__span-47-15><a id=__codelineno-47-15 name=__codelineno-47-15 href=#__codelineno-47-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>arr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>])</span>
</span><span id=__span-47-16><a id=__codelineno-47-16 name=__codelineno-47-16 href=#__codelineno-47-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>index</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>date_range</span><span class=p>(</span><span class=s2>&quot;2020&quot;</span><span class=p>,</span> <span class=n>freq</span><span class=o>=</span><span class=s2>&quot;5min&quot;</span><span class=p>,</span> <span class=n>periods</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>arr</span><span class=p>))</span><span class=o>.</span><span class=n>values</span>  <span class=c1># (5)!</span>
</span><span id=__span-47-17><a id=__codelineno-47-17 name=__codelineno-47-17 href=#__codelineno-47-17></a><span class=gp>&gt;&gt;&gt; </span><span class=n>freq</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s2>&quot;10min&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>to_timedelta64</span><span class=p>()</span>  <span class=c1># (6)!</span>
</span><span id=__span-47-18><a id=__codelineno-47-18 name=__codelineno-47-18 href=#__codelineno-47-18></a><span class=gp>&gt;&gt;&gt; </span><span class=n>any_in_var_window_1d_nb</span><span class=p>(</span><span class=n>arr</span><span class=p>,</span> <span class=n>index</span><span class=p>,</span> <span class=n>freq</span><span class=p>)</span>
</span><span id=__span-47-19><a id=__codelineno-47-19 name=__codelineno-47-19 href=#__codelineno-47-19></a><span class=go>array([False, True, True, True, False])</span>
</span></code></pre></div> <ol> <li>Use an array of type <code>np.datetime64</code> as the index and a constant of type <code>np.timedelta64</code> as the frequency.</li> <li>Test if the previous left bound is still valid, meaning it falls within the current time interval.</li> <li>If not, find the new left bound with a separate loop over the index.</li> <li>Once found, set <code>from_i</code> to the new left bound and exit the second loop.</li> <li>Create an index with a 5-minute timeframe and convert it to a NumPy datetime array.</li> <li>Define a frequency of 10 minutes and convert it to a NumPy timedelta value.</li> </ol> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>In general, it is easier to design iterative functions using regular Python and only compile them with Numba after sufficient testing, since debugging is simpler in Python than in Numba.</p> </div> <p>Keep in mind that Numba (and VBT) supports many more features for processing numeric data than for datetime or timedelta data. Fortunately, you can safely convert datetime and timedelta data to integers outside of Numba, and most functions will keep working as before:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-48-1><a id=__codelineno-48-1 name=__codelineno-48-1 href=#__codelineno-48-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>any_in_var_window_1d_nb</span><span class=p>(</span><span class=n>arr</span><span class=p>,</span> <span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>index</span><span class=p>),</span> <span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>freq</span><span class=p>))</span>
</span><span id=__span-48-2><a id=__codelineno-48-2 name=__codelineno-48-2 href=#__codelineno-48-2></a><span class=go>array([False, True, True, True, False])</span>
</span></code></pre></div> <p>Why does this work? By converting datetime or timedelta to an integer, we get the total number of nanoseconds that represent the object. For a datetime, this value is the number of nanoseconds since the <a href=https://en.wikipedia.org/wiki/Unix_time>Unix Epoch</a>, which is 00:00:00 UTC on January 1, 1970:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-49-1><a id=__codelineno-49-1 name=__codelineno-49-1 href=#__codelineno-49-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>index</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-49-2><a id=__codelineno-49-2 name=__codelineno-49-2 href=#__codelineno-49-2></a><span class=go>array([1577836800000000000, 1577837100000000000, 1577837400000000000,</span>
</span><span id=__span-49-3><a id=__codelineno-49-3 name=__codelineno-49-3 href=#__codelineno-49-3></a><span class=go>       1577837700000000000, 1577838000000000000])</span>
</span><span id=__span-49-4><a id=__codelineno-49-4 name=__codelineno-49-4 href=#__codelineno-49-4></a>
</span><span id=__span-49-5><a id=__codelineno-49-5 name=__codelineno-49-5 href=#__codelineno-49-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>index</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>datetime64</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=s2>&quot;ns&quot;</span><span class=p>))</span> <span class=c1># (2)!</span>
</span><span id=__span-49-6><a id=__codelineno-49-6 name=__codelineno-49-6 href=#__codelineno-49-6></a><span class=go>array([1577836800000000000, 1577837100000000000, 1577837400000000000,</span>
</span><span id=__span-49-7><a id=__codelineno-49-7 name=__codelineno-49-7 href=#__codelineno-49-7></a><span class=go>       1577837700000000000, 1577838000000000000])</span>
</span><span id=__span-49-8><a id=__codelineno-49-8 name=__codelineno-49-8 href=#__codelineno-49-8></a>
</span><span id=__span-49-9><a id=__codelineno-49-9 name=__codelineno-49-9 href=#__codelineno-49-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>freq</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-49-10><a id=__codelineno-49-10 name=__codelineno-49-10 href=#__codelineno-49-10></a><span class=go>600000000000</span>
</span><span id=__span-49-11><a id=__codelineno-49-11 name=__codelineno-49-11 href=#__codelineno-49-11></a>
</span><span id=__span-49-12><a id=__codelineno-49-12 name=__codelineno-49-12 href=#__codelineno-49-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>freq</span><span class=p>)</span> <span class=o>/</span> <span class=mi>1000</span> <span class=o>/</span> <span class=mi>1000</span> <span class=o>/</span> <span class=mi>1000</span> <span class=o>/</span> <span class=mi>60</span>  <span class=c1># (4)!</span>
</span><span id=__span-49-13><a id=__codelineno-49-13 name=__codelineno-49-13 href=#__codelineno-49-13></a><span class=go>10.0</span>
</span></code></pre></div> <ol> <li>The index as a timedelta in nanoseconds after 1970.</li> <li>This is the same as converting a datetime to a timedelta by subtracting the Unix Epoch.</li> <li>Frequency as a timedelta in nanoseconds.</li> <li>Convert nanoseconds into minutes.</li> </ol> <h2 id=generators>Generators<a class=headerlink href=#generators title="Permanent link">&para;</a></h2> <p>Writing custom loops is powerful and enjoyable, but VBT also provides functions that can make things easier—especially for generating signals. The most flexible helper function is the Numba-compiled <a href=https://vectorbt.pro/pvt_41531c19/api/signals/nb/#vectorbtpro.signals.nb.generate_nb>generate_nb</a> and its accessor class method <a href=https://vectorbt.pro/pvt_41531c19/api/signals/accessors/#vectorbtpro.signals.accessors.SignalsAccessor.generate>SignalsAccessor.generate</a>. These take a target shape, initialize a boolean output array filled with <code>False</code> values, then iterate over columns. For each column, they call a "placement function", which is a regular UDF that modifies the mask in place. After making changes, the placement function should return either the position of the last placed signal or <code>-1</code> if there is no signal.</p> <p>All context information for the current iteration is passed via a context of type <a href=https://vectorbt.pro/pvt_41531c19/api/signals/enums/#vectorbtpro.signals.enums.GenEnContext>GenEnContext</a>. This context provides the current output mask segment to modify, the inclusive range start, exclusive range end, the column, and the full output mask. This lets you make patches wherever needed. With this approach, VBT manages the array setup and column loops, and helps you select the correct subset of output data to modify.</p> <p>Let's place a signal at 17:00 (UTC) every Tuesday:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-50-1><a id=__codelineno-50-1 name=__codelineno-50-1 href=#__codelineno-50-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-50-2><a id=__codelineno-50-2 name=__codelineno-50-2 href=#__codelineno-50-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>place_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>index</span><span class=p>):</span>  <span class=c1># (1)!</span>
</span><span id=__span-50-3><a id=__codelineno-50-3 name=__codelineno-50-3 href=#__codelineno-50-3></a><span class=gp>... </span>    <span class=n>last_i</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>  <span class=c1># (2)!</span>
</span><span id=__span-50-4><a id=__codelineno-50-4 name=__codelineno-50-4 href=#__codelineno-50-4></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>out_i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>out</span><span class=p>)):</span>  <span class=c1># (3)!</span>
</span><span id=__span-50-5><a id=__codelineno-50-5 name=__codelineno-50-5 href=#__codelineno-50-5></a><span class=gp>... </span>        <span class=n>i</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>from_i</span> <span class=o>+</span> <span class=n>out_i</span>  <span class=c1># (4)!</span>
</span><span id=__span-50-6><a id=__codelineno-50-6 name=__codelineno-50-6 href=#__codelineno-50-6></a><span class=gp>... </span>        <span class=n>weekday</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>dt_nb</span><span class=o>.</span><span class=n>weekday_nb</span><span class=p>(</span><span class=n>index</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>  <span class=c1># (5)!</span>
</span><span id=__span-50-7><a id=__codelineno-50-7 name=__codelineno-50-7 href=#__codelineno-50-7></a><span class=gp>... </span>        <span class=n>hour</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>dt_nb</span><span class=o>.</span><span class=n>hour_nb</span><span class=p>(</span><span class=n>index</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span><span id=__span-50-8><a id=__codelineno-50-8 name=__codelineno-50-8 href=#__codelineno-50-8></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>weekday</span> <span class=o>==</span> <span class=mi>1</span> <span class=ow>and</span> <span class=n>hour</span> <span class=o>==</span> <span class=mi>17</span><span class=p>:</span>  <span class=c1># (6)!</span>
</span><span id=__span-50-9><a id=__codelineno-50-9 name=__codelineno-50-9 href=#__codelineno-50-9></a><span class=gp>... </span>            <span class=n>c</span><span class=o>.</span><span class=n>out</span><span class=p>[</span><span class=n>out_i</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>  <span class=c1># (7)!</span>
</span><span id=__span-50-10><a id=__codelineno-50-10 name=__codelineno-50-10 href=#__codelineno-50-10></a><span class=gp>... </span>            <span class=n>last_i</span> <span class=o>=</span> <span class=n>out_i</span>
</span><span id=__span-50-11><a id=__codelineno-50-11 name=__codelineno-50-11 href=#__codelineno-50-11></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>last_i</span>  <span class=c1># (8)!</span>
</span><span id=__span-50-12><a id=__codelineno-50-12 name=__codelineno-50-12 href=#__codelineno-50-12></a>
</span><span id=__span-50-13><a id=__codelineno-50-13 name=__codelineno-50-13 href=#__codelineno-50-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pd_acc</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>generate</span><span class=p>(</span>  <span class=c1># (9)!</span>
</span><span id=__span-50-14><a id=__codelineno-50-14 name=__codelineno-50-14 href=#__codelineno-50-14></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span>  <span class=c1># (10)!</span>
</span><span id=__span-50-15><a id=__codelineno-50-15 name=__codelineno-50-15 href=#__codelineno-50-15></a><span class=gp>... </span>    <span class=n>place_func_nb</span><span class=p>,</span>
</span><span id=__span-50-16><a id=__codelineno-50-16 name=__codelineno-50-16 href=#__codelineno-50-16></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>index</span><span class=p>),</span>  <span class=c1># (11)!</span>
</span><span id=__span-50-17><a id=__codelineno-50-17 name=__codelineno-50-17 href=#__codelineno-50-17></a><span class=gp>... </span>    <span class=n>wrapper</span><span class=o>=</span><span class=n>symbol_wrapper</span>  <span class=c1># (12)!</span>
</span><span id=__span-50-18><a id=__codelineno-50-18 name=__codelineno-50-18 href=#__codelineno-50-18></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-50-19><a id=__codelineno-50-19 name=__codelineno-50-19 href=#__codelineno-50-19></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-50-20><a id=__codelineno-50-20 name=__codelineno-50-20 href=#__codelineno-50-20></a><span class=go>symbol</span>
</span><span id=__span-50-21><a id=__codelineno-50-21 name=__codelineno-50-21 href=#__codelineno-50-21></a><span class=go>BTCUSDT    0</span>
</span><span id=__span-50-22><a id=__codelineno-50-22 name=__codelineno-50-22 href=#__codelineno-50-22></a><span class=go>ETHUSDT    0</span>
</span><span id=__span-50-23><a id=__codelineno-50-23 name=__codelineno-50-23 href=#__codelineno-50-23></a><span class=go>dtype: int64</span>
</span></code></pre></div> <ol> <li>The placement function receives a context and any other user-defined arguments.</li> <li>Create a variable to track the position of the last placed signal (if any).</li> <li>Iterate over the output array with a local index.</li> <li>Get the global index to retrieve the current timestamp. For example, if the array segment has 3 elements (<code>len(out)</code>) and the start index is 2 (<code>from_i</code>), then the first element is at position 2 (<code>i</code>) and the last at position 5.</li> <li><a href=https://vectorbt.pro/pvt_41531c19/api/utils/datetime_nb/ >dt_nb</a> provides Numba-compiled functions for working with datetimes and timedeltas, but usually expects integer representations!</li> <li>Check if the current timestamp is 17:00 on a Tuesday.</li> <li>If it is, place a signal using the local index; otherwise, continue to the next timestamp.</li> <li>Make sure the returned index is local, not global.</li> <li>Call <a href=https://vectorbt.pro/pvt_41531c19/api/signals/accessors/#vectorbtpro.signals.accessors.SignalsAccessor.generate>SignalsAccessor.generate</a> as a class method of <a href=https://vectorbt.pro/pvt_41531c19/api/signals/accessors/#vectorbtpro.signals.accessors.SignalsAccessor>SignalsAccessor</a>.</li> <li>Provide the shape to iterate over.</li> <li>Provide the index in integer form (total number of nanoseconds).</li> <li>Provide the wrapper to wrap the resulting NumPy array.</li> </ol> <div class="admonition info"> <p class=admonition-title>Info</p> <p>Segments in <a href=https://vectorbt.pro/pvt_41531c19/api/signals/nb/#vectorbtpro.signals.nb.generate_nb>generate_nb</a> are always full columns.</p> </div> <p>But, since our index is a daily index, there will not be any signal. Instead, let's place a signal at the next available timestamp:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-51-1><a id=__codelineno-51-1 name=__codelineno-51-1 href=#__codelineno-51-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-51-2><a id=__codelineno-51-2 name=__codelineno-51-2 href=#__codelineno-51-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>place_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>index</span><span class=p>):</span>
</span><span id=__span-51-3><a id=__codelineno-51-3 name=__codelineno-51-3 href=#__codelineno-51-3></a><span class=gp>... </span>    <span class=n>last_i</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>
</span><span id=__span-51-4><a id=__codelineno-51-4 name=__codelineno-51-4 href=#__codelineno-51-4></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>out_i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>out</span><span class=p>)):</span>
</span><span id=__span-51-5><a id=__codelineno-51-5 name=__codelineno-51-5 href=#__codelineno-51-5></a><span class=gp>... </span>        <span class=n>i</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>from_i</span> <span class=o>+</span> <span class=n>out_i</span>
</span><span id=__span-51-6><a id=__codelineno-51-6 name=__codelineno-51-6 href=#__codelineno-51-6></a><span class=gp>... </span>        <span class=n>weekday</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>dt_nb</span><span class=o>.</span><span class=n>weekday_nb</span><span class=p>(</span><span class=n>index</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span><span id=__span-51-7><a id=__codelineno-51-7 name=__codelineno-51-7 href=#__codelineno-51-7></a><span class=gp>... </span>        <span class=n>hour</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>dt_nb</span><span class=o>.</span><span class=n>hour_nb</span><span class=p>(</span><span class=n>index</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span><span id=__span-51-8><a id=__codelineno-51-8 name=__codelineno-51-8 href=#__codelineno-51-8></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>weekday</span> <span class=o>==</span> <span class=mi>1</span> <span class=ow>and</span> <span class=n>hour</span> <span class=o>==</span> <span class=mi>17</span><span class=p>:</span>
</span><span id=__span-51-9><a id=__codelineno-51-9 name=__codelineno-51-9 href=#__codelineno-51-9></a><span class=gp>... </span>            <span class=n>c</span><span class=o>.</span><span class=n>out</span><span class=p>[</span><span class=n>out_i</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-51-10><a id=__codelineno-51-10 name=__codelineno-51-10 href=#__codelineno-51-10></a><span class=gp>... </span>            <span class=n>last_i</span> <span class=o>=</span> <span class=n>out_i</span>
</span><span id=__span-51-11><a id=__codelineno-51-11 name=__codelineno-51-11 href=#__codelineno-51-11></a><span class=gp>... </span>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-51-12><a id=__codelineno-51-12 name=__codelineno-51-12 href=#__codelineno-51-12></a><span class=gp>... </span>            <span class=n>past_target_midnight</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>dt_nb</span><span class=o>.</span><span class=n>past_weekday_nb</span><span class=p>(</span><span class=n>index</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-51-13><a id=__codelineno-51-13 name=__codelineno-51-13 href=#__codelineno-51-13></a><span class=gp>... </span>            <span class=n>past_target</span> <span class=o>=</span> <span class=n>past_target_midnight</span> <span class=o>+</span> <span class=mi>17</span> <span class=o>*</span> <span class=n>vbt</span><span class=o>.</span><span class=n>dt_nb</span><span class=o>.</span><span class=n>h_ns</span>  <span class=c1># (2)!</span>
</span><span id=__span-51-14><a id=__codelineno-51-14 name=__codelineno-51-14 href=#__codelineno-51-14></a><span class=gp>... </span>            <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>index</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>past_target</span><span class=p>)</span> <span class=ow>and</span> \
</span><span id=__span-51-15><a id=__codelineno-51-15 name=__codelineno-51-15 href=#__codelineno-51-15></a><span class=gp>... </span>                <span class=n>index</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>past_target</span><span class=p>:</span>  <span class=c1># (3)!</span>
</span><span id=__span-51-16><a id=__codelineno-51-16 name=__codelineno-51-16 href=#__codelineno-51-16></a><span class=gp>... </span>                <span class=n>c</span><span class=o>.</span><span class=n>out</span><span class=p>[</span><span class=n>out_i</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-51-17><a id=__codelineno-51-17 name=__codelineno-51-17 href=#__codelineno-51-17></a><span class=gp>... </span>                <span class=n>last_i</span> <span class=o>=</span> <span class=n>out_i</span>
</span><span id=__span-51-18><a id=__codelineno-51-18 name=__codelineno-51-18 href=#__codelineno-51-18></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>last_i</span>
</span><span id=__span-51-19><a id=__codelineno-51-19 name=__codelineno-51-19 href=#__codelineno-51-19></a>
</span><span id=__span-51-20><a id=__codelineno-51-20 name=__codelineno-51-20 href=#__codelineno-51-20></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pd_acc</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>generate</span><span class=p>(</span>
</span><span id=__span-51-21><a id=__codelineno-51-21 name=__codelineno-51-21 href=#__codelineno-51-21></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span>
</span><span id=__span-51-22><a id=__codelineno-51-22 name=__codelineno-51-22 href=#__codelineno-51-22></a><span class=gp>... </span>    <span class=n>place_func_nb</span><span class=p>,</span>
</span><span id=__span-51-23><a id=__codelineno-51-23 name=__codelineno-51-23 href=#__codelineno-51-23></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>index</span><span class=p>),</span>
</span><span id=__span-51-24><a id=__codelineno-51-24 name=__codelineno-51-24 href=#__codelineno-51-24></a><span class=gp>... </span>    <span class=n>wrapper</span><span class=o>=</span><span class=n>symbol_wrapper</span>
</span><span id=__span-51-25><a id=__codelineno-51-25 name=__codelineno-51-25 href=#__codelineno-51-25></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-51-26><a id=__codelineno-51-26 name=__codelineno-51-26 href=#__codelineno-51-26></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-51-27><a id=__codelineno-51-27 name=__codelineno-51-27 href=#__codelineno-51-27></a><span class=go>symbol</span>
</span><span id=__span-51-28><a id=__codelineno-51-28 name=__codelineno-51-28 href=#__codelineno-51-28></a><span class=go>BTCUSDT    52</span>
</span><span id=__span-51-29><a id=__codelineno-51-29 name=__codelineno-51-29 href=#__codelineno-51-29></a><span class=go>ETHUSDT    52</span>
</span><span id=__span-51-30><a id=__codelineno-51-30 name=__codelineno-51-30 href=#__codelineno-51-30></a><span class=go>dtype: int64</span>
</span><span id=__span-51-31><a id=__codelineno-51-31 name=__codelineno-51-31 href=#__codelineno-51-31></a>
</span><span id=__span-51-32><a id=__codelineno-51-32 name=__codelineno-51-32 href=#__codelineno-51-32></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>mask</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)]</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%A %m/</span><span class=si>%d</span><span class=s1>/%Y&#39;</span><span class=p>)</span>  <span class=c1># (4)!</span>
</span><span id=__span-51-33><a id=__codelineno-51-33 name=__codelineno-51-33 href=#__codelineno-51-33></a><span class=go>Index([&#39;Thursday 01/07/2021&#39;, ..., &#39;Thursday 12/30/2021&#39;],</span>
</span><span id=__span-51-34><a id=__codelineno-51-34 name=__codelineno-51-34 href=#__codelineno-51-34></a><span class=go>      dtype=&#39;object&#39;, name=&#39;Open time&#39;)</span>
</span></code></pre></div> <ol> <li>Get the timestamp of midnight on the previous Tuesday.</li> <li>Get the timestamp for 17:00 on the previous Tuesday.</li> <li>Check if the previous timestamp was before and the current timestamp is after the target time.</li> <li>All generated signals should occur on Wednesdays.</li> </ol> <p>The key point in the code above is that all datetime logic is handled using simple integers!</p> <div class="admonition important"> <p class=admonition-title>Important</p> <p>When converting to integer format, each datetime object's timezone is effectively set to UTC. So, make sure any value compared to the UTC timestamp is also in UTC.</p> </div> <p>But what if you want to support multiple parameter combinations? We cannot use the above function with the indicator factory because it does not look like an apply function. Fortunately, VBT offers a dedicated indicator factory subclass for signal generation: <a href=https://vectorbt.pro/pvt_41531c19/api/signals/factory/#vectorbtpro.signals.factory.SignalFactory>SignalFactory</a>. This class supports several generation modes, set by the <code>mode</code> argument of type <a href=https://vectorbt.pro/pvt_41531c19/api/signals/enums/#vectorbtpro.signals.enums.FactoryMode>FactoryMode</a>. In this case, the mode is <code>FactoryMode.Entries</code> because our function generates signals based only on the target shape, not on other signal arrays. The signal factory can accept any combination of inputs, parameters, and in-place outputs to build the skeleton of our new indicator class.</p> <p>The signal factory includes the class method <a href=https://vectorbt.pro/pvt_41531c19/api/signals/factory/#vectorbtpro.signals.factory.SignalFactory.with_place_func>SignalFactory.with_place_func</a>, which is similar to the familiar <code>from_apply_func</code>. It takes a placement function and generates a custom function that performs all the necessary pre- and post-processing for <a href=https://vectorbt.pro/pvt_41531c19/api/signals/nb/#vectorbtpro.signals.nb.generate_nb>generate_nb</a>. (Note that other modes may use different generation functions.) This custom function, for example, prepares arguments and assigns them to the correct positions in the placement function call. It is then passed to <a href=https://vectorbt.pro/pvt_41531c19/api/indicators/factory/#vectorbtpro.indicators.factory.IndicatorFactory.with_custom_func>IndicatorFactory.with_custom_func</a>. As a result, you get an indicator class with a <code>run</code> method you can use with any custom shape or parameter grid. Convenient, right?</p> <p>Let's parameterize the exact-match placement function with two parameters: weekday and hour.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-52-1><a id=__codelineno-52-1 name=__codelineno-52-1 href=#__codelineno-52-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-52-2><a id=__codelineno-52-2 name=__codelineno-52-2 href=#__codelineno-52-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>place_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>weekday</span><span class=p>,</span> <span class=n>hour</span><span class=p>,</span> <span class=n>index</span><span class=p>):</span>  <span class=c1># (1)!</span>
</span><span id=__span-52-3><a id=__codelineno-52-3 name=__codelineno-52-3 href=#__codelineno-52-3></a><span class=gp>... </span>    <span class=n>last_i</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>
</span><span id=__span-52-4><a id=__codelineno-52-4 name=__codelineno-52-4 href=#__codelineno-52-4></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>out_i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>out</span><span class=p>)):</span>
</span><span id=__span-52-5><a id=__codelineno-52-5 name=__codelineno-52-5 href=#__codelineno-52-5></a><span class=gp>... </span>        <span class=n>i</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>from_i</span> <span class=o>+</span> <span class=n>out_i</span>
</span><span id=__span-52-6><a id=__codelineno-52-6 name=__codelineno-52-6 href=#__codelineno-52-6></a><span class=gp>... </span>        <span class=n>weekday_now</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>dt_nb</span><span class=o>.</span><span class=n>weekday_nb</span><span class=p>(</span><span class=n>index</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span><span id=__span-52-7><a id=__codelineno-52-7 name=__codelineno-52-7 href=#__codelineno-52-7></a><span class=gp>... </span>        <span class=n>hour_now</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>dt_nb</span><span class=o>.</span><span class=n>hour_nb</span><span class=p>(</span><span class=n>index</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span><span id=__span-52-8><a id=__codelineno-52-8 name=__codelineno-52-8 href=#__codelineno-52-8></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>weekday_now</span> <span class=o>==</span> <span class=n>weekday</span> <span class=ow>and</span> <span class=n>hour_now</span> <span class=o>==</span> <span class=n>hour</span><span class=p>:</span>
</span><span id=__span-52-9><a id=__codelineno-52-9 name=__codelineno-52-9 href=#__codelineno-52-9></a><span class=gp>... </span>            <span class=n>c</span><span class=o>.</span><span class=n>out</span><span class=p>[</span><span class=n>out_i</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-52-10><a id=__codelineno-52-10 name=__codelineno-52-10 href=#__codelineno-52-10></a><span class=gp>... </span>            <span class=n>last_i</span> <span class=o>=</span> <span class=n>out_i</span>
</span><span id=__span-52-11><a id=__codelineno-52-11 name=__codelineno-52-11 href=#__codelineno-52-11></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>last_i</span>
</span><span id=__span-52-12><a id=__codelineno-52-12 name=__codelineno-52-12 href=#__codelineno-52-12></a>
</span><span id=__span-52-13><a id=__codelineno-52-13 name=__codelineno-52-13 href=#__codelineno-52-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>EntryGenerator</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>SignalFactory</span><span class=p>(</span>
</span><span id=__span-52-14><a id=__codelineno-52-14 name=__codelineno-52-14 href=#__codelineno-52-14></a><span class=gp>... </span>    <span class=n>mode</span><span class=o>=</span><span class=s2>&quot;entries&quot;</span><span class=p>,</span>
</span><span id=__span-52-15><a id=__codelineno-52-15 name=__codelineno-52-15 href=#__codelineno-52-15></a><span class=gp>... </span>    <span class=n>param_names</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;weekday&quot;</span><span class=p>,</span> <span class=s2>&quot;hour&quot;</span><span class=p>]</span>
</span><span id=__span-52-16><a id=__codelineno-52-16 name=__codelineno-52-16 href=#__codelineno-52-16></a><span class=gp>... </span><span class=p>)</span><span class=o>.</span><span class=n>with_place_func</span><span class=p>(</span>
</span><span id=__span-52-17><a id=__codelineno-52-17 name=__codelineno-52-17 href=#__codelineno-52-17></a><span class=gp>... </span>    <span class=n>entry_place_func_nb</span><span class=o>=</span><span class=n>place_func_nb</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-52-18><a id=__codelineno-52-18 name=__codelineno-52-18 href=#__codelineno-52-18></a><span class=gp>... </span>    <span class=n>entry_settings</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>  <span class=c1># (3)!</span>
</span><span id=__span-52-19><a id=__codelineno-52-19 name=__codelineno-52-19 href=#__codelineno-52-19></a><span class=gp>... </span>        <span class=n>pass_params</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;weekday&quot;</span><span class=p>,</span> <span class=s2>&quot;hour&quot;</span><span class=p>],</span>
</span><span id=__span-52-20><a id=__codelineno-52-20 name=__codelineno-52-20 href=#__codelineno-52-20></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-52-21><a id=__codelineno-52-21 name=__codelineno-52-21 href=#__codelineno-52-21></a><span class=gp>... </span>    <span class=n>var_args</span><span class=o>=</span><span class=kc>True</span>  <span class=c1># (4)!</span>
</span><span id=__span-52-22><a id=__codelineno-52-22 name=__codelineno-52-22 href=#__codelineno-52-22></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-52-23><a id=__codelineno-52-23 name=__codelineno-52-23 href=#__codelineno-52-23></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entry_generator</span> <span class=o>=</span> <span class=n>EntryGenerator</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span><span id=__span-52-24><a id=__codelineno-52-24 name=__codelineno-52-24 href=#__codelineno-52-24></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span>  <span class=c1># (5)!</span>
</span><span id=__span-52-25><a id=__codelineno-52-25 name=__codelineno-52-25 href=#__codelineno-52-25></a><span class=gp>... </span>    <span class=mi>1</span><span class=p>,</span> 
</span><span id=__span-52-26><a id=__codelineno-52-26 name=__codelineno-52-26 href=#__codelineno-52-26></a><span class=gp>... </span>    <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>17</span><span class=p>],</span>  <span class=c1># (6)!</span>
</span><span id=__span-52-27><a id=__codelineno-52-27 name=__codelineno-52-27 href=#__codelineno-52-27></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>index</span><span class=p>),</span>  <span class=c1># (7)!</span>
</span><span id=__span-52-28><a id=__codelineno-52-28 name=__codelineno-52-28 href=#__codelineno-52-28></a><span class=gp>... </span>    <span class=n>input_index</span><span class=o>=</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>index</span><span class=p>,</span>  <span class=c1># (8)!</span>
</span><span id=__span-52-29><a id=__codelineno-52-29 name=__codelineno-52-29 href=#__codelineno-52-29></a><span class=gp>... </span>    <span class=n>input_columns</span><span class=o>=</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>columns</span>
</span><span id=__span-52-30><a id=__codelineno-52-30 name=__codelineno-52-30 href=#__codelineno-52-30></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-52-31><a id=__codelineno-52-31 name=__codelineno-52-31 href=#__codelineno-52-31></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entry_generator</span><span class=o>.</span><span class=n>entries</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-52-32><a id=__codelineno-52-32 name=__codelineno-52-32 href=#__codelineno-52-32></a><span class=go>custom_weekday  custom_hour  symbol </span>
</span><span id=__span-52-33><a id=__codelineno-52-33 name=__codelineno-52-33 href=#__codelineno-52-33></a><span class=go>2               0            BTCUSDT    52</span>
</span><span id=__span-52-34><a id=__codelineno-52-34 name=__codelineno-52-34 href=#__codelineno-52-34></a><span class=go>                             ETHUSDT    52</span>
</span><span id=__span-52-35><a id=__codelineno-52-35 name=__codelineno-52-35 href=#__codelineno-52-35></a><span class=go>                17           BTCUSDT     0</span>
</span><span id=__span-52-36><a id=__codelineno-52-36 name=__codelineno-52-36 href=#__codelineno-52-36></a><span class=go>                             ETHUSDT     0</span>
</span><span id=__span-52-37><a id=__codelineno-52-37 name=__codelineno-52-37 href=#__codelineno-52-37></a><span class=go>dtype: int64</span>
</span></code></pre></div> <ol> <li>Each indicator function must first accept the input shape, then (optionally) inputs, in-place outputs, parameters, and finally any additional arguments.</li> <li>In <code>FactoryMode.Entries</code>, provide your placement function as <code>entry_place_func_nb</code>.</li> <li>Provide settings to ensure specific inputs, in-place outputs, and parameters are passed to the placement function. If omitted, nothing will be passed!</li> <li>Enable variable arguments to allow passing the index as an extra positional argument.</li> <li>Input shape must be given if neither inputs nor in-place outputs provide it.</li> <li>Test two time combinations: 00:00 and 17:00.</li> <li>Possible thanks to <code>var_args</code>.</li> <li>Pass Pandas metadata for wrapping output arrays.</li> </ol> <div class="admonition note"> <p class=admonition-title>Note</p> <p>The <code>FactoryMode.Entries</code> mode does not require you to generate only entry signals during simulation. You can produce any mask, including exits, as long as they do not depend on entries.</p> </div> <p>The indicator function matches all midnight times but not afternoon times, as expected, since our index is daily and only contains midnight times. You can easily plot the indicator with the attached <code>plot</code> method, which knows how to visualize each mode:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-53-1><a id=__codelineno-53-1 name=__codelineno-53-1 href=#__codelineno-53-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entry_generator</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>column</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=s2>&quot;BTCUSDT&quot;</span><span class=p>))</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/signal-dev/signal_factory.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/signal-dev/signal_factory.dark.svg#only-dark></p> <h3 id=exits>Exits<a class=headerlink href=#exits title="Permanent link">&para;</a></h3> <p>After creating the position entry mask, we need to determine the position exit mask. When exits are independent of entries, we can use the generator introduced above. However, in some cases, the exit logic is entirely dependent on the entry signal. For example, a stop loss exit signal only exists because of the entry signal that triggered the stop loss. There is also no guarantee that each entry will have a corresponding exit. Therefore, this mode should only be used when entries do not depend on exits, but exits depend on entries. In this case, generation is performed using the Numba-compiled function <a href=https://vectorbt.pro/pvt_41531c19/api/signals/nb/#vectorbtpro.signals.nb.generate_ex_nb>generate_ex_nb</a> and its accessor instance method <a href=https://vectorbt.pro/pvt_41531c19/api/signals/accessors/#vectorbtpro.signals.accessors.SignalsAccessor.generate_exits>SignalsAccessor.generate_exits</a>. The provided context is now of type <a href=https://vectorbt.pro/pvt_41531c19/api/signals/enums/#vectorbtpro.signals.enums.GenExContext>GenExContext</a> and includes the input mask along with other generator-related arguments.</p> <p>The generator receives an entry mask array and, for each column, visits every entry signal, calling a UDF to place one or more exit signals that follow it. Remember how we accepted <code>from_i</code> and <code>to_i</code> in the placement functions above? The previous mode always passed <code>0</code> as <code>from_i</code> and <code>len(index)</code> as <code>to_i</code> because we could set our signals anywhere in the entire column. Here, <code>from_i</code> is usually the position immediately after the previous entry, while <code>to_i</code> is typically the index of the next entry, which limits our decision range to the segment between each pair of entries.</p> <div class="admonition warning"> <p class=admonition-title>Warning</p> <p>Be aware that knowing the position of the next entry signal may introduce look-ahead bias. Use it only for iteration purposes, and never set data based on <code>to_i</code>!</p> </div> <p>Let's generate an entry each quarter and an exit at the following date:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-54-1><a id=__codelineno-54-1 name=__codelineno-54-1 href=#__codelineno-54-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-54-2><a id=__codelineno-54-2 name=__codelineno-54-2 href=#__codelineno-54-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>exit_place_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span><span id=__span-54-3><a id=__codelineno-54-3 name=__codelineno-54-3 href=#__codelineno-54-3></a><span class=gp>... </span>    <span class=n>c</span><span class=o>.</span><span class=n>out</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>  <span class=c1># (1)!</span>
</span><span id=__span-54-4><a id=__codelineno-54-4 name=__codelineno-54-4 href=#__codelineno-54-4></a><span class=gp>... </span>    <span class=k>return</span> <span class=mi>0</span>
</span><span id=__span-54-5><a id=__codelineno-54-5 name=__codelineno-54-5 href=#__codelineno-54-5></a>
</span><span id=__span-54-6><a id=__codelineno-54-6 name=__codelineno-54-6 href=#__codelineno-54-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entries</span> <span class=o>=</span> <span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-54-7><a id=__codelineno-54-7 name=__codelineno-54-7 href=#__codelineno-54-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entries</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>every</span><span class=o>=</span><span class=s2>&quot;Q&quot;</span><span class=p>,</span> <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-54-8><a id=__codelineno-54-8 name=__codelineno-54-8 href=#__codelineno-54-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entries</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>entries</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)]</span>
</span><span id=__span-54-9><a id=__codelineno-54-9 name=__codelineno-54-9 href=#__codelineno-54-9></a><span class=go>DatetimeIndex([&#39;2021-03-31 00:00:00+00:00&#39;, &#39;2021-06-30 00:00:00+00:00&#39;,</span>
</span><span id=__span-54-10><a id=__codelineno-54-10 name=__codelineno-54-10 href=#__codelineno-54-10></a><span class=go>               &#39;2021-09-30 00:00:00+00:00&#39;, &#39;2021-12-31 00:00:00+00:00&#39;],</span>
</span><span id=__span-54-11><a id=__codelineno-54-11 name=__codelineno-54-11 href=#__codelineno-54-11></a><span class=go>              dtype=&#39;datetime64[ns, UTC]&#39;, name=&#39;Open time&#39;, freq=None)</span>
</span><span id=__span-54-12><a id=__codelineno-54-12 name=__codelineno-54-12 href=#__codelineno-54-12></a>
</span><span id=__span-54-13><a id=__codelineno-54-13 name=__codelineno-54-13 href=#__codelineno-54-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span> <span class=o>=</span> <span class=n>entries</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>generate_exits</span><span class=p>(</span><span class=n>exit_place_func_nb</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-54-14><a id=__codelineno-54-14 name=__codelineno-54-14 href=#__codelineno-54-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>exits</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)]</span>
</span><span id=__span-54-15><a id=__codelineno-54-15 name=__codelineno-54-15 href=#__codelineno-54-15></a><span class=go>DatetimeIndex([&#39;2021-04-01 00:00:00+00:00&#39;, &#39;2021-07-01 00:00:00+00:00&#39;,</span>
</span><span id=__span-54-16><a id=__codelineno-54-16 name=__codelineno-54-16 href=#__codelineno-54-16></a><span class=go>               &#39;2021-10-01 00:00:00+00:00&#39;],</span>
</span><span id=__span-54-17><a id=__codelineno-54-17 name=__codelineno-54-17 href=#__codelineno-54-17></a><span class=go>              dtype=&#39;datetime64[ns, UTC]&#39;, name=&#39;Open time&#39;, freq=None)</span>
</span></code></pre></div> <ol> <li>Place an exit at the first position in the segment.</li> <li>Unlike <a href=https://vectorbt.pro/pvt_41531c19/api/signals/accessors/#vectorbtpro.signals.accessors.SignalsAccessor.generate>SignalsAccessor.generate</a>, this method is bound to a Pandas object containing entries and uses its metadata.</li> </ol> <p>We can adjust the distance to the entry signal using the <code>wait</code> parameter, which defaults to 1. Let's instruct VBT to begin each segment at the same timestamp as the entry:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-55-1><a id=__codelineno-55-1 name=__codelineno-55-1 href=#__codelineno-55-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span> <span class=o>=</span> <span class=n>entries</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>generate_exits</span><span class=p>(</span>
</span><span id=__span-55-2><a id=__codelineno-55-2 name=__codelineno-55-2 href=#__codelineno-55-2></a><span class=gp>... </span>    <span class=n>exit_place_func_nb</span><span class=p>,</span>
</span><span id=__span-55-3><a id=__codelineno-55-3 name=__codelineno-55-3 href=#__codelineno-55-3></a><span class=gp>... </span>    <span class=n>wait</span><span class=o>=</span><span class=mi>0</span>
</span><span id=__span-55-4><a id=__codelineno-55-4 name=__codelineno-55-4 href=#__codelineno-55-4></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-55-5><a id=__codelineno-55-5 name=__codelineno-55-5 href=#__codelineno-55-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>exits</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)]</span>
</span><span id=__span-55-6><a id=__codelineno-55-6 name=__codelineno-55-6 href=#__codelineno-55-6></a><span class=go>DatetimeIndex([&#39;2021-03-31 00:00:00+00:00&#39;, &#39;2021-06-30 00:00:00+00:00&#39;,</span>
</span><span id=__span-55-7><a id=__codelineno-55-7 name=__codelineno-55-7 href=#__codelineno-55-7></a><span class=go>               &#39;2021-09-30 00:00:00+00:00&#39;, &#39;2021-12-31 00:00:00+00:00&#39;],</span>
</span><span id=__span-55-8><a id=__codelineno-55-8 name=__codelineno-55-8 href=#__codelineno-55-8></a><span class=go>              dtype=&#39;datetime64[ns, UTC]&#39;, name=&#39;Open time&#39;, freq=None)</span>
</span></code></pre></div> <p>Next, let's implement a variable waiting time based on a frequency. We will wait exactly 7 days before placing an exit:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-56-1><a id=__codelineno-56-1 name=__codelineno-56-1 href=#__codelineno-56-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-56-2><a id=__codelineno-56-2 name=__codelineno-56-2 href=#__codelineno-56-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>exit_place_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>index</span><span class=p>,</span> <span class=n>wait_td</span><span class=p>):</span>
</span><span id=__span-56-3><a id=__codelineno-56-3 name=__codelineno-56-3 href=#__codelineno-56-3></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>out_i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>out</span><span class=p>)):</span>
</span><span id=__span-56-4><a id=__codelineno-56-4 name=__codelineno-56-4 href=#__codelineno-56-4></a><span class=gp>... </span>        <span class=n>i</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>from_i</span> <span class=o>+</span> <span class=n>out_i</span>
</span><span id=__span-56-5><a id=__codelineno-56-5 name=__codelineno-56-5 href=#__codelineno-56-5></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>index</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>index</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>from_i</span><span class=p>]</span> <span class=o>+</span> <span class=n>wait_td</span><span class=p>:</span>  <span class=c1># (1)!</span>
</span><span id=__span-56-6><a id=__codelineno-56-6 name=__codelineno-56-6 href=#__codelineno-56-6></a><span class=gp>... </span>            <span class=k>return</span> <span class=n>out_i</span>  <span class=c1># (2)!</span>
</span><span id=__span-56-7><a id=__codelineno-56-7 name=__codelineno-56-7 href=#__codelineno-56-7></a><span class=gp>... </span>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span>
</span><span id=__span-56-8><a id=__codelineno-56-8 name=__codelineno-56-8 href=#__codelineno-56-8></a>
</span><span id=__span-56-9><a id=__codelineno-56-9 name=__codelineno-56-9 href=#__codelineno-56-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span> <span class=o>=</span> <span class=n>entries</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>generate_exits</span><span class=p>(</span>
</span><span id=__span-56-10><a id=__codelineno-56-10 name=__codelineno-56-10 href=#__codelineno-56-10></a><span class=gp>... </span>    <span class=n>exit_place_func_nb</span><span class=p>,</span>
</span><span id=__span-56-11><a id=__codelineno-56-11 name=__codelineno-56-11 href=#__codelineno-56-11></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>entries</span><span class=o>.</span><span class=n>index</span><span class=p>),</span>  <span class=c1># (3)!</span>
</span><span id=__span-56-12><a id=__codelineno-56-12 name=__codelineno-56-12 href=#__codelineno-56-12></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s2>&quot;7d&quot;</span><span class=p>)),</span>
</span><span id=__span-56-13><a id=__codelineno-56-13 name=__codelineno-56-13 href=#__codelineno-56-13></a><span class=gp>... </span>    <span class=n>wait</span><span class=o>=</span><span class=mi>0</span>
</span><span id=__span-56-14><a id=__codelineno-56-14 name=__codelineno-56-14 href=#__codelineno-56-14></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-56-15><a id=__codelineno-56-15 name=__codelineno-56-15 href=#__codelineno-56-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>exits</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)]</span>
</span><span id=__span-56-16><a id=__codelineno-56-16 name=__codelineno-56-16 href=#__codelineno-56-16></a><span class=go>DatetimeIndex([&#39;2021-04-07 00:00:00+00:00&#39;, &#39;2021-07-07 00:00:00+00:00&#39;,</span>
</span><span id=__span-56-17><a id=__codelineno-56-17 name=__codelineno-56-17 href=#__codelineno-56-17></a><span class=go>               &#39;2021-10-07 00:00:00+00:00&#39;],</span>
</span><span id=__span-56-18><a id=__codelineno-56-18 name=__codelineno-56-18 href=#__codelineno-56-18></a><span class=go>              dtype=&#39;datetime64[ns, UTC]&#39;, name=&#39;Open time&#39;, freq=None)</span>
</span></code></pre></div> <ol> <li>Check whether enough time has passed since the entry. For <code>c.from_i</code> to correspond to the entry's index, set <code>wait</code> to zero.</li> <li>By returning the index, the generator will automatically set the respective element to True.</li> <li>Additional arguments are provided here.</li> </ol> <p>But what happens to the exit for an entry if the next entry occurs less than 7 days later? Will an exit still be placed? No!</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-57-1><a id=__codelineno-57-1 name=__codelineno-57-1 href=#__codelineno-57-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entries</span> <span class=o>=</span> <span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-57-2><a id=__codelineno-57-2 name=__codelineno-57-2 href=#__codelineno-57-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entries</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>every</span><span class=o>=</span><span class=s2>&quot;5d&quot;</span><span class=p>,</span> <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-57-3><a id=__codelineno-57-3 name=__codelineno-57-3 href=#__codelineno-57-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span> <span class=o>=</span> <span class=n>entries</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>generate_exits</span><span class=p>(</span>
</span><span id=__span-57-4><a id=__codelineno-57-4 name=__codelineno-57-4 href=#__codelineno-57-4></a><span class=gp>... </span>    <span class=n>exit_place_func_nb</span><span class=p>,</span>
</span><span id=__span-57-5><a id=__codelineno-57-5 name=__codelineno-57-5 href=#__codelineno-57-5></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>entries</span><span class=o>.</span><span class=n>index</span><span class=p>),</span>
</span><span id=__span-57-6><a id=__codelineno-57-6 name=__codelineno-57-6 href=#__codelineno-57-6></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s2>&quot;7d&quot;</span><span class=p>)),</span>
</span><span id=__span-57-7><a id=__codelineno-57-7 name=__codelineno-57-7 href=#__codelineno-57-7></a><span class=gp>... </span>    <span class=n>wait</span><span class=o>=</span><span class=mi>0</span>
</span><span id=__span-57-8><a id=__codelineno-57-8 name=__codelineno-57-8 href=#__codelineno-57-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-57-9><a id=__codelineno-57-9 name=__codelineno-57-9 href=#__codelineno-57-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>exits</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)]</span>
</span><span id=__span-57-10><a id=__codelineno-57-10 name=__codelineno-57-10 href=#__codelineno-57-10></a><span class=go>DatetimeIndex([], dtype=&#39;datetime64[ns, UTC]&#39;, name=&#39;Open time&#39;, freq=&#39;D&#39;)</span>
</span></code></pre></div> <p>By default, each segment is limited to the space between two surrounding entries. To make this segment infinite, you can disable <code>until_next</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-58-1><a id=__codelineno-58-1 name=__codelineno-58-1 href=#__codelineno-58-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span> <span class=o>=</span> <span class=n>entries</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>generate_exits</span><span class=p>(</span>
</span><span id=__span-58-2><a id=__codelineno-58-2 name=__codelineno-58-2 href=#__codelineno-58-2></a><span class=gp>... </span>    <span class=n>exit_place_func_nb</span><span class=p>,</span>
</span><span id=__span-58-3><a id=__codelineno-58-3 name=__codelineno-58-3 href=#__codelineno-58-3></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>entries</span><span class=o>.</span><span class=n>index</span><span class=p>),</span>
</span><span id=__span-58-4><a id=__codelineno-58-4 name=__codelineno-58-4 href=#__codelineno-58-4></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s2>&quot;7d&quot;</span><span class=p>)),</span>
</span><span id=__span-58-5><a id=__codelineno-58-5 name=__codelineno-58-5 href=#__codelineno-58-5></a><span class=gp>... </span>    <span class=n>wait</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span><span id=__span-58-6><a id=__codelineno-58-6 name=__codelineno-58-6 href=#__codelineno-58-6></a><span class=gp>... </span>    <span class=n>until_next</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-58-7><a id=__codelineno-58-7 name=__codelineno-58-7 href=#__codelineno-58-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-58-8><a id=__codelineno-58-8 name=__codelineno-58-8 href=#__codelineno-58-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>exits</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)]</span>
</span><span id=__span-58-9><a id=__codelineno-58-9 name=__codelineno-58-9 href=#__codelineno-58-9></a><span class=go>DatetimeIndex([&#39;2021-01-08 00:00:00+00:00&#39;, &#39;2021-01-13 00:00:00+00:00&#39;,</span>
</span><span id=__span-58-10><a id=__codelineno-58-10 name=__codelineno-58-10 href=#__codelineno-58-10></a><span class=go>               &#39;2021-01-18 00:00:00+00:00&#39;, &#39;2021-01-23 00:00:00+00:00&#39;,</span>
</span><span id=__span-58-11><a id=__codelineno-58-11 name=__codelineno-58-11 href=#__codelineno-58-11></a><span class=go>               &#39;2021-01-28 00:00:00+00:00&#39;, &#39;2021-02-02 00:00:00+00:00&#39;,</span>
</span><span id=__span-58-12><a id=__codelineno-58-12 name=__codelineno-58-12 href=#__codelineno-58-12></a><span class=go>               ...</span>
</span><span id=__span-58-13><a id=__codelineno-58-13 name=__codelineno-58-13 href=#__codelineno-58-13></a><span class=go>               &#39;2021-12-04 00:00:00+00:00&#39;, &#39;2021-12-09 00:00:00+00:00&#39;,</span>
</span><span id=__span-58-14><a id=__codelineno-58-14 name=__codelineno-58-14 href=#__codelineno-58-14></a><span class=go>               &#39;2021-12-14 00:00:00+00:00&#39;, &#39;2021-12-19 00:00:00+00:00&#39;,</span>
</span><span id=__span-58-15><a id=__codelineno-58-15 name=__codelineno-58-15 href=#__codelineno-58-15></a><span class=go>               &#39;2021-12-24 00:00:00+00:00&#39;, &#39;2021-12-29 00:00:00+00:00&#39;],</span>
</span><span id=__span-58-16><a id=__codelineno-58-16 name=__codelineno-58-16 href=#__codelineno-58-16></a><span class=go>              dtype=&#39;datetime64[ns, UTC]&#39;, name=&#39;Open time&#39;, freq=None)</span>
</span></code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>In this case, it may be impossible to determine which exit belongs to which entry. Two or more entries may generate an exit at the same timestamp, so be careful!</p> </div> <p>In this example, the generated signals follow the sequence: <code>entry1</code>, <code>entry2</code>, <code>exit1</code>, <code>entry3</code>, <code>exit2</code>, and so on. If you pass these signals to the simulator, it will execute <code>entry1</code> and ignore <code>entry2</code> because there was no prior exit—you are still in the market. It will then properly execute <code>exit1</code>. Afterward, it will open a new position with <code>entry3</code> and immediately close it with <code>exit2</code>, which was originally intended for <code>entry2</code> (but that entry was ignored). To prevent this, enable <code>skip_until_exit</code> to avoid processing any new entry signal that comes before an exit for a previous entry signal. This setup matches the simulation order.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-59-1><a id=__codelineno-59-1 name=__codelineno-59-1 href=#__codelineno-59-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span> <span class=o>=</span> <span class=n>entries</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>generate_exits</span><span class=p>(</span>
</span><span id=__span-59-2><a id=__codelineno-59-2 name=__codelineno-59-2 href=#__codelineno-59-2></a><span class=gp>... </span>    <span class=n>exit_place_func_nb</span><span class=p>,</span>
</span><span id=__span-59-3><a id=__codelineno-59-3 name=__codelineno-59-3 href=#__codelineno-59-3></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>entries</span><span class=o>.</span><span class=n>index</span><span class=p>),</span>
</span><span id=__span-59-4><a id=__codelineno-59-4 name=__codelineno-59-4 href=#__codelineno-59-4></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>to_ns</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s2>&quot;7d&quot;</span><span class=p>)),</span>
</span><span id=__span-59-5><a id=__codelineno-59-5 name=__codelineno-59-5 href=#__codelineno-59-5></a><span class=gp>... </span>    <span class=n>wait</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span><span id=__span-59-6><a id=__codelineno-59-6 name=__codelineno-59-6 href=#__codelineno-59-6></a><span class=gp>... </span>    <span class=n>until_next</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-59-7><a id=__codelineno-59-7 name=__codelineno-59-7 href=#__codelineno-59-7></a><span class=gp>... </span>    <span class=n>skip_until_exit</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-59-8><a id=__codelineno-59-8 name=__codelineno-59-8 href=#__codelineno-59-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-59-9><a id=__codelineno-59-9 name=__codelineno-59-9 href=#__codelineno-59-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>exits</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)]</span>
</span><span id=__span-59-10><a id=__codelineno-59-10 name=__codelineno-59-10 href=#__codelineno-59-10></a><span class=go>DatetimeIndex([&#39;2021-01-08 00:00:00+00:00&#39;, &#39;2021-01-18 00:00:00+00:00&#39;,</span>
</span><span id=__span-59-11><a id=__codelineno-59-11 name=__codelineno-59-11 href=#__codelineno-59-11></a><span class=go>               &#39;2021-01-28 00:00:00+00:00&#39;, &#39;2021-02-07 00:00:00+00:00&#39;,</span>
</span><span id=__span-59-12><a id=__codelineno-59-12 name=__codelineno-59-12 href=#__codelineno-59-12></a><span class=go>               &#39;2021-02-17 00:00:00+00:00&#39;, &#39;2021-02-27 00:00:00+00:00&#39;,</span>
</span><span id=__span-59-13><a id=__codelineno-59-13 name=__codelineno-59-13 href=#__codelineno-59-13></a><span class=go>               ...</span>
</span><span id=__span-59-14><a id=__codelineno-59-14 name=__codelineno-59-14 href=#__codelineno-59-14></a><span class=go>               &#39;2021-11-04 00:00:00+00:00&#39;, &#39;2021-11-14 00:00:00+00:00&#39;,</span>
</span><span id=__span-59-15><a id=__codelineno-59-15 name=__codelineno-59-15 href=#__codelineno-59-15></a><span class=go>               &#39;2021-11-24 00:00:00+00:00&#39;, &#39;2021-12-04 00:00:00+00:00&#39;,</span>
</span><span id=__span-59-16><a id=__codelineno-59-16 name=__codelineno-59-16 href=#__codelineno-59-16></a><span class=go>               &#39;2021-12-14 00:00:00+00:00&#39;, &#39;2021-12-24 00:00:00+00:00&#39;],</span>
</span><span id=__span-59-17><a id=__codelineno-59-17 name=__codelineno-59-17 href=#__codelineno-59-17></a><span class=go>              dtype=&#39;datetime64[ns, UTC]&#39;, name=&#39;Open time&#39;, freq=None)</span>
</span></code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Always make sure to use <code>skip_until_exit</code> together with <code>until_next</code> set to False.</p> </div> <p>Finally, to make the process parametrizable, use <code>FactoryMode.Exits</code> as the mode and provide any supporting information with the prefix <code>exit</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-60-1><a id=__codelineno-60-1 name=__codelineno-60-1 href=#__codelineno-60-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-60-2><a id=__codelineno-60-2 name=__codelineno-60-2 href=#__codelineno-60-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>exit_place_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>wait_td</span><span class=p>,</span> <span class=n>index</span><span class=p>):</span>  <span class=c1># (1)!</span>
</span><span id=__span-60-3><a id=__codelineno-60-3 name=__codelineno-60-3 href=#__codelineno-60-3></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>out_i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>out</span><span class=p>)):</span>
</span><span id=__span-60-4><a id=__codelineno-60-4 name=__codelineno-60-4 href=#__codelineno-60-4></a><span class=gp>... </span>        <span class=n>i</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>from_i</span> <span class=o>+</span> <span class=n>out_i</span>
</span><span id=__span-60-5><a id=__codelineno-60-5 name=__codelineno-60-5 href=#__codelineno-60-5></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>index</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>index</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>from_i</span><span class=p>]</span> <span class=o>+</span> <span class=n>wait_td</span><span class=p>:</span>
</span><span id=__span-60-6><a id=__codelineno-60-6 name=__codelineno-60-6 href=#__codelineno-60-6></a><span class=gp>... </span>            <span class=k>return</span> <span class=n>out_i</span>
</span><span id=__span-60-7><a id=__codelineno-60-7 name=__codelineno-60-7 href=#__codelineno-60-7></a><span class=gp>... </span>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span>
</span><span id=__span-60-8><a id=__codelineno-60-8 name=__codelineno-60-8 href=#__codelineno-60-8></a>
</span><span id=__span-60-9><a id=__codelineno-60-9 name=__codelineno-60-9 href=#__codelineno-60-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>ExitGenerator</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>SignalFactory</span><span class=p>(</span>
</span><span id=__span-60-10><a id=__codelineno-60-10 name=__codelineno-60-10 href=#__codelineno-60-10></a><span class=gp>... </span>    <span class=n>mode</span><span class=o>=</span><span class=s2>&quot;exits&quot;</span><span class=p>,</span>
</span><span id=__span-60-11><a id=__codelineno-60-11 name=__codelineno-60-11 href=#__codelineno-60-11></a><span class=gp>... </span>    <span class=n>param_names</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;wait_td&quot;</span><span class=p>]</span>
</span><span id=__span-60-12><a id=__codelineno-60-12 name=__codelineno-60-12 href=#__codelineno-60-12></a><span class=gp>... </span><span class=p>)</span><span class=o>.</span><span class=n>with_place_func</span><span class=p>(</span>
</span><span id=__span-60-13><a id=__codelineno-60-13 name=__codelineno-60-13 href=#__codelineno-60-13></a><span class=gp>... </span>    <span class=n>exit_place_func_nb</span><span class=o>=</span><span class=n>exit_place_func_nb</span><span class=p>,</span>
</span><span id=__span-60-14><a id=__codelineno-60-14 name=__codelineno-60-14 href=#__codelineno-60-14></a><span class=gp>... </span>    <span class=n>exit_settings</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-60-15><a id=__codelineno-60-15 name=__codelineno-60-15 href=#__codelineno-60-15></a><span class=gp>... </span>        <span class=n>pass_params</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;wait_td&quot;</span><span class=p>],</span>
</span><span id=__span-60-16><a id=__codelineno-60-16 name=__codelineno-60-16 href=#__codelineno-60-16></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-60-17><a id=__codelineno-60-17 name=__codelineno-60-17 href=#__codelineno-60-17></a><span class=gp>... </span>    <span class=n>var_args</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-60-18><a id=__codelineno-60-18 name=__codelineno-60-18 href=#__codelineno-60-18></a><span class=gp>... </span>    <span class=n>wait</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-60-19><a id=__codelineno-60-19 name=__codelineno-60-19 href=#__codelineno-60-19></a><span class=gp>... </span>    <span class=n>until_next</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-60-20><a id=__codelineno-60-20 name=__codelineno-60-20 href=#__codelineno-60-20></a><span class=gp>... </span>    <span class=n>skip_until_exit</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-60-21><a id=__codelineno-60-21 name=__codelineno-60-21 href=#__codelineno-60-21></a><span class=gp>... </span>    <span class=n>param_settings</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>  <span class=c1># (3)!</span>
</span><span id=__span-60-22><a id=__codelineno-60-22 name=__codelineno-60-22 href=#__codelineno-60-22></a><span class=gp>... </span>        <span class=n>wait_td</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-60-23><a id=__codelineno-60-23 name=__codelineno-60-23 href=#__codelineno-60-23></a><span class=gp>... </span>            <span class=n>post_index_func</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=k>lambda</span> <span class=n>y</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=n>y</span><span class=p>)))</span>
</span><span id=__span-60-24><a id=__codelineno-60-24 name=__codelineno-60-24 href=#__codelineno-60-24></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-60-25><a id=__codelineno-60-25 name=__codelineno-60-25 href=#__codelineno-60-25></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-60-26><a id=__codelineno-60-26 name=__codelineno-60-26 href=#__codelineno-60-26></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-60-27><a id=__codelineno-60-27 name=__codelineno-60-27 href=#__codelineno-60-27></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exit_generator</span> <span class=o>=</span> <span class=n>ExitGenerator</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span><span id=__span-60-28><a id=__codelineno-60-28 name=__codelineno-60-28 href=#__codelineno-60-28></a><span class=gp>... </span>    <span class=n>entries</span><span class=p>,</span>  <span class=c1># (4)!</span>
</span><span id=__span-60-29><a id=__codelineno-60-29 name=__codelineno-60-29 href=#__codelineno-60-29></a><span class=gp>... </span>    <span class=p>[</span>
</span><span id=__span-60-30><a id=__codelineno-60-30 name=__codelineno-60-30 href=#__codelineno-60-30></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s2>&quot;3d&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>to_timedelta64</span><span class=p>(),</span>  <span class=c1># (5)!</span>
</span><span id=__span-60-31><a id=__codelineno-60-31 name=__codelineno-60-31 href=#__codelineno-60-31></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s2>&quot;7d&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>to_timedelta64</span><span class=p>()</span>
</span><span id=__span-60-32><a id=__codelineno-60-32 name=__codelineno-60-32 href=#__codelineno-60-32></a><span class=gp>... </span>    <span class=p>],</span>
</span><span id=__span-60-33><a id=__codelineno-60-33 name=__codelineno-60-33 href=#__codelineno-60-33></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-60-34><a id=__codelineno-60-34 name=__codelineno-60-34 href=#__codelineno-60-34></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-60-35><a id=__codelineno-60-35 name=__codelineno-60-35 href=#__codelineno-60-35></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exit_generator</span><span class=o>.</span><span class=n>exits</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-60-36><a id=__codelineno-60-36 name=__codelineno-60-36 href=#__codelineno-60-36></a><span class=go>custom_wait_td   symbol </span>
</span><span id=__span-60-37><a id=__codelineno-60-37 name=__codelineno-60-37 href=#__codelineno-60-37></a><span class=go>3 days 00:00:00  BTCUSDT    73</span>
</span><span id=__span-60-38><a id=__codelineno-60-38 name=__codelineno-60-38 href=#__codelineno-60-38></a><span class=go>                 ETHUSDT    73</span>
</span><span id=__span-60-39><a id=__codelineno-60-39 name=__codelineno-60-39 href=#__codelineno-60-39></a><span class=go>7 days 00:00:00  BTCUSDT    36</span>
</span><span id=__span-60-40><a id=__codelineno-60-40 name=__codelineno-60-40 href=#__codelineno-60-40></a><span class=go>                 ETHUSDT    36</span>
</span><span id=__span-60-41><a id=__codelineno-60-41 name=__codelineno-60-41 href=#__codelineno-60-41></a><span class=go>dtype: int64</span>
</span></code></pre></div> <ol> <li>Remember to switch the order of the parameters and user-defined arguments.</li> <li>Parameters for the generator can be passed as regular keyword arguments, including to the <code>run</code> method.</li> <li>Convert the index level with timedeltas to strings so you can easily select different values. The <code>post_index_func</code> function must take the original index and return a new index.</li> <li>There is no need to provide the input shape or Pandas metadata because both can be derived from the entries array.</li> <li>Test two timedelta combinations. Before passing, convert the index and timedeltas to NumPy. Here, you can use datetimes and timedeltas directly, without converting them to integers.</li> </ol> <p>If desired, you can remove redundant entries:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-61-1><a id=__codelineno-61-1 name=__codelineno-61-1 href=#__codelineno-61-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>new_entries</span> <span class=o>=</span> <span class=n>exit_generator</span><span class=o>.</span><span class=n>entries</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>first</span><span class=p>(</span>  <span class=c1># (1)!</span>
</span><span id=__span-61-2><a id=__codelineno-61-2 name=__codelineno-61-2 href=#__codelineno-61-2></a><span class=gp>... </span>    <span class=n>reset_by</span><span class=o>=</span><span class=n>exit_generator</span><span class=o>.</span><span class=n>exits</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-61-3><a id=__codelineno-61-3 name=__codelineno-61-3 href=#__codelineno-61-3></a><span class=gp>... </span>    <span class=n>allow_gaps</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>  <span class=c1># (3)!</span>
</span><span id=__span-61-4><a id=__codelineno-61-4 name=__codelineno-61-4 href=#__codelineno-61-4></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-61-5><a id=__codelineno-61-5 name=__codelineno-61-5 href=#__codelineno-61-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>new_entries</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>new_entries</span><span class=p>[(</span><span class=s2>&quot;7 days 00:00:00&quot;</span><span class=p>,</span> <span class=s2>&quot;BTCUSDT&quot;</span><span class=p>)]]</span>
</span><span id=__span-61-6><a id=__codelineno-61-6 name=__codelineno-61-6 href=#__codelineno-61-6></a><span class=go>DatetimeIndex([&#39;2021-01-01 00:00:00+00:00&#39;, &#39;2021-01-11 00:00:00+00:00&#39;,</span>
</span><span id=__span-61-7><a id=__codelineno-61-7 name=__codelineno-61-7 href=#__codelineno-61-7></a><span class=go>               &#39;2021-01-21 00:00:00+00:00&#39;, &#39;2021-01-31 00:00:00+00:00&#39;,</span>
</span><span id=__span-61-8><a id=__codelineno-61-8 name=__codelineno-61-8 href=#__codelineno-61-8></a><span class=go>               &#39;2021-02-10 00:00:00+00:00&#39;, &#39;2021-02-20 00:00:00+00:00&#39;,</span>
</span><span id=__span-61-9><a id=__codelineno-61-9 name=__codelineno-61-9 href=#__codelineno-61-9></a><span class=go>               ...</span>
</span><span id=__span-61-10><a id=__codelineno-61-10 name=__codelineno-61-10 href=#__codelineno-61-10></a><span class=go>               &#39;2021-11-17 00:00:00+00:00&#39;, &#39;2021-11-27 00:00:00+00:00&#39;,</span>
</span><span id=__span-61-11><a id=__codelineno-61-11 name=__codelineno-61-11 href=#__codelineno-61-11></a><span class=go>               &#39;2021-12-07 00:00:00+00:00&#39;, &#39;2021-12-17 00:00:00+00:00&#39;,</span>
</span><span id=__span-61-12><a id=__codelineno-61-12 name=__codelineno-61-12 href=#__codelineno-61-12></a><span class=go>               &#39;2021-12-27 00:00:00+00:00&#39;],</span>
</span><span id=__span-61-13><a id=__codelineno-61-13 name=__codelineno-61-13 href=#__codelineno-61-13></a><span class=go>              dtype=&#39;datetime64[ns, UTC]&#39;, name=&#39;Open time&#39;, freq=None)</span>
</span></code></pre></div> <ol> <li>Use <a href=https://vectorbt.pro/pvt_41531c19/api/signals/accessors/#vectorbtpro.signals.accessors.SignalsAccessor.first>SignalsAccessor.first</a> to select the first <code>True</code> value in each partition.</li> <li>Reset the partition when an exit signal is found.</li> <li>The partition may contain <code>False</code> values.</li> </ol> <p>After this step, each exit is guaranteed to occur after the entry it was generated for.</p> <h3 id=both>Both<a class=headerlink href=#both title="Permanent link">&para;</a></h3> <p>Instead of generating entry and exit signals separately, we can merge them. This approach is especially useful when an exit depends on an entry and an entry also depends on an exit. This kind of logic can be implemented using the Numba-compiled function <a href=https://vectorbt.pro/pvt_41531c19/api/signals/nb/#vectorbtpro.signals.nb.generate_enex_nb>generate_enex_nb</a> and its accessor class method <a href=https://vectorbt.pro/pvt_41531c19/api/signals/accessors/#vectorbtpro.signals.accessors.SignalsAccessor.generate_both>SignalsAccessor.generate_both</a>. The generation process works as follows: first, two empty output masks are created for entries and exits. Then, for each column, the entry placement function is called to generate one or more entry signals. The generator then finds the position of the last generated entry signal and calls the exit placement function on the segment that follows that entry. Next, the entry placement function runs again. This cycle repeats until the column is completely traversed. The provided context is of type <a href=https://vectorbt.pro/pvt_41531c19/api/signals/enums/#vectorbtpro.signals.enums.GenEnExContext>GenEnExContext</a> and includes all relevant information for the current turn and iteration.</p> <p>Let's demonstrate the full capability of this method by placing an entry when the price falls below one threshold, and an exit when the price rises above another threshold. The signals are generated strictly one after another, and both the entry and exit prices are set to the close price.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-62-1><a id=__codelineno-62-1 name=__codelineno-62-1 href=#__codelineno-62-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-62-2><a id=__codelineno-62-2 name=__codelineno-62-2 href=#__codelineno-62-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>entry_place_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span> <span class=n>close</span><span class=p>,</span> <span class=n>th</span><span class=p>):</span>
</span><span id=__span-62-3><a id=__codelineno-62-3 name=__codelineno-62-3 href=#__codelineno-62-3></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>from_i</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>  <span class=c1># (1)!</span>
</span><span id=__span-62-4><a id=__codelineno-62-4 name=__codelineno-62-4 href=#__codelineno-62-4></a><span class=gp>... </span>        <span class=n>c</span><span class=o>.</span><span class=n>out</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-62-5><a id=__codelineno-62-5 name=__codelineno-62-5 href=#__codelineno-62-5></a><span class=gp>... </span>        <span class=k>return</span> <span class=mi>0</span>
</span><span id=__span-62-6><a id=__codelineno-62-6 name=__codelineno-62-6 href=#__codelineno-62-6></a><span class=gp>... </span>    <span class=n>exit_i</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>from_i</span> <span class=o>-</span> <span class=n>c</span><span class=o>.</span><span class=n>wait</span>  <span class=c1># (2)!</span>
</span><span id=__span-62-7><a id=__codelineno-62-7 name=__codelineno-62-7 href=#__codelineno-62-7></a><span class=gp>... </span>    <span class=n>exit_price</span> <span class=o>=</span> <span class=n>close</span><span class=p>[</span><span class=n>exit_i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>  <span class=c1># (3)!</span>
</span><span id=__span-62-8><a id=__codelineno-62-8 name=__codelineno-62-8 href=#__codelineno-62-8></a><span class=gp>... </span>    <span class=n>hit_price</span> <span class=o>=</span> <span class=n>exit_price</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>th</span><span class=p>)</span>
</span><span id=__span-62-9><a id=__codelineno-62-9 name=__codelineno-62-9 href=#__codelineno-62-9></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>out_i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>out</span><span class=p>)):</span>
</span><span id=__span-62-10><a id=__codelineno-62-10 name=__codelineno-62-10 href=#__codelineno-62-10></a><span class=gp>... </span>        <span class=n>i</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>from_i</span> <span class=o>+</span> <span class=n>out_i</span>
</span><span id=__span-62-11><a id=__codelineno-62-11 name=__codelineno-62-11 href=#__codelineno-62-11></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>low</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>hit_price</span><span class=p>:</span>  <span class=c1># (4)!</span>
</span><span id=__span-62-12><a id=__codelineno-62-12 name=__codelineno-62-12 href=#__codelineno-62-12></a><span class=gp>... </span>            <span class=k>return</span> <span class=n>out_i</span>
</span><span id=__span-62-13><a id=__codelineno-62-13 name=__codelineno-62-13 href=#__codelineno-62-13></a><span class=gp>... </span>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span>
</span><span id=__span-62-14><a id=__codelineno-62-14 name=__codelineno-62-14 href=#__codelineno-62-14></a>
</span><span id=__span-62-15><a id=__codelineno-62-15 name=__codelineno-62-15 href=#__codelineno-62-15></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-62-16><a id=__codelineno-62-16 name=__codelineno-62-16 href=#__codelineno-62-16></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>exit_place_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>high</span><span class=p>,</span> <span class=n>close</span><span class=p>,</span> <span class=n>th</span><span class=p>):</span>  <span class=c1># (5)!</span>
</span><span id=__span-62-17><a id=__codelineno-62-17 name=__codelineno-62-17 href=#__codelineno-62-17></a><span class=gp>... </span>    <span class=n>entry_i</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>from_i</span> <span class=o>-</span> <span class=n>c</span><span class=o>.</span><span class=n>wait</span>
</span><span id=__span-62-18><a id=__codelineno-62-18 name=__codelineno-62-18 href=#__codelineno-62-18></a><span class=gp>... </span>    <span class=n>entry_price</span> <span class=o>=</span> <span class=n>close</span><span class=p>[</span><span class=n>entry_i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-62-19><a id=__codelineno-62-19 name=__codelineno-62-19 href=#__codelineno-62-19></a><span class=gp>... </span>    <span class=n>hit_price</span> <span class=o>=</span> <span class=n>entry_price</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>th</span><span class=p>)</span>
</span><span id=__span-62-20><a id=__codelineno-62-20 name=__codelineno-62-20 href=#__codelineno-62-20></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>out_i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>out</span><span class=p>)):</span>
</span><span id=__span-62-21><a id=__codelineno-62-21 name=__codelineno-62-21 href=#__codelineno-62-21></a><span class=gp>... </span>        <span class=n>i</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>from_i</span> <span class=o>+</span> <span class=n>out_i</span>
</span><span id=__span-62-22><a id=__codelineno-62-22 name=__codelineno-62-22 href=#__codelineno-62-22></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>high</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>hit_price</span><span class=p>:</span>
</span><span id=__span-62-23><a id=__codelineno-62-23 name=__codelineno-62-23 href=#__codelineno-62-23></a><span class=gp>... </span>            <span class=k>return</span> <span class=n>out_i</span>
</span><span id=__span-62-24><a id=__codelineno-62-24 name=__codelineno-62-24 href=#__codelineno-62-24></a><span class=gp>... </span>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span>
</span><span id=__span-62-25><a id=__codelineno-62-25 name=__codelineno-62-25 href=#__codelineno-62-25></a>
</span><span id=__span-62-26><a id=__codelineno-62-26 name=__codelineno-62-26 href=#__codelineno-62-26></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entries</span><span class=p>,</span> <span class=n>exits</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pd_acc</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>generate_both</span><span class=p>(</span>  <span class=c1># (6)!</span>
</span><span id=__span-62-27><a id=__codelineno-62-27 name=__codelineno-62-27 href=#__codelineno-62-27></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span>
</span><span id=__span-62-28><a id=__codelineno-62-28 name=__codelineno-62-28 href=#__codelineno-62-28></a><span class=gp>... </span>    <span class=n>entry_place_func_nb</span><span class=o>=</span><span class=n>entry_place_func_nb</span><span class=p>,</span>
</span><span id=__span-62-29><a id=__codelineno-62-29 name=__codelineno-62-29 href=#__codelineno-62-29></a><span class=gp>... </span>    <span class=n>entry_place_args</span><span class=o>=</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;low&quot;</span><span class=p>),</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;close&quot;</span><span class=p>),</span> <span class=mf>0.1</span><span class=p>),</span>  <span class=c1># (7)!</span>
</span><span id=__span-62-30><a id=__codelineno-62-30 name=__codelineno-62-30 href=#__codelineno-62-30></a><span class=gp>... </span>    <span class=n>exit_place_func_nb</span><span class=o>=</span><span class=n>exit_place_func_nb</span><span class=p>,</span>
</span><span id=__span-62-31><a id=__codelineno-62-31 name=__codelineno-62-31 href=#__codelineno-62-31></a><span class=gp>... </span>    <span class=n>exit_place_args</span><span class=o>=</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;high&quot;</span><span class=p>),</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;close&quot;</span><span class=p>),</span> <span class=mf>0.2</span><span class=p>),</span>
</span><span id=__span-62-32><a id=__codelineno-62-32 name=__codelineno-62-32 href=#__codelineno-62-32></a><span class=gp>... </span>    <span class=n>wrapper</span><span class=o>=</span><span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-62-33><a id=__codelineno-62-33 name=__codelineno-62-33 href=#__codelineno-62-33></a><span class=gp>... </span>    <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>  <span class=c1># (8)!</span>
</span><span id=__span-62-34><a id=__codelineno-62-34 name=__codelineno-62-34 href=#__codelineno-62-34></a><span class=gp>... </span>        <span class=n>high</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;High&quot;</span><span class=p>),</span>
</span><span id=__span-62-35><a id=__codelineno-62-35 name=__codelineno-62-35 href=#__codelineno-62-35></a><span class=gp>... </span>        <span class=n>low</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>),</span>
</span><span id=__span-62-36><a id=__codelineno-62-36 name=__codelineno-62-36 href=#__codelineno-62-36></a><span class=gp>... </span>        <span class=n>close</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span>
</span><span id=__span-62-37><a id=__codelineno-62-37 name=__codelineno-62-37 href=#__codelineno-62-37></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-62-38><a id=__codelineno-62-38 name=__codelineno-62-38 href=#__codelineno-62-38></a><span class=gp>... </span>    <span class=n>broadcast_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>post_func</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>)</span>  <span class=c1># (9)!</span>
</span><span id=__span-62-39><a id=__codelineno-62-39 name=__codelineno-62-39 href=#__codelineno-62-39></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-62-40><a id=__codelineno-62-40 name=__codelineno-62-40 href=#__codelineno-62-40></a>
</span><span id=__span-62-41><a id=__codelineno-62-41 name=__codelineno-62-41 href=#__codelineno-62-41></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span>
</span><span id=__span-62-42><a id=__codelineno-62-42 name=__codelineno-62-42 href=#__codelineno-62-42></a><span class=gp>... </span>    <span class=n>symbol</span><span class=o>=</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>,</span> 
</span><span id=__span-62-43><a id=__codelineno-62-43 name=__codelineno-62-43 href=#__codelineno-62-43></a><span class=gp>... </span>    <span class=n>ohlc_trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>opacity</span><span class=o>=</span><span class=mf>0.5</span><span class=p>),</span> 
</span><span id=__span-62-44><a id=__codelineno-62-44 name=__codelineno-62-44 href=#__codelineno-62-44></a><span class=gp>... </span>    <span class=n>plot_volume</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-62-45><a id=__codelineno-62-45 name=__codelineno-62-45 href=#__codelineno-62-45></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-62-46><a id=__codelineno-62-46 name=__codelineno-62-46 href=#__codelineno-62-46></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entries</span><span class=p>[</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>plot_as_entries</span><span class=p>(</span>
</span><span id=__span-62-47><a id=__codelineno-62-47 name=__codelineno-62-47 href=#__codelineno-62-47></a><span class=gp>... </span>    <span class=n>y</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>,</span> <span class=s2>&quot;BTCUSDT&quot;</span><span class=p>),</span> <span class=n>fig</span><span class=o>=</span><span class=n>fig</span><span class=p>)</span>
</span><span id=__span-62-48><a id=__codelineno-62-48 name=__codelineno-62-48 href=#__codelineno-62-48></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span><span class=p>[</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>plot_as_exits</span><span class=p>(</span>
</span><span id=__span-62-49><a id=__codelineno-62-49 name=__codelineno-62-49 href=#__codelineno-62-49></a><span class=gp>... </span>    <span class=n>y</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>,</span> <span class=s2>&quot;BTCUSDT&quot;</span><span class=p>),</span> <span class=n>fig</span><span class=o>=</span><span class=n>fig</span><span class=p>)</span>
</span><span id=__span-62-50><a id=__codelineno-62-50 name=__codelineno-62-50 href=#__codelineno-62-50></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>  <span class=c1># (10)!</span>
</span></code></pre></div> <ol> <li>Place the first entry signal at the initial timestamp, since there is no previous signal for the threshold comparison.</li> <li>Find the (global) index of the most recent opposite signal using <code>c.from_i - c.wait</code>.</li> <li>Apply the percentage threshold to the initial close price.</li> <li>Place an entry signal if the low price falls below the threshold.</li> <li>For the exit placement function, note two key differences: an exit is guaranteed to have a preceding entry, and the threshold is now above the entry close price and must be crossed upward by the high price.</li> <li>The accessor method is a class method, as it does not depend on any existing array and only requires the target shape.</li> <li>Distribute three price arrays across two functions: high, low, and close. Use VBT's <a href=https://vectorbt.pro/pvt_41531c19/api/utils/template/#vectorbtpro.utils.template.Rep>Rep</a> template to substitute names with their broadcasted arrays.</li> <li>Broadcast all arrays to match the target shape.</li> <li>Make sure to convert the broadcasted arrays to NumPy.</li> <li>Plot the OHLC price data, entries, and exits. Set the OHLC chart to be more transparent so the signals are easier to see.</li> </ol> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/signal-dev/both.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/signal-dev/both.dark.svg#only-dark></p> <p>To parameterize this logic, use <code>FactoryMode.Both</code> as the mode. Since the functions require input arrays that broadcast to the input shape, VBT will not require you to provide the input shape, as it will automatically determine it from the input arrays:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-63-1><a id=__codelineno-63-1 name=__codelineno-63-1 href=#__codelineno-63-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>BothGenerator</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>SignalFactory</span><span class=p>(</span>
</span><span id=__span-63-2><a id=__codelineno-63-2 name=__codelineno-63-2 href=#__codelineno-63-2></a><span class=gp>... </span>    <span class=n>mode</span><span class=o>=</span><span class=s2>&quot;both&quot;</span><span class=p>,</span>
</span><span id=__span-63-3><a id=__codelineno-63-3 name=__codelineno-63-3 href=#__codelineno-63-3></a><span class=gp>... </span>    <span class=n>input_names</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;high&quot;</span><span class=p>,</span> <span class=s2>&quot;low&quot;</span><span class=p>,</span> <span class=s2>&quot;close&quot;</span><span class=p>],</span>
</span><span id=__span-63-4><a id=__codelineno-63-4 name=__codelineno-63-4 href=#__codelineno-63-4></a><span class=gp>... </span>    <span class=n>param_names</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;entry_th&quot;</span><span class=p>,</span> <span class=s2>&quot;exit_th&quot;</span><span class=p>]</span>
</span><span id=__span-63-5><a id=__codelineno-63-5 name=__codelineno-63-5 href=#__codelineno-63-5></a><span class=gp>... </span><span class=p>)</span><span class=o>.</span><span class=n>with_place_func</span><span class=p>(</span>
</span><span id=__span-63-6><a id=__codelineno-63-6 name=__codelineno-63-6 href=#__codelineno-63-6></a><span class=gp>... </span>    <span class=n>entry_place_func_nb</span><span class=o>=</span><span class=n>entry_place_func_nb</span><span class=p>,</span>
</span><span id=__span-63-7><a id=__codelineno-63-7 name=__codelineno-63-7 href=#__codelineno-63-7></a><span class=gp>... </span>    <span class=n>entry_settings</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-63-8><a id=__codelineno-63-8 name=__codelineno-63-8 href=#__codelineno-63-8></a><span class=gp>... </span>        <span class=n>pass_inputs</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;low&quot;</span><span class=p>,</span> <span class=s2>&quot;close&quot;</span><span class=p>],</span>
</span><span id=__span-63-9><a id=__codelineno-63-9 name=__codelineno-63-9 href=#__codelineno-63-9></a><span class=gp>... </span>        <span class=n>pass_params</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;entry_th&quot;</span><span class=p>],</span>
</span><span id=__span-63-10><a id=__codelineno-63-10 name=__codelineno-63-10 href=#__codelineno-63-10></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-63-11><a id=__codelineno-63-11 name=__codelineno-63-11 href=#__codelineno-63-11></a><span class=gp>... </span>    <span class=n>exit_place_func_nb</span><span class=o>=</span><span class=n>exit_place_func_nb</span><span class=p>,</span>
</span><span id=__span-63-12><a id=__codelineno-63-12 name=__codelineno-63-12 href=#__codelineno-63-12></a><span class=gp>... </span>    <span class=n>exit_settings</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-63-13><a id=__codelineno-63-13 name=__codelineno-63-13 href=#__codelineno-63-13></a><span class=gp>... </span>        <span class=n>pass_inputs</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;high&quot;</span><span class=p>,</span> <span class=s2>&quot;close&quot;</span><span class=p>],</span>
</span><span id=__span-63-14><a id=__codelineno-63-14 name=__codelineno-63-14 href=#__codelineno-63-14></a><span class=gp>... </span>        <span class=n>pass_params</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;exit_th&quot;</span><span class=p>],</span>
</span><span id=__span-63-15><a id=__codelineno-63-15 name=__codelineno-63-15 href=#__codelineno-63-15></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-63-16><a id=__codelineno-63-16 name=__codelineno-63-16 href=#__codelineno-63-16></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-63-17><a id=__codelineno-63-17 name=__codelineno-63-17 href=#__codelineno-63-17></a><span class=gp>&gt;&gt;&gt; </span><span class=n>both_generator</span> <span class=o>=</span> <span class=n>BothGenerator</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span><span id=__span-63-18><a id=__codelineno-63-18 name=__codelineno-63-18 href=#__codelineno-63-18></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;High&quot;</span><span class=p>),</span>
</span><span id=__span-63-19><a id=__codelineno-63-19 name=__codelineno-63-19 href=#__codelineno-63-19></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>),</span>
</span><span id=__span-63-20><a id=__codelineno-63-20 name=__codelineno-63-20 href=#__codelineno-63-20></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>),</span>
</span><span id=__span-63-21><a id=__codelineno-63-21 name=__codelineno-63-21 href=#__codelineno-63-21></a><span class=gp>... </span>    <span class=p>[</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>],</span>
</span><span id=__span-63-22><a id=__codelineno-63-22 name=__codelineno-63-22 href=#__codelineno-63-22></a><span class=gp>... </span>    <span class=p>[</span><span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>],</span>
</span><span id=__span-63-23><a id=__codelineno-63-23 name=__codelineno-63-23 href=#__codelineno-63-23></a><span class=gp>... </span>    <span class=n>param_product</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-63-24><a id=__codelineno-63-24 name=__codelineno-63-24 href=#__codelineno-63-24></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-63-25><a id=__codelineno-63-25 name=__codelineno-63-25 href=#__codelineno-63-25></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span>
</span><span id=__span-63-26><a id=__codelineno-63-26 name=__codelineno-63-26 href=#__codelineno-63-26></a><span class=gp>... </span>    <span class=n>symbol</span><span class=o>=</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>,</span> 
</span><span id=__span-63-27><a id=__codelineno-63-27 name=__codelineno-63-27 href=#__codelineno-63-27></a><span class=gp>... </span>    <span class=n>ohlc_trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>opacity</span><span class=o>=</span><span class=mf>0.5</span><span class=p>),</span> 
</span><span id=__span-63-28><a id=__codelineno-63-28 name=__codelineno-63-28 href=#__codelineno-63-28></a><span class=gp>... </span>    <span class=n>plot_volume</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-63-29><a id=__codelineno-63-29 name=__codelineno-63-29 href=#__codelineno-63-29></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-63-30><a id=__codelineno-63-30 name=__codelineno-63-30 href=#__codelineno-63-30></a><span class=gp>&gt;&gt;&gt; </span><span class=n>both_generator</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span>
</span><span id=__span-63-31><a id=__codelineno-63-31 name=__codelineno-63-31 href=#__codelineno-63-31></a><span class=gp>... </span>    <span class=n>column</span><span class=o>=</span><span class=p>(</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>,</span> <span class=s2>&quot;BTCUSDT&quot;</span><span class=p>),</span> 
</span><span id=__span-63-32><a id=__codelineno-63-32 name=__codelineno-63-32 href=#__codelineno-63-32></a><span class=gp>... </span>    <span class=n>entry_y</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>,</span> <span class=s2>&quot;BTCUSDT&quot;</span><span class=p>),</span> 
</span><span id=__span-63-33><a id=__codelineno-63-33 name=__codelineno-63-33 href=#__codelineno-63-33></a><span class=gp>... </span>    <span class=n>exit_y</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>,</span> <span class=s2>&quot;BTCUSDT&quot;</span><span class=p>),</span> 
</span><span id=__span-63-34><a id=__codelineno-63-34 name=__codelineno-63-34 href=#__codelineno-63-34></a><span class=gp>... </span>    <span class=n>fig</span><span class=o>=</span><span class=n>fig</span>
</span><span id=__span-63-35><a id=__codelineno-63-35 name=__codelineno-63-35 href=#__codelineno-63-35></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-63-36><a id=__codelineno-63-36 name=__codelineno-63-36 href=#__codelineno-63-36></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/signal-dev/both2.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/signal-dev/both2.dark.svg#only-dark></p> <h3 id=chained-exits>Chained exits<a class=headerlink href=#chained-exits title="Permanent link">&para;</a></h3> <p>In VBT, a chain refers to a special sequence of entry and exit signals where each exit follows exactly one entry, and each entry (except the first one) follows exactly one exit. This structure makes it simple to match each exit to its corresponding entry and vice versa. The previous example is a perfect illustration of a chain, as each signal from threshold crossing depends only on the most recent opposite signal. Now, suppose you have already generated an array of entries, and each of those entries should be valid only if there was a prior exit. Otherwise, the entry should be ignored. This scenario is very similar to using <code>FactoryMode.Exits</code> with <code>skip_until_exit</code> enabled and <code>until_next</code> disabled.</p> <p>However, the <code>FactoryMode.Chain</code> mode offers the following: it uses the <a href=https://vectorbt.pro/pvt_41531c19/api/signals/nb/#vectorbtpro.signals.nb.generate_enex_nb>generate_enex_nb</a> generator with the entry placement function <a href=https://vectorbt.pro/pvt_41531c19/api/signals/nb/#vectorbtpro.signals.nb.first_place_nb>first_place_nb</a> to select only the first entry signal after each exit, along with any custom exit placement function. At the end, you receive two arrays: cleaned entries (often called <code>new_entries</code>) and exits (<code>exits</code>).</p> <p>It is important to note that entries and exits generated during the signal generation phase do not need to be used as entries and exits for simulation. For example, you might generate entry signals from a moving average crossover, where each signal mimics a limit order, and use an exit placement function to generate signals for filling those limit orders. As a result, these newly generated signals can be used as actual entries in your simulation. If a new "entry" signal occurs before the previous "exit" signal, it will be ignored. You can also track the fill price with another array.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-64-1><a id=__codelineno-64-1 name=__codelineno-64-1 href=#__codelineno-64-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-64-2><a id=__codelineno-64-2 name=__codelineno-64-2 href=#__codelineno-64-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>exit_place_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span> <span class=n>request_price</span><span class=p>,</span> <span class=n>fill_price_out</span><span class=p>):</span>
</span><span id=__span-64-3><a id=__codelineno-64-3 name=__codelineno-64-3 href=#__codelineno-64-3></a><span class=gp>... </span>    <span class=n>entry_req_price</span> <span class=o>=</span> <span class=n>request_price</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>from_i</span> <span class=o>-</span> <span class=n>c</span><span class=o>.</span><span class=n>wait</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>  <span class=c1># (1)!</span>
</span><span id=__span-64-4><a id=__codelineno-64-4 name=__codelineno-64-4 href=#__codelineno-64-4></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>out_i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>out</span><span class=p>)):</span>
</span><span id=__span-64-5><a id=__codelineno-64-5 name=__codelineno-64-5 href=#__codelineno-64-5></a><span class=gp>... </span>        <span class=n>i</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>from_i</span> <span class=o>+</span> <span class=n>out_i</span>
</span><span id=__span-64-6><a id=__codelineno-64-6 name=__codelineno-64-6 href=#__codelineno-64-6></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>low</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>entry_req_price</span><span class=p>:</span>  <span class=c1># (2)!</span>
</span><span id=__span-64-7><a id=__codelineno-64-7 name=__codelineno-64-7 href=#__codelineno-64-7></a><span class=gp>... </span>            <span class=n>fill_price_out</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>entry_req_price</span>
</span><span id=__span-64-8><a id=__codelineno-64-8 name=__codelineno-64-8 href=#__codelineno-64-8></a><span class=gp>... </span>            <span class=k>return</span> <span class=n>out_i</span>
</span><span id=__span-64-9><a id=__codelineno-64-9 name=__codelineno-64-9 href=#__codelineno-64-9></a><span class=gp>... </span>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span>
</span><span id=__span-64-10><a id=__codelineno-64-10 name=__codelineno-64-10 href=#__codelineno-64-10></a>
</span><span id=__span-64-11><a id=__codelineno-64-11 name=__codelineno-64-11 href=#__codelineno-64-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>ChainGenerator</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>SignalFactory</span><span class=p>(</span>
</span><span id=__span-64-12><a id=__codelineno-64-12 name=__codelineno-64-12 href=#__codelineno-64-12></a><span class=gp>... </span>    <span class=n>mode</span><span class=o>=</span><span class=s2>&quot;chain&quot;</span><span class=p>,</span>
</span><span id=__span-64-13><a id=__codelineno-64-13 name=__codelineno-64-13 href=#__codelineno-64-13></a><span class=gp>... </span>    <span class=n>input_names</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;low&quot;</span><span class=p>,</span> <span class=s2>&quot;request_price&quot;</span><span class=p>],</span>
</span><span id=__span-64-14><a id=__codelineno-64-14 name=__codelineno-64-14 href=#__codelineno-64-14></a><span class=gp>... </span>    <span class=n>in_output_names</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;fill_price_out&quot;</span><span class=p>]</span>
</span><span id=__span-64-15><a id=__codelineno-64-15 name=__codelineno-64-15 href=#__codelineno-64-15></a><span class=gp>... </span><span class=p>)</span><span class=o>.</span><span class=n>with_place_func</span><span class=p>(</span>  <span class=c1># (3)!</span>
</span><span id=__span-64-16><a id=__codelineno-64-16 name=__codelineno-64-16 href=#__codelineno-64-16></a><span class=gp>... </span>    <span class=n>exit_place_func_nb</span><span class=o>=</span><span class=n>exit_place_func_nb</span><span class=p>,</span>
</span><span id=__span-64-17><a id=__codelineno-64-17 name=__codelineno-64-17 href=#__codelineno-64-17></a><span class=gp>... </span>    <span class=n>exit_settings</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-64-18><a id=__codelineno-64-18 name=__codelineno-64-18 href=#__codelineno-64-18></a><span class=gp>... </span>        <span class=n>pass_inputs</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;low&quot;</span><span class=p>,</span> <span class=s2>&quot;request_price&quot;</span><span class=p>],</span>
</span><span id=__span-64-19><a id=__codelineno-64-19 name=__codelineno-64-19 href=#__codelineno-64-19></a><span class=gp>... </span>        <span class=n>pass_in_outputs</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;fill_price_out&quot;</span><span class=p>],</span>
</span><span id=__span-64-20><a id=__codelineno-64-20 name=__codelineno-64-20 href=#__codelineno-64-20></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-64-21><a id=__codelineno-64-21 name=__codelineno-64-21 href=#__codelineno-64-21></a><span class=gp>... </span>    <span class=n>fill_price_out</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span>  <span class=c1># (4)!</span>
</span><span id=__span-64-22><a id=__codelineno-64-22 name=__codelineno-64-22 href=#__codelineno-64-22></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-64-23><a id=__codelineno-64-23 name=__codelineno-64-23 href=#__codelineno-64-23></a>
</span><span id=__span-64-24><a id=__codelineno-64-24 name=__codelineno-64-24 href=#__codelineno-64-24></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fast_ma</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>talib</span><span class=p>(</span><span class=s2>&quot;SMA&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span><span id=__span-64-25><a id=__codelineno-64-25 name=__codelineno-64-25 href=#__codelineno-64-25></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>),</span> 
</span><span id=__span-64-26><a id=__codelineno-64-26 name=__codelineno-64-26 href=#__codelineno-64-26></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>Default</span><span class=p>(</span><span class=mi>10</span><span class=p>),</span> 
</span><span id=__span-64-27><a id=__codelineno-64-27 name=__codelineno-64-27 href=#__codelineno-64-27></a><span class=gp>... </span>    <span class=n>short_name</span><span class=o>=</span><span class=s2>&quot;fast_ma&quot;</span>
</span><span id=__span-64-28><a id=__codelineno-64-28 name=__codelineno-64-28 href=#__codelineno-64-28></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-64-29><a id=__codelineno-64-29 name=__codelineno-64-29 href=#__codelineno-64-29></a><span class=gp>&gt;&gt;&gt; </span><span class=n>slow_ma</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>talib</span><span class=p>(</span><span class=s2>&quot;SMA&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span><span id=__span-64-30><a id=__codelineno-64-30 name=__codelineno-64-30 href=#__codelineno-64-30></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>),</span> 
</span><span id=__span-64-31><a id=__codelineno-64-31 name=__codelineno-64-31 href=#__codelineno-64-31></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>Default</span><span class=p>(</span><span class=mi>20</span><span class=p>),</span> 
</span><span id=__span-64-32><a id=__codelineno-64-32 name=__codelineno-64-32 href=#__codelineno-64-32></a><span class=gp>... </span>    <span class=n>short_name</span><span class=o>=</span><span class=s2>&quot;slow_ma&quot;</span>
</span><span id=__span-64-33><a id=__codelineno-64-33 name=__codelineno-64-33 href=#__codelineno-64-33></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-64-34><a id=__codelineno-64-34 name=__codelineno-64-34 href=#__codelineno-64-34></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entries</span> <span class=o>=</span> <span class=n>fast_ma</span><span class=o>.</span><span class=n>real_crossed_above</span><span class=p>(</span><span class=n>slow_ma</span><span class=p>)</span>  <span class=c1># (5)!</span>
</span><span id=__span-64-35><a id=__codelineno-64-35 name=__codelineno-64-35 href=#__codelineno-64-35></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entries</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-64-36><a id=__codelineno-64-36 name=__codelineno-64-36 href=#__codelineno-64-36></a><span class=go>symbol</span>
</span><span id=__span-64-37><a id=__codelineno-64-37 name=__codelineno-64-37 href=#__codelineno-64-37></a><span class=go>BTCUSDT    10</span>
</span><span id=__span-64-38><a id=__codelineno-64-38 name=__codelineno-64-38 href=#__codelineno-64-38></a><span class=go>ETHUSDT     8</span>
</span><span id=__span-64-39><a id=__codelineno-64-39 name=__codelineno-64-39 href=#__codelineno-64-39></a><span class=go>dtype: int64</span>
</span><span id=__span-64-40><a id=__codelineno-64-40 name=__codelineno-64-40 href=#__codelineno-64-40></a>
</span><span id=__span-64-41><a id=__codelineno-64-41 name=__codelineno-64-41 href=#__codelineno-64-41></a><span class=gp>&gt;&gt;&gt; </span><span class=n>chain_generator</span> <span class=o>=</span> <span class=n>ChainGenerator</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span><span id=__span-64-42><a id=__codelineno-64-42 name=__codelineno-64-42 href=#__codelineno-64-42></a><span class=gp>... </span>    <span class=n>entries</span><span class=p>,</span>
</span><span id=__span-64-43><a id=__codelineno-64-43 name=__codelineno-64-43 href=#__codelineno-64-43></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>),</span>
</span><span id=__span-64-44><a id=__codelineno-64-44 name=__codelineno-64-44 href=#__codelineno-64-44></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=mf>0.1</span><span class=p>)</span>  <span class=c1># (6)!</span>
</span><span id=__span-64-45><a id=__codelineno-64-45 name=__codelineno-64-45 href=#__codelineno-64-45></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-64-46><a id=__codelineno-64-46 name=__codelineno-64-46 href=#__codelineno-64-46></a><span class=gp>&gt;&gt;&gt; </span><span class=n>request_mask</span> <span class=o>=</span> <span class=n>chain_generator</span><span class=o>.</span><span class=n>new_entries</span>  <span class=c1># (7)!</span>
</span><span id=__span-64-47><a id=__codelineno-64-47 name=__codelineno-64-47 href=#__codelineno-64-47></a><span class=gp>&gt;&gt;&gt; </span><span class=n>request_mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-64-48><a id=__codelineno-64-48 name=__codelineno-64-48 href=#__codelineno-64-48></a><span class=go>symbol</span>
</span><span id=__span-64-49><a id=__codelineno-64-49 name=__codelineno-64-49 href=#__codelineno-64-49></a><span class=go>BTCUSDT    4</span>
</span><span id=__span-64-50><a id=__codelineno-64-50 name=__codelineno-64-50 href=#__codelineno-64-50></a><span class=go>ETHUSDT    5</span>
</span><span id=__span-64-51><a id=__codelineno-64-51 name=__codelineno-64-51 href=#__codelineno-64-51></a><span class=go>dtype: int64</span>
</span><span id=__span-64-52><a id=__codelineno-64-52 name=__codelineno-64-52 href=#__codelineno-64-52></a>
</span><span id=__span-64-53><a id=__codelineno-64-53 name=__codelineno-64-53 href=#__codelineno-64-53></a><span class=gp>&gt;&gt;&gt; </span><span class=n>request_price</span> <span class=o>=</span> <span class=n>chain_generator</span><span class=o>.</span><span class=n>request_price</span>  <span class=c1># (8)!</span>
</span><span id=__span-64-54><a id=__codelineno-64-54 name=__codelineno-64-54 href=#__codelineno-64-54></a><span class=gp>&gt;&gt;&gt; </span><span class=n>request_price</span><span class=p>[</span><span class=n>request_mask</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)]</span>
</span><span id=__span-64-55><a id=__codelineno-64-55 name=__codelineno-64-55 href=#__codelineno-64-55></a><span class=go>symbol                       BTCUSDT   ETHUSDT</span>
</span><span id=__span-64-56><a id=__codelineno-64-56 name=__codelineno-64-56 href=#__codelineno-64-56></a><span class=go>Open time                                     </span>
</span><span id=__span-64-57><a id=__codelineno-64-57 name=__codelineno-64-57 href=#__codelineno-64-57></a><span class=go>2021-02-04 00:00:00+00:00  33242.994  1436.103</span>
</span><span id=__span-64-58><a id=__codelineno-64-58 name=__codelineno-64-58 href=#__codelineno-64-58></a><span class=go>2021-03-11 00:00:00+00:00  51995.844  1643.202</span>
</span><span id=__span-64-59><a id=__codelineno-64-59 name=__codelineno-64-59 href=#__codelineno-64-59></a><span class=go>2021-04-02 00:00:00+00:00  53055.009  1920.321</span>
</span><span id=__span-64-60><a id=__codelineno-64-60 name=__codelineno-64-60 href=#__codelineno-64-60></a><span class=go>2021-06-07 00:00:00+00:00  30197.511  2332.845</span>
</span><span id=__span-64-61><a id=__codelineno-64-61 name=__codelineno-64-61 href=#__codelineno-64-61></a><span class=go>2021-06-15 00:00:00+00:00  36129.636  2289.186</span>
</span><span id=__span-64-62><a id=__codelineno-64-62 name=__codelineno-64-62 href=#__codelineno-64-62></a><span class=go>2021-07-05 00:00:00+00:00  30321.126  1976.877</span>
</span><span id=__span-64-63><a id=__codelineno-64-63 name=__codelineno-64-63 href=#__codelineno-64-63></a><span class=go>2021-07-06 00:00:00+00:00  30798.009  2090.250</span>
</span><span id=__span-64-64><a id=__codelineno-64-64 name=__codelineno-64-64 href=#__codelineno-64-64></a><span class=go>2021-07-27 00:00:00+00:00  35512.083  2069.541</span>
</span><span id=__span-64-65><a id=__codelineno-64-65 name=__codelineno-64-65 href=#__codelineno-64-65></a>
</span><span id=__span-64-66><a id=__codelineno-64-66 name=__codelineno-64-66 href=#__codelineno-64-66></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fill_mask</span> <span class=o>=</span> <span class=n>chain_generator</span><span class=o>.</span><span class=n>exits</span>  <span class=c1># (9)!</span>
</span><span id=__span-64-67><a id=__codelineno-64-67 name=__codelineno-64-67 href=#__codelineno-64-67></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fill_mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-64-68><a id=__codelineno-64-68 name=__codelineno-64-68 href=#__codelineno-64-68></a><span class=go>symbol</span>
</span><span id=__span-64-69><a id=__codelineno-64-69 name=__codelineno-64-69 href=#__codelineno-64-69></a><span class=go>BTCUSDT    3</span>
</span><span id=__span-64-70><a id=__codelineno-64-70 name=__codelineno-64-70 href=#__codelineno-64-70></a><span class=go>ETHUSDT    4</span>
</span><span id=__span-64-71><a id=__codelineno-64-71 name=__codelineno-64-71 href=#__codelineno-64-71></a><span class=go>dtype: int64</span>
</span><span id=__span-64-72><a id=__codelineno-64-72 name=__codelineno-64-72 href=#__codelineno-64-72></a>
</span><span id=__span-64-73><a id=__codelineno-64-73 name=__codelineno-64-73 href=#__codelineno-64-73></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fill_price</span> <span class=o>=</span> <span class=n>chain_generator</span><span class=o>.</span><span class=n>fill_price_out</span>  <span class=c1># (10)!</span>
</span><span id=__span-64-74><a id=__codelineno-64-74 name=__codelineno-64-74 href=#__codelineno-64-74></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fill_price</span><span class=p>[</span><span class=n>fill_mask</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)]</span>
</span><span id=__span-64-75><a id=__codelineno-64-75 name=__codelineno-64-75 href=#__codelineno-64-75></a><span class=go>symbol                       BTCUSDT   ETHUSDT</span>
</span><span id=__span-64-76><a id=__codelineno-64-76 name=__codelineno-64-76 href=#__codelineno-64-76></a><span class=go>Open time                                     </span>
</span><span id=__span-64-77><a id=__codelineno-64-77 name=__codelineno-64-77 href=#__codelineno-64-77></a><span class=go>2021-03-24 00:00:00+00:00        NaN  1643.202</span>
</span><span id=__span-64-78><a id=__codelineno-64-78 name=__codelineno-64-78 href=#__codelineno-64-78></a><span class=go>2021-05-19 00:00:00+00:00  33242.994  1920.321</span>
</span><span id=__span-64-79><a id=__codelineno-64-79 name=__codelineno-64-79 href=#__codelineno-64-79></a><span class=go>2021-06-08 00:00:00+00:00        NaN  2332.845</span>
</span><span id=__span-64-80><a id=__codelineno-64-80 name=__codelineno-64-80 href=#__codelineno-64-80></a><span class=go>2021-06-18 00:00:00+00:00  36129.636       NaN</span>
</span><span id=__span-64-81><a id=__codelineno-64-81 name=__codelineno-64-81 href=#__codelineno-64-81></a><span class=go>2021-07-13 00:00:00+00:00        NaN  1976.877</span>
</span><span id=__span-64-82><a id=__codelineno-64-82 name=__codelineno-64-82 href=#__codelineno-64-82></a><span class=go>2021-07-19 00:00:00+00:00  30798.009       NaN</span>
</span></code></pre></div> <ol> <li>Retrieve the limit price assigned at the entry.</li> <li>Check if this price has been reached. If so, record the signal along with the fill price.</li> <li>The entry function and its related settings are automatically populated by VBT.</li> <li>If you do not specify a default, VBT will create the in-place output array using <code>np.empty</code>. If you provide a default, VBT will use <code>np.full</code> to create the array and fill it with the default value. We need the second option because our function does not overwrite every element.</li> <li>Generate a signal array for limit order requests based on moving average crossovers.</li> <li>Use a limit price set at 10% below the close price.</li> <li>New entries contain filtered order request signals. Many signals are ignored because they appear before the previous signal's limit price could be reached.</li> <li>This is the input array used as the limit order price. Use the request mask to obtain the price for each request order.</li> <li>Exits contain signals for orders that have been filled, generated by the exit placement function. Each fill signal matches a corresponding request signal.</li> <li>This output array contains the order fill prices. Use the fill mask to obtain the price for each filled order.</li> </ol> <p>For example, the first limit order for <code>BTCUSDT</code> was requested on <code>2021-02-04</code> and filled on <code>2021-05-19</code>. The first limit order for <code>ETHUSDT</code> was requested on <code>2021-03-11</code> and filled on <code>2021-03-24</code>. To simulate this process, you can pass <code>fill_mask</code> as the entries or order size, and <code>fill_price</code> as the order price.</p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>If you want each new limit order to replace any pending one instead of ignoring pending orders, use <code>FactoryMode.Exits</code> and then select the last input signal before each output signal.</p> </div> <h2 id=preset-generators>Preset generators<a class=headerlink href=#preset-generators title="Permanent link">&para;</a></h2> <p>A wide range of preset signal generators is available <a href=https://vectorbt.pro/pvt_41531c19/api/signals/generators/ >here</a>, which use the modes discussed above. Preset indicators are designed for specific tasks and are ready to use without any need for custom placement functions. Their naming follows a clear convention:</p> <ul> <li>Plain generators have no suffix.</li> <li>Exit generators use the suffix <code>X</code>.</li> <li>Both generators use the suffix <code>NX</code>.</li> <li>Chain exit generators use the suffix <code>CX</code>.</li> </ul> <h3 id=random>Random<a class=headerlink href=#random title="Permanent link">&para;</a></h3> <p>Do you dislike randomness in trading? There is one important case where randomness is actually welcome: trading strategy benchmarking. For example, comparing one RSI configuration to another is not always meaningful, since both strategy instances might be inherently suboptimal. Choosing one could simply mean picking the lesser of two evils. Random signals, however, open up a whole new universe of unexplored strategies. Generating enough random signal permutations on a market can reveal the underlying structure and behavior of that market, and may help determine whether your trading strategy is driven by a true edge or simply by chance.</p> <p>There are two types of random signal generation: count-based and probability-based. The count-based method takes a target number of signals, <code>n</code>, to place within a certain period and guarantees to place this number unless the period is too short. The probability-based method takes a probability, <code>prob</code>, of placing a signal at each timestamp. If the probability is too high, a signal may be placed at every timestamp; if too low, no signals may be placed. Both types can be used with the same accessor methods: <a href=https://vectorbt.pro/pvt_41531c19/api/signals/accessors/#vectorbtpro.signals.accessors.SignalsAccessor.generate_random>SignalsAccessor.generate_random</a> to spread entry signals across an entire column, <a href=https://vectorbt.pro/pvt_41531c19/api/signals/accessors/#vectorbtpro.signals.accessors.SignalsAccessor.generate_random_exits>SignalsAccessor.generate_random_exits</a> to distribute exit signals after each entry and before the next entry, and <a href=https://vectorbt.pro/pvt_41531c19/api/signals/accessors/#vectorbtpro.signals.accessors.SignalsAccessor.generate_random_both>SignalsAccessor.generate_random_both</a> to chain entry and exit signals one after the other.</p> <div class="admonition warning"> <p class=admonition-title>Warning</p> <p>Generating an exact number of signals may introduce look-ahead bias because it involves knowledge of the next opposite signal or the end of the column. Use this with care, and only when the placement of the last signal is predetermined, such as when trading on a per-month basis.</p> </div> <p>Let's generate a signal on average once every 10 timestamps:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-65-1><a id=__codelineno-65-1 name=__codelineno-65-1 href=#__codelineno-65-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>btcusdt_wrapper</span> <span class=o>=</span> <span class=n>symbol_wrapper</span><span class=p>[</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>]</span>
</span><span id=__span-65-2><a id=__codelineno-65-2 name=__codelineno-65-2 href=#__codelineno-65-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pd_acc</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>generate_random</span><span class=p>(</span>
</span><span id=__span-65-3><a id=__codelineno-65-3 name=__codelineno-65-3 href=#__codelineno-65-3></a><span class=gp>... </span>    <span class=n>btcusdt_wrapper</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span>
</span><span id=__span-65-4><a id=__codelineno-65-4 name=__codelineno-65-4 href=#__codelineno-65-4></a><span class=gp>... </span>    <span class=n>prob</span><span class=o>=</span><span class=mi>1</span> <span class=o>/</span> <span class=mi>10</span><span class=p>,</span>
</span><span id=__span-65-5><a id=__codelineno-65-5 name=__codelineno-65-5 href=#__codelineno-65-5></a><span class=gp>... </span>    <span class=n>wrapper</span><span class=o>=</span><span class=n>btcusdt_wrapper</span><span class=p>,</span>
</span><span id=__span-65-6><a id=__codelineno-65-6 name=__codelineno-65-6 href=#__codelineno-65-6></a><span class=gp>... </span>    <span class=n>seed</span><span class=o>=</span><span class=mi>42</span>  <span class=c1># (1)!</span>
</span><span id=__span-65-7><a id=__codelineno-65-7 name=__codelineno-65-7 href=#__codelineno-65-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-65-8><a id=__codelineno-65-8 name=__codelineno-65-8 href=#__codelineno-65-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask_index</span> <span class=o>=</span> <span class=n>mask</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>mask</span><span class=p>]</span>
</span><span id=__span-65-9><a id=__codelineno-65-9 name=__codelineno-65-9 href=#__codelineno-65-9></a><span class=gp>&gt;&gt;&gt; </span><span class=p>(</span><span class=n>mask_index</span><span class=p>[</span><span class=mi>1</span><span class=p>:]</span> <span class=o>-</span> <span class=n>mask_index</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>  <span class=c1># (2)!</span>
</span><span id=__span-65-10><a id=__codelineno-65-10 name=__codelineno-65-10 href=#__codelineno-65-10></a><span class=go>Timedelta(&#39;8 days 03:20:55.813953488&#39;)</span>
</span></code></pre></div> <ol> <li>Make the calculation deterministic.</li> <li>Calculate the average distance between two neighboring signals in the mask.</li> </ol> <div class="admonition note"> <p class=admonition-title>Note</p> <p>The more signals you generate, the closer the average neighbor distance will be to the target average.</p> </div> <p>Now, let's generate exactly one signal each week. To do this, we will generate an "entry" signal on each Monday and an "exit" signal as our target signal. This avoids look-ahead bias because we have already defined the bounds of the generation period.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-66-1><a id=__codelineno-66-1 name=__codelineno-66-1 href=#__codelineno-66-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>monday_mask</span> <span class=o>=</span> <span class=n>btcusdt_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-66-2><a id=__codelineno-66-2 name=__codelineno-66-2 href=#__codelineno-66-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>monday_mask</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>every</span><span class=o>=</span><span class=s2>&quot;monday&quot;</span><span class=p>,</span> <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-66-3><a id=__codelineno-66-3 name=__codelineno-66-3 href=#__codelineno-66-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask</span> <span class=o>=</span> <span class=n>monday_mask</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>generate_random_exits</span><span class=p>(</span><span class=n>wait</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-66-4><a id=__codelineno-66-4 name=__codelineno-66-4 href=#__codelineno-66-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask_index</span> <span class=o>=</span> <span class=n>mask</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>mask</span><span class=p>]</span>
</span><span id=__span-66-5><a id=__codelineno-66-5 name=__codelineno-66-5 href=#__codelineno-66-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>mask_index</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&quot;%W %A&quot;</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-66-6><a id=__codelineno-66-6 name=__codelineno-66-6 href=#__codelineno-66-6></a><span class=go>Index([&#39;01 Tuesday&#39;, &#39;02 Wednesday&#39;, &#39;03 Wednesday&#39;, &#39;04 Friday&#39;, &#39;05 Friday&#39;,</span>
</span><span id=__span-66-7><a id=__codelineno-66-7 name=__codelineno-66-7 href=#__codelineno-66-7></a><span class=go>       &#39;06 Tuesday&#39;, &#39;07 Thursday&#39;, &#39;08 Tuesday&#39;, &#39;09 Friday&#39;, &#39;10 Saturday&#39;,</span>
</span><span id=__span-66-8><a id=__codelineno-66-8 name=__codelineno-66-8 href=#__codelineno-66-8></a><span class=go>       &#39;11 Friday&#39;, &#39;12 Saturday&#39;, &#39;13 Monday&#39;, &#39;14 Friday&#39;, &#39;15 Monday&#39;,</span>
</span><span id=__span-66-9><a id=__codelineno-66-9 name=__codelineno-66-9 href=#__codelineno-66-9></a><span class=go>       ...</span>
</span><span id=__span-66-10><a id=__codelineno-66-10 name=__codelineno-66-10 href=#__codelineno-66-10></a><span class=go>       &#39;41 Wednesday&#39;, &#39;42 Friday&#39;, &#39;43 Thursday&#39;, &#39;44 Sunday&#39;, &#39;45 Sunday&#39;,</span>
</span><span id=__span-66-11><a id=__codelineno-66-11 name=__codelineno-66-11 href=#__codelineno-66-11></a><span class=go>       &#39;46 Sunday&#39;, &#39;47 Saturday&#39;, &#39;48 Saturday&#39;, &#39;49 Tuesday&#39;, &#39;50 Thursday&#39;,</span>
</span><span id=__span-66-12><a id=__codelineno-66-12 name=__codelineno-66-12 href=#__codelineno-66-12></a><span class=go>       &#39;51 Sunday&#39;, &#39;52 Tuesday&#39;],</span>
</span><span id=__span-66-13><a id=__codelineno-66-13 name=__codelineno-66-13 href=#__codelineno-66-13></a><span class=go>      dtype=&#39;object&#39;, name=&#39;Open time&#39;)</span>
</span></code></pre></div> <ol> <li>Set <code>True</code> on each Monday using <a href=https://vectorbt.pro/pvt_41531c19/api/base/accessors/#vectorbtpro.base.accessors.BaseAccessor.set>BaseAccessor.set</a>.</li> <li>Generate exactly one signal after the previous Monday and before the next one. With <code>wait=0</code>, we allow placing a signal immediately after Monday midnight.</li> <li>Print the week number and weekday of each signal.</li> </ol> <p>To parameterize the number of signals and the probability, you can use indicators with the prefixes <code>RAND</code> and <code>RPROB</code>, respectively. A powerful feature of these indicators is that they can accept parameters as array-like objects. This means you can pass <code>n</code> per column and <code>prob</code> per column, per row, or even per element in the target shape.</p> <p>Let's use <a href=https://vectorbt.pro/pvt_41531c19/api/signals/generators/rprob/#vectorbtpro.signals.generators.rprob.RPROB>RPROB</a> to gradually generate more signals over time. We will start with a probability of 0% and end at 100%, placing a signal at each timestamp:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-67-1><a id=__codelineno-67-1 name=__codelineno-67-1 href=#__codelineno-67-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>prob</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>linspace</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>index</span><span class=p>))</span>  <span class=c1># (1)!</span>
</span><span id=__span-67-2><a id=__codelineno-67-2 name=__codelineno-67-2 href=#__codelineno-67-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>rprob</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>RPROB</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span><span id=__span-67-3><a id=__codelineno-67-3 name=__codelineno-67-3 href=#__codelineno-67-3></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-67-4><a id=__codelineno-67-4 name=__codelineno-67-4 href=#__codelineno-67-4></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>Default</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_pr_array</span><span class=p>(</span><span class=n>prob</span><span class=p>)),</span>  <span class=c1># (3)!</span>
</span><span id=__span-67-5><a id=__codelineno-67-5 name=__codelineno-67-5 href=#__codelineno-67-5></a><span class=gp>... </span>    <span class=n>seed</span><span class=o>=</span><span class=mi>42</span><span class=p>,</span>
</span><span id=__span-67-6><a id=__codelineno-67-6 name=__codelineno-67-6 href=#__codelineno-67-6></a><span class=gp>... </span>    <span class=n>input_index</span><span class=o>=</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>index</span><span class=p>,</span>
</span><span id=__span-67-7><a id=__codelineno-67-7 name=__codelineno-67-7 href=#__codelineno-67-7></a><span class=gp>... </span>    <span class=n>input_columns</span><span class=o>=</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>columns</span>
</span><span id=__span-67-8><a id=__codelineno-67-8 name=__codelineno-67-8 href=#__codelineno-67-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-67-9><a id=__codelineno-67-9 name=__codelineno-67-9 href=#__codelineno-67-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>rprob</span><span class=o>.</span><span class=n>entries</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>ts_heatmap</span><span class=p>()</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>  <span class=c1># (4)!</span>
</span></code></pre></div> <ol> <li>Use <a href=https://numpy.org/doc/stable/reference/generated/numpy.linspace.html>numpy.linspace</a> to fill the probability values between 0 and 1.</li> <li>Provide the input shape since the indicator does not take input arrays.</li> <li>Use <a href=https://vectorbt.pro/pvt_41531c19/api/base/reshaping/#vectorbtpro.base.reshaping.to_2d_pr_array>to_2d_pr_array</a> to expand the array to two dimensions so each value matches a row rather than a column (see broadcasting rules). Wrap this with <a href=https://vectorbt.pro/pvt_41531c19/api/base/reshaping/#vectorbtpro.base.reshaping.Default>Default</a> to hide the parameter.</li> <li>Plot the final distribution.</li> </ol> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/signal-dev/rprob.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/signal-dev/rprob.dark.svg#only-dark></p> <p>To try multiple values, you can supply them as a list. Let's show that a fixed probability of 50% yields, on average, the same number of signals as a probability that increases from 0% to 100%, though the distributions are quite different:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-68-1><a id=__codelineno-68-1 name=__codelineno-68-1 href=#__codelineno-68-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>rprob</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>RPROB</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span><span id=__span-68-2><a id=__codelineno-68-2 name=__codelineno-68-2 href=#__codelineno-68-2></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span>
</span><span id=__span-68-3><a id=__codelineno-68-3 name=__codelineno-68-3 href=#__codelineno-68-3></a><span class=gp>... </span>    <span class=p>[</span><span class=mf>0.5</span><span class=p>,</span> <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_pr_array</span><span class=p>(</span><span class=n>prob</span><span class=p>)],</span>
</span><span id=__span-68-4><a id=__codelineno-68-4 name=__codelineno-68-4 href=#__codelineno-68-4></a><span class=gp>... </span>    <span class=n>seed</span><span class=o>=</span><span class=mi>42</span><span class=p>,</span>
</span><span id=__span-68-5><a id=__codelineno-68-5 name=__codelineno-68-5 href=#__codelineno-68-5></a><span class=gp>... </span>    <span class=n>input_index</span><span class=o>=</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>index</span><span class=p>,</span>
</span><span id=__span-68-6><a id=__codelineno-68-6 name=__codelineno-68-6 href=#__codelineno-68-6></a><span class=gp>... </span>    <span class=n>input_columns</span><span class=o>=</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>columns</span>
</span><span id=__span-68-7><a id=__codelineno-68-7 name=__codelineno-68-7 href=#__codelineno-68-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-68-8><a id=__codelineno-68-8 name=__codelineno-68-8 href=#__codelineno-68-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>rprob</span><span class=o>.</span><span class=n>entries</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-68-9><a id=__codelineno-68-9 name=__codelineno-68-9 href=#__codelineno-68-9></a><span class=go>rprob_prob  symbol </span>
</span><span id=__span-68-10><a id=__codelineno-68-10 name=__codelineno-68-10 href=#__codelineno-68-10></a><span class=go>0.5         BTCUSDT    176</span>
</span><span id=__span-68-11><a id=__codelineno-68-11 name=__codelineno-68-11 href=#__codelineno-68-11></a><span class=go>            ETHUSDT    187</span>
</span><span id=__span-68-12><a id=__codelineno-68-12 name=__codelineno-68-12 href=#__codelineno-68-12></a><span class=go>array_0     BTCUSDT    183</span>
</span><span id=__span-68-13><a id=__codelineno-68-13 name=__codelineno-68-13 href=#__codelineno-68-13></a><span class=go>            ETHUSDT    178</span>
</span><span id=__span-68-14><a id=__codelineno-68-14 name=__codelineno-68-14 href=#__codelineno-68-14></a><span class=go>dtype: int64</span>
</span></code></pre></div> <h3 id=stops>Stops<a class=headerlink href=#stops title="Permanent link">&para;</a></h3> <p>Stop signals are an important element of signal development because they allow you to propagate a stop condition through time. VBT provides two main stop signal generators: a basic generator that compares a single time series to any stop condition, and a specialized generator that works with candlestick data and stop order conditions that are common in trading.</p> <p>The first type can be used via the Numba-compiled function <a href=https://vectorbt.pro/pvt_41531c19/api/signals/nb/#vectorbtpro.signals.nb.stop_place_nb>stop_place_nb</a> and its accessor instance method <a href=https://vectorbt.pro/pvt_41531c19/api/signals/accessors/#vectorbtpro.signals.accessors.SignalsAccessor.generate_stop_exits>SignalsAccessor.generate_stop_exits</a>. There are also indicator classes <a href=https://vectorbt.pro/pvt_41531c19/api/signals/generators/stx/#vectorbtpro.signals.generators.stx.STX>STX</a> and <a href=https://vectorbt.pro/pvt_41531c19/api/signals/generators/stcx/#vectorbtpro.signals.generators.stcx.STCX>STCX</a> that make the stop parameterizable. Let's use the accessor method to generate take profit (TP) signals. This requires four inputs: entry signals (<code>entries</code>), the entry price for the stop (<code>entry_ts</code>), the high price (<code>ts</code>), and the actual stop(s) in % to compare against the high price (<code>stop</code>). Use the crossover entries generated previously. Run the method in chained exits mode to ensure VBT waits for an exit and removes any entry signals that appear before.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-69-1><a id=__codelineno-69-1 name=__codelineno-69-1 href=#__codelineno-69-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>new_entries</span><span class=p>,</span> <span class=n>exits</span> <span class=o>=</span> <span class=n>entries</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>generate_stop_exits</span><span class=p>(</span>
</span><span id=__span-69-2><a id=__codelineno-69-2 name=__codelineno-69-2 href=#__codelineno-69-2></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>),</span>
</span><span id=__span-69-3><a id=__codelineno-69-3 name=__codelineno-69-3 href=#__codelineno-69-3></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;High&quot;</span><span class=p>),</span>
</span><span id=__span-69-4><a id=__codelineno-69-4 name=__codelineno-69-4 href=#__codelineno-69-4></a><span class=gp>... </span>    <span class=n>stop</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
</span><span id=__span-69-5><a id=__codelineno-69-5 name=__codelineno-69-5 href=#__codelineno-69-5></a><span class=gp>... </span>    <span class=n>chain</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-69-6><a id=__codelineno-69-6 name=__codelineno-69-6 href=#__codelineno-69-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-69-7><a id=__codelineno-69-7 name=__codelineno-69-7 href=#__codelineno-69-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>new_entries</span><span class=p>[</span><span class=n>new_entries</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)]</span>
</span><span id=__span-69-8><a id=__codelineno-69-8 name=__codelineno-69-8 href=#__codelineno-69-8></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-69-9><a id=__codelineno-69-9 name=__codelineno-69-9 href=#__codelineno-69-9></a><span class=go>Open time                                  </span>
</span><span id=__span-69-10><a id=__codelineno-69-10 name=__codelineno-69-10 href=#__codelineno-69-10></a><span class=go>2021-02-04 00:00:00+00:00     True    False</span>
</span><span id=__span-69-11><a id=__codelineno-69-11 name=__codelineno-69-11 href=#__codelineno-69-11></a><span class=go>2021-03-10 00:00:00+00:00     True    False</span>
</span><span id=__span-69-12><a id=__codelineno-69-12 name=__codelineno-69-12 href=#__codelineno-69-12></a><span class=go>...</span>
</span><span id=__span-69-13><a id=__codelineno-69-13 name=__codelineno-69-13 href=#__codelineno-69-13></a><span class=go>2021-11-07 00:00:00+00:00     True    False</span>
</span><span id=__span-69-14><a id=__codelineno-69-14 name=__codelineno-69-14 href=#__codelineno-69-14></a><span class=go>2021-12-02 00:00:00+00:00    False     True</span>
</span><span id=__span-69-15><a id=__codelineno-69-15 name=__codelineno-69-15 href=#__codelineno-69-15></a>
</span><span id=__span-69-16><a id=__codelineno-69-16 name=__codelineno-69-16 href=#__codelineno-69-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exits</span><span class=p>[</span><span class=n>exits</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)]</span>
</span><span id=__span-69-17><a id=__codelineno-69-17 name=__codelineno-69-17 href=#__codelineno-69-17></a><span class=go>symbol                     BTCUSDT  ETHUSDT</span>
</span><span id=__span-69-18><a id=__codelineno-69-18 name=__codelineno-69-18 href=#__codelineno-69-18></a><span class=go>Open time                                  </span>
</span><span id=__span-69-19><a id=__codelineno-69-19 name=__codelineno-69-19 href=#__codelineno-69-19></a><span class=go>2021-02-06 00:00:00+00:00     True    False</span>
</span><span id=__span-69-20><a id=__codelineno-69-20 name=__codelineno-69-20 href=#__codelineno-69-20></a><span class=go>2021-03-13 00:00:00+00:00     True    False</span>
</span><span id=__span-69-21><a id=__codelineno-69-21 name=__codelineno-69-21 href=#__codelineno-69-21></a><span class=go>...</span>
</span><span id=__span-69-22><a id=__codelineno-69-22 name=__codelineno-69-22 href=#__codelineno-69-22></a><span class=go>2021-10-15 00:00:00+00:00    False     True</span>
</span><span id=__span-69-23><a id=__codelineno-69-23 name=__codelineno-69-23 href=#__codelineno-69-23></a><span class=go>2021-10-19 00:00:00+00:00     True    False</span>
</span></code></pre></div> <p>But how do we determine the stop price? Fortunately, the Numba-compiled function also accepts a (required) in-place output array <code>stop_ts</code> that will be filled with the stop price of each exit. By default, VBT assumes you are not interested in this array, so to save memory, it creates an empty (uninitialized) array, passes it to Numba, and deletes it afterward. To have it return the array, you should pass an empty dictionary <code>out_dict</code>, where the accessor method can place the array. When you provide an <code>out_dict</code>, VBT will create a full (initialized) array with <code>np.nan</code>, pass it to Numba, and store it in the dictionary:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-70-1><a id=__codelineno-70-1 name=__codelineno-70-1 href=#__codelineno-70-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>out_dict</span> <span class=o>=</span> <span class=p>{}</span>
</span><span id=__span-70-2><a id=__codelineno-70-2 name=__codelineno-70-2 href=#__codelineno-70-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>new_entries</span><span class=p>,</span> <span class=n>exits</span> <span class=o>=</span> <span class=n>entries</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>generate_stop_exits</span><span class=p>(</span>
</span><span id=__span-70-3><a id=__codelineno-70-3 name=__codelineno-70-3 href=#__codelineno-70-3></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>),</span>
</span><span id=__span-70-4><a id=__codelineno-70-4 name=__codelineno-70-4 href=#__codelineno-70-4></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;High&quot;</span><span class=p>),</span>
</span><span id=__span-70-5><a id=__codelineno-70-5 name=__codelineno-70-5 href=#__codelineno-70-5></a><span class=gp>... </span>    <span class=n>stop</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
</span><span id=__span-70-6><a id=__codelineno-70-6 name=__codelineno-70-6 href=#__codelineno-70-6></a><span class=gp>... </span>    <span class=n>chain</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-70-7><a id=__codelineno-70-7 name=__codelineno-70-7 href=#__codelineno-70-7></a><span class=gp>... </span>    <span class=n>out_dict</span><span class=o>=</span><span class=n>out_dict</span>
</span><span id=__span-70-8><a id=__codelineno-70-8 name=__codelineno-70-8 href=#__codelineno-70-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-70-9><a id=__codelineno-70-9 name=__codelineno-70-9 href=#__codelineno-70-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>out_dict</span><span class=p>[</span><span class=s2>&quot;stop_ts&quot;</span><span class=p>][</span><span class=n>exits</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)]</span>
</span><span id=__span-70-10><a id=__codelineno-70-10 name=__codelineno-70-10 href=#__codelineno-70-10></a><span class=go>symbol                       BTCUSDT   ETHUSDT</span>
</span><span id=__span-70-11><a id=__codelineno-70-11 name=__codelineno-70-11 href=#__codelineno-70-11></a><span class=go>Open time                                     </span>
</span><span id=__span-70-12><a id=__codelineno-70-12 name=__codelineno-70-12 href=#__codelineno-70-12></a><span class=go>2021-02-06 00:00:00+00:00  40630.326       NaN</span>
</span><span id=__span-70-13><a id=__codelineno-70-13 name=__codelineno-70-13 href=#__codelineno-70-13></a><span class=go>2021-03-13 00:00:00+00:00  61436.749       NaN</span>
</span><span id=__span-70-14><a id=__codelineno-70-14 name=__codelineno-70-14 href=#__codelineno-70-14></a><span class=go>...</span>
</span><span id=__span-70-15><a id=__codelineno-70-15 name=__codelineno-70-15 href=#__codelineno-70-15></a><span class=go>2021-10-15 00:00:00+00:00        NaN  3866.797</span>
</span><span id=__span-70-16><a id=__codelineno-70-16 name=__codelineno-70-16 href=#__codelineno-70-16></a><span class=go>2021-10-19 00:00:00+00:00  63179.721       NaN</span>
</span></code></pre></div> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>You can also pass your own (pre-created) <code>stop_ts</code> inside <code>out_dict</code>, and VBT will override only the elements corresponding to the exits.</p> </div> <p>You can do the same with the corresponding indicator class. Let's try something different: test two trailing stop loss (TSL) parameters, where the condition follows the high price upward and is triggered once the low price crosses the stop value downward. The high price can be specified with the argument <code>follow_ts</code>. The entry price will be the open price (even though we generated entries using the close price, let's assume this situation for now), so we will also allow placing the first signal at the entry bar by setting <code>wait</code> to zero:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-71-1><a id=__codelineno-71-1 name=__codelineno-71-1 href=#__codelineno-71-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>stcx</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>STCX</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>  <span class=c1># (1)!</span>
</span><span id=__span-71-2><a id=__codelineno-71-2 name=__codelineno-71-2 href=#__codelineno-71-2></a><span class=gp>... </span>    <span class=n>entries</span><span class=p>,</span>
</span><span id=__span-71-3><a id=__codelineno-71-3 name=__codelineno-71-3 href=#__codelineno-71-3></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Open&quot;</span><span class=p>),</span>
</span><span id=__span-71-4><a id=__codelineno-71-4 name=__codelineno-71-4 href=#__codelineno-71-4></a><span class=gp>... </span>    <span class=n>ts</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>),</span>
</span><span id=__span-71-5><a id=__codelineno-71-5 name=__codelineno-71-5 href=#__codelineno-71-5></a><span class=gp>... </span>    <span class=n>follow_ts</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;High&quot;</span><span class=p>),</span>
</span><span id=__span-71-6><a id=__codelineno-71-6 name=__codelineno-71-6 href=#__codelineno-71-6></a><span class=gp>... </span>    <span class=n>stop</span><span class=o>=-</span><span class=mf>0.1</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-71-7><a id=__codelineno-71-7 name=__codelineno-71-7 href=#__codelineno-71-7></a><span class=gp>... </span>    <span class=n>trailing</span><span class=o>=</span><span class=p>[</span><span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>],</span>  <span class=c1># (3)!</span>
</span><span id=__span-71-8><a id=__codelineno-71-8 name=__codelineno-71-8 href=#__codelineno-71-8></a><span class=gp>... </span>    <span class=n>wait</span><span class=o>=</span><span class=mi>0</span>  <span class=c1># (4)!</span>
</span><span id=__span-71-9><a id=__codelineno-71-9 name=__codelineno-71-9 href=#__codelineno-71-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-71-10><a id=__codelineno-71-10 name=__codelineno-71-10 href=#__codelineno-71-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span>
</span><span id=__span-71-11><a id=__codelineno-71-11 name=__codelineno-71-11 href=#__codelineno-71-11></a><span class=gp>... </span>    <span class=n>symbol</span><span class=o>=</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>,</span> 
</span><span id=__span-71-12><a id=__codelineno-71-12 name=__codelineno-71-12 href=#__codelineno-71-12></a><span class=gp>... </span>    <span class=n>ohlc_trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>opacity</span><span class=o>=</span><span class=mf>0.5</span><span class=p>),</span> 
</span><span id=__span-71-13><a id=__codelineno-71-13 name=__codelineno-71-13 href=#__codelineno-71-13></a><span class=gp>... </span>    <span class=n>plot_volume</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-71-14><a id=__codelineno-71-14 name=__codelineno-71-14 href=#__codelineno-71-14></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-71-15><a id=__codelineno-71-15 name=__codelineno-71-15 href=#__codelineno-71-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>stcx</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span>
</span><span id=__span-71-16><a id=__codelineno-71-16 name=__codelineno-71-16 href=#__codelineno-71-16></a><span class=gp>... </span>    <span class=n>column</span><span class=o>=</span><span class=p>(</span><span class=o>-</span><span class=mf>0.1</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=s2>&quot;BTCUSDT&quot;</span><span class=p>),</span> 
</span><span id=__span-71-17><a id=__codelineno-71-17 name=__codelineno-71-17 href=#__codelineno-71-17></a><span class=gp>... </span>    <span class=n>entry_y</span><span class=o>=</span><span class=s2>&quot;entry_ts&quot;</span><span class=p>,</span>  <span class=c1># (5)!</span>
</span><span id=__span-71-18><a id=__codelineno-71-18 name=__codelineno-71-18 href=#__codelineno-71-18></a><span class=gp>... </span>    <span class=n>exit_y</span><span class=o>=</span><span class=s2>&quot;stop_ts&quot;</span><span class=p>,</span> 
</span><span id=__span-71-19><a id=__codelineno-71-19 name=__codelineno-71-19 href=#__codelineno-71-19></a><span class=gp>... </span>    <span class=n>fig</span><span class=o>=</span><span class=n>fig</span>
</span><span id=__span-71-20><a id=__codelineno-71-20 name=__codelineno-71-20 href=#__codelineno-71-20></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-71-21><a id=__codelineno-71-21 name=__codelineno-71-21 href=#__codelineno-71-21></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <ol> <li>Indicators usually assume you want all optional arrays, so you do not need to pass anything. If you are not interested, pass <code>stop_ts=None</code> to save some RAM.</li> <li>For a downward crossover condition, specify a negative stop value.</li> <li>Test both SL and TSL.</li> <li>Set waiting time to zero only if the entry price is the open price.</li> <li>When plotting, you can provide <code>y</code> as an attribute of the indicator instance.</li> </ol> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/signal-dev/stcx.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/signal-dev/stcx.dark.svg#only-dark></p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Waiting time cannot be higher than 1. If waiting time is 0, <code>entry_ts</code> should be the first value in the bar. If waiting time is 1, <code>entry_ts</code> should be the last value in the bar; otherwise, the stop could have also been hit at the first bar.</p> <p>By setting waiting time to zero, you may have an entry and an exit on the same bar. Multiple orders on the same bar can only be handled using a flexible order function or by converting signals directly into order records. When passed directly to <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a>, any conflicting signals will be ignored.</p> </div> <p>If you want to place only SL, TSL, TP, and TTP orders, a more complete approach is to use the full OHLC data, as utilized by the Numba-compiled function <a href=https://vectorbt.pro/pvt_41531c19/api/signals/nb/#vectorbtpro.signals.nb.ohlc_stop_place_nb>ohlc_stop_place_nb</a>, the accessor instance method <a href=https://vectorbt.pro/pvt_41531c19/api/signals/accessors/#vectorbtpro.signals.accessors.SignalsAccessor.generate_ohlc_stop_exits>SignalsAccessor.generate_ohlc_stop_exits</a>, and the corresponding indicator classes <a href=https://vectorbt.pro/pvt_41531c19/api/signals/generators/ohlcstx/#vectorbtpro.signals.generators.ohlcstx.OHLCSTX>OHLCSTX</a> and <a href=https://vectorbt.pro/pvt_41531c19/api/signals/generators/ohlcstcx/#vectorbtpro.signals.generators.ohlcstcx.OHLCSTCX>OHLCSTCX</a>. The main advantage of this approach is that you can check for all stop order conditions at the same time.</p> <p>Let's generate signals based on a <a href=https://www.investopedia.com/articles/trading/08/trailing-stop-loss.asp>stop loss and trailing stop loss combo</a> of 10% and 15%, respectively:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-72-1><a id=__codelineno-72-1 name=__codelineno-72-1 href=#__codelineno-72-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>ohlcstcx</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>OHLCSTCX</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span><span id=__span-72-2><a id=__codelineno-72-2 name=__codelineno-72-2 href=#__codelineno-72-2></a><span class=gp>... </span>    <span class=n>entries</span><span class=p>,</span>
</span><span id=__span-72-3><a id=__codelineno-72-3 name=__codelineno-72-3 href=#__codelineno-72-3></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>),</span>  <span class=c1># (1)!</span>
</span><span id=__span-72-4><a id=__codelineno-72-4 name=__codelineno-72-4 href=#__codelineno-72-4></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Open&quot;</span><span class=p>),</span>  <span class=c1># (2)!</span>
</span><span id=__span-72-5><a id=__codelineno-72-5 name=__codelineno-72-5 href=#__codelineno-72-5></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;High&quot;</span><span class=p>),</span>
</span><span id=__span-72-6><a id=__codelineno-72-6 name=__codelineno-72-6 href=#__codelineno-72-6></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>),</span>
</span><span id=__span-72-7><a id=__codelineno-72-7 name=__codelineno-72-7 href=#__codelineno-72-7></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>),</span>
</span><span id=__span-72-8><a id=__codelineno-72-8 name=__codelineno-72-8 href=#__codelineno-72-8></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Default</span><span class=p>(</span><span class=mf>0.1</span><span class=p>),</span>  <span class=c1># (3)!</span>
</span><span id=__span-72-9><a id=__codelineno-72-9 name=__codelineno-72-9 href=#__codelineno-72-9></a><span class=gp>... </span>    <span class=n>tsl_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Default</span><span class=p>(</span><span class=mf>0.15</span><span class=p>),</span>
</span><span id=__span-72-10><a id=__codelineno-72-10 name=__codelineno-72-10 href=#__codelineno-72-10></a><span class=gp>... </span>    <span class=n>is_entry_open</span><span class=o>=</span><span class=kc>False</span>  <span class=c1># (4)!</span>
</span><span id=__span-72-11><a id=__codelineno-72-11 name=__codelineno-72-11 href=#__codelineno-72-11></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-72-12><a id=__codelineno-72-12 name=__codelineno-72-12 href=#__codelineno-72-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>ohlcstcx</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>column</span><span class=o>=</span><span class=p>(</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>))</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>  <span class=c1># (5)!</span>
</span></code></pre></div> <ol> <li>Entry price. Here, we use the close price since the entries array was generated using it.</li> <li>OHLC.</li> <li>Stop parameters.</li> <li>Entry price is the close price. Enable this flag if the entry price is the open price.</li> <li>The indicator instance automatically plots the candlestick data.</li> </ol> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/signal-dev/ohlcstcx.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/signal-dev/ohlcstcx.dark.svg#only-dark></p> <p>Keep in mind that there is no intra-candle data. If there was a large price fluctuation in both directions, we could not determine whether SL was triggered before TP or vice versa. Certain assumptions must be made:</p> <ul> <li>If a stop is hit before the open price, the stop price becomes the current open price. This is especially true for <code>wait=1</code> and <code>is_entry_open=True</code>.</li> <li>Trailing stop can only be based on the previous high/low price, not the current one.</li> <li>We pessimistically assume that any SL is triggered before any TP.</li> </ul> <p>A common tricky situation occurs when the entry price is the open price and you are waiting one bar. For example, what happens if the condition is met during the waiting period? You cannot place an exit signal at the entry bar. Instead, the function waits until the next bar and checks whether the condition is still valid for the open price. If it is, the signal is placed with the stop price set to the open price. If not, the function simply waits for the next opportunity. If the stop is trailing, the target price will update as usual at the entry timestamp. To avoid logical bugs, it is recommended to use the close price as the entry price when <code>wait</code> is one bar (which is the default).</p> <p>When working with multiple stop types simultaneously, you may want to know which exact type was triggered. This information is stored in the <code>stop_type</code> array (machine-readable) and the <code>stop_type_readable</code> array (human-readable):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-73-1><a id=__codelineno-73-1 name=__codelineno-73-1 href=#__codelineno-73-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>ohlcstcx</span><span class=o>.</span><span class=n>stop_type_readable</span><span class=p>[</span><span class=n>ohlcstcx</span><span class=o>.</span><span class=n>exits</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)]</span>
</span><span id=__span-73-2><a id=__codelineno-73-2 name=__codelineno-73-2 href=#__codelineno-73-2></a><span class=go>symbol                    BTCUSDT ETHUSDT</span>
</span><span id=__span-73-3><a id=__codelineno-73-3 name=__codelineno-73-3 href=#__codelineno-73-3></a><span class=go>Open time                                </span>
</span><span id=__span-73-4><a id=__codelineno-73-4 name=__codelineno-73-4 href=#__codelineno-73-4></a><span class=go>2021-02-22 00:00:00+00:00     TSL    None</span>
</span><span id=__span-73-5><a id=__codelineno-73-5 name=__codelineno-73-5 href=#__codelineno-73-5></a><span class=go>2021-03-23 00:00:00+00:00    None     TSL</span>
</span><span id=__span-73-6><a id=__codelineno-73-6 name=__codelineno-73-6 href=#__codelineno-73-6></a><span class=go>2021-03-24 00:00:00+00:00     TSL    None</span>
</span><span id=__span-73-7><a id=__codelineno-73-7 name=__codelineno-73-7 href=#__codelineno-73-7></a><span class=go>2021-04-18 00:00:00+00:00      SL     TSL</span>
</span><span id=__span-73-8><a id=__codelineno-73-8 name=__codelineno-73-8 href=#__codelineno-73-8></a><span class=go>2021-05-12 00:00:00+00:00      SL    None</span>
</span><span id=__span-73-9><a id=__codelineno-73-9 name=__codelineno-73-9 href=#__codelineno-73-9></a><span class=go>2021-06-08 00:00:00+00:00    None      SL</span>
</span><span id=__span-73-10><a id=__codelineno-73-10 name=__codelineno-73-10 href=#__codelineno-73-10></a><span class=go>2021-06-18 00:00:00+00:00      SL    None</span>
</span><span id=__span-73-11><a id=__codelineno-73-11 name=__codelineno-73-11 href=#__codelineno-73-11></a><span class=go>2021-07-09 00:00:00+00:00    None     TSL</span>
</span><span id=__span-73-12><a id=__codelineno-73-12 name=__codelineno-73-12 href=#__codelineno-73-12></a><span class=go>2021-07-19 00:00:00+00:00      SL    None</span>
</span><span id=__span-73-13><a id=__codelineno-73-13 name=__codelineno-73-13 href=#__codelineno-73-13></a><span class=go>2021-09-07 00:00:00+00:00     TSL     TSL</span>
</span><span id=__span-73-14><a id=__codelineno-73-14 name=__codelineno-73-14 href=#__codelineno-73-14></a><span class=go>2021-11-16 00:00:00+00:00     TSL     TSL</span>
</span><span id=__span-73-15><a id=__codelineno-73-15 name=__codelineno-73-15 href=#__codelineno-73-15></a><span class=go>2021-12-03 00:00:00+00:00    None      SL</span>
</span><span id=__span-73-16><a id=__codelineno-73-16 name=__codelineno-73-16 href=#__codelineno-73-16></a><span class=go>2021-12-29 00:00:00+00:00    None      SL</span>
</span><span id=__span-73-17><a id=__codelineno-73-17 name=__codelineno-73-17 href=#__codelineno-73-17></a><span class=go>2021-12-31 00:00:00+00:00      SL    None</span>
</span></code></pre></div> <p>All stop types are listed in the enumerated type <a href=https://vectorbt.pro/pvt_41531c19/api/signals/enums/#vectorbtpro.signals.enums.StopType>StopType</a>.</p> <p>Both stop signal generation modes are very flexible with inputs. For example, if any element in the <code>ts</code> and <code>follow_ts</code> arrays is NaN (default), it will be replaced by the corresponding element in <code>entry_ts</code>. If only an element in <code>follow_ts</code> is NaN, it will be replaced by the minimum or maximum (depending on the sign of the stop value) of the element in both other arrays. Similarly, in the second mode, you can provide only <code>entry_price</code>, and VBT will auto-populate the open price if <code>is_entry_open</code> is enabled, or the close price otherwise. Without <code>high</code>, VBT will use the maximum of <code>open</code> and <code>close</code>. Generally, you are not required to provide every piece of information except for the entry price, but it is best to provide as much detail as you can for better decision-making and to closely simulate real-world conditions.</p> <p>For example, let's run the same as above but specify only the entry price:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-74-1><a id=__codelineno-74-1 name=__codelineno-74-1 href=#__codelineno-74-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>ohlcstcx</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>OHLCSTCX</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span><span id=__span-74-2><a id=__codelineno-74-2 name=__codelineno-74-2 href=#__codelineno-74-2></a><span class=gp>... </span>    <span class=n>entries</span><span class=p>,</span>
</span><span id=__span-74-3><a id=__codelineno-74-3 name=__codelineno-74-3 href=#__codelineno-74-3></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>),</span>
</span><span id=__span-74-4><a id=__codelineno-74-4 name=__codelineno-74-4 href=#__codelineno-74-4></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Default</span><span class=p>(</span><span class=mf>0.1</span><span class=p>),</span>
</span><span id=__span-74-5><a id=__codelineno-74-5 name=__codelineno-74-5 href=#__codelineno-74-5></a><span class=gp>... </span>    <span class=n>tsl_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Default</span><span class=p>(</span><span class=mf>0.15</span><span class=p>),</span>
</span><span id=__span-74-6><a id=__codelineno-74-6 name=__codelineno-74-6 href=#__codelineno-74-6></a><span class=gp>... </span>    <span class=n>is_entry_open</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-74-7><a id=__codelineno-74-7 name=__codelineno-74-7 href=#__codelineno-74-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-74-8><a id=__codelineno-74-8 name=__codelineno-74-8 href=#__codelineno-74-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>ohlcstcx</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>column</span><span class=o>=</span><span class=p>(</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>))</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/signal-dev/ohlcstcx2.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/signal-dev/ohlcstcx2.dark.svg#only-dark></p> <p>The same flexibility applies to parameters: just like the probability parameter in random signal generators, you can pass each parameter as an array, such as one element per row, column, or even element. Let's treat every second entry as a short entry and reverse the <a href=https://capitalise.ai/trailing-take-profit-manage-your-risk-while-locking-the-profits/ >trailing take profit</a> (TTP) logic for it:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-75-1><a id=__codelineno-75-1 name=__codelineno-75-1 href=#__codelineno-75-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entry_pos_rank</span> <span class=o>=</span> <span class=n>entries</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>pos_rank</span><span class=p>(</span><span class=n>allow_gaps</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-75-2><a id=__codelineno-75-2 name=__codelineno-75-2 href=#__codelineno-75-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>short_entries</span> <span class=o>=</span> <span class=p>(</span><span class=n>entry_pos_rank</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>entry_pos_rank</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-75-3><a id=__codelineno-75-3 name=__codelineno-75-3 href=#__codelineno-75-3></a>
</span><span id=__span-75-4><a id=__codelineno-75-4 name=__codelineno-75-4 href=#__codelineno-75-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>ohlcstcx</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>OHLCSTCX</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span><span id=__span-75-5><a id=__codelineno-75-5 name=__codelineno-75-5 href=#__codelineno-75-5></a><span class=gp>... </span>    <span class=n>entries</span><span class=p>,</span>
</span><span id=__span-75-6><a id=__codelineno-75-6 name=__codelineno-75-6 href=#__codelineno-75-6></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>),</span>
</span><span id=__span-75-7><a id=__codelineno-75-7 name=__codelineno-75-7 href=#__codelineno-75-7></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Open&quot;</span><span class=p>),</span>
</span><span id=__span-75-8><a id=__codelineno-75-8 name=__codelineno-75-8 href=#__codelineno-75-8></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;High&quot;</span><span class=p>),</span>
</span><span id=__span-75-9><a id=__codelineno-75-9 name=__codelineno-75-9 href=#__codelineno-75-9></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Low&quot;</span><span class=p>),</span>
</span><span id=__span-75-10><a id=__codelineno-75-10 name=__codelineno-75-10 href=#__codelineno-75-10></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>),</span>
</span><span id=__span-75-11><a id=__codelineno-75-11 name=__codelineno-75-11 href=#__codelineno-75-11></a><span class=gp>... </span>    <span class=n>tsl_th</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Default</span><span class=p>(</span><span class=mf>0.2</span><span class=p>),</span>  <span class=c1># (3)!</span>
</span><span id=__span-75-12><a id=__codelineno-75-12 name=__codelineno-75-12 href=#__codelineno-75-12></a><span class=gp>... </span>    <span class=n>tsl_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Default</span><span class=p>(</span><span class=mf>0.1</span><span class=p>),</span>
</span><span id=__span-75-13><a id=__codelineno-75-13 name=__codelineno-75-13 href=#__codelineno-75-13></a><span class=gp>... </span>    <span class=n>reverse</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Default</span><span class=p>(</span><span class=n>short_entries</span><span class=p>),</span>  <span class=c1># (4)!</span>
</span><span id=__span-75-14><a id=__codelineno-75-14 name=__codelineno-75-14 href=#__codelineno-75-14></a><span class=gp>... </span>    <span class=n>is_entry_open</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-75-15><a id=__codelineno-75-15 name=__codelineno-75-15 href=#__codelineno-75-15></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-75-16><a id=__codelineno-75-16 name=__codelineno-75-16 href=#__codelineno-75-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>ohlcstcx</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>column</span><span class=o>=</span><span class=p>(</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>))</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <ol> <li>Rank each entry signal by its position among all entry signals using <a href=https://vectorbt.pro/pvt_41531c19/api/signals/accessors/#vectorbtpro.signals.accessors.pos_rank>SignalsAccessor.pos_rank</a>.</li> <li>Select only those entries whose position is odd, meaning those not divisible by 2. These will be our short entries.</li> <li>TTP information consists of two parts: a take profit threshold (<code>tsl_th</code>) that needs to be crossed upward, and a trailing stop loss (<code>tsl_stop</code>) that is enabled once the threshold is crossed.</li> <li>The short entry mask becomes our reversal mask.</li> </ol> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/signal-dev/ohlcstcx3.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/signal-dev/ohlcstcx3.dark.svg#only-dark></p> <p>You can then split both final arrays into four direction-aware arrays for simulation:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-76-1><a id=__codelineno-76-1 name=__codelineno-76-1 href=#__codelineno-76-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>long_entries</span> <span class=o>=</span> <span class=n>ohlcstcx</span><span class=o>.</span><span class=n>new_entries</span><span class=o>.</span><span class=n>vbt</span> <span class=o>&amp;</span> <span class=p>(</span><span class=o>~</span><span class=n>short_entries</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-76-2><a id=__codelineno-76-2 name=__codelineno-76-2 href=#__codelineno-76-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>long_exits</span> <span class=o>=</span> <span class=n>ohlcstcx</span><span class=o>.</span><span class=n>exits</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>first_after</span><span class=p>(</span><span class=n>long_entries</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-76-3><a id=__codelineno-76-3 name=__codelineno-76-3 href=#__codelineno-76-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>short_entries</span> <span class=o>=</span> <span class=n>ohlcstcx</span><span class=o>.</span><span class=n>new_entries</span><span class=o>.</span><span class=n>vbt</span> <span class=o>&amp;</span> <span class=n>short_entries</span>
</span><span id=__span-76-4><a id=__codelineno-76-4 name=__codelineno-76-4 href=#__codelineno-76-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>short_exits</span> <span class=o>=</span> <span class=n>ohlcstcx</span><span class=o>.</span><span class=n>exits</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>first_after</span><span class=p>(</span><span class=n>short_entries</span><span class=p>)</span>
</span><span id=__span-76-5><a id=__codelineno-76-5 name=__codelineno-76-5 href=#__codelineno-76-5></a>
</span><span id=__span-76-6><a id=__codelineno-76-6 name=__codelineno-76-6 href=#__codelineno-76-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span>
</span><span id=__span-76-7><a id=__codelineno-76-7 name=__codelineno-76-7 href=#__codelineno-76-7></a><span class=gp>... </span>    <span class=n>symbol</span><span class=o>=</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>,</span> 
</span><span id=__span-76-8><a id=__codelineno-76-8 name=__codelineno-76-8 href=#__codelineno-76-8></a><span class=gp>... </span>    <span class=n>ohlc_trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>opacity</span><span class=o>=</span><span class=mf>0.5</span><span class=p>),</span> 
</span><span id=__span-76-9><a id=__codelineno-76-9 name=__codelineno-76-9 href=#__codelineno-76-9></a><span class=gp>... </span>    <span class=n>plot_volume</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-76-10><a id=__codelineno-76-10 name=__codelineno-76-10 href=#__codelineno-76-10></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-76-11><a id=__codelineno-76-11 name=__codelineno-76-11 href=#__codelineno-76-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>long_entries</span><span class=p>[</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>plot_as_entries</span><span class=p>(</span>
</span><span id=__span-76-12><a id=__codelineno-76-12 name=__codelineno-76-12 href=#__codelineno-76-12></a><span class=gp>... </span>    <span class=n>ohlcstcx</span><span class=o>.</span><span class=n>entry_price</span><span class=p>[</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>],</span>
</span><span id=__span-76-13><a id=__codelineno-76-13 name=__codelineno-76-13 href=#__codelineno-76-13></a><span class=gp>... </span>    <span class=n>trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>marker</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>color</span><span class=o>=</span><span class=s2>&quot;limegreen&quot;</span><span class=p>),</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;Long entries&quot;</span><span class=p>),</span> 
</span><span id=__span-76-14><a id=__codelineno-76-14 name=__codelineno-76-14 href=#__codelineno-76-14></a><span class=gp>... </span>    <span class=n>fig</span><span class=o>=</span><span class=n>fig</span>
</span><span id=__span-76-15><a id=__codelineno-76-15 name=__codelineno-76-15 href=#__codelineno-76-15></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-76-16><a id=__codelineno-76-16 name=__codelineno-76-16 href=#__codelineno-76-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>long_exits</span><span class=p>[</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>plot_as_exits</span><span class=p>(</span>
</span><span id=__span-76-17><a id=__codelineno-76-17 name=__codelineno-76-17 href=#__codelineno-76-17></a><span class=gp>... </span>    <span class=n>ohlcstcx</span><span class=o>.</span><span class=n>stop_price</span><span class=p>[</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>],</span>
</span><span id=__span-76-18><a id=__codelineno-76-18 name=__codelineno-76-18 href=#__codelineno-76-18></a><span class=gp>... </span>    <span class=n>trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>marker</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>color</span><span class=o>=</span><span class=s2>&quot;orange&quot;</span><span class=p>),</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;Long exits&quot;</span><span class=p>),</span>
</span><span id=__span-76-19><a id=__codelineno-76-19 name=__codelineno-76-19 href=#__codelineno-76-19></a><span class=gp>... </span>    <span class=n>fig</span><span class=o>=</span><span class=n>fig</span>
</span><span id=__span-76-20><a id=__codelineno-76-20 name=__codelineno-76-20 href=#__codelineno-76-20></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-76-21><a id=__codelineno-76-21 name=__codelineno-76-21 href=#__codelineno-76-21></a><span class=gp>&gt;&gt;&gt; </span><span class=n>short_entries</span><span class=p>[</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>plot_as_entries</span><span class=p>(</span>
</span><span id=__span-76-22><a id=__codelineno-76-22 name=__codelineno-76-22 href=#__codelineno-76-22></a><span class=gp>... </span>    <span class=n>ohlcstcx</span><span class=o>.</span><span class=n>entry_price</span><span class=p>[</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>],</span>
</span><span id=__span-76-23><a id=__codelineno-76-23 name=__codelineno-76-23 href=#__codelineno-76-23></a><span class=gp>... </span>    <span class=n>trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>marker</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>color</span><span class=o>=</span><span class=s2>&quot;magenta&quot;</span><span class=p>),</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;Short entries&quot;</span><span class=p>),</span>
</span><span id=__span-76-24><a id=__codelineno-76-24 name=__codelineno-76-24 href=#__codelineno-76-24></a><span class=gp>... </span>    <span class=n>fig</span><span class=o>=</span><span class=n>fig</span>
</span><span id=__span-76-25><a id=__codelineno-76-25 name=__codelineno-76-25 href=#__codelineno-76-25></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-76-26><a id=__codelineno-76-26 name=__codelineno-76-26 href=#__codelineno-76-26></a><span class=gp>&gt;&gt;&gt; </span><span class=n>short_exits</span><span class=p>[</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>plot_as_exits</span><span class=p>(</span>
</span><span id=__span-76-27><a id=__codelineno-76-27 name=__codelineno-76-27 href=#__codelineno-76-27></a><span class=gp>... </span>    <span class=n>ohlcstcx</span><span class=o>.</span><span class=n>stop_price</span><span class=p>[</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>],</span>
</span><span id=__span-76-28><a id=__codelineno-76-28 name=__codelineno-76-28 href=#__codelineno-76-28></a><span class=gp>... </span>    <span class=n>trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>marker</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>color</span><span class=o>=</span><span class=s2>&quot;red&quot;</span><span class=p>),</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;Short exits&quot;</span><span class=p>),</span>
</span><span id=__span-76-29><a id=__codelineno-76-29 name=__codelineno-76-29 href=#__codelineno-76-29></a><span class=gp>... </span>    <span class=n>fig</span><span class=o>=</span><span class=n>fig</span>
</span><span id=__span-76-30><a id=__codelineno-76-30 name=__codelineno-76-30 href=#__codelineno-76-30></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-76-31><a id=__codelineno-76-31 name=__codelineno-76-31 href=#__codelineno-76-31></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <ol> <li>We cannot use the original <code>entries</code> array since the generator ignored some entries that came too early. But since new entries retain their positions, we can identify long signals by inverting the short array and combining it with the new entry array using the <em>AND</em> operation.</li> <li>A useful feature of the chained exits mode is that each exit always follows its entry directly— there are no other entries in between, so we can use <a href=https://vectorbt.pro/pvt_41531c19/api/signals/accessors/#vectorbtpro.signals.accessors.first_after>SignalsAccessor.first_after</a> for this task.</li> </ol> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/signal-dev/ohlcstcx4.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/signal-dev/ohlcstcx4.dark.svg#only-dark></p> <p>It seems like all trades are winners, thanks to a range-bound but still volatile market <img alt=🍀 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f340.svg title=:four_leaf_clover:></p> <p><a class=md-button href=https://vectorbt.pro/pvt_41531c19/assets/jupytext/tutorials/signal-development/generation.py.txt target=blank_><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19.14 7.5A2.86 2.86 0 0 1 22 10.36v3.78A2.86 2.86 0 0 1 19.14 17H12c0 .39.32.96.71.96H17v1.68a2.86 2.86 0 0 1-2.86 2.86H9.86A2.86 2.86 0 0 1 7 19.64v-3.75a2.85 2.85 0 0 1 2.86-2.85h5.25a2.85 2.85 0 0 0 2.85-2.86V7.5zm-4.28 11.79c-.4 0-.72.3-.72.89s.32.71.72.71a.71.71 0 0 0 .71-.71c0-.59-.32-.89-.71-.89m-10-1.79A2.86 2.86 0 0 1 2 14.64v-3.78A2.86 2.86 0 0 1 4.86 8H12c0-.39-.32-.96-.71-.96H7V5.36A2.86 2.86 0 0 1 9.86 2.5h4.28A2.86 2.86 0 0 1 17 5.36v3.75a2.85 2.85 0 0 1-2.86 2.85H8.89a2.85 2.85 0 0 0-2.85 2.86v2.68zM9.14 5.71c.4 0 .72-.3.72-.89s-.32-.71-.72-.71c-.39 0-.71.12-.71.71s.32.89.71.89"/></svg></span> Python code</a> <a class=md-button href=https://github.com/polakowo/vectorbt.pro/blob/notebooks/SignalDevelopment.ipynb target=blank_><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 4v6l-2-2-2 2V4H9v16h10V4zM3 7V5h2V4a2 2 0 0 1 2-2h12c1.05 0 2 .95 2 2v16c0 1.05-.95 2-2 2H7c-1.05 0-2-.95-2-2v-1H3v-2h2v-4H3v-2h2V7zm2-2v2h2V5zm0 14h2v-2H5zm0-6h2v-2H5z"/></svg></span> Notebook</a></p> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/superfast-supertrend/pipelines/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Pipelines"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Pipelines </div> </div> </a> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/signal-development/pre-analysis/ class="md-footer__link md-footer__link--next" aria-label="Next: Pre-analysis"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Pre-analysis </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2021-2025 Oleg Polakow. All rights reserved. </div> </div> <div class=md-social> <a href=https://www.linkedin.com/in/polakowo target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> <a href=https://github.com/polakowo target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <div class=md-consent data-md-component=consent id=__consent hidden> <div class=md-consent__overlay></div> <aside class=md-consent__inner> <form class="md-consent__form md-grid md-typeset" name=consent> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class=md-toggle type=checkbox id=__settings> <div class=md-consent__settings> <ul class=task-list> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=analytics checked> <span class=task-list-indicator></span> Google Analytics </label> </li> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=github checked> <span class=task-list-indicator></span> GitHub </label> </li> </ul> </div> <div class=md-consent__controls> <button class="md-button md-button--primary">Accept</button> <label class=md-button for=__settings>Manage settings</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script> <script id=__config type=application/json>{"annotate": null, "base": "../../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.instant", "navigation.instant.progress", "navigation.top", "navigation.prune", "navigation.path", "navigation.footer", "search.suggest", "search.share", "content.code.annotate", "content.code.copy", "content.code.select", "content.tooltips", "content.tabs.link", "toc.follow", "toc.integrate", "announce.dismiss"], "search": "../../../assets/javascripts/workers/search.26099bd0.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=https://vectorbt.pro/pvt_41531c19/assets/javascripts/bundle.9d1edc04.min.js></script> <script src=https://vectorbt.pro/pvt_41531c19/assets/scripts/extra.js></script> <script src=https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js></script> </body> 
<!-- Mirrored from vectorbt.pro/pvt_41531c19/tutorials/signal-development/generation/ by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 22 Nov 2025 03:46:52 GMT -->
</html>