<!doctype html><html lang=en class=no-js> 
<!-- Mirrored from vectorbt.pro/pvt_41531c19/tutorials/pairs-trading/ by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 22 Nov 2025 03:46:56 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Learn how to develop and optimize a pairs trading strategy using VectorBT PRO"><meta name=author content="Oleg Polakow"><link href=https://vectorbt.pro/tutorials/pairs-trading/ rel=canonical><link href=../portfolio-optimization/dynamic/index.html rel=prev><link href=../patterns-and-projections/patterns/index.html rel=next><link rel=icon href=../../assets/logo/favicon.png><meta name=generator content="mkdocs-1.6.0, mkdocs-material-9.6.21+insiders-4.53.17"><title>Pairs trading - VectorBT® PRO</title><link rel=stylesheet href=../../assets/stylesheets/main.010a373c.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=../../../../fonts.gstatic.com/index.html crossorigin><link rel=stylesheet href="../../../../fonts.googleapis.com/cssbe43.css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../assets/stylesheets/extra.css><link rel=stylesheet href=../../assets/stylesheets/custom-light.css><link rel=stylesheet href=../../assets/stylesheets/custom-dark.css><link rel=stylesheet href=../../assets/stylesheets/pygments-light.css><link rel=stylesheet href=../../assets/stylesheets/pygments-dark.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-0C5VNYCFHL"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-0C5VNYCFHL",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="../../../../www.googletagmanager.com/gtag/jsc6c8?id=G-0C5VNYCFHL",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script><meta name=robots content="noindex, nofollow"><meta property=og:title content="Pairs trading"><meta property=og:type content=website><meta content=https://vectorbt.pro/tutorials/pairs-trading/ property=og:url><meta property=og:image:url content=https://vectorbt.pro/pvt_41531c19/assets/logo/social-new.png><meta property=og:image:type content=image/png><meta property=og:description content="Learn how to develop and optimize a pairs trading strategy using VectorBT PRO"><meta property=og:locale content=en-GB><link rel=apple-touch-icon sizes=180x180 href=https://vectorbt.pro/pvt_41531c19/assets/logo/apple-touch-icon.png><link rel=icon type=image/svg+xml href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon.svg><link rel=icon type=image/png sizes=32x32 href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon-16x16.png><link rel=manifest href=https://vectorbt.pro/pvt_41531c19/assets/logo/site.webmanifest><link rel=mask-icon href=https://vectorbt.pro/pvt_41531c19/assets/logo/safari-pinned-tab.svg color=#1e1f22><link rel="shortcut icon" href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon.ico><meta name=msapplication-TileColor content=#1e1f22><meta name=msapplication-config content=https://vectorbt.pro/pvt_41531c19/assets/logo/browserconfig.xml><meta name=theme-color content=#1e1f22><link href=https://unpkg.com/aos@2.3.4/dist/aos.css rel=stylesheet><script src=https://unpkg.com/aos@2.3.4/dist/aos.js></script><link href=http://fonts.cdnfonts.com/css/uni-neue rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/js/all.min.js integrity="sha512-8pHNiqTlsrRjVD4A/3va++W1sMbUHwWxxRPWNyVlql3T+Hgfd81Qc6FC5WMXDC+tSauxxzp1tgiAvSKFu1qIlA==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js integrity="sha512-q583ppKrCRc7N5O0n2nzUiJ+suUv7Et1JGels4bXOaMFQcamPk9HjdUknZuuFjBNs7tsMuadge5k9RzdmO+1GQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><link rel=preconnect href=https://fonts.googleapis.com/><link rel=preconnect href=https://fonts.gstatic.com/ crossorigin></head> <body dir=ltr data-md-color-scheme=custom-dark data-md-color-primary=custom-dark data-md-color-accent=custom-dark> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#pairs-trading class=md-skip> Skip to content </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> <button class="md-banner__button md-icon" aria-label="Don't show this again"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> <i>What's new</i>: New LLM providers, reasoning steps, function calling, YAML & TOML support, and <a href=https://vectorbt.pro/pvt_41531c19/getting-started/release-notes><strong>more</strong></a> <span class="twemoji announce-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m153.6 29.9 16-21.3c4-5.4 10.4-8.6 17.1-8.6C198.4 0 208 9.6 208 21.3v22.1c0 13.1 5.4 25.7 14.9 34.7l84.7 80.9c48.8 46.6 76.4 111.2 76.4 178.7C384 434 306 512 209.7 512H192C86 512 0 426 0 320v-3.8c0-48.8 19.4-95.6 53.9-130.1l3.5-3.5c4.2-4.2 10-6.6 16-6.6 12.5 0 22.6 10.1 22.6 22.6V288c0 35.3 28.7 64 64 64s64-28.7 64-64v-3.9c0-18-7.2-35.3-19.9-48l-38.6-38.6c-24-24-37.5-56.7-37.5-90.7 0-27.7 9-54.8 25.6-76.9"/></svg></span> </div> <script>var el=document.querySelector("[data-md-component=announce]");if(el){var content=el.querySelector(".md-typeset");__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0)}</script> </aside> </div> <!-- Determine class according to configuration --> <!-- Header --> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=header.title> <!-- Link to home --> <a href=https://vectorbt.pro/pvt_41531c19/ title="VectorBT® PRO" class="md-header__button md-logo" aria-label="VectorBT® PRO" data-md-component=logo> <img src=https://vectorbt.pro/pvt_41531c19/assets/logo/logo.svg alt=logo class=logo> </a> <!-- Button to open drawer --> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <!-- Header title --> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> VectorBT® PRO <span class=md-version> v2025.10.15 </span> <span class=unlock-icon><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M192 32c-35.3 0-64 28.7-64 64v64h192c35.3 0 64 28.7 64 64v224c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V224c0-35.3 28.7-64 64-64V96c0-70.7 57.3-128 128-128 63.5 0 116.1 46.1 126.2 106.7 2.9 17.4-8.8 33.9-26.3 36.9S258 102.8 255 85.3C250 55.1 223.7 32 192 32m40 328c13.3 0 24-10.7 24-24s-10.7-24-24-24h-80c-13.3 0-24 10.7-24 24s10.7 24 24 24z"/></svg></span> </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Pairs trading </span> </div> </div> </div> <!-- Color palette --> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=custom-dark data-md-color-primary=custom-dark data-md-color-accent=custom-dark aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=custom-light data-md-color-primary=custom-light data-md-color-accent=custom-light aria-label="Switch to dark mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <!-- Site language selector --> <!-- Button to open search modal --> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <!-- Search interface --> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <!-- Repository information --> <div class=md-header__source> <a href=https://github.com/polakowo/vectorbt.pro title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> vectorbt.pro </div> </a> </div> </nav> <!-- Navigation tabs (sticky) --> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/ class=md-tabs__link> Getting started </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/features/overview/ class=md-tabs__link> Features </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/overview/ class=md-tabs__link> Tutorials </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/documentation/overview/ class=md-tabs__link> Documentation </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/overview/ class=md-tabs__link> Cookbook </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/api/ class=md-tabs__link> API </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/terms/terms-of-use/ class=md-tabs__link> Terms </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://vectorbt.pro/pvt_41531c19/ title="VectorBT® PRO" class="md-nav__button md-logo" aria-label="VectorBT® PRO" data-md-component=logo> <img src=https://vectorbt.pro/pvt_41531c19/assets/logo/logo.svg alt=logo class=logo> </a> VectorBT® PRO </label> <div class=md-nav__source> <a href=https://github.com/polakowo/vectorbt.pro title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> vectorbt.pro </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/ class=md-nav__link> <span class=md-ellipsis> Getting started </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/features/overview/ class=md-nav__link> <span class=md-ellipsis> Features </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Tutorials </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Tutorials </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/overview/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/basic-rsi/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m3.5 18.5 6-6 4 4L22 6.92 20.59 5.5l-7.09 8-4-4L2 17z"/></svg> <span class=md-ellipsis> Basic RSI strategy </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/superfast-supertrend/ class=md-nav__link> <span class=md-ellipsis> SuperFast SuperTrend </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/signal-development/generation/ class=md-nav__link> <span class=md-ellipsis> Signal development </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/stop-signals/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 23h-2V1h2zm-4-4H5V5h4V3H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h4zM19 7v2h2V7zm0-2h2a2 2 0 0 0-2-2zm2 10h-2v2h2zm-2-4v2h2v-2zm-2-8h-2v2h2zm2 18c1.11 0 2-.89 2-2h-2zm-2-2h-2v2h2z"/></svg> <span class=md-ellipsis> Stop signals </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/mtf-analysis/ class=md-nav__link> <span class=md-ellipsis> MTF analysis </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/portfolio-optimization/ class=md-nav__link> <span class=md-ellipsis> Portfolio optimization </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22 6.92 20.59 5.5l-2.85 3.22C15.68 6.4 12.83 5 9.61 5 6.72 5 4.07 6.16 2 8l1.42 1.42C5.12 7.93 7.27 7 9.61 7c2.74 0 5.09 1.26 6.77 3.24L13.5 13.5l-4-4L2 17l1.5 1.5 6-6 4 4 4.05-4.57c.75 1.35 1.25 2.9 1.45 4.57h2c-.22-2.32-.95-4.41-2.04-6.16z"/></svg> <span class=md-ellipsis> Pairs trading </span> <span class="md-nav__icon md-icon"></span> </label> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/pairs-trading/ class="md-nav__link md-nav__link--active"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22 6.92 20.59 5.5l-2.85 3.22C15.68 6.4 12.83 5 9.61 5 6.72 5 4.07 6.16 2 8l1.42 1.42C5.12 7.93 7.27 7 9.61 7c2.74 0 5.09 1.26 6.77 3.24L13.5 13.5l-4-4L2 17l1.5 1.5 6-6 4 4 4.05-4.57c.75 1.35 1.25 2.9 1.45 4.57h2c-.22-2.32-.95-4.41-2.04-6.16z"/></svg> <span class=md-ellipsis> Pairs trading </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#selection class=md-nav__link> <span class=md-ellipsis> Selection </span> </a> </li> <li class=md-nav__item> <a href=#testing class=md-nav__link> <span class=md-ellipsis> Testing </span> </a> <nav class=md-nav aria-label=Testing> <ul class=md-nav__list> <li class=md-nav__item> <a href=#level-researcher class=md-nav__link> <span class=md-ellipsis> Level: Researcher </span> </a> </li> <li class=md-nav__item> <a href=#level-engineer class=md-nav__link> <span class=md-ellipsis> Level: Engineer </span> </a> </li> <li class=md-nav__item> <a href=#level-architect class=md-nav__link> <span class=md-ellipsis> Level: Architect </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#summary class=md-nav__link> <span class=md-ellipsis> Summary </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/patterns-and-projections/patterns/ class=md-nav__link> <span class=md-ellipsis> Patterns and projections </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/cross-validation/ class=md-nav__link> <span class=md-ellipsis> Cross-validation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/more-tutorials/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10.6 13.4a1 1 0 0 1-1.4 1.4 4.8 4.8 0 0 1 0-7l3.5-3.6a5.1 5.1 0 0 1 7.1 0 5.1 5.1 0 0 1 0 7.1l-1.5 1.5a6.4 6.4 0 0 0-.4-2.4l.5-.5a3.2 3.2 0 0 0 0-4.3 3.2 3.2 0 0 0-4.3 0l-3.5 3.6a2.9 2.9 0 0 0 0 4.2M23 18v2h-3v3h-2v-3h-3v-2h3v-3h2v3m-3.8-4.3a4.8 4.8 0 0 0-1.4-4.5 1 1 0 0 0-1.4 1.4 2.9 2.9 0 0 1 0 4.2l-3.5 3.6a3.2 3.2 0 0 1-4.3 0 3.2 3.2 0 0 1 0-4.3l.5-.4a7.3 7.3 0 0 1-.4-2.5l-1.5 1.5a5.1 5.1 0 0 0 0 7.1 5.1 5.1 0 0 0 7.1 0l1.8-1.8a6 6 0 0 1 3.1-4.3"/></svg> <span class=md-ellipsis> More tutorials </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/to-be-continued/ class=md-nav__link> <span class=md-ellipsis> To be continued... </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/documentation/overview/ class=md-nav__link> <span class=md-ellipsis> Documentation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/overview/ class=md-nav__link> <span class=md-ellipsis> Cookbook </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/api/ class=md-nav__link> <span class=md-ellipsis> API </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/terms/terms-of-use/ class=md-nav__link> <span class=md-ellipsis> Terms </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=pairs-trading><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22 6.92 20.59 5.5l-2.85 3.22C15.68 6.4 12.83 5 9.61 5 6.72 5 4.07 6.16 2 8l1.42 1.42C5.12 7.93 7.27 7 9.61 7c2.74 0 5.09 1.26 6.77 3.24L13.5 13.5l-4-4L2 17l1.5 1.5 6-6 4 4 4.05-4.57c.75 1.35 1.25 2.9 1.45 4.57h2c-.22-2.32-.95-4.41-2.04-6.16z"/></svg></span> Pairs trading<a class=headerlink href=#pairs-trading title="Permanent link">&para;</a></h1> <p>A pairs trading strategy is a statistical arbitrage and convergence strategy based on the historical correlation between two instruments. It involves taking a long position in one instrument and a short position in the other. These offsetting positions create a hedging strategy that aims to profit from both positive and negative trends. A high positive correlation, typically at least 0.8, between the two instruments is the main source of the strategy's profits. When the correlation deviates, we look to buy the underperforming instrument and sell short the outperforming one. If the securities revert to their historical correlation, which is the outcome we aim for, a profit is generated from the convergence of their prices. As a result, pairs trading can be used to seek profits regardless of market conditions, whether the market is trending up, down, or moving sideways.</p> <h2 id=selection>Selection<a class=headerlink href=#selection title="Permanent link">&para;</a></h2> <p>When designing a pairs trading strategy, it is more important to select pairs based on <a href=https://en.wikipedia.org/wiki/Cointegration>cointegration</a> rather than just <a href=https://en.wikipedia.org/wiki/Correlation>correlation</a>. Correlated instruments usually move in a similar way, but over time, the price ratio (or spread) between them may diverge significantly. Cointegrated instruments, however, do not always move together in the same direction: the spread between them can widen on some days, but their prices usually "pull back together" to the mean, providing optimal conditions for pairs arbitrage trading.</p> <p>The two main methods for identifying cointegration are the Engle-Granger test and the Johansen test. We will use the Engle-Granger test, as its augmented version is available in <a href=https://www.statsmodels.org/ ><code>statsmodels</code></a>. The concept behind the Engle-Granger test is straightforward. We perform a linear regression between the two asset prices and check if the residual is stationary using the <a href=https://en.wikipedia.org/wiki/Augmented_Dickey–Fuller_test>Augmented Dickey-Fuller (ADF) test</a>. If the residual is stationary, then the two asset prices are cointegrated.</p> <p>First, let's create a universe of instruments from which to select our pairs. We will search for all available USDT symbols on Binance and download their daily history. Instead of downloading all of them at once, we will fetch each symbol individually and append it to an HDF file. We take this approach because most symbols have limited history, and we want to avoid using extra RAM by extending datasets with NaNs. We will also skip this entire process if the file already exists.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Make sure to delete the HDF file if you want to re-fetch.</p> </div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=kn>from</span><span class=w> </span><span class=nn>vectorbtpro</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>SYMBOLS</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>BinanceData</span><span class=o>.</span><span class=n>list_symbols</span><span class=p>(</span><span class=s2>&quot;*USDT&quot;</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>POOL_FILE</span> <span class=o>=</span> <span class=s2>&quot;temp/data_pool.h5&quot;</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>START</span> <span class=o>=</span> <span class=s2>&quot;2018&quot;</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>END</span> <span class=o>=</span> <span class=s2>&quot;2023&quot;</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># vbt.remove_dir(&quot;temp&quot;, with_contents=True, missing_ok=True)</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>make_dir</span><span class=p>(</span><span class=s2>&quot;temp&quot;</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=gp>&gt;&gt;&gt; </span><span class=k>if</span> <span class=ow>not</span> <span class=n>vbt</span><span class=o>.</span><span class=n>file_exists</span><span class=p>(</span><span class=n>POOL_FILE</span><span class=p>):</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=gp>... </span>    <span class=k>with</span> <span class=n>vbt</span><span class=o>.</span><span class=n>ProgressBar</span><span class=p>(</span><span class=n>total</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>SYMBOLS</span><span class=p>))</span> <span class=k>as</span> <span class=n>pbar</span><span class=p>:</span>  <span class=c1># (3)!</span>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=gp>... </span>        <span class=n>collected</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a><span class=gp>... </span>        <span class=k>for</span> <span class=n>symbol</span> <span class=ow>in</span> <span class=n>SYMBOLS</span><span class=p>:</span>
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a><span class=gp>... </span>            <span class=k>try</span><span class=p>:</span>
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a><span class=gp>... </span>                <span class=n>data</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>BinanceData</span><span class=o>.</span><span class=n>pull</span><span class=p>(</span>
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a><span class=gp>... </span>                    <span class=n>symbol</span><span class=p>,</span> 
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a><span class=gp>... </span>                    <span class=n>start</span><span class=o>=</span><span class=n>START</span><span class=p>,</span>
</span><span id=__span-0-19><a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a><span class=gp>... </span>                    <span class=n>end</span><span class=o>=</span><span class=n>END</span><span class=p>,</span>
</span><span id=__span-0-20><a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a><span class=gp>... </span>                    <span class=n>show_progress</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-0-21><a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a><span class=gp>... </span>                    <span class=n>silence_warnings</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-0-22><a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a><span class=gp>... </span>                <span class=p>)</span>
</span><span id=__span-0-23><a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a><span class=gp>... </span>                <span class=n>data</span><span class=o>.</span><span class=n>to_hdf</span><span class=p>(</span><span class=n>POOL_FILE</span><span class=p>)</span>  <span class=c1># (4)!</span>
</span><span id=__span-0-24><a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a><span class=gp>... </span>                <span class=n>collected</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-0-25><a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a><span class=gp>... </span>            <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span><span id=__span-0-26><a id=__codelineno-0-26 name=__codelineno-0-26 href=#__codelineno-0-26></a><span class=gp>... </span>                <span class=k>pass</span>
</span><span id=__span-0-27><a id=__codelineno-0-27 name=__codelineno-0-27 href=#__codelineno-0-27></a><span class=gp>... </span>            <span class=n>pbar</span><span class=o>.</span><span class=n>set_prefix</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>symbol</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>collected</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>  <span class=c1># (5)!</span>
</span><span id=__span-0-28><a id=__codelineno-0-28 name=__codelineno-0-28 href=#__codelineno-0-28></a><span class=gp>... </span>            <span class=n>pbar</span><span class=o>.</span><span class=n>update</span><span class=p>()</span>
</span></code></pre></div> <ol> <li>Use a wildcard for the base currency to search for all pairs with USDT as the quote currency.</li> <li>Create a temporary directory where all future artifacts will reside.</li> <li>Display a <a href=https://github.com/tqdm/tqdm><code>tqdm</code></a> progress bar.</li> <li>Save each dataset to the same HDF file under <code>POOL_FILE</code>, using the symbol as a key.</li> <li>A descriptive progress bar always helps track the process.</li> </ol> <p> <div class="progress progress-100plus candystripe candystripe-animate"> <div class=progress-bar style=width:100.00%> <p class=progress-label>Symbol 423/423</p> </div> </div> </p> <p>Although this process takes some time, we now have a file containing data for each symbol under its own key. One major advantage of using HDF files (and VBT in particular) is that we can load the entire file and join all contained keys with a single command.</p> <p>We still have one more decision to make: which period should we analyze to select the optimal pair? It is important not to use the same date range for both pair selection and strategy backtesting, as this could introduce survivorship bias. Therefore, let's reserve a more recent period for backtesting.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>SELECT_START</span> <span class=o>=</span> <span class=s2>&quot;2020&quot;</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>SELECT_END</span> <span class=o>=</span> <span class=s2>&quot;2021&quot;</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>HDFData</span><span class=o>.</span><span class=n>pull</span><span class=p>(</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=gp>... </span>    <span class=n>POOL_FILE</span><span class=p>,</span> 
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=gp>... </span>    <span class=n>start</span><span class=o>=</span><span class=n>SELECT_START</span><span class=p>,</span> 
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=gp>... </span>    <span class=n>end</span><span class=o>=</span><span class=n>SELECT_END</span><span class=p>,</span> 
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=gp>... </span>    <span class=n>silence_warnings</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>symbols</span><span class=p>))</span>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a><span class=go>245</span>
</span></code></pre></div> <p>We have imported 245 datasets, but some may be incomplete. To ensure smooth analysis, we should remove the incomplete datasets.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>select</span><span class=p>([</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=gp>... </span>    <span class=n>k</span> 
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>items</span><span class=p>()</span> 
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=gp>... </span>    <span class=k>if</span> <span class=ow>not</span> <span class=n>v</span><span class=o>.</span><span class=n>isnull</span><span class=p>()</span><span class=o>.</span><span class=n>any</span><span class=p>()</span><span class=o>.</span><span class=n>any</span><span class=p>()</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=gp>... </span><span class=p>])</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>symbols</span><span class=p>))</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=go>82</span>
</span></code></pre></div> <p>We have removed a large portion of the incomplete data.</p> <p>The next step is to find the pairs that pass our cointegration test. There are several approaches to finding viable pairs. On one hand, we may have prior knowledge and specifically test a particular pair for cointegration. On the other hand, we can search through hundreds of instruments to find any viable pairs according to the test results. In this exhaustive search scenario, we might encounter a multiple comparisons bias, which is an increased chance of incorrectly identifying a significant p-value when performing many tests. For example, if we run 100 tests on random data, we would expect about 5 p-values below 0.05 just by chance. In practice, we should include a second verification step when identifying pairs in this way, which we will do later.</p> <p>The test itself is performed using <a href=https://www.statsmodels.org/stable/generated/statsmodels.tsa.stattools.coint.html><code>statsmodels.tsa.stattools.coint</code></a>. This function returns a tuple, with the second element being the p-value of interest. Testing each pair would require looping through <code>82 * 82</code> or 6,724 pairs, and since the <code>coint</code> function is not especially fast, we will parallelize the process using <a href=https://pathos.readthedocs.io/en/latest/index.html><code>pathos</code></a> <img alt=⚡ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26a1.svg title=:zap:></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@vbt</span><span class=o>.</span><span class=n>parameterized</span><span class=p>(</span>  <span class=c1># (1)!</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=gp>... </span>    <span class=n>merge_func</span><span class=o>=</span><span class=s2>&quot;concat&quot;</span><span class=p>,</span> 
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=gp>... </span>    <span class=n>engine</span><span class=o>=</span><span class=s2>&quot;pathos&quot;</span><span class=p>,</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=gp>... </span>    <span class=n>distribute</span><span class=o>=</span><span class=s2>&quot;chunks&quot;</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=gp>... </span>    <span class=n>n_chunks</span><span class=o>=</span><span class=s2>&quot;auto&quot;</span>  <span class=c1># (3)!</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>coint_pvalue</span><span class=p>(</span><span class=n>close</span><span class=p>,</span> <span class=n>s1</span><span class=p>,</span> <span class=n>s2</span><span class=p>):</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=gp>... </span>    <span class=kn>import</span><span class=w> </span><span class=nn>statsmodels.tsa.stattools</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>ts</span>  <span class=c1># (4)!</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=gp>... </span>    <span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>ts</span><span class=o>.</span><span class=n>coint</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>close</span><span class=p>[</span><span class=n>s1</span><span class=p>]),</span> <span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>close</span><span class=p>[</span><span class=n>s2</span><span class=p>]))[</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>COINT_FILE</span> <span class=o>=</span> <span class=s2>&quot;temp/coint_pvalues.pickle&quot;</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># vbt.remove_file(COINT_FILE, missing_ok=True)</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a><span class=gp>&gt;&gt;&gt; </span><span class=k>if</span> <span class=ow>not</span> <span class=n>vbt</span><span class=o>.</span><span class=n>file_exists</span><span class=p>(</span><span class=n>COINT_FILE</span><span class=p>):</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a><span class=gp>... </span>    <span class=n>coint_pvalues</span> <span class=o>=</span> <span class=n>coint_pvalue</span><span class=p>(</span>  <span class=c1># (5)!</span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a><span class=gp>... </span>        <span class=n>data</span><span class=o>.</span><span class=n>close</span><span class=p>,</span>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>symbols</span><span class=p>,</span> <span class=n>condition</span><span class=o>=</span><span class=s2>&quot;s1 != s2&quot;</span><span class=p>),</span>  <span class=c1># (6)!</span>
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>symbols</span><span class=p>)</span>
</span><span id=__span-3-20><a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-3-21><a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>coint_pvalues</span><span class=p>,</span> <span class=n>COINT_FILE</span><span class=p>)</span>
</span><span id=__span-3-22><a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a><span class=gp>... </span><span class=k>else</span><span class=p>:</span>
</span><span id=__span-3-23><a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a><span class=gp>... </span>    <span class=n>coint_pvalues</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>COINT_FILE</span><span class=p>)</span>
</span></code></pre></div> <ol> <li>This decorator (<a href=https://vectorbt.pro/pvt_41531c19/api/utils/params/#vectorbtpro.utils.params.parameterized>parameterized</a>) takes arguments wrapped with <a href=https://vectorbt.pro/pvt_41531c19/api/utils/params/#vectorbtpro.utils.params.Param>Param</a>, builds their product, and passes each combination to the underlying function.</li> <li>Build chunks of multiple parameter combinations and process these chunks in parallel, while combinations within each chunk are processed serially.</li> <li>Set the number of chunks to the number of CPU cores.</li> <li>Since we use multiprocessing, each process must import the libraries it will need.</li> <li>The wrapped function takes the same arguments as the underlying function.</li> <li>Do not compare symbols to themselves.</li> </ol> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>Analyzing raw prices can work, but log prices are preferable.</p> </div> <p>The result is a Pandas Series where each pair of symbols in the index is mapped to its p-value. If the p-value is small, below a critical threshold (&lt; 0.05), we can reject the hypothesis that there is no cointegrating relationship. Let's now arrange the p-values in increasing order:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>coint_pvalues</span> <span class=o>=</span> <span class=n>coint_pvalues</span><span class=o>.</span><span class=n>sort_values</span><span class=p>()</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=n>coint_pvalues</span><span class=p>)</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=go>s1        s2      </span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=go>TUSDUSDT  BUSDUSDT    6.179128e-17</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=go>USDCUSDT  BUSDUSDT    7.703666e-14</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=go>BUSDUSDT  USDCUSDT    2.687508e-13</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=go>TUSDUSDT  USDCUSDT    2.906244e-12</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=go>BUSDUSDT  TUSDUSDT    1.853641e-11</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=go>                               ...</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a><span class=go>BTCUSDT   XTZUSDT     1.000000e+00</span>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a><span class=go>          EOSUSDT     1.000000e+00</span>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a><span class=go>          ENJUSDT     1.000000e+00</span>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a><span class=go>          NKNUSDT     1.000000e+00</span>
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=go>ZILUSDT   HBARUSDT    1.000000e+00</span>
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a><span class=go>Length: 6642, dtype: float64</span>
</span></code></pre></div> <p>Is it a coincidence that the most cointegrated pairs are stablecoins? Probably not.</p> <p>Remember the multiple comparisons bias? Let's test the top pairs by plotting their charts below and making sure that the difference between each pair of symbols bounces back and forth around its mean. For example, here is an analysis for the pair <code>(ALGOUSDT, QTUMUSDT)</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>S1</span><span class=p>,</span> <span class=n>S2</span> <span class=o>=</span> <span class=s2>&quot;ALGOUSDT&quot;</span><span class=p>,</span> <span class=s2>&quot;QTUMUSDT&quot;</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>column</span><span class=o>=</span><span class=s2>&quot;Close&quot;</span><span class=p>,</span> <span class=n>symbol</span><span class=o>=</span><span class=p>[</span><span class=n>S1</span><span class=p>,</span> <span class=n>S2</span><span class=p>],</span> <span class=n>base</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pairs-trading/rebased_price.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pairs-trading/rebased_price.dark.svg#only-dark></p> <p>These prices move together.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>S1_log</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>,</span> <span class=n>S1</span><span class=p>))</span>  <span class=c1># (1)!</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>S2_log</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>,</span> <span class=n>S2</span><span class=p>))</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>log_diff</span> <span class=o>=</span> <span class=p>(</span><span class=n>S2_log</span> <span class=o>-</span> <span class=n>S1_log</span><span class=p>)</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=s2>&quot;Log diff&quot;</span><span class=p>)</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span> <span class=o>=</span> <span class=n>log_diff</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>plot</span><span class=p>()</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span><span class=o>.</span><span class=n>add_hline</span><span class=p>(</span><span class=n>y</span><span class=o>=</span><span class=n>log_diff</span><span class=o>.</span><span class=n>mean</span><span class=p>(),</span> <span class=n>line_color</span><span class=o>=</span><span class=s2>&quot;yellow&quot;</span><span class=p>,</span> <span class=n>line_dash</span><span class=o>=</span><span class=s2>&quot;dot&quot;</span><span class=p>)</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <ol> <li>Avoid <code>data.close[S1]</code>, which creates the close series with all symbols first—it is slower!</li> </ol> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pairs-trading/price_log_diff.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pairs-trading/price_log_diff.dark.svg#only-dark></p> <p>The linear combination of the two prices oscillates around the mean.</p> <h2 id=testing>Testing<a class=headerlink href=#testing title="Permanent link">&para;</a></h2> <p>More data is always better. Let's re-fetch our pair's history with higher granularity.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>DATA_FILE</span> <span class=o>=</span> <span class=s2>&quot;temp/data.pickle&quot;</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># vbt.remove_file(DATA_FILE, missing_ok=True)</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=gp>&gt;&gt;&gt; </span><span class=k>if</span> <span class=ow>not</span> <span class=n>vbt</span><span class=o>.</span><span class=n>file_exists</span><span class=p>(</span><span class=n>DATA_FILE</span><span class=p>):</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=gp>... </span>    <span class=n>data</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>BinanceData</span><span class=o>.</span><span class=n>pull</span><span class=p>(</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=gp>... </span>        <span class=p>[</span><span class=n>S1</span><span class=p>,</span> <span class=n>S2</span><span class=p>],</span> 
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=gp>... </span>        <span class=n>start</span><span class=o>=</span><span class=n>SELECT_END</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a><span class=gp>... </span>        <span class=n>end</span><span class=o>=</span><span class=n>END</span><span class=p>,</span> 
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a><span class=gp>... </span>        <span class=n>timeframe</span><span class=o>=</span><span class=s2>&quot;hourly&quot;</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>DATA_FILE</span><span class=p>)</span>
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a><span class=gp>... </span><span class=k>else</span><span class=p>:</span>
</span><span id=__span-7-13><a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a><span class=gp>... </span>    <span class=n>data</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>DATA_FILE</span><span class=p>)</span>
</span><span id=__span-7-14><a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a>
</span><span id=__span-7-15><a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=p>))</span>
</span><span id=__span-7-16><a id=__codelineno-7-16 name=__codelineno-7-16 href=#__codelineno-7-16></a><span class=go>17507</span>
</span></code></pre></div> <ol> <li>The selection and testing periods should not overlap!</li> </ol> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Make sure none of the tickers have been delisted.</p> </div> <p>We now have 17,507 data points for each symbol.</p> <h3 id=level-researcher>Level: Researcher <img alt=📡 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f4e1.svg title=:satellite:><a class=headerlink href=#level-researcher title="Permanent link">&para;</a></h3> <p>The spread represents the relative performance of both instruments. Whenever the two instruments move apart, the spread increases and may reach a certain threshold where we take a long position in the underperformer and a short position in the overachiever. This threshold is usually set to a number of standard deviations from the mean. All of this is done in a rolling manner, as the linear relationship between the instruments is always changing. We will use the prediction error of the <a href=https://en.wikipedia.org/wiki/Ordinary_least_squares>ordinary least squares (OLS)</a>, which is the difference between the true value and the predicted value. Fortunately, we have the <a href=https://vectorbt.pro/pvt_41531c19/api/indicators/custom/ols/#vectorbtpro.indicators.custom.ols.OLS>OLS</a> indicator, which can calculate both the prediction error and the z-score of that error:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=gp>&gt;&gt;&gt; </span><span class=kn>import</span><span class=w> </span><span class=nn>scipy.stats</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>st</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>WINDOW</span> <span class=o>=</span> <span class=mi>24</span> <span class=o>*</span> <span class=mi>30</span>  <span class=c1># (1)!</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>UPPER</span> <span class=o>=</span> <span class=n>st</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>ppf</span><span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=mf>0.05</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>LOWER</span> <span class=o>=</span> <span class=o>-</span><span class=n>st</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>ppf</span><span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=mf>0.05</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>S1_close</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>,</span> <span class=n>S1</span><span class=p>)</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>S2_close</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>,</span> <span class=n>S2</span><span class=p>)</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>ols</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>OLS</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>S1_close</span><span class=p>,</span> <span class=n>S2_close</span><span class=p>,</span> <span class=n>window</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Default</span><span class=p>(</span><span class=n>WINDOW</span><span class=p>))</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>spread</span> <span class=o>=</span> <span class=n>ols</span><span class=o>.</span><span class=n>error</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=s2>&quot;Spread&quot;</span><span class=p>)</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>zscore</span> <span class=o>=</span> <span class=n>ols</span><span class=o>.</span><span class=n>zscore</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=s2>&quot;Z-score&quot;</span><span class=p>)</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>((</span><span class=n>spread</span><span class=p>,</span> <span class=n>zscore</span><span class=p>),</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>))</span>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a><span class=go>                             Spread   Z-score</span>
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a><span class=go>Open time                                    </span>
</span><span id=__span-8-15><a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a><span class=go>2021-01-01 00:00:00+00:00       NaN       NaN</span>
</span><span id=__span-8-16><a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a><span class=go>2021-01-01 01:00:00+00:00       NaN       NaN</span>
</span><span id=__span-8-17><a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a><span class=go>2021-01-01 02:00:00+00:00       NaN       NaN</span>
</span><span id=__span-8-18><a id=__codelineno-8-18 name=__codelineno-8-18 href=#__codelineno-8-18></a><span class=go>2021-01-01 03:00:00+00:00       NaN       NaN</span>
</span><span id=__span-8-19><a id=__codelineno-8-19 name=__codelineno-8-19 href=#__codelineno-8-19></a><span class=go>2021-01-01 04:00:00+00:00       NaN       NaN</span>
</span><span id=__span-8-20><a id=__codelineno-8-20 name=__codelineno-8-20 href=#__codelineno-8-20></a><span class=go>...                             ...       ...</span>
</span><span id=__span-8-21><a id=__codelineno-8-21 name=__codelineno-8-21 href=#__codelineno-8-21></a><span class=go>2022-12-31 19:00:00+00:00 -0.121450 -1.066809</span>
</span><span id=__span-8-22><a id=__codelineno-8-22 name=__codelineno-8-22 href=#__codelineno-8-22></a><span class=go>2022-12-31 20:00:00+00:00 -0.123244 -1.078957</span>
</span><span id=__span-8-23><a id=__codelineno-8-23 name=__codelineno-8-23 href=#__codelineno-8-23></a><span class=go>2022-12-31 21:00:00+00:00 -0.122595 -1.070667</span>
</span><span id=__span-8-24><a id=__codelineno-8-24 name=__codelineno-8-24 href=#__codelineno-8-24></a><span class=go>2022-12-31 22:00:00+00:00 -0.125066 -1.088617</span>
</span><span id=__span-8-25><a id=__codelineno-8-25 name=__codelineno-8-25 href=#__codelineno-8-25></a><span class=go>2022-12-31 23:00:00+00:00 -0.130532 -1.131498</span>
</span><span id=__span-8-26><a id=__codelineno-8-26 name=__codelineno-8-26 href=#__codelineno-8-26></a>
</span><span id=__span-8-27><a id=__codelineno-8-27 name=__codelineno-8-27 href=#__codelineno-8-27></a><span class=go>[17507 rows x 2 columns]</span>
</span></code></pre></div> <ol> <li>One month window.</li> <li>95% significance level across two tails.</li> </ol> <p>Let's plot the z-score, the two thresholds, and the points where the z-score crosses them:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>upper_crossed</span> <span class=o>=</span> <span class=n>zscore</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>crossed_above</span><span class=p>(</span><span class=n>UPPER</span><span class=p>)</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>lower_crossed</span> <span class=o>=</span> <span class=n>zscore</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>crossed_below</span><span class=p>(</span><span class=n>LOWER</span><span class=p>)</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span> <span class=o>=</span> <span class=n>zscore</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>plot</span><span class=p>()</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span><span class=o>.</span><span class=n>add_hline</span><span class=p>(</span><span class=n>y</span><span class=o>=</span><span class=n>UPPER</span><span class=p>,</span> <span class=n>line_color</span><span class=o>=</span><span class=s2>&quot;orangered&quot;</span><span class=p>,</span> <span class=n>line_dash</span><span class=o>=</span><span class=s2>&quot;dot&quot;</span><span class=p>)</span>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span><span class=o>.</span><span class=n>add_hline</span><span class=p>(</span><span class=n>y</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>line_color</span><span class=o>=</span><span class=s2>&quot;yellow&quot;</span><span class=p>,</span> <span class=n>line_dash</span><span class=o>=</span><span class=s2>&quot;dot&quot;</span><span class=p>)</span>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span><span class=o>.</span><span class=n>add_hline</span><span class=p>(</span><span class=n>y</span><span class=o>=</span><span class=n>LOWER</span><span class=p>,</span> <span class=n>line_color</span><span class=o>=</span><span class=s2>&quot;limegreen&quot;</span><span class=p>,</span> <span class=n>line_dash</span><span class=o>=</span><span class=s2>&quot;dot&quot;</span><span class=p>)</span>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>upper_crossed</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>plot_as_exits</span><span class=p>(</span><span class=n>zscore</span><span class=p>,</span> <span class=n>fig</span><span class=o>=</span><span class=n>fig</span><span class=p>)</span>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>lower_crossed</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>plot_as_entries</span><span class=p>(</span><span class=n>zscore</span><span class=p>,</span> <span class=n>fig</span><span class=o>=</span><span class=n>fig</span><span class=p>)</span>
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pairs-trading/zscore.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pairs-trading/zscore.dark.svg#only-dark></p> <p>If you look closely at the chart above, you will notice many signals of the same type appearing one after another. This happens because price fluctuations cause the price to cross each threshold repeatedly. This will not cause any issues if we use <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a> as our simulation method of choice, since it ignores duplicate signals by default.</p> <p>Now, we need to construct proper signal arrays. Keep in mind that pairs trading involves two opposite positions that should be part of a single portfolio. We need to transform our crossover signals into two arrays: long entries and short entries, each with two columns. Whenever there is an upper-threshold crossover signal, we issue a short entry signal for the first asset and a long entry signal for the second asset. Conversely, when there is a lower-threshold crossover signal, we issue a long entry for the first asset and a short entry for the second asset.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>long_entries</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>short_entries</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>short_entries</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>upper_crossed</span><span class=p>,</span> <span class=n>S1</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>long_entries</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>upper_crossed</span><span class=p>,</span> <span class=n>S2</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>long_entries</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>lower_crossed</span><span class=p>,</span> <span class=n>S1</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>short_entries</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>lower_crossed</span><span class=p>,</span> <span class=n>S2</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a>
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=n>long_entries</span><span class=o>.</span><span class=n>sum</span><span class=p>())</span>
</span><span id=__span-10-10><a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a><span class=go>symbol</span>
</span><span id=__span-10-11><a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a><span class=go>ALGOUSDT    52</span>
</span><span id=__span-10-12><a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a><span class=go>QTUMUSDT    73</span>
</span><span id=__span-10-13><a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a><span class=go>dtype: int64</span>
</span><span id=__span-10-14><a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=n>short_entries</span><span class=o>.</span><span class=n>sum</span><span class=p>())</span>
</span><span id=__span-10-15><a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a><span class=go>symbol</span>
</span><span id=__span-10-16><a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a><span class=go>ALGOUSDT    73</span>
</span><span id=__span-10-17><a id=__codelineno-10-17 name=__codelineno-10-17 href=#__codelineno-10-17></a><span class=go>QTUMUSDT    52</span>
</span><span id=__span-10-18><a id=__codelineno-10-18 name=__codelineno-10-18 href=#__codelineno-10-18></a><span class=go>dtype: int64</span>
</span></code></pre></div> <p>Now it is time to simulate our configuration! The position size of each pair should be matched by dollar value rather than number of shares; this way, a 5% move in one matches a 5% move in the other. To avoid running out of cash, we will make each order's position size dependent on the current equity. You might wonder why we can use <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a> even though it does not support target size types. In pairs trading, a position is either opened or reversed (closed out and opened again with the opposite sign), so we do not need target size types at all—regular size types are sufficient.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=gp>... </span>    <span class=n>data</span><span class=p>,</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>long_entries</span><span class=p>,</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=gp>... </span>    <span class=n>short_entries</span><span class=o>=</span><span class=n>short_entries</span><span class=p>,</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;valuepercent100&quot;</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=gp>... </span>    <span class=n>group_by</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>  <span class=c1># (3)!</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=gp>... </span>    <span class=n>cash_sharing</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a><span class=gp>... </span>    <span class=n>call_seq</span><span class=o>=</span><span class=s2>&quot;auto&quot;</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <ol> <li>Open a position whose value matches 10% of the current equity.</li> <li>Size is provided as a percentage of the equity, where 1 = 1%.</li> <li>Pack both positions into the same group, share the same cash balance, and reorder orders so sell orders come before buy orders to release cash early.</li> </ol> <p>The simulation is complete. When working with grouped portfolios that involve rebalancing, we should always check the allocations first to validate them:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span> <span class=o>=</span> <span class=n>pf</span><span class=o>.</span><span class=n>plot_allocations</span><span class=p>()</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>rebalancing_dates</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>unique</span><span class=p>(</span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>idx</span><span class=o>.</span><span class=n>values</span><span class=p>)]</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=gp>&gt;&gt;&gt; </span><span class=k>for</span> <span class=n>date</span> <span class=ow>in</span> <span class=n>rebalancing_dates</span><span class=p>:</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=gp>... </span>    <span class=n>fig</span><span class=o>.</span><span class=n>add_vline</span><span class=p>(</span><span class=n>x</span><span class=o>=</span><span class=n>date</span><span class=p>,</span> <span class=n>line_color</span><span class=o>=</span><span class=s2>&quot;teal&quot;</span><span class=p>,</span> <span class=n>line_dash</span><span class=o>=</span><span class=s2>&quot;dot&quot;</span><span class=p>)</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pairs-trading/from_signals_allocations.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pairs-trading/from_signals_allocations.dark.svg#only-dark></p> <p>The result makes sense: positions in both symbols are constantly switching, almost like watching a chessboard. Also, the long and short allocations rarely go above the specified 10% position size. Now, we should calculate the portfolio statistics to evaluate the profitability of our strategy:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>stats</span><span class=p>()</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=go>Start                          2021-01-01 00:00:00+00:00</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=go>End                            2022-12-31 23:00:00+00:00</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=go>Period                                 729 days 11:00:00</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=go>Start Value                                        100.0</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=go>Min Value                                      96.401924</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=go>Max Value                                     127.670782</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=go>End Value                                     119.930329</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=go>Total Return [%]                               19.930329</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a><span class=go>Benchmark Return [%]                          -34.051206</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a><span class=go>Total Time Exposure [%]                        89.946878</span>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12 href=#__codelineno-13-12></a><span class=go>Max Gross Exposure [%]                          12.17734</span>
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13 href=#__codelineno-13-13></a><span class=go>Max Drawdown [%]                                8.592299</span>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14 href=#__codelineno-13-14></a><span class=go>Max Drawdown Duration                  318 days 00:00:00</span>
</span><span id=__span-13-15><a id=__codelineno-13-15 name=__codelineno-13-15 href=#__codelineno-13-15></a><span class=go>Total Orders                                          34</span>
</span><span id=__span-13-16><a id=__codelineno-13-16 name=__codelineno-13-16 href=#__codelineno-13-16></a><span class=go>Total Fees Paid                                      0.0</span>
</span><span id=__span-13-17><a id=__codelineno-13-17 name=__codelineno-13-17 href=#__codelineno-13-17></a><span class=go>Total Trades                                          34</span>
</span><span id=__span-13-18><a id=__codelineno-13-18 name=__codelineno-13-18 href=#__codelineno-13-18></a><span class=go>Win Rate [%]                                       43.75</span>
</span><span id=__span-13-19><a id=__codelineno-13-19 name=__codelineno-13-19 href=#__codelineno-13-19></a><span class=go>Best Trade [%]                                160.511614</span>
</span><span id=__span-13-20><a id=__codelineno-13-20 name=__codelineno-13-20 href=#__codelineno-13-20></a><span class=go>Worst Trade [%]                               -54.796964</span>
</span><span id=__span-13-21><a id=__codelineno-13-21 name=__codelineno-13-21 href=#__codelineno-13-21></a><span class=go>Avg Winning Trade [%]                          41.851493</span>
</span><span id=__span-13-22><a id=__codelineno-13-22 name=__codelineno-13-22 href=#__codelineno-13-22></a><span class=go>Avg Losing Trade [%]                          -20.499826</span>
</span><span id=__span-13-23><a id=__codelineno-13-23 name=__codelineno-13-23 href=#__codelineno-13-23></a><span class=go>Avg Winning Trade Duration    42 days 22:04:17.142857143</span>
</span><span id=__span-13-24><a id=__codelineno-13-24 name=__codelineno-13-24 href=#__codelineno-13-24></a><span class=go>Avg Losing Trade Duration               33 days 14:43:20</span>
</span><span id=__span-13-25><a id=__codelineno-13-25 name=__codelineno-13-25 href=#__codelineno-13-25></a><span class=go>Profit Factor                                   1.553538</span>
</span><span id=__span-13-26><a id=__codelineno-13-26 name=__codelineno-13-26 href=#__codelineno-13-26></a><span class=go>Expectancy                                      0.713595</span>
</span><span id=__span-13-27><a id=__codelineno-13-27 name=__codelineno-13-27 href=#__codelineno-13-27></a><span class=go>Sharpe Ratio                                    0.782316</span>
</span><span id=__span-13-28><a id=__codelineno-13-28 name=__codelineno-13-28 href=#__codelineno-13-28></a><span class=go>Calmar Ratio                                     1.10712</span>
</span><span id=__span-13-29><a id=__codelineno-13-29 name=__codelineno-13-29 href=#__codelineno-13-29></a><span class=go>Omega Ratio                                     1.034258</span>
</span><span id=__span-13-30><a id=__codelineno-13-30 name=__codelineno-13-30 href=#__codelineno-13-30></a><span class=go>Sortino Ratio                                   1.221721</span>
</span><span id=__span-13-31><a id=__codelineno-13-31 name=__codelineno-13-31 href=#__codelineno-13-31></a><span class=go>Name: group, dtype: object</span>
</span></code></pre></div> <p>We gained almost 20% from the initial portfolio value—a comfortable win, especially considering that the benchmark is down nearly 35%. As expected, the portfolio was in a position 90% of the time; the only period without a position was the initial phase before the first signal. Even with a win rate below 50%, we were profitable because the average winning trade returned 50% more profit than the average loss, resulting in a long-term profit of $0.70 per trade.</p> <p>But how can we verify that the simulation closely mirrors the signals it is based on? To do this, we can reframe our problem as a portfolio optimization task: we will mark the points where the z-score crosses any of the thresholds as allocation points and assign the corresponding weights at those times. This is very straightforward using <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer>PortfolioOptimizer</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>allocations</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>()</span>  <span class=c1># (1)!</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>allocations</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>upper_crossed</span><span class=p>,</span> <span class=n>S1</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mf>0.1</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>allocations</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>upper_crossed</span><span class=p>,</span> <span class=n>S2</span><span class=p>]</span> <span class=o>=</span> <span class=mf>0.1</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>allocations</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>lower_crossed</span><span class=p>,</span> <span class=n>S1</span><span class=p>]</span> <span class=o>=</span> <span class=mf>0.1</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>allocations</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>lower_crossed</span><span class=p>,</span> <span class=n>S2</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mf>0.1</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_filled_allocations</span><span class=p>(</span><span class=n>allocations</span><span class=p>)</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=n>pfo</span><span class=o>.</span><span class=n>allocations</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a><span class=go>symbol                     ALGOUSDT  QTUMUSDT</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=go>Open time                                    </span>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a><span class=go>2021-03-15 10:00:00+00:00       0.1      -0.1</span>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a><span class=go>2021-03-23 03:00:00+00:00      -0.1       0.1</span>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a><span class=go>2021-04-17 14:00:00+00:00       0.1      -0.1</span>
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14 href=#__codelineno-14-14></a><span class=go>2021-04-19 00:00:00+00:00      -0.1       0.1</span>
</span><span id=__span-14-15><a id=__codelineno-14-15 name=__codelineno-14-15 href=#__codelineno-14-15></a><span class=go>2021-06-03 16:00:00+00:00       0.1      -0.1</span>
</span><span id=__span-14-16><a id=__codelineno-14-16 name=__codelineno-14-16 href=#__codelineno-14-16></a><span class=go>2021-06-30 22:00:00+00:00      -0.1       0.1</span>
</span><span id=__span-14-17><a id=__codelineno-14-17 name=__codelineno-14-17 href=#__codelineno-14-17></a><span class=go>2021-08-19 06:00:00+00:00       0.1      -0.1</span>
</span><span id=__span-14-18><a id=__codelineno-14-18 name=__codelineno-14-18 href=#__codelineno-14-18></a><span class=go>2021-10-02 21:00:00+00:00      -0.1       0.1</span>
</span><span id=__span-14-19><a id=__codelineno-14-19 name=__codelineno-14-19 href=#__codelineno-14-19></a><span class=go>2021-11-12 03:00:00+00:00       0.1      -0.1</span>
</span><span id=__span-14-20><a id=__codelineno-14-20 name=__codelineno-14-20 href=#__codelineno-14-20></a><span class=go>2022-02-02 09:00:00+00:00      -0.1       0.1</span>
</span><span id=__span-14-21><a id=__codelineno-14-21 name=__codelineno-14-21 href=#__codelineno-14-21></a><span class=go>2022-04-28 21:00:00+00:00       0.1      -0.1</span>
</span><span id=__span-14-22><a id=__codelineno-14-22 name=__codelineno-14-22 href=#__codelineno-14-22></a><span class=go>2022-07-22 02:00:00+00:00      -0.1       0.1</span>
</span><span id=__span-14-23><a id=__codelineno-14-23 name=__codelineno-14-23 href=#__codelineno-14-23></a><span class=go>2022-09-04 01:00:00+00:00       0.1      -0.1</span>
</span><span id=__span-14-24><a id=__codelineno-14-24 name=__codelineno-14-24 href=#__codelineno-14-24></a><span class=go>2022-09-27 03:00:00+00:00      -0.1       0.1</span>
</span><span id=__span-14-25><a id=__codelineno-14-25 name=__codelineno-14-25 href=#__codelineno-14-25></a><span class=go>2022-10-13 10:00:00+00:00       0.1      -0.1</span>
</span><span id=__span-14-26><a id=__codelineno-14-26 name=__codelineno-14-26 href=#__codelineno-14-26></a><span class=go>2022-10-23 19:00:00+00:00      -0.1       0.1</span>
</span><span id=__span-14-27><a id=__codelineno-14-27 name=__codelineno-14-27 href=#__codelineno-14-27></a><span class=go>2022-11-08 20:00:00+00:00       0.1      -0.1</span>
</span><span id=__span-14-28><a id=__codelineno-14-28 name=__codelineno-14-28 href=#__codelineno-14-28></a>
</span><span id=__span-14-29><a id=__codelineno-14-29 name=__codelineno-14-29 href=#__codelineno-14-29></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>plot</span><span class=p>()</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <ol> <li>Build an array of weights.</li> <li>Get a compressed allocations array.</li> </ol> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pairs-trading/optimizer.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pairs-trading/optimizer.dark.svg#only-dark></p> <p>There is also a convenient method to simulate the optimizer:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>pfo</span><span class=o>.</span><span class=n>simulate</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>pf_method</span><span class=o>=</span><span class=s2>&quot;from_signals&quot;</span><span class=p>)</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>total_return</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=go>0.19930328736504038</span>
</span></code></pre></div> <div class="admonition info"> <p class=admonition-title>Info</p> <p>This method is based on a dynamic signal function that converts target percentages into signals, so the first compilation may take up to a minute (after that, it will be extremely fast). You can also omit the <code>pf_method</code> argument to use the cacheable <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_orders>Portfolio.from_orders</a> with similar results.</p> </div> <p>What about parameter optimization? There are several parts of the code that are open for parameterization. The signal generation is affected by the <code>WINDOW</code>, <code>UPPER</code>, and <code>LOWER</code> parameters. The simulation part offers more flexibility; for example, you can add stops to limit your exposure to adverse price movements. Let's start with the signal generation.</p> <p>A key challenge is how to combine the <code>UPPER</code> and <code>LOWER</code> parameters. We cannot simply pass them to their respective crossover functions and expect the results to align; we need to unify the resulting columns before combining them later. One useful approach is to build a meta-indicator that encapsulates other indicators and handles multiple parameter combinations automatically:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>PTS_expr</span> <span class=o>=</span> <span class=s2>&quot;&quot;&quot;</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=gp>... </span><span class=s2>    PTS:</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=gp>... </span><span class=s2>    x = @in_close.iloc[:, 0]</span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=gp>... </span><span class=s2>    y = @in_close.iloc[:, 1]</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=gp>... </span><span class=s2>    ols = vbt.OLS.run(x, y, window=@p_window, hide_params=True)</span>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=gp>... </span><span class=s2>    upper = st.norm.ppf(1 - @p_upper_alpha / 2)</span>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=gp>... </span><span class=s2>    lower = -st.norm.ppf(1 - @p_lower_alpha / 2)</span>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a><span class=gp>... </span><span class=s2>    upper_crossed = ols.zscore.vbt.crossed_above(upper)</span>
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a><span class=gp>... </span><span class=s2>    lower_crossed = ols.zscore.vbt.crossed_below(lower)</span>
</span><span id=__span-16-10><a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a><span class=gp>... </span><span class=s2>    long_entries = wrapper.fill(False)</span>
</span><span id=__span-16-11><a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a><span class=gp>... </span><span class=s2>    short_entries = wrapper.fill(False)</span>
</span><span id=__span-16-12><a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a><span class=gp>... </span><span class=s2>    short_entries.loc[upper_crossed, x.name] = True</span>
</span><span id=__span-16-13><a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a><span class=gp>... </span><span class=s2>    long_entries.loc[upper_crossed, y.name] = True</span>
</span><span id=__span-16-14><a id=__codelineno-16-14 name=__codelineno-16-14 href=#__codelineno-16-14></a><span class=gp>... </span><span class=s2>    long_entries.loc[lower_crossed, x.name] = True</span>
</span><span id=__span-16-15><a id=__codelineno-16-15 name=__codelineno-16-15 href=#__codelineno-16-15></a><span class=gp>... </span><span class=s2>    short_entries.loc[lower_crossed, y.name] = True</span>
</span><span id=__span-16-16><a id=__codelineno-16-16 name=__codelineno-16-16 href=#__codelineno-16-16></a><span class=gp>... </span><span class=s2>    long_entries, short_entries</span>
</span><span id=__span-16-17><a id=__codelineno-16-17 name=__codelineno-16-17 href=#__codelineno-16-17></a><span class=gp>... </span><span class=s2>&quot;&quot;&quot;</span>
</span><span id=__span-16-18><a id=__codelineno-16-18 name=__codelineno-16-18 href=#__codelineno-16-18></a>
</span><span id=__span-16-19><a id=__codelineno-16-19 name=__codelineno-16-19 href=#__codelineno-16-19></a><span class=gp>&gt;&gt;&gt; </span><span class=n>PTS</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>IF</span><span class=o>.</span><span class=n>from_expr</span><span class=p>(</span><span class=n>PTS_expr</span><span class=p>,</span> <span class=n>keep_pd</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>st</span><span class=o>=</span><span class=n>st</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-16-20><a id=__codelineno-16-20 name=__codelineno-16-20 href=#__codelineno-16-20></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>phelp</span><span class=p>(</span><span class=n>PTS</span><span class=o>.</span><span class=n>run</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-16-21><a id=__codelineno-16-21 name=__codelineno-16-21 href=#__codelineno-16-21></a><span class=go>PTS.run(</span>
</span><span id=__span-16-22><a id=__codelineno-16-22 name=__codelineno-16-22 href=#__codelineno-16-22></a><span class=go>    close,</span>
</span><span id=__span-16-23><a id=__codelineno-16-23 name=__codelineno-16-23 href=#__codelineno-16-23></a><span class=go>    window,</span>
</span><span id=__span-16-24><a id=__codelineno-16-24 name=__codelineno-16-24 href=#__codelineno-16-24></a><span class=go>    upper_alpha,</span>
</span><span id=__span-16-25><a id=__codelineno-16-25 name=__codelineno-16-25 href=#__codelineno-16-25></a><span class=go>    lower_alpha,</span>
</span><span id=__span-16-26><a id=__codelineno-16-26 name=__codelineno-16-26 href=#__codelineno-16-26></a><span class=go>    short_name=&#39;pts&#39;,</span>
</span><span id=__span-16-27><a id=__codelineno-16-27 name=__codelineno-16-27 href=#__codelineno-16-27></a><span class=go>    hide_params=None,</span>
</span><span id=__span-16-28><a id=__codelineno-16-28 name=__codelineno-16-28 href=#__codelineno-16-28></a><span class=go>    hide_default=True,</span>
</span><span id=__span-16-29><a id=__codelineno-16-29 name=__codelineno-16-29 href=#__codelineno-16-29></a><span class=go>    **kwargs</span>
</span><span id=__span-16-30><a id=__codelineno-16-30 name=__codelineno-16-30 href=#__codelineno-16-30></a><span class=go>):</span>
</span><span id=__span-16-31><a id=__codelineno-16-31 name=__codelineno-16-31 href=#__codelineno-16-31></a><span class=go>    Run `PTS` indicator.</span>
</span><span id=__span-16-32><a id=__codelineno-16-32 name=__codelineno-16-32 href=#__codelineno-16-32></a>
</span><span id=__span-16-33><a id=__codelineno-16-33 name=__codelineno-16-33 href=#__codelineno-16-33></a><span class=go>    * Inputs: `close`</span>
</span><span id=__span-16-34><a id=__codelineno-16-34 name=__codelineno-16-34 href=#__codelineno-16-34></a><span class=go>    * Parameters: `window`, `upper_alpha`, `lower_alpha`</span>
</span><span id=__span-16-35><a id=__codelineno-16-35 name=__codelineno-16-35 href=#__codelineno-16-35></a><span class=go>    * Outputs: `long_entries`, `short_entries`</span>
</span></code></pre></div> <ol> <li>By default, the factory passes two-dimensional NumPy arrays. Use <code>keep_pd</code> to pass Pandas objects instead. Also, since expressions are processed in isolation from global variables, specify any variables that cannot be parsed.</li> <li>Verify the parsed input, parameter, and output names.</li> </ol> <p>Our goal was to create an indicator that accepts an input array with two columns (representing assets), runs our pipeline, and returns two signal arrays, each with two columns. To accomplish this, we wrote an expression that is standard Python code but includes some useful enhancements. For example, we defined the variable <code>close</code> as an input array by using the prefix <code>@in_</code>. Additionally, we marked the three parameters—<code>window</code>, <code>upper_alpha</code>, and <code>lower_alpha</code>—by adding the prefix <code>@p_</code>. When we run the expression, the indicator factory replaces <code>@in_close</code> with our close prices and <code>@p_window</code>, <code>@p_upper_alpha</code>, and <code>@p_lower_alpha</code> with the specified parameter values. The factory also automatically recognizes well-known variables such as <code>vbt</code> and <code>wrapper</code>, substituting them with the VBT module and the current Pandas wrapper. The last line lists the variables we want to return, and their names will automatically be used as output names.</p> <p>Now, let's run this indicator across a grid of parameter combinations we want to test. Keep in mind that wide parameter grids can lead to out-of-memory errors: each parameter combination generates multiple arrays of the same shape as the data. To address this, you can use random search to efficiently reduce the number of parameter combinations.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>WINDOW_SPACE</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=mi>50</span><span class=p>)</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>  <span class=c1># (1)!</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>ALPHA_SPACE</span> <span class=o>=</span> <span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span> <span class=o>/</span> <span class=mi>1000</span><span class=p>)</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>  <span class=c1># (2)!</span>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>long_entries</span><span class=p>,</span> <span class=n>short_entries</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>  <span class=c1># (3)!</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=gp>... </span>    <span class=n>PTS</span><span class=p>,</span> 
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=gp>... </span>    <span class=n>window</span><span class=o>=</span><span class=n>WINDOW_SPACE</span><span class=p>,</span>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a><span class=gp>... </span>    <span class=n>upper_alpha</span><span class=o>=</span><span class=n>ALPHA_SPACE</span><span class=p>,</span>
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a><span class=gp>... </span>    <span class=n>lower_alpha</span><span class=o>=</span><span class=n>ALPHA_SPACE</span><span class=p>,</span>
</span><span id=__span-17-9><a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a><span class=gp>... </span>    <span class=n>param_product</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-17-10><a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a><span class=gp>... </span>    <span class=n>random_subset</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span>  <span class=c1># (4)!</span>
</span><span id=__span-17-11><a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a><span class=gp>... </span>    <span class=n>seed</span><span class=o>=</span><span class=mi>42</span><span class=p>,</span>  <span class=c1># (5)!</span>
</span><span id=__span-17-12><a id=__codelineno-17-12 name=__codelineno-17-12 href=#__codelineno-17-12></a><span class=gp>... </span>    <span class=n>unpack</span><span class=o>=</span><span class=kc>True</span>  <span class=c1># (6)!</span>
</span><span id=__span-17-13><a id=__codelineno-17-13 name=__codelineno-17-13 href=#__codelineno-17-13></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-17-14><a id=__codelineno-17-14 name=__codelineno-17-14 href=#__codelineno-17-14></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=n>long_entries</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span>
</span><span id=__span-17-15><a id=__codelineno-17-15 name=__codelineno-17-15 href=#__codelineno-17-15></a><span class=go>MultiIndex([( 5, 0.007,  0.09, &#39;ALGOUSDT&#39;),</span>
</span><span id=__span-17-16><a id=__codelineno-17-16 name=__codelineno-17-16 href=#__codelineno-17-16></a><span class=go>            ( 5, 0.007,  0.09, &#39;QTUMUSDT&#39;),</span>
</span><span id=__span-17-17><a id=__codelineno-17-17 name=__codelineno-17-17 href=#__codelineno-17-17></a><span class=go>            ( 5, 0.009, 0.086, &#39;ALGOUSDT&#39;),</span>
</span><span id=__span-17-18><a id=__codelineno-17-18 name=__codelineno-17-18 href=#__codelineno-17-18></a><span class=go>            ( 5, 0.009, 0.086, &#39;QTUMUSDT&#39;),</span>
</span><span id=__span-17-19><a id=__codelineno-17-19 name=__codelineno-17-19 href=#__codelineno-17-19></a><span class=go>            ( 5, 0.015, 0.082, &#39;ALGOUSDT&#39;),</span>
</span><span id=__span-17-20><a id=__codelineno-17-20 name=__codelineno-17-20 href=#__codelineno-17-20></a><span class=go>            ...</span>
</span><span id=__span-17-21><a id=__codelineno-17-21 name=__codelineno-17-21 href=#__codelineno-17-21></a><span class=go>            (49, 0.091, 0.094, &#39;QTUMUSDT&#39;),</span>
</span><span id=__span-17-22><a id=__codelineno-17-22 name=__codelineno-17-22 href=#__codelineno-17-22></a><span class=go>            (49, 0.094, 0.054, &#39;ALGOUSDT&#39;),</span>
</span><span id=__span-17-23><a id=__codelineno-17-23 name=__codelineno-17-23 href=#__codelineno-17-23></a><span class=go>            (49, 0.094, 0.054, &#39;QTUMUSDT&#39;),</span>
</span><span id=__span-17-24><a id=__codelineno-17-24 name=__codelineno-17-24 href=#__codelineno-17-24></a><span class=go>            (49, 0.095, 0.074, &#39;ALGOUSDT&#39;),</span>
</span><span id=__span-17-25><a id=__codelineno-17-25 name=__codelineno-17-25 href=#__codelineno-17-25></a><span class=go>            (49, 0.095, 0.074, &#39;QTUMUSDT&#39;)],</span>
</span><span id=__span-17-26><a id=__codelineno-17-26 name=__codelineno-17-26 href=#__codelineno-17-26></a><span class=go>           names=[&#39;pts_window&#39;, &#39;pts_upper_alpha&#39;, &#39;pts_lower_alpha&#39;, &#39;symbol&#39;], length=2000)</span>
</span></code></pre></div> <ol> <li>Test window values from 5 to 49.</li> <li>Test alphas for the upper threshold from 0.1% to 10%.</li> <li>Use <a href=https://vectorbt.pro/pvt_41531c19/api/data/base/#vectorbtpro.data.base.Data.run>Data.run</a> to execute an indicator.</li> <li>Randomly select 1,000 parameter combinations.</li> <li>Make the results deterministic by setting a seed.</li> <li>Return the output arrays instead of an indicator instance.</li> </ol> <p>We used a data instance and instructed it to inspect the <code>PTS</code> indicator, find its input names among the arrays stored in the data instance, and pass these arrays along with the parameters to the indicator. This approach allows us to avoid dealing directly with input and output names <img alt=🎉 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f389.svg title=:tada:></p> <p>So, which parameter combinations are the most profitable?</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=gp>... </span>    <span class=n>data</span><span class=p>,</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>long_entries</span><span class=p>,</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=gp>... </span>    <span class=n>short_entries</span><span class=o>=</span><span class=n>short_entries</span><span class=p>,</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;valuepercent100&quot;</span><span class=p>,</span>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a><span class=gp>... </span>    <span class=n>group_by</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>ExceptLevel</span><span class=p>(</span><span class=s2>&quot;symbol&quot;</span><span class=p>),</span>  <span class=c1># (1)!</span>
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a><span class=gp>... </span>    <span class=n>cash_sharing</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a><span class=gp>... </span>    <span class=n>call_seq</span><span class=o>=</span><span class=s2>&quot;auto&quot;</span>
</span><span id=__span-18-10><a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-18-11><a id=__codelineno-18-11 name=__codelineno-18-11 href=#__codelineno-18-11></a>
</span><span id=__span-18-12><a id=__codelineno-18-12 name=__codelineno-18-12 href=#__codelineno-18-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>opt_results</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>((</span>
</span><span id=__span-18-13><a id=__codelineno-18-13 name=__codelineno-18-13 href=#__codelineno-18-13></a><span class=gp>... </span>    <span class=n>pf</span><span class=o>.</span><span class=n>total_return</span><span class=p>,</span>
</span><span id=__span-18-14><a id=__codelineno-18-14 name=__codelineno-18-14 href=#__codelineno-18-14></a><span class=gp>... </span>    <span class=n>pf</span><span class=o>.</span><span class=n>trades</span><span class=o>.</span><span class=n>expectancy</span><span class=p>,</span>
</span><span id=__span-18-15><a id=__codelineno-18-15 name=__codelineno-18-15 href=#__codelineno-18-15></a><span class=gp>... </span><span class=p>),</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-18-16><a id=__codelineno-18-16 name=__codelineno-18-16 href=#__codelineno-18-16></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=n>opt_results</span><span class=o>.</span><span class=n>sort_values</span><span class=p>(</span><span class=n>by</span><span class=o>=</span><span class=s2>&quot;total_return&quot;</span><span class=p>,</span> <span class=n>ascending</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>
</span><span id=__span-18-17><a id=__codelineno-18-17 name=__codelineno-18-17 href=#__codelineno-18-17></a><span class=go>                                            total_return  expectancy</span>
</span><span id=__span-18-18><a id=__codelineno-18-18 name=__codelineno-18-18 href=#__codelineno-18-18></a><span class=go>pts_window pts_upper_alpha pts_lower_alpha                          </span>
</span><span id=__span-18-19><a id=__codelineno-18-19 name=__codelineno-18-19 href=#__codelineno-18-19></a><span class=go>41         0.076           0.001                0.503014    0.399218</span>
</span><span id=__span-18-20><a id=__codelineno-18-20 name=__codelineno-18-20 href=#__codelineno-18-20></a><span class=go>15         0.079           0.001                0.489249    2.718049</span>
</span><span id=__span-18-21><a id=__codelineno-18-21 name=__codelineno-18-21 href=#__codelineno-18-21></a><span class=go>16         0.023           0.016                0.474538    0.104986</span>
</span><span id=__span-18-22><a id=__codelineno-18-22 name=__codelineno-18-22 href=#__codelineno-18-22></a><span class=go>6          0.078           0.048                0.445623    0.057574</span>
</span><span id=__span-18-23><a id=__codelineno-18-23 name=__codelineno-18-23 href=#__codelineno-18-23></a><span class=go>41         0.028           0.001                0.441388    0.387182</span>
</span><span id=__span-18-24><a id=__codelineno-18-24 name=__codelineno-18-24 href=#__codelineno-18-24></a><span class=go>...                                                  ...         ...</span>
</span><span id=__span-18-25><a id=__codelineno-18-25 name=__codelineno-18-25 href=#__codelineno-18-25></a><span class=go>43         0.003           0.004               -0.263967   -0.131984</span>
</span><span id=__span-18-26><a id=__codelineno-18-26 name=__codelineno-18-26 href=#__codelineno-18-26></a><span class=go>15         0.002           0.049               -0.273170   -0.182113</span>
</span><span id=__span-18-27><a id=__codelineno-18-27 name=__codelineno-18-27 href=#__codelineno-18-27></a><span class=go>42         0.002           0.036               -0.316947   -0.110821</span>
</span><span id=__span-18-28><a id=__codelineno-18-28 name=__codelineno-18-28 href=#__codelineno-18-28></a><span class=go>35         0.001           0.008               -0.330056   -0.196462</span>
</span><span id=__span-18-29><a id=__codelineno-18-29 name=__codelineno-18-29 href=#__codelineno-18-29></a><span class=go>41         0.001           0.015               -0.363547   -0.191341</span>
</span><span id=__span-18-30><a id=__codelineno-18-30 name=__codelineno-18-30 href=#__codelineno-18-30></a>
</span><span id=__span-18-31><a id=__codelineno-18-31 name=__codelineno-18-31 href=#__codelineno-18-31></a><span class=go>[1000 rows x 2 columns]</span>
</span></code></pre></div> <ol> <li>Do not group symbols; in other words, group by parameter combination.</li> </ol> <p>Now, let's proceed to the second optimization step. Pick one parameter combination from above and test various stop configurations using <a href=https://vectorbt.pro/pvt_41531c19/api/utils/params/#vectorbtpro.utils.params.Param>Param</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>best_index</span> <span class=o>=</span> <span class=n>opt_results</span><span class=o>.</span><span class=n>idxmax</span><span class=p>()[</span><span class=s2>&quot;expectancy&quot;</span><span class=p>]</span>  <span class=c1># (1)!</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>best_long_entries</span> <span class=o>=</span> <span class=n>long_entries</span><span class=p>[</span><span class=n>best_index</span><span class=p>]</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>best_short_entries</span> <span class=o>=</span> <span class=n>short_entries</span><span class=p>[</span><span class=n>best_index</span><span class=p>]</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>STOP_SPACE</span> <span class=o>=</span> <span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>]</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>  <span class=c1># (2)!</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a><span class=gp>... </span>    <span class=n>data</span><span class=p>,</span>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a><span class=gp>... </span>    <span class=n>entries</span><span class=o>=</span><span class=n>best_long_entries</span><span class=p>,</span>
</span><span id=__span-19-9><a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a><span class=gp>... </span>    <span class=n>short_entries</span><span class=o>=</span><span class=n>best_short_entries</span><span class=p>,</span>
</span><span id=__span-19-10><a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>
</span><span id=__span-19-11><a id=__codelineno-19-11 name=__codelineno-19-11 href=#__codelineno-19-11></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;valuepercent100&quot;</span><span class=p>,</span>
</span><span id=__span-19-12><a id=__codelineno-19-12 name=__codelineno-19-12 href=#__codelineno-19-12></a><span class=gp>... </span>    <span class=n>group_by</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>ExceptLevel</span><span class=p>(</span><span class=s2>&quot;symbol&quot;</span><span class=p>),</span>
</span><span id=__span-19-13><a id=__codelineno-19-13 name=__codelineno-19-13 href=#__codelineno-19-13></a><span class=gp>... </span>    <span class=n>cash_sharing</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-19-14><a id=__codelineno-19-14 name=__codelineno-19-14 href=#__codelineno-19-14></a><span class=gp>... </span>    <span class=n>call_seq</span><span class=o>=</span><span class=s2>&quot;auto&quot;</span><span class=p>,</span>
</span><span id=__span-19-15><a id=__codelineno-19-15 name=__codelineno-19-15 href=#__codelineno-19-15></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span><span class=n>STOP_SPACE</span><span class=p>),</span>  <span class=c1># (3)!</span>
</span><span id=__span-19-16><a id=__codelineno-19-16 name=__codelineno-19-16 href=#__codelineno-19-16></a><span class=gp>... </span>    <span class=n>tsl_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span><span class=n>STOP_SPACE</span><span class=p>),</span>
</span><span id=__span-19-17><a id=__codelineno-19-17 name=__codelineno-19-17 href=#__codelineno-19-17></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span><span class=n>STOP_SPACE</span><span class=p>),</span>
</span><span id=__span-19-18><a id=__codelineno-19-18 name=__codelineno-19-18 href=#__codelineno-19-18></a><span class=gp>... </span>    <span class=n>delta_format</span><span class=o>=</span><span class=s2>&quot;percent100&quot;</span><span class=p>,</span>  <span class=c1># (4)!</span>
</span><span id=__span-19-19><a id=__codelineno-19-19 name=__codelineno-19-19 href=#__codelineno-19-19></a><span class=gp>... </span>    <span class=n>stop_exit_price</span><span class=o>=</span><span class=s2>&quot;close&quot;</span><span class=p>,</span>  <span class=c1># (5)!</span>
</span><span id=__span-19-20><a id=__codelineno-19-20 name=__codelineno-19-20 href=#__codelineno-19-20></a><span class=gp>... </span>    <span class=n>broadcast_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>random_subset</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span> <span class=n>seed</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>  <span class=c1># (6)!</span>
</span><span id=__span-19-21><a id=__codelineno-19-21 name=__codelineno-19-21 href=#__codelineno-19-21></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-19-22><a id=__codelineno-19-22 name=__codelineno-19-22 href=#__codelineno-19-22></a>
</span><span id=__span-19-23><a id=__codelineno-19-23 name=__codelineno-19-23 href=#__codelineno-19-23></a><span class=gp>&gt;&gt;&gt; </span><span class=n>opt_results</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>((</span>
</span><span id=__span-19-24><a id=__codelineno-19-24 name=__codelineno-19-24 href=#__codelineno-19-24></a><span class=gp>... </span>    <span class=n>pf</span><span class=o>.</span><span class=n>total_return</span><span class=p>,</span>
</span><span id=__span-19-25><a id=__codelineno-19-25 name=__codelineno-19-25 href=#__codelineno-19-25></a><span class=gp>... </span>    <span class=n>pf</span><span class=o>.</span><span class=n>trades</span><span class=o>.</span><span class=n>expectancy</span><span class=p>,</span>
</span><span id=__span-19-26><a id=__codelineno-19-26 name=__codelineno-19-26 href=#__codelineno-19-26></a><span class=gp>... </span><span class=p>),</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-19-27><a id=__codelineno-19-27 name=__codelineno-19-27 href=#__codelineno-19-27></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=n>opt_results</span><span class=o>.</span><span class=n>sort_values</span><span class=p>(</span><span class=n>by</span><span class=o>=</span><span class=s2>&quot;total_return&quot;</span><span class=p>,</span> <span class=n>ascending</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>
</span><span id=__span-19-28><a id=__codelineno-19-28 name=__codelineno-19-28 href=#__codelineno-19-28></a><span class=go>                          total_return  expectancy</span>
</span><span id=__span-19-29><a id=__codelineno-19-29 name=__codelineno-19-29 href=#__codelineno-19-29></a><span class=go>sl_stop tsl_stop tp_stop                          </span>
</span><span id=__span-19-30><a id=__codelineno-19-30 name=__codelineno-19-30 href=#__codelineno-19-30></a><span class=go>86.0    98.0     NaN          0.602834    2.740152</span>
</span><span id=__span-19-31><a id=__codelineno-19-31 name=__codelineno-19-31 href=#__codelineno-19-31></a><span class=go>47.0    62.0     NaN          0.587525    1.632014</span>
</span><span id=__span-19-32><a id=__codelineno-19-32 name=__codelineno-19-32 href=#__codelineno-19-32></a><span class=go>43.0    90.0     NaN          0.579859    1.757150</span>
</span><span id=__span-19-33><a id=__codelineno-19-33 name=__codelineno-19-33 href=#__codelineno-19-33></a><span class=go>16.0    62.0     54.0         0.412477    0.448345</span>
</span><span id=__span-19-34><a id=__codelineno-19-34 name=__codelineno-19-34 href=#__codelineno-19-34></a><span class=go>2.0     95.0     71.0         0.406624    0.125115</span>
</span><span id=__span-19-35><a id=__codelineno-19-35 name=__codelineno-19-35 href=#__codelineno-19-35></a><span class=go>...                                ...         ...</span>
</span><span id=__span-19-36><a id=__codelineno-19-36 name=__codelineno-19-36 href=#__codelineno-19-36></a><span class=go>27.0    41.0     20.0        -0.063945   -0.046337</span>
</span><span id=__span-19-37><a id=__codelineno-19-37 name=__codelineno-19-37 href=#__codelineno-19-37></a><span class=go>52.0    46.0     20.0        -0.065675   -0.067706</span>
</span><span id=__span-19-38><a id=__codelineno-19-38 name=__codelineno-19-38 href=#__codelineno-19-38></a><span class=go>23.0    61.0     22.0        -0.071294   -0.057495</span>
</span><span id=__span-19-39><a id=__codelineno-19-39 name=__codelineno-19-39 href=#__codelineno-19-39></a><span class=go>6.0     57.0     31.0        -0.080679   -0.029232</span>
</span><span id=__span-19-40><a id=__codelineno-19-40 name=__codelineno-19-40 href=#__codelineno-19-40></a><span class=go>23.0    45.0     22.0        -0.090643   -0.073099</span>
</span><span id=__span-19-41><a id=__codelineno-19-41 name=__codelineno-19-41 href=#__codelineno-19-41></a>
</span><span id=__span-19-42><a id=__codelineno-19-42 name=__codelineno-19-42 href=#__codelineno-19-42></a><span class=go>[1000 rows x 2 columns]</span>
</span></code></pre></div> <ol> <li>Select the parameter combination with the highest expectancy.</li> <li>Use NaN or a range from 1% to 99%.</li> <li>The method will create the Cartesian product of all parameter arrays (same as using <code>param_product=True</code> earlier).</li> <li>All stops are provided as a percentage from the entry price, where 1 = 1%.</li> <li>All orders will be executed at the end of the bar; otherwise, we cannot use <code>call_seq="auto"</code>.</li> <li>Randomly select 1,000 parameter combinations and make the results deterministic by setting a seed.</li> </ol> <p>We can see how performance declines with lower SL and TSL values, and how the optimizer tends to discourage the use of TP stops. Let's examine how a metric of interest depends on each type of stop value:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>plot_metric_by_stop</span><span class=p>(</span><span class=n>stop_name</span><span class=p>,</span> <span class=n>metric_name</span><span class=p>,</span> <span class=n>stat_name</span><span class=p>,</span> <span class=n>smooth</span><span class=p>):</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=gp>... </span>    <span class=kn>from</span><span class=w> </span><span class=nn>scipy.signal</span><span class=w> </span><span class=kn>import</span> <span class=n>savgol_filter</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=gp>...</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a><span class=gp>... </span>    <span class=n>values</span> <span class=o>=</span> <span class=n>pf</span><span class=o>.</span><span class=n>deep_getattr</span><span class=p>(</span><span class=n>metric_name</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a><span class=gp>... </span>    <span class=n>values</span> <span class=o>=</span> <span class=n>values</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>select_levels</span><span class=p>(</span><span class=n>stop_name</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a><span class=gp>... </span>    <span class=n>values</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>values</span><span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=n>values</span><span class=o>.</span><span class=n>index</span><span class=p>),</span> <span class=n>stat_name</span><span class=p>)()</span>  <span class=c1># (3)!</span>
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a><span class=gp>... </span>    <span class=n>smooth_values</span> <span class=o>=</span> <span class=n>savgol_filter</span><span class=p>(</span><span class=n>values</span><span class=p>,</span> <span class=n>smooth</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># (4)!</span>
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a><span class=gp>... </span>    <span class=n>smooth_values</span> <span class=o>=</span> <span class=n>values</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>wrap</span><span class=p>(</span><span class=n>smooth_values</span><span class=p>)</span>  <span class=c1># (5)!</span>
</span><span id=__span-20-9><a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a><span class=gp>... </span>    <span class=n>fig</span> <span class=o>=</span> <span class=n>values</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=n>metric_name</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>plot</span><span class=p>()</span>
</span><span id=__span-20-10><a id=__codelineno-20-10 name=__codelineno-20-10 href=#__codelineno-20-10></a><span class=gp>... </span>    <span class=n>smooth_values</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>metric_name</span><span class=si>}</span><span class=s2> (smoothed)&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span>
</span><span id=__span-20-11><a id=__codelineno-20-11 name=__codelineno-20-11 href=#__codelineno-20-11></a><span class=gp>... </span>        <span class=n>trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>line</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>dash</span><span class=o>=</span><span class=s2>&quot;dot&quot;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s2>&quot;yellow&quot;</span><span class=p>)),</span>
</span><span id=__span-20-12><a id=__codelineno-20-12 name=__codelineno-20-12 href=#__codelineno-20-12></a><span class=gp>... </span>        <span class=n>fig</span><span class=o>=</span><span class=n>fig</span><span class=p>,</span> 
</span><span id=__span-20-13><a id=__codelineno-20-13 name=__codelineno-20-13 href=#__codelineno-20-13></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-20-14><a id=__codelineno-20-14 name=__codelineno-20-14 href=#__codelineno-20-14></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>fig</span>
</span></code></pre></div> <ol> <li>This method allows us to access deeply chained attributes in the portfolio object, such as <code>trades.winning.pnl.mean</code> for the average P&amp;L of winning trades.</li> <li>The index of any metric is a <code>pd.MultiIndex</code> with three levels, one for each parameter. Let's select just one parameter (stop type) for analysis.</li> <li>Since we tested a product of multiple parameters, each stop value might have multiple observations. Aggregate these observations using a statistic of interest.</li> <li>Apply the <a href=https://en.wikipedia.org/wiki/Savitzky–Golay_filter>Savitzky–Golay filter</a> to smooth the values.</li> <li>Because the filter returns a NumPy array, wrap it as a Pandas Series with the same index as our values.</li> </ol> <div class="tabbed-set tabbed-alternate" data-tabs=1:3><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><input id=__tabbed_1_2 name=__tabbed_1 type=radio><input id=__tabbed_1_3 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1>SL</label><label for=__tabbed_1_2>TSL</label><label for=__tabbed_1_3>TP</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>plot_metric_by_stop</span><span class=p>(</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=gp>... </span>    <span class=s2>&quot;sl_stop&quot;</span><span class=p>,</span> 
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=gp>... </span>    <span class=s2>&quot;trades.expectancy&quot;</span><span class=p>,</span> 
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=gp>... </span>    <span class=s2>&quot;median&quot;</span><span class=p>,</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a><span class=gp>... </span>    <span class=mi>10</span>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a><span class=gp>... </span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pairs-trading/SL.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pairs-trading/SL.dark.svg#only-dark></p> </div> <div class=tabbed-block> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>plot_metric_by_stop</span><span class=p>(</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=gp>... </span>    <span class=s2>&quot;tsl_stop&quot;</span><span class=p>,</span> 
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a><span class=gp>... </span>    <span class=s2>&quot;trades.expectancy&quot;</span><span class=p>,</span> 
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a><span class=gp>... </span>    <span class=s2>&quot;median&quot;</span><span class=p>,</span>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a><span class=gp>... </span>    <span class=mi>10</span>
</span><span id=__span-22-6><a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a><span class=gp>... </span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pairs-trading/TSL.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pairs-trading/TSL.dark.svg#only-dark></p> </div> <div class=tabbed-block> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>plot_metric_by_stop</span><span class=p>(</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a><span class=gp>... </span>    <span class=s2>&quot;tp_stop&quot;</span><span class=p>,</span> 
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a><span class=gp>... </span>    <span class=s2>&quot;trades.expectancy&quot;</span><span class=p>,</span> 
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a><span class=gp>... </span>    <span class=s2>&quot;median&quot;</span><span class=p>,</span>
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a><span class=gp>... </span>    <span class=mi>10</span>
</span><span id=__span-23-6><a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a><span class=gp>... </span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pairs-trading/TP.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pairs-trading/TP.dark.svg#only-dark></p> </div> </div> </div> <p>Now we have a general overview of how stop orders impact strategy performance.</p> <h3 id=level-engineer>Level: Engineer <img alt=🛰 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f6f0.svg title=:satellite_orbital:><a class=headerlink href=#level-engineer title="Permanent link">&para;</a></h3> <p>The approach above works well if you are in the strategy discovery phase. Pandas and VBT's high-level API enable rapid and easy experimentation. However, once you finish building a general framework for your strategy, you should focus on optimizing for the best CPU and memory performance. This will allow you to test the strategy on more assets, longer periods, and more parameter combinations. Previously, we could test multiple combinations by loading them all into memory. The only reason we did not encounter issues was thanks to using random search. To make parameter search more practical, we should both speed up our backtests and reduce memory usage.</p> <p>Let's begin by rewriting our indicator strictly with Numba:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span><span class=p>(</span><span class=n>nogil</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>pt_signals_nb</span><span class=p>(</span><span class=n>close</span><span class=p>,</span> <span class=n>window</span><span class=o>=</span><span class=n>WINDOW</span><span class=p>,</span> <span class=n>upper</span><span class=o>=</span><span class=n>UPPER</span><span class=p>,</span> <span class=n>lower</span><span class=o>=</span><span class=n>LOWER</span><span class=p>):</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=gp>... </span>    <span class=n>x</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>expand_dims</span><span class=p>(</span><span class=n>close</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=gp>... </span>    <span class=n>y</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>expand_dims</span><span class=p>(</span><span class=n>close</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=mi>1</span><span class=p>)</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a><span class=gp>... </span>    <span class=n>_</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>zscore</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>ind_nb</span><span class=o>.</span><span class=n>ols_nb</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>window</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a><span class=gp>... </span>    <span class=n>zscore_1d</span> <span class=o>=</span> <span class=n>zscore</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>]</span>  <span class=c1># (4)!</span>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=gp>... </span>    <span class=n>upper_ts</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full_like</span><span class=p>(</span><span class=n>zscore_1d</span><span class=p>,</span> <span class=n>upper</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>float_</span><span class=p>)</span>  <span class=c1># (5)!</span>
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a><span class=gp>... </span>    <span class=n>lower_ts</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full_like</span><span class=p>(</span><span class=n>zscore_1d</span><span class=p>,</span> <span class=n>lower</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>float_</span><span class=p>)</span>
</span><span id=__span-24-9><a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a><span class=gp>... </span>    <span class=n>upper_crossed</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>crossed_above_1d_nb</span><span class=p>(</span><span class=n>zscore_1d</span><span class=p>,</span> <span class=n>upper_ts</span><span class=p>)</span>  <span class=c1># (6)!</span>
</span><span id=__span-24-10><a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a><span class=gp>... </span>    <span class=n>lower_crossed</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>crossed_above_1d_nb</span><span class=p>(</span><span class=n>lower_ts</span><span class=p>,</span> <span class=n>zscore_1d</span><span class=p>)</span>  <span class=c1># (7)!</span>
</span><span id=__span-24-11><a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a><span class=gp>... </span>    <span class=n>long_entries</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full_like</span><span class=p>(</span><span class=n>close</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>bool_</span><span class=p>)</span>  <span class=c1># (8)!</span>
</span><span id=__span-24-12><a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a><span class=gp>... </span>    <span class=n>short_entries</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full_like</span><span class=p>(</span><span class=n>close</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>bool_</span><span class=p>)</span>
</span><span id=__span-24-13><a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a><span class=gp>... </span>    <span class=n>short_entries</span><span class=p>[</span><span class=n>upper_crossed</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>  <span class=c1># (9)!</span>
</span><span id=__span-24-14><a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a><span class=gp>... </span>    <span class=n>long_entries</span><span class=p>[</span><span class=n>upper_crossed</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-24-15><a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a><span class=gp>... </span>    <span class=n>long_entries</span><span class=p>[</span><span class=n>lower_crossed</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-24-16><a id=__codelineno-24-16 name=__codelineno-24-16 href=#__codelineno-24-16></a><span class=gp>... </span>    <span class=n>short_entries</span><span class=p>[</span><span class=n>lower_crossed</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-24-17><a id=__codelineno-24-17 name=__codelineno-24-17 href=#__codelineno-24-17></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>long_entries</span><span class=p>,</span> <span class=n>short_entries</span>
</span></code></pre></div> <ol> <li>Releases the GIL, enabling multithreading in the future.</li> <li>Select the specific column and expand to two dimensions as required for the next function.</li> <li>This is a Numba-compiled function to run OLS. Every VBT indicator function without the <code>_1d</code> suffix expects two-dimensional input.</li> <li>Two dimensions in, two dimensions out. Since no more functions below require two-dimensional arrays, reduce it to one dimension.</li> <li>Crossover functions need arrays of the same shape, but we want to compare against a single value, so create an array of the same shape as the single value.</li> <li>Notice the <code>_1d</code> suffix? The function expects a one-dimensional input.</li> <li>A crosses below B is equivalent to B crossing above A.</li> <li>The output arrays have the same shape as the input array.</li> <li>Numba does not support labels, so set the target column using its integer index.</li> </ol> <p>Next, let's verify that our indicator produces the same number of signals as before:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>long_entries</span><span class=p>,</span> <span class=n>short_entries</span> <span class=o>=</span> <span class=n>pt_signals_nb</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>close</span><span class=o>.</span><span class=n>values</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>long_entries</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>wrap</span><span class=p>(</span><span class=n>long_entries</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>short_entries</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>wrap</span><span class=p>(</span><span class=n>short_entries</span><span class=p>)</span>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a>
</span><span id=__span-25-5><a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=n>long_entries</span><span class=o>.</span><span class=n>sum</span><span class=p>())</span>
</span><span id=__span-25-6><a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a><span class=go>symbol</span>
</span><span id=__span-25-7><a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a><span class=go>ALGOUSDT    52</span>
</span><span id=__span-25-8><a id=__codelineno-25-8 name=__codelineno-25-8 href=#__codelineno-25-8></a><span class=go>QTUMUSDT    73</span>
</span><span id=__span-25-9><a id=__codelineno-25-9 name=__codelineno-25-9 href=#__codelineno-25-9></a><span class=go>dtype: int64</span>
</span><span id=__span-25-10><a id=__codelineno-25-10 name=__codelineno-25-10 href=#__codelineno-25-10></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=n>short_entries</span><span class=o>.</span><span class=n>sum</span><span class=p>())</span>
</span><span id=__span-25-11><a id=__codelineno-25-11 name=__codelineno-25-11 href=#__codelineno-25-11></a><span class=go>symbol</span>
</span><span id=__span-25-12><a id=__codelineno-25-12 name=__codelineno-25-12 href=#__codelineno-25-12></a><span class=go>ALGOUSDT    73</span>
</span><span id=__span-25-13><a id=__codelineno-25-13 name=__codelineno-25-13 href=#__codelineno-25-13></a><span class=go>QTUMUSDT    52</span>
</span><span id=__span-25-14><a id=__codelineno-25-14 name=__codelineno-25-14 href=#__codelineno-25-14></a><span class=go>dtype: int64</span>
</span></code></pre></div> <ol> <li>Numba does not accept Pandas objects, so extract the NumPy array.</li> <li>The function returns NumPy arrays, so wrap them back into the Pandas format.</li> </ol> <p>The signals align perfectly.</p> <p>Although this function is faster than the expression-based version, it does not solve the memory issue because output arrays must still be stored in memory to be passed to the simulator—especially when running multiple parameter combinations. To address this, we can wrap both the signal generation and simulation steps into a single pipeline and have it return lightweight arrays, such as just the total return. By leveraging an effective chunking approach, we could run nearly unlimited parameter combinations! <img alt=🪁 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1fa81.svg title=:kite:></p> <p>The next step is to rewrite the simulation part using Numba:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span><span class=p>(</span><span class=n>nogil</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>pt_portfolio_nb</span><span class=p>(</span>
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a><span class=gp>... </span>    <span class=nb>open</span><span class=p>,</span> 
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a><span class=gp>... </span>    <span class=n>high</span><span class=p>,</span> 
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a><span class=gp>... </span>    <span class=n>low</span><span class=p>,</span> 
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a><span class=gp>... </span>    <span class=n>close</span><span class=p>,</span>
</span><span id=__span-26-7><a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a><span class=gp>... </span>    <span class=n>long_entries</span><span class=p>,</span>
</span><span id=__span-26-8><a id=__codelineno-26-8 name=__codelineno-26-8 href=#__codelineno-26-8></a><span class=gp>... </span>    <span class=n>short_entries</span><span class=p>,</span>
</span><span id=__span-26-9><a id=__codelineno-26-9 name=__codelineno-26-9 href=#__codelineno-26-9></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-26-10><a id=__codelineno-26-10 name=__codelineno-26-10 href=#__codelineno-26-10></a><span class=gp>... </span>    <span class=n>tsl_stop</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-26-11><a id=__codelineno-26-11 name=__codelineno-26-11 href=#__codelineno-26-11></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-26-12><a id=__codelineno-26-12 name=__codelineno-26-12 href=#__codelineno-26-12></a><span class=gp>... </span><span class=p>):</span>
</span><span id=__span-26-13><a id=__codelineno-26-13 name=__codelineno-26-13 href=#__codelineno-26-13></a><span class=gp>... </span>    <span class=n>target_shape</span> <span class=o>=</span> <span class=n>close</span><span class=o>.</span><span class=n>shape</span>  <span class=c1># (1)!</span>
</span><span id=__span-26-14><a id=__codelineno-26-14 name=__codelineno-26-14 href=#__codelineno-26-14></a><span class=gp>... </span>    <span class=n>group_lens</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>2</span><span class=p>])</span>  <span class=c1># (2)!</span>
</span><span id=__span-26-15><a id=__codelineno-26-15 name=__codelineno-26-15 href=#__codelineno-26-15></a><span class=gp>... </span>    <span class=n>sim_out</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>from_signals_nb</span><span class=p>(</span>  <span class=c1># (3)!</span>
</span><span id=__span-26-16><a id=__codelineno-26-16 name=__codelineno-26-16 href=#__codelineno-26-16></a><span class=gp>... </span>        <span class=n>target_shape</span><span class=o>=</span><span class=n>target_shape</span><span class=p>,</span>
</span><span id=__span-26-17><a id=__codelineno-26-17 name=__codelineno-26-17 href=#__codelineno-26-17></a><span class=gp>... </span>        <span class=n>group_lens</span><span class=o>=</span><span class=n>group_lens</span><span class=p>,</span>
</span><span id=__span-26-18><a id=__codelineno-26-18 name=__codelineno-26-18 href=#__codelineno-26-18></a><span class=gp>... </span>        <span class=n>auto_call_seq</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>  <span class=c1># (4)!</span>
</span><span id=__span-26-19><a id=__codelineno-26-19 name=__codelineno-26-19 href=#__codelineno-26-19></a><span class=gp>... </span>        <span class=nb>open</span><span class=o>=</span><span class=nb>open</span><span class=p>,</span>
</span><span id=__span-26-20><a id=__codelineno-26-20 name=__codelineno-26-20 href=#__codelineno-26-20></a><span class=gp>... </span>        <span class=n>high</span><span class=o>=</span><span class=n>high</span><span class=p>,</span>
</span><span id=__span-26-21><a id=__codelineno-26-21 name=__codelineno-26-21 href=#__codelineno-26-21></a><span class=gp>... </span>        <span class=n>low</span><span class=o>=</span><span class=n>low</span><span class=p>,</span>
</span><span id=__span-26-22><a id=__codelineno-26-22 name=__codelineno-26-22 href=#__codelineno-26-22></a><span class=gp>... </span>        <span class=n>close</span><span class=o>=</span><span class=n>close</span><span class=p>,</span>
</span><span id=__span-26-23><a id=__codelineno-26-23 name=__codelineno-26-23 href=#__codelineno-26-23></a><span class=gp>... </span>        <span class=n>long_entries</span><span class=o>=</span><span class=n>long_entries</span><span class=p>,</span>
</span><span id=__span-26-24><a id=__codelineno-26-24 name=__codelineno-26-24 href=#__codelineno-26-24></a><span class=gp>... </span>        <span class=n>short_entries</span><span class=o>=</span><span class=n>short_entries</span><span class=p>,</span>
</span><span id=__span-26-25><a id=__codelineno-26-25 name=__codelineno-26-25 href=#__codelineno-26-25></a><span class=gp>... </span>        <span class=n>size</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>
</span><span id=__span-26-26><a id=__codelineno-26-26 name=__codelineno-26-26 href=#__codelineno-26-26></a><span class=gp>... </span>        <span class=n>size_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>SizeType</span><span class=o>.</span><span class=n>ValuePercent100</span><span class=p>,</span>  <span class=c1># (5)!</span>
</span><span id=__span-26-27><a id=__codelineno-26-27 name=__codelineno-26-27 href=#__codelineno-26-27></a><span class=gp>... </span>        <span class=n>sl_stop</span><span class=o>=</span><span class=n>sl_stop</span><span class=p>,</span>
</span><span id=__span-26-28><a id=__codelineno-26-28 name=__codelineno-26-28 href=#__codelineno-26-28></a><span class=gp>... </span>        <span class=n>tsl_stop</span><span class=o>=</span><span class=n>tsl_stop</span><span class=p>,</span>
</span><span id=__span-26-29><a id=__codelineno-26-29 name=__codelineno-26-29 href=#__codelineno-26-29></a><span class=gp>... </span>        <span class=n>tp_stop</span><span class=o>=</span><span class=n>tp_stop</span><span class=p>,</span>
</span><span id=__span-26-30><a id=__codelineno-26-30 name=__codelineno-26-30 href=#__codelineno-26-30></a><span class=gp>... </span>        <span class=n>delta_format</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>DeltaFormat</span><span class=o>.</span><span class=n>Percent100</span><span class=p>,</span>
</span><span id=__span-26-31><a id=__codelineno-26-31 name=__codelineno-26-31 href=#__codelineno-26-31></a><span class=gp>... </span>        <span class=n>stop_exit_price</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>StopExitPrice</span><span class=o>.</span><span class=n>Close</span>
</span><span id=__span-26-32><a id=__codelineno-26-32 name=__codelineno-26-32 href=#__codelineno-26-32></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-26-33><a id=__codelineno-26-33 name=__codelineno-26-33 href=#__codelineno-26-33></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>sim_out</span>
</span></code></pre></div> <ol> <li>Target shape refers to the shape over which the simulator "walks," matching the shape of our OHLC arrays.</li> <li>One group consists of two columns. When any group has more than one column, cash sharing is automatically enabled.</li> <li>There are two available functions: <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.from_signals_nb>from_signals_nb</a> and <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_signals/#vectorbtpro.portfolio.nb.from_signals.from_signal_func_nb>from_signal_func_nb</a>. Since we already have the signal arrays, we should use the first function.</li> <li>This is equivalent to using <code>call_seq="auto"</code> as before.</li> <li>Numba functions do not accept enumerated types as strings, only as integers.</li> </ol> <p>Let's run it:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sim_out</span> <span class=o>=</span> <span class=n>pt_portfolio_nb</span><span class=p>(</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>open</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>high</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>close</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a><span class=gp>... </span>    <span class=n>long_entries</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a><span class=gp>... </span>    <span class=n>short_entries</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-27-8><a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <p>The output of this function is an instance of the <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.SimulationOutput>SimulationOutput</a> type, which you can use to construct a new <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio>Portfolio</a> instance for analysis:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=p>(</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>regroup</span><span class=p>(</span><span class=n>group_by</span><span class=o>=</span><span class=kc>True</span><span class=p>),</span>  <span class=c1># (1)!</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a><span class=gp>... </span>    <span class=n>sim_out</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a><span class=gp>... </span>    <span class=nb>open</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>open</span><span class=p>,</span>  <span class=c1># (3)!</span>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=gp>... </span>    <span class=n>high</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>high</span><span class=p>,</span>
</span><span id=__span-28-6><a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a><span class=gp>... </span>    <span class=n>low</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>low</span><span class=p>,</span>
</span><span id=__span-28-7><a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>close</span><span class=p>,</span>
</span><span id=__span-28-8><a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a><span class=gp>... </span>    <span class=n>cash_sharing</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-28-9><a id=__codelineno-28-9 name=__codelineno-28-9 href=#__codelineno-28-9></a><span class=gp>... </span>    <span class=n>init_cash</span><span class=o>=</span><span class=mi>100</span>  <span class=c1># (4)!</span>
</span><span id=__span-28-10><a id=__codelineno-28-10 name=__codelineno-28-10 href=#__codelineno-28-10></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-28-11><a id=__codelineno-28-11 name=__codelineno-28-11 href=#__codelineno-28-11></a>
</span><span id=__span-28-12><a id=__codelineno-28-12 name=__codelineno-28-12 href=#__codelineno-28-12></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=n>pf</span><span class=o>.</span><span class=n>total_return</span><span class=p>)</span>
</span><span id=__span-28-13><a id=__codelineno-28-13 name=__codelineno-28-13 href=#__codelineno-28-13></a><span class=go>0.19930328736504038</span>
</span></code></pre></div> <ol> <li>The first argument should be the wrapper. Be sure to enable grouping using the same <code>group_by</code> setting as before.</li> <li>The second argument should be either the order records or the simulation output.</li> <li>We must provide the arguments used during simulation, since this information is not stored in the simulation output.</li> <li>The default initial cash for the simulator is $100. If we do not provide it here, the portfolio will set it based on the order records, which is a more expensive operation.</li> </ol> <p>Now we need a Numba-compiled version of the analysis part:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span><span class=p>(</span><span class=n>nogil</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>pt_metrics_nb</span><span class=p>(</span><span class=n>close</span><span class=p>,</span> <span class=n>sim_out</span><span class=p>):</span>
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a><span class=gp>... </span>    <span class=n>target_shape</span> <span class=o>=</span> <span class=n>close</span><span class=o>.</span><span class=n>shape</span>
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a><span class=gp>... </span>    <span class=n>group_lens</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>2</span><span class=p>])</span>
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a><span class=gp>... </span>    <span class=n>filled_close</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>fbfill_nb</span><span class=p>(</span><span class=n>close</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a><span class=gp>... </span>    <span class=n>col_map</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>rec_nb</span><span class=o>.</span><span class=n>col_map_nb</span><span class=p>(</span>  <span class=c1># (2)!</span>
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a><span class=gp>... </span>        <span class=n>col_arr</span><span class=o>=</span><span class=n>sim_out</span><span class=o>.</span><span class=n>order_records</span><span class=p>[</span><span class=s2>&quot;col&quot;</span><span class=p>],</span> 
</span><span id=__span-29-8><a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a><span class=gp>... </span>        <span class=n>n_cols</span><span class=o>=</span><span class=n>target_shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-29-9><a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-29-10><a id=__codelineno-29-10 name=__codelineno-29-10 href=#__codelineno-29-10></a><span class=gp>... </span>    <span class=n>total_profit</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>total_profit_nb</span><span class=p>(</span>  <span class=c1># (3)!</span>
</span><span id=__span-29-11><a id=__codelineno-29-11 name=__codelineno-29-11 href=#__codelineno-29-11></a><span class=gp>... </span>        <span class=n>target_shape</span><span class=o>=</span><span class=n>target_shape</span><span class=p>,</span>
</span><span id=__span-29-12><a id=__codelineno-29-12 name=__codelineno-29-12 href=#__codelineno-29-12></a><span class=gp>... </span>        <span class=n>close</span><span class=o>=</span><span class=n>filled_close</span><span class=p>,</span>
</span><span id=__span-29-13><a id=__codelineno-29-13 name=__codelineno-29-13 href=#__codelineno-29-13></a><span class=gp>... </span>        <span class=n>order_records</span><span class=o>=</span><span class=n>sim_out</span><span class=o>.</span><span class=n>order_records</span><span class=p>,</span>
</span><span id=__span-29-14><a id=__codelineno-29-14 name=__codelineno-29-14 href=#__codelineno-29-14></a><span class=gp>... </span>        <span class=n>col_map</span><span class=o>=</span><span class=n>col_map</span>
</span><span id=__span-29-15><a id=__codelineno-29-15 name=__codelineno-29-15 href=#__codelineno-29-15></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-29-16><a id=__codelineno-29-16 name=__codelineno-29-16 href=#__codelineno-29-16></a><span class=gp>... </span>    <span class=n>total_profit_grouped</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>total_profit_grouped_nb</span><span class=p>(</span>  <span class=c1># (4)!</span>
</span><span id=__span-29-17><a id=__codelineno-29-17 name=__codelineno-29-17 href=#__codelineno-29-17></a><span class=gp>... </span>        <span class=n>total_profit</span><span class=o>=</span><span class=n>total_profit</span><span class=p>,</span>
</span><span id=__span-29-18><a id=__codelineno-29-18 name=__codelineno-29-18 href=#__codelineno-29-18></a><span class=gp>... </span>        <span class=n>group_lens</span><span class=o>=</span><span class=n>group_lens</span><span class=p>,</span>
</span><span id=__span-29-19><a id=__codelineno-29-19 name=__codelineno-29-19 href=#__codelineno-29-19></a><span class=gp>... </span>    <span class=p>)[</span><span class=mi>0</span><span class=p>]</span>  <span class=c1># (5)!</span>
</span><span id=__span-29-20><a id=__codelineno-29-20 name=__codelineno-29-20 href=#__codelineno-29-20></a><span class=gp>... </span>    <span class=n>total_return</span> <span class=o>=</span> <span class=n>total_profit_grouped</span> <span class=o>/</span> <span class=mi>100</span>  <span class=c1># (6)!</span>
</span><span id=__span-29-21><a id=__codelineno-29-21 name=__codelineno-29-21 href=#__codelineno-29-21></a><span class=gp>... </span>    <span class=n>trade_records</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>get_exit_trades_nb</span><span class=p>(</span>  <span class=c1># (7)!</span>
</span><span id=__span-29-22><a id=__codelineno-29-22 name=__codelineno-29-22 href=#__codelineno-29-22></a><span class=gp>... </span>        <span class=n>order_records</span><span class=o>=</span><span class=n>sim_out</span><span class=o>.</span><span class=n>order_records</span><span class=p>,</span> 
</span><span id=__span-29-23><a id=__codelineno-29-23 name=__codelineno-29-23 href=#__codelineno-29-23></a><span class=gp>... </span>        <span class=n>close</span><span class=o>=</span><span class=n>filled_close</span><span class=p>,</span> 
</span><span id=__span-29-24><a id=__codelineno-29-24 name=__codelineno-29-24 href=#__codelineno-29-24></a><span class=gp>... </span>        <span class=n>col_map</span><span class=o>=</span><span class=n>col_map</span>
</span><span id=__span-29-25><a id=__codelineno-29-25 name=__codelineno-29-25 href=#__codelineno-29-25></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-29-26><a id=__codelineno-29-26 name=__codelineno-29-26 href=#__codelineno-29-26></a><span class=gp>... </span>    <span class=n>trade_records</span> <span class=o>=</span> <span class=n>trade_records</span><span class=p>[</span>  <span class=c1># (8)!</span>
</span><span id=__span-29-27><a id=__codelineno-29-27 name=__codelineno-29-27 href=#__codelineno-29-27></a><span class=gp>... </span>        <span class=n>trade_records</span><span class=p>[</span><span class=s2>&quot;status&quot;</span><span class=p>]</span> <span class=o>==</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>TradeStatus</span><span class=o>.</span><span class=n>Closed</span>
</span><span id=__span-29-28><a id=__codelineno-29-28 name=__codelineno-29-28 href=#__codelineno-29-28></a><span class=gp>... </span>    <span class=p>]</span>
</span><span id=__span-29-29><a id=__codelineno-29-29 name=__codelineno-29-29 href=#__codelineno-29-29></a><span class=gp>... </span>    <span class=n>expectancy</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>expectancy_reduce_nb</span><span class=p>(</span>  <span class=c1># (9)!</span>
</span><span id=__span-29-30><a id=__codelineno-29-30 name=__codelineno-29-30 href=#__codelineno-29-30></a><span class=gp>... </span>        <span class=n>pnl_arr</span><span class=o>=</span><span class=n>trade_records</span><span class=p>[</span><span class=s2>&quot;pnl&quot;</span><span class=p>]</span>
</span><span id=__span-29-31><a id=__codelineno-29-31 name=__codelineno-29-31 href=#__codelineno-29-31></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-29-32><a id=__codelineno-29-32 name=__codelineno-29-32 href=#__codelineno-29-32></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>total_return</span><span class=p>,</span> <span class=n>expectancy</span>
</span></code></pre></div> <ol> <li>Forward-fill and backward-fill the close price to avoid NaNs in the equity.</li> <li>The column mapper aggregates order records per column for easier mapping.</li> <li>Total profit is calculated directly from the order records. This is one of the few metrics that does not require any intermediate arrays, making it lightweight and fast.</li> <li>The total profit calculated above is per column. We need to aggregate it by group.</li> <li>Since this function returns an array and we have only one group, extract the sole value.</li> <li>Total return is calculated from total profit using the initial value, which is $100.</li> <li>Aggregate order records into trade records to extract P&amp;L information.</li> <li>Ignore any open trades.</li> <li>Calculate expectancy. Normally this function runs per column. Since we have only two columns that belong to the same group, we can run it directly.</li> </ol> <p>Do not let this function intimidate you! We have calculated our metrics using only the close price and order records—a process called "reconstruction." The principle is simple: start with the metric you want, identify the information it requires, find the function that provides that information, and repeat as needed.</p> <p>Let's validate it:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pt_metrics_nb</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>close</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> <span class=n>sim_out</span><span class=p>)</span>
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a><span class=go>(0.19930328736504038, 0.7135952049405152)</span>
</span></code></pre></div> <p>100% accuracy.</p> <p>Finally, let's combine all parts into a single pipeline and benchmark it:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span><span class=p>(</span><span class=n>nogil</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>pt_pipeline_nb</span><span class=p>(</span>
</span><span id=__span-31-3><a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a><span class=gp>... </span>    <span class=nb>open</span><span class=p>,</span> 
</span><span id=__span-31-4><a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a><span class=gp>... </span>    <span class=n>high</span><span class=p>,</span> 
</span><span id=__span-31-5><a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a><span class=gp>... </span>    <span class=n>low</span><span class=p>,</span> 
</span><span id=__span-31-6><a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a><span class=gp>... </span>    <span class=n>close</span><span class=p>,</span>
</span><span id=__span-31-7><a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a><span class=gp>... </span>    <span class=n>window</span><span class=o>=</span><span class=n>WINDOW</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-31-8><a id=__codelineno-31-8 name=__codelineno-31-8 href=#__codelineno-31-8></a><span class=gp>... </span>    <span class=n>upper</span><span class=o>=</span><span class=n>UPPER</span><span class=p>,</span>
</span><span id=__span-31-9><a id=__codelineno-31-9 name=__codelineno-31-9 href=#__codelineno-31-9></a><span class=gp>... </span>    <span class=n>lower</span><span class=o>=</span><span class=n>LOWER</span><span class=p>,</span>
</span><span id=__span-31-10><a id=__codelineno-31-10 name=__codelineno-31-10 href=#__codelineno-31-10></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-31-11><a id=__codelineno-31-11 name=__codelineno-31-11 href=#__codelineno-31-11></a><span class=gp>... </span>    <span class=n>tsl_stop</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-31-12><a id=__codelineno-31-12 name=__codelineno-31-12 href=#__codelineno-31-12></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-31-13><a id=__codelineno-31-13 name=__codelineno-31-13 href=#__codelineno-31-13></a><span class=gp>... </span><span class=p>):</span>
</span><span id=__span-31-14><a id=__codelineno-31-14 name=__codelineno-31-14 href=#__codelineno-31-14></a><span class=gp>... </span>    <span class=n>long_entries</span><span class=p>,</span> <span class=n>short_entries</span> <span class=o>=</span> <span class=n>pt_signals_nb</span><span class=p>(</span>
</span><span id=__span-31-15><a id=__codelineno-31-15 name=__codelineno-31-15 href=#__codelineno-31-15></a><span class=gp>... </span>        <span class=n>close</span><span class=p>,</span> 
</span><span id=__span-31-16><a id=__codelineno-31-16 name=__codelineno-31-16 href=#__codelineno-31-16></a><span class=gp>... </span>        <span class=n>window</span><span class=o>=</span><span class=n>window</span><span class=p>,</span> 
</span><span id=__span-31-17><a id=__codelineno-31-17 name=__codelineno-31-17 href=#__codelineno-31-17></a><span class=gp>... </span>        <span class=n>upper</span><span class=o>=</span><span class=n>upper</span><span class=p>,</span> 
</span><span id=__span-31-18><a id=__codelineno-31-18 name=__codelineno-31-18 href=#__codelineno-31-18></a><span class=gp>... </span>        <span class=n>lower</span><span class=o>=</span><span class=n>lower</span>
</span><span id=__span-31-19><a id=__codelineno-31-19 name=__codelineno-31-19 href=#__codelineno-31-19></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-31-20><a id=__codelineno-31-20 name=__codelineno-31-20 href=#__codelineno-31-20></a><span class=gp>... </span>    <span class=n>sim_out</span> <span class=o>=</span> <span class=n>pt_portfolio_nb</span><span class=p>(</span>
</span><span id=__span-31-21><a id=__codelineno-31-21 name=__codelineno-31-21 href=#__codelineno-31-21></a><span class=gp>... </span>        <span class=nb>open</span><span class=p>,</span>
</span><span id=__span-31-22><a id=__codelineno-31-22 name=__codelineno-31-22 href=#__codelineno-31-22></a><span class=gp>... </span>        <span class=n>high</span><span class=p>,</span>
</span><span id=__span-31-23><a id=__codelineno-31-23 name=__codelineno-31-23 href=#__codelineno-31-23></a><span class=gp>... </span>        <span class=n>low</span><span class=p>,</span>
</span><span id=__span-31-24><a id=__codelineno-31-24 name=__codelineno-31-24 href=#__codelineno-31-24></a><span class=gp>... </span>        <span class=n>close</span><span class=p>,</span>
</span><span id=__span-31-25><a id=__codelineno-31-25 name=__codelineno-31-25 href=#__codelineno-31-25></a><span class=gp>... </span>        <span class=n>long_entries</span><span class=p>,</span>
</span><span id=__span-31-26><a id=__codelineno-31-26 name=__codelineno-31-26 href=#__codelineno-31-26></a><span class=gp>... </span>        <span class=n>short_entries</span><span class=p>,</span>
</span><span id=__span-31-27><a id=__codelineno-31-27 name=__codelineno-31-27 href=#__codelineno-31-27></a><span class=gp>... </span>        <span class=n>sl_stop</span><span class=o>=</span><span class=n>sl_stop</span><span class=p>,</span>
</span><span id=__span-31-28><a id=__codelineno-31-28 name=__codelineno-31-28 href=#__codelineno-31-28></a><span class=gp>... </span>        <span class=n>tsl_stop</span><span class=o>=</span><span class=n>tsl_stop</span><span class=p>,</span>
</span><span id=__span-31-29><a id=__codelineno-31-29 name=__codelineno-31-29 href=#__codelineno-31-29></a><span class=gp>... </span>        <span class=n>tp_stop</span><span class=o>=</span><span class=n>tp_stop</span>
</span><span id=__span-31-30><a id=__codelineno-31-30 name=__codelineno-31-30 href=#__codelineno-31-30></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-31-31><a id=__codelineno-31-31 name=__codelineno-31-31 href=#__codelineno-31-31></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>pt_metrics_nb</span><span class=p>(</span><span class=n>close</span><span class=p>,</span> <span class=n>sim_out</span><span class=p>)</span>
</span><span id=__span-31-32><a id=__codelineno-31-32 name=__codelineno-31-32 href=#__codelineno-31-32></a>
</span><span id=__span-31-33><a id=__codelineno-31-33 name=__codelineno-31-33 href=#__codelineno-31-33></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pt_pipeline_nb</span><span class=p>(</span>
</span><span id=__span-31-34><a id=__codelineno-31-34 name=__codelineno-31-34 href=#__codelineno-31-34></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>open</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-31-35><a id=__codelineno-31-35 name=__codelineno-31-35 href=#__codelineno-31-35></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>high</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-31-36><a id=__codelineno-31-36 name=__codelineno-31-36 href=#__codelineno-31-36></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-31-37><a id=__codelineno-31-37 name=__codelineno-31-37 href=#__codelineno-31-37></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>close</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-31-38><a id=__codelineno-31-38 name=__codelineno-31-38 href=#__codelineno-31-38></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-31-39><a id=__codelineno-31-39 name=__codelineno-31-39 href=#__codelineno-31-39></a><span class=go>(0.19930328736504038, 0.7135952049405152)</span>
</span><span id=__span-31-40><a id=__codelineno-31-40 name=__codelineno-31-40 href=#__codelineno-31-40></a>
</span><span id=__span-31-41><a id=__codelineno-31-41 name=__codelineno-31-41 href=#__codelineno-31-41></a><span class=gp>&gt;&gt;&gt; </span><span class=o>%%</span><span class=n>timeit</span>
</span><span id=__span-31-42><a id=__codelineno-31-42 name=__codelineno-31-42 href=#__codelineno-31-42></a><span class=gp>... </span><span class=n>pt_pipeline_nb</span><span class=p>(</span>
</span><span id=__span-31-43><a id=__codelineno-31-43 name=__codelineno-31-43 href=#__codelineno-31-43></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>open</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-31-44><a id=__codelineno-31-44 name=__codelineno-31-44 href=#__codelineno-31-44></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>high</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-31-45><a id=__codelineno-31-45 name=__codelineno-31-45 href=#__codelineno-31-45></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-31-46><a id=__codelineno-31-46 name=__codelineno-31-46 href=#__codelineno-31-46></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>close</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-31-47><a id=__codelineno-31-47 name=__codelineno-31-47 href=#__codelineno-31-47></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-31-48><a id=__codelineno-31-48 name=__codelineno-31-48 href=#__codelineno-31-48></a><span class=go>5.4 ms ± 13.1 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)</span>
</span></code></pre></div> <ol> <li>Use our global defaults as default arguments.</li> </ol> <p>Only 5 milliseconds per complete backtest <img alt=🔥 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f525.svg title=:fire:></p> <p>This performance encourages us to try intensive parameter optimization. Fortunately, there are several ways to do this. The most convenient is to wrap the pipeline with the <a href=https://vectorbt.pro/pvt_41531c19/api/utils/params/#vectorbtpro.utils.params.parameterized>@parameterized</a> decorator, which builds the parameter grid and calls the pipeline function on every parameter combination. Since all our Numba functions release the GIL, we can use multithreading! Let's test all parameter combinations for signal generation by breaking them into chunks and distributing combinations within each chunk. This process took about 5 minutes on Apple Silicon.</p> <div class="admonition important"> <p class=admonition-title>Important</p> <p>Keep in mind that <code>@parameterized</code> builds the entire parameter grid even when a random subset is specified, which can take a significant amount of time. For example, 6 parameters with 100 values each will create a grid with <code>100 ** 6</code>, or one trillion combinations, which is far too many to combine.</p> </div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>param_pt_pipeline</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>parameterized</span><span class=p>(</span>  <span class=c1># (1)!</span>
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a><span class=gp>... </span>    <span class=n>pt_pipeline_nb</span><span class=p>,</span> 
</span><span id=__span-32-3><a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a><span class=gp>... </span>    <span class=n>merge_func</span><span class=o>=</span><span class=s2>&quot;concat&quot;</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-32-4><a id=__codelineno-32-4 name=__codelineno-32-4 href=#__codelineno-32-4></a><span class=gp>... </span>    <span class=n>seed</span><span class=o>=</span><span class=mi>42</span><span class=p>,</span>
</span><span id=__span-32-5><a id=__codelineno-32-5 name=__codelineno-32-5 href=#__codelineno-32-5></a><span class=gp>... </span>    <span class=n>engine</span><span class=o>=</span><span class=s2>&quot;threadpool&quot;</span><span class=p>,</span>  <span class=c1># (3)!</span>
</span><span id=__span-32-6><a id=__codelineno-32-6 name=__codelineno-32-6 href=#__codelineno-32-6></a><span class=gp>... </span>    <span class=n>chunk_len</span><span class=o>=</span><span class=s2>&quot;auto&quot;</span>
</span><span id=__span-32-7><a id=__codelineno-32-7 name=__codelineno-32-7 href=#__codelineno-32-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-32-8><a id=__codelineno-32-8 name=__codelineno-32-8 href=#__codelineno-32-8></a>
</span><span id=__span-32-9><a id=__codelineno-32-9 name=__codelineno-32-9 href=#__codelineno-32-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>UPPER_SPACE</span> <span class=o>=</span> <span class=p>[</span><span class=n>st</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>ppf</span><span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>x</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>ALPHA_SPACE</span><span class=p>]</span>  <span class=c1># (4)!</span>
</span><span id=__span-32-10><a id=__codelineno-32-10 name=__codelineno-32-10 href=#__codelineno-32-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>LOWER_SPACE</span> <span class=o>=</span> <span class=p>[</span><span class=o>-</span><span class=n>st</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>ppf</span><span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>x</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>ALPHA_SPACE</span><span class=p>]</span>
</span><span id=__span-32-11><a id=__codelineno-32-11 name=__codelineno-32-11 href=#__codelineno-32-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>POPT_FILE</span> <span class=o>=</span> <span class=s2>&quot;temp/param_opt.pickle&quot;</span>
</span><span id=__span-32-12><a id=__codelineno-32-12 name=__codelineno-32-12 href=#__codelineno-32-12></a>
</span><span id=__span-32-13><a id=__codelineno-32-13 name=__codelineno-32-13 href=#__codelineno-32-13></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># vbt.remove_file(POPT_FILE, missing_ok=True)</span>
</span><span id=__span-32-14><a id=__codelineno-32-14 name=__codelineno-32-14 href=#__codelineno-32-14></a><span class=gp>&gt;&gt;&gt; </span><span class=k>if</span> <span class=ow>not</span> <span class=n>vbt</span><span class=o>.</span><span class=n>file_exists</span><span class=p>(</span><span class=n>POPT_FILE</span><span class=p>):</span>
</span><span id=__span-32-15><a id=__codelineno-32-15 name=__codelineno-32-15 href=#__codelineno-32-15></a><span class=gp>... </span>    <span class=n>param_opt</span> <span class=o>=</span> <span class=n>param_pt_pipeline</span><span class=p>(</span>
</span><span id=__span-32-16><a id=__codelineno-32-16 name=__codelineno-32-16 href=#__codelineno-32-16></a><span class=gp>... </span>        <span class=n>data</span><span class=o>.</span><span class=n>open</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-32-17><a id=__codelineno-32-17 name=__codelineno-32-17 href=#__codelineno-32-17></a><span class=gp>... </span>        <span class=n>data</span><span class=o>.</span><span class=n>high</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-32-18><a id=__codelineno-32-18 name=__codelineno-32-18 href=#__codelineno-32-18></a><span class=gp>... </span>        <span class=n>data</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-32-19><a id=__codelineno-32-19 name=__codelineno-32-19 href=#__codelineno-32-19></a><span class=gp>... </span>        <span class=n>data</span><span class=o>.</span><span class=n>close</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-32-20><a id=__codelineno-32-20 name=__codelineno-32-20 href=#__codelineno-32-20></a><span class=gp>... </span>        <span class=n>window</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span><span class=n>WINDOW_SPACE</span><span class=p>),</span>
</span><span id=__span-32-21><a id=__codelineno-32-21 name=__codelineno-32-21 href=#__codelineno-32-21></a><span class=gp>... </span>        <span class=n>upper</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span><span class=n>UPPER_SPACE</span><span class=p>),</span>
</span><span id=__span-32-22><a id=__codelineno-32-22 name=__codelineno-32-22 href=#__codelineno-32-22></a><span class=gp>... </span>        <span class=n>lower</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span><span class=n>LOWER_SPACE</span><span class=p>)</span>
</span><span id=__span-32-23><a id=__codelineno-32-23 name=__codelineno-32-23 href=#__codelineno-32-23></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-32-24><a id=__codelineno-32-24 name=__codelineno-32-24 href=#__codelineno-32-24></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>param_opt</span><span class=p>,</span> <span class=n>POPT_FILE</span><span class=p>)</span>
</span><span id=__span-32-25><a id=__codelineno-32-25 name=__codelineno-32-25 href=#__codelineno-32-25></a><span class=gp>... </span><span class=k>else</span><span class=p>:</span>
</span><span id=__span-32-26><a id=__codelineno-32-26 name=__codelineno-32-26 href=#__codelineno-32-26></a><span class=gp>... </span>    <span class=n>param_opt</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>POPT_FILE</span><span class=p>)</span>
</span><span id=__span-32-27><a id=__codelineno-32-27 name=__codelineno-32-27 href=#__codelineno-32-27></a>
</span><span id=__span-32-28><a id=__codelineno-32-28 name=__codelineno-32-28 href=#__codelineno-32-28></a><span class=gp>&gt;&gt;&gt; </span><span class=n>total_return</span><span class=p>,</span> <span class=n>expectancy</span> <span class=o>=</span> <span class=n>param_opt</span>  <span class=c1># (5)!</span>
</span></code></pre></div> <ol> <li>You can either decorate the function directly with <code>@</code>, or call the decorator with the function as the first argument.</li> <li>Concatenate each output across all parameter combinations.</li> <li>Create a pool with the same number of threads as there are CPU cores.</li> <li>Convert the alphas to z-score thresholds.</li> <li>The format is the same as that returned by our pipeline.</li> </ol> <p> <div class="progress progress-100plus candystripe candystripe-animate"> <div class=progress-bar style=width:100.00%> <p class=progress-label>Chunk 55131/55131</p> </div> </div> </p> <p>Now, let's analyze the total return:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=n>total_return</span><span class=p>)</span>
</span><span id=__span-33-2><a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a><span class=go>window  upper     lower    </span>
</span><span id=__span-33-3><a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a><span class=go>5       3.290527  -3.290527    0.000000</span>
</span><span id=__span-33-4><a id=__codelineno-33-4 name=__codelineno-33-4 href=#__codelineno-33-4></a><span class=go>                  -3.090232    0.000000</span>
</span><span id=__span-33-5><a id=__codelineno-33-5 name=__codelineno-33-5 href=#__codelineno-33-5></a><span class=go>                  -2.967738    0.000000</span>
</span><span id=__span-33-6><a id=__codelineno-33-6 name=__codelineno-33-6 href=#__codelineno-33-6></a><span class=go>                  -2.878162    0.000000</span>
</span><span id=__span-33-7><a id=__codelineno-33-7 name=__codelineno-33-7 href=#__codelineno-33-7></a><span class=go>                  -2.807034    0.000000</span>
</span><span id=__span-33-8><a id=__codelineno-33-8 name=__codelineno-33-8 href=#__codelineno-33-8></a><span class=go>                                    ...</span>
</span><span id=__span-33-9><a id=__codelineno-33-9 name=__codelineno-33-9 href=#__codelineno-33-9></a><span class=go>49      1.649721  -1.669593    0.196197</span>
</span><span id=__span-33-10><a id=__codelineno-33-10 name=__codelineno-33-10 href=#__codelineno-33-10></a><span class=go>                  -1.664563    0.192152</span>
</span><span id=__span-33-11><a id=__codelineno-33-11 name=__codelineno-33-11 href=#__codelineno-33-11></a><span class=go>                  -1.659575    0.190713</span>
</span><span id=__span-33-12><a id=__codelineno-33-12 name=__codelineno-33-12 href=#__codelineno-33-12></a><span class=go>                  -1.654628    0.201239</span>
</span><span id=__span-33-13><a id=__codelineno-33-13 name=__codelineno-33-13 href=#__codelineno-33-13></a><span class=go>                  -1.649721    0.204764</span>
</span><span id=__span-33-14><a id=__codelineno-33-14 name=__codelineno-33-14 href=#__codelineno-33-14></a><span class=go>Length: 441045, dtype: float64</span>
</span><span id=__span-33-15><a id=__codelineno-33-15 name=__codelineno-33-15 href=#__codelineno-33-15></a>
</span><span id=__span-33-16><a id=__codelineno-33-16 name=__codelineno-33-16 href=#__codelineno-33-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>grouped_metric</span> <span class=o>=</span> <span class=n>total_return</span><span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;upper&quot;</span><span class=p>,</span> <span class=s2>&quot;lower&quot;</span><span class=p>])</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span><span id=__span-33-17><a id=__codelineno-33-17 name=__codelineno-33-17 href=#__codelineno-33-17></a><span class=gp>&gt;&gt;&gt; </span><span class=n>grouped_metric</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>heatmap</span><span class=p>(</span>
</span><span id=__span-33-18><a id=__codelineno-33-18 name=__codelineno-33-18 href=#__codelineno-33-18></a><span class=gp>... </span>    <span class=n>trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>colorscale</span><span class=o>=</span><span class=s2>&quot;RdBu&quot;</span><span class=p>,</span> <span class=n>zmid</span><span class=o>=</span><span class=mi>0</span><span class=p>),</span>
</span><span id=__span-33-19><a id=__codelineno-33-19 name=__codelineno-33-19 href=#__codelineno-33-19></a><span class=gp>... </span>    <span class=n>yaxis</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>autorange</span><span class=o>=</span><span class=s2>&quot;reversed&quot;</span><span class=p>)</span>
</span><span id=__span-33-20><a id=__codelineno-33-20 name=__codelineno-33-20 href=#__codelineno-33-20></a><span class=gp>... </span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pairs-trading/popt_total_return.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pairs-trading/popt_total_return.dark.svg#only-dark></p> <p>The effect of the thresholds appears to be asymmetric: the highest total return is achieved for the lowest upper threshold and the lowest lower threshold. This means the neutral range between the two thresholds is shifted downward as much as possible.</p> <p>However, the <code>@parameterized</code> decorator has two key limitations: it runs only one parameter combination at a time, and it must build the entire parameter grid, even when evaluating a random subset. Why is running one combination at a time a limitation? Because only a few pipeline calls can be parallelized at once. Even with the special argument <code>distribute="chunks"</code> that allows you to parallelize entire chunks, calls within each chunk occur serially in a regular Python loop. This is not ideal for multithreading, which requires the GIL to be released for the entire procedure. If you try multiprocessing, the method must serialize all arguments (including the data) on each pipeline call, which adds significant overhead. This may still be faster than the above approach in some scenarios.</p> <p>To process multiple parameter combinations within each thread, we need to split them into chunks and write a parent Numba function that loops over the combinations in each chunk. Then, we can parallelize this parent function using multithreading. The steps are: 1) manually construct the parameter grid, 2) split it into chunks, and 3) iterate over the chunks and pass each to the parent function for execution. The first step can be accomplished with <a href=https://vectorbt.pro/pvt_41531c19/api/utils/params/#vectorbtpro.utils.params.combine_params>combine_params</a>, which is the <img alt=🫀 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1fac0.svg title=:anatomical_heart:> of the <code>@parameterized</code> decorator. The second and third steps can be done using another decorator, <a href=https://vectorbt.pro/pvt_41531c19/api/utils/chunking/#vectorbtpro.utils.chunking.chunked>@chunked</a>, which specializes in argument chunking. Let's do that! <img alt=💪 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f4aa.svg title=:muscle:></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span><span class=p>(</span><span class=n>nogil</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>pt_pipeline_mult_nb</span><span class=p>(</span>
</span><span id=__span-34-3><a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a><span class=gp>... </span>    <span class=n>n_params</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-34-4><a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a><span class=gp>... </span>    <span class=nb>open</span><span class=p>:</span>     <span class=n>tp</span><span class=o>.</span><span class=n>Array2d</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-34-5><a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a><span class=gp>... </span>    <span class=n>high</span><span class=p>:</span>     <span class=n>tp</span><span class=o>.</span><span class=n>Array2d</span><span class=p>,</span> 
</span><span id=__span-34-6><a id=__codelineno-34-6 name=__codelineno-34-6 href=#__codelineno-34-6></a><span class=gp>... </span>    <span class=n>low</span><span class=p>:</span>      <span class=n>tp</span><span class=o>.</span><span class=n>Array2d</span><span class=p>,</span> 
</span><span id=__span-34-7><a id=__codelineno-34-7 name=__codelineno-34-7 href=#__codelineno-34-7></a><span class=gp>... </span>    <span class=n>close</span><span class=p>:</span>    <span class=n>tp</span><span class=o>.</span><span class=n>Array2d</span><span class=p>,</span>
</span><span id=__span-34-8><a id=__codelineno-34-8 name=__codelineno-34-8 href=#__codelineno-34-8></a><span class=gp>... </span>    <span class=n>window</span><span class=p>:</span>   <span class=n>tp</span><span class=o>.</span><span class=n>FlexArray1dLike</span> <span class=o>=</span> <span class=n>WINDOW</span><span class=p>,</span>  <span class=c1># (3)!</span>
</span><span id=__span-34-9><a id=__codelineno-34-9 name=__codelineno-34-9 href=#__codelineno-34-9></a><span class=gp>... </span>    <span class=n>upper</span><span class=p>:</span>    <span class=n>tp</span><span class=o>.</span><span class=n>FlexArray1dLike</span> <span class=o>=</span> <span class=n>UPPER</span><span class=p>,</span>
</span><span id=__span-34-10><a id=__codelineno-34-10 name=__codelineno-34-10 href=#__codelineno-34-10></a><span class=gp>... </span>    <span class=n>lower</span><span class=p>:</span>    <span class=n>tp</span><span class=o>.</span><span class=n>FlexArray1dLike</span> <span class=o>=</span> <span class=n>LOWER</span><span class=p>,</span>
</span><span id=__span-34-11><a id=__codelineno-34-11 name=__codelineno-34-11 href=#__codelineno-34-11></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=p>:</span>  <span class=n>tp</span><span class=o>.</span><span class=n>FlexArray1dLike</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-34-12><a id=__codelineno-34-12 name=__codelineno-34-12 href=#__codelineno-34-12></a><span class=gp>... </span>    <span class=n>tsl_stop</span><span class=p>:</span> <span class=n>tp</span><span class=o>.</span><span class=n>FlexArray1dLike</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-34-13><a id=__codelineno-34-13 name=__codelineno-34-13 href=#__codelineno-34-13></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=p>:</span>  <span class=n>tp</span><span class=o>.</span><span class=n>FlexArray1dLike</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-34-14><a id=__codelineno-34-14 name=__codelineno-34-14 href=#__codelineno-34-14></a><span class=gp>... </span><span class=p>):</span>
</span><span id=__span-34-15><a id=__codelineno-34-15 name=__codelineno-34-15 href=#__codelineno-34-15></a><span class=gp>... </span>    <span class=n>window_</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>to_1d_array_nb</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>window</span><span class=p>))</span>  <span class=c1># (4)!</span>
</span><span id=__span-34-16><a id=__codelineno-34-16 name=__codelineno-34-16 href=#__codelineno-34-16></a><span class=gp>... </span>    <span class=n>upper_</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>to_1d_array_nb</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>upper</span><span class=p>))</span>
</span><span id=__span-34-17><a id=__codelineno-34-17 name=__codelineno-34-17 href=#__codelineno-34-17></a><span class=gp>... </span>    <span class=n>lower_</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>to_1d_array_nb</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>lower</span><span class=p>))</span>
</span><span id=__span-34-18><a id=__codelineno-34-18 name=__codelineno-34-18 href=#__codelineno-34-18></a><span class=gp>... </span>    <span class=n>sl_stop_</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>to_1d_array_nb</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>sl_stop</span><span class=p>))</span>
</span><span id=__span-34-19><a id=__codelineno-34-19 name=__codelineno-34-19 href=#__codelineno-34-19></a><span class=gp>... </span>    <span class=n>tsl_stop_</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>to_1d_array_nb</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>tsl_stop</span><span class=p>))</span>
</span><span id=__span-34-20><a id=__codelineno-34-20 name=__codelineno-34-20 href=#__codelineno-34-20></a><span class=gp>... </span>    <span class=n>tp_stop_</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>to_1d_array_nb</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>tp_stop</span><span class=p>))</span>
</span><span id=__span-34-21><a id=__codelineno-34-21 name=__codelineno-34-21 href=#__codelineno-34-21></a><span class=gp>...</span>
</span><span id=__span-34-22><a id=__codelineno-34-22 name=__codelineno-34-22 href=#__codelineno-34-22></a><span class=gp>... </span>    <span class=n>total_return</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>n_params</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>float_</span><span class=p>)</span>  <span class=c1># (5)!</span>
</span><span id=__span-34-23><a id=__codelineno-34-23 name=__codelineno-34-23 href=#__codelineno-34-23></a><span class=gp>... </span>    <span class=n>expectancy</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>n_params</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>float_</span><span class=p>)</span>
</span><span id=__span-34-24><a id=__codelineno-34-24 name=__codelineno-34-24 href=#__codelineno-34-24></a><span class=gp>...</span>
</span><span id=__span-34-25><a id=__codelineno-34-25 name=__codelineno-34-25 href=#__codelineno-34-25></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_params</span><span class=p>):</span>  <span class=c1># (6)!</span>
</span><span id=__span-34-26><a id=__codelineno-34-26 name=__codelineno-34-26 href=#__codelineno-34-26></a><span class=gp>... </span>        <span class=n>total_return</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>expectancy</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>pt_pipeline_nb</span><span class=p>(</span>
</span><span id=__span-34-27><a id=__codelineno-34-27 name=__codelineno-34-27 href=#__codelineno-34-27></a><span class=gp>... </span>            <span class=nb>open</span><span class=p>,</span>
</span><span id=__span-34-28><a id=__codelineno-34-28 name=__codelineno-34-28 href=#__codelineno-34-28></a><span class=gp>... </span>            <span class=n>high</span><span class=p>,</span>
</span><span id=__span-34-29><a id=__codelineno-34-29 name=__codelineno-34-29 href=#__codelineno-34-29></a><span class=gp>... </span>            <span class=n>low</span><span class=p>,</span>
</span><span id=__span-34-30><a id=__codelineno-34-30 name=__codelineno-34-30 href=#__codelineno-34-30></a><span class=gp>... </span>            <span class=n>close</span><span class=p>,</span>
</span><span id=__span-34-31><a id=__codelineno-34-31 name=__codelineno-34-31 href=#__codelineno-34-31></a><span class=gp>... </span>            <span class=n>window</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_1d_nb</span><span class=p>(</span><span class=n>window_</span><span class=p>,</span> <span class=n>i</span><span class=p>),</span>  <span class=c1># (7)!</span>
</span><span id=__span-34-32><a id=__codelineno-34-32 name=__codelineno-34-32 href=#__codelineno-34-32></a><span class=gp>... </span>            <span class=n>upper</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_1d_nb</span><span class=p>(</span><span class=n>upper_</span><span class=p>,</span> <span class=n>i</span><span class=p>),</span>
</span><span id=__span-34-33><a id=__codelineno-34-33 name=__codelineno-34-33 href=#__codelineno-34-33></a><span class=gp>... </span>            <span class=n>lower</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_1d_nb</span><span class=p>(</span><span class=n>lower_</span><span class=p>,</span> <span class=n>i</span><span class=p>),</span>
</span><span id=__span-34-34><a id=__codelineno-34-34 name=__codelineno-34-34 href=#__codelineno-34-34></a><span class=gp>... </span>            <span class=n>sl_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_1d_nb</span><span class=p>(</span><span class=n>sl_stop_</span><span class=p>,</span> <span class=n>i</span><span class=p>),</span>
</span><span id=__span-34-35><a id=__codelineno-34-35 name=__codelineno-34-35 href=#__codelineno-34-35></a><span class=gp>... </span>            <span class=n>tsl_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_1d_nb</span><span class=p>(</span><span class=n>tsl_stop_</span><span class=p>,</span> <span class=n>i</span><span class=p>),</span>
</span><span id=__span-34-36><a id=__codelineno-34-36 name=__codelineno-34-36 href=#__codelineno-34-36></a><span class=gp>... </span>            <span class=n>tp_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_1d_nb</span><span class=p>(</span><span class=n>tp_stop_</span><span class=p>,</span> <span class=n>i</span><span class=p>),</span>
</span><span id=__span-34-37><a id=__codelineno-34-37 name=__codelineno-34-37 href=#__codelineno-34-37></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-34-38><a id=__codelineno-34-38 name=__codelineno-34-38 href=#__codelineno-34-38></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>total_return</span><span class=p>,</span> <span class=n>expectancy</span>
</span></code></pre></div> <ol> <li>Number of parameter combinations in the chunk. This should be equal to the length of each parameter array.</li> <li>These are called <a href=https://realpython.com/lessons/type-hinting/ >type hints</a>: they are not used by VBT (yet), but they help you quickly understand the expected argument format. Type hint <code>Array2d</code> refers to a two-dimensional NumPy array.</li> <li>The type hint <code>FlexArray1dLike</code> means either a single value or any NumPy array that broadcasts against <code>n_params</code>.</li> <li>The required function below expects each parameter to be a one-dimensional NumPy array, so we convert each to 1D in case it is not already. The result is saved to a new variable.</li> <li>Create empty NumPy arrays to return. We will populate them gradually in the loop below.</li> <li>Iterate over all parameter combinations in the chunk.</li> <li>Select the parameter value for the current combination.</li> </ol> <p>The magic of this function is that you do not need to make all parameters into arrays. Thanks to flexible indexing, you can pass some parameters as arrays and keep others at their default values. For example, you can test three window combinations like this:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pt_pipeline_mult_nb</span><span class=p>(</span>
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a><span class=gp>... </span>    <span class=mi>3</span><span class=p>,</span>
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>open</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-35-4><a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>high</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-35-5><a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-35-6><a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>close</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-35-7><a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a><span class=gp>... </span>    <span class=n>window</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>10</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>30</span><span class=p>])</span>
</span><span id=__span-35-8><a id=__codelineno-35-8 name=__codelineno-35-8 href=#__codelineno-35-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-35-9><a id=__codelineno-35-9 name=__codelineno-35-9 href=#__codelineno-35-9></a><span class=go>(array([ 0.11131525, -0.04819178,  0.13124959]),</span>
</span><span id=__span-35-10><a id=__codelineno-35-10 name=__codelineno-35-10 href=#__codelineno-35-10></a><span class=go> array([ 0.01039436, -0.00483853,  0.01756337]))</span>
</span></code></pre></div> <p>Next, we will wrap the function with the <code>@chunked</code> decorator. Unlike <code>@parameterized</code>, we must specify not only the chunks but also where to get the total number of parameter combinations and how to split each individual argument. To help with this, VBT provides a collection of annotation classes. For example, we can instruct <code>@chunked</code> to obtain the total number of combinations from the argument <code>n_params</code> by annotating this argument with the class <a href=https://vectorbt.pro/pvt_41531c19/api/utils/chunking/#vectorbtpro.utils.chunking.ArgSizer>ArgSizer</a>. Then, we annotate each parameter as a flexible one-dimensional array using the class <a href=https://vectorbt.pro/pvt_41531c19/api/utils/chunking/#vectorbtpro.utils.chunking.FlexArraySlicer>FlexArraySlicer</a>. When <code>@chunked</code> builds a new chunk, it will "slice" the corresponding subset of values from each parameter array.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>chunked_pt_pipeline</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>chunked</span><span class=p>(</span>
</span><span id=__span-36-2><a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a><span class=gp>... </span>    <span class=n>pt_pipeline_mult_nb</span><span class=p>,</span>
</span><span id=__span-36-3><a id=__codelineno-36-3 name=__codelineno-36-3 href=#__codelineno-36-3></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>ArgSizer</span><span class=p>(</span><span class=n>arg_query</span><span class=o>=</span><span class=s2>&quot;n_params&quot;</span><span class=p>),</span>
</span><span id=__span-36-4><a id=__codelineno-36-4 name=__codelineno-36-4 href=#__codelineno-36-4></a><span class=gp>... </span>    <span class=n>arg_take_spec</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-36-5><a id=__codelineno-36-5 name=__codelineno-36-5 href=#__codelineno-36-5></a><span class=gp>... </span>        <span class=n>n_params</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>CountAdapter</span><span class=p>(),</span>
</span><span id=__span-36-6><a id=__codelineno-36-6 name=__codelineno-36-6 href=#__codelineno-36-6></a><span class=gp>... </span>        <span class=nb>open</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-36-7><a id=__codelineno-36-7 name=__codelineno-36-7 href=#__codelineno-36-7></a><span class=gp>... </span>        <span class=n>high</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span><span id=__span-36-8><a id=__codelineno-36-8 name=__codelineno-36-8 href=#__codelineno-36-8></a><span class=gp>... </span>        <span class=n>low</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span><span id=__span-36-9><a id=__codelineno-36-9 name=__codelineno-36-9 href=#__codelineno-36-9></a><span class=gp>... </span>        <span class=n>close</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span><span id=__span-36-10><a id=__codelineno-36-10 name=__codelineno-36-10 href=#__codelineno-36-10></a><span class=gp>... </span>        <span class=n>window</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>FlexArraySlicer</span><span class=p>(),</span>
</span><span id=__span-36-11><a id=__codelineno-36-11 name=__codelineno-36-11 href=#__codelineno-36-11></a><span class=gp>... </span>        <span class=n>upper</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>FlexArraySlicer</span><span class=p>(),</span>
</span><span id=__span-36-12><a id=__codelineno-36-12 name=__codelineno-36-12 href=#__codelineno-36-12></a><span class=gp>... </span>        <span class=n>lower</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>FlexArraySlicer</span><span class=p>(),</span>
</span><span id=__span-36-13><a id=__codelineno-36-13 name=__codelineno-36-13 href=#__codelineno-36-13></a><span class=gp>... </span>        <span class=n>sl_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>FlexArraySlicer</span><span class=p>(),</span>
</span><span id=__span-36-14><a id=__codelineno-36-14 name=__codelineno-36-14 href=#__codelineno-36-14></a><span class=gp>... </span>        <span class=n>tsl_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>FlexArraySlicer</span><span class=p>(),</span>
</span><span id=__span-36-15><a id=__codelineno-36-15 name=__codelineno-36-15 href=#__codelineno-36-15></a><span class=gp>... </span>        <span class=n>tp_stop</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>FlexArraySlicer</span><span class=p>()</span>
</span><span id=__span-36-16><a id=__codelineno-36-16 name=__codelineno-36-16 href=#__codelineno-36-16></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-36-17><a id=__codelineno-36-17 name=__codelineno-36-17 href=#__codelineno-36-17></a><span class=gp>... </span>    <span class=n>chunk_len</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-36-18><a id=__codelineno-36-18 name=__codelineno-36-18 href=#__codelineno-36-18></a><span class=gp>... </span>    <span class=n>merge_func</span><span class=o>=</span><span class=s2>&quot;concat&quot;</span><span class=p>,</span>  <span class=c1># (3)!</span>
</span><span id=__span-36-19><a id=__codelineno-36-19 name=__codelineno-36-19 href=#__codelineno-36-19></a><span class=gp>... </span>    <span class=n>execute_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>  <span class=c1># (4)!</span>
</span><span id=__span-36-20><a id=__codelineno-36-20 name=__codelineno-36-20 href=#__codelineno-36-20></a><span class=gp>... </span>        <span class=n>chunk_len</span><span class=o>=</span><span class=s2>&quot;auto&quot;</span><span class=p>,</span>
</span><span id=__span-36-21><a id=__codelineno-36-21 name=__codelineno-36-21 href=#__codelineno-36-21></a><span class=gp>... </span>        <span class=n>engine</span><span class=o>=</span><span class=s2>&quot;threadpool&quot;</span>
</span><span id=__span-36-22><a id=__codelineno-36-22 name=__codelineno-36-22 href=#__codelineno-36-22></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-36-23><a id=__codelineno-36-23 name=__codelineno-36-23 href=#__codelineno-36-23></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <ol> <li>Set arguments that should be passed without chunking to None.</li> <li>At most 1,000 parameter combinations are passed to <code>pt_pipeline_mult_nb</code> at once.</li> <li>Concatenate the resulting arrays.</li> <li>In addition to chunking the parameter arrays, we can also bundle chunks into "super chunks". Each super chunk consists of as many chunks as there are CPU cores, with one chunk per thread.</li> </ol> <p>Here is what happens: whenever you call <code>chunked_pt_pipeline</code>, it retrieves the total number of parameter combinations from the argument <code>n_params</code>. Chunks of length 1,000 are created, and each chunk is sliced from the parameter arguments; one chunk corresponds to a single call to <code>pt_pipeline_mult_nb</code>. To parallelize chunk execution, we group them into super chunks. Chunks inside each super chunk are processed in parallel, while super chunks themselves run serially. The progress bar reflects the progress of super chunks.</p> <p>Now, let's build the complete parameter grid and run our function:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>param_product</span><span class=p>,</span> <span class=n>param_index</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>combine_params</span><span class=p>(</span>  <span class=c1># (1)!</span>
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a><span class=gp>... </span>    <span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-37-3><a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a><span class=gp>... </span>        <span class=n>window</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span><span class=n>WINDOW_SPACE</span><span class=p>),</span>  <span class=c1># (2)!</span>
</span><span id=__span-37-4><a id=__codelineno-37-4 name=__codelineno-37-4 href=#__codelineno-37-4></a><span class=gp>... </span>        <span class=n>upper</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span><span class=n>UPPER_SPACE</span><span class=p>),</span>
</span><span id=__span-37-5><a id=__codelineno-37-5 name=__codelineno-37-5 href=#__codelineno-37-5></a><span class=gp>... </span>        <span class=n>lower</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span><span class=n>LOWER_SPACE</span><span class=p>)</span>
</span><span id=__span-37-6><a id=__codelineno-37-6 name=__codelineno-37-6 href=#__codelineno-37-6></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-37-7><a id=__codelineno-37-7 name=__codelineno-37-7 href=#__codelineno-37-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-37-8><a id=__codelineno-37-8 name=__codelineno-37-8 href=#__codelineno-37-8></a>
</span><span id=__span-37-9><a id=__codelineno-37-9 name=__codelineno-37-9 href=#__codelineno-37-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>COPT_FILE</span> <span class=o>=</span> <span class=s2>&quot;temp/chunked_opt.pickle&quot;</span>
</span><span id=__span-37-10><a id=__codelineno-37-10 name=__codelineno-37-10 href=#__codelineno-37-10></a>
</span><span id=__span-37-11><a id=__codelineno-37-11 name=__codelineno-37-11 href=#__codelineno-37-11></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># vbt.remove_file(COPT_FILE, missing_ok=True)</span>
</span><span id=__span-37-12><a id=__codelineno-37-12 name=__codelineno-37-12 href=#__codelineno-37-12></a><span class=gp>&gt;&gt;&gt; </span><span class=k>if</span> <span class=ow>not</span> <span class=n>vbt</span><span class=o>.</span><span class=n>file_exists</span><span class=p>(</span><span class=n>COPT_FILE</span><span class=p>):</span>
</span><span id=__span-37-13><a id=__codelineno-37-13 name=__codelineno-37-13 href=#__codelineno-37-13></a><span class=gp>... </span>    <span class=n>chunked_opt</span> <span class=o>=</span> <span class=n>chunked_pt_pipeline</span><span class=p>(</span>
</span><span id=__span-37-14><a id=__codelineno-37-14 name=__codelineno-37-14 href=#__codelineno-37-14></a><span class=gp>... </span>        <span class=nb>len</span><span class=p>(</span><span class=n>param_index</span><span class=p>),</span>  <span class=c1># (3)!</span>
</span><span id=__span-37-15><a id=__codelineno-37-15 name=__codelineno-37-15 href=#__codelineno-37-15></a><span class=gp>... </span>        <span class=n>data</span><span class=o>.</span><span class=n>open</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-37-16><a id=__codelineno-37-16 name=__codelineno-37-16 href=#__codelineno-37-16></a><span class=gp>... </span>        <span class=n>data</span><span class=o>.</span><span class=n>high</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-37-17><a id=__codelineno-37-17 name=__codelineno-37-17 href=#__codelineno-37-17></a><span class=gp>... </span>        <span class=n>data</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-37-18><a id=__codelineno-37-18 name=__codelineno-37-18 href=#__codelineno-37-18></a><span class=gp>... </span>        <span class=n>data</span><span class=o>.</span><span class=n>close</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-37-19><a id=__codelineno-37-19 name=__codelineno-37-19 href=#__codelineno-37-19></a><span class=gp>... </span>        <span class=n>window</span><span class=o>=</span><span class=n>param_product</span><span class=p>[</span><span class=s2>&quot;window&quot;</span><span class=p>],</span>
</span><span id=__span-37-20><a id=__codelineno-37-20 name=__codelineno-37-20 href=#__codelineno-37-20></a><span class=gp>... </span>        <span class=n>upper</span><span class=o>=</span><span class=n>param_product</span><span class=p>[</span><span class=s2>&quot;upper&quot;</span><span class=p>],</span>
</span><span id=__span-37-21><a id=__codelineno-37-21 name=__codelineno-37-21 href=#__codelineno-37-21></a><span class=gp>... </span>        <span class=n>lower</span><span class=o>=</span><span class=n>param_product</span><span class=p>[</span><span class=s2>&quot;lower&quot;</span><span class=p>]</span>
</span><span id=__span-37-22><a id=__codelineno-37-22 name=__codelineno-37-22 href=#__codelineno-37-22></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-37-23><a id=__codelineno-37-23 name=__codelineno-37-23 href=#__codelineno-37-23></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>chunked_opt</span><span class=p>,</span> <span class=n>COPT_FILE</span><span class=p>)</span>
</span><span id=__span-37-24><a id=__codelineno-37-24 name=__codelineno-37-24 href=#__codelineno-37-24></a><span class=gp>... </span><span class=k>else</span><span class=p>:</span>
</span><span id=__span-37-25><a id=__codelineno-37-25 name=__codelineno-37-25 href=#__codelineno-37-25></a><span class=gp>... </span>    <span class=n>chunked_opt</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>COPT_FILE</span><span class=p>)</span>
</span></code></pre></div> <ol> <li>Returns a dictionary of new parameter arrays and the associated index.</li> <li>Uses the same format as for <code>@parameterized</code>.</li> <li>Total number of parameter combinations.</li> </ol> <p> <div class="progress progress-100plus candystripe candystripe-animate"> <div class=progress-bar style=width:100.00%> <p class=progress-label>Super chunk 56/56</p> </div> </div> </p> <p>This approach runs about 40% faster than the previous method because the overhead of spawning a thread is proportionally much lower compared to the larger workload within each thread. Additionally, memory usage does not increase, since <code>pt_pipeline_mult_nb</code> still processes only one parameter combination at a time.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>total_return</span><span class=p>,</span> <span class=n>expectancy</span> <span class=o>=</span> <span class=n>chunked_opt</span>
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a>
</span><span id=__span-38-3><a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>total_return</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>(</span><span class=n>total_return</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=n>param_index</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-38-4><a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>expectancy</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>(</span><span class=n>expectancy</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=n>param_index</span><span class=p>)</span>
</span></code></pre></div> <ol> <li>The parameter index becomes the index for each array.</li> </ol> <p>There are only two limitations left: generating parameter combinations takes a significant amount of time, and if execution is interrupted, all optimization results are lost. These issues can be addressed by creating a while-loop that, at each step, generates a subset of parameter combinations, executes them, and saves the results to disk. This continues until all combinations have been processed successfully. Another advantage is that you can resume from where execution last stopped, or even run the optimization until you find a satisfactory set of parameters.</p> <p>Suppose you want to include the stop parameters as well, but only execute a random subset of parameter combinations. Generating all of them with <a href=https://vectorbt.pro/pvt_41531c19/api/utils/params/#vectorbtpro.utils.params.combine_params>combine_params</a> would not be feasible:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>GRID_LEN</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>WINDOW_SPACE</span><span class=p>)</span> <span class=o>*</span> \
</span><span id=__span-39-2><a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a><span class=gp>... </span>    <span class=nb>len</span><span class=p>(</span><span class=n>UPPER_SPACE</span><span class=p>)</span> <span class=o>*</span> \
</span><span id=__span-39-3><a id=__codelineno-39-3 name=__codelineno-39-3 href=#__codelineno-39-3></a><span class=gp>... </span>    <span class=nb>len</span><span class=p>(</span><span class=n>LOWER_SPACE</span><span class=p>)</span> <span class=o>*</span> \
</span><span id=__span-39-4><a id=__codelineno-39-4 name=__codelineno-39-4 href=#__codelineno-39-4></a><span class=gp>... </span>    <span class=nb>len</span><span class=p>(</span><span class=n>STOP_SPACE</span><span class=p>)</span> <span class=o>**</span> <span class=mi>3</span>
</span><span id=__span-39-5><a id=__codelineno-39-5 name=__codelineno-39-5 href=#__codelineno-39-5></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=n>GRID_LEN</span><span class=p>)</span>
</span><span id=__span-39-6><a id=__codelineno-39-6 name=__codelineno-39-6 href=#__codelineno-39-6></a><span class=go>441045000000</span>
</span></code></pre></div> <p>There are nearly half a trillion parameter combinations <img alt=😮‍💨 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f62e-200d-1f4a8.svg title=:face_exhaling:></p> <p>Instead, we can select parameter combinations more efficiently using the <a href=https://vectorbt.pro/pvt_41531c19/api/utils/params/#vectorbtpro.utils.params.pick_from_param_grid>pick_from_param_grid</a> function. This function takes a dictionary of parameter spaces (order matters), as well as the position of the combination of interest, and returns the specific parameter combination at that position. For example, to pick the combination at index 123,456,789:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-40-1><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>GRID</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-40-2><a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a><span class=gp>... </span>    <span class=n>window</span><span class=o>=</span><span class=n>WINDOW_SPACE</span><span class=p>,</span>
</span><span id=__span-40-3><a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a><span class=gp>... </span>    <span class=n>upper</span><span class=o>=</span><span class=n>UPPER_SPACE</span><span class=p>,</span>
</span><span id=__span-40-4><a id=__codelineno-40-4 name=__codelineno-40-4 href=#__codelineno-40-4></a><span class=gp>... </span>    <span class=n>lower</span><span class=o>=</span><span class=n>LOWER_SPACE</span><span class=p>,</span>
</span><span id=__span-40-5><a id=__codelineno-40-5 name=__codelineno-40-5 href=#__codelineno-40-5></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=n>STOP_SPACE</span><span class=p>,</span>
</span><span id=__span-40-6><a id=__codelineno-40-6 name=__codelineno-40-6 href=#__codelineno-40-6></a><span class=gp>... </span>    <span class=n>tsl_stop</span><span class=o>=</span><span class=n>STOP_SPACE</span><span class=p>,</span>
</span><span id=__span-40-7><a id=__codelineno-40-7 name=__codelineno-40-7 href=#__codelineno-40-7></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=n>STOP_SPACE</span><span class=p>,</span>
</span><span id=__span-40-8><a id=__codelineno-40-8 name=__codelineno-40-8 href=#__codelineno-40-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-40-9><a id=__codelineno-40-9 name=__codelineno-40-9 href=#__codelineno-40-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vbt</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>pick_from_param_grid</span><span class=p>(</span><span class=n>GRID</span><span class=p>,</span> <span class=mi>123_456_789</span><span class=p>))</span>
</span><span id=__span-40-10><a id=__codelineno-40-10 name=__codelineno-40-10 href=#__codelineno-40-10></a><span class=go>dict(</span>
</span><span id=__span-40-11><a id=__codelineno-40-11 name=__codelineno-40-11 href=#__codelineno-40-11></a><span class=go>    window=5,</span>
</span><span id=__span-40-12><a id=__codelineno-40-12 name=__codelineno-40-12 href=#__codelineno-40-12></a><span class=go>    upper=3.090232306167813,</span>
</span><span id=__span-40-13><a id=__codelineno-40-13 name=__codelineno-40-13 href=#__codelineno-40-13></a><span class=go>    lower=-2.241402727604947,</span>
</span><span id=__span-40-14><a id=__codelineno-40-14 name=__codelineno-40-14 href=#__codelineno-40-14></a><span class=go>    sl_stop=45.0,</span>
</span><span id=__span-40-15><a id=__codelineno-40-15 name=__codelineno-40-15 href=#__codelineno-40-15></a><span class=go>    tsl_stop=67.0,</span>
</span><span id=__span-40-16><a id=__codelineno-40-16 name=__codelineno-40-16 href=#__codelineno-40-16></a><span class=go>    tp_stop=89.0</span>
</span><span id=__span-40-17><a id=__codelineno-40-17 name=__codelineno-40-17 href=#__codelineno-40-17></a><span class=go>)</span>
</span></code></pre></div> <p>This gives you the exact parameter combination you would get by combining all parameters and running <code>param_index[123_456_789]</code>, but with almost no impact on performance or memory!</p> <p>Now, we can build our while-loop. Let's perform a random parameter search until we get at least 100 values with expectancy of 1 or more!</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-41-1><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>FOUND_FILE</span> <span class=o>=</span> <span class=s2>&quot;temp/found.pickle&quot;</span>
</span><span id=__span-41-2><a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>BEST_N</span> <span class=o>=</span> <span class=mi>100</span>  <span class=c1># (1)!</span>
</span><span id=__span-41-3><a id=__codelineno-41-3 name=__codelineno-41-3 href=#__codelineno-41-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>BEST_TH</span> <span class=o>=</span> <span class=mf>1.0</span>  <span class=c1># (2)!</span>
</span><span id=__span-41-4><a id=__codelineno-41-4 name=__codelineno-41-4 href=#__codelineno-41-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>CHUNK_LEN</span> <span class=o>=</span> <span class=mi>10_000</span>  <span class=c1># (3)!</span>
</span><span id=__span-41-5><a id=__codelineno-41-5 name=__codelineno-41-5 href=#__codelineno-41-5></a>
</span><span id=__span-41-6><a id=__codelineno-41-6 name=__codelineno-41-6 href=#__codelineno-41-6></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># vbt.remove_file(FOUND_FILE, missing_ok=True)</span>
</span><span id=__span-41-7><a id=__codelineno-41-7 name=__codelineno-41-7 href=#__codelineno-41-7></a><span class=gp>&gt;&gt;&gt; </span><span class=k>if</span> <span class=n>vbt</span><span class=o>.</span><span class=n>file_exists</span><span class=p>(</span><span class=n>FOUND_FILE</span><span class=p>):</span>
</span><span id=__span-41-8><a id=__codelineno-41-8 name=__codelineno-41-8 href=#__codelineno-41-8></a><span class=gp>... </span>    <span class=n>found</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>FOUND_FILE</span><span class=p>)</span>  <span class=c1># (4)!</span>
</span><span id=__span-41-9><a id=__codelineno-41-9 name=__codelineno-41-9 href=#__codelineno-41-9></a><span class=gp>&gt;&gt;&gt; </span><span class=k>else</span><span class=p>:</span>
</span><span id=__span-41-10><a id=__codelineno-41-10 name=__codelineno-41-10 href=#__codelineno-41-10></a><span class=gp>... </span>    <span class=n>found</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-41-11><a id=__codelineno-41-11 name=__codelineno-41-11 href=#__codelineno-41-11></a><span class=gp>&gt;&gt;&gt; </span><span class=k>with</span> <span class=p>(</span>  <span class=c1># (5)!</span>
</span><span id=__span-41-12><a id=__codelineno-41-12 name=__codelineno-41-12 href=#__codelineno-41-12></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>ProgressBar</span><span class=p>(</span>
</span><span id=__span-41-13><a id=__codelineno-41-13 name=__codelineno-41-13 href=#__codelineno-41-13></a><span class=gp>... </span>        <span class=n>desc</span><span class=o>=</span><span class=s2>&quot;Found&quot;</span><span class=p>,</span> 
</span><span id=__span-41-14><a id=__codelineno-41-14 name=__codelineno-41-14 href=#__codelineno-41-14></a><span class=gp>... </span>        <span class=n>initial</span><span class=o>=</span><span class=mi>0</span> <span class=k>if</span> <span class=n>found</span> <span class=ow>is</span> <span class=kc>None</span> <span class=k>else</span> <span class=nb>len</span><span class=p>(</span><span class=n>found</span><span class=p>),</span>
</span><span id=__span-41-15><a id=__codelineno-41-15 name=__codelineno-41-15 href=#__codelineno-41-15></a><span class=gp>... </span>        <span class=n>total</span><span class=o>=</span><span class=n>BEST_N</span>
</span><span id=__span-41-16><a id=__codelineno-41-16 name=__codelineno-41-16 href=#__codelineno-41-16></a><span class=gp>... </span>    <span class=p>)</span> <span class=k>as</span> <span class=n>pbar1</span><span class=p>,</span>
</span><span id=__span-41-17><a id=__codelineno-41-17 name=__codelineno-41-17 href=#__codelineno-41-17></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>ProgressBar</span><span class=p>(</span>
</span><span id=__span-41-18><a id=__codelineno-41-18 name=__codelineno-41-18 href=#__codelineno-41-18></a><span class=gp>... </span>        <span class=n>desc</span><span class=o>=</span><span class=s2>&quot;Processed&quot;</span>
</span><span id=__span-41-19><a id=__codelineno-41-19 name=__codelineno-41-19 href=#__codelineno-41-19></a><span class=gp>... </span>    <span class=p>)</span> <span class=k>as</span> <span class=n>pbar2</span>
</span><span id=__span-41-20><a id=__codelineno-41-20 name=__codelineno-41-20 href=#__codelineno-41-20></a><span class=gp>... </span><span class=p>):</span>
</span><span id=__span-41-21><a id=__codelineno-41-21 name=__codelineno-41-21 href=#__codelineno-41-21></a><span class=gp>... </span>    <span class=k>while</span> <span class=n>found</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>or</span> <span class=nb>len</span><span class=p>(</span><span class=n>found</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>BEST_N</span><span class=p>:</span>  <span class=c1># (6)!</span>
</span><span id=__span-41-22><a id=__codelineno-41-22 name=__codelineno-41-22 href=#__codelineno-41-22></a><span class=gp>... </span>        <span class=n>param_df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>([</span>
</span><span id=__span-41-23><a id=__codelineno-41-23 name=__codelineno-41-23 href=#__codelineno-41-23></a><span class=gp>... </span>            <span class=n>vbt</span><span class=o>.</span><span class=n>pick_from_param_grid</span><span class=p>(</span><span class=n>GRID</span><span class=p>)</span>  <span class=c1># (7)!</span>
</span><span id=__span-41-24><a id=__codelineno-41-24 name=__codelineno-41-24 href=#__codelineno-41-24></a><span class=gp>... </span>            <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>CHUNK_LEN</span><span class=p>)</span>
</span><span id=__span-41-25><a id=__codelineno-41-25 name=__codelineno-41-25 href=#__codelineno-41-25></a><span class=gp>... </span>        <span class=p>])</span>
</span><span id=__span-41-26><a id=__codelineno-41-26 name=__codelineno-41-26 href=#__codelineno-41-26></a><span class=gp>... </span>        <span class=n>param_index</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>MultiIndex</span><span class=o>.</span><span class=n>from_frame</span><span class=p>(</span><span class=n>param_df</span><span class=p>)</span>
</span><span id=__span-41-27><a id=__codelineno-41-27 name=__codelineno-41-27 href=#__codelineno-41-27></a><span class=gp>... </span>        <span class=n>_</span><span class=p>,</span> <span class=n>expectancy</span> <span class=o>=</span> <span class=n>chunked_pt_pipeline</span><span class=p>(</span>  <span class=c1># (8)!</span>
</span><span id=__span-41-28><a id=__codelineno-41-28 name=__codelineno-41-28 href=#__codelineno-41-28></a><span class=gp>... </span>            <span class=n>CHUNK_LEN</span><span class=p>,</span>
</span><span id=__span-41-29><a id=__codelineno-41-29 name=__codelineno-41-29 href=#__codelineno-41-29></a><span class=gp>... </span>            <span class=n>data</span><span class=o>.</span><span class=n>open</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-41-30><a id=__codelineno-41-30 name=__codelineno-41-30 href=#__codelineno-41-30></a><span class=gp>... </span>            <span class=n>data</span><span class=o>.</span><span class=n>high</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-41-31><a id=__codelineno-41-31 name=__codelineno-41-31 href=#__codelineno-41-31></a><span class=gp>... </span>            <span class=n>data</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-41-32><a id=__codelineno-41-32 name=__codelineno-41-32 href=#__codelineno-41-32></a><span class=gp>... </span>            <span class=n>data</span><span class=o>.</span><span class=n>close</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-41-33><a id=__codelineno-41-33 name=__codelineno-41-33 href=#__codelineno-41-33></a><span class=gp>... </span>            <span class=n>window</span><span class=o>=</span><span class=n>param_df</span><span class=p>[</span><span class=s2>&quot;window&quot;</span><span class=p>],</span>
</span><span id=__span-41-34><a id=__codelineno-41-34 name=__codelineno-41-34 href=#__codelineno-41-34></a><span class=gp>... </span>            <span class=n>upper</span><span class=o>=</span><span class=n>param_df</span><span class=p>[</span><span class=s2>&quot;upper&quot;</span><span class=p>],</span>
</span><span id=__span-41-35><a id=__codelineno-41-35 name=__codelineno-41-35 href=#__codelineno-41-35></a><span class=gp>... </span>            <span class=n>lower</span><span class=o>=</span><span class=n>param_df</span><span class=p>[</span><span class=s2>&quot;lower&quot;</span><span class=p>],</span>
</span><span id=__span-41-36><a id=__codelineno-41-36 name=__codelineno-41-36 href=#__codelineno-41-36></a><span class=gp>... </span>            <span class=n>sl_stop</span><span class=o>=</span><span class=n>param_df</span><span class=p>[</span><span class=s2>&quot;sl_stop&quot;</span><span class=p>],</span>
</span><span id=__span-41-37><a id=__codelineno-41-37 name=__codelineno-41-37 href=#__codelineno-41-37></a><span class=gp>... </span>            <span class=n>tsl_stop</span><span class=o>=</span><span class=n>param_df</span><span class=p>[</span><span class=s2>&quot;tsl_stop&quot;</span><span class=p>],</span>
</span><span id=__span-41-38><a id=__codelineno-41-38 name=__codelineno-41-38 href=#__codelineno-41-38></a><span class=gp>... </span>            <span class=n>tp_stop</span><span class=o>=</span><span class=n>param_df</span><span class=p>[</span><span class=s2>&quot;tp_stop&quot;</span><span class=p>],</span>
</span><span id=__span-41-39><a id=__codelineno-41-39 name=__codelineno-41-39 href=#__codelineno-41-39></a><span class=gp>... </span>            <span class=n>_chunk_len</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span><span id=__span-41-40><a id=__codelineno-41-40 name=__codelineno-41-40 href=#__codelineno-41-40></a><span class=gp>... </span>            <span class=n>_execute_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-41-41><a id=__codelineno-41-41 name=__codelineno-41-41 href=#__codelineno-41-41></a><span class=gp>... </span>                <span class=n>chunk_len</span><span class=o>=</span><span class=kc>None</span>
</span><span id=__span-41-42><a id=__codelineno-41-42 name=__codelineno-41-42 href=#__codelineno-41-42></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-41-43><a id=__codelineno-41-43 name=__codelineno-41-43 href=#__codelineno-41-43></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-41-44><a id=__codelineno-41-44 name=__codelineno-41-44 href=#__codelineno-41-44></a><span class=gp>... </span>        <span class=n>expectancy</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>(</span><span class=n>expectancy</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=n>param_index</span><span class=p>)</span>
</span><span id=__span-41-45><a id=__codelineno-41-45 name=__codelineno-41-45 href=#__codelineno-41-45></a><span class=gp>... </span>        <span class=n>best_mask</span> <span class=o>=</span> <span class=n>expectancy</span> <span class=o>&gt;=</span> <span class=n>BEST_TH</span>
</span><span id=__span-41-46><a id=__codelineno-41-46 name=__codelineno-41-46 href=#__codelineno-41-46></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>best_mask</span><span class=o>.</span><span class=n>any</span><span class=p>():</span>  <span class=c1># (9)!</span>
</span><span id=__span-41-47><a id=__codelineno-41-47 name=__codelineno-41-47 href=#__codelineno-41-47></a><span class=gp>... </span>            <span class=n>best</span> <span class=o>=</span> <span class=n>expectancy</span><span class=p>[</span><span class=n>best_mask</span><span class=p>]</span>
</span><span id=__span-41-48><a id=__codelineno-41-48 name=__codelineno-41-48 href=#__codelineno-41-48></a><span class=gp>... </span>            <span class=k>if</span> <span class=n>found</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-41-49><a id=__codelineno-41-49 name=__codelineno-41-49 href=#__codelineno-41-49></a><span class=gp>... </span>                <span class=n>found</span> <span class=o>=</span> <span class=n>best</span>
</span><span id=__span-41-50><a id=__codelineno-41-50 name=__codelineno-41-50 href=#__codelineno-41-50></a><span class=gp>... </span>            <span class=k>else</span><span class=p>:</span>
</span><span id=__span-41-51><a id=__codelineno-41-51 name=__codelineno-41-51 href=#__codelineno-41-51></a><span class=gp>... </span>                <span class=n>found</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>((</span><span class=n>found</span><span class=p>,</span> <span class=n>best</span><span class=p>))</span>
</span><span id=__span-41-52><a id=__codelineno-41-52 name=__codelineno-41-52 href=#__codelineno-41-52></a><span class=gp>... </span>                <span class=n>found</span> <span class=o>=</span> <span class=n>found</span><span class=p>[</span><span class=o>~</span><span class=n>found</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>duplicated</span><span class=p>(</span><span class=n>keep</span><span class=o>=</span><span class=s2>&quot;first&quot;</span><span class=p>)]</span>
</span><span id=__span-41-53><a id=__codelineno-41-53 name=__codelineno-41-53 href=#__codelineno-41-53></a><span class=gp>... </span>            <span class=n>vbt</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>found</span><span class=p>,</span> <span class=n>FOUND_FILE</span><span class=p>)</span>
</span><span id=__span-41-54><a id=__codelineno-41-54 name=__codelineno-41-54 href=#__codelineno-41-54></a><span class=gp>... </span>            <span class=n>pbar1</span><span class=o>.</span><span class=n>update_to</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>found</span><span class=p>))</span>
</span><span id=__span-41-55><a id=__codelineno-41-55 name=__codelineno-41-55 href=#__codelineno-41-55></a><span class=gp>... </span>            <span class=n>pbar1</span><span class=o>.</span><span class=n>refresh</span><span class=p>()</span>
</span><span id=__span-41-56><a id=__codelineno-41-56 name=__codelineno-41-56 href=#__codelineno-41-56></a><span class=gp>... </span>        <span class=n>pbar2</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>expectancy</span><span class=p>))</span>
</span></code></pre></div> <ol> <li>Number of best parameter combinations to search for.</li> <li>Expectancy threshold after which a parameter combination is considered the best.</li> <li>Number of parameter combinations to process during each iteration of the while-loop.</li> <li>Load cached results from previous execution(s).</li> <li>Create two progress bars: one shows how many best parameter combinations have been found, and the other shows the total number of parameter combinations processed.</li> <li>Run the loop until the requested number of best parameter combinations have been found.</li> <li>Generate a random parameter combination <code>CHUNK_LEN</code> times.</li> <li>Backtest the generated parameter combinations using chunking.</li> <li>If any parameter combinations that meet the condition are found, concatenate them with others, cache to disk, and update the first progress bar.</li> </ol> <p> <div class="progress progress-100plus candystripe candystripe-animate"> <div class=progress-bar style=width:100.00%> <p class=progress-label>Found 100/100</p> </div> </div> </p> <p>You can now run the cell above, stop execution at any time, and resume later <img alt=📅 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f4c5.svg title=:date:></p> <p>By grouping similar parameter combinations into the same bucket, you can also aggregate them to derive a single optimal parameter combination:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-42-1><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>get_param_median</span><span class=p>(</span><span class=n>param</span><span class=p>):</span>  <span class=c1># (1)!</span>
</span><span id=__span-42-2><a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>found</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>get_level_values</span><span class=p>(</span><span class=n>param</span><span class=p>)</span><span class=o>.</span><span class=n>to_series</span><span class=p>()</span><span class=o>.</span><span class=n>median</span><span class=p>()</span>
</span><span id=__span-42-3><a id=__codelineno-42-3 name=__codelineno-42-3 href=#__codelineno-42-3></a>
</span><span id=__span-42-4><a id=__codelineno-42-4 name=__codelineno-42-4 href=#__codelineno-42-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pt_pipeline_nb</span><span class=p>(</span>
</span><span id=__span-42-5><a id=__codelineno-42-5 name=__codelineno-42-5 href=#__codelineno-42-5></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>open</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-42-6><a id=__codelineno-42-6 name=__codelineno-42-6 href=#__codelineno-42-6></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>high</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-42-7><a id=__codelineno-42-7 name=__codelineno-42-7 href=#__codelineno-42-7></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-42-8><a id=__codelineno-42-8 name=__codelineno-42-8 href=#__codelineno-42-8></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>close</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-42-9><a id=__codelineno-42-9 name=__codelineno-42-9 href=#__codelineno-42-9></a><span class=gp>... </span>    <span class=n>window</span><span class=o>=</span><span class=nb>int</span><span class=p>(</span><span class=n>get_param_median</span><span class=p>(</span><span class=s2>&quot;window&quot;</span><span class=p>)),</span>
</span><span id=__span-42-10><a id=__codelineno-42-10 name=__codelineno-42-10 href=#__codelineno-42-10></a><span class=gp>... </span>    <span class=n>upper</span><span class=o>=</span><span class=n>get_param_median</span><span class=p>(</span><span class=s2>&quot;upper&quot;</span><span class=p>),</span>
</span><span id=__span-42-11><a id=__codelineno-42-11 name=__codelineno-42-11 href=#__codelineno-42-11></a><span class=gp>... </span>    <span class=n>lower</span><span class=o>=</span><span class=n>get_param_median</span><span class=p>(</span><span class=s2>&quot;lower&quot;</span><span class=p>),</span>
</span><span id=__span-42-12><a id=__codelineno-42-12 name=__codelineno-42-12 href=#__codelineno-42-12></a><span class=gp>... </span>    <span class=n>sl_stop</span><span class=o>=</span><span class=n>get_param_median</span><span class=p>(</span><span class=s2>&quot;sl_stop&quot;</span><span class=p>),</span>
</span><span id=__span-42-13><a id=__codelineno-42-13 name=__codelineno-42-13 href=#__codelineno-42-13></a><span class=gp>... </span>    <span class=n>tsl_stop</span><span class=o>=</span><span class=n>get_param_median</span><span class=p>(</span><span class=s2>&quot;tsl_stop&quot;</span><span class=p>),</span>
</span><span id=__span-42-14><a id=__codelineno-42-14 name=__codelineno-42-14 href=#__codelineno-42-14></a><span class=gp>... </span>    <span class=n>tp_stop</span><span class=o>=</span><span class=n>get_param_median</span><span class=p>(</span><span class=s2>&quot;tp_stop&quot;</span><span class=p>)</span>
</span><span id=__span-42-15><a id=__codelineno-42-15 name=__codelineno-42-15 href=#__codelineno-42-15></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-42-16><a id=__codelineno-42-16 name=__codelineno-42-16 href=#__codelineno-42-16></a><span class=go>(0.24251123364060986, 1.7316489316495804)</span>
</span></code></pre></div> <ol> <li>Get the median of the parameter values.</li> </ol> <p>You can see that the median parameter combination also meets our expectancy condition.</p> <p>However, sometimes you do not need to test so many parameter combinations. You can simply use an established parameter optimization framework like <a href=https://optuna.org/ >Optuna</a>. This approach offers several advantages: you can use the original <code>pt_pipeline_nb</code> function without decorators, you do not need to handle large parameter grids, and you can apply various statistical strategies to improve search effectiveness and reduce the number of parameter combinations you need to test.</p> <div class="admonition info"> <p class=admonition-title>Info</p> <p>Make sure to install Optuna before running the following cell.</p> </div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-43-1><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a><span class=gp>&gt;&gt;&gt; </span><span class=kn>import</span><span class=w> </span><span class=nn>optuna</span>
</span><span id=__span-43-2><a id=__codelineno-43-2 name=__codelineno-43-2 href=#__codelineno-43-2></a>
</span><span id=__span-43-3><a id=__codelineno-43-3 name=__codelineno-43-3 href=#__codelineno-43-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>optuna</span><span class=o>.</span><span class=n>logging</span><span class=o>.</span><span class=n>disable_default_handler</span><span class=p>()</span>
</span><span id=__span-43-4><a id=__codelineno-43-4 name=__codelineno-43-4 href=#__codelineno-43-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>optuna</span><span class=o>.</span><span class=n>logging</span><span class=o>.</span><span class=n>set_verbosity</span><span class=p>(</span><span class=n>optuna</span><span class=o>.</span><span class=n>logging</span><span class=o>.</span><span class=n>WARNING</span><span class=p>)</span>
</span><span id=__span-43-5><a id=__codelineno-43-5 name=__codelineno-43-5 href=#__codelineno-43-5></a>
</span><span id=__span-43-6><a id=__codelineno-43-6 name=__codelineno-43-6 href=#__codelineno-43-6></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>objective</span><span class=p>(</span><span class=n>trial</span><span class=p>):</span>
</span><span id=__span-43-7><a id=__codelineno-43-7 name=__codelineno-43-7 href=#__codelineno-43-7></a><span class=gp>... </span>    <span class=n>window</span> <span class=o>=</span> <span class=n>trial</span><span class=o>.</span><span class=n>suggest_categorical</span><span class=p>(</span><span class=s2>&quot;window&quot;</span><span class=p>,</span> <span class=n>WINDOW_SPACE</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-43-8><a id=__codelineno-43-8 name=__codelineno-43-8 href=#__codelineno-43-8></a><span class=gp>... </span>    <span class=n>upper</span> <span class=o>=</span> <span class=n>trial</span><span class=o>.</span><span class=n>suggest_categorical</span><span class=p>(</span><span class=s2>&quot;upper&quot;</span><span class=p>,</span> <span class=n>UPPER_SPACE</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-43-9><a id=__codelineno-43-9 name=__codelineno-43-9 href=#__codelineno-43-9></a><span class=gp>... </span>    <span class=n>lower</span> <span class=o>=</span> <span class=n>trial</span><span class=o>.</span><span class=n>suggest_categorical</span><span class=p>(</span><span class=s2>&quot;lower&quot;</span><span class=p>,</span> <span class=n>LOWER_SPACE</span><span class=p>)</span>
</span><span id=__span-43-10><a id=__codelineno-43-10 name=__codelineno-43-10 href=#__codelineno-43-10></a><span class=gp>... </span>    <span class=n>sl_stop</span> <span class=o>=</span> <span class=n>trial</span><span class=o>.</span><span class=n>suggest_categorical</span><span class=p>(</span><span class=s2>&quot;sl_stop&quot;</span><span class=p>,</span> <span class=n>STOP_SPACE</span><span class=p>)</span>
</span><span id=__span-43-11><a id=__codelineno-43-11 name=__codelineno-43-11 href=#__codelineno-43-11></a><span class=gp>... </span>    <span class=n>tsl_stop</span> <span class=o>=</span> <span class=n>trial</span><span class=o>.</span><span class=n>suggest_categorical</span><span class=p>(</span><span class=s2>&quot;tsl_stop&quot;</span><span class=p>,</span> <span class=n>STOP_SPACE</span><span class=p>)</span>
</span><span id=__span-43-12><a id=__codelineno-43-12 name=__codelineno-43-12 href=#__codelineno-43-12></a><span class=gp>... </span>    <span class=n>tp_stop</span> <span class=o>=</span> <span class=n>trial</span><span class=o>.</span><span class=n>suggest_categorical</span><span class=p>(</span><span class=s2>&quot;tp_stop&quot;</span><span class=p>,</span> <span class=n>STOP_SPACE</span><span class=p>)</span>
</span><span id=__span-43-13><a id=__codelineno-43-13 name=__codelineno-43-13 href=#__codelineno-43-13></a><span class=gp>... </span>    <span class=n>total_return</span><span class=p>,</span> <span class=n>expectancy</span> <span class=o>=</span> <span class=n>pt_pipeline_nb</span><span class=p>(</span>
</span><span id=__span-43-14><a id=__codelineno-43-14 name=__codelineno-43-14 href=#__codelineno-43-14></a><span class=gp>... </span>        <span class=n>data</span><span class=o>.</span><span class=n>open</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-43-15><a id=__codelineno-43-15 name=__codelineno-43-15 href=#__codelineno-43-15></a><span class=gp>... </span>        <span class=n>data</span><span class=o>.</span><span class=n>high</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-43-16><a id=__codelineno-43-16 name=__codelineno-43-16 href=#__codelineno-43-16></a><span class=gp>... </span>        <span class=n>data</span><span class=o>.</span><span class=n>low</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-43-17><a id=__codelineno-43-17 name=__codelineno-43-17 href=#__codelineno-43-17></a><span class=gp>... </span>        <span class=n>data</span><span class=o>.</span><span class=n>close</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-43-18><a id=__codelineno-43-18 name=__codelineno-43-18 href=#__codelineno-43-18></a><span class=gp>... </span>        <span class=n>window</span><span class=o>=</span><span class=n>window</span><span class=p>,</span>
</span><span id=__span-43-19><a id=__codelineno-43-19 name=__codelineno-43-19 href=#__codelineno-43-19></a><span class=gp>... </span>        <span class=n>upper</span><span class=o>=</span><span class=n>upper</span><span class=p>,</span>
</span><span id=__span-43-20><a id=__codelineno-43-20 name=__codelineno-43-20 href=#__codelineno-43-20></a><span class=gp>... </span>        <span class=n>lower</span><span class=o>=</span><span class=n>lower</span><span class=p>,</span>
</span><span id=__span-43-21><a id=__codelineno-43-21 name=__codelineno-43-21 href=#__codelineno-43-21></a><span class=gp>... </span>        <span class=n>sl_stop</span><span class=o>=</span><span class=n>sl_stop</span><span class=p>,</span>
</span><span id=__span-43-22><a id=__codelineno-43-22 name=__codelineno-43-22 href=#__codelineno-43-22></a><span class=gp>... </span>        <span class=n>tsl_stop</span><span class=o>=</span><span class=n>tsl_stop</span><span class=p>,</span>
</span><span id=__span-43-23><a id=__codelineno-43-23 name=__codelineno-43-23 href=#__codelineno-43-23></a><span class=gp>... </span>        <span class=n>tp_stop</span><span class=o>=</span><span class=n>tp_stop</span>
</span><span id=__span-43-24><a id=__codelineno-43-24 name=__codelineno-43-24 href=#__codelineno-43-24></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-43-25><a id=__codelineno-43-25 name=__codelineno-43-25 href=#__codelineno-43-25></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>total_return</span><span class=p>):</span>
</span><span id=__span-43-26><a id=__codelineno-43-26 name=__codelineno-43-26 href=#__codelineno-43-26></a><span class=gp>... </span>        <span class=k>raise</span> <span class=n>optuna</span><span class=o>.</span><span class=n>TrialPruned</span><span class=p>()</span>  <span class=c1># (3)!</span>
</span><span id=__span-43-27><a id=__codelineno-43-27 name=__codelineno-43-27 href=#__codelineno-43-27></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>expectancy</span><span class=p>):</span>
</span><span id=__span-43-28><a id=__codelineno-43-28 name=__codelineno-43-28 href=#__codelineno-43-28></a><span class=gp>... </span>        <span class=k>raise</span> <span class=n>optuna</span><span class=o>.</span><span class=n>TrialPruned</span><span class=p>()</span>
</span><span id=__span-43-29><a id=__codelineno-43-29 name=__codelineno-43-29 href=#__codelineno-43-29></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>total_return</span><span class=p>,</span> <span class=n>expectancy</span>
</span><span id=__span-43-30><a id=__codelineno-43-30 name=__codelineno-43-30 href=#__codelineno-43-30></a>
</span><span id=__span-43-31><a id=__codelineno-43-31 name=__codelineno-43-31 href=#__codelineno-43-31></a><span class=gp>&gt;&gt;&gt; </span><span class=n>study</span> <span class=o>=</span> <span class=n>optuna</span><span class=o>.</span><span class=n>create_study</span><span class=p>(</span><span class=n>directions</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;maximize&quot;</span><span class=p>,</span> <span class=s2>&quot;maximize&quot;</span><span class=p>])</span>  <span class=c1># (4)!</span>
</span><span id=__span-43-32><a id=__codelineno-43-32 name=__codelineno-43-32 href=#__codelineno-43-32></a><span class=gp>&gt;&gt;&gt; </span><span class=n>study</span><span class=o>.</span><span class=n>optimize</span><span class=p>(</span><span class=n>objective</span><span class=p>,</span> <span class=n>n_trials</span><span class=o>=</span><span class=mi>1000</span><span class=p>)</span>  <span class=c1># (5)!</span>
</span><span id=__span-43-33><a id=__codelineno-43-33 name=__codelineno-43-33 href=#__codelineno-43-33></a>
</span><span id=__span-43-34><a id=__codelineno-43-34 name=__codelineno-43-34 href=#__codelineno-43-34></a><span class=gp>&gt;&gt;&gt; </span><span class=n>trials_df</span> <span class=o>=</span> <span class=n>study</span><span class=o>.</span><span class=n>trials_dataframe</span><span class=p>(</span><span class=n>attrs</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;params&quot;</span><span class=p>,</span> <span class=s2>&quot;values&quot;</span><span class=p>])</span>
</span><span id=__span-43-35><a id=__codelineno-43-35 name=__codelineno-43-35 href=#__codelineno-43-35></a><span class=gp>&gt;&gt;&gt; </span><span class=n>trials_df</span><span class=o>.</span><span class=n>set_index</span><span class=p>([</span>
</span><span id=__span-43-36><a id=__codelineno-43-36 name=__codelineno-43-36 href=#__codelineno-43-36></a><span class=gp>... </span>    <span class=s2>&quot;params_window&quot;</span><span class=p>,</span> 
</span><span id=__span-43-37><a id=__codelineno-43-37 name=__codelineno-43-37 href=#__codelineno-43-37></a><span class=gp>... </span>    <span class=s2>&quot;params_upper&quot;</span><span class=p>,</span> 
</span><span id=__span-43-38><a id=__codelineno-43-38 name=__codelineno-43-38 href=#__codelineno-43-38></a><span class=gp>... </span>    <span class=s2>&quot;params_lower&quot;</span><span class=p>,</span>
</span><span id=__span-43-39><a id=__codelineno-43-39 name=__codelineno-43-39 href=#__codelineno-43-39></a><span class=gp>... </span>    <span class=s2>&quot;params_sl_stop&quot;</span><span class=p>,</span>
</span><span id=__span-43-40><a id=__codelineno-43-40 name=__codelineno-43-40 href=#__codelineno-43-40></a><span class=gp>... </span>    <span class=s2>&quot;params_tsl_stop&quot;</span><span class=p>,</span>
</span><span id=__span-43-41><a id=__codelineno-43-41 name=__codelineno-43-41 href=#__codelineno-43-41></a><span class=gp>... </span>    <span class=s2>&quot;params_tp_stop&quot;</span>
</span><span id=__span-43-42><a id=__codelineno-43-42 name=__codelineno-43-42 href=#__codelineno-43-42></a><span class=gp>... </span><span class=p>],</span> <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-43-43><a id=__codelineno-43-43 name=__codelineno-43-43 href=#__codelineno-43-43></a><span class=gp>&gt;&gt;&gt; </span><span class=n>trials_df</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>rename</span><span class=p>([</span>
</span><span id=__span-43-44><a id=__codelineno-43-44 name=__codelineno-43-44 href=#__codelineno-43-44></a><span class=gp>... </span>    <span class=s2>&quot;window&quot;</span><span class=p>,</span> 
</span><span id=__span-43-45><a id=__codelineno-43-45 name=__codelineno-43-45 href=#__codelineno-43-45></a><span class=gp>... </span>    <span class=s2>&quot;upper&quot;</span><span class=p>,</span> 
</span><span id=__span-43-46><a id=__codelineno-43-46 name=__codelineno-43-46 href=#__codelineno-43-46></a><span class=gp>... </span>    <span class=s2>&quot;lower&quot;</span><span class=p>,</span>
</span><span id=__span-43-47><a id=__codelineno-43-47 name=__codelineno-43-47 href=#__codelineno-43-47></a><span class=gp>... </span>    <span class=s2>&quot;sl_stop&quot;</span><span class=p>,</span>
</span><span id=__span-43-48><a id=__codelineno-43-48 name=__codelineno-43-48 href=#__codelineno-43-48></a><span class=gp>... </span>    <span class=s2>&quot;tsl_stop&quot;</span><span class=p>,</span>
</span><span id=__span-43-49><a id=__codelineno-43-49 name=__codelineno-43-49 href=#__codelineno-43-49></a><span class=gp>... </span>    <span class=s2>&quot;tp_stop&quot;</span>
</span><span id=__span-43-50><a id=__codelineno-43-50 name=__codelineno-43-50 href=#__codelineno-43-50></a><span class=gp>... </span><span class=p>],</span> <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-43-51><a id=__codelineno-43-51 name=__codelineno-43-51 href=#__codelineno-43-51></a><span class=gp>&gt;&gt;&gt; </span><span class=n>trials_df</span><span class=o>.</span><span class=n>columns</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;total_return&quot;</span><span class=p>,</span> <span class=s2>&quot;expectancy&quot;</span><span class=p>]</span>
</span><span id=__span-43-52><a id=__codelineno-43-52 name=__codelineno-43-52 href=#__codelineno-43-52></a><span class=gp>&gt;&gt;&gt; </span><span class=n>trials_df</span> <span class=o>=</span> <span class=n>trials_df</span><span class=p>[</span><span class=o>~</span><span class=n>trials_df</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>duplicated</span><span class=p>(</span><span class=n>keep</span><span class=o>=</span><span class=s2>&quot;first&quot;</span><span class=p>)]</span>
</span><span id=__span-43-53><a id=__codelineno-43-53 name=__codelineno-43-53 href=#__codelineno-43-53></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=n>trials_df</span><span class=o>.</span><span class=n>sort_values</span><span class=p>(</span><span class=n>by</span><span class=o>=</span><span class=s2>&quot;total_return&quot;</span><span class=p>,</span> <span class=n>ascending</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>
</span><span id=__span-43-54><a id=__codelineno-43-54 name=__codelineno-43-54 href=#__codelineno-43-54></a><span class=go>                                                    total_return  expectancy</span>
</span><span id=__span-43-55><a id=__codelineno-43-55 name=__codelineno-43-55 href=#__codelineno-43-55></a><span class=go>window upper    lower     sl_stop tsl_stop tp_stop                          </span>
</span><span id=__span-43-56><a id=__codelineno-43-56 name=__codelineno-43-56 href=#__codelineno-43-56></a><span class=go>44     1.746485 -3.072346 9.0     67.0     55.0         0.558865    0.184924</span>
</span><span id=__span-43-57><a id=__codelineno-43-57 name=__codelineno-43-57 href=#__codelineno-43-57></a><span class=go>42     1.871392 -3.286737 53.0    98.0     55.0         0.500062    0.330489</span>
</span><span id=__span-43-58><a id=__codelineno-43-58 name=__codelineno-43-58 href=#__codelineno-43-58></a><span class=go>                                           77.0         0.496029    0.334432</span>
</span><span id=__span-43-59><a id=__codelineno-43-59 name=__codelineno-43-59 href=#__codelineno-43-59></a><span class=go>5      1.746485 -1.759648 76.0    94.0     45.0         0.492721    0.043832</span>
</span><span id=__span-43-60><a id=__codelineno-43-60 name=__codelineno-43-60 href=#__codelineno-43-60></a><span class=go>43     1.807618 -3.192280 87.0    36.0     60.0         0.475732    0.229682</span>
</span><span id=__span-43-61><a id=__codelineno-43-61 name=__codelineno-43-61 href=#__codelineno-43-61></a><span class=go>...                                                          ...         ...</span>
</span><span id=__span-43-62><a id=__codelineno-43-62 name=__codelineno-43-62 href=#__codelineno-43-62></a><span class=go>7      2.639845 -3.072346 80.0    95.0     55.0              NaN         NaN</span>
</span><span id=__span-43-63><a id=__codelineno-43-63 name=__codelineno-43-63 href=#__codelineno-43-63></a><span class=go>5      3.117886 -3.072346 78.0    90.0     47.0              NaN         NaN</span>
</span><span id=__span-43-64><a id=__codelineno-43-64 name=__codelineno-43-64 href=#__codelineno-43-64></a><span class=go>       2.769169 -3.072346 78.0    90.0     55.0              NaN         NaN</span>
</span><span id=__span-43-65><a id=__codelineno-43-65 name=__codelineno-43-65 href=#__codelineno-43-65></a><span class=go>7      3.098951 -3.072346 78.0    95.0     55.0              NaN         NaN</span>
</span><span id=__span-43-66><a id=__codelineno-43-66 name=__codelineno-43-66 href=#__codelineno-43-66></a><span class=go>       2.607536 -3.072346 78.0    95.0     77.0              NaN         NaN</span>
</span><span id=__span-43-67><a id=__codelineno-43-67 name=__codelineno-43-67 href=#__codelineno-43-67></a>
</span><span id=__span-43-68><a id=__codelineno-43-68 name=__codelineno-43-68 href=#__codelineno-43-68></a><span class=go>[892 rows x 2 columns]</span>
</span></code></pre></div> <ol> <li>You can also use <code>suggest_int</code> here (pass two bounds instead of a list).</li> <li>You can also use <code>suggest_float</code> here (pass two bounds instead of a list).</li> <li>Prune the trial because Optuna does not tolerate NaNs.</li> <li>Maximize both metrics.</li> <li>Run 1,000 non-pruned trials.</li> </ol> <p>The only downside of this approach is that you are limited by the chosen results and cannot explore the entire parameter landscape, which is something VBT is fully designed for.</p> <h3 id=level-architect>Level: Architect <img alt=🛸 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f6f8.svg title=:flying_saucer:><a class=headerlink href=#level-architect title="Permanent link">&para;</a></h3> <p>Suppose you want full control over execution, such as allowing at most one rebalancing operation within N days. Additionally, you want to avoid pre-calculating arrays and do everything in an event-driven manner. For simplicity, let's switch our signaling algorithm from cointegration with OLS to a basic distance measure: log prices.</p> <p>We will implement the strategy as a custom signal function for <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a>. This is the most challenging approach because the signal function is called for each column, while our decisions need to be made per segment (i.e., once for both columns). A good strategy is to perform calculations for the first column processed at each bar, store results in some temporary arrays, and then access those arrays from each column to return the signals. An ideal place to store these arrays is the built-in named tuple <code>in_outputs</code>, accessible both during simulation and analysis.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-44-1><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>InOutputs</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s2>&quot;InOutputs&quot;</span><span class=p>,</span> <span class=p>[</span><span class=s2>&quot;spread&quot;</span><span class=p>,</span> <span class=s2>&quot;zscore&quot;</span><span class=p>])</span>  <span class=c1># (1)!</span>
</span><span id=__span-44-2><a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a>
</span><span id=__span-44-3><a id=__codelineno-44-3 name=__codelineno-44-3 href=#__codelineno-44-3></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span><span class=p>(</span><span class=n>nogil</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>boundscheck</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-44-4><a id=__codelineno-44-4 name=__codelineno-44-4 href=#__codelineno-44-4></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>can_execute_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>wait_days</span><span class=p>):</span>  <span class=c1># (3)!</span>
</span><span id=__span-44-5><a id=__codelineno-44-5 name=__codelineno-44-5 href=#__codelineno-44-5></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>order_counts</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>  <span class=c1># (4)!</span>
</span><span id=__span-44-6><a id=__codelineno-44-6 name=__codelineno-44-6 href=#__codelineno-44-6></a><span class=gp>... </span>        <span class=k>return</span> <span class=kc>True</span>
</span><span id=__span-44-7><a id=__codelineno-44-7 name=__codelineno-44-7 href=#__codelineno-44-7></a><span class=gp>... </span>    <span class=n>last_order</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>order_records</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>order_counts</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>]</span>  <span class=c1># (5)!</span>
</span><span id=__span-44-8><a id=__codelineno-44-8 name=__codelineno-44-8 href=#__codelineno-44-8></a><span class=gp>... </span>    <span class=n>ns_delta</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>c</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>last_order</span><span class=o>.</span><span class=n>idx</span><span class=p>]</span>  <span class=c1># (6)!</span>
</span><span id=__span-44-9><a id=__codelineno-44-9 name=__codelineno-44-9 href=#__codelineno-44-9></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>ns_delta</span> <span class=o>&gt;=</span> <span class=n>wait_days</span> <span class=o>*</span> <span class=n>vbt</span><span class=o>.</span><span class=n>dt_nb</span><span class=o>.</span><span class=n>d_ns</span><span class=p>:</span>  <span class=c1># (7)!</span>
</span><span id=__span-44-10><a id=__codelineno-44-10 name=__codelineno-44-10 href=#__codelineno-44-10></a><span class=gp>... </span>        <span class=k>return</span> <span class=kc>True</span>
</span><span id=__span-44-11><a id=__codelineno-44-11 name=__codelineno-44-11 href=#__codelineno-44-11></a><span class=gp>... </span>    <span class=k>return</span> <span class=kc>False</span>
</span><span id=__span-44-12><a id=__codelineno-44-12 name=__codelineno-44-12 href=#__codelineno-44-12></a>
</span><span id=__span-44-13><a id=__codelineno-44-13 name=__codelineno-44-13 href=#__codelineno-44-13></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span><span class=p>(</span><span class=n>nogil</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>boundscheck</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-44-14><a id=__codelineno-44-14 name=__codelineno-44-14 href=#__codelineno-44-14></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>create_signals_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>upper</span><span class=p>,</span> <span class=n>lower</span><span class=p>,</span> <span class=n>wait_days</span><span class=p>):</span>  <span class=c1># (8)!</span>
</span><span id=__span-44-15><a id=__codelineno-44-15 name=__codelineno-44-15 href=#__codelineno-44-15></a><span class=gp>... </span>    <span class=n>_upper</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>upper</span><span class=p>)</span>  <span class=c1># (9)!</span>
</span><span id=__span-44-16><a id=__codelineno-44-16 name=__codelineno-44-16 href=#__codelineno-44-16></a><span class=gp>... </span>    <span class=n>_lower</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>lower</span><span class=p>)</span>
</span><span id=__span-44-17><a id=__codelineno-44-17 name=__codelineno-44-17 href=#__codelineno-44-17></a><span class=gp>... </span>    <span class=n>_wait_days</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>wait_days</span><span class=p>)</span>
</span><span id=__span-44-18><a id=__codelineno-44-18 name=__codelineno-44-18 href=#__codelineno-44-18></a><span class=gp>...</span>
</span><span id=__span-44-19><a id=__codelineno-44-19 name=__codelineno-44-19 href=#__codelineno-44-19></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>  <span class=c1># (10)!</span>
</span><span id=__span-44-20><a id=__codelineno-44-20 name=__codelineno-44-20 href=#__codelineno-44-20></a><span class=gp>... </span>        <span class=n>prev_zscore</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>zscore</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>]</span>
</span><span id=__span-44-21><a id=__codelineno-44-21 name=__codelineno-44-21 href=#__codelineno-44-21></a><span class=gp>... </span>        <span class=n>zscore</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>zscore</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>]</span>
</span><span id=__span-44-22><a id=__codelineno-44-22 name=__codelineno-44-22 href=#__codelineno-44-22></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>prev_zscore</span> <span class=o>&lt;</span> <span class=n>_upper</span> <span class=ow>and</span> <span class=n>zscore</span> <span class=o>&gt;</span> <span class=n>_upper</span><span class=p>:</span>  <span class=c1># (11)!</span>
</span><span id=__span-44-23><a id=__codelineno-44-23 name=__codelineno-44-23 href=#__codelineno-44-23></a><span class=gp>... </span>            <span class=k>if</span> <span class=n>can_execute_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>_wait_days</span><span class=p>):</span>
</span><span id=__span-44-24><a id=__codelineno-44-24 name=__codelineno-44-24 href=#__codelineno-44-24></a><span class=gp>... </span>                <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-44-25><a id=__codelineno-44-25 name=__codelineno-44-25 href=#__codelineno-44-25></a><span class=gp>... </span>                    <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span>  <span class=c1># (12)!</span>
</span><span id=__span-44-26><a id=__codelineno-44-26 name=__codelineno-44-26 href=#__codelineno-44-26></a><span class=gp>... </span>                <span class=k>return</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>  <span class=c1># (13)!</span>
</span><span id=__span-44-27><a id=__codelineno-44-27 name=__codelineno-44-27 href=#__codelineno-44-27></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>prev_zscore</span> <span class=o>&gt;</span> <span class=n>_lower</span> <span class=ow>and</span> <span class=n>zscore</span> <span class=o>&lt;</span> <span class=n>_lower</span><span class=p>:</span>
</span><span id=__span-44-28><a id=__codelineno-44-28 name=__codelineno-44-28 href=#__codelineno-44-28></a><span class=gp>... </span>            <span class=k>if</span> <span class=n>can_execute_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>_wait_days</span><span class=p>):</span>
</span><span id=__span-44-29><a id=__codelineno-44-29 name=__codelineno-44-29 href=#__codelineno-44-29></a><span class=gp>... </span>                <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-44-30><a id=__codelineno-44-30 name=__codelineno-44-30 href=#__codelineno-44-30></a><span class=gp>... </span>                    <span class=k>return</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-44-31><a id=__codelineno-44-31 name=__codelineno-44-31 href=#__codelineno-44-31></a><span class=gp>... </span>                <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span>
</span><span id=__span-44-32><a id=__codelineno-44-32 name=__codelineno-44-32 href=#__codelineno-44-32></a><span class=gp>... </span>    <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span>  <span class=c1># (14)!</span>
</span><span id=__span-44-33><a id=__codelineno-44-33 name=__codelineno-44-33 href=#__codelineno-44-33></a>
</span><span id=__span-44-34><a id=__codelineno-44-34 name=__codelineno-44-34 href=#__codelineno-44-34></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span><span class=p>(</span><span class=n>nogil</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>boundscheck</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-44-35><a id=__codelineno-44-35 name=__codelineno-44-35 href=#__codelineno-44-35></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>signal_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>window</span><span class=p>,</span> <span class=n>upper</span><span class=p>,</span> <span class=n>lower</span><span class=p>,</span> <span class=n>wait_days</span><span class=p>):</span>  <span class=c1># (15)!</span>
</span><span id=__span-44-36><a id=__codelineno-44-36 name=__codelineno-44-36 href=#__codelineno-44-36></a><span class=gp>... </span>    <span class=n>_window</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>window</span><span class=p>)</span>
</span><span id=__span-44-37><a id=__codelineno-44-37 name=__codelineno-44-37 href=#__codelineno-44-37></a><span class=gp>... </span>        
</span><span id=__span-44-38><a id=__codelineno-44-38 name=__codelineno-44-38 href=#__codelineno-44-38></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>  <span class=c1># (16)!</span>
</span><span id=__span-44-39><a id=__codelineno-44-39 name=__codelineno-44-39 href=#__codelineno-44-39></a><span class=gp>... </span>        <span class=n>x</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>close</span><span class=p>,</span> <span class=n>col</span><span class=o>=</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>)</span>  <span class=c1># (17)!</span>
</span><span id=__span-44-40><a id=__codelineno-44-40 name=__codelineno-44-40 href=#__codelineno-44-40></a><span class=gp>... </span>        <span class=n>y</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>close</span><span class=p>,</span> <span class=n>col</span><span class=o>=</span><span class=n>c</span><span class=o>.</span><span class=n>col</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span><span id=__span-44-41><a id=__codelineno-44-41 name=__codelineno-44-41 href=#__codelineno-44-41></a><span class=gp>... </span>        <span class=n>c</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>spread</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>y</span><span class=p>)</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>  <span class=c1># (18)!</span>
</span><span id=__span-44-42><a id=__codelineno-44-42 name=__codelineno-44-42 href=#__codelineno-44-42></a><span class=gp>... </span>        
</span><span id=__span-44-43><a id=__codelineno-44-43 name=__codelineno-44-43 href=#__codelineno-44-43></a><span class=gp>... </span>        <span class=n>window_start</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>-</span> <span class=n>_window</span> <span class=o>+</span> <span class=mi>1</span>  <span class=c1># (19)!</span>
</span><span id=__span-44-44><a id=__codelineno-44-44 name=__codelineno-44-44 href=#__codelineno-44-44></a><span class=gp>... </span>        <span class=n>window_end</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span>  <span class=c1># (20)!</span>
</span><span id=__span-44-45><a id=__codelineno-44-45 name=__codelineno-44-45 href=#__codelineno-44-45></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>window_start</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>:</span>  <span class=c1># (21)!</span>
</span><span id=__span-44-46><a id=__codelineno-44-46 name=__codelineno-44-46 href=#__codelineno-44-46></a><span class=gp>... </span>            <span class=n>s</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>spread</span><span class=p>[</span><span class=n>window_start</span> <span class=p>:</span> <span class=n>window_end</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>]</span>
</span><span id=__span-44-47><a id=__codelineno-44-47 name=__codelineno-44-47 href=#__codelineno-44-47></a><span class=gp>... </span>            <span class=n>s_mean</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>nanmean</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
</span><span id=__span-44-48><a id=__codelineno-44-48 name=__codelineno-44-48 href=#__codelineno-44-48></a><span class=gp>... </span>            <span class=n>s_std</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>nanstd</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
</span><span id=__span-44-49><a id=__codelineno-44-49 name=__codelineno-44-49 href=#__codelineno-44-49></a><span class=gp>... </span>            <span class=n>c</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>zscore</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>s_mean</span><span class=p>)</span> <span class=o>/</span> <span class=n>s_std</span>
</span><span id=__span-44-50><a id=__codelineno-44-50 name=__codelineno-44-50 href=#__codelineno-44-50></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>create_signals_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>upper</span><span class=p>,</span> <span class=n>lower</span><span class=p>,</span> <span class=n>wait_days</span><span class=p>)</span>
</span></code></pre></div> <ol> <li>Defines a named tuple containing two arrays: spread and its z-score.</li> <li>It is always recommended to enable bound checking while developing a signal function to avoid out-of-bounds errors; however, be aware this may slightly reduce performance.</li> <li>Helper Numba function to check whether orders can be placed at the current bar.</li> <li>Checks if this is the asset's first order in the simulation.</li> <li>Retrieves the last order if this is not the asset's first order in the simulation.</li> <li>Gets the elapsed time in nanoseconds between the current bar and the bar of the last order.</li> <li>Checks if the elapsed time is at least <code>wait_days</code>. Since we compare nanoseconds, we must multiply <code>wait_days</code> by one day's nanoseconds to get the value in nanoseconds.</li> <li>Another helper Numba function to create signals from the available spread and z-score.</li> <li>Our parameters are flexible arrays rather than single values, so we need to select the element corresponding to the current row and column.</li> <li>Crossovers are based on the current and previous value, so ensure the previous value is available.</li> <li>Very basic crossover comparison.</li> <li>Short entry.</li> <li>Long entry.</li> <li>Do not forget this line; otherwise, the function will return None and cause an ugly error.</li> <li>The main signal function, acting as a callback and being called by the simulator. The first argument in each signal function is the context of type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.SignalContext>SignalContext</a>. Other arguments are user-defined, such as the parameters.</li> <li>If this is the first column in the bar, calculate the spread and its z-score, since both are group metrics and must be available to both columns.</li> <li>The close price is also a flexible array.</li> <li>Both spread and z-score are two-dimensional arrays with columns representing groups.</li> <li>The z-score is calculated using the mean and standard deviation of a data window.</li> <li>In integer indexing, the stop is exclusive, so add 1 to include the current bar.</li> <li>Ensure the window start is greater than or equal to zero; if it is negative, the last values of the array will be used instead!</li> </ol> <p>Now, create a pipeline that runs simulation using the signal function above:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-45-1><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>WAIT_DAYS</span> <span class=o>=</span> <span class=mi>30</span>
</span><span id=__span-45-2><a id=__codelineno-45-2 name=__codelineno-45-2 href=#__codelineno-45-2></a>
</span><span id=__span-45-3><a id=__codelineno-45-3 name=__codelineno-45-3 href=#__codelineno-45-3></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>iter_pt_portfolio</span><span class=p>(</span>
</span><span id=__span-45-4><a id=__codelineno-45-4 name=__codelineno-45-4 href=#__codelineno-45-4></a><span class=gp>... </span>    <span class=n>window</span><span class=o>=</span><span class=n>WINDOW</span><span class=p>,</span> 
</span><span id=__span-45-5><a id=__codelineno-45-5 name=__codelineno-45-5 href=#__codelineno-45-5></a><span class=gp>... </span>    <span class=n>upper</span><span class=o>=</span><span class=n>UPPER</span><span class=p>,</span> 
</span><span id=__span-45-6><a id=__codelineno-45-6 name=__codelineno-45-6 href=#__codelineno-45-6></a><span class=gp>... </span>    <span class=n>lower</span><span class=o>=</span><span class=n>LOWER</span><span class=p>,</span> 
</span><span id=__span-45-7><a id=__codelineno-45-7 name=__codelineno-45-7 href=#__codelineno-45-7></a><span class=gp>... </span>    <span class=n>wait_days</span><span class=o>=</span><span class=n>WAIT_DAYS</span><span class=p>,</span>
</span><span id=__span-45-8><a id=__codelineno-45-8 name=__codelineno-45-8 href=#__codelineno-45-8></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-45-9><a id=__codelineno-45-9 name=__codelineno-45-9 href=#__codelineno-45-9></a><span class=gp>... </span>    <span class=n>more_signal_args</span><span class=o>=</span><span class=p>(),</span>
</span><span id=__span-45-10><a id=__codelineno-45-10 name=__codelineno-45-10 href=#__codelineno-45-10></a><span class=gp>... </span>    <span class=o>**</span><span class=n>kwargs</span>
</span><span id=__span-45-11><a id=__codelineno-45-11 name=__codelineno-45-11 href=#__codelineno-45-11></a><span class=gp>... </span><span class=p>):</span>
</span><span id=__span-45-12><a id=__codelineno-45-12 name=__codelineno-45-12 href=#__codelineno-45-12></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_signals</span><span class=p>(</span>
</span><span id=__span-45-13><a id=__codelineno-45-13 name=__codelineno-45-13 href=#__codelineno-45-13></a><span class=gp>... </span>        <span class=n>data</span><span class=p>,</span>
</span><span id=__span-45-14><a id=__codelineno-45-14 name=__codelineno-45-14 href=#__codelineno-45-14></a><span class=gp>... </span>        <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>  <span class=c1># (2)!</span>
</span><span id=__span-45-15><a id=__codelineno-45-15 name=__codelineno-45-15 href=#__codelineno-45-15></a><span class=gp>... </span>            <span class=n>window</span><span class=o>=</span><span class=n>window</span><span class=p>,</span>
</span><span id=__span-45-16><a id=__codelineno-45-16 name=__codelineno-45-16 href=#__codelineno-45-16></a><span class=gp>... </span>            <span class=n>upper</span><span class=o>=</span><span class=n>upper</span><span class=p>,</span>
</span><span id=__span-45-17><a id=__codelineno-45-17 name=__codelineno-45-17 href=#__codelineno-45-17></a><span class=gp>... </span>            <span class=n>lower</span><span class=o>=</span><span class=n>lower</span><span class=p>,</span>
</span><span id=__span-45-18><a id=__codelineno-45-18 name=__codelineno-45-18 href=#__codelineno-45-18></a><span class=gp>... </span>            <span class=n>wait_days</span><span class=o>=</span><span class=n>wait_days</span>
</span><span id=__span-45-19><a id=__codelineno-45-19 name=__codelineno-45-19 href=#__codelineno-45-19></a><span class=gp>... </span>        <span class=p>),</span>
</span><span id=__span-45-20><a id=__codelineno-45-20 name=__codelineno-45-20 href=#__codelineno-45-20></a><span class=gp>... </span>        <span class=n>in_outputs</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;&quot;&quot;</span>
</span><span id=__span-45-21><a id=__codelineno-45-21 name=__codelineno-45-21 href=#__codelineno-45-21></a><span class=gp>... </span><span class=s2>            InOutputs(</span>
</span><span id=__span-45-22><a id=__codelineno-45-22 name=__codelineno-45-22 href=#__codelineno-45-22></a><span class=gp>... </span><span class=s2>                np.full((target_shape[0], target_shape[1] // 2), np.nan), </span>
</span><span id=__span-45-23><a id=__codelineno-45-23 name=__codelineno-45-23 href=#__codelineno-45-23></a><span class=gp>... </span><span class=s2>                np.full((target_shape[0], target_shape[1] // 2), np.nan)</span>
</span><span id=__span-45-24><a id=__codelineno-45-24 name=__codelineno-45-24 href=#__codelineno-45-24></a><span class=gp>... </span><span class=s2>            )</span>
</span><span id=__span-45-25><a id=__codelineno-45-25 name=__codelineno-45-25 href=#__codelineno-45-25></a><span class=gp>... </span><span class=s2>        &quot;&quot;&quot;</span><span class=p>,</span> <span class=n>context</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>InOutputs</span><span class=o>=</span><span class=n>InOutputs</span><span class=p>)),</span>  <span class=c1># (3)!</span>
</span><span id=__span-45-26><a id=__codelineno-45-26 name=__codelineno-45-26 href=#__codelineno-45-26></a><span class=gp>... </span>        <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>signal_func_nb</span><span class=p>,</span>  <span class=c1># (4)!</span>
</span><span id=__span-45-27><a id=__codelineno-45-27 name=__codelineno-45-27 href=#__codelineno-45-27></a><span class=gp>... </span>        <span class=n>signal_args</span><span class=o>=</span><span class=p>(</span>  <span class=c1># (5)!</span>
</span><span id=__span-45-28><a id=__codelineno-45-28 name=__codelineno-45-28 href=#__codelineno-45-28></a><span class=gp>... </span>            <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;window&quot;</span><span class=p>),</span>  <span class=c1># (6)!</span>
</span><span id=__span-45-29><a id=__codelineno-45-29 name=__codelineno-45-29 href=#__codelineno-45-29></a><span class=gp>... </span>            <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;upper&quot;</span><span class=p>),</span>
</span><span id=__span-45-30><a id=__codelineno-45-30 name=__codelineno-45-30 href=#__codelineno-45-30></a><span class=gp>... </span>            <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;lower&quot;</span><span class=p>),</span>
</span><span id=__span-45-31><a id=__codelineno-45-31 name=__codelineno-45-31 href=#__codelineno-45-31></a><span class=gp>... </span>            <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;wait_days&quot;</span><span class=p>),</span>
</span><span id=__span-45-32><a id=__codelineno-45-32 name=__codelineno-45-32 href=#__codelineno-45-32></a><span class=gp>... </span>            <span class=o>*</span><span class=n>more_signal_args</span>
</span><span id=__span-45-33><a id=__codelineno-45-33 name=__codelineno-45-33 href=#__codelineno-45-33></a><span class=gp>... </span>        <span class=p>),</span>
</span><span id=__span-45-34><a id=__codelineno-45-34 name=__codelineno-45-34 href=#__codelineno-45-34></a><span class=gp>... </span>        <span class=n>size</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>
</span><span id=__span-45-35><a id=__codelineno-45-35 name=__codelineno-45-35 href=#__codelineno-45-35></a><span class=gp>... </span>        <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;valuepercent100&quot;</span><span class=p>,</span>
</span><span id=__span-45-36><a id=__codelineno-45-36 name=__codelineno-45-36 href=#__codelineno-45-36></a><span class=gp>... </span>        <span class=n>group_by</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>ExceptLevel</span><span class=p>(</span><span class=s2>&quot;symbol&quot;</span><span class=p>),</span>
</span><span id=__span-45-37><a id=__codelineno-45-37 name=__codelineno-45-37 href=#__codelineno-45-37></a><span class=gp>... </span>        <span class=n>cash_sharing</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-45-38><a id=__codelineno-45-38 name=__codelineno-45-38 href=#__codelineno-45-38></a><span class=gp>... </span>        <span class=n>call_seq</span><span class=o>=</span><span class=s2>&quot;auto&quot;</span><span class=p>,</span>
</span><span id=__span-45-39><a id=__codelineno-45-39 name=__codelineno-45-39 href=#__codelineno-45-39></a><span class=gp>... </span>        <span class=n>delta_format</span><span class=o>=</span><span class=s2>&quot;percent100&quot;</span><span class=p>,</span>
</span><span id=__span-45-40><a id=__codelineno-45-40 name=__codelineno-45-40 href=#__codelineno-45-40></a><span class=gp>... </span>        <span class=n>stop_exit_price</span><span class=o>=</span><span class=s2>&quot;close&quot;</span><span class=p>,</span>
</span><span id=__span-45-41><a id=__codelineno-45-41 name=__codelineno-45-41 href=#__codelineno-45-41></a><span class=gp>... </span>        <span class=o>**</span><span class=n>kwargs</span>
</span><span id=__span-45-42><a id=__codelineno-45-42 name=__codelineno-45-42 href=#__codelineno-45-42></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-45-43><a id=__codelineno-45-43 name=__codelineno-45-43 href=#__codelineno-45-43></a>
</span><span id=__span-45-44><a id=__codelineno-45-44 name=__codelineno-45-44 href=#__codelineno-45-44></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>iter_pt_portfolio</span><span class=p>()</span>
</span></code></pre></div> <ol> <li>This lets you later replace the signal function with another one—stay tuned!</li> <li>By defining parameters here, you make them flexible; you can provide single values, or arrays per row, column, or even element.</li> <li>Since we do not know the target shape for the temporary arrays yet, create a Python expression that generates the named tuple with arrays and delay evaluation until the target shape is known.</li> <li>Instead of passing signal arrays, we now pass the signal function.</li> <li>These arguments appear after the context argument <code>c</code> in <code>signal_func_nb</code>.</li> <li>Use templates to substitute array names from <code>broadcast_named_args</code> with the actual arrays once they are prepared.</li> </ol> <p>Let's visually validate our implementation:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-46-1><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>make_subplots</span><span class=p>(</span>  <span class=c1># (1)!</span>
</span><span id=__span-46-2><a id=__codelineno-46-2 name=__codelineno-46-2 href=#__codelineno-46-2></a><span class=gp>... </span>    <span class=n>rows</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> 
</span><span id=__span-46-3><a id=__codelineno-46-3 name=__codelineno-46-3 href=#__codelineno-46-3></a><span class=gp>... </span>    <span class=n>cols</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> 
</span><span id=__span-46-4><a id=__codelineno-46-4 name=__codelineno-46-4 href=#__codelineno-46-4></a><span class=gp>... </span>    <span class=n>vertical_spacing</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span><span id=__span-46-5><a id=__codelineno-46-5 name=__codelineno-46-5 href=#__codelineno-46-5></a><span class=gp>... </span>    <span class=n>shared_xaxes</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-46-6><a id=__codelineno-46-6 name=__codelineno-46-6 href=#__codelineno-46-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-46-7><a id=__codelineno-46-7 name=__codelineno-46-7 href=#__codelineno-46-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>zscore</span> <span class=o>=</span> <span class=n>pf</span><span class=o>.</span><span class=n>get_in_output</span><span class=p>(</span><span class=s2>&quot;zscore&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=s2>&quot;Z-score&quot;</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-46-8><a id=__codelineno-46-8 name=__codelineno-46-8 href=#__codelineno-46-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>zscore</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span>  <span class=c1># (3)!</span>
</span><span id=__span-46-9><a id=__codelineno-46-9 name=__codelineno-46-9 href=#__codelineno-46-9></a><span class=gp>... </span>    <span class=n>add_trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>row</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>col</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>
</span><span id=__span-46-10><a id=__codelineno-46-10 name=__codelineno-46-10 href=#__codelineno-46-10></a><span class=gp>... </span>    <span class=n>fig</span><span class=o>=</span><span class=n>fig</span>
</span><span id=__span-46-11><a id=__codelineno-46-11 name=__codelineno-46-11 href=#__codelineno-46-11></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-46-12><a id=__codelineno-46-12 name=__codelineno-46-12 href=#__codelineno-46-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span><span class=o>.</span><span class=n>add_hline</span><span class=p>(</span><span class=n>row</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>y</span><span class=o>=</span><span class=n>UPPER</span><span class=p>,</span> <span class=n>line_color</span><span class=o>=</span><span class=s2>&quot;orangered&quot;</span><span class=p>,</span> <span class=n>line_dash</span><span class=o>=</span><span class=s2>&quot;dot&quot;</span><span class=p>)</span>
</span><span id=__span-46-13><a id=__codelineno-46-13 name=__codelineno-46-13 href=#__codelineno-46-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span><span class=o>.</span><span class=n>add_hline</span><span class=p>(</span><span class=n>row</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>y</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>line_color</span><span class=o>=</span><span class=s2>&quot;yellow&quot;</span><span class=p>,</span> <span class=n>line_dash</span><span class=o>=</span><span class=s2>&quot;dot&quot;</span><span class=p>)</span>
</span><span id=__span-46-14><a id=__codelineno-46-14 name=__codelineno-46-14 href=#__codelineno-46-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span><span class=o>.</span><span class=n>add_hline</span><span class=p>(</span><span class=n>row</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>y</span><span class=o>=</span><span class=n>LOWER</span><span class=p>,</span> <span class=n>line_color</span><span class=o>=</span><span class=s2>&quot;limegreen&quot;</span><span class=p>,</span> <span class=n>line_dash</span><span class=o>=</span><span class=s2>&quot;dot&quot;</span><span class=p>)</span>
</span><span id=__span-46-15><a id=__codelineno-46-15 name=__codelineno-46-15 href=#__codelineno-46-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>orders</span> <span class=o>=</span> <span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>regroup</span><span class=p>(</span><span class=n>group_by</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>iloc</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>]</span>  <span class=c1># (4)!</span>
</span><span id=__span-46-16><a id=__codelineno-46-16 name=__codelineno-46-16 href=#__codelineno-46-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exit_mask</span> <span class=o>=</span> <span class=n>orders</span><span class=o>.</span><span class=n>side_sell</span><span class=o>.</span><span class=n>get_pd_mask</span><span class=p>(</span><span class=n>idx_arr</span><span class=o>=</span><span class=s2>&quot;signal_idx&quot;</span><span class=p>)</span>  <span class=c1># (5)!</span>
</span><span id=__span-46-17><a id=__codelineno-46-17 name=__codelineno-46-17 href=#__codelineno-46-17></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entry_mask</span> <span class=o>=</span> <span class=n>orders</span><span class=o>.</span><span class=n>side_buy</span><span class=o>.</span><span class=n>get_pd_mask</span><span class=p>(</span><span class=n>idx_arr</span><span class=o>=</span><span class=s2>&quot;signal_idx&quot;</span><span class=p>)</span>  <span class=c1># (6)!</span>
</span><span id=__span-46-18><a id=__codelineno-46-18 name=__codelineno-46-18 href=#__codelineno-46-18></a><span class=gp>&gt;&gt;&gt; </span><span class=n>upper_crossed</span> <span class=o>=</span> <span class=n>zscore</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>crossed_above</span><span class=p>(</span><span class=n>UPPER</span><span class=p>)</span>
</span><span id=__span-46-19><a id=__codelineno-46-19 name=__codelineno-46-19 href=#__codelineno-46-19></a><span class=gp>&gt;&gt;&gt; </span><span class=n>lower_crossed</span> <span class=o>=</span> <span class=n>zscore</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>crossed_below</span><span class=p>(</span><span class=n>LOWER</span><span class=p>)</span>
</span><span id=__span-46-20><a id=__codelineno-46-20 name=__codelineno-46-20 href=#__codelineno-46-20></a><span class=gp>&gt;&gt;&gt; </span><span class=p>(</span><span class=n>upper_crossed</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>exit_mask</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>plot_as_exits</span><span class=p>(</span>  <span class=c1># (7)!</span>
</span><span id=__span-46-21><a id=__codelineno-46-21 name=__codelineno-46-21 href=#__codelineno-46-21></a><span class=gp>... </span>    <span class=n>pf</span><span class=o>.</span><span class=n>get_in_output</span><span class=p>(</span><span class=s2>&quot;zscore&quot;</span><span class=p>),</span>
</span><span id=__span-46-22><a id=__codelineno-46-22 name=__codelineno-46-22 href=#__codelineno-46-22></a><span class=gp>... </span>    <span class=n>trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-46-23><a id=__codelineno-46-23 name=__codelineno-46-23 href=#__codelineno-46-23></a><span class=gp>... </span>        <span class=n>name</span><span class=o>=</span><span class=s2>&quot;Exits (ignored)&quot;</span><span class=p>,</span> 
</span><span id=__span-46-24><a id=__codelineno-46-24 name=__codelineno-46-24 href=#__codelineno-46-24></a><span class=gp>... </span>        <span class=n>marker</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>color</span><span class=o>=</span><span class=s2>&quot;lightgray&quot;</span><span class=p>),</span> 
</span><span id=__span-46-25><a id=__codelineno-46-25 name=__codelineno-46-25 href=#__codelineno-46-25></a><span class=gp>... </span>        <span class=n>opacity</span><span class=o>=</span><span class=mf>0.5</span>
</span><span id=__span-46-26><a id=__codelineno-46-26 name=__codelineno-46-26 href=#__codelineno-46-26></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-46-27><a id=__codelineno-46-27 name=__codelineno-46-27 href=#__codelineno-46-27></a><span class=gp>... </span>    <span class=n>add_trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>row</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>col</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>
</span><span id=__span-46-28><a id=__codelineno-46-28 name=__codelineno-46-28 href=#__codelineno-46-28></a><span class=gp>... </span>    <span class=n>fig</span><span class=o>=</span><span class=n>fig</span>
</span><span id=__span-46-29><a id=__codelineno-46-29 name=__codelineno-46-29 href=#__codelineno-46-29></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-46-30><a id=__codelineno-46-30 name=__codelineno-46-30 href=#__codelineno-46-30></a><span class=gp>&gt;&gt;&gt; </span><span class=p>(</span><span class=n>lower_crossed</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>entry_mask</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>plot_as_entries</span><span class=p>(</span>
</span><span id=__span-46-31><a id=__codelineno-46-31 name=__codelineno-46-31 href=#__codelineno-46-31></a><span class=gp>... </span>    <span class=n>pf</span><span class=o>.</span><span class=n>get_in_output</span><span class=p>(</span><span class=s2>&quot;zscore&quot;</span><span class=p>),</span>
</span><span id=__span-46-32><a id=__codelineno-46-32 name=__codelineno-46-32 href=#__codelineno-46-32></a><span class=gp>... </span>    <span class=n>trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-46-33><a id=__codelineno-46-33 name=__codelineno-46-33 href=#__codelineno-46-33></a><span class=gp>... </span>        <span class=n>name</span><span class=o>=</span><span class=s2>&quot;Entries (ignored)&quot;</span><span class=p>,</span> 
</span><span id=__span-46-34><a id=__codelineno-46-34 name=__codelineno-46-34 href=#__codelineno-46-34></a><span class=gp>... </span>        <span class=n>marker</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>color</span><span class=o>=</span><span class=s2>&quot;lightgray&quot;</span><span class=p>),</span> 
</span><span id=__span-46-35><a id=__codelineno-46-35 name=__codelineno-46-35 href=#__codelineno-46-35></a><span class=gp>... </span>        <span class=n>opacity</span><span class=o>=</span><span class=mf>0.5</span>
</span><span id=__span-46-36><a id=__codelineno-46-36 name=__codelineno-46-36 href=#__codelineno-46-36></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-46-37><a id=__codelineno-46-37 name=__codelineno-46-37 href=#__codelineno-46-37></a><span class=gp>... </span>    <span class=n>add_trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>row</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>col</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>
</span><span id=__span-46-38><a id=__codelineno-46-38 name=__codelineno-46-38 href=#__codelineno-46-38></a><span class=gp>... </span>    <span class=n>fig</span><span class=o>=</span><span class=n>fig</span>
</span><span id=__span-46-39><a id=__codelineno-46-39 name=__codelineno-46-39 href=#__codelineno-46-39></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-46-40><a id=__codelineno-46-40 name=__codelineno-46-40 href=#__codelineno-46-40></a><span class=gp>&gt;&gt;&gt; </span><span class=n>exit_mask</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>plot_as_exits</span><span class=p>(</span>  <span class=c1># (8)!</span>
</span><span id=__span-46-41><a id=__codelineno-46-41 name=__codelineno-46-41 href=#__codelineno-46-41></a><span class=gp>... </span>    <span class=n>pf</span><span class=o>.</span><span class=n>get_in_output</span><span class=p>(</span><span class=s2>&quot;zscore&quot;</span><span class=p>),</span>
</span><span id=__span-46-42><a id=__codelineno-46-42 name=__codelineno-46-42 href=#__codelineno-46-42></a><span class=gp>... </span>    <span class=n>add_trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>row</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>col</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>
</span><span id=__span-46-43><a id=__codelineno-46-43 name=__codelineno-46-43 href=#__codelineno-46-43></a><span class=gp>... </span>    <span class=n>fig</span><span class=o>=</span><span class=n>fig</span>
</span><span id=__span-46-44><a id=__codelineno-46-44 name=__codelineno-46-44 href=#__codelineno-46-44></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-46-45><a id=__codelineno-46-45 name=__codelineno-46-45 href=#__codelineno-46-45></a><span class=gp>&gt;&gt;&gt; </span><span class=n>entry_mask</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>plot_as_entries</span><span class=p>(</span>
</span><span id=__span-46-46><a id=__codelineno-46-46 name=__codelineno-46-46 href=#__codelineno-46-46></a><span class=gp>... </span>    <span class=n>pf</span><span class=o>.</span><span class=n>get_in_output</span><span class=p>(</span><span class=s2>&quot;zscore&quot;</span><span class=p>),</span>
</span><span id=__span-46-47><a id=__codelineno-46-47 name=__codelineno-46-47 href=#__codelineno-46-47></a><span class=gp>... </span>    <span class=n>add_trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>row</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>col</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>
</span><span id=__span-46-48><a id=__codelineno-46-48 name=__codelineno-46-48 href=#__codelineno-46-48></a><span class=gp>... </span>    <span class=n>fig</span><span class=o>=</span><span class=n>fig</span>
</span><span id=__span-46-49><a id=__codelineno-46-49 name=__codelineno-46-49 href=#__codelineno-46-49></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-46-50><a id=__codelineno-46-50 name=__codelineno-46-50 href=#__codelineno-46-50></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>plot_allocations</span><span class=p>(</span>  <span class=c1># (9)!</span>
</span><span id=__span-46-51><a id=__codelineno-46-51 name=__codelineno-46-51 href=#__codelineno-46-51></a><span class=gp>... </span>    <span class=n>add_trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>row</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>col</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>
</span><span id=__span-46-52><a id=__codelineno-46-52 name=__codelineno-46-52 href=#__codelineno-46-52></a><span class=gp>... </span>    <span class=n>fig</span><span class=o>=</span><span class=n>fig</span>
</span><span id=__span-46-53><a id=__codelineno-46-53 name=__codelineno-46-53 href=#__codelineno-46-53></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-46-54><a id=__codelineno-46-54 name=__codelineno-46-54 href=#__codelineno-46-54></a><span class=gp>&gt;&gt;&gt; </span><span class=n>rebalancing_dates</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>unique</span><span class=p>(</span><span class=n>orders</span><span class=o>.</span><span class=n>idx</span><span class=o>.</span><span class=n>values</span><span class=p>)]</span>
</span><span id=__span-46-55><a id=__codelineno-46-55 name=__codelineno-46-55 href=#__codelineno-46-55></a><span class=gp>&gt;&gt;&gt; </span><span class=k>for</span> <span class=n>date</span> <span class=ow>in</span> <span class=n>rebalancing_dates</span><span class=p>:</span>
</span><span id=__span-46-56><a id=__codelineno-46-56 name=__codelineno-46-56 href=#__codelineno-46-56></a><span class=gp>... </span>    <span class=n>fig</span><span class=o>.</span><span class=n>add_vline</span><span class=p>(</span><span class=n>row</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>x</span><span class=o>=</span><span class=n>date</span><span class=p>,</span> <span class=n>line_color</span><span class=o>=</span><span class=s2>&quot;teal&quot;</span><span class=p>,</span> <span class=n>line_dash</span><span class=o>=</span><span class=s2>&quot;dot&quot;</span><span class=p>)</span>
</span><span id=__span-46-57><a id=__codelineno-46-57 name=__codelineno-46-57 href=#__codelineno-46-57></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span><span class=o>.</span><span class=n>update_layout</span><span class=p>(</span><span class=n>height</span><span class=o>=</span><span class=mi>600</span><span class=p>)</span>
</span><span id=__span-46-58><a id=__codelineno-46-58 name=__codelineno-46-58 href=#__codelineno-46-58></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fig</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <ol> <li>Create two subplots.</li> <li>The temporary spread array filled in the signal function can be accessed with <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.get_in_output>Portfolio.get_in_output</a>. It will be automatically converted into a Pandas format for you.</li> <li>Plot the spread on the first subplot.</li> <li>The portfolio object and the orders object are grouped. Since we only need the first asset to visualize rebalancing decisions, we ungroup the object and select the first asset.</li> <li>Get the mask for when the first asset was sold, indicating the upper threshold was crossed.</li> <li>Get the mask for when the first asset was bought, indicating the lower threshold was crossed.</li> <li>Plot ignored signals, which are crossover signals that were not executed.</li> <li>Plot executed signals.</li> <li>Plot the allocations on the second subplot.</li> </ol> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pairs-trading/iter_pt_portfolio.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pairs-trading/iter_pt_portfolio.dark.svg#only-dark></p> <p>Great! But what about parameter optimization? Since our parameters are defined as flexible arrays, we can pass them in many formats, including <a href=https://vectorbt.pro/pvt_41531c19/api/utils/params/#vectorbtpro.utils.params.Param>Param</a>. Now, let's see how varying the waiting time affects the number of orders:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-47-1><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>WAIT_SPACE</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=mi>30</span><span class=p>,</span> <span class=mi>370</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span><span id=__span-47-2><a id=__codelineno-47-2 name=__codelineno-47-2 href=#__codelineno-47-2></a>
</span><span id=__span-47-3><a id=__codelineno-47-3 name=__codelineno-47-3 href=#__codelineno-47-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>iter_pt_portfolio</span><span class=p>(</span><span class=n>wait_days</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span><span class=n>WAIT_SPACE</span><span class=p>))</span>
</span><span id=__span-47-4><a id=__codelineno-47-4 name=__codelineno-47-4 href=#__codelineno-47-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>count</span><span class=p>()</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>scatterplot</span><span class=p>(</span>
</span><span id=__span-47-5><a id=__codelineno-47-5 name=__codelineno-47-5 href=#__codelineno-47-5></a><span class=gp>... </span>    <span class=n>xaxis_title</span><span class=o>=</span><span class=s2>&quot;Wait days&quot;</span><span class=p>,</span>
</span><span id=__span-47-6><a id=__codelineno-47-6 name=__codelineno-47-6 href=#__codelineno-47-6></a><span class=gp>... </span>    <span class=n>yaxis_title</span><span class=o>=</span><span class=s2>&quot;Order count&quot;</span>
</span><span id=__span-47-7><a id=__codelineno-47-7 name=__codelineno-47-7 href=#__codelineno-47-7></a><span class=gp>... </span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pairs-trading/wait_days.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pairs-trading/wait_days.dark.svg#only-dark></p> <p>Keep in mind that the optimization approach above requires a lot of RAM because the OHLC data must be tiled as many times as there are parameter combinations. This is the same consideration as when optimizing <code>sl_stop</code> and other built-in parameters. You may also notice that both compilation and execution take much longer than before. Signal functions cannot be cached, so the entire simulator must be compiled from scratch with each runtime. Additionally, we must use a different simulation path than the faster path based on signal arrays that we used earlier. Also, our z-score implementation is quite slow since the mean and standard deviation need to be recomputed for every single bar (unlike the previous OLS indicator, which used one of the fastest algorithms available).</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-48-1><a id=__codelineno-48-1 name=__codelineno-48-1 href=#__codelineno-48-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>with</span> <span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>Timer</span><span class=p>()</span> <span class=k>as</span> <span class=n>timer</span><span class=p>,</span> <span class=n>vbt</span><span class=o>.</span><span class=n>MemTracer</span><span class=p>()</span> <span class=k>as</span> <span class=n>tracer</span><span class=p>):</span>
</span><span id=__span-48-2><a id=__codelineno-48-2 name=__codelineno-48-2 href=#__codelineno-48-2></a><span class=gp>... </span>    <span class=n>iter_pt_portfolio</span><span class=p>(</span><span class=n>wait_days</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span><span class=n>WAIT_SPACE</span><span class=p>))</span>
</span><span id=__span-48-3><a id=__codelineno-48-3 name=__codelineno-48-3 href=#__codelineno-48-3></a>
</span><span id=__span-48-4><a id=__codelineno-48-4 name=__codelineno-48-4 href=#__codelineno-48-4></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=n>timer</span><span class=o>.</span><span class=n>elapsed</span><span class=p>())</span>
</span><span id=__span-48-5><a id=__codelineno-48-5 name=__codelineno-48-5 href=#__codelineno-48-5></a><span class=go>8.62 seconds</span>
</span><span id=__span-48-6><a id=__codelineno-48-6 name=__codelineno-48-6 href=#__codelineno-48-6></a>
</span><span id=__span-48-7><a id=__codelineno-48-7 name=__codelineno-48-7 href=#__codelineno-48-7></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=n>tracer</span><span class=o>.</span><span class=n>peak_usage</span><span class=p>())</span>
</span><span id=__span-48-8><a id=__codelineno-48-8 name=__codelineno-48-8 href=#__codelineno-48-8></a><span class=go>306.2 MB</span>
</span></code></pre></div> <p>While compilation time is difficult to reduce, execution time can be significantly decreased by replacing both the mean and standard deviation operations with a z-score accumulator. A z-score accumulator computes z-scores incrementally, avoiding expensive aggregations. Fortunately, VBT already includes such an accumulator: <a href=https://vectorbt.pro/pvt_41531c19/api/generic/nb/rolling/#vectorbtpro.generic.nb.rolling.rolling_zscore_acc_nb>rolling_zscore_acc_nb</a>. The process works like this: you provide an input state containing the information needed to process the value for this bar, pass it to the accumulator, and receive an output state that contains both the calculated z-score and the updated information for the next bar.</p> <p>The first question is: what information should we store? In general, you need to keep the data that the accumulator updates and will require as input for the next bar. The next question is: how do we store this information? A state usually consists of several individual values, but named tuples are immutable. The trick is to use a <a href=https://numpy.org/doc/stable/user/basics.rec.html>structured NumPy array</a>, which you can think of as a regular NumPy array that holds mutable named tuples. We will create a one-dimensional array with one tuple per group.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-49-1><a id=__codelineno-49-1 name=__codelineno-49-1 href=#__codelineno-49-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>zscore_state_dt</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>dtype</span><span class=p>(</span>  <span class=c1># (1)!</span>
</span><span id=__span-49-2><a id=__codelineno-49-2 name=__codelineno-49-2 href=#__codelineno-49-2></a><span class=gp>... </span>    <span class=p>[</span>
</span><span id=__span-49-3><a id=__codelineno-49-3 name=__codelineno-49-3 href=#__codelineno-49-3></a><span class=gp>... </span>        <span class=p>(</span><span class=s2>&quot;cumsum&quot;</span><span class=p>,</span> <span class=n>float_</span><span class=p>),</span>
</span><span id=__span-49-4><a id=__codelineno-49-4 name=__codelineno-49-4 href=#__codelineno-49-4></a><span class=gp>... </span>        <span class=p>(</span><span class=s2>&quot;cumsum_sq&quot;</span><span class=p>,</span> <span class=n>float_</span><span class=p>),</span>
</span><span id=__span-49-5><a id=__codelineno-49-5 name=__codelineno-49-5 href=#__codelineno-49-5></a><span class=gp>... </span>        <span class=p>(</span><span class=s2>&quot;nancnt&quot;</span><span class=p>,</span> <span class=n>int_</span><span class=p>)</span>
</span><span id=__span-49-6><a id=__codelineno-49-6 name=__codelineno-49-6 href=#__codelineno-49-6></a><span class=gp>... </span>    <span class=p>],</span>
</span><span id=__span-49-7><a id=__codelineno-49-7 name=__codelineno-49-7 href=#__codelineno-49-7></a><span class=gp>... </span>    <span class=n>align</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-49-8><a id=__codelineno-49-8 name=__codelineno-49-8 href=#__codelineno-49-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-49-9><a id=__codelineno-49-9 name=__codelineno-49-9 href=#__codelineno-49-9></a>
</span><span id=__span-49-10><a id=__codelineno-49-10 name=__codelineno-49-10 href=#__codelineno-49-10></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span><span class=p>(</span><span class=n>nogil</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>boundscheck</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-49-11><a id=__codelineno-49-11 name=__codelineno-49-11 href=#__codelineno-49-11></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>stream_signal_func_nb</span><span class=p>(</span>
</span><span id=__span-49-12><a id=__codelineno-49-12 name=__codelineno-49-12 href=#__codelineno-49-12></a><span class=gp>... </span>    <span class=n>c</span><span class=p>,</span> 
</span><span id=__span-49-13><a id=__codelineno-49-13 name=__codelineno-49-13 href=#__codelineno-49-13></a><span class=gp>... </span>    <span class=n>window</span><span class=p>,</span> 
</span><span id=__span-49-14><a id=__codelineno-49-14 name=__codelineno-49-14 href=#__codelineno-49-14></a><span class=gp>... </span>    <span class=n>upper</span><span class=p>,</span> 
</span><span id=__span-49-15><a id=__codelineno-49-15 name=__codelineno-49-15 href=#__codelineno-49-15></a><span class=gp>... </span>    <span class=n>lower</span><span class=p>,</span> 
</span><span id=__span-49-16><a id=__codelineno-49-16 name=__codelineno-49-16 href=#__codelineno-49-16></a><span class=gp>... </span>    <span class=n>wait_days</span><span class=p>,</span> 
</span><span id=__span-49-17><a id=__codelineno-49-17 name=__codelineno-49-17 href=#__codelineno-49-17></a><span class=gp>... </span>    <span class=n>zscore_state</span>  <span class=c1># (2)!</span>
</span><span id=__span-49-18><a id=__codelineno-49-18 name=__codelineno-49-18 href=#__codelineno-49-18></a><span class=gp>... </span><span class=p>):</span>
</span><span id=__span-49-19><a id=__codelineno-49-19 name=__codelineno-49-19 href=#__codelineno-49-19></a><span class=gp>... </span>    <span class=n>_window</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>window</span><span class=p>)</span>
</span><span id=__span-49-20><a id=__codelineno-49-20 name=__codelineno-49-20 href=#__codelineno-49-20></a><span class=gp>... </span>        
</span><span id=__span-49-21><a id=__codelineno-49-21 name=__codelineno-49-21 href=#__codelineno-49-21></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-49-22><a id=__codelineno-49-22 name=__codelineno-49-22 href=#__codelineno-49-22></a><span class=gp>... </span>        <span class=n>x</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>close</span><span class=p>,</span> <span class=n>col</span><span class=o>=</span><span class=n>c</span><span class=o>.</span><span class=n>col</span><span class=p>)</span>
</span><span id=__span-49-23><a id=__codelineno-49-23 name=__codelineno-49-23 href=#__codelineno-49-23></a><span class=gp>... </span>        <span class=n>y</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>close</span><span class=p>,</span> <span class=n>col</span><span class=o>=</span><span class=n>c</span><span class=o>.</span><span class=n>col</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span><span id=__span-49-24><a id=__codelineno-49-24 name=__codelineno-49-24 href=#__codelineno-49-24></a><span class=gp>... </span>        <span class=n>c</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>spread</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>y</span><span class=p>)</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span><span id=__span-49-25><a id=__codelineno-49-25 name=__codelineno-49-25 href=#__codelineno-49-25></a><span class=gp>... </span>        
</span><span id=__span-49-26><a id=__codelineno-49-26 name=__codelineno-49-26 href=#__codelineno-49-26></a><span class=gp>... </span>        <span class=n>value</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>spread</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>]</span>  <span class=c1># (3)!</span>
</span><span id=__span-49-27><a id=__codelineno-49-27 name=__codelineno-49-27 href=#__codelineno-49-27></a><span class=gp>... </span>        <span class=n>pre_i</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>-</span> <span class=n>_window</span>
</span><span id=__span-49-28><a id=__codelineno-49-28 name=__codelineno-49-28 href=#__codelineno-49-28></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>pre_i</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-49-29><a id=__codelineno-49-29 name=__codelineno-49-29 href=#__codelineno-49-29></a><span class=gp>... </span>            <span class=n>pre_window_value</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>spread</span><span class=p>[</span><span class=n>pre_i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>]</span>  <span class=c1># (4)!</span>
</span><span id=__span-49-30><a id=__codelineno-49-30 name=__codelineno-49-30 href=#__codelineno-49-30></a><span class=gp>... </span>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-49-31><a id=__codelineno-49-31 name=__codelineno-49-31 href=#__codelineno-49-31></a><span class=gp>... </span>            <span class=n>pre_window_value</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span>
</span><span id=__span-49-32><a id=__codelineno-49-32 name=__codelineno-49-32 href=#__codelineno-49-32></a><span class=gp>... </span>        <span class=n>zscore_in_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>enums</span><span class=o>.</span><span class=n>RollZScoreAIS</span><span class=p>(</span>  <span class=c1># (5)!</span>
</span><span id=__span-49-33><a id=__codelineno-49-33 name=__codelineno-49-33 href=#__codelineno-49-33></a><span class=gp>... </span>            <span class=n>i</span><span class=o>=</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span>
</span><span id=__span-49-34><a id=__codelineno-49-34 name=__codelineno-49-34 href=#__codelineno-49-34></a><span class=gp>... </span>            <span class=n>value</span><span class=o>=</span><span class=n>value</span><span class=p>,</span>
</span><span id=__span-49-35><a id=__codelineno-49-35 name=__codelineno-49-35 href=#__codelineno-49-35></a><span class=gp>... </span>            <span class=n>pre_window_value</span><span class=o>=</span><span class=n>pre_window_value</span><span class=p>,</span>
</span><span id=__span-49-36><a id=__codelineno-49-36 name=__codelineno-49-36 href=#__codelineno-49-36></a><span class=gp>... </span>            <span class=n>cumsum</span><span class=o>=</span><span class=n>zscore_state</span><span class=p>[</span><span class=s2>&quot;cumsum&quot;</span><span class=p>][</span><span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>],</span>
</span><span id=__span-49-37><a id=__codelineno-49-37 name=__codelineno-49-37 href=#__codelineno-49-37></a><span class=gp>... </span>            <span class=n>cumsum_sq</span><span class=o>=</span><span class=n>zscore_state</span><span class=p>[</span><span class=s2>&quot;cumsum_sq&quot;</span><span class=p>][</span><span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>],</span>
</span><span id=__span-49-38><a id=__codelineno-49-38 name=__codelineno-49-38 href=#__codelineno-49-38></a><span class=gp>... </span>            <span class=n>nancnt</span><span class=o>=</span><span class=n>zscore_state</span><span class=p>[</span><span class=s2>&quot;nancnt&quot;</span><span class=p>][</span><span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>],</span>
</span><span id=__span-49-39><a id=__codelineno-49-39 name=__codelineno-49-39 href=#__codelineno-49-39></a><span class=gp>... </span>            <span class=n>window</span><span class=o>=</span><span class=n>_window</span><span class=p>,</span>
</span><span id=__span-49-40><a id=__codelineno-49-40 name=__codelineno-49-40 href=#__codelineno-49-40></a><span class=gp>... </span>            <span class=n>minp</span><span class=o>=</span><span class=n>_window</span><span class=p>,</span>
</span><span id=__span-49-41><a id=__codelineno-49-41 name=__codelineno-49-41 href=#__codelineno-49-41></a><span class=gp>... </span>            <span class=n>ddof</span><span class=o>=</span><span class=mi>0</span>
</span><span id=__span-49-42><a id=__codelineno-49-42 name=__codelineno-49-42 href=#__codelineno-49-42></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-49-43><a id=__codelineno-49-43 name=__codelineno-49-43 href=#__codelineno-49-43></a><span class=gp>... </span>        <span class=n>zscore_out_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>rolling_zscore_acc_nb</span><span class=p>(</span><span class=n>zscore_in_state</span><span class=p>)</span>  <span class=c1># (6)!</span>
</span><span id=__span-49-44><a id=__codelineno-49-44 name=__codelineno-49-44 href=#__codelineno-49-44></a><span class=gp>... </span>        <span class=n>c</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>zscore</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>]</span> <span class=o>=</span> <span class=n>zscore_out_state</span><span class=o>.</span><span class=n>value</span>  <span class=c1># (7)!</span>
</span><span id=__span-49-45><a id=__codelineno-49-45 name=__codelineno-49-45 href=#__codelineno-49-45></a><span class=gp>... </span>        <span class=n>zscore_state</span><span class=p>[</span><span class=s2>&quot;cumsum&quot;</span><span class=p>][</span><span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>]</span> <span class=o>=</span> <span class=n>zscore_out_state</span><span class=o>.</span><span class=n>cumsum</span>  <span class=c1># (8)!</span>
</span><span id=__span-49-46><a id=__codelineno-49-46 name=__codelineno-49-46 href=#__codelineno-49-46></a><span class=gp>... </span>        <span class=n>zscore_state</span><span class=p>[</span><span class=s2>&quot;cumsum_sq&quot;</span><span class=p>][</span><span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>]</span> <span class=o>=</span> <span class=n>zscore_out_state</span><span class=o>.</span><span class=n>cumsum_sq</span>
</span><span id=__span-49-47><a id=__codelineno-49-47 name=__codelineno-49-47 href=#__codelineno-49-47></a><span class=gp>... </span>        <span class=n>zscore_state</span><span class=p>[</span><span class=s2>&quot;nancnt&quot;</span><span class=p>][</span><span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>]</span> <span class=o>=</span> <span class=n>zscore_out_state</span><span class=o>.</span><span class=n>nancnt</span>
</span><span id=__span-49-48><a id=__codelineno-49-48 name=__codelineno-49-48 href=#__codelineno-49-48></a><span class=gp>... </span>        
</span><span id=__span-49-49><a id=__codelineno-49-49 name=__codelineno-49-49 href=#__codelineno-49-49></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>create_signals_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>upper</span><span class=p>,</span> <span class=n>lower</span><span class=p>,</span> <span class=n>wait_days</span><span class=p>)</span>
</span></code></pre></div> <ol> <li>Specify the fields of a structured array that will hold the state.</li> <li>The structured array will be created later using a template.</li> <li>The z-score is based on the spread.</li> <li>The calculation function also needs the spread value from <code>window</code> bars ago.</li> <li>Create an input state using all available information.</li> <li>Run the calculation function.</li> <li>Store the returned z-score.</li> <li>Remember to also store the new state.</li> </ol> <p>Next, we will adapt the portfolio function to use the new signal function:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-50-1><a id=__codelineno-50-1 name=__codelineno-50-1 href=#__codelineno-50-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>stream_pt_portfolio</span> <span class=o>=</span> <span class=n>partial</span><span class=p>(</span>  <span class=c1># (1)!</span>
</span><span id=__span-50-2><a id=__codelineno-50-2 name=__codelineno-50-2 href=#__codelineno-50-2></a><span class=gp>... </span>    <span class=n>iter_pt_portfolio</span><span class=p>,</span>
</span><span id=__span-50-3><a id=__codelineno-50-3 name=__codelineno-50-3 href=#__codelineno-50-3></a><span class=gp>... </span>    <span class=n>signal_func_nb</span><span class=o>=</span><span class=n>stream_signal_func_nb</span><span class=p>,</span>
</span><span id=__span-50-4><a id=__codelineno-50-4 name=__codelineno-50-4 href=#__codelineno-50-4></a><span class=gp>... </span>    <span class=n>more_signal_args</span><span class=o>=</span><span class=p>(</span>  <span class=c1># (2)!</span>
</span><span id=__span-50-5><a id=__codelineno-50-5 name=__codelineno-50-5 href=#__codelineno-50-5></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span>  <span class=c1># (3)!</span>
</span><span id=__span-50-6><a id=__codelineno-50-6 name=__codelineno-50-6 href=#__codelineno-50-6></a><span class=gp>... </span><span class=w>            </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-50-7><a id=__codelineno-50-7 name=__codelineno-50-7 href=#__codelineno-50-7></a><span class=gp>... </span><span class=sd>            n_groups = target_shape[1] // 2</span>
</span><span id=__span-50-8><a id=__codelineno-50-8 name=__codelineno-50-8 href=#__codelineno-50-8></a><span class=gp>... </span><span class=sd>            zscore_state = np.empty(n_groups, dtype=zscore_state_dt)</span>
</span><span id=__span-50-9><a id=__codelineno-50-9 name=__codelineno-50-9 href=#__codelineno-50-9></a><span class=gp>... </span><span class=sd>            zscore_state[&quot;cumsum&quot;] = 0.0</span>
</span><span id=__span-50-10><a id=__codelineno-50-10 name=__codelineno-50-10 href=#__codelineno-50-10></a><span class=gp>... </span><span class=sd>            zscore_state[&quot;cumsum_sq&quot;] = 0.0</span>
</span><span id=__span-50-11><a id=__codelineno-50-11 name=__codelineno-50-11 href=#__codelineno-50-11></a><span class=gp>... </span><span class=sd>            zscore_state[&quot;nancnt&quot;] = 0</span>
</span><span id=__span-50-12><a id=__codelineno-50-12 name=__codelineno-50-12 href=#__codelineno-50-12></a><span class=gp>... </span><span class=sd>            zscore_state</span>
</span><span id=__span-50-13><a id=__codelineno-50-13 name=__codelineno-50-13 href=#__codelineno-50-13></a><span class=gp>... </span><span class=sd>            &quot;&quot;&quot;</span><span class=p>,</span> 
</span><span id=__span-50-14><a id=__codelineno-50-14 name=__codelineno-50-14 href=#__codelineno-50-14></a><span class=gp>... </span>            <span class=n>context</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>zscore_state_dt</span><span class=o>=</span><span class=n>zscore_state_dt</span><span class=p>)</span>
</span><span id=__span-50-15><a id=__codelineno-50-15 name=__codelineno-50-15 href=#__codelineno-50-15></a><span class=gp>... </span>        <span class=p>),</span>
</span><span id=__span-50-16><a id=__codelineno-50-16 name=__codelineno-50-16 href=#__codelineno-50-16></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-50-17><a id=__codelineno-50-17 name=__codelineno-50-17 href=#__codelineno-50-17></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <ol> <li>Copy the <code>iter_pt_portfolio</code> function and replace its default signal function.</li> <li>The new signal function expects a structured array as its last argument. This is why we made it possible to provide additional arguments earlier.</li> <li>Since the number of groups is not known yet, create an expression template that will be substituted once this information becomes available. The template should create, initialize, and return a new structured array with the data type defined above.</li> </ol> <p>All set! Let's build the portfolio and validate it by comparing with the previous one:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-51-1><a id=__codelineno-51-1 name=__codelineno-51-1 href=#__codelineno-51-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>stream_pf</span> <span class=o>=</span> <span class=n>stream_pt_portfolio</span><span class=p>()</span>
</span><span id=__span-51-2><a id=__codelineno-51-2 name=__codelineno-51-2 href=#__codelineno-51-2></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=n>stream_pf</span><span class=o>.</span><span class=n>total_return</span><span class=p>)</span>
</span><span id=__span-51-3><a id=__codelineno-51-3 name=__codelineno-51-3 href=#__codelineno-51-3></a><span class=go>0.15210165047643728</span>
</span><span id=__span-51-4><a id=__codelineno-51-4 name=__codelineno-51-4 href=#__codelineno-51-4></a>
</span><span id=__span-51-5><a id=__codelineno-51-5 name=__codelineno-51-5 href=#__codelineno-51-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>iter_pt_portfolio</span><span class=p>()</span>
</span><span id=__span-51-6><a id=__codelineno-51-6 name=__codelineno-51-6 href=#__codelineno-51-6></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=n>pf</span><span class=o>.</span><span class=n>total_return</span><span class=p>)</span>
</span><span id=__span-51-7><a id=__codelineno-51-7 name=__codelineno-51-7 href=#__codelineno-51-7></a><span class=go>0.15210165047643728</span>
</span></code></pre></div> <p>Finally, let's benchmark the new portfolio using <code>WAIT_SPACE</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-52-1><a id=__codelineno-52-1 name=__codelineno-52-1 href=#__codelineno-52-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>with</span> <span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>Timer</span><span class=p>()</span> <span class=k>as</span> <span class=n>timer</span><span class=p>,</span> <span class=n>vbt</span><span class=o>.</span><span class=n>MemTracer</span><span class=p>()</span> <span class=k>as</span> <span class=n>tracer</span><span class=p>):</span>
</span><span id=__span-52-2><a id=__codelineno-52-2 name=__codelineno-52-2 href=#__codelineno-52-2></a><span class=gp>... </span>    <span class=n>stream_pt_portfolio</span><span class=p>(</span><span class=n>wait_days</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span><span class=n>WAIT_SPACE</span><span class=p>))</span>
</span><span id=__span-52-3><a id=__codelineno-52-3 name=__codelineno-52-3 href=#__codelineno-52-3></a>
</span><span id=__span-52-4><a id=__codelineno-52-4 name=__codelineno-52-4 href=#__codelineno-52-4></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=n>timer</span><span class=o>.</span><span class=n>elapsed</span><span class=p>())</span>
</span><span id=__span-52-5><a id=__codelineno-52-5 name=__codelineno-52-5 href=#__codelineno-52-5></a><span class=go>1.52 seconds</span>
</span><span id=__span-52-6><a id=__codelineno-52-6 name=__codelineno-52-6 href=#__codelineno-52-6></a>
</span><span id=__span-52-7><a id=__codelineno-52-7 name=__codelineno-52-7 href=#__codelineno-52-7></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=n>tracer</span><span class=o>.</span><span class=n>peak_usage</span><span class=p>())</span>
</span><span id=__span-52-8><a id=__codelineno-52-8 name=__codelineno-52-8 href=#__codelineno-52-8></a><span class=go>306.2 MB</span>
</span></code></pre></div> <div class="admonition info"> <p class=admonition-title>Info</p> <p>Run this cell at least twice, because the simulation may need to compile during the first run. This is necessary because compilation is triggered whenever a new set of argument <strong>types</strong> is detected. A single parameter combination and multiple parameter combinations produce two distinct sets of argument types.</p> </div> <p>The final optimization to further speed up the simulation for multiple parameter combinations is to enable in-house chunking. There is one important detail: <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_signals>Portfolio.from_signals</a> cannot chunk user-defined arrays automatically, so we must provide the chunking specifications for all arguments in both <code>signal_args</code> and <code>in_outputs</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-53-1><a id=__codelineno-53-1 name=__codelineno-53-1 href=#__codelineno-53-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>chunked_stream_pt_portfolio</span> <span class=o>=</span> <span class=n>partial</span><span class=p>(</span>
</span><span id=__span-53-2><a id=__codelineno-53-2 name=__codelineno-53-2 href=#__codelineno-53-2></a><span class=gp>... </span>    <span class=n>stream_pt_portfolio</span><span class=p>,</span>
</span><span id=__span-53-3><a id=__codelineno-53-3 name=__codelineno-53-3 href=#__codelineno-53-3></a><span class=gp>... </span>    <span class=n>chunked</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>  <span class=c1># (1)!</span>
</span><span id=__span-53-4><a id=__codelineno-53-4 name=__codelineno-53-4 href=#__codelineno-53-4></a><span class=gp>... </span>        <span class=n>engine</span><span class=o>=</span><span class=s2>&quot;threadpool&quot;</span><span class=p>,</span>
</span><span id=__span-53-5><a id=__codelineno-53-5 name=__codelineno-53-5 href=#__codelineno-53-5></a><span class=gp>... </span>        <span class=n>arg_take_spec</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-53-6><a id=__codelineno-53-6 name=__codelineno-53-6 href=#__codelineno-53-6></a><span class=gp>... </span>            <span class=n>signal_args</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>ArgsTaker</span><span class=p>(</span>
</span><span id=__span-53-7><a id=__codelineno-53-7 name=__codelineno-53-7 href=#__codelineno-53-7></a><span class=gp>... </span>                <span class=n>vbt</span><span class=o>.</span><span class=n>flex_array_gl_slicer</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-53-8><a id=__codelineno-53-8 name=__codelineno-53-8 href=#__codelineno-53-8></a><span class=gp>... </span>                <span class=n>vbt</span><span class=o>.</span><span class=n>flex_array_gl_slicer</span><span class=p>,</span>
</span><span id=__span-53-9><a id=__codelineno-53-9 name=__codelineno-53-9 href=#__codelineno-53-9></a><span class=gp>... </span>                <span class=n>vbt</span><span class=o>.</span><span class=n>flex_array_gl_slicer</span><span class=p>,</span>
</span><span id=__span-53-10><a id=__codelineno-53-10 name=__codelineno-53-10 href=#__codelineno-53-10></a><span class=gp>... </span>                <span class=n>vbt</span><span class=o>.</span><span class=n>flex_array_gl_slicer</span><span class=p>,</span>
</span><span id=__span-53-11><a id=__codelineno-53-11 name=__codelineno-53-11 href=#__codelineno-53-11></a><span class=gp>... </span>                <span class=n>vbt</span><span class=o>.</span><span class=n>ArraySlicer</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-53-12><a id=__codelineno-53-12 name=__codelineno-53-12 href=#__codelineno-53-12></a><span class=gp>... </span>            <span class=p>),</span>
</span><span id=__span-53-13><a id=__codelineno-53-13 name=__codelineno-53-13 href=#__codelineno-53-13></a><span class=gp>... </span>            <span class=n>in_outputs</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>SequenceTaker</span><span class=p>([</span>
</span><span id=__span-53-14><a id=__codelineno-53-14 name=__codelineno-53-14 href=#__codelineno-53-14></a><span class=gp>... </span>                <span class=n>vbt</span><span class=o>.</span><span class=n>ArraySlicer</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>  <span class=c1># (4)!</span>
</span><span id=__span-53-15><a id=__codelineno-53-15 name=__codelineno-53-15 href=#__codelineno-53-15></a><span class=gp>... </span>                <span class=n>vbt</span><span class=o>.</span><span class=n>ArraySlicer</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-53-16><a id=__codelineno-53-16 name=__codelineno-53-16 href=#__codelineno-53-16></a><span class=gp>... </span>            <span class=p>])</span>
</span><span id=__span-53-17><a id=__codelineno-53-17 name=__codelineno-53-17 href=#__codelineno-53-17></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-53-18><a id=__codelineno-53-18 name=__codelineno-53-18 href=#__codelineno-53-18></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-53-19><a id=__codelineno-53-19 name=__codelineno-53-19 href=#__codelineno-53-19></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-53-20><a id=__codelineno-53-20 name=__codelineno-53-20 href=#__codelineno-53-20></a>
</span><span id=__span-53-21><a id=__codelineno-53-21 name=__codelineno-53-21 href=#__codelineno-53-21></a><span class=gp>&gt;&gt;&gt; </span><span class=k>with</span> <span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>Timer</span><span class=p>()</span> <span class=k>as</span> <span class=n>timer</span><span class=p>,</span> <span class=n>vbt</span><span class=o>.</span><span class=n>MemTracer</span><span class=p>()</span> <span class=k>as</span> <span class=n>tracer</span><span class=p>):</span>
</span><span id=__span-53-22><a id=__codelineno-53-22 name=__codelineno-53-22 href=#__codelineno-53-22></a><span class=gp>... </span>    <span class=n>chunked_stream_pt_portfolio</span><span class=p>(</span><span class=n>wait_days</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span><span class=n>WAIT_SPACE</span><span class=p>))</span>
</span><span id=__span-53-23><a id=__codelineno-53-23 name=__codelineno-53-23 href=#__codelineno-53-23></a>
</span><span id=__span-53-24><a id=__codelineno-53-24 name=__codelineno-53-24 href=#__codelineno-53-24></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=n>timer</span><span class=o>.</span><span class=n>elapsed</span><span class=p>())</span>
</span><span id=__span-53-25><a id=__codelineno-53-25 name=__codelineno-53-25 href=#__codelineno-53-25></a><span class=go>520.08 milliseconds</span>
</span><span id=__span-53-26><a id=__codelineno-53-26 name=__codelineno-53-26 href=#__codelineno-53-26></a>
</span><span id=__span-53-27><a id=__codelineno-53-27 name=__codelineno-53-27 href=#__codelineno-53-27></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=n>tracer</span><span class=o>.</span><span class=n>peak_usage</span><span class=p>())</span>
</span><span id=__span-53-28><a id=__codelineno-53-28 name=__codelineno-53-28 href=#__codelineno-53-28></a><span class=go>306.4 MB</span>
</span></code></pre></div> <ol> <li>Accepts the same arguments as <code>@chunked</code>, provided as a dictionary.</li> <li>This special type, widely used by simulators, first chunks the groups, then maps each group to its respective columns, and finally slices the columns out of a flexible array.</li> <li>An array slicer without a mapper will slice arrays by groups. This is exactly what we want here, since <code>zscore_state</code> has its length equal to the number of groups.</li> <li>Temporary arrays <code>spread</code> and <code>zscore</code> are also group metrics, but they are two-dimensional arrays, so we must use the second axis (columns).</li> </ol> <p>With this optimization, simulation is now an order of magnitude faster than before <img alt=💨 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f4a8.svg title=:dash:></p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>To reduce memory usage during execution, use the "serial" engine or build super chunks.</p> </div> <h2 id=summary>Summary<a class=headerlink href=#summary title="Permanent link">&para;</a></h2> <p>Pairs trading uses two columns with opposite position signs, making it an almost perfect use case for VBT's integrated grouping mechanics. It gets even better: most pairs trading strategies can be implemented using semi-vectorized, iterative, and streaming approaches alike. This tutorial demonstrates how to incrementally develop a strategy and then optimize it for high performance and low resource consumption.</p> <p>We started with the discovery phase, designing and implementing the strategy from the ground up using various high-level tools without focusing on performance. Once the strategy's framework was established, we focused on speeding up execution to discover more profitable configurations in less time. Finally, we moved to an iterative approach to gain complete control over execution. But this does not have to be the end of the story: if you are curious, you can build your own simulator and unlock power that others can only dream of <img alt=🦸 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f9b8.svg title=:superhero:></p> <p><a class=md-button href=https://vectorbt.pro/pvt_41531c19/assets/jupytext/tutorials/pairs-trading.py.txt target=blank_><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19.14 7.5A2.86 2.86 0 0 1 22 10.36v3.78A2.86 2.86 0 0 1 19.14 17H12c0 .39.32.96.71.96H17v1.68a2.86 2.86 0 0 1-2.86 2.86H9.86A2.86 2.86 0 0 1 7 19.64v-3.75a2.85 2.85 0 0 1 2.86-2.85h5.25a2.85 2.85 0 0 0 2.85-2.86V7.5zm-4.28 11.79c-.4 0-.72.3-.72.89s.32.71.72.71a.71.71 0 0 0 .71-.71c0-.59-.32-.89-.71-.89m-10-1.79A2.86 2.86 0 0 1 2 14.64v-3.78A2.86 2.86 0 0 1 4.86 8H12c0-.39-.32-.96-.71-.96H7V5.36A2.86 2.86 0 0 1 9.86 2.5h4.28A2.86 2.86 0 0 1 17 5.36v3.75a2.85 2.85 0 0 1-2.86 2.85H8.89a2.85 2.85 0 0 0-2.85 2.86v2.68zM9.14 5.71c.4 0 .72-.3.72-.89s-.32-.71-.72-.71c-.39 0-.71.12-.71.71s.32.89.71.89"/></svg></span> Python code</a> <a class=md-button href=https://github.com/polakowo/vectorbt.pro/blob/notebooks/PairsTrading.ipynb target=blank_><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 4v6l-2-2-2 2V4H9v16h10V4zM3 7V5h2V4a2 2 0 0 1 2-2h12c1.05 0 2 .95 2 2v16c0 1.05-.95 2-2 2H7c-1.05 0-2-.95-2-2v-1H3v-2h2v-4H3v-2h2V7zm2-2v2h2V5zm0 14h2v-2H5zm0-6h2v-2H5z"/></svg></span> Notebook</a></p> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/portfolio-optimization/dynamic/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Dynamic"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Dynamic </div> </div> </a> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/patterns-and-projections/patterns/ class="md-footer__link md-footer__link--next" aria-label="Next: Patterns"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Patterns </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2021-2025 Oleg Polakow. All rights reserved. </div> </div> <div class=md-social> <a href=https://www.linkedin.com/in/polakowo target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> <a href=https://github.com/polakowo target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <div class=md-consent data-md-component=consent id=__consent hidden> <div class=md-consent__overlay></div> <aside class=md-consent__inner> <form class="md-consent__form md-grid md-typeset" name=consent> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class=md-toggle type=checkbox id=__settings> <div class=md-consent__settings> <ul class=task-list> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=analytics checked> <span class=task-list-indicator></span> Google Analytics </label> </li> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=github checked> <span class=task-list-indicator></span> GitHub </label> </li> </ul> </div> <div class=md-consent__controls> <button class="md-button md-button--primary">Accept</button> <label class=md-button for=__settings>Manage settings</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script> <script id=__config type=application/json>{"annotate": null, "base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.instant", "navigation.instant.progress", "navigation.top", "navigation.prune", "navigation.path", "navigation.footer", "search.suggest", "search.share", "content.code.annotate", "content.code.copy", "content.code.select", "content.tooltips", "content.tabs.link", "toc.follow", "toc.integrate", "announce.dismiss"], "search": "../../assets/javascripts/workers/search.26099bd0.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=https://vectorbt.pro/pvt_41531c19/assets/javascripts/bundle.9d1edc04.min.js></script> <script src=https://vectorbt.pro/pvt_41531c19/assets/scripts/extra.js></script> <script src=https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js></script> </body> 
<!-- Mirrored from vectorbt.pro/pvt_41531c19/tutorials/pairs-trading/ by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 22 Nov 2025 03:46:56 GMT -->
</html>