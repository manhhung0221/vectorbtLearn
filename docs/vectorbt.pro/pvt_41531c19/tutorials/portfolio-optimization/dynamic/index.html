<!doctype html><html lang=en class=no-js> 
<!-- Mirrored from vectorbt.pro/pvt_41531c19/tutorials/portfolio-optimization/dynamic/ by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 22 Nov 2025 03:46:58 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Learn about dynamic portfolio optimization in VectorBT PRO"><meta name=author content="Oleg Polakow"><link href=https://vectorbt.pro/tutorials/portfolio-optimization/dynamic/ rel=canonical><link href=../integrations/index.html rel=prev><link href=../../pairs-trading/index.html rel=next><link rel=icon href=../../../assets/logo/favicon.png><meta name=generator content="mkdocs-1.6.0, mkdocs-material-9.6.21+insiders-4.53.17"><title>Dynamic - VectorBT® PRO</title><link rel=stylesheet href=../../../assets/stylesheets/main.010a373c.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=../../../../../fonts.gstatic.com/index.html crossorigin><link rel=stylesheet href="../../../../../fonts.googleapis.com/cssbe43.css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../assets/stylesheets/extra.css><link rel=stylesheet href=../../../assets/stylesheets/custom-light.css><link rel=stylesheet href=../../../assets/stylesheets/custom-dark.css><link rel=stylesheet href=../../../assets/stylesheets/pygments-light.css><link rel=stylesheet href=../../../assets/stylesheets/pygments-dark.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-0C5VNYCFHL"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-0C5VNYCFHL",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="../../../../../www.googletagmanager.com/gtag/jsc6c8?id=G-0C5VNYCFHL",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script><meta name=robots content="noindex, nofollow"><meta property=og:title content=Dynamic><meta property=og:type content=website><meta content=https://vectorbt.pro/tutorials/portfolio-optimization/dynamic/ property=og:url><meta property=og:image:url content=https://vectorbt.pro/pvt_41531c19/assets/logo/social-new.png><meta property=og:image:type content=image/png><meta property=og:description content="Learn about dynamic portfolio optimization in VectorBT PRO"><meta property=og:locale content=en-GB><link rel=apple-touch-icon sizes=180x180 href=https://vectorbt.pro/pvt_41531c19/assets/logo/apple-touch-icon.png><link rel=icon type=image/svg+xml href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon.svg><link rel=icon type=image/png sizes=32x32 href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon-16x16.png><link rel=manifest href=https://vectorbt.pro/pvt_41531c19/assets/logo/site.webmanifest><link rel=mask-icon href=https://vectorbt.pro/pvt_41531c19/assets/logo/safari-pinned-tab.svg color=#1e1f22><link rel="shortcut icon" href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon.ico><meta name=msapplication-TileColor content=#1e1f22><meta name=msapplication-config content=https://vectorbt.pro/pvt_41531c19/assets/logo/browserconfig.xml><meta name=theme-color content=#1e1f22><link href=https://unpkg.com/aos@2.3.4/dist/aos.css rel=stylesheet><script src=https://unpkg.com/aos@2.3.4/dist/aos.js></script><link href=http://fonts.cdnfonts.com/css/uni-neue rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/js/all.min.js integrity="sha512-8pHNiqTlsrRjVD4A/3va++W1sMbUHwWxxRPWNyVlql3T+Hgfd81Qc6FC5WMXDC+tSauxxzp1tgiAvSKFu1qIlA==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js integrity="sha512-q583ppKrCRc7N5O0n2nzUiJ+suUv7Et1JGels4bXOaMFQcamPk9HjdUknZuuFjBNs7tsMuadge5k9RzdmO+1GQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><link rel=preconnect href=https://fonts.googleapis.com/><link rel=preconnect href=https://fonts.gstatic.com/ crossorigin></head> <body dir=ltr data-md-color-scheme=custom-dark data-md-color-primary=custom-dark data-md-color-accent=custom-dark> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#dynamic class=md-skip> Skip to content </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> <button class="md-banner__button md-icon" aria-label="Don't show this again"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> <i>What's new</i>: New LLM providers, reasoning steps, function calling, YAML & TOML support, and <a href=https://vectorbt.pro/pvt_41531c19/getting-started/release-notes><strong>more</strong></a> <span class="twemoji announce-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m153.6 29.9 16-21.3c4-5.4 10.4-8.6 17.1-8.6C198.4 0 208 9.6 208 21.3v22.1c0 13.1 5.4 25.7 14.9 34.7l84.7 80.9c48.8 46.6 76.4 111.2 76.4 178.7C384 434 306 512 209.7 512H192C86 512 0 426 0 320v-3.8c0-48.8 19.4-95.6 53.9-130.1l3.5-3.5c4.2-4.2 10-6.6 16-6.6 12.5 0 22.6 10.1 22.6 22.6V288c0 35.3 28.7 64 64 64s64-28.7 64-64v-3.9c0-18-7.2-35.3-19.9-48l-38.6-38.6c-24-24-37.5-56.7-37.5-90.7 0-27.7 9-54.8 25.6-76.9"/></svg></span> </div> <script>var el=document.querySelector("[data-md-component=announce]");if(el){var content=el.querySelector(".md-typeset");__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0)}</script> </aside> </div> <!-- Determine class according to configuration --> <!-- Header --> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=header.title> <!-- Link to home --> <a href=https://vectorbt.pro/pvt_41531c19/ title="VectorBT® PRO" class="md-header__button md-logo" aria-label="VectorBT® PRO" data-md-component=logo> <img src=https://vectorbt.pro/pvt_41531c19/assets/logo/logo.svg alt=logo class=logo> </a> <!-- Button to open drawer --> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <!-- Header title --> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> VectorBT® PRO <span class=md-version> v2025.10.15 </span> <span class=unlock-icon><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M192 32c-35.3 0-64 28.7-64 64v64h192c35.3 0 64 28.7 64 64v224c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V224c0-35.3 28.7-64 64-64V96c0-70.7 57.3-128 128-128 63.5 0 116.1 46.1 126.2 106.7 2.9 17.4-8.8 33.9-26.3 36.9S258 102.8 255 85.3C250 55.1 223.7 32 192 32m40 328c13.3 0 24-10.7 24-24s-10.7-24-24-24h-80c-13.3 0-24 10.7-24 24s10.7 24 24 24z"/></svg></span> </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Dynamic </span> </div> </div> </div> <!-- Color palette --> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=custom-dark data-md-color-primary=custom-dark data-md-color-accent=custom-dark aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=custom-light data-md-color-primary=custom-light data-md-color-accent=custom-light aria-label="Switch to dark mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <!-- Site language selector --> <!-- Button to open search modal --> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <!-- Search interface --> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <!-- Repository information --> <div class=md-header__source> <a href=https://github.com/polakowo/vectorbt.pro title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> vectorbt.pro </div> </a> </div> </nav> <!-- Navigation tabs (sticky) --> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/ class=md-tabs__link> Getting started </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/features/overview/ class=md-tabs__link> Features </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/overview/ class=md-tabs__link> Tutorials </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/documentation/overview/ class=md-tabs__link> Documentation </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/overview/ class=md-tabs__link> Cookbook </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/api/ class=md-tabs__link> API </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/terms/terms-of-use/ class=md-tabs__link> Terms </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://vectorbt.pro/pvt_41531c19/ title="VectorBT® PRO" class="md-nav__button md-logo" aria-label="VectorBT® PRO" data-md-component=logo> <img src=https://vectorbt.pro/pvt_41531c19/assets/logo/logo.svg alt=logo class=logo> </a> VectorBT® PRO </label> <div class=md-nav__source> <a href=https://github.com/polakowo/vectorbt.pro title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> vectorbt.pro </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/ class=md-nav__link> <span class=md-ellipsis> Getting started </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/features/overview/ class=md-nav__link> <span class=md-ellipsis> Features </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Tutorials </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Tutorials </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/overview/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/basic-rsi/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m3.5 18.5 6-6 4 4L22 6.92 20.59 5.5l-7.09 8-4-4L2 17z"/></svg> <span class=md-ellipsis> Basic RSI strategy </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/superfast-supertrend/ class=md-nav__link> <span class=md-ellipsis> SuperFast SuperTrend </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/signal-development/generation/ class=md-nav__link> <span class=md-ellipsis> Signal development </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/stop-signals/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 23h-2V1h2zm-4-4H5V5h4V3H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h4zM19 7v2h2V7zm0-2h2a2 2 0 0 0-2-2zm2 10h-2v2h2zm-2-4v2h2v-2zm-2-8h-2v2h2zm2 18c1.11 0 2-.89 2-2h-2zm-2-2h-2v2h2z"/></svg> <span class=md-ellipsis> Stop signals </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/mtf-analysis/ class=md-nav__link> <span class=md-ellipsis> MTF analysis </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_7 checked> <label class=md-nav__link for=__nav_3_7 id=__nav_3_7_label tabindex=0> <span class=md-ellipsis> Portfolio optimization </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_7_label aria-expanded=true> <label class=md-nav__title for=__nav_3_7> <span class="md-nav__icon md-icon"></span> Portfolio optimization </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/portfolio-optimization/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22 21H2V3h2v16h2v-2h4v2h2v-3h4v3h2v-2h4zm-4-7h4v2h-4zm-6-8h4v3h-4zm4 9h-4v-5h4zM6 10h4v2H6zm4 6H6v-3h4z"/></svg> <span class=md-ellipsis> Portfolio optimization </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/portfolio-optimization/integrations/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22 21H2V3h2v16h2v-2h4v2h2v-3h4v3h2v-2h4zm-4-7h4v2h-4zm-6-8h4v3h-4zm4 9h-4v-5h4zM6 10h4v2H6zm4 6H6v-3h4z"/></svg> <span class=md-ellipsis> Integrations </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22 21H2V3h2v16h2v-2h4v2h2v-3h4v3h2v-2h4zm-4-7h4v2h-4zm-6-8h4v3h-4zm4 9h-4v-5h4zM6 10h4v2H6zm4 6H6v-3h4z"/></svg> <span class=md-ellipsis> Dynamic </span> <span class="md-nav__icon md-icon"></span> </label> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/portfolio-optimization/dynamic/ class="md-nav__link md-nav__link--active"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22 21H2V3h2v16h2v-2h4v2h2v-3h4v3h2v-2h4zm-4-7h4v2h-4zm-6-8h4v3h-4zm4 9h-4v-5h4zM6 10h4v2H6zm4 6H6v-3h4z"/></svg> <span class=md-ellipsis> Dynamic </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#post-analysis class=md-nav__link> <span class=md-ellipsis> Post-analysis </span> </a> </li> <li class=md-nav__item> <a href=#bonus-1-own-optimizer class=md-nav__link> <span class=md-ellipsis> Bonus 1: Own optimizer </span> </a> </li> <li class=md-nav__item> <a href=#bonus-2-parameterization class=md-nav__link> <span class=md-ellipsis> Bonus 2: Parameterization </span> </a> </li> <li class=md-nav__item> <a href=#bonus-3-hyperopt class=md-nav__link> <span class=md-ellipsis> Bonus 3: Hyperopt </span> </a> </li> <li class=md-nav__item> <a href=#bonus-4-hybrid class=md-nav__link> <span class=md-ellipsis> Bonus 4: Hybrid </span> </a> </li> <li class=md-nav__item> <a href=#summary class=md-nav__link> <span class=md-ellipsis> Summary </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/pairs-trading/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22 6.92 20.59 5.5l-2.85 3.22C15.68 6.4 12.83 5 9.61 5 6.72 5 4.07 6.16 2 8l1.42 1.42C5.12 7.93 7.27 7 9.61 7c2.74 0 5.09 1.26 6.77 3.24L13.5 13.5l-4-4L2 17l1.5 1.5 6-6 4 4 4.05-4.57c.75 1.35 1.25 2.9 1.45 4.57h2c-.22-2.32-.95-4.41-2.04-6.16z"/></svg> <span class=md-ellipsis> Pairs trading </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/patterns-and-projections/patterns/ class=md-nav__link> <span class=md-ellipsis> Patterns and projections </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/cross-validation/ class=md-nav__link> <span class=md-ellipsis> Cross-validation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/more-tutorials/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10.6 13.4a1 1 0 0 1-1.4 1.4 4.8 4.8 0 0 1 0-7l3.5-3.6a5.1 5.1 0 0 1 7.1 0 5.1 5.1 0 0 1 0 7.1l-1.5 1.5a6.4 6.4 0 0 0-.4-2.4l.5-.5a3.2 3.2 0 0 0 0-4.3 3.2 3.2 0 0 0-4.3 0l-3.5 3.6a2.9 2.9 0 0 0 0 4.2M23 18v2h-3v3h-2v-3h-3v-2h3v-3h2v3m-3.8-4.3a4.8 4.8 0 0 0-1.4-4.5 1 1 0 0 0-1.4 1.4 2.9 2.9 0 0 1 0 4.2l-3.5 3.6a3.2 3.2 0 0 1-4.3 0 3.2 3.2 0 0 1 0-4.3l.5-.4a7.3 7.3 0 0 1-.4-2.5l-1.5 1.5a5.1 5.1 0 0 0 0 7.1 5.1 5.1 0 0 0 7.1 0l1.8-1.8a6 6 0 0 1 3.1-4.3"/></svg> <span class=md-ellipsis> More tutorials </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/to-be-continued/ class=md-nav__link> <span class=md-ellipsis> To be continued... </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/documentation/overview/ class=md-nav__link> <span class=md-ellipsis> Documentation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/overview/ class=md-nav__link> <span class=md-ellipsis> Cookbook </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/api/ class=md-nav__link> <span class=md-ellipsis> API </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/terms/terms-of-use/ class=md-nav__link> <span class=md-ellipsis> Terms </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <nav class=md-path aria-label=Navigation> <ol class=md-path__list> <li class=md-path__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/overview/ class=md-path__link> <span class=md-ellipsis> Tutorials </span> </a> </li> <li class=md-path__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/portfolio-optimization/ class=md-path__link> <span class=md-ellipsis> Portfolio optimization </span> </a> </li> </ol> </nav> <article class="md-content__inner md-typeset"> <h1 id=dynamic><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22 21H2V3h2v16h2v-2h4v2h2v-3h4v3h2v-2h4zm-4-7h4v2h-4zm-6-8h4v3h-4zm4 9h-4v-5h4zM6 10h4v2H6zm4 6H6v-3h4z"/></svg></span> Dynamic<a class=headerlink href=#dynamic title="Permanent link">&para;</a></h1> <p>Up to this point, all allocation and optimization functions have relied strictly on external information, such as pricing data, and have not controlled actual execution. But what if you want to rebalance based on conditions within the current trading environment? For example, to perform threshold rebalancing, you need to know the current portfolio value. This creates a path-dependent problem that can only be handled with a custom order function.</p> <p>Let's backtest threshold rebalancing—a portfolio management strategy used to maintain a set of desired allocations without allowing asset weights to drift too far. We will build a template pipeline that accepts any user-defined, Numba-compiled allocation function. When one of the individual portfolio constituents moves outside its desired allocation bounds, the entire portfolio is rebalanced to realign with the target allocations.</p> <p>Here is a general template:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>GroupMemory</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s2>&quot;GroupMemory&quot;</span><span class=p>,</span> <span class=p>[</span>  <span class=c1># (1)!</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>... </span>    <span class=s2>&quot;target_alloc&quot;</span><span class=p>,</span> 
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=s2>&quot;size_type&quot;</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=s2>&quot;direction&quot;</span><span class=p>,</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=s2>&quot;order_value_out&quot;</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=p>])</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>pre_group_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>  <span class=c1># (2)!</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=gp>... </span>    <span class=n>group_memory</span> <span class=o>=</span> <span class=n>GroupMemory</span><span class=p>(</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=gp>... </span>        <span class=n>target_alloc</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>group_len</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>),</span>  <span class=c1># (3)!</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=gp>... </span>        <span class=n>size_type</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>group_len</span><span class=p>,</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>SizeType</span><span class=o>.</span><span class=n>TargetPercent</span><span class=p>),</span>  <span class=c1># (4)!</span>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=gp>... </span>        <span class=n>direction</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>group_len</span><span class=p>,</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>Direction</span><span class=o>.</span><span class=n>Both</span><span class=p>),</span>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a><span class=gp>... </span>        <span class=n>order_value_out</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>group_len</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>  <span class=c1># (5)!</span>
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>group_memory</span><span class=p>,</span>
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a>
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-0-19><a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>pre_segment_func_nb</span><span class=p>(</span>  <span class=c1># (6)!</span>
</span><span id=__span-0-20><a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a><span class=gp>... </span>    <span class=n>c</span><span class=p>,</span> 
</span><span id=__span-0-21><a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a><span class=gp>... </span>    <span class=n>group_memory</span><span class=p>,</span>  <span class=c1># (7)!</span>
</span><span id=__span-0-22><a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a><span class=gp>... </span>    <span class=n>min_history</span><span class=p>,</span>  <span class=c1># (8)!</span>
</span><span id=__span-0-23><a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a><span class=gp>... </span>    <span class=n>threshold</span><span class=p>,</span>  <span class=c1># (9)!</span>
</span><span id=__span-0-24><a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a><span class=gp>... </span>    <span class=n>allocate_func_nb</span><span class=p>,</span>  <span class=c1># (10)!</span>
</span><span id=__span-0-25><a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a><span class=gp>... </span>    <span class=o>*</span><span class=n>args</span>
</span><span id=__span-0-26><a id=__codelineno-0-26 name=__codelineno-0-26 href=#__codelineno-0-26></a><span class=gp>... </span><span class=p>):</span>
</span><span id=__span-0-27><a id=__codelineno-0-27 name=__codelineno-0-27 href=#__codelineno-0-27></a><span class=gp>... </span>    <span class=n>should_rebalance</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-0-28><a id=__codelineno-0-28 name=__codelineno-0-28 href=#__codelineno-0-28></a><span class=gp>... </span>    
</span><span id=__span-0-29><a id=__codelineno-0-29 name=__codelineno-0-29 href=#__codelineno-0-29></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span> <span class=o>&gt;=</span> <span class=n>min_history</span><span class=p>:</span>
</span><span id=__span-0-30><a id=__codelineno-0-30 name=__codelineno-0-30 href=#__codelineno-0-30></a><span class=gp>... </span>        <span class=n>in_position</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-0-31><a id=__codelineno-0-31 name=__codelineno-0-31 href=#__codelineno-0-31></a><span class=gp>... </span>        <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>from_col</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>to_col</span><span class=p>):</span>
</span><span id=__span-0-32><a id=__codelineno-0-32 name=__codelineno-0-32 href=#__codelineno-0-32></a><span class=gp>... </span>            <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>last_position</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-0-33><a id=__codelineno-0-33 name=__codelineno-0-33 href=#__codelineno-0-33></a><span class=gp>... </span>                <span class=n>in_position</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-0-34><a id=__codelineno-0-34 name=__codelineno-0-34 href=#__codelineno-0-34></a><span class=gp>... </span>                <span class=k>break</span>
</span><span id=__span-0-35><a id=__codelineno-0-35 name=__codelineno-0-35 href=#__codelineno-0-35></a><span class=gp>... </span>                
</span><span id=__span-0-36><a id=__codelineno-0-36 name=__codelineno-0-36 href=#__codelineno-0-36></a><span class=gp>... </span>        <span class=k>if</span> <span class=ow>not</span> <span class=n>in_position</span><span class=p>:</span>
</span><span id=__span-0-37><a id=__codelineno-0-37 name=__codelineno-0-37 href=#__codelineno-0-37></a><span class=gp>... </span>            <span class=n>should_rebalance</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-0-38><a id=__codelineno-0-38 name=__codelineno-0-38 href=#__codelineno-0-38></a><span class=gp>... </span>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-39><a id=__codelineno-0-39 name=__codelineno-0-39 href=#__codelineno-0-39></a><span class=gp>... </span>            <span class=n>curr_value</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_value</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>]</span>
</span><span id=__span-0-40><a id=__codelineno-0-40 name=__codelineno-0-40 href=#__codelineno-0-40></a><span class=gp>... </span>            <span class=k>for</span> <span class=n>group_col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>group_len</span><span class=p>):</span>
</span><span id=__span-0-41><a id=__codelineno-0-41 name=__codelineno-0-41 href=#__codelineno-0-41></a><span class=gp>... </span>                <span class=n>col</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>from_col</span> <span class=o>+</span> <span class=n>group_col</span>
</span><span id=__span-0-42><a id=__codelineno-0-42 name=__codelineno-0-42 href=#__codelineno-0-42></a><span class=gp>... </span>                <span class=n>curr_position</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_position</span><span class=p>[</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-0-43><a id=__codelineno-0-43 name=__codelineno-0-43 href=#__codelineno-0-43></a><span class=gp>... </span>                <span class=n>curr_price</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>last_val_price</span><span class=p>[</span><span class=n>col</span><span class=p>]</span>
</span><span id=__span-0-44><a id=__codelineno-0-44 name=__codelineno-0-44 href=#__codelineno-0-44></a><span class=gp>... </span>                <span class=n>curr_alloc</span> <span class=o>=</span> <span class=n>curr_position</span> <span class=o>*</span> <span class=n>curr_price</span> <span class=o>/</span> <span class=n>curr_value</span>
</span><span id=__span-0-45><a id=__codelineno-0-45 name=__codelineno-0-45 href=#__codelineno-0-45></a><span class=gp>... </span>                <span class=n>curr_threshold</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_from_col_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>col</span><span class=p>,</span> <span class=n>threshold</span><span class=p>)</span>  <span class=c1># (11)!</span>
</span><span id=__span-0-46><a id=__codelineno-0-46 name=__codelineno-0-46 href=#__codelineno-0-46></a><span class=gp>... </span>                <span class=n>alloc_diff</span> <span class=o>=</span> <span class=n>curr_alloc</span> <span class=o>-</span> <span class=n>group_memory</span><span class=o>.</span><span class=n>target_alloc</span><span class=p>[</span><span class=n>group_col</span><span class=p>]</span>
</span><span id=__span-0-47><a id=__codelineno-0-47 name=__codelineno-0-47 href=#__codelineno-0-47></a><span class=gp>... </span>                
</span><span id=__span-0-48><a id=__codelineno-0-48 name=__codelineno-0-48 href=#__codelineno-0-48></a><span class=gp>... </span>                <span class=k>if</span> <span class=nb>abs</span><span class=p>(</span><span class=n>alloc_diff</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>curr_threshold</span><span class=p>:</span>
</span><span id=__span-0-49><a id=__codelineno-0-49 name=__codelineno-0-49 href=#__codelineno-0-49></a><span class=gp>... </span>                    <span class=n>should_rebalance</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-0-50><a id=__codelineno-0-50 name=__codelineno-0-50 href=#__codelineno-0-50></a><span class=gp>... </span>                    <span class=k>break</span>
</span><span id=__span-0-51><a id=__codelineno-0-51 name=__codelineno-0-51 href=#__codelineno-0-51></a><span class=gp>... </span>                    
</span><span id=__span-0-52><a id=__codelineno-0-52 name=__codelineno-0-52 href=#__codelineno-0-52></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>should_rebalance</span><span class=p>:</span>
</span><span id=__span-0-53><a id=__codelineno-0-53 name=__codelineno-0-53 href=#__codelineno-0-53></a><span class=gp>... </span>        <span class=n>allocate_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>group_memory</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>)</span>  <span class=c1># (12)!</span>
</span><span id=__span-0-54><a id=__codelineno-0-54 name=__codelineno-0-54 href=#__codelineno-0-54></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>sort_call_seq_1d_nb</span><span class=p>(</span>  <span class=c1># (13)!</span>
</span><span id=__span-0-55><a id=__codelineno-0-55 name=__codelineno-0-55 href=#__codelineno-0-55></a><span class=gp>... </span>            <span class=n>c</span><span class=p>,</span> 
</span><span id=__span-0-56><a id=__codelineno-0-56 name=__codelineno-0-56 href=#__codelineno-0-56></a><span class=gp>... </span>            <span class=n>group_memory</span><span class=o>.</span><span class=n>target_alloc</span><span class=p>,</span> 
</span><span id=__span-0-57><a id=__codelineno-0-57 name=__codelineno-0-57 href=#__codelineno-0-57></a><span class=gp>... </span>            <span class=n>group_memory</span><span class=o>.</span><span class=n>size_type</span><span class=p>,</span> 
</span><span id=__span-0-58><a id=__codelineno-0-58 name=__codelineno-0-58 href=#__codelineno-0-58></a><span class=gp>... </span>            <span class=n>group_memory</span><span class=o>.</span><span class=n>direction</span><span class=p>,</span> 
</span><span id=__span-0-59><a id=__codelineno-0-59 name=__codelineno-0-59 href=#__codelineno-0-59></a><span class=gp>... </span>            <span class=n>group_memory</span><span class=o>.</span><span class=n>order_value_out</span>
</span><span id=__span-0-60><a id=__codelineno-0-60 name=__codelineno-0-60 href=#__codelineno-0-60></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-0-61><a id=__codelineno-0-61 name=__codelineno-0-61 href=#__codelineno-0-61></a><span class=gp>... </span>        
</span><span id=__span-0-62><a id=__codelineno-0-62 name=__codelineno-0-62 href=#__codelineno-0-62></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>group_memory</span><span class=p>,</span> <span class=n>should_rebalance</span>
</span><span id=__span-0-63><a id=__codelineno-0-63 name=__codelineno-0-63 href=#__codelineno-0-63></a>
</span><span id=__span-0-64><a id=__codelineno-0-64 name=__codelineno-0-64 href=#__codelineno-0-64></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-0-65><a id=__codelineno-0-65 name=__codelineno-0-65 href=#__codelineno-0-65></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>order_func_nb</span><span class=p>(</span>  <span class=c1># (14)!</span>
</span><span id=__span-0-66><a id=__codelineno-0-66 name=__codelineno-0-66 href=#__codelineno-0-66></a><span class=gp>... </span>    <span class=n>c</span><span class=p>,</span> 
</span><span id=__span-0-67><a id=__codelineno-0-67 name=__codelineno-0-67 href=#__codelineno-0-67></a><span class=gp>... </span>    <span class=n>group_memory</span><span class=p>,</span>  <span class=c1># (15)! </span>
</span><span id=__span-0-68><a id=__codelineno-0-68 name=__codelineno-0-68 href=#__codelineno-0-68></a><span class=gp>... </span>    <span class=n>should_rebalance</span><span class=p>,</span> 
</span><span id=__span-0-69><a id=__codelineno-0-69 name=__codelineno-0-69 href=#__codelineno-0-69></a><span class=gp>... </span>    <span class=n>price</span><span class=p>,</span>
</span><span id=__span-0-70><a id=__codelineno-0-70 name=__codelineno-0-70 href=#__codelineno-0-70></a><span class=gp>... </span>    <span class=n>fees</span>
</span><span id=__span-0-71><a id=__codelineno-0-71 name=__codelineno-0-71 href=#__codelineno-0-71></a><span class=gp>... </span><span class=p>):</span>
</span><span id=__span-0-72><a id=__codelineno-0-72 name=__codelineno-0-72 href=#__codelineno-0-72></a><span class=gp>... </span>    <span class=k>if</span> <span class=ow>not</span> <span class=n>should_rebalance</span><span class=p>:</span>
</span><span id=__span-0-73><a id=__codelineno-0-73 name=__codelineno-0-73 href=#__codelineno-0-73></a><span class=gp>... </span>        <span class=k>return</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nothing_nb</span><span class=p>()</span>
</span><span id=__span-0-74><a id=__codelineno-0-74 name=__codelineno-0-74 href=#__codelineno-0-74></a><span class=gp>... </span>    
</span><span id=__span-0-75><a id=__codelineno-0-75 name=__codelineno-0-75 href=#__codelineno-0-75></a><span class=gp>... </span>    <span class=n>group_col</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>col</span> <span class=o>-</span> <span class=n>c</span><span class=o>.</span><span class=n>from_col</span>  <span class=c1># (16)!</span>
</span><span id=__span-0-76><a id=__codelineno-0-76 name=__codelineno-0-76 href=#__codelineno-0-76></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nb</span><span class=p>(</span>
</span><span id=__span-0-77><a id=__codelineno-0-77 name=__codelineno-0-77 href=#__codelineno-0-77></a><span class=gp>... </span>        <span class=n>size</span><span class=o>=</span><span class=n>group_memory</span><span class=o>.</span><span class=n>target_alloc</span><span class=p>[</span><span class=n>group_col</span><span class=p>],</span> 
</span><span id=__span-0-78><a id=__codelineno-0-78 name=__codelineno-0-78 href=#__codelineno-0-78></a><span class=gp>... </span>        <span class=n>price</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>price</span><span class=p>),</span>
</span><span id=__span-0-79><a id=__codelineno-0-79 name=__codelineno-0-79 href=#__codelineno-0-79></a><span class=gp>... </span>        <span class=n>size_type</span><span class=o>=</span><span class=n>group_memory</span><span class=o>.</span><span class=n>size_type</span><span class=p>[</span><span class=n>group_col</span><span class=p>],</span>
</span><span id=__span-0-80><a id=__codelineno-0-80 name=__codelineno-0-80 href=#__codelineno-0-80></a><span class=gp>... </span>        <span class=n>direction</span><span class=o>=</span><span class=n>group_memory</span><span class=o>.</span><span class=n>direction</span><span class=p>[</span><span class=n>group_col</span><span class=p>],</span>
</span><span id=__span-0-81><a id=__codelineno-0-81 name=__codelineno-0-81 href=#__codelineno-0-81></a><span class=gp>... </span>        <span class=n>fees</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>select_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>fees</span><span class=p>)</span>
</span><span id=__span-0-82><a id=__codelineno-0-82 name=__codelineno-0-82 href=#__codelineno-0-82></a><span class=gp>... </span>    <span class=p>)</span>
</span></code></pre></div> <ol> <li>Create a named tuple to store variables shared between contexts within each portfolio group.</li> <li>Initialize arrays in each portfolio group.</li> <li>Array for the target allocation per asset. This array is updated at each rebalancing step.</li> <li>Arrays for size type and direction per asset. These default to target percentage and both directions, but you can modify them within <code>allocate_func_nb</code>.</li> <li>Temporary array needed for sorting by order value.</li> <li>Rebalancing takes place in a pre-segment function. Remember, a segment is a group of assets at a specific timestamp, and in this function we decide whether to rebalance the entire group.</li> <li>Arguments returned by <code>pre_group_func_nb</code> are passed right after the context.</li> <li>Indicates when to place the first allocation.</li> <li>Threshold array, which can be a constant, or provided by timestamp, asset, or element.</li> <li>Allocation function that should accept the context, the group memory, and <code>*args</code>.</li> <li>Use this function since segment contexts do not have column information.</li> <li>The allocation function should update arrays in the group context and return nothing (<code>None</code>).</li> <li>Sort the current call sequence by order value to execute sell orders before buy orders (to release funds early). Use <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_order_func/#vectorbtpro.portfolio.nb.from_order_func.sort_call_seq_nb>sort_call_seq_nb</a> and <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/nb/from_order_func/#vectorbtpro.portfolio.nb.from_order_func.sort_call_seq_1d_nb>sort_call_seq_1d_nb</a> when passing two-dimensional and one-dimensional arrays, respectively.</li> <li>For each asset in the current group (sorted by order value), VBT will call this order function.</li> <li>Again, arguments returned by <code>pre_segment_func_nb</code> are passed right after the context.</li> <li>Index of the current column within the current group.</li> </ol> <p>Now, let's create an allocation function for an equally-weighted portfolio:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>uniform_allocate_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>group_memory</span><span class=p>):</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>group_col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>group_len</span><span class=p>):</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=gp>... </span>        <span class=n>group_memory</span><span class=o>.</span><span class=n>target_alloc</span><span class=p>[</span><span class=n>group_col</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>c</span><span class=o>.</span><span class=n>group_len</span>  <span class=c1># (1)!</span>
</span></code></pre></div> <ol> <li>Modify the target allocation array in place.</li> </ol> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>Sometimes, you may want to rebalance dynamically using a function that relies on a third-party library, such as SciPy or scikit-learn, which cannot be compiled with Numba. In these cases, you can disable jitting of the main simulator function by passing <code>jitted=False</code>.</p> </div> <p>Now it's time to run the simulation!</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>simulate_threshold_rebalancing</span><span class=p>(</span><span class=n>threshold</span><span class=p>,</span> <span class=n>allocate_func_nb</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_order_func</span><span class=p>(</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=gp>... </span>        <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>),</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=gp>... </span>        <span class=nb>open</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Open&quot;</span><span class=p>),</span>  <span class=c1># (1)!</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=gp>... </span>        <span class=n>pre_group_func_nb</span><span class=o>=</span><span class=n>pre_group_func_nb</span><span class=p>,</span> 
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=gp>... </span>        <span class=n>pre_group_args</span><span class=o>=</span><span class=p>(),</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=gp>... </span>        <span class=n>pre_segment_func_nb</span><span class=o>=</span><span class=n>pre_segment_func_nb</span><span class=p>,</span> 
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=gp>... </span>        <span class=n>pre_segment_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=gp>... </span>            <span class=mi>0</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=gp>... </span>            <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;threshold&quot;</span><span class=p>),</span>  <span class=c1># (3)!</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=gp>... </span>            <span class=n>allocate_func_nb</span><span class=p>,</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=gp>... </span>            <span class=o>*</span><span class=n>args</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=gp>... </span>        <span class=p>),</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=gp>... </span>        <span class=n>order_func_nb</span><span class=o>=</span><span class=n>order_func_nb</span><span class=p>,</span> 
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=gp>... </span>        <span class=n>order_args</span><span class=o>=</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s1>&#39;price&#39;</span><span class=p>),</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s1>&#39;fees&#39;</span><span class=p>)),</span>  <span class=c1># (4)!</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=gp>... </span>        <span class=n>broadcast_named_args</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=gp>... </span>            <span class=n>price</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>),</span>
</span><span id=__span-2-18><a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a><span class=gp>... </span>            <span class=n>fees</span><span class=o>=</span><span class=mf>0.005</span><span class=p>,</span>
</span><span id=__span-2-19><a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a><span class=gp>... </span>            <span class=n>threshold</span><span class=o>=</span><span class=n>threshold</span>
</span><span id=__span-2-20><a id=__codelineno-2-20 name=__codelineno-2-20 href=#__codelineno-2-20></a><span class=gp>... </span>        <span class=p>),</span>
</span><span id=__span-2-21><a id=__codelineno-2-21 name=__codelineno-2-21 href=#__codelineno-2-21></a><span class=gp>... </span>        <span class=n>cash_sharing</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-2-22><a id=__codelineno-2-22 name=__codelineno-2-22 href=#__codelineno-2-22></a><span class=gp>... </span>        <span class=n>group_by</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>ExceptLevel</span><span class=p>(</span><span class=s2>&quot;symbol&quot;</span><span class=p>),</span>  <span class=c1># (5)!</span>
</span><span id=__span-2-23><a id=__codelineno-2-23 name=__codelineno-2-23 href=#__codelineno-2-23></a><span class=gp>... </span>        <span class=n>freq</span><span class=o>=</span><span class=s1>&#39;1h&#39;</span><span class=p>,</span> 
</span><span id=__span-2-24><a id=__codelineno-2-24 name=__codelineno-2-24 href=#__codelineno-2-24></a><span class=gp>... </span>        <span class=o>**</span><span class=n>kwargs</span>
</span><span id=__span-2-25><a id=__codelineno-2-25 name=__codelineno-2-25 href=#__codelineno-2-25></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-2-26><a id=__codelineno-2-26 name=__codelineno-2-26 href=#__codelineno-2-26></a>
</span><span id=__span-2-27><a id=__codelineno-2-27 name=__codelineno-2-27 href=#__codelineno-2-27></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>simulate_threshold_rebalancing</span><span class=p>(</span><span class=mf>0.05</span><span class=p>,</span> <span class=n>uniform_allocate_func_nb</span><span class=p>)</span>
</span><span id=__span-2-28><a id=__codelineno-2-28 name=__codelineno-2-28 href=#__codelineno-2-28></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>plot_allocations</span><span class=p>()</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <ol> <li>Provide <code>open</code> to ensure a non-NA valuation price in <code>pre_segment_func_nb</code> at the first timestamp.</li> <li>Place an allocation at the first timestamp.</li> <li>Threshold is an array-like object broadcast per timestamp and column, so include price along with <code>close</code>.</li> <li>Use templates to broadcast price along with <code>close</code>. Be sure to include such arguments in <code>broadcast_named_args</code>.</li> <li>Group by everything except assets so each group contains only assets.</li> </ol> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/dynamic.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/dynamic.dark.svg#only-dark></p> <p>We see that threshold rebalancing causes asset allocations to repeatedly jump to their target levels.</p> <div class="admonition info"> <p class=admonition-title>Info</p> <p>If your kernel dies or you want to validate your pipeline with Numba, it is recommended to either enable bounds checks or disable Numba entirely, then run your pipeline on sample data. This will help you catch any hidden indexing bugs.</p> <p>To do this, run the following in the first cell before anything else:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=gp>&gt;&gt;&gt; </span><span class=kn>import</span><span class=w> </span><span class=nn>os</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&quot;NUMBA_BOUNDSCHECK&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;1&quot;</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&quot;NUMBA_DISABLE_JIT&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;1&quot;</span>
</span></code></pre></div> </div> <p>We can also test multiple thresholds by simply making it an index:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>simulate_threshold_rebalancing</span><span class=p>(</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span> <span class=o>/</span> <span class=mi>100</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;threshold&quot;</span><span class=p>),</span>  <span class=c1># (1)!</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=gp>... </span>    <span class=n>uniform_allocate_func_nb</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>sharpe_ratio</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=go>threshold</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=go>0.01    1.939551</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=go>0.02    1.964451</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=go>0.03    1.985215</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a><span class=go>0.04    1.984484</span>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a><span class=go>0.05    1.993381</span>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a><span class=go>0.06    2.019594</span>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a><span class=go>0.07    1.983087</span>
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=go>0.08    2.047598</span>
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a><span class=go>0.09    2.087186</span>
</span><span id=__span-4-17><a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a><span class=go>0.10    1.939077</span>
</span><span id=__span-4-18><a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a><span class=go>0.11    1.962485</span>
</span><span id=__span-4-19><a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a><span class=go>0.12    1.978320</span>
</span><span id=__span-4-20><a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a><span class=go>0.13    1.963077</span>
</span><span id=__span-4-21><a id=__codelineno-4-21 name=__codelineno-4-21 href=#__codelineno-4-21></a><span class=go>0.14    1.969721</span>
</span><span id=__span-4-22><a id=__codelineno-4-22 name=__codelineno-4-22 href=#__codelineno-4-22></a><span class=go>0.15    1.983179</span>
</span><span id=__span-4-23><a id=__codelineno-4-23 name=__codelineno-4-23 href=#__codelineno-4-23></a><span class=go>Name: sharpe_ratio, dtype: float64</span>
</span></code></pre></div> <ol> <li>If you used <code>np.arange(0.01, 0.16, 0.01)</code>, you would not be able to select those values from columns since, for example, <code>0.6</code> would become <code>0.060000000000000005</code>.</li> </ol> <h2 id=post-analysis>Post-analysis<a class=headerlink href=#post-analysis title="Permanent link">&para;</a></h2> <p>But can we retrieve the rebalancing timestamps? Absolutely!</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>track_uniform_allocate_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>group_memory</span><span class=p>,</span> <span class=n>index_points</span><span class=p>,</span> <span class=n>alloc_counter</span><span class=p>):</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>group_col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>group_len</span><span class=p>):</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=gp>... </span>        <span class=n>group_memory</span><span class=o>.</span><span class=n>target_alloc</span><span class=p>[</span><span class=n>group_col</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>c</span><span class=o>.</span><span class=n>group_len</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=gp>...</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=gp>... </span>    <span class=n>index_points</span><span class=p>[</span><span class=n>alloc_counter</span><span class=p>[</span><span class=mi>0</span><span class=p>]]</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=gp>... </span>    <span class=n>alloc_counter</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>index_points</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>int_</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>alloc_counter</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>simulate_threshold_rebalancing</span><span class=p>(</span>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a><span class=gp>... </span>    <span class=mf>0.05</span><span class=p>,</span>
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a><span class=gp>... </span>    <span class=n>track_uniform_allocate_func_nb</span><span class=p>,</span> 
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a><span class=gp>... </span>    <span class=n>index_points</span><span class=p>,</span> 
</span><span id=__span-5-15><a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a><span class=gp>... </span>    <span class=n>alloc_counter</span>
</span><span id=__span-5-16><a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-5-17><a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a><span class=gp>&gt;&gt;&gt; </span><span class=n>index_points</span> <span class=o>=</span> <span class=n>index_points</span><span class=p>[:</span><span class=n>alloc_counter</span><span class=p>[</span><span class=mi>0</span><span class=p>]]</span>  <span class=c1># (3)!</span>
</span><span id=__span-5-18><a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a>
</span><span id=__span-5-19><a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>index_points</span><span class=p>]</span>
</span><span id=__span-5-20><a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a><span class=go>DatetimeIndex([&#39;2020-01-01 00:00:00+00:00&#39;, &#39;2020-02-02 04:00:00+00:00&#39;,</span>
</span><span id=__span-5-21><a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a><span class=go>               &#39;2020-03-07 15:00:00+00:00&#39;, &#39;2020-05-28 18:00:00+00:00&#39;,</span>
</span><span id=__span-5-22><a id=__codelineno-5-22 name=__codelineno-5-22 href=#__codelineno-5-22></a><span class=go>               &#39;2020-06-03 16:00:00+00:00&#39;, &#39;2020-07-07 13:00:00+00:00&#39;,</span>
</span><span id=__span-5-23><a id=__codelineno-5-23 name=__codelineno-5-23 href=#__codelineno-5-23></a><span class=go>               &#39;2020-08-14 17:00:00+00:00&#39;, &#39;2020-09-09 01:00:00+00:00&#39;,</span>
</span><span id=__span-5-24><a id=__codelineno-5-24 name=__codelineno-5-24 href=#__codelineno-5-24></a><span class=go>               &#39;2020-11-05 13:00:00+00:00&#39;, &#39;2020-11-21 14:00:00+00:00&#39;,</span>
</span><span id=__span-5-25><a id=__codelineno-5-25 name=__codelineno-5-25 href=#__codelineno-5-25></a><span class=go>               &#39;2020-11-24 00:00:00+00:00&#39;, &#39;2020-12-22 17:00:00+00:00&#39;,</span>
</span><span id=__span-5-26><a id=__codelineno-5-26 name=__codelineno-5-26 href=#__codelineno-5-26></a><span class=go>               &#39;2020-12-23 11:00:00+00:00&#39;, &#39;2020-12-28 23:00:00+00:00&#39;,</span>
</span><span id=__span-5-27><a id=__codelineno-5-27 name=__codelineno-5-27 href=#__codelineno-5-27></a><span class=go>               &#39;2020-12-29 16:00:00+00:00&#39;],</span>
</span><span id=__span-5-28><a id=__codelineno-5-28 name=__codelineno-5-28 href=#__codelineno-5-28></a><span class=go>              dtype=&#39;datetime64[ns, UTC]&#39;, name=&#39;Open time&#39;, freq=None)</span>
</span></code></pre></div> <ol> <li>Since we do not know the number of index points in advance, we should initialize an array with the same size as the number of timestamps.</li> <li>Allocation counter is an array with one element set to <code>0</code>. Why use an array instead of a constant? Because we need to keep a reference to it.</li> <li>After the simulation, part of the index point array has been filled, while the rest remains uninitialized (it contains garbage). Use the counter to select only the filled entries.</li> </ol> <p>What if we want to post-analyze both index points and target allocations? And how should we handle situations with multiple parameter combinations?</p> <p>Allocations can be saved to an array just like index points. However, when there are multiple groups, we have two options: we can either run the whole pipeline in a loop (remember, VBT even encourages this since you can use chunking), or you can concatenate index points and target allocations from all groups into a single array and track the group for each entry. Then, you can construct an instance of <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer>PortfolioOptimizer</a> to conveniently post-analyze all the target allocation data!</p> <p>We need to make a few adaptations, though. First, <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer>PortfolioOptimizer</a> requires index points to be of type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/records/#vectorbtpro.portfolio.pfopt.records.AllocPoints>AllocPoints</a>, which means the underlying data should be a structured array of the complex data type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.alloc_point_dt>alloc_point_dt</a>. Second, our counter will now track counts per group instead of globally. By summing it, we can still get the global count. For better illustration, we will also implement a new allocation function that generates weights randomly. Finally, if you are not afraid of complexity and want the most flexible solution possible, see the "Flexible" tab for the same pipeline with templates and in-place outputs <img alt=😏 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f60f.svg title=:smirk:></p> <div class="tabbed-set tabbed-alternate" data-tabs=1:2><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><input id=__tabbed_1_2 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1>Preset</label><label for=__tabbed_1_2>Flexible</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>random_allocate_func_nb</span><span class=p>(</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=gp>... </span>    <span class=n>c</span><span class=p>,</span> 
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=gp>... </span>    <span class=n>group_memory</span><span class=p>,</span> 
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=gp>... </span>    <span class=n>alloc_points</span><span class=p>,</span> 
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=gp>... </span>    <span class=n>alloc_weights</span><span class=p>,</span> 
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=gp>... </span>    <span class=n>alloc_counter</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=gp>... </span><span class=p>):</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=gp>... </span>    <span class=n>weights</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>group_len</span><span class=p>)</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=gp>... </span>    <span class=n>group_memory</span><span class=o>.</span><span class=n>target_alloc</span><span class=p>[:]</span> <span class=o>=</span> <span class=n>weights</span> <span class=o>/</span> <span class=n>weights</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a><span class=gp>...</span>
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a><span class=gp>... </span>    <span class=n>group_count</span> <span class=o>=</span> <span class=n>alloc_counter</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>]</span>
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a><span class=gp>... </span>    <span class=n>count</span> <span class=o>=</span> <span class=n>alloc_counter</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>  <span class=c1># (1)!</span>
</span><span id=__span-6-14><a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a><span class=gp>... </span>    <span class=n>alloc_points</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>][</span><span class=n>count</span><span class=p>]</span> <span class=o>=</span> <span class=n>group_count</span>  <span class=c1># (2)!</span>
</span><span id=__span-6-15><a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a><span class=gp>... </span>    <span class=n>alloc_points</span><span class=p>[</span><span class=s2>&quot;col&quot;</span><span class=p>][</span><span class=n>count</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>group</span>  <span class=c1># (3)!</span>
</span><span id=__span-6-16><a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a><span class=gp>... </span>    <span class=n>alloc_points</span><span class=p>[</span><span class=s2>&quot;alloc_idx&quot;</span><span class=p>][</span><span class=n>count</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span>  <span class=c1># (4)!</span>
</span><span id=__span-6-17><a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a><span class=gp>... </span>    <span class=n>alloc_weights</span><span class=p>[</span><span class=n>count</span><span class=p>]</span> <span class=o>=</span> <span class=n>group_memory</span><span class=o>.</span><span class=n>target_alloc</span>  <span class=c1># (5)!</span>
</span><span id=__span-6-18><a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a><span class=gp>... </span>    <span class=n>alloc_counter</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-6-19><a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a>
</span><span id=__span-6-20><a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a><span class=gp>&gt;&gt;&gt; </span><span class=n>thresholds</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Index</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span> <span class=o>/</span> <span class=mi>100</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;threshold&quot;</span><span class=p>)</span>
</span><span id=__span-6-21><a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a><span class=gp>&gt;&gt;&gt; </span><span class=n>max_entries</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>thresholds</span><span class=p>)</span>  <span class=c1># (6)!</span>
</span><span id=__span-6-22><a id=__codelineno-6-22 name=__codelineno-6-22 href=#__codelineno-6-22></a><span class=gp>&gt;&gt;&gt; </span><span class=n>alloc_points</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>max_entries</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>alloc_point_dt</span><span class=p>)</span>  <span class=c1># (7)!</span>
</span><span id=__span-6-23><a id=__codelineno-6-23 name=__codelineno-6-23 href=#__codelineno-6-23></a><span class=gp>&gt;&gt;&gt; </span><span class=n>alloc_weights</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>((</span><span class=n>max_entries</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>symbols</span><span class=p>)),</span> <span class=n>dtype</span><span class=o>=</span><span class=n>float_</span><span class=p>)</span>  <span class=c1># (8)!</span>
</span><span id=__span-6-24><a id=__codelineno-6-24 name=__codelineno-6-24 href=#__codelineno-6-24></a><span class=gp>&gt;&gt;&gt; </span><span class=n>alloc_counter</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>thresholds</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># (9)!</span>
</span><span id=__span-6-25><a id=__codelineno-6-25 name=__codelineno-6-25 href=#__codelineno-6-25></a>
</span><span id=__span-6-26><a id=__codelineno-6-26 name=__codelineno-6-26 href=#__codelineno-6-26></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>simulate_threshold_rebalancing</span><span class=p>(</span>
</span><span id=__span-6-27><a id=__codelineno-6-27 name=__codelineno-6-27 href=#__codelineno-6-27></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span><span class=n>thresholds</span><span class=p>),</span>
</span><span id=__span-6-28><a id=__codelineno-6-28 name=__codelineno-6-28 href=#__codelineno-6-28></a><span class=gp>... </span>    <span class=n>random_allocate_func_nb</span><span class=p>,</span> 
</span><span id=__span-6-29><a id=__codelineno-6-29 name=__codelineno-6-29 href=#__codelineno-6-29></a><span class=gp>... </span>    <span class=n>alloc_points</span><span class=p>,</span> 
</span><span id=__span-6-30><a id=__codelineno-6-30 name=__codelineno-6-30 href=#__codelineno-6-30></a><span class=gp>... </span>    <span class=n>alloc_weights</span><span class=p>,</span>
</span><span id=__span-6-31><a id=__codelineno-6-31 name=__codelineno-6-31 href=#__codelineno-6-31></a><span class=gp>... </span>    <span class=n>alloc_counter</span><span class=p>,</span>
</span><span id=__span-6-32><a id=__codelineno-6-32 name=__codelineno-6-32 href=#__codelineno-6-32></a><span class=gp>... </span>    <span class=n>seed</span><span class=o>=</span><span class=mi>42</span>  <span class=c1># (10)!</span>
</span><span id=__span-6-33><a id=__codelineno-6-33 name=__codelineno-6-33 href=#__codelineno-6-33></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-6-34><a id=__codelineno-6-34 name=__codelineno-6-34 href=#__codelineno-6-34></a><span class=gp>&gt;&gt;&gt; </span><span class=n>alloc_points</span> <span class=o>=</span> <span class=n>alloc_points</span><span class=p>[:</span><span class=n>alloc_counter</span><span class=o>.</span><span class=n>sum</span><span class=p>()]</span>  <span class=c1># (11)!</span>
</span><span id=__span-6-35><a id=__codelineno-6-35 name=__codelineno-6-35 href=#__codelineno-6-35></a><span class=gp>&gt;&gt;&gt; </span><span class=n>alloc_weights</span> <span class=o>=</span> <span class=n>alloc_weights</span><span class=p>[:</span><span class=n>alloc_counter</span><span class=o>.</span><span class=n>sum</span><span class=p>()]</span>
</span></code></pre></div> <ol> <li>The global count will be used as the index at which the current allocation data is stored. This allows us to incrementally write all group allocation data into a single array.</li> <li>Record id is always per column (in this case, per group, since columns are groups in allocation records).</li> <li>Store the current column (in this case, group, since columns are groups in allocation records).</li> <li>Store the actual index point.</li> <li>Store the allocation (the vector of weights, one per group member).</li> <li>Since we do not know the number of generated allocations in advance, we should prepare for the worst case, where every timestamp has an allocation. The maximum number of entries is the number of timestamps multiplied by the number of groups.</li> <li>Notice how we use <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.alloc_point_dt>alloc_point_dt</a> as the data type for the array to make it structured.</li> <li>The allocation array has the same number of entries as the index point array, but with two dimensions to store the weight for each asset in a group (number of columns = number of assets in each group).</li> <li>The count is now tracked per group.</li> <li>Set the seed so the output is the same each time you execute this cell.</li> <li>To remove unused entries that have not been filled, use the global count, which is simply the sum of all group counts.</li> </ol> </div> <div class=tabbed-block> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>random_allocate_func_nb</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>group_memory</span><span class=p>):</span>  <span class=c1># (1)!</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=gp>... </span>    <span class=n>weights</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>group_len</span><span class=p>)</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=gp>... </span>    <span class=n>group_memory</span><span class=o>.</span><span class=n>target_alloc</span><span class=p>[:]</span> <span class=o>=</span> <span class=n>weights</span> <span class=o>/</span> <span class=n>weights</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=gp>...</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=gp>... </span>    <span class=n>group_count</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>alloc_counter</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>]</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=gp>... </span>    <span class=n>count</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>alloc_counter</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a><span class=gp>... </span>    <span class=n>c</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>alloc_points</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>][</span><span class=n>count</span><span class=p>]</span> <span class=o>=</span> <span class=n>group_count</span>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a><span class=gp>... </span>    <span class=n>c</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>alloc_points</span><span class=p>[</span><span class=s2>&quot;col&quot;</span><span class=p>][</span><span class=n>count</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>group</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a><span class=gp>... </span>    <span class=n>c</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>alloc_points</span><span class=p>[</span><span class=s2>&quot;alloc_idx&quot;</span><span class=p>][</span><span class=n>count</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>i</span>
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a><span class=gp>... </span>    <span class=n>c</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>alloc_weights</span><span class=p>[</span><span class=n>count</span><span class=p>]</span> <span class=o>=</span> <span class=n>group_memory</span><span class=o>.</span><span class=n>target_alloc</span>
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a><span class=gp>... </span>    <span class=n>c</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>alloc_counter</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>group</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-7-13><a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a>
</span><span id=__span-7-14><a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>alloc_points</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;&quot;&quot;</span>
</span><span id=__span-7-15><a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a><span class=gp>... </span><span class=s2>    max_entries = target_shape[0] * len(group_lens)</span>
</span><span id=__span-7-16><a id=__codelineno-7-16 name=__codelineno-7-16 href=#__codelineno-7-16></a><span class=gp>... </span><span class=s2>    np.empty(max_entries, dtype=alloc_point_dt)</span>
</span><span id=__span-7-17><a id=__codelineno-7-17 name=__codelineno-7-17 href=#__codelineno-7-17></a><span class=gp>... </span><span class=s2>&quot;&quot;&quot;</span><span class=p>,</span> <span class=n>context</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>alloc_point_dt</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>alloc_point_dt</span><span class=p>))</span>  <span class=c1># (2)!</span>
</span><span id=__span-7-18><a id=__codelineno-7-18 name=__codelineno-7-18 href=#__codelineno-7-18></a><span class=gp>&gt;&gt;&gt; </span><span class=n>alloc_weights</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;&quot;&quot;</span>
</span><span id=__span-7-19><a id=__codelineno-7-19 name=__codelineno-7-19 href=#__codelineno-7-19></a><span class=gp>... </span><span class=s2>    max_entries = target_shape[0] * len(group_lens)</span>
</span><span id=__span-7-20><a id=__codelineno-7-20 name=__codelineno-7-20 href=#__codelineno-7-20></a><span class=gp>... </span><span class=s2>    np.empty((max_entries, n_cols), dtype=float_)</span>
</span><span id=__span-7-21><a id=__codelineno-7-21 name=__codelineno-7-21 href=#__codelineno-7-21></a><span class=gp>... </span><span class=s2>&quot;&quot;&quot;</span><span class=p>,</span> <span class=n>context</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>n_cols</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>symbols</span><span class=p>)))</span>
</span><span id=__span-7-22><a id=__codelineno-7-22 name=__codelineno-7-22 href=#__codelineno-7-22></a><span class=gp>&gt;&gt;&gt; </span><span class=n>alloc_counter</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;np.full(len(group_lens), 0)&quot;</span><span class=p>)</span>
</span><span id=__span-7-23><a id=__codelineno-7-23 name=__codelineno-7-23 href=#__codelineno-7-23></a>
</span><span id=__span-7-24><a id=__codelineno-7-24 name=__codelineno-7-24 href=#__codelineno-7-24></a><span class=gp>&gt;&gt;&gt; </span><span class=n>InOutputs</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s2>&quot;InOutputs&quot;</span><span class=p>,</span> <span class=p>[</span>
</span><span id=__span-7-25><a id=__codelineno-7-25 name=__codelineno-7-25 href=#__codelineno-7-25></a><span class=gp>... </span>    <span class=s2>&quot;alloc_points&quot;</span><span class=p>,</span>
</span><span id=__span-7-26><a id=__codelineno-7-26 name=__codelineno-7-26 href=#__codelineno-7-26></a><span class=gp>... </span>    <span class=s2>&quot;alloc_weights&quot;</span><span class=p>,</span>  <span class=c1># (3)!</span>
</span><span id=__span-7-27><a id=__codelineno-7-27 name=__codelineno-7-27 href=#__codelineno-7-27></a><span class=gp>... </span>    <span class=s2>&quot;alloc_counter&quot;</span>
</span><span id=__span-7-28><a id=__codelineno-7-28 name=__codelineno-7-28 href=#__codelineno-7-28></a><span class=gp>... </span><span class=p>])</span>
</span><span id=__span-7-29><a id=__codelineno-7-29 name=__codelineno-7-29 href=#__codelineno-7-29></a><span class=gp>&gt;&gt;&gt; </span><span class=n>in_outputs</span> <span class=o>=</span> <span class=n>InOutputs</span><span class=p>(</span>
</span><span id=__span-7-30><a id=__codelineno-7-30 name=__codelineno-7-30 href=#__codelineno-7-30></a><span class=gp>... </span>    <span class=n>alloc_points</span><span class=o>=</span><span class=n>alloc_points</span><span class=p>,</span> 
</span><span id=__span-7-31><a id=__codelineno-7-31 name=__codelineno-7-31 href=#__codelineno-7-31></a><span class=gp>... </span>    <span class=n>alloc_weights</span><span class=o>=</span><span class=n>alloc_weights</span><span class=p>,</span>
</span><span id=__span-7-32><a id=__codelineno-7-32 name=__codelineno-7-32 href=#__codelineno-7-32></a><span class=gp>... </span>    <span class=n>alloc_counter</span><span class=o>=</span><span class=n>alloc_counter</span><span class=p>,</span>
</span><span id=__span-7-33><a id=__codelineno-7-33 name=__codelineno-7-33 href=#__codelineno-7-33></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-7-34><a id=__codelineno-7-34 name=__codelineno-7-34 href=#__codelineno-7-34></a>
</span><span id=__span-7-35><a id=__codelineno-7-35 name=__codelineno-7-35 href=#__codelineno-7-35></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>simulate_threshold_rebalancing</span><span class=p>(</span>
</span><span id=__span-7-36><a id=__codelineno-7-36 name=__codelineno-7-36 href=#__codelineno-7-36></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span> <span class=o>/</span> <span class=mi>100</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;threshold&quot;</span><span class=p>),</span>  <span class=c1># (4)!</span>
</span><span id=__span-7-37><a id=__codelineno-7-37 name=__codelineno-7-37 href=#__codelineno-7-37></a><span class=gp>... </span>    <span class=n>random_allocate_func_nb</span><span class=p>,</span> 
</span><span id=__span-7-38><a id=__codelineno-7-38 name=__codelineno-7-38 href=#__codelineno-7-38></a><span class=gp>... </span>    <span class=n>in_outputs</span><span class=o>=</span><span class=n>in_outputs</span><span class=p>,</span>  <span class=c1># (5)!</span>
</span><span id=__span-7-39><a id=__codelineno-7-39 name=__codelineno-7-39 href=#__codelineno-7-39></a><span class=gp>... </span>    <span class=n>seed</span><span class=o>=</span><span class=mi>42</span>
</span><span id=__span-7-40><a id=__codelineno-7-40 name=__codelineno-7-40 href=#__codelineno-7-40></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-7-41><a id=__codelineno-7-41 name=__codelineno-7-41 href=#__codelineno-7-41></a><span class=gp>&gt;&gt;&gt; </span><span class=n>alloc_points</span> <span class=o>=</span> <span class=n>pf</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>alloc_points</span><span class=p>[:</span><span class=n>pf</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>alloc_counter</span><span class=o>.</span><span class=n>sum</span><span class=p>()]</span>
</span><span id=__span-7-42><a id=__codelineno-7-42 name=__codelineno-7-42 href=#__codelineno-7-42></a><span class=gp>&gt;&gt;&gt; </span><span class=n>alloc_weights</span> <span class=o>=</span> <span class=n>pf</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>alloc_weights</span><span class=p>[:</span><span class=n>pf</span><span class=o>.</span><span class=n>in_outputs</span><span class=o>.</span><span class=n>alloc_counter</span><span class=o>.</span><span class=n>sum</span><span class=p>()]</span>
</span></code></pre></div> <ol> <li>The function is the same as in the "Preset" example, but now the arrays are provided through the in-place outputs tuple instead of being passed directly as arguments.</li> <li>The logic is the same as in the "Preset" example, except we use templates to defer array creation until after all other arrays are broadcast and the final shape and number of groups are determined.</li> <li>Do not name the field <code>allocations</code>, since it is a reserved word!</li> <li>Notice that array creation is no longer directly tied to the threshold array.</li> <li>Since we now use templates, we no longer have direct references to the created arrays. Luckily, we can use in-place outputs, which store references to all the arrays for us.</li> </ol> </div> </div> </div> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>If you perform portfolio optimization across a historical data range (for example, by searching for the maximum Sharpe ratio), be sure to use <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/enums/#vectorbtpro.portfolio.enums.alloc_range_dt>alloc_range_dt</a> and <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/records/#vectorbtpro.portfolio.pfopt.records.AllocRanges>AllocRanges</a>— this will add another dimension for data analysis.</p> </div> <p>All that's left is to create a <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer>PortfolioOptimizer</a> instance using the target allocation data we just filled:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=p>(</span>  <span class=c1># (1)!</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=gp>... </span>    <span class=n>wrapper</span><span class=o>=</span><span class=n>pf</span><span class=o>.</span><span class=n>wrapper</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=gp>... </span>    <span class=n>alloc_records</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>AllocPoints</span><span class=p>(</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=gp>... </span>        <span class=n>pf</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>resolve</span><span class=p>(),</span>  <span class=c1># (3)!</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=gp>... </span>        <span class=n>alloc_points</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=gp>... </span>    <span class=n>allocations</span><span class=o>=</span><span class=n>alloc_weights</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <ol> <li>We do not call any class method here—since we already have all the data, we can instantiate the class directly!</li> <li>The main wrapper should contain both regular columns and groups.</li> <li>The allocation wrapper should contain only groups, as the <code>col</code> field we filled previously points to groups instead of regular columns. By using <a href=https://vectorbt.pro/pvt_41531c19/api/base/wrapping/#vectorbtpro.base.wrapping.ArrayWrapper.resolve>ArrayWrapper.resolve</a>, we create a new wrapper where columns are replaced with groups.</li> </ol> <p>With this instance, we can thoroughly post-analyze the target allocation data. Even though we used random weights during rebalancing, let's review the allocations generated for a threshold of 10%, just as an example:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=p>[</span><span class=mf>0.1</span><span class=p>]</span><span class=o>.</span><span class=n>allocations</span><span class=o>.</span><span class=n>describe</span><span class=p>()</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=go>symbol   ADAUSDT   BNBUSDT   BTCUSDT   ETHUSDT   XRPUSDT</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=go>count   6.000000  6.000000  6.000000  6.000000  6.000000</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=go>mean    0.159883  0.149608  0.156493  0.292615  0.241400</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=go>std     0.092490  0.079783  0.043584  0.098891  0.083152</span>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=go>min     0.076678  0.056292  0.094375  0.200873  0.098709</span>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=go>25%     0.091023  0.082134  0.149385  0.220957  0.223424</span>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=go>50%     0.123982  0.157974  0.153985  0.252078  0.243109</span>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a><span class=go>75%     0.230589  0.204527  0.156810  0.375171  0.293097</span>
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=go>max     0.288493  0.248507  0.231013  0.423879  0.336853</span>
</span><span id=__span-9-11><a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a>
</span><span id=__span-9-12><a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>column</span><span class=o>=</span><span class=mf>0.1</span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/dynamic_01.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/dynamic_01.dark.svg#only-dark></p> <p>Here is how the target allocation visualization changes with a lower threshold:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>column</span><span class=o>=</span><span class=mf>0.03</span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/dynamic_003.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/dynamic_003.dark.svg#only-dark></p> <p>And here is what actually happened in practice:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=p>[</span><span class=mf>0.03</span><span class=p>]</span><span class=o>.</span><span class=n>plot_allocations</span><span class=p>()</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/dynamic_003_sim.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/dynamic_003_sim.dark.svg#only-dark></p> <p>Want to see something cool? If we feed our manually constructed optimizer instance to <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_optimizer>Portfolio.from_optimizer</a>, we will get exactly the same results <img alt=🤯 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f92f.svg title=:exploding_head:></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>sharpe_ratio</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=go>threshold</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=go>0.01    1.098642</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=go>0.02    1.707515</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a><span class=go>0.03    1.775001</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=go>0.04    2.077479</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a><span class=go>0.05    2.082900</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=go>0.06    1.964474</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a><span class=go>0.07    2.106367</span>
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a><span class=go>0.08    2.121511</span>
</span><span id=__span-12-11><a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a><span class=go>0.09    1.838164</span>
</span><span id=__span-12-12><a id=__codelineno-12-12 name=__codelineno-12-12 href=#__codelineno-12-12></a><span class=go>0.10    2.072388</span>
</span><span id=__span-12-13><a id=__codelineno-12-13 name=__codelineno-12-13 href=#__codelineno-12-13></a><span class=go>0.11    2.229001</span>
</span><span id=__span-12-14><a id=__codelineno-12-14 name=__codelineno-12-14 href=#__codelineno-12-14></a><span class=go>0.12    1.766305</span>
</span><span id=__span-12-15><a id=__codelineno-12-15 name=__codelineno-12-15 href=#__codelineno-12-15></a><span class=go>0.13    1.859604</span>
</span><span id=__span-12-16><a id=__codelineno-12-16 name=__codelineno-12-16 href=#__codelineno-12-16></a><span class=go>0.14    2.209144</span>
</span><span id=__span-12-17><a id=__codelineno-12-17 name=__codelineno-12-17 href=#__codelineno-12-17></a><span class=go>0.15    2.124474</span>
</span><span id=__span-12-18><a id=__codelineno-12-18 name=__codelineno-12-18 href=#__codelineno-12-18></a><span class=go>Name: sharpe_ratio, dtype: float64</span>
</span><span id=__span-12-19><a id=__codelineno-12-19 name=__codelineno-12-19 href=#__codelineno-12-19></a>
</span><span id=__span-12-20><a id=__codelineno-12-20 name=__codelineno-12-20 href=#__codelineno-12-20></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf_new</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_optimizer</span><span class=p>(</span>
</span><span id=__span-12-21><a id=__codelineno-12-21 name=__codelineno-12-21 href=#__codelineno-12-21></a><span class=gp>... </span>    <span class=n>data</span><span class=p>,</span>
</span><span id=__span-12-22><a id=__codelineno-12-22 name=__codelineno-12-22 href=#__codelineno-12-22></a><span class=gp>... </span>    <span class=n>pfo</span><span class=p>,</span> 
</span><span id=__span-12-23><a id=__codelineno-12-23 name=__codelineno-12-23 href=#__codelineno-12-23></a><span class=gp>... </span>    <span class=n>val_price</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Open&quot;</span><span class=p>),</span> 
</span><span id=__span-12-24><a id=__codelineno-12-24 name=__codelineno-12-24 href=#__codelineno-12-24></a><span class=gp>... </span>    <span class=n>freq</span><span class=o>=</span><span class=s2>&quot;1h&quot;</span><span class=p>,</span> 
</span><span id=__span-12-25><a id=__codelineno-12-25 name=__codelineno-12-25 href=#__codelineno-12-25></a><span class=gp>... </span>    <span class=n>fees</span><span class=o>=</span><span class=mf>0.005</span>
</span><span id=__span-12-26><a id=__codelineno-12-26 name=__codelineno-12-26 href=#__codelineno-12-26></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-12-27><a id=__codelineno-12-27 name=__codelineno-12-27 href=#__codelineno-12-27></a>
</span><span id=__span-12-28><a id=__codelineno-12-28 name=__codelineno-12-28 href=#__codelineno-12-28></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf_new</span><span class=o>.</span><span class=n>sharpe_ratio</span>
</span><span id=__span-12-29><a id=__codelineno-12-29 name=__codelineno-12-29 href=#__codelineno-12-29></a><span class=go>threshold</span>
</span><span id=__span-12-30><a id=__codelineno-12-30 name=__codelineno-12-30 href=#__codelineno-12-30></a><span class=go>0.01    1.098642</span>
</span><span id=__span-12-31><a id=__codelineno-12-31 name=__codelineno-12-31 href=#__codelineno-12-31></a><span class=go>0.02    1.707515</span>
</span><span id=__span-12-32><a id=__codelineno-12-32 name=__codelineno-12-32 href=#__codelineno-12-32></a><span class=go>0.03    1.775001</span>
</span><span id=__span-12-33><a id=__codelineno-12-33 name=__codelineno-12-33 href=#__codelineno-12-33></a><span class=go>0.04    2.077479</span>
</span><span id=__span-12-34><a id=__codelineno-12-34 name=__codelineno-12-34 href=#__codelineno-12-34></a><span class=go>0.05    2.082900</span>
</span><span id=__span-12-35><a id=__codelineno-12-35 name=__codelineno-12-35 href=#__codelineno-12-35></a><span class=go>0.06    1.964474</span>
</span><span id=__span-12-36><a id=__codelineno-12-36 name=__codelineno-12-36 href=#__codelineno-12-36></a><span class=go>0.07    2.106367</span>
</span><span id=__span-12-37><a id=__codelineno-12-37 name=__codelineno-12-37 href=#__codelineno-12-37></a><span class=go>0.08    2.121511</span>
</span><span id=__span-12-38><a id=__codelineno-12-38 name=__codelineno-12-38 href=#__codelineno-12-38></a><span class=go>0.09    1.838164</span>
</span><span id=__span-12-39><a id=__codelineno-12-39 name=__codelineno-12-39 href=#__codelineno-12-39></a><span class=go>0.10    2.072388</span>
</span><span id=__span-12-40><a id=__codelineno-12-40 name=__codelineno-12-40 href=#__codelineno-12-40></a><span class=go>0.11    2.229001</span>
</span><span id=__span-12-41><a id=__codelineno-12-41 name=__codelineno-12-41 href=#__codelineno-12-41></a><span class=go>0.12    1.766305</span>
</span><span id=__span-12-42><a id=__codelineno-12-42 name=__codelineno-12-42 href=#__codelineno-12-42></a><span class=go>0.13    1.859604</span>
</span><span id=__span-12-43><a id=__codelineno-12-43 name=__codelineno-12-43 href=#__codelineno-12-43></a><span class=go>0.14    2.209144</span>
</span><span id=__span-12-44><a id=__codelineno-12-44 name=__codelineno-12-44 href=#__codelineno-12-44></a><span class=go>0.15    2.124474</span>
</span><span id=__span-12-45><a id=__codelineno-12-45 name=__codelineno-12-45 href=#__codelineno-12-45></a><span class=go>Name: sharpe_ratio, dtype: float64</span>
</span></code></pre></div> <p>This once again demonstrates the power of VBT: we just performed dynamic threshold rebalancing, extracted the target allocation data from the simulation, analyzed that data, and then fed it into another, completely different simulation method to ensure there were no mistakes in order generation.</p> <h2 id=bonus-1-own-optimizer>Bonus 1: Own optimizer<a class=headerlink href=#bonus-1-own-optimizer title="Permanent link">&para;</a></h2> <p>As a bonus, let's perform periodic mean-variance optimization using our own simulator! We will generate the rebalancing dates ahead of time and, for each date, calculate multiple Sharpe ratios for that period and use the Efficient Frontier to select the best one. The pipeline below is as lightweight as possible: it processes only one parameter combination at a time, uses VBT's low-level order execution API, and only uses the information it actually needs.</p> <p>Here is our raw Numba-compiled pipeline (agnostic to the optimization function):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span><span class=p>(</span><span class=n>nogil</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>optimize_portfolio_nb</span><span class=p>(</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=gp>... </span>    <span class=n>close</span><span class=p>,</span> 
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=gp>... </span>    <span class=n>val_price</span><span class=p>,</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=gp>... </span>    <span class=n>range_starts</span><span class=p>,</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=gp>... </span>    <span class=n>range_ends</span><span class=p>,</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=gp>... </span>    <span class=n>optimize_func_nb</span><span class=p>,</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=gp>... </span>    <span class=n>optimize_args</span><span class=o>=</span><span class=p>(),</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a><span class=gp>... </span>    <span class=n>fees</span><span class=o>=</span><span class=mf>0.</span><span class=p>,</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a><span class=gp>... </span>    <span class=n>init_cash</span><span class=o>=</span><span class=mf>100.</span><span class=p>,</span>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12 href=#__codelineno-13-12></a><span class=gp>... </span>    <span class=n>group</span><span class=o>=</span><span class=mi>0</span>
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13 href=#__codelineno-13-13></a><span class=gp>... </span><span class=p>):</span>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14 href=#__codelineno-13-14></a><span class=gp>... </span>    <span class=n>val_price_</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array_nb</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>val_price</span><span class=p>))</span>  <span class=c1># (1)!</span>
</span><span id=__span-13-15><a id=__codelineno-13-15 name=__codelineno-13-15 href=#__codelineno-13-15></a><span class=gp>... </span>    <span class=n>price_</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array_nb</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>price</span><span class=p>))</span>
</span><span id=__span-13-16><a id=__codelineno-13-16 name=__codelineno-13-16 href=#__codelineno-13-16></a><span class=gp>... </span>    <span class=n>fees_</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array_nb</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>fees</span><span class=p>))</span>
</span><span id=__span-13-17><a id=__codelineno-13-17 name=__codelineno-13-17 href=#__codelineno-13-17></a><span class=gp>...</span>
</span><span id=__span-13-18><a id=__codelineno-13-18 name=__codelineno-13-18 href=#__codelineno-13-18></a><span class=gp>... </span>    <span class=n>order_records</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>order_dt</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-13-19><a id=__codelineno-13-19 name=__codelineno-13-19 href=#__codelineno-13-19></a><span class=gp>... </span>    <span class=n>order_counts</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mi>0</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>int_</span><span class=p>)</span>
</span><span id=__span-13-20><a id=__codelineno-13-20 name=__codelineno-13-20 href=#__codelineno-13-20></a><span class=gp>... </span>    
</span><span id=__span-13-21><a id=__codelineno-13-21 name=__codelineno-13-21 href=#__codelineno-13-21></a><span class=gp>... </span>    <span class=n>order_value</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>float_</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-13-22><a id=__codelineno-13-22 name=__codelineno-13-22 href=#__codelineno-13-22></a><span class=gp>... </span>    <span class=n>call_seq</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>empty</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>int_</span><span class=p>)</span>
</span><span id=__span-13-23><a id=__codelineno-13-23 name=__codelineno-13-23 href=#__codelineno-13-23></a><span class=gp>... </span>    
</span><span id=__span-13-24><a id=__codelineno-13-24 name=__codelineno-13-24 href=#__codelineno-13-24></a><span class=gp>... </span>    <span class=n>last_position</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mf>0.0</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>float_</span><span class=p>)</span>
</span><span id=__span-13-25><a id=__codelineno-13-25 name=__codelineno-13-25 href=#__codelineno-13-25></a><span class=gp>... </span>    <span class=n>last_debt</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mf>0.0</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>float_</span><span class=p>)</span>
</span><span id=__span-13-26><a id=__codelineno-13-26 name=__codelineno-13-26 href=#__codelineno-13-26></a><span class=gp>... </span>    <span class=n>last_locked_cash</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mf>0.0</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>float_</span><span class=p>)</span>
</span><span id=__span-13-27><a id=__codelineno-13-27 name=__codelineno-13-27 href=#__codelineno-13-27></a><span class=gp>... </span>    <span class=n>cash_now</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>init_cash</span><span class=p>)</span>  <span class=c1># (4)!</span>
</span><span id=__span-13-28><a id=__codelineno-13-28 name=__codelineno-13-28 href=#__codelineno-13-28></a><span class=gp>... </span>    <span class=n>free_cash_now</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>init_cash</span><span class=p>)</span>
</span><span id=__span-13-29><a id=__codelineno-13-29 name=__codelineno-13-29 href=#__codelineno-13-29></a><span class=gp>... </span>    <span class=n>value_now</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>init_cash</span><span class=p>)</span>
</span><span id=__span-13-30><a id=__codelineno-13-30 name=__codelineno-13-30 href=#__codelineno-13-30></a><span class=gp>... </span>
</span><span id=__span-13-31><a id=__codelineno-13-31 name=__codelineno-13-31 href=#__codelineno-13-31></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>range_starts</span><span class=p>)):</span>  <span class=c1># (5)!</span>
</span><span id=__span-13-32><a id=__codelineno-13-32 name=__codelineno-13-32 href=#__codelineno-13-32></a><span class=gp>... </span>        <span class=n>i</span> <span class=o>=</span> <span class=n>range_ends</span><span class=p>[</span><span class=n>k</span><span class=p>]</span>  <span class=c1># (6)!</span>
</span><span id=__span-13-33><a id=__codelineno-13-33 name=__codelineno-13-33 href=#__codelineno-13-33></a><span class=gp>... </span>        <span class=n>size</span> <span class=o>=</span> <span class=n>optimize_func_nb</span><span class=p>(</span>  <span class=c1># (7)!</span>
</span><span id=__span-13-34><a id=__codelineno-13-34 name=__codelineno-13-34 href=#__codelineno-13-34></a><span class=gp>... </span>            <span class=n>range_starts</span><span class=p>[</span><span class=n>k</span><span class=p>],</span> 
</span><span id=__span-13-35><a id=__codelineno-13-35 name=__codelineno-13-35 href=#__codelineno-13-35></a><span class=gp>... </span>            <span class=n>range_ends</span><span class=p>[</span><span class=n>k</span><span class=p>],</span> 
</span><span id=__span-13-36><a id=__codelineno-13-36 name=__codelineno-13-36 href=#__codelineno-13-36></a><span class=gp>... </span>            <span class=o>*</span><span class=n>optimize_args</span>
</span><span id=__span-13-37><a id=__codelineno-13-37 name=__codelineno-13-37 href=#__codelineno-13-37></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-13-38><a id=__codelineno-13-38 name=__codelineno-13-38 href=#__codelineno-13-38></a><span class=gp>... </span>        
</span><span id=__span-13-39><a id=__codelineno-13-39 name=__codelineno-13-39 href=#__codelineno-13-39></a><span class=gp>... </span>        <span class=c1># (8)!</span>
</span><span id=__span-13-40><a id=__codelineno-13-40 name=__codelineno-13-40 href=#__codelineno-13-40></a><span class=gp>... </span>        <span class=n>value_now</span> <span class=o>=</span> <span class=n>cash_now</span>
</span><span id=__span-13-41><a id=__codelineno-13-41 name=__codelineno-13-41 href=#__codelineno-13-41></a><span class=gp>... </span>        <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]):</span>
</span><span id=__span-13-42><a id=__codelineno-13-42 name=__codelineno-13-42 href=#__codelineno-13-42></a><span class=gp>... </span>            <span class=n>val_price_now</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_nb</span><span class=p>(</span><span class=n>val_price_</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>)</span>
</span><span id=__span-13-43><a id=__codelineno-13-43 name=__codelineno-13-43 href=#__codelineno-13-43></a><span class=gp>... </span>            <span class=n>value_now</span> <span class=o>+=</span> <span class=n>last_position</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>*</span> <span class=n>val_price_now</span>
</span><span id=__span-13-44><a id=__codelineno-13-44 name=__codelineno-13-44 href=#__codelineno-13-44></a><span class=gp>... </span>        
</span><span id=__span-13-45><a id=__codelineno-13-45 name=__codelineno-13-45 href=#__codelineno-13-45></a><span class=gp>... </span>        <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]):</span>
</span><span id=__span-13-46><a id=__codelineno-13-46 name=__codelineno-13-46 href=#__codelineno-13-46></a><span class=gp>... </span>            <span class=n>val_price_now</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_nb</span><span class=p>(</span><span class=n>val_price_</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>)</span>
</span><span id=__span-13-47><a id=__codelineno-13-47 name=__codelineno-13-47 href=#__codelineno-13-47></a><span class=gp>... </span>            <span class=n>exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>ExecState</span><span class=p>(</span>
</span><span id=__span-13-48><a id=__codelineno-13-48 name=__codelineno-13-48 href=#__codelineno-13-48></a><span class=gp>... </span>                <span class=n>cash</span><span class=o>=</span><span class=n>cash_now</span><span class=p>,</span>
</span><span id=__span-13-49><a id=__codelineno-13-49 name=__codelineno-13-49 href=#__codelineno-13-49></a><span class=gp>... </span>                <span class=n>position</span><span class=o>=</span><span class=n>last_position</span><span class=p>[</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-13-50><a id=__codelineno-13-50 name=__codelineno-13-50 href=#__codelineno-13-50></a><span class=gp>... </span>                <span class=n>debt</span><span class=o>=</span><span class=n>last_debt</span><span class=p>[</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-13-51><a id=__codelineno-13-51 name=__codelineno-13-51 href=#__codelineno-13-51></a><span class=gp>... </span>                <span class=n>locked_cash</span><span class=o>=</span><span class=n>last_locked_cash</span><span class=p>[</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-13-52><a id=__codelineno-13-52 name=__codelineno-13-52 href=#__codelineno-13-52></a><span class=gp>... </span>                <span class=n>free_cash</span><span class=o>=</span><span class=n>free_cash_now</span><span class=p>,</span>
</span><span id=__span-13-53><a id=__codelineno-13-53 name=__codelineno-13-53 href=#__codelineno-13-53></a><span class=gp>... </span>                <span class=n>val_price</span><span class=o>=</span><span class=n>val_price_now</span><span class=p>,</span>
</span><span id=__span-13-54><a id=__codelineno-13-54 name=__codelineno-13-54 href=#__codelineno-13-54></a><span class=gp>... </span>                <span class=n>value</span><span class=o>=</span><span class=n>value_now</span><span class=p>,</span>
</span><span id=__span-13-55><a id=__codelineno-13-55 name=__codelineno-13-55 href=#__codelineno-13-55></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-13-56><a id=__codelineno-13-56 name=__codelineno-13-56 href=#__codelineno-13-56></a><span class=gp>... </span>            <span class=n>order_value</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>approx_order_value_nb</span><span class=p>(</span>  <span class=c1># (9)!</span>
</span><span id=__span-13-57><a id=__codelineno-13-57 name=__codelineno-13-57 href=#__codelineno-13-57></a><span class=gp>... </span>                <span class=n>exec_state</span><span class=p>,</span>
</span><span id=__span-13-58><a id=__codelineno-13-58 name=__codelineno-13-58 href=#__codelineno-13-58></a><span class=gp>... </span>                <span class=n>size</span><span class=p>[</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-13-59><a id=__codelineno-13-59 name=__codelineno-13-59 href=#__codelineno-13-59></a><span class=gp>... </span>                <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>SizeType</span><span class=o>.</span><span class=n>TargetPercent</span><span class=p>,</span>
</span><span id=__span-13-60><a id=__codelineno-13-60 name=__codelineno-13-60 href=#__codelineno-13-60></a><span class=gp>... </span>                <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>Direction</span><span class=o>.</span><span class=n>Both</span><span class=p>,</span>
</span><span id=__span-13-61><a id=__codelineno-13-61 name=__codelineno-13-61 href=#__codelineno-13-61></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-13-62><a id=__codelineno-13-62 name=__codelineno-13-62 href=#__codelineno-13-62></a><span class=gp>... </span>            <span class=n>call_seq</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>col</span>  <span class=c1># (10)!</span>
</span><span id=__span-13-63><a id=__codelineno-13-63 name=__codelineno-13-63 href=#__codelineno-13-63></a><span class=gp>... </span>
</span><span id=__span-13-64><a id=__codelineno-13-64 name=__codelineno-13-64 href=#__codelineno-13-64></a><span class=gp>... </span>        <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>insert_argsort_nb</span><span class=p>(</span><span class=n>order_value</span><span class=p>,</span> <span class=n>call_seq</span><span class=p>)</span>  <span class=c1># (11)!</span>
</span><span id=__span-13-65><a id=__codelineno-13-65 name=__codelineno-13-65 href=#__codelineno-13-65></a><span class=gp>... </span>
</span><span id=__span-13-66><a id=__codelineno-13-66 name=__codelineno-13-66 href=#__codelineno-13-66></a><span class=gp>... </span>        <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]):</span>  <span class=c1># (12)!</span>
</span><span id=__span-13-67><a id=__codelineno-13-67 name=__codelineno-13-67 href=#__codelineno-13-67></a><span class=gp>... </span>            <span class=n>col</span> <span class=o>=</span> <span class=n>call_seq</span><span class=p>[</span><span class=n>c</span><span class=p>]</span>  <span class=c1># (13)!</span>
</span><span id=__span-13-68><a id=__codelineno-13-68 name=__codelineno-13-68 href=#__codelineno-13-68></a><span class=gp>... </span>            
</span><span id=__span-13-69><a id=__codelineno-13-69 name=__codelineno-13-69 href=#__codelineno-13-69></a><span class=gp>... </span>            <span class=n>order</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>order_nb</span><span class=p>(</span>  <span class=c1># (14)!</span>
</span><span id=__span-13-70><a id=__codelineno-13-70 name=__codelineno-13-70 href=#__codelineno-13-70></a><span class=gp>... </span>                <span class=n>size</span><span class=o>=</span><span class=n>size</span><span class=p>[</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-13-71><a id=__codelineno-13-71 name=__codelineno-13-71 href=#__codelineno-13-71></a><span class=gp>... </span>                <span class=n>price</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_nb</span><span class=p>(</span><span class=n>price_</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>),</span>
</span><span id=__span-13-72><a id=__codelineno-13-72 name=__codelineno-13-72 href=#__codelineno-13-72></a><span class=gp>... </span>                <span class=n>size_type</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>SizeType</span><span class=o>.</span><span class=n>TargetPercent</span><span class=p>,</span>
</span><span id=__span-13-73><a id=__codelineno-13-73 name=__codelineno-13-73 href=#__codelineno-13-73></a><span class=gp>... </span>                <span class=n>direction</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>Direction</span><span class=o>.</span><span class=n>Both</span><span class=p>,</span>
</span><span id=__span-13-74><a id=__codelineno-13-74 name=__codelineno-13-74 href=#__codelineno-13-74></a><span class=gp>... </span>                <span class=n>fees</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_nb</span><span class=p>(</span><span class=n>fees_</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>),</span>
</span><span id=__span-13-75><a id=__codelineno-13-75 name=__codelineno-13-75 href=#__codelineno-13-75></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-13-76><a id=__codelineno-13-76 name=__codelineno-13-76 href=#__codelineno-13-76></a><span class=gp>...</span>
</span><span id=__span-13-77><a id=__codelineno-13-77 name=__codelineno-13-77 href=#__codelineno-13-77></a><span class=gp>... </span>            <span class=c1># (15)!</span>
</span><span id=__span-13-78><a id=__codelineno-13-78 name=__codelineno-13-78 href=#__codelineno-13-78></a><span class=gp>... </span>            <span class=n>price_area</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>PriceArea</span><span class=p>(</span>
</span><span id=__span-13-79><a id=__codelineno-13-79 name=__codelineno-13-79 href=#__codelineno-13-79></a><span class=gp>... </span>                <span class=nb>open</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-13-80><a id=__codelineno-13-80 name=__codelineno-13-80 href=#__codelineno-13-80></a><span class=gp>... </span>                <span class=n>high</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-13-81><a id=__codelineno-13-81 name=__codelineno-13-81 href=#__codelineno-13-81></a><span class=gp>... </span>                <span class=n>low</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
</span><span id=__span-13-82><a id=__codelineno-13-82 name=__codelineno-13-82 href=#__codelineno-13-82></a><span class=gp>... </span>                <span class=n>close</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_nb</span><span class=p>(</span><span class=n>close</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>),</span>
</span><span id=__span-13-83><a id=__codelineno-13-83 name=__codelineno-13-83 href=#__codelineno-13-83></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-13-84><a id=__codelineno-13-84 name=__codelineno-13-84 href=#__codelineno-13-84></a><span class=gp>... </span>            <span class=n>val_price_now</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>flex_select_nb</span><span class=p>(</span><span class=n>val_price_</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>col</span><span class=p>)</span>
</span><span id=__span-13-85><a id=__codelineno-13-85 name=__codelineno-13-85 href=#__codelineno-13-85></a><span class=gp>... </span>            <span class=n>exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_enums</span><span class=o>.</span><span class=n>ExecState</span><span class=p>(</span>
</span><span id=__span-13-86><a id=__codelineno-13-86 name=__codelineno-13-86 href=#__codelineno-13-86></a><span class=gp>... </span>                <span class=n>cash</span><span class=o>=</span><span class=n>cash_now</span><span class=p>,</span>
</span><span id=__span-13-87><a id=__codelineno-13-87 name=__codelineno-13-87 href=#__codelineno-13-87></a><span class=gp>... </span>                <span class=n>position</span><span class=o>=</span><span class=n>last_position</span><span class=p>[</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-13-88><a id=__codelineno-13-88 name=__codelineno-13-88 href=#__codelineno-13-88></a><span class=gp>... </span>                <span class=n>debt</span><span class=o>=</span><span class=n>last_debt</span><span class=p>[</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-13-89><a id=__codelineno-13-89 name=__codelineno-13-89 href=#__codelineno-13-89></a><span class=gp>... </span>                <span class=n>locked_cash</span><span class=o>=</span><span class=n>last_locked_cash</span><span class=p>[</span><span class=n>col</span><span class=p>],</span>
</span><span id=__span-13-90><a id=__codelineno-13-90 name=__codelineno-13-90 href=#__codelineno-13-90></a><span class=gp>... </span>                <span class=n>free_cash</span><span class=o>=</span><span class=n>free_cash_now</span><span class=p>,</span>
</span><span id=__span-13-91><a id=__codelineno-13-91 name=__codelineno-13-91 href=#__codelineno-13-91></a><span class=gp>... </span>                <span class=n>val_price</span><span class=o>=</span><span class=n>val_price_now</span><span class=p>,</span>
</span><span id=__span-13-92><a id=__codelineno-13-92 name=__codelineno-13-92 href=#__codelineno-13-92></a><span class=gp>... </span>                <span class=n>value</span><span class=o>=</span><span class=n>value_now</span><span class=p>,</span>
</span><span id=__span-13-93><a id=__codelineno-13-93 name=__codelineno-13-93 href=#__codelineno-13-93></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-13-94><a id=__codelineno-13-94 name=__codelineno-13-94 href=#__codelineno-13-94></a><span class=gp>... </span>            <span class=n>_</span><span class=p>,</span> <span class=n>new_exec_state</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>pf_nb</span><span class=o>.</span><span class=n>process_order_nb</span><span class=p>(</span>
</span><span id=__span-13-95><a id=__codelineno-13-95 name=__codelineno-13-95 href=#__codelineno-13-95></a><span class=gp>... </span>                <span class=n>group</span><span class=o>=</span><span class=n>group</span><span class=p>,</span>
</span><span id=__span-13-96><a id=__codelineno-13-96 name=__codelineno-13-96 href=#__codelineno-13-96></a><span class=gp>... </span>                <span class=n>col</span><span class=o>=</span><span class=n>col</span><span class=p>,</span>
</span><span id=__span-13-97><a id=__codelineno-13-97 name=__codelineno-13-97 href=#__codelineno-13-97></a><span class=gp>... </span>                <span class=n>i</span><span class=o>=</span><span class=n>i</span><span class=p>,</span>
</span><span id=__span-13-98><a id=__codelineno-13-98 name=__codelineno-13-98 href=#__codelineno-13-98></a><span class=gp>... </span>                <span class=n>exec_state</span><span class=o>=</span><span class=n>exec_state</span><span class=p>,</span>
</span><span id=__span-13-99><a id=__codelineno-13-99 name=__codelineno-13-99 href=#__codelineno-13-99></a><span class=gp>... </span>                <span class=n>order</span><span class=o>=</span><span class=n>order</span><span class=p>,</span>
</span><span id=__span-13-100><a id=__codelineno-13-100 name=__codelineno-13-100 href=#__codelineno-13-100></a><span class=gp>... </span>                <span class=n>price_area</span><span class=o>=</span><span class=n>price_area</span><span class=p>,</span>
</span><span id=__span-13-101><a id=__codelineno-13-101 name=__codelineno-13-101 href=#__codelineno-13-101></a><span class=gp>... </span>                <span class=n>order_records</span><span class=o>=</span><span class=n>order_records</span><span class=p>,</span>
</span><span id=__span-13-102><a id=__codelineno-13-102 name=__codelineno-13-102 href=#__codelineno-13-102></a><span class=gp>... </span>                <span class=n>order_counts</span><span class=o>=</span><span class=n>order_counts</span>
</span><span id=__span-13-103><a id=__codelineno-13-103 name=__codelineno-13-103 href=#__codelineno-13-103></a><span class=gp>... </span>            <span class=p>)</span>
</span><span id=__span-13-104><a id=__codelineno-13-104 name=__codelineno-13-104 href=#__codelineno-13-104></a><span class=gp>... </span>
</span><span id=__span-13-105><a id=__codelineno-13-105 name=__codelineno-13-105 href=#__codelineno-13-105></a><span class=gp>... </span>            <span class=n>cash_now</span> <span class=o>=</span> <span class=n>new_exec_state</span><span class=o>.</span><span class=n>cash</span>
</span><span id=__span-13-106><a id=__codelineno-13-106 name=__codelineno-13-106 href=#__codelineno-13-106></a><span class=gp>... </span>            <span class=n>free_cash_now</span> <span class=o>=</span> <span class=n>new_exec_state</span><span class=o>.</span><span class=n>free_cash</span>
</span><span id=__span-13-107><a id=__codelineno-13-107 name=__codelineno-13-107 href=#__codelineno-13-107></a><span class=gp>... </span>            <span class=n>value_now</span> <span class=o>=</span> <span class=n>new_exec_state</span><span class=o>.</span><span class=n>value</span>
</span><span id=__span-13-108><a id=__codelineno-13-108 name=__codelineno-13-108 href=#__codelineno-13-108></a><span class=gp>... </span>            <span class=n>last_position</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>new_exec_state</span><span class=o>.</span><span class=n>position</span>
</span><span id=__span-13-109><a id=__codelineno-13-109 name=__codelineno-13-109 href=#__codelineno-13-109></a><span class=gp>... </span>            <span class=n>last_debt</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>new_exec_state</span><span class=o>.</span><span class=n>debt</span>
</span><span id=__span-13-110><a id=__codelineno-13-110 name=__codelineno-13-110 href=#__codelineno-13-110></a><span class=gp>... </span>            <span class=n>last_locked_cash</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>new_exec_state</span><span class=o>.</span><span class=n>locked_cash</span>
</span><span id=__span-13-111><a id=__codelineno-13-111 name=__codelineno-13-111 href=#__codelineno-13-111></a><span class=gp>... </span>
</span><span id=__span-13-112><a id=__codelineno-13-112 name=__codelineno-13-112 href=#__codelineno-13-112></a><span class=gp>... </span>    <span class=c1># (16)!</span>
</span><span id=__span-13-113><a id=__codelineno-13-113 name=__codelineno-13-113 href=#__codelineno-13-113></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>repartition_nb</span><span class=p>(</span><span class=n>order_records</span><span class=p>,</span> <span class=n>order_counts</span><span class=p>)</span>
</span></code></pre></div> <ol> <li><a href=https://vectorbt.pro/pvt_41531c19/api/base/flex_indexing/#vectorbtpro.base.flex_indexing.flex_select_nb>flex_select_nb</a> requires flexible arrays to have exactly two dimensions, so we use the <a href=https://vectorbt.pro/pvt_41531c19/api/base/reshaping/#vectorbtpro.base.reshaping.to_2d_array_nb>to_2d_array_nb</a> function to convert scalars and one-dimensional arrays. Notice how we store the new arrays in variables with a trailing underscore. Numba cannot handle arrays with different shapes assigned to the same variable.</li> <li>Since we do not know the number of orders ahead of time, create an array with the same number of records as there are elements in <code>close</code>. Also, note that <code>order_records</code> must be two-dimensional.</li> <li>Because we are iterating over timestamps and columns, we need to store information related to each asset. We do this using a one-dimensional array with elements aligned by column.</li> <li>All information associated with cash is a constant because we have just one group with cash sharing. We update those constants after each iteration.</li> <li>There is no significant difference between iterating over the entire shape of <code>close</code> or just the timestamps where optimization actually occurs. So, we iterate over ranges. If you want to combine optimization with a stop loss or other rolling checks, you should iterate over <code>close.shape[0]</code> and run <code>optimize_func_nb</code> only when the current iteration matches an entry in <code>range_ends</code>.</li> <li>The allocation index, where optimization and order execution should occur, defaults to the range end.</li> <li>Run the optimization function, which should return the weights. You can adapt it to return the size type, direction, and any other information needed.</li> <li>Calculate the current group value using the open price.</li> <li>Use the group value to approximate the order value for each allocation.</li> <li>Prepare the call sequence array.</li> <li>Sort the call sequence by order value, so assets that should be sold are processed first.</li> <li>Iterate over each asset to place an order.</li> <li>Get the column index of an asset based on the sorted call sequence. For example, if the first element in <code>call_seq</code> is 2, we should process the third asset first.</li> <li>Create an order. You can provide additional information such as fixed fees to this function.</li> <li>Process the order and update the current balances.</li> <li>Order records are stored per column, so flatten them.</li> </ol> <p>Here is our Numba-compiled MVO function:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span><span class=p>(</span><span class=n>nogil</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>sharpe_optimize_func_nb</span><span class=p>(</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=gp>... </span>    <span class=n>start_idx</span><span class=p>,</span> 
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=gp>... </span>    <span class=n>end_idx</span><span class=p>,</span> 
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=gp>... </span>    <span class=n>close</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a><span class=gp>... </span>    <span class=n>num_tests</span><span class=p>,</span> 
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=gp>... </span>    <span class=n>ann_factor</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a><span class=gp>... </span><span class=p>):</span>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a><span class=gp>... </span>    <span class=n>close_period</span> <span class=o>=</span> <span class=n>close</span><span class=p>[</span><span class=n>start_idx</span><span class=p>:</span><span class=n>end_idx</span><span class=p>]</span>  <span class=c1># (3)!</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=gp>... </span>    <span class=n>returns</span> <span class=o>=</span> <span class=p>(</span><span class=n>close_period</span><span class=p>[</span><span class=mi>1</span><span class=p>:]</span> <span class=o>-</span> <span class=n>close_period</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span> <span class=o>/</span> <span class=n>close_period</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a><span class=gp>... </span>    <span class=n>mean</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>nanmean_nb</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a><span class=gp>... </span>    <span class=n>cov</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>cov</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>rowvar</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a><span class=gp>... </span>    <span class=n>best_sharpe_ratio</span> <span class=o>=</span> <span class=o>-</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span>
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14 href=#__codelineno-14-14></a><span class=gp>... </span>    <span class=n>weights</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>float_</span><span class=p>)</span>
</span><span id=__span-14-15><a id=__codelineno-14-15 name=__codelineno-14-15 href=#__codelineno-14-15></a><span class=gp>... </span>    
</span><span id=__span-14-16><a id=__codelineno-14-16 name=__codelineno-14-16 href=#__codelineno-14-16></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>num_tests</span><span class=p>):</span>  <span class=c1># (4)!</span>
</span><span id=__span-14-17><a id=__codelineno-14-17 name=__codelineno-14-17 href=#__codelineno-14-17></a><span class=gp>... </span>        <span class=n>w</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>random_sample</span><span class=p>(</span><span class=n>close</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span><span id=__span-14-18><a id=__codelineno-14-18 name=__codelineno-14-18 href=#__codelineno-14-18></a><span class=gp>... </span>        <span class=n>w</span> <span class=o>=</span> <span class=n>w</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>w</span><span class=p>)</span>
</span><span id=__span-14-19><a id=__codelineno-14-19 name=__codelineno-14-19 href=#__codelineno-14-19></a><span class=gp>... </span>        <span class=n>p_return</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>mean</span> <span class=o>*</span> <span class=n>w</span><span class=p>)</span> <span class=o>*</span> <span class=n>ann_factor</span>
</span><span id=__span-14-20><a id=__codelineno-14-20 name=__codelineno-14-20 href=#__codelineno-14-20></a><span class=gp>... </span>        <span class=n>p_std</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>w</span><span class=o>.</span><span class=n>T</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>cov</span><span class=p>,</span> <span class=n>w</span><span class=p>)))</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>ann_factor</span><span class=p>)</span>
</span><span id=__span-14-21><a id=__codelineno-14-21 name=__codelineno-14-21 href=#__codelineno-14-21></a><span class=gp>... </span>        <span class=n>sharpe_ratio</span> <span class=o>=</span> <span class=n>p_return</span> <span class=o>/</span> <span class=n>p_std</span>
</span><span id=__span-14-22><a id=__codelineno-14-22 name=__codelineno-14-22 href=#__codelineno-14-22></a><span class=gp>... </span>        <span class=k>if</span> <span class=n>sharpe_ratio</span> <span class=o>&gt;</span> <span class=n>best_sharpe_ratio</span><span class=p>:</span>
</span><span id=__span-14-23><a id=__codelineno-14-23 name=__codelineno-14-23 href=#__codelineno-14-23></a><span class=gp>... </span>            <span class=n>best_sharpe_ratio</span> <span class=o>=</span> <span class=n>sharpe_ratio</span>
</span><span id=__span-14-24><a id=__codelineno-14-24 name=__codelineno-14-24 href=#__codelineno-14-24></a><span class=gp>... </span>            <span class=n>weights</span> <span class=o>=</span> <span class=n>w</span>
</span><span id=__span-14-25><a id=__codelineno-14-25 name=__codelineno-14-25 href=#__codelineno-14-25></a><span class=gp>... </span>            
</span><span id=__span-14-26><a id=__codelineno-14-26 name=__codelineno-14-26 href=#__codelineno-14-26></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>weights</span>
</span></code></pre></div> <ol> <li>Remember to disable the GIL everywhere so you can use multi-threading.</li> <li>These are additional arguments passed via <code>*args</code> in <code>optimize_portfolio_nb</code>.</li> <li>Select the previous week in <code>close</code>.</li> <li>Iterate over a number of tests. For each, generate a random allocation, calculate its Sharpe ratio, and store it if it is better than the previous best Sharpe ratios.</li> </ol> <p>Now, let's run the MVO on a weekly basis:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>range_starts</span><span class=p>,</span> <span class=n>range_ends</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>get_index_ranges</span><span class=p>(</span><span class=n>every</span><span class=o>=</span><span class=s2>&quot;W&quot;</span><span class=p>)</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>ann_factor</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s2>&quot;365d&quot;</span><span class=p>)</span> <span class=o>/</span> <span class=n>vbt</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=s2>&quot;1h&quot;</span><span class=p>)</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>init_cash</span> <span class=o>=</span> <span class=mi>100</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>num_tests</span> <span class=o>=</span> <span class=mi>30</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fees</span> <span class=o>=</span> <span class=mf>0.005</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>order_records</span> <span class=o>=</span> <span class=n>optimize_portfolio_nb</span><span class=p>(</span>
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-15-9><a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Open&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-15-10><a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a><span class=gp>... </span>    <span class=n>range_starts</span><span class=p>,</span>
</span><span id=__span-15-11><a id=__codelineno-15-11 name=__codelineno-15-11 href=#__codelineno-15-11></a><span class=gp>... </span>    <span class=n>range_ends</span><span class=p>,</span>
</span><span id=__span-15-12><a id=__codelineno-15-12 name=__codelineno-15-12 href=#__codelineno-15-12></a><span class=gp>... </span>    <span class=n>sharpe_optimize_func_nb</span><span class=p>,</span>
</span><span id=__span-15-13><a id=__codelineno-15-13 name=__codelineno-15-13 href=#__codelineno-15-13></a><span class=gp>... </span>    <span class=n>optimize_args</span><span class=o>=</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> <span class=n>num_tests</span><span class=p>,</span> <span class=n>ann_factor</span><span class=p>),</span>
</span><span id=__span-15-14><a id=__codelineno-15-14 name=__codelineno-15-14 href=#__codelineno-15-14></a><span class=gp>... </span>    <span class=n>fees</span><span class=o>=</span><span class=n>fees</span><span class=p>,</span>
</span><span id=__span-15-15><a id=__codelineno-15-15 name=__codelineno-15-15 href=#__codelineno-15-15></a><span class=gp>... </span>    <span class=n>init_cash</span><span class=o>=</span><span class=n>init_cash</span>
</span><span id=__span-15-16><a id=__codelineno-15-16 name=__codelineno-15-16 href=#__codelineno-15-16></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <p>The result of our optimization is a set of order records, which can be used as input for the <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio>Portfolio</a> class:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=p>(</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=gp>... </span>    <span class=n>wrapper</span><span class=o>=</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>regroup</span><span class=p>(</span><span class=kc>True</span><span class=p>),</span>  <span class=c1># (1)!</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>),</span> 
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=gp>... </span>    <span class=n>order_records</span><span class=o>=</span><span class=n>order_records</span><span class=p>,</span> 
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=gp>... </span>    <span class=n>log_records</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([]),</span>  <span class=c1># (2)!</span>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=gp>... </span>    <span class=n>cash_sharing</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> 
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=gp>... </span>    <span class=n>init_cash</span><span class=o>=</span><span class=n>init_cash</span>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <ol> <li>By using <a href=https://vectorbt.pro/pvt_41531c19/api/base/wrapping/#vectorbtpro.base.wrapping.ArrayWrapper.regroup>ArrayWrapper.regroup</a>, we group all assets together by setting <code>True</code>, putting them in one group.</li> <li>We do not have any log records. If you want logs, you can generate and process them similarly to order records.</li> </ol> <p>Now you can analyze the portfolio as usual!</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>plot_allocations</span><span class=p>()</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/mvo.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/mvo.dark.svg#only-dark></p> <h2 id=bonus-2-parameterization>Bonus 2: Parameterization<a class=headerlink href=#bonus-2-parameterization title="Permanent link">&para;</a></h2> <p>Unlike most of the examples above, our pipeline can process only one parameter combination at a time. To test multiple parameter combinations, you must run it in a loop—either manually or with the special <a href=https://vectorbt.pro/pvt_41531c19/api/utils/params/#vectorbtpro.utils.params.parameterized>parameterized</a> decorator, which magically transforms any Python function into one that can accept arbitrary parameter grids! Behind the scenes, the decorator intercepts each argument passed to the original function and checks if its value, or any nested value, is wrapped with <a href=https://vectorbt.pro/pvt_41531c19/api/utils/params/#vectorbtpro.utils.params.Param>Param</a>. It then broadcasts and builds the Cartesian product of all parameter sequences found, prepares the arguments and keyword arguments for each parameter combination, and forwards those argument sets to the executor function <a href=https://vectorbt.pro/pvt_41531c19/api/utils/execution/#vectorbtpro.utils.execution.execute>execute</a>. This way, the decorator not only manages building the parameter grid, but also handles execution distribution, such as with Dask.</p> <p>Let's test the Cartesian product of different index ranges, test counts, and fees. Since distributed execution returns a list of outputs, the first step is to write a merging function that combines all the results. In this case, each output for a parameter combination is an array of order records, and our target metric is the Sharpe ratio. We will create a portfolio for each set of order records, extract the Sharpe ratios, and concatenate them:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>merge_func</span><span class=p>(</span><span class=n>order_records_list</span><span class=p>,</span> <span class=n>param_index</span><span class=p>):</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=gp>... </span>    <span class=n>sharpe_ratios</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=n>param_index</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>float_</span><span class=p>)</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>order_records</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>order_records_list</span><span class=p>):</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=gp>... </span>        <span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=p>(</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=gp>... </span>            <span class=n>wrapper</span><span class=o>=</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>regroup</span><span class=p>(</span><span class=kc>True</span><span class=p>),</span> 
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a><span class=gp>... </span>            <span class=n>close</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>),</span> 
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a><span class=gp>... </span>            <span class=n>order_records</span><span class=o>=</span><span class=n>order_records</span><span class=p>,</span> 
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a><span class=gp>... </span>            <span class=n>cash_sharing</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> 
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a><span class=gp>... </span>            <span class=n>init_cash</span><span class=o>=</span><span class=n>init_cash</span>
</span><span id=__span-18-10><a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-18-11><a id=__codelineno-18-11 name=__codelineno-18-11 href=#__codelineno-18-11></a><span class=gp>... </span>        <span class=n>sharpe_ratios</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>pf</span><span class=o>.</span><span class=n>sharpe_ratio</span>
</span><span id=__span-18-12><a id=__codelineno-18-12 name=__codelineno-18-12 href=#__codelineno-18-12></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>sharpe_ratios</span>
</span></code></pre></div> <p>The first argument of <code>merge_func</code> is the list of outputs from the original function (<code>optimize_portfolio_nb</code>). Any other argument should be specifically instructed to be passed. The parameter index (<code>param_index</code>) is a special argument containing the multi-index built internally from all parameter combinations, and it will become the index of the resulting Sharpe series.</p> <p>The next step is to decorate the original function with the decorator, which is straightforward:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>param_optimize_portfolio_nb</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>parameterized</span><span class=p>(</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=gp>... </span>    <span class=n>optimize_portfolio_nb</span><span class=p>,</span> 
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=gp>... </span>    <span class=n>merge_func</span><span class=o>=</span><span class=n>merge_func</span><span class=p>,</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=gp>... </span>    <span class=n>merge_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>param_index</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;param_index&quot;</span><span class=p>)),</span>  <span class=c1># (1)!</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=gp>... </span>    <span class=n>engine</span><span class=o>=</span><span class=s2>&quot;dask&quot;</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=gp>... </span>    <span class=n>chunk_len</span><span class=o>=</span><span class=mi>4</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <ol> <li>Instruct the decorator to pass <code>param_index</code> as a keyword argument to <code>merge_func</code>.</li> <li>The parameter combinations are split into chunks of 4, and each chunk is executed with Dask. </li> </ol> <p>Next, we need to prepare our parameter grid. While passing multiple commission and <code>num_tests</code> combinations is straightforward, setting up index ranges requires extra care. Because index ranges cannot be built inside Numba (<a href=https://vectorbt.pro/pvt_41531c19/api/base/wrapping/#vectorbtpro.base.wrapping.ArrayWrapper.get_index_ranges>ArrayWrapper.get_index_ranges</a> is not Numba-compiled), we must loop through each <code>every</code> instruction and manually extract the index ranges. Index ranges consist of two arrays—start and end indices—which are accepted as two different arguments in <code>optimize_portfolio_nb</code>. However, they will appear as a single parameter in the final multi-index because they share the same <code>level</code> in <a href=https://vectorbt.pro/pvt_41531c19/api/utils/params/#vectorbtpro.utils.params.Param>Param</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>every_index</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Index</span><span class=p>([</span><span class=s2>&quot;D&quot;</span><span class=p>,</span> <span class=s2>&quot;W&quot;</span><span class=p>,</span> <span class=s2>&quot;M&quot;</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;every&quot;</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>num_tests_index</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Index</span><span class=p>([</span><span class=mi>30</span><span class=p>,</span> <span class=mi>50</span><span class=p>,</span> <span class=mi>100</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;num_tests&quot;</span><span class=p>)</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fees_index</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Index</span><span class=p>([</span><span class=mf>0.0</span><span class=p>,</span> <span class=mf>0.005</span><span class=p>,</span> <span class=mf>0.01</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;fees&quot;</span><span class=p>)</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>range_starts</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>range_ends</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a><span class=gp>&gt;&gt;&gt; </span><span class=k>for</span> <span class=n>every</span> <span class=ow>in</span> <span class=n>every_index</span><span class=p>:</span>
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a><span class=gp>... </span>    <span class=n>index_ranges</span> <span class=o>=</span> <span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>get_index_ranges</span><span class=p>(</span><span class=n>every</span><span class=o>=</span><span class=n>every</span><span class=p>)</span>
</span><span id=__span-20-9><a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a><span class=gp>... </span>    <span class=n>range_starts</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>index_ranges</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span><span id=__span-20-10><a id=__codelineno-20-10 name=__codelineno-20-10 href=#__codelineno-20-10></a><span class=gp>... </span>    <span class=n>range_ends</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>index_ranges</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span><span id=__span-20-11><a id=__codelineno-20-11 name=__codelineno-20-11 href=#__codelineno-20-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>num_tests</span> <span class=o>=</span> <span class=n>num_tests_index</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span><span id=__span-20-12><a id=__codelineno-20-12 name=__codelineno-20-12 href=#__codelineno-20-12></a>
</span><span id=__span-20-13><a id=__codelineno-20-13 name=__codelineno-20-13 href=#__codelineno-20-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>range_starts</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span><span class=n>range_starts</span><span class=p>,</span> <span class=n>level</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>keys</span><span class=o>=</span><span class=n>every_index</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-20-14><a id=__codelineno-20-14 name=__codelineno-20-14 href=#__codelineno-20-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>range_ends</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span><span class=n>range_ends</span><span class=p>,</span> <span class=n>level</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>keys</span><span class=o>=</span><span class=n>every_index</span><span class=p>)</span>
</span><span id=__span-20-15><a id=__codelineno-20-15 name=__codelineno-20-15 href=#__codelineno-20-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>num_tests</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span><span class=n>num_tests</span><span class=p>,</span> <span class=n>level</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>keys</span><span class=o>=</span><span class=n>num_tests_index</span><span class=p>)</span>
</span><span id=__span-20-16><a id=__codelineno-20-16 name=__codelineno-20-16 href=#__codelineno-20-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>fees</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>(</span><span class=n>fees_index</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> <span class=n>level</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>keys</span><span class=o>=</span><span class=n>fees_index</span><span class=p>)</span>
</span></code></pre></div> <ol> <li>These indexes will become levels in the final multi-index.</li> <li>Make each list an official parameter. The range start and end indices share the same level so they will not be combined.</li> </ol> <p>Finally, pass the prepared arguments to the parameterized function, just as you would to <code>optimize_portfolio_nb</code>!</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sharpe_ratios</span> <span class=o>=</span> <span class=n>param_optimize_portfolio_nb</span><span class=p>(</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Open&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=gp>... </span>    <span class=n>range_starts</span><span class=p>,</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a><span class=gp>... </span>    <span class=n>range_ends</span><span class=p>,</span>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a><span class=gp>... </span>    <span class=n>sharpe_optimize_func_nb</span><span class=p>,</span>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a><span class=gp>... </span>    <span class=n>optimize_args</span><span class=o>=</span><span class=p>(</span>
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a><span class=gp>... </span>        <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
</span><span id=__span-21-9><a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a><span class=gp>... </span>        <span class=n>num_tests</span><span class=p>,</span> 
</span><span id=__span-21-10><a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a><span class=gp>... </span>        <span class=n>ann_factor</span>
</span><span id=__span-21-11><a id=__codelineno-21-11 name=__codelineno-21-11 href=#__codelineno-21-11></a><span class=gp>... </span>    <span class=p>),</span>
</span><span id=__span-21-12><a id=__codelineno-21-12 name=__codelineno-21-12 href=#__codelineno-21-12></a><span class=gp>... </span>    <span class=n>fees</span><span class=o>=</span><span class=n>fees</span><span class=p>,</span>
</span><span id=__span-21-13><a id=__codelineno-21-13 name=__codelineno-21-13 href=#__codelineno-21-13></a><span class=gp>... </span>    <span class=n>init_cash</span><span class=o>=</span><span class=n>init_cash</span><span class=p>,</span>
</span><span id=__span-21-14><a id=__codelineno-21-14 name=__codelineno-21-14 href=#__codelineno-21-14></a><span class=gp>... </span>    <span class=n>group</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;config_idx&quot;</span><span class=p>)</span>
</span><span id=__span-21-15><a id=__codelineno-21-15 name=__codelineno-21-15 href=#__codelineno-21-15></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <p> <div class="progress progress-100plus candystripe candystripe-animate"> <div class=progress-bar style=width:100.00%> <p class=progress-label>Chunk 7/7</p> </div> </div> </p> <p>With Dask, each function call takes about 10 milliseconds!</p> <p>Now, let's examine the generated Sharpe ratios:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sharpe_ratios</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=go>every  num_tests  fees </span>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a><span class=go>D      30         0.000    2.208492</span>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a><span class=go>                  0.005    0.412934</span>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a><span class=go>                  0.010   -1.393060</span>
</span><span id=__span-22-6><a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a><span class=go>       50         0.000    2.305169</span>
</span><span id=__span-22-7><a id=__codelineno-22-7 name=__codelineno-22-7 href=#__codelineno-22-7></a><span class=go>                  0.005    0.396711</span>
</span><span id=__span-22-8><a id=__codelineno-22-8 name=__codelineno-22-8 href=#__codelineno-22-8></a><span class=go>                  0.010   -1.444904</span>
</span><span id=__span-22-9><a id=__codelineno-22-9 name=__codelineno-22-9 href=#__codelineno-22-9></a><span class=go>       100        0.000    2.202177</span>
</span><span id=__span-22-10><a id=__codelineno-22-10 name=__codelineno-22-10 href=#__codelineno-22-10></a><span class=go>                  0.005    0.380674</span>
</span><span id=__span-22-11><a id=__codelineno-22-11 name=__codelineno-22-11 href=#__codelineno-22-11></a><span class=go>                  0.010   -1.824848</span>
</span><span id=__span-22-12><a id=__codelineno-22-12 name=__codelineno-22-12 href=#__codelineno-22-12></a><span class=go>W      30         0.000    2.507784</span>
</span><span id=__span-22-13><a id=__codelineno-22-13 name=__codelineno-22-13 href=#__codelineno-22-13></a><span class=go>                  0.005    2.297914</span>
</span><span id=__span-22-14><a id=__codelineno-22-14 name=__codelineno-22-14 href=#__codelineno-22-14></a><span class=go>                  0.010    1.962726</span>
</span><span id=__span-22-15><a id=__codelineno-22-15 name=__codelineno-22-15 href=#__codelineno-22-15></a><span class=go>       50         0.000    2.358747</span>
</span><span id=__span-22-16><a id=__codelineno-22-16 name=__codelineno-22-16 href=#__codelineno-22-16></a><span class=go>                  0.005    1.940125</span>
</span><span id=__span-22-17><a id=__codelineno-22-17 name=__codelineno-22-17 href=#__codelineno-22-17></a><span class=go>                  0.010    1.736605</span>
</span><span id=__span-22-18><a id=__codelineno-22-18 name=__codelineno-22-18 href=#__codelineno-22-18></a><span class=go>       100        0.000    2.563558</span>
</span><span id=__span-22-19><a id=__codelineno-22-19 name=__codelineno-22-19 href=#__codelineno-22-19></a><span class=go>                  0.005    2.365637</span>
</span><span id=__span-22-20><a id=__codelineno-22-20 name=__codelineno-22-20 href=#__codelineno-22-20></a><span class=go>                  0.010    1.877434</span>
</span><span id=__span-22-21><a id=__codelineno-22-21 name=__codelineno-22-21 href=#__codelineno-22-21></a><span class=go>M      30         0.000    1.514242</span>
</span><span id=__span-22-22><a id=__codelineno-22-22 name=__codelineno-22-22 href=#__codelineno-22-22></a><span class=go>                  0.005    1.606507</span>
</span><span id=__span-22-23><a id=__codelineno-22-23 name=__codelineno-22-23 href=#__codelineno-22-23></a><span class=go>                  0.010    1.859369</span>
</span><span id=__span-22-24><a id=__codelineno-22-24 name=__codelineno-22-24 href=#__codelineno-22-24></a><span class=go>       50         0.000    1.890288</span>
</span><span id=__span-22-25><a id=__codelineno-22-25 name=__codelineno-22-25 href=#__codelineno-22-25></a><span class=go>                  0.005    1.555012</span>
</span><span id=__span-22-26><a id=__codelineno-22-26 name=__codelineno-22-26 href=#__codelineno-22-26></a><span class=go>                  0.010    1.479636</span>
</span><span id=__span-22-27><a id=__codelineno-22-27 name=__codelineno-22-27 href=#__codelineno-22-27></a><span class=go>       100        0.000    1.327935</span>
</span><span id=__span-22-28><a id=__codelineno-22-28 name=__codelineno-22-28 href=#__codelineno-22-28></a><span class=go>                  0.005    1.847109</span>
</span><span id=__span-22-29><a id=__codelineno-22-29 name=__codelineno-22-29 href=#__codelineno-22-29></a><span class=go>                  0.010    1.659961</span>
</span><span id=__span-22-30><a id=__codelineno-22-30 name=__codelineno-22-30 href=#__codelineno-22-30></a><span class=go>dtype: float64</span>
</span></code></pre></div> <p>We could have also stacked all the order records and analyzed them as a single portfolio, but this would require tiling the close price by the number of parameter combinations. This can quickly become memory-intensive, so simple looping is preferred here.</p> <h2 id=bonus-3-hyperopt>Bonus 3: Hyperopt<a class=headerlink href=#bonus-3-hyperopt title="Permanent link">&para;</a></h2> <p>Instead of constructing and testing every combination in the parameter grid, you can use a statistical approach. Libraries like Hyperopt are designed to minimize objective functions.</p> <blockquote> <p><a href=https://github.com/hyperopt/hyperopt>Hyperopt</a> is a Python library for serial and parallel optimization over awkward search spaces, which may include real-valued, discrete, and conditional dimensions.</p> </blockquote> <p>To use Hyperopt, you first need to implement the objective function, which is straightforward in this case:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>objective</span><span class=p>(</span><span class=n>kwargs</span><span class=p>):</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a><span class=gp>... </span>    <span class=n>close_values</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a><span class=gp>... </span>    <span class=n>open_values</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Open&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a><span class=gp>... </span>    <span class=n>index_ranges</span> <span class=o>=</span> <span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>get_index_ranges</span><span class=p>(</span><span class=n>every</span><span class=o>=</span><span class=n>kwargs</span><span class=p>[</span><span class=s2>&quot;every&quot;</span><span class=p>])</span>
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a><span class=gp>... </span>    <span class=n>order_records</span> <span class=o>=</span> <span class=n>optimize_portfolio_nb</span><span class=p>(</span>
</span><span id=__span-23-6><a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a><span class=gp>... </span>        <span class=n>close_values</span><span class=p>,</span>
</span><span id=__span-23-7><a id=__codelineno-23-7 name=__codelineno-23-7 href=#__codelineno-23-7></a><span class=gp>... </span>        <span class=n>open_values</span><span class=p>,</span>
</span><span id=__span-23-8><a id=__codelineno-23-8 name=__codelineno-23-8 href=#__codelineno-23-8></a><span class=gp>... </span>        <span class=n>index_ranges</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>  <span class=c1># (1)!</span>
</span><span id=__span-23-9><a id=__codelineno-23-9 name=__codelineno-23-9 href=#__codelineno-23-9></a><span class=gp>... </span>        <span class=n>index_ranges</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span>  <span class=c1># (2)!</span>
</span><span id=__span-23-10><a id=__codelineno-23-10 name=__codelineno-23-10 href=#__codelineno-23-10></a><span class=gp>... </span>        <span class=n>sharpe_optimize_func_nb</span><span class=p>,</span>
</span><span id=__span-23-11><a id=__codelineno-23-11 name=__codelineno-23-11 href=#__codelineno-23-11></a><span class=gp>... </span>        <span class=n>optimize_args</span><span class=o>=</span><span class=p>(</span><span class=n>close_values</span><span class=p>,</span> <span class=n>kwargs</span><span class=p>[</span><span class=s2>&quot;num_tests&quot;</span><span class=p>],</span> <span class=n>ann_factor</span><span class=p>),</span>
</span><span id=__span-23-12><a id=__codelineno-23-12 name=__codelineno-23-12 href=#__codelineno-23-12></a><span class=gp>... </span>        <span class=n>fees</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>to_2d_array</span><span class=p>(</span><span class=n>kwargs</span><span class=p>[</span><span class=s2>&quot;fees&quot;</span><span class=p>]),</span>
</span><span id=__span-23-13><a id=__codelineno-23-13 name=__codelineno-23-13 href=#__codelineno-23-13></a><span class=gp>... </span>        <span class=n>init_cash</span><span class=o>=</span><span class=n>init_cash</span>
</span><span id=__span-23-14><a id=__codelineno-23-14 name=__codelineno-23-14 href=#__codelineno-23-14></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-23-15><a id=__codelineno-23-15 name=__codelineno-23-15 href=#__codelineno-23-15></a><span class=gp>... </span>    <span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=p>(</span>
</span><span id=__span-23-16><a id=__codelineno-23-16 name=__codelineno-23-16 href=#__codelineno-23-16></a><span class=gp>... </span>        <span class=n>wrapper</span><span class=o>=</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>regroup</span><span class=p>(</span><span class=kc>True</span><span class=p>),</span> 
</span><span id=__span-23-17><a id=__codelineno-23-17 name=__codelineno-23-17 href=#__codelineno-23-17></a><span class=gp>... </span>        <span class=n>close</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>),</span> 
</span><span id=__span-23-18><a id=__codelineno-23-18 name=__codelineno-23-18 href=#__codelineno-23-18></a><span class=gp>... </span>        <span class=n>order_records</span><span class=o>=</span><span class=n>order_records</span><span class=p>,</span> 
</span><span id=__span-23-19><a id=__codelineno-23-19 name=__codelineno-23-19 href=#__codelineno-23-19></a><span class=gp>... </span>        <span class=n>log_records</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([]),</span> 
</span><span id=__span-23-20><a id=__codelineno-23-20 name=__codelineno-23-20 href=#__codelineno-23-20></a><span class=gp>... </span>        <span class=n>cash_sharing</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> 
</span><span id=__span-23-21><a id=__codelineno-23-21 name=__codelineno-23-21 href=#__codelineno-23-21></a><span class=gp>... </span>        <span class=n>init_cash</span><span class=o>=</span><span class=n>init_cash</span>
</span><span id=__span-23-22><a id=__codelineno-23-22 name=__codelineno-23-22 href=#__codelineno-23-22></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-23-23><a id=__codelineno-23-23 name=__codelineno-23-23 href=#__codelineno-23-23></a><span class=gp>... </span>    <span class=k>return</span> <span class=o>-</span><span class=n>pf</span><span class=o>.</span><span class=n>sharpe_ratio</span>  <span class=c1># (3)!</span>
</span></code></pre></div> <ol> <li>Array with range start indices.</li> <li>Array with range end indices.</li> <li>Must be a float-valued function, and you want to <strong>minimize</strong> it.</li> </ol> <p>Next, build the search space:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=gp>&gt;&gt;&gt; </span><span class=kn>from</span><span class=w> </span><span class=nn>hyperopt</span><span class=w> </span><span class=kn>import</span> <span class=n>fmin</span><span class=p>,</span> <span class=n>tpe</span><span class=p>,</span> <span class=n>hp</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>space</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=gp>... </span>    <span class=s2>&quot;every&quot;</span><span class=p>:</span> <span class=n>hp</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=s2>&quot;every&quot;</span><span class=p>,</span> <span class=p>[</span><span class=s2>&quot;</span><span class=si>%d</span><span class=s2>D&quot;</span> <span class=o>%</span> <span class=n>n</span> <span class=k>for</span> <span class=n>n</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>100</span><span class=p>)]),</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a><span class=gp>... </span>    <span class=s2>&quot;num_tests&quot;</span><span class=p>:</span> <span class=n>hp</span><span class=o>.</span><span class=n>quniform</span><span class=p>(</span><span class=s2>&quot;num_tests&quot;</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a><span class=gp>... </span>    <span class=s2>&quot;fees&quot;</span><span class=p>:</span> <span class=n>hp</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=s1>&#39;fees&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mf>0.05</span><span class=p>)</span>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=gp>... </span><span class=p>}</span>
</span></code></pre></div> <p>Finally, search for the best candidate:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>best</span> <span class=o>=</span> <span class=n>fmin</span><span class=p>(</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=gp>... </span>    <span class=n>fn</span><span class=o>=</span><span class=n>objective</span><span class=p>,</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=gp>... </span>    <span class=n>space</span><span class=o>=</span><span class=n>space</span><span class=p>,</span>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a><span class=gp>... </span>    <span class=n>algo</span><span class=o>=</span><span class=n>tpe</span><span class=o>.</span><span class=n>suggest</span><span class=p>,</span>
</span><span id=__span-25-5><a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a><span class=gp>... </span>    <span class=n>max_evals</span><span class=o>=</span><span class=mi>30</span>
</span><span id=__span-25-6><a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-25-7><a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a><span class=go>100%|██████| 30/30 [00:01&lt;00:00, 24.11trial/s, best loss: -2.4913128485273424]</span>
</span><span id=__span-25-8><a id=__codelineno-25-8 name=__codelineno-25-8 href=#__codelineno-25-8></a>
</span><span id=__span-25-9><a id=__codelineno-25-9 name=__codelineno-25-9 href=#__codelineno-25-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>best</span>
</span><span id=__span-25-10><a id=__codelineno-25-10 name=__codelineno-25-10 href=#__codelineno-25-10></a><span class=go>{&#39;every&#39;: 92, &#39;fees&#39;: 0.018781236093979012, &#39;num_tests&#39;: 46.0}</span>
</span></code></pre></div> <p>Here is the <a href=https://github.com/hyperopt/hyperopt/wiki/FMin>official tutorial</a> to help you get started.</p> <h2 id=bonus-4-hybrid>Bonus 4: Hybrid<a class=headerlink href=#bonus-4-hybrid title="Permanent link">&para;</a></h2> <p>We have covered generating weights strictly before and during the simulation, but what about scenarios that fall somewhere in between? For example, how can we use external libraries (which usually cannot be Numba compiled) while still accessing the simulated state, such as the current portfolio value? Disabling Numba entirely and running the external optimization function as part of the simulation would be too slow and would not provide any advantage over using backtrader or other traditional backtesting software. Here is a helpful trick: simulate the portfolio in chunks! For instance, allocate weights, simulate a portfolio over a set period of time, evaluate the portfolio, and repeat. If implemented correctly, the portfolios used for evaluation should closely match the performance of the post-generation portfolio.</p> <p>Let's create an optimization function that allocates equal weights, but only if the current allocation deviates from the target allocation by a specified percentage amount:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>optimize_func</span><span class=p>(</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=gp>... </span>    <span class=n>data</span><span class=p>,</span> 
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a><span class=gp>... </span>    <span class=n>index_slice</span><span class=p>,</span> 
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a><span class=gp>... </span>    <span class=n>temp_allocations</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a><span class=gp>... </span>    <span class=n>temp_pfs</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a><span class=gp>... </span>    <span class=n>threshold</span>
</span><span id=__span-26-7><a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a><span class=gp>... </span><span class=p>):</span>
</span><span id=__span-26-8><a id=__codelineno-26-8 name=__codelineno-26-8 href=#__codelineno-26-8></a><span class=gp>... </span>    <span class=n>sub_data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>index_slice</span><span class=p>]</span>
</span><span id=__span-26-9><a id=__codelineno-26-9 name=__codelineno-26-9 href=#__codelineno-26-9></a><span class=gp>... </span>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>temp_allocations</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>  <span class=c1># (3)!</span>
</span><span id=__span-26-10><a id=__codelineno-26-10 name=__codelineno-26-10 href=#__codelineno-26-10></a><span class=gp>... </span>        <span class=n>prev_allocation</span> <span class=o>=</span> <span class=n>sub_data</span><span class=o>.</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>wrap</span><span class=p>(</span>  <span class=c1># (4)!</span>
</span><span id=__span-26-11><a id=__codelineno-26-11 name=__codelineno-26-11 href=#__codelineno-26-11></a><span class=gp>... </span>            <span class=p>[</span><span class=n>temp_allocations</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]],</span> 
</span><span id=__span-26-12><a id=__codelineno-26-12 name=__codelineno-26-12 href=#__codelineno-26-12></a><span class=gp>... </span>            <span class=n>index</span><span class=o>=</span><span class=n>sub_data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>index</span><span class=p>[[</span><span class=mi>0</span><span class=p>]]</span>
</span><span id=__span-26-13><a id=__codelineno-26-13 name=__codelineno-26-13 href=#__codelineno-26-13></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-26-14><a id=__codelineno-26-14 name=__codelineno-26-14 href=#__codelineno-26-14></a><span class=gp>... </span>        <span class=n>prev_pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_allocations</span><span class=p>(</span>  <span class=c1># (5)!</span>
</span><span id=__span-26-15><a id=__codelineno-26-15 name=__codelineno-26-15 href=#__codelineno-26-15></a><span class=gp>... </span>            <span class=n>sub_data</span><span class=o>.</span><span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-26-16><a id=__codelineno-26-16 name=__codelineno-26-16 href=#__codelineno-26-16></a><span class=gp>... </span>            <span class=n>prev_allocation</span>
</span><span id=__span-26-17><a id=__codelineno-26-17 name=__codelineno-26-17 href=#__codelineno-26-17></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-26-18><a id=__codelineno-26-18 name=__codelineno-26-18 href=#__codelineno-26-18></a><span class=gp>... </span>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>temp_pfs</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-26-19><a id=__codelineno-26-19 name=__codelineno-26-19 href=#__codelineno-26-19></a><span class=gp>... </span>            <span class=n>init_cash</span> <span class=o>=</span> <span class=n>temp_pfs</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>cash</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-26-20><a id=__codelineno-26-20 name=__codelineno-26-20 href=#__codelineno-26-20></a><span class=gp>... </span>            <span class=n>init_position</span> <span class=o>=</span> <span class=n>temp_pfs</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>assets</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-26-21><a id=__codelineno-26-21 name=__codelineno-26-21 href=#__codelineno-26-21></a><span class=gp>... </span>            <span class=n>init_price</span> <span class=o>=</span> <span class=n>temp_pfs</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>close</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-26-22><a id=__codelineno-26-22 name=__codelineno-26-22 href=#__codelineno-26-22></a><span class=gp>... </span>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-26-23><a id=__codelineno-26-23 name=__codelineno-26-23 href=#__codelineno-26-23></a><span class=gp>... </span>            <span class=n>init_cash</span> <span class=o>=</span> <span class=mf>100.</span>
</span><span id=__span-26-24><a id=__codelineno-26-24 name=__codelineno-26-24 href=#__codelineno-26-24></a><span class=gp>... </span>            <span class=n>init_position</span> <span class=o>=</span> <span class=mf>0.</span>
</span><span id=__span-26-25><a id=__codelineno-26-25 name=__codelineno-26-25 href=#__codelineno-26-25></a><span class=gp>... </span>            <span class=n>init_price</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span>
</span><span id=__span-26-26><a id=__codelineno-26-26 name=__codelineno-26-26 href=#__codelineno-26-26></a><span class=gp>... </span>        <span class=n>prev_pf</span> <span class=o>=</span> <span class=n>prev_pfo</span><span class=o>.</span><span class=n>simulate</span><span class=p>(</span>  <span class=c1># (6)!</span>
</span><span id=__span-26-27><a id=__codelineno-26-27 name=__codelineno-26-27 href=#__codelineno-26-27></a><span class=gp>... </span>            <span class=n>sub_data</span><span class=p>,</span>
</span><span id=__span-26-28><a id=__codelineno-26-28 name=__codelineno-26-28 href=#__codelineno-26-28></a><span class=gp>... </span>            <span class=n>init_cash</span><span class=o>=</span><span class=n>init_cash</span><span class=p>,</span> 
</span><span id=__span-26-29><a id=__codelineno-26-29 name=__codelineno-26-29 href=#__codelineno-26-29></a><span class=gp>... </span>            <span class=n>init_position</span><span class=o>=</span><span class=n>init_position</span><span class=p>,</span>
</span><span id=__span-26-30><a id=__codelineno-26-30 name=__codelineno-26-30 href=#__codelineno-26-30></a><span class=gp>... </span>            <span class=n>init_price</span><span class=o>=</span><span class=n>init_price</span>
</span><span id=__span-26-31><a id=__codelineno-26-31 name=__codelineno-26-31 href=#__codelineno-26-31></a><span class=gp>... </span>        <span class=p>)</span>
</span><span id=__span-26-32><a id=__codelineno-26-32 name=__codelineno-26-32 href=#__codelineno-26-32></a><span class=gp>... </span>        <span class=n>temp_pfs</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>prev_pf</span><span class=p>)</span>
</span><span id=__span-26-33><a id=__codelineno-26-33 name=__codelineno-26-33 href=#__codelineno-26-33></a><span class=gp>... </span>        <span class=n>should_rebalance</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-26-34><a id=__codelineno-26-34 name=__codelineno-26-34 href=#__codelineno-26-34></a><span class=gp>... </span>        <span class=n>curr_alloc</span> <span class=o>=</span> <span class=n>prev_pf</span><span class=o>.</span><span class=n>allocations</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span><span id=__span-26-35><a id=__codelineno-26-35 name=__codelineno-26-35 href=#__codelineno-26-35></a><span class=gp>... </span>        <span class=k>if</span> <span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>curr_alloc</span> <span class=o>-</span> <span class=n>temp_allocations</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span> <span class=o>&gt;=</span> <span class=n>threshold</span><span class=p>)</span><span class=o>.</span><span class=n>any</span><span class=p>():</span>
</span><span id=__span-26-36><a id=__codelineno-26-36 name=__codelineno-26-36 href=#__codelineno-26-36></a><span class=gp>... </span>            <span class=n>should_rebalance</span> <span class=o>=</span> <span class=kc>True</span>  <span class=c1># (7)!</span>
</span><span id=__span-26-37><a id=__codelineno-26-37 name=__codelineno-26-37 href=#__codelineno-26-37></a><span class=gp>... </span>    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-26-38><a id=__codelineno-26-38 name=__codelineno-26-38 href=#__codelineno-26-38></a><span class=gp>... </span>        <span class=n>should_rebalance</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-26-39><a id=__codelineno-26-39 name=__codelineno-26-39 href=#__codelineno-26-39></a><span class=gp>... </span>    <span class=n>n_symbols</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>sub_data</span><span class=o>.</span><span class=n>symbols</span><span class=p>)</span>
</span><span id=__span-26-40><a id=__codelineno-26-40 name=__codelineno-26-40 href=#__codelineno-26-40></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>should_rebalance</span><span class=p>:</span>
</span><span id=__span-26-41><a id=__codelineno-26-41 name=__codelineno-26-41 href=#__codelineno-26-41></a><span class=gp>... </span>        <span class=n>new_alloc</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>n_symbols</span><span class=p>,</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>n_symbols</span><span class=p>)</span>  <span class=c1># (8)!</span>
</span><span id=__span-26-42><a id=__codelineno-26-42 name=__codelineno-26-42 href=#__codelineno-26-42></a><span class=gp>... </span>    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-26-43><a id=__codelineno-26-43 name=__codelineno-26-43 href=#__codelineno-26-43></a><span class=gp>... </span>        <span class=n>new_alloc</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>n_symbols</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>  <span class=c1># (9)!</span>
</span><span id=__span-26-44><a id=__codelineno-26-44 name=__codelineno-26-44 href=#__codelineno-26-44></a><span class=gp>... </span>    <span class=n>temp_allocations</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>new_alloc</span><span class=p>)</span>
</span><span id=__span-26-45><a id=__codelineno-26-45 name=__codelineno-26-45 href=#__codelineno-26-45></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>new_alloc</span>
</span><span id=__span-26-46><a id=__codelineno-26-46 name=__codelineno-26-46 href=#__codelineno-26-46></a>
</span><span id=__span-26-47><a id=__codelineno-26-47 name=__codelineno-26-47 href=#__codelineno-26-47></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfs</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-26-48><a id=__codelineno-26-48 name=__codelineno-26-48 href=#__codelineno-26-48></a><span class=gp>&gt;&gt;&gt; </span><span class=n>allocations</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-26-49><a id=__codelineno-26-49 name=__codelineno-26-49 href=#__codelineno-26-49></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfopt</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_optimize_func</span><span class=p>(</span>
</span><span id=__span-26-50><a id=__codelineno-26-50 name=__codelineno-26-50 href=#__codelineno-26-50></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-26-51><a id=__codelineno-26-51 name=__codelineno-26-51 href=#__codelineno-26-51></a><span class=gp>... </span>    <span class=n>optimize_func</span><span class=p>,</span>
</span><span id=__span-26-52><a id=__codelineno-26-52 name=__codelineno-26-52 href=#__codelineno-26-52></a><span class=gp>... </span>    <span class=n>data</span><span class=p>,</span>
</span><span id=__span-26-53><a id=__codelineno-26-53 name=__codelineno-26-53 href=#__codelineno-26-53></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;index_slice&quot;</span><span class=p>),</span>
</span><span id=__span-26-54><a id=__codelineno-26-54 name=__codelineno-26-54 href=#__codelineno-26-54></a><span class=gp>... </span>    <span class=n>allocations</span><span class=p>,</span>
</span><span id=__span-26-55><a id=__codelineno-26-55 name=__codelineno-26-55 href=#__codelineno-26-55></a><span class=gp>... </span>    <span class=n>pfs</span><span class=p>,</span>
</span><span id=__span-26-56><a id=__codelineno-26-56 name=__codelineno-26-56 href=#__codelineno-26-56></a><span class=gp>... </span>    <span class=mf>0.03</span><span class=p>,</span>  <span class=c1># (10)!</span>
</span><span id=__span-26-57><a id=__codelineno-26-57 name=__codelineno-26-57 href=#__codelineno-26-57></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=s2>&quot;W&quot;</span>
</span><span id=__span-26-58><a id=__codelineno-26-58 name=__codelineno-26-58 href=#__codelineno-26-58></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-26-59><a id=__codelineno-26-59 name=__codelineno-26-59 href=#__codelineno-26-59></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>pfopt</span><span class=o>.</span><span class=n>simulate</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></code></pre></div> <ol> <li>Temporary list with previous target allocations. An allocation is generated each week and appended to this list, so next time we can compare it with the actual allocation.</li> <li>Temporary list with previous portfolios. A portfolio is generated each week and added to this list, so the next portfolio knows where to start from.</li> <li>If this data window had any allocation, we need to simulate it.</li> <li>Get the allocation from the previous <code>optimize_func</code> call.</li> <li>Create a small portfolio optimizer that allocates at the start of this data window, only once.</li> <li>Simulate the optimizer using the last metrics of the previous portfolio as initial metrics. This way, this portfolio will continue from the point where the previous portfolio ended.</li> <li>Check whether any of the actual and target allocations deviate sufficiently.</li> <li>If yes, re-allocate equally.</li> <li>If not, do not re-allocate at all.</li> <li>Test with a threshold of 3%.</li> </ol> <p>How can we ensure that all the used sub-portfolios closely match reality? Let's compare the final value of each sub-portfolio to the corresponding value in the monolithic portfolio:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>final_values</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=o>.</span><span class=n>value</span><span class=p>[[</span><span class=o>-</span><span class=mi>1</span><span class=p>]],</span> <span class=n>pfs</span><span class=p>))</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>final_values</span>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=go>Open time</span>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=go>2020-01-18 23:00:00+00:00    117.448601</span>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=go>2020-01-25 23:00:00+00:00    109.741201</span>
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a><span class=go>2020-02-01 23:00:00+00:00    126.428241</span>
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a><span class=go>2020-02-08 23:00:00+00:00    143.399207</span>
</span><span id=__span-27-8><a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a><span class=go>2020-02-15 23:00:00+00:00    157.673925</span>
</span><span id=__span-27-9><a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a><span class=go>                                    ...</span>
</span><span id=__span-27-10><a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a><span class=go>2020-11-28 23:00:00+00:00    306.180144</span>
</span><span id=__span-27-11><a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a><span class=go>2020-12-05 23:00:00+00:00    312.231039</span>
</span><span id=__span-27-12><a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a><span class=go>2020-12-12 23:00:00+00:00    289.465806</span>
</span><span id=__span-27-13><a id=__codelineno-27-13 name=__codelineno-27-13 href=#__codelineno-27-13></a><span class=go>2020-12-19 23:00:00+00:00    338.756466</span>
</span><span id=__span-27-14><a id=__codelineno-27-14 name=__codelineno-27-14 href=#__codelineno-27-14></a><span class=go>2020-12-26 23:00:00+00:00    313.229099</span>
</span><span id=__span-27-15><a id=__codelineno-27-15 name=__codelineno-27-15 href=#__codelineno-27-15></a><span class=go>Name: group, dtype: float64</span>
</span><span id=__span-27-16><a id=__codelineno-27-16 name=__codelineno-27-16 href=#__codelineno-27-16></a>
</span><span id=__span-27-17><a id=__codelineno-27-17 name=__codelineno-27-17 href=#__codelineno-27-17></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pd</span><span class=o>.</span><span class=n>testing</span><span class=o>.</span><span class=n>assert_series_equal</span><span class=p>(</span>  <span class=c1># (1)!</span>
</span><span id=__span-27-18><a id=__codelineno-27-18 name=__codelineno-27-18 href=#__codelineno-27-18></a><span class=gp>... </span>    <span class=n>final_values</span><span class=p>,</span>
</span><span id=__span-27-19><a id=__codelineno-27-19 name=__codelineno-27-19 href=#__codelineno-27-19></a><span class=gp>... </span>    <span class=n>pf</span><span class=o>.</span><span class=n>value</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>final_values</span><span class=o>.</span><span class=n>index</span><span class=p>],</span>
</span><span id=__span-27-20><a id=__codelineno-27-20 name=__codelineno-27-20 href=#__codelineno-27-20></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <ol> <li>If the two series were not equal, an error would be raised.</li> </ol> <p>Perfect match! <img alt=⛳ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26f3.svg title=:golf:></p> <h2 id=summary>Summary<a class=headerlink href=#summary title="Permanent link">&para;</a></h2> <p>Regular portfolio reviews allow us to make adjustments and increase our chances of achieving comfortable returns while maintaining our preferred level of risk. Diversification across asset classes is a risk-mitigation strategy, especially when spreading investments across a variety of asset classes. With VBT, we have powerful tools to programmatically select optimal portfolios. Not only are there tools that work well with third-party libraries, but there is also a universe of options for easily implementing and testing any custom optimization strategy, especially when leveraging acceleration, such as compilation with Numba.</p> <p>As we saw in these examples, VBT encourages us to use data science and to look at portfolio optimization from new angles to better understand how it influences results. For example, we can use the <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer>PortfolioOptimizer</a> class to quickly tune various parameters for weight generation and rebalancing schedules. Once we are satisfied with the pre-analysis, we can feed the optimizer into a simulator to analyze the chosen strategy after execution. Or, we can choose to implement our own optimizer from scratch to control the entire execution process. In this case, we can extract target allocations and other metadata during the simulation and analyze them later. There are so many possibilities... <img alt=💭 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f4ad.svg title=:thought_balloon:></p> <p><a class=md-button href=https://vectorbt.pro/pvt_41531c19/assets/jupytext/tutorials/portfolio-optimization/dynamic.py.txt target=blank_><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19.14 7.5A2.86 2.86 0 0 1 22 10.36v3.78A2.86 2.86 0 0 1 19.14 17H12c0 .39.32.96.71.96H17v1.68a2.86 2.86 0 0 1-2.86 2.86H9.86A2.86 2.86 0 0 1 7 19.64v-3.75a2.85 2.85 0 0 1 2.86-2.85h5.25a2.85 2.85 0 0 0 2.85-2.86V7.5zm-4.28 11.79c-.4 0-.72.3-.72.89s.32.71.72.71a.71.71 0 0 0 .71-.71c0-.59-.32-.89-.71-.89m-10-1.79A2.86 2.86 0 0 1 2 14.64v-3.78A2.86 2.86 0 0 1 4.86 8H12c0-.39-.32-.96-.71-.96H7V5.36A2.86 2.86 0 0 1 9.86 2.5h4.28A2.86 2.86 0 0 1 17 5.36v3.75a2.85 2.85 0 0 1-2.86 2.85H8.89a2.85 2.85 0 0 0-2.85 2.86v2.68zM9.14 5.71c.4 0 .72-.3.72-.89s-.32-.71-.72-.71c-.39 0-.71.12-.71.71s.32.89.71.89"/></svg></span> Python code</a> <a class=md-button href=https://github.com/polakowo/vectorbt.pro/blob/notebooks/PortfolioOptimization.ipynb target=blank_><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 4v6l-2-2-2 2V4H9v16h10V4zM3 7V5h2V4a2 2 0 0 1 2-2h12c1.05 0 2 .95 2 2v16c0 1.05-.95 2-2 2H7c-1.05 0-2-.95-2-2v-1H3v-2h2v-4H3v-2h2V7zm2-2v2h2V5zm0 14h2v-2H5zm0-6h2v-2H5z"/></svg></span> Notebook</a></p> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/portfolio-optimization/integrations/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Integrations"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Integrations </div> </div> </a> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/pairs-trading/ class="md-footer__link md-footer__link--next" aria-label="Next: Pairs trading"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Pairs trading </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2021-2025 Oleg Polakow. All rights reserved. </div> </div> <div class=md-social> <a href=https://www.linkedin.com/in/polakowo target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> <a href=https://github.com/polakowo target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <div class=md-consent data-md-component=consent id=__consent hidden> <div class=md-consent__overlay></div> <aside class=md-consent__inner> <form class="md-consent__form md-grid md-typeset" name=consent> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class=md-toggle type=checkbox id=__settings> <div class=md-consent__settings> <ul class=task-list> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=analytics checked> <span class=task-list-indicator></span> Google Analytics </label> </li> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=github checked> <span class=task-list-indicator></span> GitHub </label> </li> </ul> </div> <div class=md-consent__controls> <button class="md-button md-button--primary">Accept</button> <label class=md-button for=__settings>Manage settings</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script> <script id=__config type=application/json>{"annotate": null, "base": "../../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.instant", "navigation.instant.progress", "navigation.top", "navigation.prune", "navigation.path", "navigation.footer", "search.suggest", "search.share", "content.code.annotate", "content.code.copy", "content.code.select", "content.tooltips", "content.tabs.link", "toc.follow", "toc.integrate", "announce.dismiss"], "search": "../../../assets/javascripts/workers/search.26099bd0.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=https://vectorbt.pro/pvt_41531c19/assets/javascripts/bundle.9d1edc04.min.js></script> <script src=https://vectorbt.pro/pvt_41531c19/assets/scripts/extra.js></script> <script src=https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js></script> </body> 
<!-- Mirrored from vectorbt.pro/pvt_41531c19/tutorials/portfolio-optimization/dynamic/ by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 22 Nov 2025 03:46:58 GMT -->
</html>