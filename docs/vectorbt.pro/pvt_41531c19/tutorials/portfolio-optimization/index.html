<!doctype html><html lang=en class=no-js> 
<!-- Mirrored from vectorbt.pro/pvt_41531c19/tutorials/portfolio-optimization/ by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 22 Nov 2025 03:47:00 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Learn about portfolio optimization in VectorBT PRO"><meta name=author content="Oleg Polakow"><link href=https://vectorbt.pro/tutorials/portfolio-optimization/ rel=canonical><link href=../mtf-analysis/aggregation/index.html rel=prev><link href=integrations/index.html rel=next><link rel=icon href=../../assets/logo/favicon.png><meta name=generator content="mkdocs-1.6.0, mkdocs-material-9.6.21+insiders-4.53.17"><title>Portfolio optimization - VectorBT® PRO</title><link rel=stylesheet href=../../assets/stylesheets/main.010a373c.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=../../../../fonts.gstatic.com/index.html crossorigin><link rel=stylesheet href="../../../../fonts.googleapis.com/cssbe43.css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../assets/stylesheets/extra.css><link rel=stylesheet href=../../assets/stylesheets/custom-light.css><link rel=stylesheet href=../../assets/stylesheets/custom-dark.css><link rel=stylesheet href=../../assets/stylesheets/pygments-light.css><link rel=stylesheet href=../../assets/stylesheets/pygments-dark.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-0C5VNYCFHL"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-0C5VNYCFHL",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="../../../../www.googletagmanager.com/gtag/jsc6c8?id=G-0C5VNYCFHL",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script><meta name=robots content="noindex, nofollow"><meta property=og:title content="Portfolio optimization"><meta property=og:type content=website><meta content=https://vectorbt.pro/tutorials/portfolio-optimization/ property=og:url><meta property=og:image:url content=https://vectorbt.pro/pvt_41531c19/assets/logo/social-new.png><meta property=og:image:type content=image/png><meta property=og:description content="Learn about portfolio optimization in VectorBT PRO"><meta property=og:locale content=en-GB><link rel=apple-touch-icon sizes=180x180 href=https://vectorbt.pro/pvt_41531c19/assets/logo/apple-touch-icon.png><link rel=icon type=image/svg+xml href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon.svg><link rel=icon type=image/png sizes=32x32 href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon-16x16.png><link rel=manifest href=https://vectorbt.pro/pvt_41531c19/assets/logo/site.webmanifest><link rel=mask-icon href=https://vectorbt.pro/pvt_41531c19/assets/logo/safari-pinned-tab.svg color=#1e1f22><link rel="shortcut icon" href=https://vectorbt.pro/pvt_41531c19/assets/logo/favicon.ico><meta name=msapplication-TileColor content=#1e1f22><meta name=msapplication-config content=https://vectorbt.pro/pvt_41531c19/assets/logo/browserconfig.xml><meta name=theme-color content=#1e1f22><link href=https://unpkg.com/aos@2.3.4/dist/aos.css rel=stylesheet><script src=https://unpkg.com/aos@2.3.4/dist/aos.js></script><link href=http://fonts.cdnfonts.com/css/uni-neue rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/js/all.min.js integrity="sha512-8pHNiqTlsrRjVD4A/3va++W1sMbUHwWxxRPWNyVlql3T+Hgfd81Qc6FC5WMXDC+tSauxxzp1tgiAvSKFu1qIlA==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js integrity="sha512-q583ppKrCRc7N5O0n2nzUiJ+suUv7Et1JGels4bXOaMFQcamPk9HjdUknZuuFjBNs7tsMuadge5k9RzdmO+1GQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><link rel=preconnect href=https://fonts.googleapis.com/><link rel=preconnect href=https://fonts.gstatic.com/ crossorigin></head> <body dir=ltr data-md-color-scheme=custom-dark data-md-color-primary=custom-dark data-md-color-accent=custom-dark> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#portfolio-optimization class=md-skip> Skip to content </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> <button class="md-banner__button md-icon" aria-label="Don't show this again"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> <i>What's new</i>: New LLM providers, reasoning steps, function calling, YAML & TOML support, and <a href=https://vectorbt.pro/pvt_41531c19/getting-started/release-notes><strong>more</strong></a> <span class="twemoji announce-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m153.6 29.9 16-21.3c4-5.4 10.4-8.6 17.1-8.6C198.4 0 208 9.6 208 21.3v22.1c0 13.1 5.4 25.7 14.9 34.7l84.7 80.9c48.8 46.6 76.4 111.2 76.4 178.7C384 434 306 512 209.7 512H192C86 512 0 426 0 320v-3.8c0-48.8 19.4-95.6 53.9-130.1l3.5-3.5c4.2-4.2 10-6.6 16-6.6 12.5 0 22.6 10.1 22.6 22.6V288c0 35.3 28.7 64 64 64s64-28.7 64-64v-3.9c0-18-7.2-35.3-19.9-48l-38.6-38.6c-24-24-37.5-56.7-37.5-90.7 0-27.7 9-54.8 25.6-76.9"/></svg></span> </div> <script>var el=document.querySelector("[data-md-component=announce]");if(el){var content=el.querySelector(".md-typeset");__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0)}</script> </aside> </div> <!-- Determine class according to configuration --> <!-- Header --> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=header.title> <!-- Link to home --> <a href=https://vectorbt.pro/pvt_41531c19/ title="VectorBT® PRO" class="md-header__button md-logo" aria-label="VectorBT® PRO" data-md-component=logo> <img src=https://vectorbt.pro/pvt_41531c19/assets/logo/logo.svg alt=logo class=logo> </a> <!-- Button to open drawer --> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <!-- Header title --> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> VectorBT® PRO <span class=md-version> v2025.10.15 </span> <span class=unlock-icon><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M192 32c-35.3 0-64 28.7-64 64v64h192c35.3 0 64 28.7 64 64v224c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V224c0-35.3 28.7-64 64-64V96c0-70.7 57.3-128 128-128 63.5 0 116.1 46.1 126.2 106.7 2.9 17.4-8.8 33.9-26.3 36.9S258 102.8 255 85.3C250 55.1 223.7 32 192 32m40 328c13.3 0 24-10.7 24-24s-10.7-24-24-24h-80c-13.3 0-24 10.7-24 24s10.7 24 24 24z"/></svg></span> </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Portfolio optimization </span> </div> </div> </div> <!-- Color palette --> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=custom-dark data-md-color-primary=custom-dark data-md-color-accent=custom-dark aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=custom-light data-md-color-primary=custom-light data-md-color-accent=custom-light aria-label="Switch to dark mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <!-- Site language selector --> <!-- Button to open search modal --> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <!-- Search interface --> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <!-- Repository information --> <div class=md-header__source> <a href=https://github.com/polakowo/vectorbt.pro title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> vectorbt.pro </div> </a> </div> </nav> <!-- Navigation tabs (sticky) --> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/ class=md-tabs__link> Getting started </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/features/overview/ class=md-tabs__link> Features </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/overview/ class=md-tabs__link> Tutorials </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/documentation/overview/ class=md-tabs__link> Documentation </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/overview/ class=md-tabs__link> Cookbook </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/api/ class=md-tabs__link> API </a> </li> <li class=md-tabs__item> <a href=https://vectorbt.pro/pvt_41531c19/terms/terms-of-use/ class=md-tabs__link> Terms </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://vectorbt.pro/pvt_41531c19/ title="VectorBT® PRO" class="md-nav__button md-logo" aria-label="VectorBT® PRO" data-md-component=logo> <img src=https://vectorbt.pro/pvt_41531c19/assets/logo/logo.svg alt=logo class=logo> </a> VectorBT® PRO </label> <div class=md-nav__source> <a href=https://github.com/polakowo/vectorbt.pro title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> vectorbt.pro </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/ class=md-nav__link> <span class=md-ellipsis> Getting started </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/features/overview/ class=md-nav__link> <span class=md-ellipsis> Features </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Tutorials </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Tutorials </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/overview/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/basic-rsi/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m3.5 18.5 6-6 4 4L22 6.92 20.59 5.5l-7.09 8-4-4L2 17z"/></svg> <span class=md-ellipsis> Basic RSI strategy </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/superfast-supertrend/ class=md-nav__link> <span class=md-ellipsis> SuperFast SuperTrend </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/signal-development/generation/ class=md-nav__link> <span class=md-ellipsis> Signal development </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/stop-signals/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 23h-2V1h2zm-4-4H5V5h4V3H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h4zM19 7v2h2V7zm0-2h2a2 2 0 0 0-2-2zm2 10h-2v2h2zm-2-4v2h2v-2zm-2-8h-2v2h2zm2 18c1.11 0 2-.89 2-2h-2zm-2-2h-2v2h2z"/></svg> <span class=md-ellipsis> Stop signals </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/mtf-analysis/ class=md-nav__link> <span class=md-ellipsis> MTF analysis </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_7 checked> <label class=md-nav__link for=__nav_3_7 id=__nav_3_7_label tabindex=0> <span class=md-ellipsis> Portfolio optimization </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_7_label aria-expanded=true> <label class=md-nav__title for=__nav_3_7> <span class="md-nav__icon md-icon"></span> Portfolio optimization </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22 21H2V3h2v16h2v-2h4v2h2v-3h4v3h2v-2h4zm-4-7h4v2h-4zm-6-8h4v3h-4zm4 9h-4v-5h4zM6 10h4v2H6zm4 6H6v-3h4z"/></svg> <span class=md-ellipsis> Portfolio optimization </span> <span class="md-nav__icon md-icon"></span> </label> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/portfolio-optimization/ class="md-nav__link md-nav__link--active"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22 21H2V3h2v16h2v-2h4v2h2v-3h4v3h2v-2h4zm-4-7h4v2h-4zm-6-8h4v3h-4zm4 9h-4v-5h4zM6 10h4v2H6zm4 6H6v-3h4z"/></svg> <span class=md-ellipsis> Portfolio optimization </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#data class=md-nav__link> <span class=md-ellipsis> Data </span> </a> </li> <li class=md-nav__item> <a href=#allocation class=md-nav__link> <span class=md-ellipsis> Allocation </span> </a> <nav class=md-nav aria-label=Allocation> <ul class=md-nav__list> <li class=md-nav__item> <a href=#manually class=md-nav__link> <span class=md-ellipsis> Manually </span> </a> <nav class=md-nav aria-label=Manually> <ul class=md-nav__list> <li class=md-nav__item> <a href=#index-points class=md-nav__link> <span class=md-ellipsis> Index points </span> </a> </li> <li class=md-nav__item> <a href=#filling class=md-nav__link> <span class=md-ellipsis> Filling </span> </a> </li> <li class=md-nav__item> <a href=#simulation class=md-nav__link> <span class=md-ellipsis> Simulation </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#allocation-method class=md-nav__link> <span class=md-ellipsis> Allocation method </span> </a> <nav class=md-nav aria-label="Allocation method"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#once class=md-nav__link> <span class=md-ellipsis> Once </span> </a> </li> <li class=md-nav__item> <a href=#custom-array class=md-nav__link> <span class=md-ellipsis> Custom array </span> </a> </li> <li class=md-nav__item> <a href=#templates class=md-nav__link> <span class=md-ellipsis> Templates </span> </a> </li> <li class=md-nav__item> <a href=#groups class=md-nav__link> <span class=md-ellipsis> Groups </span> </a> </li> <li class=md-nav__item> <a href=#numba class=md-nav__link> <span class=md-ellipsis> Numba </span> </a> </li> <li class=md-nav__item> <a href=#distribution class=md-nav__link> <span class=md-ellipsis> Distribution </span> </a> </li> <li class=md-nav__item> <a href=#previous-allocation class=md-nav__link> <span class=md-ellipsis> Previous allocation </span> </a> </li> <li class=md-nav__item> <a href=#current-allocation class=md-nav__link> <span class=md-ellipsis> Current allocation </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#optimization class=md-nav__link> <span class=md-ellipsis> Optimization </span> </a> <nav class=md-nav aria-label=Optimization> <ul class=md-nav__list> <li class=md-nav__item> <a href=#index-ranges class=md-nav__link> <span class=md-ellipsis> Index ranges </span> </a> </li> <li class=md-nav__item> <a href=#optimization-method class=md-nav__link> <span class=md-ellipsis> Optimization method </span> </a> <nav class=md-nav aria-label="Optimization method"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#waiting class=md-nav__link> <span class=md-ellipsis> Waiting </span> </a> </li> <li class=md-nav__item> <a href=#numba_1 class=md-nav__link> <span class=md-ellipsis> Numba </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/portfolio-optimization/integrations/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22 21H2V3h2v16h2v-2h4v2h2v-3h4v3h2v-2h4zm-4-7h4v2h-4zm-6-8h4v3h-4zm4 9h-4v-5h4zM6 10h4v2H6zm4 6H6v-3h4z"/></svg> <span class=md-ellipsis> Integrations </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/portfolio-optimization/dynamic/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22 21H2V3h2v16h2v-2h4v2h2v-3h4v3h2v-2h4zm-4-7h4v2h-4zm-6-8h4v3h-4zm4 9h-4v-5h4zM6 10h4v2H6zm4 6H6v-3h4z"/></svg> <span class=md-ellipsis> Dynamic </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/pairs-trading/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22 6.92 20.59 5.5l-2.85 3.22C15.68 6.4 12.83 5 9.61 5 6.72 5 4.07 6.16 2 8l1.42 1.42C5.12 7.93 7.27 7 9.61 7c2.74 0 5.09 1.26 6.77 3.24L13.5 13.5l-4-4L2 17l1.5 1.5 6-6 4 4 4.05-4.57c.75 1.35 1.25 2.9 1.45 4.57h2c-.22-2.32-.95-4.41-2.04-6.16z"/></svg> <span class=md-ellipsis> Pairs trading </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/patterns-and-projections/patterns/ class=md-nav__link> <span class=md-ellipsis> Patterns and projections </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/cross-validation/ class=md-nav__link> <span class=md-ellipsis> Cross-validation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/more-tutorials/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10.6 13.4a1 1 0 0 1-1.4 1.4 4.8 4.8 0 0 1 0-7l3.5-3.6a5.1 5.1 0 0 1 7.1 0 5.1 5.1 0 0 1 0 7.1l-1.5 1.5a6.4 6.4 0 0 0-.4-2.4l.5-.5a3.2 3.2 0 0 0 0-4.3 3.2 3.2 0 0 0-4.3 0l-3.5 3.6a2.9 2.9 0 0 0 0 4.2M23 18v2h-3v3h-2v-3h-3v-2h3v-3h2v3m-3.8-4.3a4.8 4.8 0 0 0-1.4-4.5 1 1 0 0 0-1.4 1.4 2.9 2.9 0 0 1 0 4.2l-3.5 3.6a3.2 3.2 0 0 1-4.3 0 3.2 3.2 0 0 1 0-4.3l.5-.4a7.3 7.3 0 0 1-.4-2.5l-1.5 1.5a5.1 5.1 0 0 0 0 7.1 5.1 5.1 0 0 0 7.1 0l1.8-1.8a6 6 0 0 1 3.1-4.3"/></svg> <span class=md-ellipsis> More tutorials </span> </a> </li> <li class=md-nav__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/to-be-continued/ class=md-nav__link> <span class=md-ellipsis> To be continued... </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/documentation/overview/ class=md-nav__link> <span class=md-ellipsis> Documentation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/cookbook/overview/ class=md-nav__link> <span class=md-ellipsis> Cookbook </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/api/ class=md-nav__link> <span class=md-ellipsis> API </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://vectorbt.pro/pvt_41531c19/terms/terms-of-use/ class=md-nav__link> <span class=md-ellipsis> Terms </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <nav class=md-path aria-label=Navigation> <ol class=md-path__list> <li class=md-path__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/overview/ class=md-path__link> <span class=md-ellipsis> Tutorials </span> </a> </li> <li class=md-path__item> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/portfolio-optimization/ class=md-path__link> <span class=md-ellipsis> Portfolio optimization </span> </a> </li> </ol> </nav> <article class="md-content__inner md-typeset"> <h1 id=portfolio-optimization><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22 21H2V3h2v16h2v-2h4v2h2v-3h4v3h2v-2h4zm-4-7h4v2h-4zm-6-8h4v3h-4zm4 9h-4v-5h4zM6 10h4v2H6zm4 6H6v-3h4z"/></svg></span> Portfolio optimization<a class=headerlink href=#portfolio-optimization title="Permanent link">&para;</a></h1> <p>Portfolio optimization focuses on constructing a portfolio of assets that seeks to maximize returns and minimize risk. In this context, a portfolio refers to the distribution of an investor's assets—a weight vector—which can be optimized for risk tolerance, expected rate of return, cost minimization, and other objectives. This optimization can be performed regularly to reflect recent changes in market behavior.</p> <p>In VBT, a portfolio is a collection of asset vectors combined into a larger array along the column axis. By default, each of these vectors is treated as a separate backtesting instance, but you can apply a grouping instruction to treat multiple assets as a single unit. Portfolio optimization then becomes the process of converting a set of pricing vectors (information as input) into a set of allocation vectors (actions as output), which can then be provided to any simulator.</p> <p>Thanks to VBT's modular design (and in line with the key principles of data science), optimization and simulation are handled separately. This enables you to analyze and filter allocation vectors even before they are backtested. This approach is similar to the typical workflow for working with signals: 1) generate, 2) pre-analyze, 3) simulate, and 4) post-analyze. In this example, we will cover how to complete each of these steps for the highest informational yield.</p> <h2 id=data>Data<a class=headerlink href=#data title="Permanent link">&para;</a></h2> <p>As always, we should begin by obtaining some data. Because portfolio optimization involves working with a group of assets, we need to fetch data for more than one symbol. Here, we will fetch one year of hourly data for 5 different cryptocurrencies:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=kn>from</span><span class=w> </span><span class=nn>vectorbtpro</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>BinanceData</span><span class=o>.</span><span class=n>pull</span><span class=p>(</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=p>[</span><span class=s2>&quot;BTCUSDT&quot;</span><span class=p>,</span> <span class=s2>&quot;ETHUSDT&quot;</span><span class=p>,</span> <span class=s2>&quot;BNBUSDT&quot;</span><span class=p>,</span> <span class=s2>&quot;XRPUSDT&quot;</span><span class=p>,</span> <span class=s2>&quot;ADAUSDT&quot;</span><span class=p>],</span> 
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>start</span><span class=o>=</span><span class=s2>&quot;2020-01-01 UTC&quot;</span><span class=p>,</span> 
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span>    <span class=n>end</span><span class=o>=</span><span class=s2>&quot;2021-01-01 UTC&quot;</span><span class=p>,</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>... </span>    <span class=n>timeframe</span><span class=o>=</span><span class=s2>&quot;1h&quot;</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <p> <div class="progress progress-100plus candystripe candystripe-animate"> <div class=progress-bar style=width:100.00%> <p class=progress-label>Symbol 5/5</p> </div> </div> </p> <p> <div class="progress progress-100plus candystripe candystripe-animate"> <div class=progress-bar style=width:100.00%> <p class=progress-label>Period 9/9</p> </div> </div> </p> <p>Let's save the data locally to avoid re-fetching it every time we start a new runtime:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data</span><span class=o>.</span><span class=n>to_hdf</span><span class=p>()</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>HDFData</span><span class=o>.</span><span class=n>pull</span><span class=p>(</span><span class=s2>&quot;BinanceData.h5&quot;</span><span class=p>)</span>
</span></code></pre></div> <h2 id=allocation>Allocation<a class=headerlink href=#allocation title="Permanent link">&para;</a></h2> <p>In simple terms, asset allocation is the process of deciding where to invest funds in the market—it is a horizontal vector composed of weights or amounts of assets at a specific timestamp. For example, to allocate 50% to <code>BTCUSDT</code>, 20% to <code>ETHUSDT</code>, and distribute the remainder equally among the other assets, the allocation vector would be <code>[0.5, 0.2, 0.1, 0.1, 0.1]</code>. Frequently, weight allocations sum to 1, ensuring the entire stake is continuously invested, but you can also choose to invest only a portion of your balance or specify a particular (continuous or discrete) number of assets instead of weights. Since we generally want to allocate periodically rather than hold positions indefinitely, we also need to decide on rebalancing timestamps.</p> <h3 id=manually>Manually<a class=headerlink href=#manually title="Permanent link">&para;</a></h3> <p>Let's manually generate and simulate allocations to better understand how everything works together.</p> <h4 id=index-points>Index points<a class=headerlink href=#index-points title="Permanent link">&para;</a></h4> <p>The first step is to decide when to re-allocate. This is straightforward using <a href=https://vectorbt.pro/pvt_41531c19/api/base/wrapping/#vectorbtpro.base.wrapping.ArrayWrapper.get_index_points>ArrayWrapper.get_index_points</a>, which converts a human-readable query into a list of index positions (also called "index points" or "allocation points"). These positions are simple numeric indices, where <code>0</code> is the first row and <code>len(index) - 1</code> is the last.</p> <p>For example, let's convert the first day of each month into index points:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>ms_points</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>get_index_points</span><span class=p>(</span><span class=n>every</span><span class=o>=</span><span class=s2>&quot;M&quot;</span><span class=p>)</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>ms_points</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=go>array([0, 744, 1434, 2177, 2895, 3639, 4356, 5100, 5844, 6564, 7308, 8027])</span>
</span></code></pre></div> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>You can check the indices above using Pandas:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>get_indexer</span><span class=p>(</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=gp>... </span>    <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>index</span><span class=p>)</span><span class=o>.</span><span class=n>resample</span><span class=p>(</span><span class=n>vbt</span><span class=o>.</span><span class=n>offset</span><span class=p>(</span><span class=s2>&quot;M&quot;</span><span class=p>))</span><span class=o>.</span><span class=n>asfreq</span><span class=p>()</span><span class=o>.</span><span class=n>index</span><span class=p>,</span> 
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=gp>... </span>    <span class=n>method</span><span class=o>=</span><span class=s2>&quot;bfill&quot;</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=go>array([0, 744, 1434, 2177, 2895, 3639, 4356, 5100, 5844, 6564, 7308, 8027])</span>
</span></code></pre></div> </div> <p>We can also convert these index points back to timestamps:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>ms_points</span><span class=p>]</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=go>DatetimeIndex([&#39;2020-01-01 00:00:00+00:00&#39;, &#39;2020-02-01 00:00:00+00:00&#39;,</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=go>               &#39;2020-03-01 00:00:00+00:00&#39;, &#39;2020-04-01 00:00:00+00:00&#39;,</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=go>               &#39;2020-05-01 00:00:00+00:00&#39;, &#39;2020-06-01 00:00:00+00:00&#39;,</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=go>               &#39;2020-07-01 00:00:00+00:00&#39;, &#39;2020-08-01 00:00:00+00:00&#39;,</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=go>               &#39;2020-09-01 00:00:00+00:00&#39;, &#39;2020-10-01 00:00:00+00:00&#39;,</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=go>               &#39;2020-11-01 00:00:00+00:00&#39;, &#39;2020-12-01 00:00:00+00:00&#39;],</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=go>              dtype=&#39;datetime64[ns, UTC]&#39;, name=&#39;Open time&#39;, freq=None)</span>
</span></code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p><a href=https://vectorbt.pro/pvt_41531c19/api/base/wrapping/#vectorbtpro.base.wrapping.ArrayWrapper.get_index_points>ArrayWrapper.get_index_points</a> always returns indices that can be used on the index, unless <code>skipna</code> is disabled. In that case, it will return <code>-1</code> wherever an index point cannot be found.</p> </div> <p>These are our <a href=https://www.investopedia.com/terms/r/rebalancing.asp>rebalancing</a> timestamps!</p> <p>The main advantage of this method is its flexibility. The <code>every</code> argument can be a string, an integer, a <code>pd.Timedelta</code> object, or a <code>pd.DateOffset</code> object:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>example_points</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>get_index_points</span><span class=p>(</span><span class=n>every</span><span class=o>=</span><span class=mi>24</span> <span class=o>*</span> <span class=mi>30</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>example_points</span><span class=p>]</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=go>DatetimeIndex([&#39;2020-01-01 00:00:00+00:00&#39;, &#39;2020-01-31 00:00:00+00:00&#39;,</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=go>               &#39;2020-03-01 06:00:00+00:00&#39;, &#39;2020-03-31 07:00:00+00:00&#39;,</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=go>               &#39;2020-04-30 09:00:00+00:00&#39;, &#39;2020-05-30 09:00:00+00:00&#39;,</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=go>               &#39;2020-06-29 12:00:00+00:00&#39;, &#39;2020-07-29 12:00:00+00:00&#39;,</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=go>               &#39;2020-08-28 12:00:00+00:00&#39;, &#39;2020-09-27 12:00:00+00:00&#39;,</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=go>               &#39;2020-10-27 12:00:00+00:00&#39;, &#39;2020-11-26 12:00:00+00:00&#39;,</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=go>               &#39;2020-12-26 17:00:00+00:00&#39;],</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=go>              dtype=&#39;datetime64[ns, UTC]&#39;, name=&#39;Open time&#39;, freq=None)</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>date_offset</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>offsets</span><span class=o>.</span><span class=n>WeekOfMonth</span><span class=p>(</span><span class=n>week</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>weekday</span><span class=o>=</span><span class=mi>4</span><span class=p>)</span>
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a><span class=gp>&gt;&gt;&gt; </span><span class=n>example_points</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>get_index_points</span><span class=p>(</span>  <span class=c1># (2)!</span>
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=n>date_offset</span><span class=p>,</span> 
</span><span id=__span-5-15><a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a><span class=gp>... </span>    <span class=n>add_delta</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Timedelta</span><span class=p>(</span><span class=n>hours</span><span class=o>=</span><span class=mi>17</span><span class=p>)</span>
</span><span id=__span-5-16><a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-5-17><a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>example_points</span><span class=p>]</span>
</span><span id=__span-5-18><a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a><span class=go>DatetimeIndex([&#39;2020-01-24 17:00:00+00:00&#39;, &#39;2020-02-28 17:00:00+00:00&#39;,</span>
</span><span id=__span-5-19><a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a><span class=go>               &#39;2020-03-27 17:00:00+00:00&#39;, &#39;2020-04-24 17:00:00+00:00&#39;,</span>
</span><span id=__span-5-20><a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a><span class=go>               &#39;2020-05-22 17:00:00+00:00&#39;, &#39;2020-06-26 17:00:00+00:00&#39;,</span>
</span><span id=__span-5-21><a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a><span class=go>               &#39;2020-07-24 17:00:00+00:00&#39;, &#39;2020-08-28 17:00:00+00:00&#39;,</span>
</span><span id=__span-5-22><a id=__codelineno-5-22 name=__codelineno-5-22 href=#__codelineno-5-22></a><span class=go>               &#39;2020-09-25 17:00:00+00:00&#39;, &#39;2020-10-23 17:00:00+00:00&#39;,</span>
</span><span id=__span-5-23><a id=__codelineno-5-23 name=__codelineno-5-23 href=#__codelineno-5-23></a><span class=go>               &#39;2020-11-27 17:00:00+00:00&#39;, &#39;2020-12-25 17:00:00+00:00&#39;],</span>
</span><span id=__span-5-24><a id=__codelineno-5-24 name=__codelineno-5-24 href=#__codelineno-5-24></a><span class=go>              dtype=&#39;datetime64[ns, UTC]&#39;, name=&#39;Open time&#39;, freq=None)</span>
</span></code></pre></div> <ol> <li>Every 24 * 30 = 1440 hours.</li> <li>At 17:00 on the last Friday of each month.</li> </ol> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>Take a look at the <a href=https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#dateoffset-objects>available date offsets</a>.</p> </div> <p>You can also use <code>start</code> and <code>end</code> as human-readable strings (thanks to <a href=https://github.com/scrapinghub/dateparser>dateparser</a>!), integers, or <code>pd.Timestamp</code> objects to limit the date range as needed:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>example_points</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>get_index_points</span><span class=p>(</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=gp>... </span>    <span class=n>start</span><span class=o>=</span><span class=s2>&quot;April 1st 2020&quot;</span><span class=p>,</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=s2>&quot;M&quot;</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>example_points</span><span class=p>]</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=go>DatetimeIndex([&#39;2020-04-01 00:00:00+00:00&#39;, &#39;2020-05-01 00:00:00+00:00&#39;,</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=go>               &#39;2020-06-01 00:00:00+00:00&#39;, &#39;2020-07-01 00:00:00+00:00&#39;,</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=go>               &#39;2020-08-01 00:00:00+00:00&#39;, &#39;2020-09-01 00:00:00+00:00&#39;,</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=go>               &#39;2020-10-01 00:00:00+00:00&#39;, &#39;2020-11-01 00:00:00+00:00&#39;,</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=go>               &#39;2020-12-01 00:00:00+00:00&#39;],</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a><span class=go>              dtype=&#39;datetime64[ns, UTC]&#39;, name=&#39;Open time&#39;, freq=None)</span>
</span></code></pre></div> <p>Another helpful feature is providing your own dates using the <code>on</code> argument. <a href=https://vectorbt.pro/pvt_41531c19/api/base/wrapping/#vectorbtpro.base.wrapping.ArrayWrapper.get_index_points>ArrayWrapper.get_index_points</a> will match these dates to the index. If any date is not found, it will simply use the next date (not the previous one, since we should not look into the future):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>example_points</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>get_index_points</span><span class=p>(</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=gp>... </span>    <span class=n>on</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;April 1st 2020 19:45&quot;</span><span class=p>,</span> <span class=s2>&quot;17 September 2020 00:01&quot;</span><span class=p>]</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>example_points</span><span class=p>]</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=go>DatetimeIndex([</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=go>    &#39;2020-04-01 20:00:00+00:00&#39;, </span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=go>    &#39;2020-09-17 01:00:00+00:00&#39;</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a><span class=go>], dtype=&#39;datetime64[ns, UTC]&#39;, name=&#39;Open time&#39;, freq=None)</span>
</span></code></pre></div> <p>But let's continue with the <code>ms_points</code> generated earlier.</p> <h4 id=filling>Filling<a class=headerlink href=#filling title="Permanent link">&para;</a></h4> <p>We now have our allocation index points, so it's time to fill in the actual allocations at these points. First, let's create an empty DataFrame with symbols as columns:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>symbol_wrapper</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get_symbol_wrapper</span><span class=p>(</span><span class=n>freq</span><span class=o>=</span><span class=s2>&quot;1h&quot;</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>filled_allocations</span> <span class=o>=</span> <span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>fill</span><span class=p>()</span>  <span class=c1># (2)!</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>filled_allocations</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=go>symbol                     ADAUSDT  BNBUSDT  BTCUSDT  ETHUSDT  XRPUSDT</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=go>Open time                                                             </span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=go>2020-01-01 00:00:00+00:00      NaN      NaN      NaN      NaN      NaN</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=go>2020-01-01 01:00:00+00:00      NaN      NaN      NaN      NaN      NaN</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=go>2020-01-01 02:00:00+00:00      NaN      NaN      NaN      NaN      NaN</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a><span class=go>...                            ...      ...      ...      ...      ...</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a><span class=go>2020-12-31 21:00:00+00:00      NaN      NaN      NaN      NaN      NaN</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a><span class=go>2020-12-31 22:00:00+00:00      NaN      NaN      NaN      NaN      NaN</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a><span class=go>2020-12-31 23:00:00+00:00      NaN      NaN      NaN      NaN      NaN</span>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a>
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a><span class=go>[8767 rows x 5 columns]</span>
</span></code></pre></div> <ol> <li>Using <a href=https://vectorbt.pro/pvt_41531c19/api/data/base/#vectorbtpro.data.base.Data.get_symbol_wrapper>Data.get_symbol_wrapper</a>.</li> <li>Using <a href=https://vectorbt.pro/pvt_41531c19/api/base/wrapping/#vectorbtpro.base.wrapping.ArrayWrapper.fill>ArrayWrapper.fill</a>.</li> </ol> <p>Next, we need to generate allocations and assign them at their index points. In this example, we will create allocations randomly:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>random_allocate_func</span><span class=p>():</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=gp>... </span>    <span class=n>weights</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=n>size</span><span class=o>=</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>weights</span> <span class=o>/</span> <span class=n>weights</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>  <span class=c1># (2)!</span>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=gp>&gt;&gt;&gt; </span><span class=k>for</span> <span class=n>idx</span> <span class=ow>in</span> <span class=n>ms_points</span><span class=p>:</span>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=gp>... </span>    <span class=n>filled_allocations</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>random_allocate_func</span><span class=p>()</span>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a>
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>allocations</span> <span class=o>=</span> <span class=n>filled_allocations</span><span class=p>[</span><span class=o>~</span><span class=n>filled_allocations</span><span class=o>.</span><span class=n>isnull</span><span class=p>()</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)]</span>
</span><span id=__span-9-11><a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>allocations</span>
</span><span id=__span-9-12><a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a><span class=go>symbol                      ADAUSDT   BNBUSDT   BTCUSDT   ETHUSDT   XRPUSDT</span>
</span><span id=__span-9-13><a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a><span class=go>Open time                                                                  </span>
</span><span id=__span-9-14><a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a><span class=go>2020-01-01 00:00:00+00:00  0.133197  0.338101  0.260318  0.212900  0.055485</span>
</span><span id=__span-9-15><a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a><span class=go>2020-02-01 00:00:00+00:00  0.065285  0.024308  0.362501  0.251571  0.296334</span>
</span><span id=__span-9-16><a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a><span class=go>2020-03-01 00:00:00+00:00  0.009284  0.437468  0.375464  0.095773  0.082010</span>
</span><span id=__span-9-17><a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a><span class=go>2020-04-01 00:00:00+00:00  0.105673  0.175297  0.302353  0.248877  0.167800</span>
</span><span id=__span-9-18><a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a><span class=go>2020-05-01 00:00:00+00:00  0.327909  0.074759  0.156568  0.196343  0.244421</span>
</span><span id=__span-9-19><a id=__codelineno-9-19 name=__codelineno-9-19 href=#__codelineno-9-19></a><span class=go>2020-06-01 00:00:00+00:00  0.367257  0.093395  0.240527  0.277095  0.021727</span>
</span><span id=__span-9-20><a id=__codelineno-9-20 name=__codelineno-9-20 href=#__codelineno-9-20></a><span class=go>2020-07-01 00:00:00+00:00  0.220313  0.061837  0.023590  0.344094  0.350166</span>
</span><span id=__span-9-21><a id=__codelineno-9-21 name=__codelineno-9-21 href=#__codelineno-9-21></a><span class=go>2020-08-01 00:00:00+00:00  0.346199  0.130452  0.041828  0.293025  0.188497</span>
</span><span id=__span-9-22><a id=__codelineno-9-22 name=__codelineno-9-22 href=#__codelineno-9-22></a><span class=go>2020-09-01 00:00:00+00:00  0.067065  0.272119  0.018898  0.499708  0.142210</span>
</span><span id=__span-9-23><a id=__codelineno-9-23 name=__codelineno-9-23 href=#__codelineno-9-23></a><span class=go>2020-10-01 00:00:00+00:00  0.297647  0.140040  0.233647  0.245617  0.083048</span>
</span><span id=__span-9-24><a id=__codelineno-9-24 name=__codelineno-9-24 href=#__codelineno-9-24></a><span class=go>2020-11-01 00:00:00+00:00  0.232128  0.185574  0.224925  0.214230  0.143143</span>
</span><span id=__span-9-25><a id=__codelineno-9-25 name=__codelineno-9-25 href=#__codelineno-9-25></a><span class=go>2020-12-01 00:00:00+00:00  0.584609  0.056118  0.124283  0.028681  0.206309</span>
</span></code></pre></div> <ol> <li>Set the random seed to make the results reproducible.</li> <li>Divide by the sum to ensure the weights add up to 1.</li> </ol> <p>That's it! We can now use these weight vectors for simulation.</p> <h4 id=simulation>Simulation<a class=headerlink href=#simulation title="Permanent link">&para;</a></h4> <p>The simulation step is simple: use the filled allocations as the size for the target percentage type, enable grouping with cash sharing, and use a dynamic call sequence.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_orders</span><span class=p>(</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=gp>... </span>    <span class=n>close</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>),</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=gp>... </span>    <span class=n>size</span><span class=o>=</span><span class=n>filled_allocations</span><span class=p>,</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=gp>... </span>    <span class=n>size_type</span><span class=o>=</span><span class=s2>&quot;targetpercent&quot;</span><span class=p>,</span>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=gp>... </span>    <span class=n>group_by</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=gp>... </span>    <span class=n>cash_sharing</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=gp>... </span>    <span class=n>call_seq</span><span class=o>=</span><span class=s2>&quot;auto&quot;</span>  <span class=c1># (2)!</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <ol> <li>Change this if you have multiple groups.</li> <li>Selling before buying is important!</li> </ol> <p>We can extract the actual allocations produced by the simulation:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sim_alloc</span> <span class=o>=</span> <span class=n>pf</span><span class=o>.</span><span class=n>get_asset_value</span><span class=p>(</span><span class=n>group_by</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span> <span class=o>/</span> <span class=n>pf</span><span class=o>.</span><span class=n>value</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sim_alloc</span>  <span class=c1># (1)!</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=go>symbol                      ADAUSDT   BNBUSDT   BTCUSDT   ETHUSDT   XRPUSDT</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=go>Open time                                                                  </span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=go>2020-01-01 00:00:00+00:00  0.133197  0.338101  0.260318  0.212900  0.055485</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=go>2020-01-01 01:00:00+00:00  0.132979  0.337881  0.259649  0.214099  0.055393</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=go>2020-01-01 02:00:00+00:00  0.133259  0.337934  0.259737  0.213728  0.055342</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=go>...                             ...       ...       ...       ...       ...</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a><span class=go>2020-12-31 21:00:00+00:00  0.636496  0.067686  0.188081  0.035737  0.072000</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a><span class=go>2020-12-31 22:00:00+00:00  0.634586  0.068128  0.189404  0.035930  0.071952</span>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a><span class=go>2020-12-31 23:00:00+00:00  0.638154  0.068205  0.187649  0.035619  0.070373</span>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a><span class=go>[8766 rows x 5 columns]</span>
</span></code></pre></div> <ol> <li>You can also return this using <code>pf.allocations</code>.</li> </ol> <p>We can plot the allocations manually:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>sim_alloc</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=gp>... </span>   <span class=n>trace_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>stackgroup</span><span class=o>=</span><span class=s2>&quot;one&quot;</span><span class=p>),</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=gp>... </span>   <span class=n>use_gl</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=gp>... </span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/actual_allocations.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/actual_allocations.dark.svg#only-dark></p> <p>Or use <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.plot_allocations>Portfolio.plot_allocations</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>plot_allocations</span><span class=p>()</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/plot_allocations.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/plot_allocations.dark.svg#only-dark></p> <p>Without transaction costs such as commissions and slippage, the source and target allocations should closely match at the allocation points:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>np</span><span class=o>.</span><span class=n>isclose</span><span class=p>(</span><span class=n>allocations</span><span class=p>,</span> <span class=n>sim_alloc</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>ms_points</span><span class=p>])</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=go>array([[ True,  True,  True,  True,  True],</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=go>       [ True,  True,  True,  True,  True],</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=go>       [ True,  True,  True,  True,  True],</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=go>       [ True,  True,  True,  True,  True],</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a><span class=go>       [ True,  True,  True,  True,  True],</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=go>       [ True,  True,  True,  True,  True],</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a><span class=go>       [ True,  True,  True,  True,  True],</span>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a><span class=go>       [ True,  True,  True,  True,  True],</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=go>       [ True,  True,  True,  True,  True],</span>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a><span class=go>       [ True,  True,  True,  True,  True],</span>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a><span class=go>       [ True,  True,  True,  True,  True],</span>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a><span class=go>       [ True,  True,  True,  True,  True]])</span>
</span></code></pre></div> <h3 id=allocation-method>Allocation method<a class=headerlink href=#allocation-method title="Permanent link">&para;</a></h3> <p>We have learned how to manually generate, fill, and simulate allocations. But VBT would not be VBT if it did not provide a convenient function for this! This is where <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer>PortfolioOptimizer</a> comes into play: it offers various class methods for generating allocations. The workings of this class are quite straightforward (despite the complex implementation): it generates allocations and stores them in a compressed form for later analysis and simulation.</p> <p>The allocation generation is managed by the class method <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer.from_allocate_func>PortfolioOptimizer.from_allocate_func</a>. If you review the documentation for this method, you will notice that it takes the same arguments as <a href=https://vectorbt.pro/pvt_41531c19/api/base/wrapping/#vectorbtpro.base.wrapping.ArrayWrapper.get_index_points>ArrayWrapper.get_index_points</a> to generate index points. Then, at each of these points, it calls a user-defined allocation function <code>allocate_func</code> to produce an allocation vector. Finally, all the returned vectors are concatenated into a single two-dimensional NumPy array, while the index points are stored in a separate structured NumPy array of type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/records/#vectorbtpro.portfolio.pfopt.records.AllocPoints>AllocPoints</a>.</p> <p>Let's apply the optimizer class to <code>random_allocate_func</code>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_allocate_func</span><span class=p>(</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=gp>... </span>    <span class=n>random_allocate_func</span><span class=p>,</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=s2>&quot;M&quot;</span>  <span class=c1># (2)!</span>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <ol> <li>The wrapper must contain symbols as columns.</li> <li>If you do not provide a frequency, the function will be called at every date.</li> </ol> <p> <div class="progress progress-100plus candystripe candystripe-animate"> <div class=progress-bar style=width:100.00%> <p class=progress-label>Allocation 12/12</p> </div> </div> </p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>There is also a convenient method <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer.from_random>PortfolioOptimizer.from_random</a> to generate random allocations. Give it a try!</p> </div> <p>Now, let's look at the generated random allocations:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>allocations</span>  <span class=c1># (1)!</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=go>symbol                      ADAUSDT   BNBUSDT   BTCUSDT   ETHUSDT   XRPUSDT</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=go>Open time                                                                  </span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=go>2020-01-01 00:00:00+00:00  0.133197  0.338101  0.260318  0.212900  0.055485</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=go>2020-02-01 00:00:00+00:00  0.065285  0.024308  0.362501  0.251571  0.296334</span>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=go>2020-03-01 00:00:00+00:00  0.009284  0.437468  0.375464  0.095773  0.082010</span>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=go>2020-04-01 00:00:00+00:00  0.105673  0.175297  0.302353  0.248877  0.167800</span>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a><span class=go>2020-05-01 00:00:00+00:00  0.327909  0.074759  0.156568  0.196343  0.244421</span>
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a><span class=go>2020-06-01 00:00:00+00:00  0.367257  0.093395  0.240527  0.277095  0.021727</span>
</span><span id=__span-16-10><a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a><span class=go>2020-07-01 00:00:00+00:00  0.220313  0.061837  0.023590  0.344094  0.350166</span>
</span><span id=__span-16-11><a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a><span class=go>2020-08-01 00:00:00+00:00  0.346199  0.130452  0.041828  0.293025  0.188497</span>
</span><span id=__span-16-12><a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a><span class=go>2020-09-01 00:00:00+00:00  0.067065  0.272119  0.018898  0.499708  0.142210</span>
</span><span id=__span-16-13><a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a><span class=go>2020-10-01 00:00:00+00:00  0.297647  0.140040  0.233647  0.245617  0.083048</span>
</span><span id=__span-16-14><a id=__codelineno-16-14 name=__codelineno-16-14 href=#__codelineno-16-14></a><span class=go>2020-11-01 00:00:00+00:00  0.232128  0.185574  0.224925  0.214230  0.143143</span>
</span><span id=__span-16-15><a id=__codelineno-16-15 name=__codelineno-16-15 href=#__codelineno-16-15></a><span class=go>2020-12-01 00:00:00+00:00  0.584609  0.056118  0.124283  0.028681  0.206309</span>
</span></code></pre></div> <ol> <li>See <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer.get_allocations>PortfolioOptimizer.get_allocations</a>.</li> </ol> <p>We can also fill the entire array so it can be used in simulation:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>filled_allocations</span>  <span class=c1># (1)!</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=go>symbol                      ADAUSDT   BNBUSDT   BTCUSDT  ETHUSDT   XRPUSDT</span>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=go>Open time                                                                 </span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=go>2020-01-01 00:00:00+00:00  0.133197  0.338101  0.260318   0.2129  0.055485</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=go>2020-01-01 01:00:00+00:00       NaN       NaN       NaN      NaN       NaN</span>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=go>2020-01-01 02:00:00+00:00       NaN       NaN       NaN      NaN       NaN</span>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a><span class=go>2020-01-01 03:00:00+00:00       NaN       NaN       NaN      NaN       NaN</span>
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a><span class=go>...                             ...       ...       ...      ...       ...</span>
</span><span id=__span-17-9><a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a><span class=go>2020-12-31 21:00:00+00:00       NaN       NaN       NaN      NaN       NaN</span>
</span><span id=__span-17-10><a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a><span class=go>2020-12-31 22:00:00+00:00       NaN       NaN       NaN      NaN       NaN</span>
</span><span id=__span-17-11><a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a><span class=go>2020-12-31 23:00:00+00:00       NaN       NaN       NaN      NaN       NaN</span>
</span><span id=__span-17-12><a id=__codelineno-17-12 name=__codelineno-17-12 href=#__codelineno-17-12></a>
</span><span id=__span-17-13><a id=__codelineno-17-13 name=__codelineno-17-13 href=#__codelineno-17-13></a><span class=go>[8767 rows x 5 columns]</span>
</span></code></pre></div> <ol> <li>See <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer.fill_allocations>PortfolioOptimizer.fill_allocations</a>.</li> </ol> <div class="admonition note"> <p class=admonition-title>Note</p> <p>A row filled with NaN values means there is no allocation at that timestamp.</p> </div> <p>Since an instance of <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer>PortfolioOptimizer</a> stores not only the allocation vectors but also the index points themselves, you can access them using <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer.alloc_records>PortfolioOptimizer.alloc_records</a> and analyze them like regular records:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>alloc_records</span><span class=o>.</span><span class=n>records_readable</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=go>    Id  Group          Allocation Index</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=go>0    0  group 2020-01-01 00:00:00+00:00</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=go>1    1  group 2020-02-01 00:00:00+00:00</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=go>2    2  group 2020-03-01 00:00:00+00:00</span>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a><span class=go>3    3  group 2020-04-01 00:00:00+00:00</span>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a><span class=go>4    4  group 2020-05-01 00:00:00+00:00</span>
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a><span class=go>5    5  group 2020-06-01 00:00:00+00:00</span>
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a><span class=go>6    6  group 2020-07-01 00:00:00+00:00</span>
</span><span id=__span-18-10><a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a><span class=go>7    7  group 2020-08-01 00:00:00+00:00</span>
</span><span id=__span-18-11><a id=__codelineno-18-11 name=__codelineno-18-11 href=#__codelineno-18-11></a><span class=go>8    8  group 2020-09-01 00:00:00+00:00</span>
</span><span id=__span-18-12><a id=__codelineno-18-12 name=__codelineno-18-12 href=#__codelineno-18-12></a><span class=go>9    9  group 2020-10-01 00:00:00+00:00</span>
</span><span id=__span-18-13><a id=__codelineno-18-13 name=__codelineno-18-13 href=#__codelineno-18-13></a><span class=go>10  10  group 2020-11-01 00:00:00+00:00</span>
</span><span id=__span-18-14><a id=__codelineno-18-14 name=__codelineno-18-14 href=#__codelineno-18-14></a><span class=go>11  11  group 2020-12-01 00:00:00+00:00</span>
</span></code></pre></div> <p>The allocations can be plotted easily using <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer.plot>PortfolioOptimizer.plot</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>plot</span><span class=p>()</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/optimizer.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/optimizer.dark.svg#only-dark></p> <p>Since <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer>PortfolioOptimizer</a> is a subclass of <a href=https://vectorbt.pro/pvt_41531c19/api/generic/analyzable/#vectorbtpro.generic.analyzable.Analyzable>Analyzable</a>, we can generate statistics to describe the optimizer's current state:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>stats</span><span class=p>()</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=go>Start                       2020-01-01 00:00:00+00:00</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=go>End                         2020-12-31 23:00:00+00:00</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a><span class=go>Period                              365 days 06:00:00</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a><span class=go>Total Records                                      12</span>
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a><span class=go>Mean Allocation: ADAUSDT                     0.229714</span>
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a><span class=go>Mean Allocation: BNBUSDT                     0.165789</span>
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a><span class=go>Mean Allocation: BTCUSDT                     0.197075</span>
</span><span id=__span-20-9><a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a><span class=go>Mean Allocation: ETHUSDT                     0.242326</span>
</span><span id=__span-20-10><a id=__codelineno-20-10 name=__codelineno-20-10 href=#__codelineno-20-10></a><span class=go>Mean Allocation: XRPUSDT                     0.165096</span>
</span><span id=__span-20-11><a id=__codelineno-20-11 name=__codelineno-20-11 href=#__codelineno-20-11></a><span class=go>Name: group, dtype: object</span>
</span></code></pre></div> <p>What about simulation? <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio>Portfolio</a> includes a dedicated class method for this purpose: <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/base/#vectorbtpro.portfolio.base.Portfolio.from_optimizer>Portfolio.from_optimizer</a>.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>Portfolio</span><span class=o>.</span><span class=n>from_optimizer</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>pfo</span><span class=p>,</span> <span class=n>freq</span><span class=o>=</span><span class=s2>&quot;1h&quot;</span><span class=p>)</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>sharpe_ratio</span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=go>2.097991099869708</span>
</span></code></pre></div> <p>Alternatively, you can run the simulation directly from the portfolio optimizer:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>pfo</span><span class=o>.</span><span class=n>simulate</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>freq</span><span class=o>=</span><span class=s2>&quot;1h&quot;</span><span class=p>)</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>sharpe_ratio</span>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a><span class=go>2.097991099869708</span>
</span></code></pre></div> <p>As we can see, VBT continues its modular approach to keep individual backtesting components as independent as possible while maintaining coherence. Instead of defining all the logic within a single backtesting module, you can divide the workflow into a set of logically separate, isolated components, each of which can be maintained independently.</p> <h4 id=once>Once<a class=headerlink href=#once title="Permanent link">&para;</a></h4> <p>To allocate once, you can use <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer.from_allocate_func>PortfolioOptimizer.from_allocate_func</a> with <code>on=0</code>, or use <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer.from_initial>PortfolioOptimizer.from_initial</a>:</p> <div class="tabbed-set tabbed-alternate" data-tabs=1:2><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><input id=__tabbed_1_2 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1>from_allocate_func</label><label for=__tabbed_1_2>from_initial</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>const_allocate_func</span><span class=p>(</span><span class=n>target_alloc</span><span class=p>):</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>target_alloc</span>
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a>
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_allocate_func</span><span class=p>(</span>
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-23-6><a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a><span class=gp>... </span>    <span class=n>const_allocate_func</span><span class=p>,</span>
</span><span id=__span-23-7><a id=__codelineno-23-7 name=__codelineno-23-7 href=#__codelineno-23-7></a><span class=gp>... </span>    <span class=p>[</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>],</span>
</span><span id=__span-23-8><a id=__codelineno-23-8 name=__codelineno-23-8 href=#__codelineno-23-8></a><span class=gp>... </span>    <span class=n>on</span><span class=o>=</span><span class=mi>0</span>
</span><span id=__span-23-9><a id=__codelineno-23-9 name=__codelineno-23-9 href=#__codelineno-23-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-23-10><a id=__codelineno-23-10 name=__codelineno-23-10 href=#__codelineno-23-10></a>
</span><span id=__span-23-11><a id=__codelineno-23-11 name=__codelineno-23-11 href=#__codelineno-23-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>plot</span><span class=p>()</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> </div> <div class=tabbed-block> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_initial</span><span class=p>(</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=gp>... </span>    <span class=p>[</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>]</span>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>plot</span><span class=p>()</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> </div> </div> </div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/once.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/once.dark.svg#only-dark></p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Even if the lines appear straight on the chart, this does not mean rebalancing happens at each timestamp. This effect is mainly due to VBT forward-filling the allocation. In reality, the initial allocation is preserved at the first timestamp, and then it typically begins to change. That's why periodic or threshold rebalancing is required to maintain the allocation over the entire period.</p> </div> <h4 id=custom-array>Custom array<a class=headerlink href=#custom-array title="Permanent link">&para;</a></h4> <p>If you already have an array with allocations in either compressed or filled form, you can use <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer.from_allocations>PortfolioOptimizer.from_allocations</a> and <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer.from_filled_allocations>PortfolioOptimizer.from_filled_allocations</a> respectively.</p> <p>Let's create a compressed array with custom allocations for each quarter:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>custom_index</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>date_range</span><span class=p>(</span><span class=s2>&quot;2020-01-01&quot;</span><span class=p>,</span> <span class=s2>&quot;2021-01-01&quot;</span><span class=p>,</span> <span class=n>freq</span><span class=o>=</span><span class=s2>&quot;Q&quot;</span><span class=p>)</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>custom_allocations</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=gp>... </span>    <span class=p>[</span>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a><span class=gp>... </span>        <span class=p>[</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>],</span>
</span><span id=__span-25-5><a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a><span class=gp>... </span>        <span class=p>[</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>],</span>
</span><span id=__span-25-6><a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a><span class=gp>... </span>        <span class=p>[</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>],</span>
</span><span id=__span-25-7><a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a><span class=gp>... </span>        <span class=p>[</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>]</span>
</span><span id=__span-25-8><a id=__codelineno-25-8 name=__codelineno-25-8 href=#__codelineno-25-8></a><span class=gp>... </span>    <span class=p>],</span>
</span><span id=__span-25-9><a id=__codelineno-25-9 name=__codelineno-25-9 href=#__codelineno-25-9></a><span class=gp>... </span>    <span class=n>index</span><span class=o>=</span><span class=n>custom_index</span><span class=p>,</span>
</span><span id=__span-25-10><a id=__codelineno-25-10 name=__codelineno-25-10 href=#__codelineno-25-10></a><span class=gp>... </span>    <span class=n>columns</span><span class=o>=</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>columns</span>
</span><span id=__span-25-11><a id=__codelineno-25-11 name=__codelineno-25-11 href=#__codelineno-25-11></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <p>When you pass a DataFrame, VBT automatically uses its index as the <code>on</code> argument to apply allocations at those (or next) timestamps in the original index:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_allocations</span><span class=p>(</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a><span class=gp>... </span>    <span class=n>custom_allocations</span>
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>allocations</span>
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a><span class=go>symbol                     ADAUSDT  BNBUSDT  BTCUSDT  ETHUSDT  XRPUSDT</span>
</span><span id=__span-26-7><a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a><span class=go>Open time</span>
</span><span id=__span-26-8><a id=__codelineno-26-8 name=__codelineno-26-8 href=#__codelineno-26-8></a><span class=go>2020-01-01 00:00:00+00:00      0.5      0.2      0.1      0.1      0.1</span>
</span><span id=__span-26-9><a id=__codelineno-26-9 name=__codelineno-26-9 href=#__codelineno-26-9></a><span class=go>2020-04-01 00:00:00+00:00      0.1      0.5      0.2      0.1      0.1</span>
</span><span id=__span-26-10><a id=__codelineno-26-10 name=__codelineno-26-10 href=#__codelineno-26-10></a><span class=go>2020-07-01 00:00:00+00:00      0.1      0.1      0.5      0.2      0.1</span>
</span><span id=__span-26-11><a id=__codelineno-26-11 name=__codelineno-26-11 href=#__codelineno-26-11></a><span class=go>2020-10-01 00:00:00+00:00      0.1      0.1      0.1      0.5      0.2</span>
</span></code></pre></div> <p>However, if you pass a NumPy array, VBT will not be able to parse the dates, so you must specify the index points manually:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_allocations</span><span class=p>(</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=gp>... </span>    <span class=n>custom_allocations</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=gp>... </span>    <span class=n>start</span><span class=o>=</span><span class=s2>&quot;2020-01-01&quot;</span><span class=p>,</span>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=gp>... </span>    <span class=n>end</span><span class=o>=</span><span class=s2>&quot;2021-01-01&quot;</span><span class=p>,</span>
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=s2>&quot;Q&quot;</span>
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-27-8><a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>allocations</span>
</span><span id=__span-27-9><a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a><span class=go>symbol                     ADAUSDT  BNBUSDT  BTCUSDT  ETHUSDT  XRPUSDT</span>
</span><span id=__span-27-10><a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a><span class=go>Open time</span>
</span><span id=__span-27-11><a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a><span class=go>2020-01-01 00:00:00+00:00      0.5      0.2      0.1      0.1      0.1</span>
</span><span id=__span-27-12><a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a><span class=go>2020-04-01 00:00:00+00:00      0.1      0.5      0.2      0.1      0.1</span>
</span><span id=__span-27-13><a id=__codelineno-27-13 name=__codelineno-27-13 href=#__codelineno-27-13></a><span class=go>2020-07-01 00:00:00+00:00      0.1      0.1      0.5      0.2      0.1</span>
</span><span id=__span-27-14><a id=__codelineno-27-14 name=__codelineno-27-14 href=#__codelineno-27-14></a><span class=go>2020-10-01 00:00:00+00:00      0.1      0.1      0.1      0.5      0.2</span>
</span></code></pre></div> <p>You can also use allocations that have already been filled as input. In this case, you do not even need to provide a wrapper. Vectorbt will extract the necessary information from the DataFrame itself. Filled allocations are handled by treating any row where all values are NaN as empty. Let's use the filled allocations from the previous optimizer as input to another optimizer:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_filled_allocations</span><span class=p>(</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=gp>... </span>    <span class=n>pfo</span><span class=o>.</span><span class=n>fill_allocations</span><span class=p>()</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>allocations</span>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=go>symbol                     ADAUSDT  BNBUSDT  BTCUSDT  ETHUSDT  XRPUSDT</span>
</span><span id=__span-28-6><a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a><span class=go>Open time</span>
</span><span id=__span-28-7><a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a><span class=go>2020-01-01 00:00:00+00:00      0.5      0.2      0.1      0.1      0.1</span>
</span><span id=__span-28-8><a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a><span class=go>2020-04-01 00:00:00+00:00      0.1      0.5      0.2      0.1      0.1</span>
</span><span id=__span-28-9><a id=__codelineno-28-9 name=__codelineno-28-9 href=#__codelineno-28-9></a><span class=go>2020-07-01 00:00:00+00:00      0.1      0.1      0.5      0.2      0.1</span>
</span><span id=__span-28-10><a id=__codelineno-28-10 name=__codelineno-28-10 href=#__codelineno-28-10></a><span class=go>2020-10-01 00:00:00+00:00      0.1      0.1      0.1      0.5      0.2</span>
</span></code></pre></div> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>You can re-run this cell as many times as you like. There is no information loss!</p> </div> <h4 id=templates>Templates<a class=headerlink href=#templates title="Permanent link">&para;</a></h4> <p>What if you want to use more complex allocation functions that require passing arguments? One of the coolest features of VBT is templates, which act as a sort of callback. With templates, you can instruct VBT to run small code snippets at various execution points, typically whenever new information becomes available.</p> <p>When a new index point is processed by <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer.from_allocate_func>PortfolioOptimizer.from_allocate_func</a>, VBT substitutes all templates found in <code>*args</code> and <code>**kwargs</code> using the current context and passes them to the allocation function. The template context includes all arguments given to the class method, plus the generated index points (<code>index_points</code>), the current iteration index (<code>i</code>), and the specific index point (<code>index_point</code>).</p> <p>To make our example more interesting, let's rotate and allocate 100% to one asset at a time:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>rotation_allocate_func</span><span class=p>(</span><span class=n>wrapper</span><span class=p>,</span> <span class=n>i</span><span class=p>):</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a><span class=gp>... </span>    <span class=n>weights</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>wrapper</span><span class=o>.</span><span class=n>columns</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span>
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a><span class=gp>... </span>    <span class=n>weights</span><span class=p>[</span><span class=n>i</span> <span class=o>%</span> <span class=nb>len</span><span class=p>(</span><span class=n>wrapper</span><span class=o>.</span><span class=n>columns</span><span class=p>)]</span> <span class=o>=</span> <span class=mi>1</span>
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>weights</span>
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a>
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_allocate_func</span><span class=p>(</span>
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-29-8><a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a><span class=gp>... </span>    <span class=n>rotation_allocate_func</span><span class=p>,</span>
</span><span id=__span-29-9><a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;wrapper&quot;</span><span class=p>),</span>  <span class=c1># (1)!</span>
</span><span id=__span-29-10><a id=__codelineno-29-10 name=__codelineno-29-10 href=#__codelineno-29-10></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;i&quot;</span><span class=p>),</span>
</span><span id=__span-29-11><a id=__codelineno-29-11 name=__codelineno-29-11 href=#__codelineno-29-11></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=s2>&quot;M&quot;</span>
</span><span id=__span-29-12><a id=__codelineno-29-12 name=__codelineno-29-12 href=#__codelineno-29-12></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-29-13><a id=__codelineno-29-13 name=__codelineno-29-13 href=#__codelineno-29-13></a>
</span><span id=__span-29-14><a id=__codelineno-29-14 name=__codelineno-29-14 href=#__codelineno-29-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>plot</span><span class=p>()</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <ol> <li>Replace the first and second variable arguments with the wrapper and iteration index, respectively.</li> </ol> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/templates.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/templates.dark.svg#only-dark></p> <p>You can also use evaluation templates to accomplish the same task:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>rotation_allocate_func</span><span class=p>(</span><span class=n>symbols</span><span class=p>,</span> <span class=n>chosen_symbol</span><span class=p>):</span>
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a><span class=gp>... </span>    <span class=k>return</span> <span class=p>{</span><span class=n>s</span><span class=p>:</span> <span class=mi>1</span> <span class=k>if</span> <span class=n>s</span> <span class=o>==</span> <span class=n>chosen_symbol</span> <span class=k>else</span> <span class=mi>0</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>symbols</span><span class=p>}</span>
</span><span id=__span-30-3><a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a>
</span><span id=__span-30-4><a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_allocate_func</span><span class=p>(</span>
</span><span id=__span-30-5><a id=__codelineno-30-5 name=__codelineno-30-5 href=#__codelineno-30-5></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-30-6><a id=__codelineno-30-6 name=__codelineno-30-6 href=#__codelineno-30-6></a><span class=gp>... </span>    <span class=n>rotation_allocate_func</span><span class=p>,</span>
</span><span id=__span-30-7><a id=__codelineno-30-7 name=__codelineno-30-7 href=#__codelineno-30-7></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;wrapper.columns&quot;</span><span class=p>),</span>  <span class=c1># (1)!</span>
</span><span id=__span-30-8><a id=__codelineno-30-8 name=__codelineno-30-8 href=#__codelineno-30-8></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;wrapper.columns[i </span><span class=si>% le</span><span class=s2>n(wrapper.columns)]&quot;</span><span class=p>),</span>
</span><span id=__span-30-9><a id=__codelineno-30-9 name=__codelineno-30-9 href=#__codelineno-30-9></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=s2>&quot;M&quot;</span>
</span><span id=__span-30-10><a id=__codelineno-30-10 name=__codelineno-30-10 href=#__codelineno-30-10></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-30-11><a id=__codelineno-30-11 name=__codelineno-30-11 href=#__codelineno-30-11></a>
</span><span id=__span-30-12><a id=__codelineno-30-12 name=__codelineno-30-12 href=#__codelineno-30-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>allocations</span>
</span><span id=__span-30-13><a id=__codelineno-30-13 name=__codelineno-30-13 href=#__codelineno-30-13></a><span class=go>symbol                     ADAUSDT  BNBUSDT  BTCUSDT  ETHUSDT  XRPUSDT</span>
</span><span id=__span-30-14><a id=__codelineno-30-14 name=__codelineno-30-14 href=#__codelineno-30-14></a><span class=go>Open time</span>
</span><span id=__span-30-15><a id=__codelineno-30-15 name=__codelineno-30-15 href=#__codelineno-30-15></a><span class=go>2020-01-01 00:00:00+00:00        1        0        0        0        0</span>
</span><span id=__span-30-16><a id=__codelineno-30-16 name=__codelineno-30-16 href=#__codelineno-30-16></a><span class=go>2020-02-01 00:00:00+00:00        0        1        0        0        0</span>
</span><span id=__span-30-17><a id=__codelineno-30-17 name=__codelineno-30-17 href=#__codelineno-30-17></a><span class=go>2020-03-01 00:00:00+00:00        0        0        1        0        0</span>
</span><span id=__span-30-18><a id=__codelineno-30-18 name=__codelineno-30-18 href=#__codelineno-30-18></a><span class=go>2020-04-01 00:00:00+00:00        0        0        0        1        0</span>
</span><span id=__span-30-19><a id=__codelineno-30-19 name=__codelineno-30-19 href=#__codelineno-30-19></a><span class=go>2020-05-01 00:00:00+00:00        0        0        0        0        1</span>
</span><span id=__span-30-20><a id=__codelineno-30-20 name=__codelineno-30-20 href=#__codelineno-30-20></a><span class=go>2020-06-01 00:00:00+00:00        1        0        0        0        0</span>
</span><span id=__span-30-21><a id=__codelineno-30-21 name=__codelineno-30-21 href=#__codelineno-30-21></a><span class=go>2020-07-01 00:00:00+00:00        0        1        0        0        0</span>
</span><span id=__span-30-22><a id=__codelineno-30-22 name=__codelineno-30-22 href=#__codelineno-30-22></a><span class=go>2020-08-01 00:00:00+00:00        0        0        1        0        0</span>
</span><span id=__span-30-23><a id=__codelineno-30-23 name=__codelineno-30-23 href=#__codelineno-30-23></a><span class=go>2020-09-01 00:00:00+00:00        0        0        0        1        0</span>
</span><span id=__span-30-24><a id=__codelineno-30-24 name=__codelineno-30-24 href=#__codelineno-30-24></a><span class=go>2020-10-01 00:00:00+00:00        0        0        0        0        1</span>
</span><span id=__span-30-25><a id=__codelineno-30-25 name=__codelineno-30-25 href=#__codelineno-30-25></a><span class=go>2020-11-01 00:00:00+00:00        1        0        0        0        0</span>
</span><span id=__span-30-26><a id=__codelineno-30-26 name=__codelineno-30-26 href=#__codelineno-30-26></a><span class=go>2020-12-01 00:00:00+00:00        0        1        0        0        0</span>
</span></code></pre></div> <ol> <li>Evaluate these expressions and use them as arguments for the function.</li> </ol> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>The allocation function can return a sequence of values (one per asset), a dictionary (with assets as keys), or even a Pandas Series (with assets as the index). In other words, it can return anything that can be packed into a list and used as input for a DataFrame. If any asset key is not provided, its allocation will be NaN.</p> </div> <h4 id=groups>Groups<a class=headerlink href=#groups title="Permanent link">&para;</a></h4> <p>Testing a single combination of parameters can be boring, so VBT provides two different features for parameter combinations: arguments wrapped with the <a href=https://vectorbt.pro/pvt_41531c19/api/utils/params/#vectorbtpro.utils.params.Param>Param</a> class and group configs. The idea behind the former is similar to what you may have seen in <a href=https://vectorbt.pro/pvt_41531c19/api/base/reshaping/#vectorbtpro.base.reshaping.broadcast>broadcast</a>: wrap a sequence of values with this class to combine the argument with other arguments or similar parameters. Let's implement constant-weight asset allocation with various rebalancing intervals:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_allocate_func</span><span class=p>(</span>
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-31-3><a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a><span class=gp>... </span>    <span class=n>const_allocate_func</span><span class=p>,</span>
</span><span id=__span-31-4><a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a><span class=gp>... </span>    <span class=p>[</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>],</span>
</span><span id=__span-31-5><a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=s2>&quot;1M&quot;</span><span class=p>,</span> <span class=s2>&quot;2M&quot;</span><span class=p>,</span> <span class=s2>&quot;3M&quot;</span><span class=p>])</span>  <span class=c1># (1)!</span>
</span><span id=__span-31-6><a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-31-7><a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a>
</span><span id=__span-31-8><a id=__codelineno-31-8 name=__codelineno-31-8 href=#__codelineno-31-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span> <span class=o>=</span> <span class=n>pfo</span><span class=o>.</span><span class=n>simulate</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>freq</span><span class=o>=</span><span class=s2>&quot;1h&quot;</span><span class=p>)</span>
</span><span id=__span-31-9><a id=__codelineno-31-9 name=__codelineno-31-9 href=#__codelineno-31-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pf</span><span class=o>.</span><span class=n>total_return</span>
</span><span id=__span-31-10><a id=__codelineno-31-10 name=__codelineno-31-10 href=#__codelineno-31-10></a><span class=go>every</span>
</span><span id=__span-31-11><a id=__codelineno-31-11 name=__codelineno-31-11 href=#__codelineno-31-11></a><span class=go>1M    3.716574</span>
</span><span id=__span-31-12><a id=__codelineno-31-12 name=__codelineno-31-12 href=#__codelineno-31-12></a><span class=go>2M    3.435540</span>
</span><span id=__span-31-13><a id=__codelineno-31-13 name=__codelineno-31-13 href=#__codelineno-31-13></a><span class=go>3M    3.516401</span>
</span><span id=__span-31-14><a id=__codelineno-31-14 name=__codelineno-31-14 href=#__codelineno-31-14></a><span class=go>Name: total_return, dtype: float64</span>
</span></code></pre></div> <ol> <li>Create three groups: rebalance monthly, once every two months, and once every three months.</li> </ol> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>To hide the progress bar, pass <code>execute_kwargs=dict(show_progress=False)</code>.</p> </div> <p>As you can see, VBT recognizes that the <code>every</code> argument is a parameter, so it creates a column level named after the argument and puts it on top of the symbol columns.</p> <p>Now, let's define another parameter for weights:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_allocate_func</span><span class=p>(</span>
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-32-3><a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a><span class=gp>... </span>    <span class=n>const_allocate_func</span><span class=p>,</span>
</span><span id=__span-32-4><a id=__codelineno-32-4 name=__codelineno-32-4 href=#__codelineno-32-4></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span>
</span><span id=__span-32-5><a id=__codelineno-32-5 name=__codelineno-32-5 href=#__codelineno-32-5></a><span class=gp>... </span>        <span class=p>[</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>],</span>
</span><span id=__span-32-6><a id=__codelineno-32-6 name=__codelineno-32-6 href=#__codelineno-32-6></a><span class=gp>... </span>        <span class=p>[</span><span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>]</span>
</span><span id=__span-32-7><a id=__codelineno-32-7 name=__codelineno-32-7 href=#__codelineno-32-7></a><span class=gp>... </span>    <span class=p>],</span> <span class=n>keys</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Index</span><span class=p>([</span><span class=s2>&quot;w1&quot;</span><span class=p>,</span> <span class=s2>&quot;w2&quot;</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;weights&quot;</span><span class=p>)),</span>  <span class=c1># (1)!</span>
</span><span id=__span-32-8><a id=__codelineno-32-8 name=__codelineno-32-8 href=#__codelineno-32-8></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=s2>&quot;1M&quot;</span><span class=p>,</span> <span class=s2>&quot;2M&quot;</span><span class=p>,</span> <span class=s2>&quot;3M&quot;</span><span class=p>])</span>
</span><span id=__span-32-9><a id=__codelineno-32-9 name=__codelineno-32-9 href=#__codelineno-32-9></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <ol> <li>Set a custom name for the parameter in the final column index.</li> </ol> <p>This code produces 6 parameter combinations (groups):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>grouper</span><span class=o>.</span><span class=n>get_index</span><span class=p>()</span>
</span><span id=__span-33-2><a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a><span class=go>MultiIndex([(&#39;1M&#39;, &#39;w1&#39;),</span>
</span><span id=__span-33-3><a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a><span class=go>            (&#39;1M&#39;, &#39;w2&#39;),</span>
</span><span id=__span-33-4><a id=__codelineno-33-4 name=__codelineno-33-4 href=#__codelineno-33-4></a><span class=go>            (&#39;2M&#39;, &#39;w1&#39;),</span>
</span><span id=__span-33-5><a id=__codelineno-33-5 name=__codelineno-33-5 href=#__codelineno-33-5></a><span class=go>            (&#39;2M&#39;, &#39;w2&#39;),</span>
</span><span id=__span-33-6><a id=__codelineno-33-6 name=__codelineno-33-6 href=#__codelineno-33-6></a><span class=go>            (&#39;3M&#39;, &#39;w1&#39;),</span>
</span><span id=__span-33-7><a id=__codelineno-33-7 name=__codelineno-33-7 href=#__codelineno-33-7></a><span class=go>            (&#39;3M&#39;, &#39;w2&#39;)],</span>
</span><span id=__span-33-8><a id=__codelineno-33-8 name=__codelineno-33-8 href=#__codelineno-33-8></a><span class=go>           names=[&#39;every&#39;, &#39;weights&#39;])</span>
</span></code></pre></div> <p>And applies each combination to the asset columns:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>columns</span>
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a><span class=go>MultiIndex([(&#39;1M&#39;, &#39;w1&#39;, &#39;ADAUSDT&#39;),</span>
</span><span id=__span-34-3><a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a><span class=go>            (&#39;1M&#39;, &#39;w1&#39;, &#39;BNBUSDT&#39;),</span>
</span><span id=__span-34-4><a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a><span class=go>            (&#39;1M&#39;, &#39;w1&#39;, &#39;BTCUSDT&#39;),</span>
</span><span id=__span-34-5><a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a><span class=go>            ...</span>
</span><span id=__span-34-6><a id=__codelineno-34-6 name=__codelineno-34-6 href=#__codelineno-34-6></a><span class=go>            (&#39;3M&#39;, &#39;w2&#39;, &#39;BTCUSDT&#39;),</span>
</span><span id=__span-34-7><a id=__codelineno-34-7 name=__codelineno-34-7 href=#__codelineno-34-7></a><span class=go>            (&#39;3M&#39;, &#39;w2&#39;, &#39;ETHUSDT&#39;),</span>
</span><span id=__span-34-8><a id=__codelineno-34-8 name=__codelineno-34-8 href=#__codelineno-34-8></a><span class=go>            (&#39;3M&#39;, &#39;w2&#39;, &#39;XRPUSDT&#39;)],</span>
</span><span id=__span-34-9><a id=__codelineno-34-9 name=__codelineno-34-9 href=#__codelineno-34-9></a><span class=go>           names=[&#39;every&#39;, &#39;weights&#39;, &#39;symbol&#39;])</span>
</span></code></pre></div> <p>To select or plot the allocations for any parameter combination, you can use Pandas-like indexing <strong>on groups</strong>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=p>[(</span><span class=s2>&quot;3M&quot;</span><span class=p>,</span> <span class=s2>&quot;w2&quot;</span><span class=p>)]</span><span class=o>.</span><span class=n>stats</span><span class=p>()</span>
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a><span class=go>Start                       2020-01-01 00:00:00+00:00</span>
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a><span class=go>End                         2020-12-31 23:00:00+00:00</span>
</span><span id=__span-35-4><a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a><span class=go>Period                              365 days 06:00:00</span>
</span><span id=__span-35-5><a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a><span class=go>Total Records                                       4</span>
</span><span id=__span-35-6><a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a><span class=go>Mean Allocation: ADAUSDT                          0.2</span>
</span><span id=__span-35-7><a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a><span class=go>Mean Allocation: BNBUSDT                          0.1</span>
</span><span id=__span-35-8><a id=__codelineno-35-8 name=__codelineno-35-8 href=#__codelineno-35-8></a><span class=go>Mean Allocation: BTCUSDT                          0.1</span>
</span><span id=__span-35-9><a id=__codelineno-35-9 name=__codelineno-35-9 href=#__codelineno-35-9></a><span class=go>Mean Allocation: ETHUSDT                          0.1</span>
</span><span id=__span-35-10><a id=__codelineno-35-10 name=__codelineno-35-10 href=#__codelineno-35-10></a><span class=go>Mean Allocation: XRPUSDT                          0.5</span>
</span><span id=__span-35-11><a id=__codelineno-35-11 name=__codelineno-35-11 href=#__codelineno-35-11></a><span class=go>Name: (3M, w2), dtype: object</span>
</span></code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>When plotting, instead of indexing, you can pass a group name or tuple using the <code>column</code> argument.</p> </div> <p>But what if you have more complex groups? Representing everything with parameters can become cumbersome when arguments barely overlap. Fortunately, you can use the <code>group_configs</code> argument to pass a list of dictionaries, each representing a group and defining its arguments. Let's use this method for the example above:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_allocate_func</span><span class=p>(</span>
</span><span id=__span-36-2><a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-36-3><a id=__codelineno-36-3 name=__codelineno-36-3 href=#__codelineno-36-3></a><span class=gp>... </span>    <span class=n>const_allocate_func</span><span class=p>,</span>
</span><span id=__span-36-4><a id=__codelineno-36-4 name=__codelineno-36-4 href=#__codelineno-36-4></a><span class=gp>... </span>    <span class=n>group_configs</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-36-5><a id=__codelineno-36-5 name=__codelineno-36-5 href=#__codelineno-36-5></a><span class=gp>... </span>        <span class=nb>dict</span><span class=p>(</span><span class=n>args</span><span class=o>=</span><span class=p>([</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>],),</span> <span class=n>every</span><span class=o>=</span><span class=s2>&quot;1M&quot;</span><span class=p>),</span>
</span><span id=__span-36-6><a id=__codelineno-36-6 name=__codelineno-36-6 href=#__codelineno-36-6></a><span class=gp>... </span>        <span class=nb>dict</span><span class=p>(</span><span class=n>args</span><span class=o>=</span><span class=p>([</span><span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>],),</span> <span class=n>every</span><span class=o>=</span><span class=s2>&quot;2M&quot;</span><span class=p>),</span>
</span><span id=__span-36-7><a id=__codelineno-36-7 name=__codelineno-36-7 href=#__codelineno-36-7></a><span class=gp>... </span>        <span class=nb>dict</span><span class=p>(</span><span class=n>args</span><span class=o>=</span><span class=p>([</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>],),</span> <span class=n>every</span><span class=o>=</span><span class=s2>&quot;3M&quot;</span><span class=p>),</span>
</span><span id=__span-36-8><a id=__codelineno-36-8 name=__codelineno-36-8 href=#__codelineno-36-8></a><span class=gp>... </span>        <span class=nb>dict</span><span class=p>(</span><span class=n>args</span><span class=o>=</span><span class=p>([</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>],),</span> <span class=n>every</span><span class=o>=</span><span class=s2>&quot;1M&quot;</span><span class=p>),</span>
</span><span id=__span-36-9><a id=__codelineno-36-9 name=__codelineno-36-9 href=#__codelineno-36-9></a><span class=gp>... </span>        <span class=nb>dict</span><span class=p>(</span><span class=n>args</span><span class=o>=</span><span class=p>([</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>],),</span> <span class=n>every</span><span class=o>=</span><span class=s2>&quot;2M&quot;</span><span class=p>),</span>
</span><span id=__span-36-10><a id=__codelineno-36-10 name=__codelineno-36-10 href=#__codelineno-36-10></a><span class=gp>... </span>        <span class=nb>dict</span><span class=p>(</span><span class=n>args</span><span class=o>=</span><span class=p>([</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>],),</span> <span class=n>every</span><span class=o>=</span><span class=s2>&quot;3M&quot;</span><span class=p>),</span>
</span><span id=__span-36-11><a id=__codelineno-36-11 name=__codelineno-36-11 href=#__codelineno-36-11></a><span class=gp>... </span>    <span class=p>]</span>
</span><span id=__span-36-12><a id=__codelineno-36-12 name=__codelineno-36-12 href=#__codelineno-36-12></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-36-13><a id=__codelineno-36-13 name=__codelineno-36-13 href=#__codelineno-36-13></a><span class=go>pfo.wrapper.grouper.get_index()</span>
</span><span id=__span-36-14><a id=__codelineno-36-14 name=__codelineno-36-14 href=#__codelineno-36-14></a><span class=go>Int64Index([0, 1, 2, 3, 4, 5], dtype=&#39;int64&#39;, name=&#39;group_config&#39;)</span>
</span></code></pre></div> <p>Unlike the previous example, where VBT created two column levels for the parameters, this produces only one, where each number is the index of a group config. Now, let's make it more fun by creating one group with a constant allocation and another group with a random allocation!</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_allocate_func</span><span class=p>(</span>
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-37-3><a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a><span class=gp>... </span>    <span class=n>const_allocate_func</span><span class=p>,</span>
</span><span id=__span-37-4><a id=__codelineno-37-4 name=__codelineno-37-4 href=#__codelineno-37-4></a><span class=gp>... </span>    <span class=n>group_configs</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-37-5><a id=__codelineno-37-5 name=__codelineno-37-5 href=#__codelineno-37-5></a><span class=gp>... </span>        <span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-37-6><a id=__codelineno-37-6 name=__codelineno-37-6 href=#__codelineno-37-6></a><span class=gp>... </span>            <span class=n>allocate_func</span><span class=o>=</span><span class=n>const_allocate_func</span><span class=p>,</span> 
</span><span id=__span-37-7><a id=__codelineno-37-7 name=__codelineno-37-7 href=#__codelineno-37-7></a><span class=gp>... </span>            <span class=n>args</span><span class=o>=</span><span class=p>([</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>],),</span>
</span><span id=__span-37-8><a id=__codelineno-37-8 name=__codelineno-37-8 href=#__codelineno-37-8></a><span class=gp>... </span>            <span class=n>_name</span><span class=o>=</span><span class=s2>&quot;const&quot;</span>  <span class=c1># (1)!</span>
</span><span id=__span-37-9><a id=__codelineno-37-9 name=__codelineno-37-9 href=#__codelineno-37-9></a><span class=gp>... </span>        <span class=p>),</span>
</span><span id=__span-37-10><a id=__codelineno-37-10 name=__codelineno-37-10 href=#__codelineno-37-10></a><span class=gp>... </span>        <span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-37-11><a id=__codelineno-37-11 name=__codelineno-37-11 href=#__codelineno-37-11></a><span class=gp>... </span>            <span class=n>allocate_func</span><span class=o>=</span><span class=n>random_allocate_func</span><span class=p>,</span>
</span><span id=__span-37-12><a id=__codelineno-37-12 name=__codelineno-37-12 href=#__codelineno-37-12></a><span class=gp>... </span>            <span class=n>every</span><span class=o>=</span><span class=s2>&quot;M&quot;</span><span class=p>,</span>
</span><span id=__span-37-13><a id=__codelineno-37-13 name=__codelineno-37-13 href=#__codelineno-37-13></a><span class=gp>... </span>            <span class=n>_name</span><span class=o>=</span><span class=s2>&quot;random&quot;</span>
</span><span id=__span-37-14><a id=__codelineno-37-14 name=__codelineno-37-14 href=#__codelineno-37-14></a><span class=gp>... </span>        <span class=p>),</span>
</span><span id=__span-37-15><a id=__codelineno-37-15 name=__codelineno-37-15 href=#__codelineno-37-15></a><span class=gp>... </span>    <span class=p>]</span>
</span><span id=__span-37-16><a id=__codelineno-37-16 name=__codelineno-37-16 href=#__codelineno-37-16></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-37-17><a id=__codelineno-37-17 name=__codelineno-37-17 href=#__codelineno-37-17></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>grouper</span><span class=o>.</span><span class=n>get_index</span><span class=p>()</span>
</span><span id=__span-37-18><a id=__codelineno-37-18 name=__codelineno-37-18 href=#__codelineno-37-18></a><span class=go>Index([&#39;const&#39;, &#39;random&#39;], dtype=&#39;object&#39;, name=&#39;group_config&#39;)</span>
</span></code></pre></div> <ol> <li>Assign a name to the config with the reserved key <code>_name</code>.</li> </ol> <p>You can also combine <a href=https://vectorbt.pro/pvt_41531c19/api/utils/params/#vectorbtpro.utils.params.Param>Param</a> instances and group configs for maximum flexibility:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_allocate_func</span><span class=p>(</span>
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-38-3><a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a><span class=gp>... </span>    <span class=n>const_allocate_func</span><span class=p>,</span>
</span><span id=__span-38-4><a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a><span class=gp>... </span>    <span class=n>group_configs</span><span class=o>=</span><span class=p>{</span>  <span class=c1># (1)!</span>
</span><span id=__span-38-5><a id=__codelineno-38-5 name=__codelineno-38-5 href=#__codelineno-38-5></a><span class=gp>... </span>        <span class=s2>&quot;const&quot;</span><span class=p>:</span> <span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-38-6><a id=__codelineno-38-6 name=__codelineno-38-6 href=#__codelineno-38-6></a><span class=gp>... </span>            <span class=n>allocate_func</span><span class=o>=</span><span class=n>const_allocate_func</span><span class=p>,</span> 
</span><span id=__span-38-7><a id=__codelineno-38-7 name=__codelineno-38-7 href=#__codelineno-38-7></a><span class=gp>... </span>            <span class=n>args</span><span class=o>=</span><span class=p>([</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>],)</span>
</span><span id=__span-38-8><a id=__codelineno-38-8 name=__codelineno-38-8 href=#__codelineno-38-8></a><span class=gp>... </span>        <span class=p>),</span>
</span><span id=__span-38-9><a id=__codelineno-38-9 name=__codelineno-38-9 href=#__codelineno-38-9></a><span class=gp>... </span>        <span class=s2>&quot;random&quot;</span><span class=p>:</span> <span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-38-10><a id=__codelineno-38-10 name=__codelineno-38-10 href=#__codelineno-38-10></a><span class=gp>... </span>            <span class=n>allocate_func</span><span class=o>=</span><span class=n>random_allocate_func</span><span class=p>,</span>
</span><span id=__span-38-11><a id=__codelineno-38-11 name=__codelineno-38-11 href=#__codelineno-38-11></a><span class=gp>... </span>        <span class=p>),</span>
</span><span id=__span-38-12><a id=__codelineno-38-12 name=__codelineno-38-12 href=#__codelineno-38-12></a><span class=gp>... </span>    <span class=p>},</span>
</span><span id=__span-38-13><a id=__codelineno-38-13 name=__codelineno-38-13 href=#__codelineno-38-13></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Param</span><span class=p>([</span><span class=s2>&quot;1M&quot;</span><span class=p>,</span> <span class=s2>&quot;2M&quot;</span><span class=p>,</span> <span class=s2>&quot;3M&quot;</span><span class=p>])</span>  <span class=c1># (2)!</span>
</span><span id=__span-38-14><a id=__codelineno-38-14 name=__codelineno-38-14 href=#__codelineno-38-14></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-38-15><a id=__codelineno-38-15 name=__codelineno-38-15 href=#__codelineno-38-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>grouper</span><span class=o>.</span><span class=n>get_index</span><span class=p>()</span>
</span><span id=__span-38-16><a id=__codelineno-38-16 name=__codelineno-38-16 href=#__codelineno-38-16></a><span class=go>MultiIndex([(&#39;1M&#39;,  &#39;const&#39;),</span>
</span><span id=__span-38-17><a id=__codelineno-38-17 name=__codelineno-38-17 href=#__codelineno-38-17></a><span class=go>            (&#39;1M&#39;, &#39;random&#39;),</span>
</span><span id=__span-38-18><a id=__codelineno-38-18 name=__codelineno-38-18 href=#__codelineno-38-18></a><span class=go>            (&#39;2M&#39;,  &#39;const&#39;),</span>
</span><span id=__span-38-19><a id=__codelineno-38-19 name=__codelineno-38-19 href=#__codelineno-38-19></a><span class=go>            (&#39;2M&#39;, &#39;random&#39;),</span>
</span><span id=__span-38-20><a id=__codelineno-38-20 name=__codelineno-38-20 href=#__codelineno-38-20></a><span class=go>            (&#39;3M&#39;,  &#39;const&#39;),</span>
</span><span id=__span-38-21><a id=__codelineno-38-21 name=__codelineno-38-21 href=#__codelineno-38-21></a><span class=go>            (&#39;3M&#39;, &#39;random&#39;)],</span>
</span><span id=__span-38-22><a id=__codelineno-38-22 name=__codelineno-38-22 href=#__codelineno-38-22></a><span class=go>           names=[&#39;every&#39;, &#39;group_config&#39;])</span>
</span></code></pre></div> <ol> <li>You can also provide group configs as a dictionary with configuration names as keys.</li> <li>Make sure that any parameterized argument is not redefined in any group config.</li> </ol> <div class="admonition info"> <p class=admonition-title>Info</p> <p>The column levels for parameters are always placed above those for group configs.</p> </div> <h4 id=numba>Numba<a class=headerlink href=#numba title="Permanent link">&para;</a></h4> <p>By default, VBT iterates over index points with a standard Python for-loop. This has almost no effect on performance if the number of allocations is low, which is typical in portfolio optimization. This is because running the allocation function itself takes much longer than a single loop iteration. However, when the number of iterations reaches tens of thousands, it may be worth using Numba for iteration.</p> <p>To enable Numba, set <code>jitted_loop</code> to True. In this case, index points are iterated using <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/nb/#vectorbtpro.portfolio.pfopt.nb.allocate_meta_nb>allocate_meta_nb</a>, which passes the current iteration index, the current index point, and <code>*args</code>.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Variable keyword arguments are not supported by Numba yet.</p> </div> <p>Let's implement the rotation example with Numba, rebalancing every day:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-39-2><a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>rotation_allocate_func_nb</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>idx</span><span class=p>,</span> <span class=n>n_cols</span><span class=p>):</span>
</span><span id=__span-39-3><a id=__codelineno-39-3 name=__codelineno-39-3 href=#__codelineno-39-3></a><span class=gp>... </span>    <span class=n>weights</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>n_cols</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span><span id=__span-39-4><a id=__codelineno-39-4 name=__codelineno-39-4 href=#__codelineno-39-4></a><span class=gp>... </span>    <span class=n>weights</span><span class=p>[</span><span class=n>i</span> <span class=o>%</span> <span class=n>n_cols</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span>
</span><span id=__span-39-5><a id=__codelineno-39-5 name=__codelineno-39-5 href=#__codelineno-39-5></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>weights</span>
</span><span id=__span-39-6><a id=__codelineno-39-6 name=__codelineno-39-6 href=#__codelineno-39-6></a>
</span><span id=__span-39-7><a id=__codelineno-39-7 name=__codelineno-39-7 href=#__codelineno-39-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_allocate_func</span><span class=p>(</span>
</span><span id=__span-39-8><a id=__codelineno-39-8 name=__codelineno-39-8 href=#__codelineno-39-8></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-39-9><a id=__codelineno-39-9 name=__codelineno-39-9 href=#__codelineno-39-9></a><span class=gp>... </span>    <span class=n>rotation_allocate_func_nb</span><span class=p>,</span>
</span><span id=__span-39-10><a id=__codelineno-39-10 name=__codelineno-39-10 href=#__codelineno-39-10></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;len(wrapper.columns)&quot;</span><span class=p>),</span>
</span><span id=__span-39-11><a id=__codelineno-39-11 name=__codelineno-39-11 href=#__codelineno-39-11></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=s2>&quot;D&quot;</span><span class=p>,</span>
</span><span id=__span-39-12><a id=__codelineno-39-12 name=__codelineno-39-12 href=#__codelineno-39-12></a><span class=gp>... </span>    <span class=n>jitted_loop</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-39-13><a id=__codelineno-39-13 name=__codelineno-39-13 href=#__codelineno-39-13></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-39-14><a id=__codelineno-39-14 name=__codelineno-39-14 href=#__codelineno-39-14></a>
</span><span id=__span-39-15><a id=__codelineno-39-15 name=__codelineno-39-15 href=#__codelineno-39-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>allocations</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span><span id=__span-39-16><a id=__codelineno-39-16 name=__codelineno-39-16 href=#__codelineno-39-16></a><span class=go>symbol                     ADAUSDT  BNBUSDT  BTCUSDT  ETHUSDT  XRPUSDT</span>
</span><span id=__span-39-17><a id=__codelineno-39-17 name=__codelineno-39-17 href=#__codelineno-39-17></a><span class=go>Open time</span>
</span><span id=__span-39-18><a id=__codelineno-39-18 name=__codelineno-39-18 href=#__codelineno-39-18></a><span class=go>2020-01-05 00:00:00+00:00      1.0      0.0      0.0      0.0      0.0</span>
</span><span id=__span-39-19><a id=__codelineno-39-19 name=__codelineno-39-19 href=#__codelineno-39-19></a><span class=go>2020-01-12 00:00:00+00:00      0.0      1.0      0.0      0.0      0.0</span>
</span><span id=__span-39-20><a id=__codelineno-39-20 name=__codelineno-39-20 href=#__codelineno-39-20></a><span class=go>2020-01-19 00:00:00+00:00      0.0      0.0      1.0      0.0      0.0</span>
</span><span id=__span-39-21><a id=__codelineno-39-21 name=__codelineno-39-21 href=#__codelineno-39-21></a><span class=go>2020-01-26 00:00:00+00:00      0.0      0.0      0.0      1.0      0.0</span>
</span><span id=__span-39-22><a id=__codelineno-39-22 name=__codelineno-39-22 href=#__codelineno-39-22></a><span class=go>2020-02-02 00:00:00+00:00      0.0      0.0      0.0      0.0      1.0</span>
</span></code></pre></div> <h4 id=distribution>Distribution<a class=headerlink href=#distribution title="Permanent link">&para;</a></h4> <p>For the best performance, you can also run the allocation function in a distributed way, as long as each function call does not depend on previous calls. This is only an issue if you are storing state in a custom variable.</p> <p>If the jitted loop is disabled, VBT sends all iterations to the <a href=https://vectorbt.pro/pvt_41531c19/api/utils/execution/#vectorbtpro.utils.execution.execute>execute</a> function, which is VBT's in-house execution infrastructure. This works much like how indicator parameter combinations are distributed. In fact, the same argument <code>execute_kwargs</code> is available to control execution.</p> <p>Let's disable the jitted loop and pass all arguments required by our Numba-compiled function <code>rotation_allocate_func_nb</code> using templates (since the function is not called by <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/nb/#vectorbtpro.portfolio.pfopt.nb.allocate_meta_nb>allocate_meta_nb</a> anymore!):</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-40-1><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_allocate_func</span><span class=p>(</span>
</span><span id=__span-40-2><a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-40-3><a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a><span class=gp>... </span>    <span class=n>rotation_allocate_func_nb</span><span class=p>,</span>
</span><span id=__span-40-4><a id=__codelineno-40-4 name=__codelineno-40-4 href=#__codelineno-40-4></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;i&quot;</span><span class=p>),</span>
</span><span id=__span-40-5><a id=__codelineno-40-5 name=__codelineno-40-5 href=#__codelineno-40-5></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;index_point&quot;</span><span class=p>),</span>
</span><span id=__span-40-6><a id=__codelineno-40-6 name=__codelineno-40-6 href=#__codelineno-40-6></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;len(wrapper.columns)&quot;</span><span class=p>),</span>
</span><span id=__span-40-7><a id=__codelineno-40-7 name=__codelineno-40-7 href=#__codelineno-40-7></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=s2>&quot;D&quot;</span><span class=p>,</span>
</span><span id=__span-40-8><a id=__codelineno-40-8 name=__codelineno-40-8 href=#__codelineno-40-8></a><span class=gp>... </span>    <span class=n>execute_kwargs</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>engine</span><span class=o>=</span><span class=s2>&quot;dask&quot;</span><span class=p>)</span>
</span><span id=__span-40-9><a id=__codelineno-40-9 name=__codelineno-40-9 href=#__codelineno-40-9></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-40-10><a id=__codelineno-40-10 name=__codelineno-40-10 href=#__codelineno-40-10></a>
</span><span id=__span-40-11><a id=__codelineno-40-11 name=__codelineno-40-11 href=#__codelineno-40-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>allocations</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span><span id=__span-40-12><a id=__codelineno-40-12 name=__codelineno-40-12 href=#__codelineno-40-12></a><span class=go>symbol                     ADAUSDT  BNBUSDT  BTCUSDT  ETHUSDT  XRPUSDT</span>
</span><span id=__span-40-13><a id=__codelineno-40-13 name=__codelineno-40-13 href=#__codelineno-40-13></a><span class=go>Open time</span>
</span><span id=__span-40-14><a id=__codelineno-40-14 name=__codelineno-40-14 href=#__codelineno-40-14></a><span class=go>2020-01-01 00:00:00+00:00        1        0        0        0        0</span>
</span><span id=__span-40-15><a id=__codelineno-40-15 name=__codelineno-40-15 href=#__codelineno-40-15></a><span class=go>2020-01-02 00:00:00+00:00        0        1        0        0        0</span>
</span><span id=__span-40-16><a id=__codelineno-40-16 name=__codelineno-40-16 href=#__codelineno-40-16></a><span class=go>2020-01-03 00:00:00+00:00        0        0        1        0        0</span>
</span><span id=__span-40-17><a id=__codelineno-40-17 name=__codelineno-40-17 href=#__codelineno-40-17></a><span class=go>2020-01-04 00:00:00+00:00        0        0        0        1        0</span>
</span><span id=__span-40-18><a id=__codelineno-40-18 name=__codelineno-40-18 href=#__codelineno-40-18></a><span class=go>2020-01-05 00:00:00+00:00        0        0        0        0        1</span>
</span></code></pre></div> <p>There is another great option for distributing the allocation process: enable the jitted loop with <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/nb/#vectorbtpro.portfolio.pfopt.nb.allocate_meta_nb>allocate_meta_nb</a> and use chunking. This way, you can split index points into chunks and iterate over each chunk entirely within Numba. Control chunking with the <code>chunked</code> argument, which is resolved and passed to <a href=https://vectorbt.pro/pvt_41531c19/api/utils/chunking/#vectorbtpro.utils.chunking.chunked>chunked</a>. Just remember to supply a chunking specification for all extra arguments required by the allocation function:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-41-1><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_allocate_func</span><span class=p>(</span>
</span><span id=__span-41-2><a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-41-3><a id=__codelineno-41-3 name=__codelineno-41-3 href=#__codelineno-41-3></a><span class=gp>... </span>    <span class=n>rotation_allocate_func_nb</span><span class=p>,</span>
</span><span id=__span-41-4><a id=__codelineno-41-4 name=__codelineno-41-4 href=#__codelineno-41-4></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;len(wrapper.columns)&quot;</span><span class=p>),</span>
</span><span id=__span-41-5><a id=__codelineno-41-5 name=__codelineno-41-5 href=#__codelineno-41-5></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=s2>&quot;D&quot;</span><span class=p>,</span>
</span><span id=__span-41-6><a id=__codelineno-41-6 name=__codelineno-41-6 href=#__codelineno-41-6></a><span class=gp>... </span>    <span class=n>jitted_loop</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-41-7><a id=__codelineno-41-7 name=__codelineno-41-7 href=#__codelineno-41-7></a><span class=gp>... </span>    <span class=n>chunked</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span>
</span><span id=__span-41-8><a id=__codelineno-41-8 name=__codelineno-41-8 href=#__codelineno-41-8></a><span class=gp>... </span>        <span class=n>arg_take_spec</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>args</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>ArgsTaker</span><span class=p>(</span><span class=kc>None</span><span class=p>)),</span>  <span class=c1># (1)!</span>
</span><span id=__span-41-9><a id=__codelineno-41-9 name=__codelineno-41-9 href=#__codelineno-41-9></a><span class=gp>... </span>        <span class=n>engine</span><span class=o>=</span><span class=s2>&quot;dask&quot;</span>
</span><span id=__span-41-10><a id=__codelineno-41-10 name=__codelineno-41-10 href=#__codelineno-41-10></a><span class=gp>... </span>    <span class=p>)</span>
</span><span id=__span-41-11><a id=__codelineno-41-11 name=__codelineno-41-11 href=#__codelineno-41-11></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-41-12><a id=__codelineno-41-12 name=__codelineno-41-12 href=#__codelineno-41-12></a><span class=go>symbol                     ADAUSDT  BNBUSDT  BTCUSDT  ETHUSDT  XRPUSDT</span>
</span><span id=__span-41-13><a id=__codelineno-41-13 name=__codelineno-41-13 href=#__codelineno-41-13></a><span class=go>Open time</span>
</span><span id=__span-41-14><a id=__codelineno-41-14 name=__codelineno-41-14 href=#__codelineno-41-14></a><span class=go>2020-01-01 00:00:00+00:00      1.0      0.0      0.0      0.0      0.0</span>
</span><span id=__span-41-15><a id=__codelineno-41-15 name=__codelineno-41-15 href=#__codelineno-41-15></a><span class=go>2020-01-02 00:00:00+00:00      0.0      1.0      0.0      0.0      0.0</span>
</span><span id=__span-41-16><a id=__codelineno-41-16 name=__codelineno-41-16 href=#__codelineno-41-16></a><span class=go>2020-01-03 00:00:00+00:00      0.0      0.0      1.0      0.0      0.0</span>
</span><span id=__span-41-17><a id=__codelineno-41-17 name=__codelineno-41-17 href=#__codelineno-41-17></a><span class=go>2020-01-04 00:00:00+00:00      0.0      0.0      0.0      1.0      0.0</span>
</span><span id=__span-41-18><a id=__codelineno-41-18 name=__codelineno-41-18 href=#__codelineno-41-18></a><span class=go>2020-01-05 00:00:00+00:00      0.0      0.0      0.0      0.0      1.0</span>
</span></code></pre></div> <ol> <li>The argument <code>n_cols</code> used by <code>rotation_allocate_func_nb</code> is passed as the first argument through <code>*args</code> to <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/nb/#vectorbtpro.portfolio.pfopt.nb.allocate_meta_nb>allocate_meta_nb</a>. This is why we use <a href=https://vectorbt.pro/pvt_41531c19/api/utils/chunking/#vectorbtpro.utils.chunking.ArgsTaker>ArgsTaker</a> to specify that the first argument should not be split in any way (since we are chunking rows, not columns). Otherwise, a warning will be triggered.</li> </ol> <p>If you are not tired of all these distribution options, here is another one: parallelize the iteration internally with Numba. This can be done with the <code>jitted</code> argument, which is resolved and passed to the <code>@njit</code> decorator of <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/nb/#vectorbtpro.portfolio.pfopt.nb.allocate_meta_nb>allocate_meta_nb</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-42-1><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_allocate_func</span><span class=p>(</span>
</span><span id=__span-42-2><a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-42-3><a id=__codelineno-42-3 name=__codelineno-42-3 href=#__codelineno-42-3></a><span class=gp>... </span>    <span class=n>rotation_allocate_func_nb</span><span class=p>,</span>
</span><span id=__span-42-4><a id=__codelineno-42-4 name=__codelineno-42-4 href=#__codelineno-42-4></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>RepEval</span><span class=p>(</span><span class=s2>&quot;len(wrapper.columns)&quot;</span><span class=p>),</span>
</span><span id=__span-42-5><a id=__codelineno-42-5 name=__codelineno-42-5 href=#__codelineno-42-5></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=s2>&quot;D&quot;</span><span class=p>,</span>
</span><span id=__span-42-6><a id=__codelineno-42-6 name=__codelineno-42-6 href=#__codelineno-42-6></a><span class=gp>... </span>    <span class=n>jitted_loop</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-42-7><a id=__codelineno-42-7 name=__codelineno-42-7 href=#__codelineno-42-7></a><span class=gp>... </span>    <span class=n>jitted</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>parallel</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-42-8><a id=__codelineno-42-8 name=__codelineno-42-8 href=#__codelineno-42-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-42-9><a id=__codelineno-42-9 name=__codelineno-42-9 href=#__codelineno-42-9></a>
</span><span id=__span-42-10><a id=__codelineno-42-10 name=__codelineno-42-10 href=#__codelineno-42-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>allocations</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span><span id=__span-42-11><a id=__codelineno-42-11 name=__codelineno-42-11 href=#__codelineno-42-11></a><span class=go>symbol                     ADAUSDT  BNBUSDT  BTCUSDT  ETHUSDT  XRPUSDT</span>
</span><span id=__span-42-12><a id=__codelineno-42-12 name=__codelineno-42-12 href=#__codelineno-42-12></a><span class=go>Open time</span>
</span><span id=__span-42-13><a id=__codelineno-42-13 name=__codelineno-42-13 href=#__codelineno-42-13></a><span class=go>2020-01-01 00:00:00+00:00      1.0      0.0      0.0      0.0      0.0</span>
</span><span id=__span-42-14><a id=__codelineno-42-14 name=__codelineno-42-14 href=#__codelineno-42-14></a><span class=go>2020-01-02 00:00:00+00:00      0.0      1.0      0.0      0.0      0.0</span>
</span><span id=__span-42-15><a id=__codelineno-42-15 name=__codelineno-42-15 href=#__codelineno-42-15></a><span class=go>2020-01-03 00:00:00+00:00      0.0      0.0      1.0      0.0      0.0</span>
</span><span id=__span-42-16><a id=__codelineno-42-16 name=__codelineno-42-16 href=#__codelineno-42-16></a><span class=go>2020-01-04 00:00:00+00:00      0.0      0.0      0.0      1.0      0.0</span>
</span><span id=__span-42-17><a id=__codelineno-42-17 name=__codelineno-42-17 href=#__codelineno-42-17></a><span class=go>2020-01-05 00:00:00+00:00      0.0      0.0      0.0      0.0      1.0</span>
</span></code></pre></div> <h4 id=previous-allocation>Previous allocation<a class=headerlink href=#previous-allocation title="Permanent link">&para;</a></h4> <p>To access the allocation created in the previous step, you must disable all distribution (in other words, run the allocation function serially) and use a temporary list or another container to store all generated allocations. Each time the allocation function is called, it will generate a new allocation and save it in the container, making it accessible for the next step. Let's slightly randomize each previous allocation to create a new one:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-43-1><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>randomize_prev_allocate_func</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>allocations</span><span class=p>,</span> <span class=n>mean</span><span class=p>,</span> <span class=n>std</span><span class=p>):</span>
</span><span id=__span-43-2><a id=__codelineno-43-2 name=__codelineno-43-2 href=#__codelineno-43-2></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>i</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-43-3><a id=__codelineno-43-3 name=__codelineno-43-3 href=#__codelineno-43-3></a><span class=gp>... </span>        <span class=k>return</span> <span class=n>allocations</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>  <span class=c1># (1)!</span>
</span><span id=__span-43-4><a id=__codelineno-43-4 name=__codelineno-43-4 href=#__codelineno-43-4></a><span class=gp>... </span>    <span class=n>prev_allocation</span> <span class=o>=</span> <span class=n>allocations</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>  <span class=c1># (2)!</span>
</span><span id=__span-43-5><a id=__codelineno-43-5 name=__codelineno-43-5 href=#__codelineno-43-5></a><span class=gp>... </span>    <span class=n>log_returns</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=n>mean</span><span class=p>,</span> <span class=n>std</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>prev_allocation</span><span class=p>))</span>  <span class=c1># (3)!</span>
</span><span id=__span-43-6><a id=__codelineno-43-6 name=__codelineno-43-6 href=#__codelineno-43-6></a><span class=gp>... </span>    <span class=n>returns</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>exp</span><span class=p>(</span><span class=n>log_returns</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span>  <span class=c1># (4)!</span>
</span><span id=__span-43-7><a id=__codelineno-43-7 name=__codelineno-43-7 href=#__codelineno-43-7></a><span class=gp>... </span>    <span class=n>new_allocation</span> <span class=o>=</span> <span class=n>prev_allocation</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>returns</span><span class=p>)</span>  <span class=c1># (5)!</span>
</span><span id=__span-43-8><a id=__codelineno-43-8 name=__codelineno-43-8 href=#__codelineno-43-8></a><span class=gp>... </span>    <span class=n>new_allocation</span> <span class=o>=</span> <span class=n>new_allocation</span> <span class=o>/</span> <span class=n>new_allocation</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>  <span class=c1># (6)!</span>
</span><span id=__span-43-9><a id=__codelineno-43-9 name=__codelineno-43-9 href=#__codelineno-43-9></a><span class=gp>... </span>    <span class=n>allocations</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>new_allocation</span><span class=p>)</span>  <span class=c1># (7)!</span>
</span><span id=__span-43-10><a id=__codelineno-43-10 name=__codelineno-43-10 href=#__codelineno-43-10></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>new_allocation</span>
</span><span id=__span-43-11><a id=__codelineno-43-11 name=__codelineno-43-11 href=#__codelineno-43-11></a>
</span><span id=__span-43-12><a id=__codelineno-43-12 name=__codelineno-43-12 href=#__codelineno-43-12></a><span class=gp>&gt;&gt;&gt; </span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
</span><span id=__span-43-13><a id=__codelineno-43-13 name=__codelineno-43-13 href=#__codelineno-43-13></a>
</span><span id=__span-43-14><a id=__codelineno-43-14 name=__codelineno-43-14 href=#__codelineno-43-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>n_symbols</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span>
</span><span id=__span-43-15><a id=__codelineno-43-15 name=__codelineno-43-15 href=#__codelineno-43-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>init_allocation</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>n_symbols</span><span class=p>,</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>n_symbols</span><span class=p>)</span>
</span><span id=__span-43-16><a id=__codelineno-43-16 name=__codelineno-43-16 href=#__codelineno-43-16></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_allocate_func</span><span class=p>(</span>
</span><span id=__span-43-17><a id=__codelineno-43-17 name=__codelineno-43-17 href=#__codelineno-43-17></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-43-18><a id=__codelineno-43-18 name=__codelineno-43-18 href=#__codelineno-43-18></a><span class=gp>... </span>    <span class=n>randomize_prev_allocate_func</span><span class=p>,</span>
</span><span id=__span-43-19><a id=__codelineno-43-19 name=__codelineno-43-19 href=#__codelineno-43-19></a><span class=gp>... </span>    <span class=n>i</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;i&quot;</span><span class=p>),</span>  <span class=c1># (8)!</span>
</span><span id=__span-43-20><a id=__codelineno-43-20 name=__codelineno-43-20 href=#__codelineno-43-20></a><span class=gp>... </span>    <span class=n>allocations</span><span class=o>=</span><span class=p>[</span><span class=n>init_allocation</span><span class=p>],</span>  <span class=c1># (9)!</span>
</span><span id=__span-43-21><a id=__codelineno-43-21 name=__codelineno-43-21 href=#__codelineno-43-21></a><span class=gp>... </span>    <span class=n>mean</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span><span id=__span-43-22><a id=__codelineno-43-22 name=__codelineno-43-22 href=#__codelineno-43-22></a><span class=gp>... </span>    <span class=n>std</span><span class=o>=</span><span class=mf>0.5</span><span class=p>,</span>
</span><span id=__span-43-23><a id=__codelineno-43-23 name=__codelineno-43-23 href=#__codelineno-43-23></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=s2>&quot;W&quot;</span><span class=p>,</span>
</span><span id=__span-43-24><a id=__codelineno-43-24 name=__codelineno-43-24 href=#__codelineno-43-24></a><span class=gp>... </span>    <span class=n>start</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>  <span class=c1># (10)!</span>
</span><span id=__span-43-25><a id=__codelineno-43-25 name=__codelineno-43-25 href=#__codelineno-43-25></a><span class=gp>... </span>    <span class=n>exact_start</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-43-26><a id=__codelineno-43-26 name=__codelineno-43-26 href=#__codelineno-43-26></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-43-27><a id=__codelineno-43-27 name=__codelineno-43-27 href=#__codelineno-43-27></a>
</span><span id=__span-43-28><a id=__codelineno-43-28 name=__codelineno-43-28 href=#__codelineno-43-28></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>plot</span><span class=p>()</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <ol> <li>Use the initial allocation at the very first step.</li> <li>For later steps, access the last allocation in the list.</li> <li>Sample random log returns from a normal distribution using the provided parameters.</li> <li>Convert the log returns to simple returns.</li> <li>Apply the simple returns to the previous allocation.</li> <li>Make sure the new allocation sums to 1.</li> <li>Add the new allocation to the list to use at the next step.</li> <li>Instruct VBT to pass the iteration number as <code>i</code>.</li> <li>Create a list to be shared among function calls.</li> <li>Start exactly from the first timestamp to use the initial allocation.</li> </ol> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/prev_allocation.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/prev_allocation.dark.svg#only-dark></p> <h4 id=current-allocation>Current allocation<a class=headerlink href=#current-allocation title="Permanent link">&para;</a></h4> <p>Now that you know how to access the previous allocation, how do you get the current (updated) allocation, since it has changed over time? You can simply forward-simulate it!</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-44-1><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>current_allocate_func</span><span class=p>(</span><span class=n>price</span><span class=p>,</span> <span class=n>index_point</span><span class=p>,</span> <span class=n>alloc_info</span><span class=p>):</span>
</span><span id=__span-44-2><a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a><span class=gp>... </span>    <span class=n>prev_alloc_info</span> <span class=o>=</span> <span class=n>alloc_info</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-44-3><a id=__codelineno-44-3 name=__codelineno-44-3 href=#__codelineno-44-3></a><span class=gp>... </span>    <span class=n>prev_index_point</span> <span class=o>=</span> <span class=n>prev_alloc_info</span><span class=p>[</span><span class=s2>&quot;index_point&quot;</span><span class=p>]</span>
</span><span id=__span-44-4><a id=__codelineno-44-4 name=__codelineno-44-4 href=#__codelineno-44-4></a><span class=gp>... </span>    <span class=n>prev_allocation</span> <span class=o>=</span> <span class=n>prev_alloc_info</span><span class=p>[</span><span class=s2>&quot;allocation&quot;</span><span class=p>]</span>
</span><span id=__span-44-5><a id=__codelineno-44-5 name=__codelineno-44-5 href=#__codelineno-44-5></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>prev_index_point</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-44-6><a id=__codelineno-44-6 name=__codelineno-44-6 href=#__codelineno-44-6></a><span class=gp>... </span>        <span class=n>current_allocation</span> <span class=o>=</span> <span class=n>prev_allocation</span>
</span><span id=__span-44-7><a id=__codelineno-44-7 name=__codelineno-44-7 href=#__codelineno-44-7></a><span class=gp>... </span>    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-44-8><a id=__codelineno-44-8 name=__codelineno-44-8 href=#__codelineno-44-8></a><span class=gp>... </span>        <span class=n>prev_price_period</span> <span class=o>=</span> <span class=n>price</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>prev_index_point</span><span class=p>:</span><span class=n>index_point</span><span class=p>]</span>  <span class=c1># (1)!</span>
</span><span id=__span-44-9><a id=__codelineno-44-9 name=__codelineno-44-9 href=#__codelineno-44-9></a><span class=gp>... </span>        <span class=n>prev_pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PFO</span><span class=o>.</span><span class=n>from_initial</span><span class=p>(</span><span class=n>prev_price_period</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>wrapper</span><span class=p>,</span> <span class=n>prev_allocation</span><span class=p>)</span>  <span class=c1># (2)!</span>
</span><span id=__span-44-10><a id=__codelineno-44-10 name=__codelineno-44-10 href=#__codelineno-44-10></a><span class=gp>... </span>        <span class=n>prev_pf</span> <span class=o>=</span> <span class=n>prev_pfo</span><span class=o>.</span><span class=n>simulate</span><span class=p>(</span><span class=n>prev_price_period</span><span class=p>)</span>
</span><span id=__span-44-11><a id=__codelineno-44-11 name=__codelineno-44-11 href=#__codelineno-44-11></a><span class=gp>... </span>        <span class=n>current_allocation</span> <span class=o>=</span> <span class=n>prev_pf</span><span class=o>.</span><span class=n>allocations</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>  <span class=c1># (3)!</span>
</span><span id=__span-44-12><a id=__codelineno-44-12 name=__codelineno-44-12 href=#__codelineno-44-12></a><span class=gp>... </span>    <span class=n>alloc_info</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>dict</span><span class=p>(</span>  <span class=c1># (4)!</span>
</span><span id=__span-44-13><a id=__codelineno-44-13 name=__codelineno-44-13 href=#__codelineno-44-13></a><span class=gp>... </span>        <span class=n>index_point</span><span class=o>=</span><span class=n>index_point</span><span class=p>,</span>
</span><span id=__span-44-14><a id=__codelineno-44-14 name=__codelineno-44-14 href=#__codelineno-44-14></a><span class=gp>... </span>        <span class=n>allocation</span><span class=o>=</span><span class=n>current_allocation</span><span class=p>,</span>
</span><span id=__span-44-15><a id=__codelineno-44-15 name=__codelineno-44-15 href=#__codelineno-44-15></a><span class=gp>... </span>    <span class=p>))</span>
</span><span id=__span-44-16><a id=__codelineno-44-16 name=__codelineno-44-16 href=#__codelineno-44-16></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>current_allocation</span>
</span><span id=__span-44-17><a id=__codelineno-44-17 name=__codelineno-44-17 href=#__codelineno-44-17></a>
</span><span id=__span-44-18><a id=__codelineno-44-18 name=__codelineno-44-18 href=#__codelineno-44-18></a><span class=gp>&gt;&gt;&gt; </span><span class=n>n_symbols</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span>
</span><span id=__span-44-19><a id=__codelineno-44-19 name=__codelineno-44-19 href=#__codelineno-44-19></a><span class=gp>&gt;&gt;&gt; </span><span class=n>init_allocation</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>n_symbols</span><span class=p>,</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>n_symbols</span><span class=p>)</span>
</span><span id=__span-44-20><a id=__codelineno-44-20 name=__codelineno-44-20 href=#__codelineno-44-20></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_allocate_func</span><span class=p>(</span>
</span><span id=__span-44-21><a id=__codelineno-44-21 name=__codelineno-44-21 href=#__codelineno-44-21></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-44-22><a id=__codelineno-44-22 name=__codelineno-44-22 href=#__codelineno-44-22></a><span class=gp>... </span>    <span class=n>current_allocate_func</span><span class=p>,</span>
</span><span id=__span-44-23><a id=__codelineno-44-23 name=__codelineno-44-23 href=#__codelineno-44-23></a><span class=gp>... </span>    <span class=n>price</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>),</span>
</span><span id=__span-44-24><a id=__codelineno-44-24 name=__codelineno-44-24 href=#__codelineno-44-24></a><span class=gp>... </span>    <span class=n>index_point</span><span class=o>=</span><span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;index_point&quot;</span><span class=p>),</span>
</span><span id=__span-44-25><a id=__codelineno-44-25 name=__codelineno-44-25 href=#__codelineno-44-25></a><span class=gp>... </span>    <span class=n>alloc_info</span><span class=o>=</span><span class=p>[</span><span class=nb>dict</span><span class=p>(</span><span class=n>index_point</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>allocation</span><span class=o>=</span><span class=n>init_allocation</span><span class=p>)],</span>  <span class=c1># (5)!</span>
</span><span id=__span-44-26><a id=__codelineno-44-26 name=__codelineno-44-26 href=#__codelineno-44-26></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=s2>&quot;W&quot;</span><span class=p>,</span>
</span><span id=__span-44-27><a id=__codelineno-44-27 name=__codelineno-44-27 href=#__codelineno-44-27></a><span class=gp>... </span>    <span class=n>start</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span><span id=__span-44-28><a id=__codelineno-44-28 name=__codelineno-44-28 href=#__codelineno-44-28></a><span class=gp>... </span>    <span class=n>exact_start</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-44-29><a id=__codelineno-44-29 name=__codelineno-44-29 href=#__codelineno-44-29></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-44-30><a id=__codelineno-44-30 name=__codelineno-44-30 href=#__codelineno-44-30></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>plot</span><span class=p>()</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <ol> <li>Select the prices for the period between the previous step (inclusive) and the current step (exclusive).</li> <li>Create a smaller optimizer that starts from the previous allocation and simulates it for that period.</li> <li>The last allocation in the simulated portfolio is the current allocation.</li> <li>Add the current allocation and its index to the list for the next step.</li> <li>Tip: If you want to access this list later, define it as a separate variable.</li> </ol> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/current_allocation.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/current_allocation.dark.svg#only-dark></p> <p>The code above accesses the previous allocation, simulates the forward return, and then uses the last allocation of the simulated portfolio as the new one. This is equivalent to simulating only the initial allocation <img alt=✨ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2728.svg title=:sparkles:></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-45-1><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>init_pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PFO</span><span class=o>.</span><span class=n>from_initial</span><span class=p>(</span><span class=n>symbol_wrapper</span><span class=p>,</span> <span class=n>init_allocation</span><span class=p>)</span>
</span><span id=__span-45-2><a id=__codelineno-45-2 name=__codelineno-45-2 href=#__codelineno-45-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>continuous_pf</span> <span class=o>=</span> <span class=n>pfo</span><span class=o>.</span><span class=n>simulate</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>))</span>
</span><span id=__span-45-3><a id=__codelineno-45-3 name=__codelineno-45-3 href=#__codelineno-45-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>index_points</span> <span class=o>=</span> <span class=n>symbol_wrapper</span><span class=o>.</span><span class=n>get_index_points</span><span class=p>(</span><span class=n>every</span><span class=o>=</span><span class=s2>&quot;W&quot;</span><span class=p>,</span> <span class=n>start</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>exact_start</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-45-4><a id=__codelineno-45-4 name=__codelineno-45-4 href=#__codelineno-45-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>discrete_pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PFO</span><span class=o>.</span><span class=n>from_allocations</span><span class=p>(</span><span class=n>symbol_wrapper</span><span class=p>,</span> <span class=n>continuous_pf</span><span class=o>.</span><span class=n>allocations</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>index_points</span><span class=p>])</span>
</span><span id=__span-45-5><a id=__codelineno-45-5 name=__codelineno-45-5 href=#__codelineno-45-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>discrete_pfo</span><span class=o>.</span><span class=n>plot</span><span class=p>()</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/current_allocation.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/current_allocation.dark.svg#only-dark></p> <h2 id=optimization>Optimization<a class=headerlink href=#optimization title="Permanent link">&para;</a></h2> <p>Periodic allocation can be useful, but it offers somewhat limited capabilities compared to what is possible. Consider a common scenario where you want to rebalance based on a data window instead of just at fixed points in time. If you use an allocation function, you would need to track either the previous allocation or the lookback period. To make this process easier, VBT provides an "optimization" function that operates over a range of timestamps.</p> <h3 id=index-ranges>Index ranges<a class=headerlink href=#index-ranges title="Permanent link">&para;</a></h3> <p>Like index points, index ranges are collections of indices, but each element represents a range of indices instead of a single point. In VBT, index ranges are usually represented by a two-dimensional NumPy array, where the first column contains the range start indices (inclusive), and the second column contains the range end indices (exclusive). Just as we used <a href=https://vectorbt.pro/pvt_41531c19/api/base/wrapping/#vectorbtpro.base.wrapping.ArrayWrapper.get_index_points>ArrayWrapper.get_index_points</a> to turn human-readable queries into arrays of indices, we can use <a href=https://vectorbt.pro/pvt_41531c19/api/base/wrapping/#vectorbtpro.base.wrapping.ArrayWrapper.get_index_ranges>ArrayWrapper.get_index_ranges</a> to create similar queries for index ranges.</p> <p>Let's demonstrate how to use this method by dividing the entire period into monthly ranges:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-46-1><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>example_ranges</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>get_index_ranges</span><span class=p>(</span><span class=n>every</span><span class=o>=</span><span class=s2>&quot;M&quot;</span><span class=p>)</span>
</span><span id=__span-46-2><a id=__codelineno-46-2 name=__codelineno-46-2 href=#__codelineno-46-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>example_ranges</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span><span id=__span-46-3><a id=__codelineno-46-3 name=__codelineno-46-3 href=#__codelineno-46-3></a><span class=go>array([0, 744, 1434, 2177, 2895, 3639, 4356, 5100, 5844, 6564, 7308])</span>
</span><span id=__span-46-4><a id=__codelineno-46-4 name=__codelineno-46-4 href=#__codelineno-46-4></a>
</span><span id=__span-46-5><a id=__codelineno-46-5 name=__codelineno-46-5 href=#__codelineno-46-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>example_ranges</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-46-6><a id=__codelineno-46-6 name=__codelineno-46-6 href=#__codelineno-46-6></a><span class=go>array([744, 1434, 2177, 2895, 3639, 4356, 5100, 5844, 6564, 7308, 8027])</span>
</span></code></pre></div> <p>Here's what happened: VBT created a new datetime index with a monthly frequency and generated a range from each pair of values in that index.</p> <p>To convert each index range back to timestamps:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-47-1><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>example_ranges</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]:</span><span class=n>example_ranges</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]]</span>  <span class=c1># (1)!</span>
</span><span id=__span-47-2><a id=__codelineno-47-2 name=__codelineno-47-2 href=#__codelineno-47-2></a><span class=go>DatetimeIndex([&#39;2020-01-01 00:00:00+00:00&#39;, &#39;2020-01-01 01:00:00+00:00&#39;,</span>
</span><span id=__span-47-3><a id=__codelineno-47-3 name=__codelineno-47-3 href=#__codelineno-47-3></a><span class=go>               &#39;2020-01-01 02:00:00+00:00&#39;, &#39;2020-01-01 03:00:00+00:00&#39;,</span>
</span><span id=__span-47-4><a id=__codelineno-47-4 name=__codelineno-47-4 href=#__codelineno-47-4></a><span class=go>               &#39;2020-01-01 04:00:00+00:00&#39;, &#39;2020-01-01 05:00:00+00:00&#39;,</span>
</span><span id=__span-47-5><a id=__codelineno-47-5 name=__codelineno-47-5 href=#__codelineno-47-5></a><span class=go>               ...</span>
</span><span id=__span-47-6><a id=__codelineno-47-6 name=__codelineno-47-6 href=#__codelineno-47-6></a><span class=go>               &#39;2020-01-31 18:00:00+00:00&#39;, &#39;2020-01-31 19:00:00+00:00&#39;,</span>
</span><span id=__span-47-7><a id=__codelineno-47-7 name=__codelineno-47-7 href=#__codelineno-47-7></a><span class=go>               &#39;2020-01-31 20:00:00+00:00&#39;, &#39;2020-01-31 21:00:00+00:00&#39;,</span>
</span><span id=__span-47-8><a id=__codelineno-47-8 name=__codelineno-47-8 href=#__codelineno-47-8></a><span class=go>               &#39;2020-01-31 22:00:00+00:00&#39;, &#39;2020-01-31 23:00:00+00:00&#39;],</span>
</span><span id=__span-47-9><a id=__codelineno-47-9 name=__codelineno-47-9 href=#__codelineno-47-9></a><span class=go>              dtype=&#39;datetime64[ns, UTC]&#39;, name=&#39;Open time&#39;, length=744, freq=None)</span>
</span></code></pre></div> <ol> <li>The first number (either 0 or 1) selects the bound (left or right), and the second number selects a range.</li> </ol> <div class="admonition important"> <p class=admonition-title>Important</p> <p>The right bound (second column) is always exclusive, so you should not use it for indexing directly, as it may point to an element beyond the index length.</p> </div> <p>We can see that the first range covers values from <code>2020-01-01</code> to <code>2020-01-31</code>, representing one month.</p> <p>If you want to look back over a set period of time rather than up to the previous allocation timestamp, you can use the <code>lookback_period</code> argument. In the following example, we generate new indices each month while looking back over the previous 3 months:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-48-1><a id=__codelineno-48-1 name=__codelineno-48-1 href=#__codelineno-48-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>example_ranges</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>get_index_ranges</span><span class=p>(</span>
</span><span id=__span-48-2><a id=__codelineno-48-2 name=__codelineno-48-2 href=#__codelineno-48-2></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=s2>&quot;M&quot;</span><span class=p>,</span> 
</span><span id=__span-48-3><a id=__codelineno-48-3 name=__codelineno-48-3 href=#__codelineno-48-3></a><span class=gp>... </span>    <span class=n>lookback_period</span><span class=o>=</span><span class=s2>&quot;3M&quot;</span>  <span class=c1># (1)!</span>
</span><span id=__span-48-4><a id=__codelineno-48-4 name=__codelineno-48-4 href=#__codelineno-48-4></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-48-5><a id=__codelineno-48-5 name=__codelineno-48-5 href=#__codelineno-48-5></a>
</span><span id=__span-48-6><a id=__codelineno-48-6 name=__codelineno-48-6 href=#__codelineno-48-6></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>get_index_bounds</span><span class=p>(</span><span class=n>range_starts</span><span class=p>,</span> <span class=n>range_ends</span><span class=p>):</span>  <span class=c1># (2)!</span>
</span><span id=__span-48-7><a id=__codelineno-48-7 name=__codelineno-48-7 href=#__codelineno-48-7></a><span class=gp>... </span>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>range_starts</span><span class=p>)):</span>
</span><span id=__span-48-8><a id=__codelineno-48-8 name=__codelineno-48-8 href=#__codelineno-48-8></a><span class=gp>... </span>        <span class=n>start_idx</span> <span class=o>=</span> <span class=n>range_starts</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>  <span class=c1># (3)!</span>
</span><span id=__span-48-9><a id=__codelineno-48-9 name=__codelineno-48-9 href=#__codelineno-48-9></a><span class=gp>... </span>        <span class=n>end_idx</span> <span class=o>=</span> <span class=n>range_ends</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>  <span class=c1># (4)!</span>
</span><span id=__span-48-10><a id=__codelineno-48-10 name=__codelineno-48-10 href=#__codelineno-48-10></a><span class=gp>... </span>        <span class=n>range_index</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>start_idx</span><span class=p>:</span><span class=n>end_idx</span><span class=p>]</span>
</span><span id=__span-48-11><a id=__codelineno-48-11 name=__codelineno-48-11 href=#__codelineno-48-11></a><span class=gp>... </span>        <span class=k>yield</span> <span class=n>range_index</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>range_index</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-48-12><a id=__codelineno-48-12 name=__codelineno-48-12 href=#__codelineno-48-12></a>
</span><span id=__span-48-13><a id=__codelineno-48-13 name=__codelineno-48-13 href=#__codelineno-48-13></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>list</span><span class=p>(</span><span class=n>get_index_bounds</span><span class=p>(</span><span class=o>*</span><span class=n>example_ranges</span><span class=p>))</span>
</span><span id=__span-48-14><a id=__codelineno-48-14 name=__codelineno-48-14 href=#__codelineno-48-14></a><span class=go>[(Timestamp(&#39;2020-01-01 00:00:00+0000&#39;, tz=&#39;UTC&#39;),</span>
</span><span id=__span-48-15><a id=__codelineno-48-15 name=__codelineno-48-15 href=#__codelineno-48-15></a><span class=go>  Timestamp(&#39;2020-03-31 23:00:00+0000&#39;, tz=&#39;UTC&#39;)),</span>
</span><span id=__span-48-16><a id=__codelineno-48-16 name=__codelineno-48-16 href=#__codelineno-48-16></a><span class=go> (Timestamp(&#39;2020-02-01 00:00:00+0000&#39;, tz=&#39;UTC&#39;),</span>
</span><span id=__span-48-17><a id=__codelineno-48-17 name=__codelineno-48-17 href=#__codelineno-48-17></a><span class=go>  Timestamp(&#39;2020-04-30 23:00:00+0000&#39;, tz=&#39;UTC&#39;)),</span>
</span><span id=__span-48-18><a id=__codelineno-48-18 name=__codelineno-48-18 href=#__codelineno-48-18></a><span class=go> (Timestamp(&#39;2020-03-01 00:00:00+0000&#39;, tz=&#39;UTC&#39;),</span>
</span><span id=__span-48-19><a id=__codelineno-48-19 name=__codelineno-48-19 href=#__codelineno-48-19></a><span class=go>  Timestamp(&#39;2020-05-31 23:00:00+0000&#39;, tz=&#39;UTC&#39;)),</span>
</span><span id=__span-48-20><a id=__codelineno-48-20 name=__codelineno-48-20 href=#__codelineno-48-20></a><span class=go> (Timestamp(&#39;2020-04-01 00:00:00+0000&#39;, tz=&#39;UTC&#39;),</span>
</span><span id=__span-48-21><a id=__codelineno-48-21 name=__codelineno-48-21 href=#__codelineno-48-21></a><span class=go>  Timestamp(&#39;2020-06-30 23:00:00+0000&#39;, tz=&#39;UTC&#39;)),</span>
</span><span id=__span-48-22><a id=__codelineno-48-22 name=__codelineno-48-22 href=#__codelineno-48-22></a><span class=go> (Timestamp(&#39;2020-05-01 00:00:00+0000&#39;, tz=&#39;UTC&#39;),</span>
</span><span id=__span-48-23><a id=__codelineno-48-23 name=__codelineno-48-23 href=#__codelineno-48-23></a><span class=go>  Timestamp(&#39;2020-07-31 23:00:00+0000&#39;, tz=&#39;UTC&#39;)),</span>
</span><span id=__span-48-24><a id=__codelineno-48-24 name=__codelineno-48-24 href=#__codelineno-48-24></a><span class=go> (Timestamp(&#39;2020-06-01 00:00:00+0000&#39;, tz=&#39;UTC&#39;),</span>
</span><span id=__span-48-25><a id=__codelineno-48-25 name=__codelineno-48-25 href=#__codelineno-48-25></a><span class=go>  Timestamp(&#39;2020-08-31 23:00:00+0000&#39;, tz=&#39;UTC&#39;)),</span>
</span><span id=__span-48-26><a id=__codelineno-48-26 name=__codelineno-48-26 href=#__codelineno-48-26></a><span class=go> (Timestamp(&#39;2020-07-01 00:00:00+0000&#39;, tz=&#39;UTC&#39;),</span>
</span><span id=__span-48-27><a id=__codelineno-48-27 name=__codelineno-48-27 href=#__codelineno-48-27></a><span class=go>  Timestamp(&#39;2020-09-30 23:00:00+0000&#39;, tz=&#39;UTC&#39;)),</span>
</span><span id=__span-48-28><a id=__codelineno-48-28 name=__codelineno-48-28 href=#__codelineno-48-28></a><span class=go> (Timestamp(&#39;2020-08-01 00:00:00+0000&#39;, tz=&#39;UTC&#39;),</span>
</span><span id=__span-48-29><a id=__codelineno-48-29 name=__codelineno-48-29 href=#__codelineno-48-29></a><span class=go>  Timestamp(&#39;2020-10-31 23:00:00+0000&#39;, tz=&#39;UTC&#39;)),</span>
</span><span id=__span-48-30><a id=__codelineno-48-30 name=__codelineno-48-30 href=#__codelineno-48-30></a><span class=go> (Timestamp(&#39;2020-09-01 00:00:00+0000&#39;, tz=&#39;UTC&#39;),</span>
</span><span id=__span-48-31><a id=__codelineno-48-31 name=__codelineno-48-31 href=#__codelineno-48-31></a><span class=go>  Timestamp(&#39;2020-11-30 23:00:00+0000&#39;, tz=&#39;UTC&#39;))]</span>
</span></code></pre></div> <ol> <li>The lookback period can also be provided as an integer (which is multiplied by the source frequency), a <code>pd.Timedelta</code> object, or a <code>pd.DateOffset</code> object.</li> <li>This is a simple function that returns the first and last timestamp for each index range.</li> <li>Inclusive.</li> <li>Exclusive.</li> </ol> <p>But what if you know the exact dates when each range should start and/or end? Unlike index points, the <code>start</code> and <code>end</code> arguments can be collections of indices or timestamps to define the range bounds:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-49-1><a id=__codelineno-49-1 name=__codelineno-49-1 href=#__codelineno-49-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>example_ranges</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>get_index_ranges</span><span class=p>(</span>
</span><span id=__span-49-2><a id=__codelineno-49-2 name=__codelineno-49-2 href=#__codelineno-49-2></a><span class=gp>... </span>    <span class=n>start</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;2020-01-01&quot;</span><span class=p>,</span> <span class=s2>&quot;2020-04-01&quot;</span><span class=p>,</span> <span class=s2>&quot;2020-08-01&quot;</span><span class=p>],</span>
</span><span id=__span-49-3><a id=__codelineno-49-3 name=__codelineno-49-3 href=#__codelineno-49-3></a><span class=gp>... </span>    <span class=n>end</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;2020-04-01&quot;</span><span class=p>,</span> <span class=s2>&quot;2020-08-01&quot;</span><span class=p>,</span> <span class=s2>&quot;2020-12-01&quot;</span><span class=p>]</span>
</span><span id=__span-49-4><a id=__codelineno-49-4 name=__codelineno-49-4 href=#__codelineno-49-4></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-49-5><a id=__codelineno-49-5 name=__codelineno-49-5 href=#__codelineno-49-5></a>
</span><span id=__span-49-6><a id=__codelineno-49-6 name=__codelineno-49-6 href=#__codelineno-49-6></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>list</span><span class=p>(</span><span class=n>get_index_bounds</span><span class=p>(</span><span class=o>*</span><span class=n>example_ranges</span><span class=p>))</span>
</span><span id=__span-49-7><a id=__codelineno-49-7 name=__codelineno-49-7 href=#__codelineno-49-7></a><span class=go>[(Timestamp(&#39;2020-01-01 00:00:00+0000&#39;, tz=&#39;UTC&#39;),</span>
</span><span id=__span-49-8><a id=__codelineno-49-8 name=__codelineno-49-8 href=#__codelineno-49-8></a><span class=go>  Timestamp(&#39;2020-03-31 23:00:00+0000&#39;, tz=&#39;UTC&#39;)),</span>
</span><span id=__span-49-9><a id=__codelineno-49-9 name=__codelineno-49-9 href=#__codelineno-49-9></a><span class=go> (Timestamp(&#39;2020-04-01 00:00:00+0000&#39;, tz=&#39;UTC&#39;),</span>
</span><span id=__span-49-10><a id=__codelineno-49-10 name=__codelineno-49-10 href=#__codelineno-49-10></a><span class=go>  Timestamp(&#39;2020-07-31 23:00:00+0000&#39;, tz=&#39;UTC&#39;)),</span>
</span><span id=__span-49-11><a id=__codelineno-49-11 name=__codelineno-49-11 href=#__codelineno-49-11></a><span class=go> (Timestamp(&#39;2020-08-01 00:00:00+0000&#39;, tz=&#39;UTC&#39;),</span>
</span><span id=__span-49-12><a id=__codelineno-49-12 name=__codelineno-49-12 href=#__codelineno-49-12></a><span class=go>  Timestamp(&#39;2020-11-30 23:00:00+0000&#39;, tz=&#39;UTC&#39;))]</span>
</span></code></pre></div> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>You can mark the first timestamp as exclusive and the last timestamp as inclusive by setting <code>closed_start</code> to False and <code>closed_end</code> to True, respectively. Note that these settings affect the input, but the output always follows the <em>from inclusive to exclusive</em> scheme.</p> </div> <p>Additionally, if either <code>start</code> or <code>end</code> is a single value, it will automatically be broadcast to match the length of the other argument. Let's simulate the movement of an expanding window:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-50-1><a id=__codelineno-50-1 name=__codelineno-50-1 href=#__codelineno-50-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>example_ranges</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>get_index_ranges</span><span class=p>(</span>
</span><span id=__span-50-2><a id=__codelineno-50-2 name=__codelineno-50-2 href=#__codelineno-50-2></a><span class=gp>... </span>    <span class=n>start</span><span class=o>=</span><span class=s2>&quot;2020-01-01&quot;</span><span class=p>,</span>
</span><span id=__span-50-3><a id=__codelineno-50-3 name=__codelineno-50-3 href=#__codelineno-50-3></a><span class=gp>... </span>    <span class=n>end</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;2020-04-01&quot;</span><span class=p>,</span> <span class=s2>&quot;2020-08-01&quot;</span><span class=p>,</span> <span class=s2>&quot;2020-12-01&quot;</span><span class=p>]</span>
</span><span id=__span-50-4><a id=__codelineno-50-4 name=__codelineno-50-4 href=#__codelineno-50-4></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-50-5><a id=__codelineno-50-5 name=__codelineno-50-5 href=#__codelineno-50-5></a>
</span><span id=__span-50-6><a id=__codelineno-50-6 name=__codelineno-50-6 href=#__codelineno-50-6></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>list</span><span class=p>(</span><span class=n>get_index_bounds</span><span class=p>(</span><span class=o>*</span><span class=n>example_ranges</span><span class=p>))</span>
</span><span id=__span-50-7><a id=__codelineno-50-7 name=__codelineno-50-7 href=#__codelineno-50-7></a><span class=go>[(Timestamp(&#39;2020-01-01 00:00:00+0000&#39;, tz=&#39;UTC&#39;),</span>
</span><span id=__span-50-8><a id=__codelineno-50-8 name=__codelineno-50-8 href=#__codelineno-50-8></a><span class=go>  Timestamp(&#39;2020-03-31 23:00:00+0000&#39;, tz=&#39;UTC&#39;)),</span>
</span><span id=__span-50-9><a id=__codelineno-50-9 name=__codelineno-50-9 href=#__codelineno-50-9></a><span class=go> (Timestamp(&#39;2020-01-01 00:00:00+0000&#39;, tz=&#39;UTC&#39;),</span>
</span><span id=__span-50-10><a id=__codelineno-50-10 name=__codelineno-50-10 href=#__codelineno-50-10></a><span class=go>  Timestamp(&#39;2020-07-31 23:00:00+0000&#39;, tz=&#39;UTC&#39;)),</span>
</span><span id=__span-50-11><a id=__codelineno-50-11 name=__codelineno-50-11 href=#__codelineno-50-11></a><span class=go> (Timestamp(&#39;2020-01-01 00:00:00+0000&#39;, tz=&#39;UTC&#39;),</span>
</span><span id=__span-50-12><a id=__codelineno-50-12 name=__codelineno-50-12 href=#__codelineno-50-12></a><span class=go>  Timestamp(&#39;2020-11-30 23:00:00+0000&#39;, tz=&#39;UTC&#39;))]</span>
</span></code></pre></div> <p>Another useful argument is <code>fixed_start</code>, which, when combined with <code>every</code>, can also simulate an expanding window:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-51-1><a id=__codelineno-51-1 name=__codelineno-51-1 href=#__codelineno-51-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>example_ranges</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>wrapper</span><span class=o>.</span><span class=n>get_index_ranges</span><span class=p>(</span>
</span><span id=__span-51-2><a id=__codelineno-51-2 name=__codelineno-51-2 href=#__codelineno-51-2></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=s2>&quot;Q&quot;</span><span class=p>,</span>
</span><span id=__span-51-3><a id=__codelineno-51-3 name=__codelineno-51-3 href=#__codelineno-51-3></a><span class=gp>... </span>    <span class=n>exact_start</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>  <span class=c1># (1)!</span>
</span><span id=__span-51-4><a id=__codelineno-51-4 name=__codelineno-51-4 href=#__codelineno-51-4></a><span class=gp>... </span>    <span class=n>fixed_start</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-51-5><a id=__codelineno-51-5 name=__codelineno-51-5 href=#__codelineno-51-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-51-6><a id=__codelineno-51-6 name=__codelineno-51-6 href=#__codelineno-51-6></a>
</span><span id=__span-51-7><a id=__codelineno-51-7 name=__codelineno-51-7 href=#__codelineno-51-7></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>list</span><span class=p>(</span><span class=n>get_index_bounds</span><span class=p>(</span><span class=o>*</span><span class=n>example_ranges</span><span class=p>))</span>
</span><span id=__span-51-8><a id=__codelineno-51-8 name=__codelineno-51-8 href=#__codelineno-51-8></a><span class=go>[(Timestamp(&#39;2020-01-01 00:00:00+0000&#39;, tz=&#39;UTC&#39;),</span>
</span><span id=__span-51-9><a id=__codelineno-51-9 name=__codelineno-51-9 href=#__codelineno-51-9></a><span class=go>  Timestamp(&#39;2020-03-30 23:00:00+0000&#39;, tz=&#39;UTC&#39;)),</span>
</span><span id=__span-51-10><a id=__codelineno-51-10 name=__codelineno-51-10 href=#__codelineno-51-10></a><span class=go> (Timestamp(&#39;2020-01-01 00:00:00+0000&#39;, tz=&#39;UTC&#39;),</span>
</span><span id=__span-51-11><a id=__codelineno-51-11 name=__codelineno-51-11 href=#__codelineno-51-11></a><span class=go>  Timestamp(&#39;2020-06-29 23:00:00+0000&#39;, tz=&#39;UTC&#39;)),</span>
</span><span id=__span-51-12><a id=__codelineno-51-12 name=__codelineno-51-12 href=#__codelineno-51-12></a><span class=go> (Timestamp(&#39;2020-01-01 00:00:00+0000&#39;, tz=&#39;UTC&#39;),</span>
</span><span id=__span-51-13><a id=__codelineno-51-13 name=__codelineno-51-13 href=#__codelineno-51-13></a><span class=go>  Timestamp(&#39;2020-09-29 23:00:00+0000&#39;, tz=&#39;UTC&#39;)),</span>
</span><span id=__span-51-14><a id=__codelineno-51-14 name=__codelineno-51-14 href=#__codelineno-51-14></a><span class=go> (Timestamp(&#39;2020-01-01 00:00:00+0000&#39;, tz=&#39;UTC&#39;),</span>
</span><span id=__span-51-15><a id=__codelineno-51-15 name=__codelineno-51-15 href=#__codelineno-51-15></a><span class=go>  Timestamp(&#39;2020-12-30 23:00:00+0000&#39;, tz=&#39;UTC&#39;))]</span>
</span></code></pre></div> <ol> <li>Without this flag, the first date would be "2020-03-31" as generated by <a href=https://pandas.pydata.org/docs/reference/api/pandas.date_range.html>pandas.date_range</a>.</li> </ol> <h3 id=optimization-method>Optimization method<a class=headerlink href=#optimization-method title="Permanent link">&para;</a></h3> <p>Similar to <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer.from_allocate_func>PortfolioOptimizer.from_allocate_func</a>, which is applied on index points, there is a class method <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer.from_optimize_func>PortfolioOptimizer.from_optimize_func</a> that is applied on index ranges. This method works almost identically to its counterpart, except that each iteration calls an optimization function <code>optimize_func</code> that focuses on an index range (available as <code>index_slice</code> through the template context). All index ranges are stored as records of type <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/records/#vectorbtpro.portfolio.pfopt.records.AllocRanges>AllocRanges</a>, which is a subclass of <a href=https://vectorbt.pro/pvt_41531c19/api/generic/ranges/#vectorbtpro.generic.ranges.Ranges>Ranges</a>.</p> <p>Let's try a simple example: allocate inversely proportional to the return of an asset. This approach allocates more to assets that have recently performed poorly, with the expectation of buying them at a discounted price and that they will turn bullish in the upcoming period.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-52-1><a id=__codelineno-52-1 name=__codelineno-52-1 href=#__codelineno-52-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>inv_rank_optimize_func</span><span class=p>(</span><span class=n>price</span><span class=p>,</span> <span class=n>index_slice</span><span class=p>):</span>
</span><span id=__span-52-2><a id=__codelineno-52-2 name=__codelineno-52-2 href=#__codelineno-52-2></a><span class=gp>... </span>    <span class=n>price_period</span> <span class=o>=</span> <span class=n>price</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>index_slice</span><span class=p>]</span>  <span class=c1># (1)!</span>
</span><span id=__span-52-3><a id=__codelineno-52-3 name=__codelineno-52-3 href=#__codelineno-52-3></a><span class=gp>... </span>    <span class=n>first_price</span> <span class=o>=</span> <span class=n>price_period</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span><span id=__span-52-4><a id=__codelineno-52-4 name=__codelineno-52-4 href=#__codelineno-52-4></a><span class=gp>... </span>    <span class=n>last_price</span> <span class=o>=</span> <span class=n>price_period</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-52-5><a id=__codelineno-52-5 name=__codelineno-52-5 href=#__codelineno-52-5></a><span class=gp>... </span>    <span class=n>ret</span> <span class=o>=</span> <span class=p>(</span><span class=n>last_price</span> <span class=o>-</span> <span class=n>first_price</span><span class=p>)</span> <span class=o>/</span> <span class=n>first_price</span>  <span class=c1># (2)!</span>
</span><span id=__span-52-6><a id=__codelineno-52-6 name=__codelineno-52-6 href=#__codelineno-52-6></a><span class=gp>... </span>    <span class=n>ranks</span> <span class=o>=</span> <span class=n>ret</span><span class=o>.</span><span class=n>rank</span><span class=p>(</span><span class=n>ascending</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-52-7><a id=__codelineno-52-7 name=__codelineno-52-7 href=#__codelineno-52-7></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>ranks</span> <span class=o>/</span> <span class=n>ranks</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>  <span class=c1># (4)!</span>
</span><span id=__span-52-8><a id=__codelineno-52-8 name=__codelineno-52-8 href=#__codelineno-52-8></a>
</span><span id=__span-52-9><a id=__codelineno-52-9 name=__codelineno-52-9 href=#__codelineno-52-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_optimize_func</span><span class=p>(</span>
</span><span id=__span-52-10><a id=__codelineno-52-10 name=__codelineno-52-10 href=#__codelineno-52-10></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-52-11><a id=__codelineno-52-11 name=__codelineno-52-11 href=#__codelineno-52-11></a><span class=gp>... </span>    <span class=n>inv_rank_optimize_func</span><span class=p>,</span>
</span><span id=__span-52-12><a id=__codelineno-52-12 name=__codelineno-52-12 href=#__codelineno-52-12></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>),</span>
</span><span id=__span-52-13><a id=__codelineno-52-13 name=__codelineno-52-13 href=#__codelineno-52-13></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>Rep</span><span class=p>(</span><span class=s2>&quot;index_slice&quot;</span><span class=p>),</span>  <span class=c1># (5)!</span>
</span><span id=__span-52-14><a id=__codelineno-52-14 name=__codelineno-52-14 href=#__codelineno-52-14></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=s2>&quot;M&quot;</span>
</span><span id=__span-52-15><a id=__codelineno-52-15 name=__codelineno-52-15 href=#__codelineno-52-15></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-52-16><a id=__codelineno-52-16 name=__codelineno-52-16 href=#__codelineno-52-16></a>
</span><span id=__span-52-17><a id=__codelineno-52-17 name=__codelineno-52-17 href=#__codelineno-52-17></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>allocations</span>
</span><span id=__span-52-18><a id=__codelineno-52-18 name=__codelineno-52-18 href=#__codelineno-52-18></a><span class=go>symbol                      ADAUSDT   BNBUSDT   BTCUSDT   ETHUSDT   XRPUSDT</span>
</span><span id=__span-52-19><a id=__codelineno-52-19 name=__codelineno-52-19 href=#__codelineno-52-19></a><span class=go>Open time                                                                  </span>
</span><span id=__span-52-20><a id=__codelineno-52-20 name=__codelineno-52-20 href=#__codelineno-52-20></a><span class=go>2020-02-01 00:00:00+00:00  0.066667  0.200000  0.266667  0.133333  0.333333</span>
</span><span id=__span-52-21><a id=__codelineno-52-21 name=__codelineno-52-21 href=#__codelineno-52-21></a><span class=go>2020-03-01 00:00:00+00:00  0.333333  0.133333  0.266667  0.066667  0.200000</span>
</span><span id=__span-52-22><a id=__codelineno-52-22 name=__codelineno-52-22 href=#__codelineno-52-22></a><span class=go>2020-04-01 00:00:00+00:00  0.266667  0.200000  0.133333  0.333333  0.066667</span>
</span><span id=__span-52-23><a id=__codelineno-52-23 name=__codelineno-52-23 href=#__codelineno-52-23></a><span class=go>2020-05-01 00:00:00+00:00  0.066667  0.200000  0.266667  0.133333  0.333333</span>
</span><span id=__span-52-24><a id=__codelineno-52-24 name=__codelineno-52-24 href=#__codelineno-52-24></a><span class=go>2020-06-01 00:00:00+00:00  0.066667  0.266667  0.200000  0.133333  0.333333</span>
</span><span id=__span-52-25><a id=__codelineno-52-25 name=__codelineno-52-25 href=#__codelineno-52-25></a><span class=go>2020-07-01 00:00:00+00:00  0.066667  0.266667  0.200000  0.133333  0.333333</span>
</span><span id=__span-52-26><a id=__codelineno-52-26 name=__codelineno-52-26 href=#__codelineno-52-26></a><span class=go>2020-08-01 00:00:00+00:00  0.066667  0.266667  0.333333  0.133333  0.200000</span>
</span><span id=__span-52-27><a id=__codelineno-52-27 name=__codelineno-52-27 href=#__codelineno-52-27></a><span class=go>2020-09-01 00:00:00+00:00  0.333333  0.133333  0.266667  0.066667  0.200000</span>
</span><span id=__span-52-28><a id=__codelineno-52-28 name=__codelineno-52-28 href=#__codelineno-52-28></a><span class=go>2020-10-01 00:00:00+00:00  0.266667  0.066667  0.133333  0.333333  0.200000</span>
</span><span id=__span-52-29><a id=__codelineno-52-29 name=__codelineno-52-29 href=#__codelineno-52-29></a><span class=go>2020-11-01 00:00:00+00:00  0.333333  0.266667  0.066667  0.133333  0.200000</span>
</span><span id=__span-52-30><a id=__codelineno-52-30 name=__codelineno-52-30 href=#__codelineno-52-30></a><span class=go>2020-12-01 00:00:00+00:00  0.133333  0.333333  0.266667  0.200000  0.066667</span>
</span></code></pre></div> <ol> <li>Select the data within the current index range.</li> <li>Calculate the return of each asset.</li> <li>Calculate the inverse rank of each return.</li> <li>Convert the ranks into weights that sum to 1.</li> <li>Use the <a href=https://vectorbt.pro/pvt_41531c19/api/utils/template/#vectorbtpro.utils.template.Rep>Rep</a> template to instruct VBT to replace it with the index slice of type <code>slice</code>, which can be easily applied to any Pandas array.</li> </ol> <p>To automatically select the index range from an array, we can wrap the array with <a href=https://vectorbt.pro/pvt_41531c19/api/generic/splitting/base/#vectorbtpro.generic.splitting.base.Takeable>Takeable</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-53-1><a id=__codelineno-53-1 name=__codelineno-53-1 href=#__codelineno-53-1></a><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span><span class=w> </span><span class=nf>inv_rank_optimize_func</span><span class=p>(</span><span class=n>price</span><span class=p>):</span>
</span><span id=__span-53-2><a id=__codelineno-53-2 name=__codelineno-53-2 href=#__codelineno-53-2></a><span class=gp>... </span>    <span class=n>first_price</span> <span class=o>=</span> <span class=n>price</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span><span id=__span-53-3><a id=__codelineno-53-3 name=__codelineno-53-3 href=#__codelineno-53-3></a><span class=gp>... </span>    <span class=n>last_price</span> <span class=o>=</span> <span class=n>price</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-53-4><a id=__codelineno-53-4 name=__codelineno-53-4 href=#__codelineno-53-4></a><span class=gp>... </span>    <span class=n>ret</span> <span class=o>=</span> <span class=p>(</span><span class=n>last_price</span> <span class=o>-</span> <span class=n>first_price</span><span class=p>)</span> <span class=o>/</span> <span class=n>first_price</span>
</span><span id=__span-53-5><a id=__codelineno-53-5 name=__codelineno-53-5 href=#__codelineno-53-5></a><span class=gp>... </span>    <span class=n>ranks</span> <span class=o>=</span> <span class=n>ret</span><span class=o>.</span><span class=n>rank</span><span class=p>(</span><span class=n>ascending</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-53-6><a id=__codelineno-53-6 name=__codelineno-53-6 href=#__codelineno-53-6></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>ranks</span> <span class=o>/</span> <span class=n>ranks</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-53-7><a id=__codelineno-53-7 name=__codelineno-53-7 href=#__codelineno-53-7></a>
</span><span id=__span-53-8><a id=__codelineno-53-8 name=__codelineno-53-8 href=#__codelineno-53-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_optimize_func</span><span class=p>(</span>
</span><span id=__span-53-9><a id=__codelineno-53-9 name=__codelineno-53-9 href=#__codelineno-53-9></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-53-10><a id=__codelineno-53-10 name=__codelineno-53-10 href=#__codelineno-53-10></a><span class=gp>... </span>    <span class=n>inv_rank_optimize_func</span><span class=p>,</span>
</span><span id=__span-53-11><a id=__codelineno-53-11 name=__codelineno-53-11 href=#__codelineno-53-11></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>Takeable</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)),</span>
</span><span id=__span-53-12><a id=__codelineno-53-12 name=__codelineno-53-12 href=#__codelineno-53-12></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=s2>&quot;M&quot;</span>
</span><span id=__span-53-13><a id=__codelineno-53-13 name=__codelineno-53-13 href=#__codelineno-53-13></a><span class=gp>... </span><span class=p>)</span>
</span></code></pre></div> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>Although this approach introduces a slight overhead, it has a key advantage over the manual approach: VBT knows how to select an index range even when the takeable array is a Pandas object whose index or frequency differs from that of the optimization. This is possible thanks to VBT's robust resampling.</p> </div> <p>To validate the allocation array, we first need to access the index ranges over which our portfolio optimization was performed. These are stored under the same attribute as index points: <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer.alloc_records>PortfolioOptimizer.alloc_records</a>:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-54-1><a id=__codelineno-54-1 name=__codelineno-54-1 href=#__codelineno-54-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>alloc_records</span><span class=o>.</span><span class=n>records_readable</span>
</span><span id=__span-54-2><a id=__codelineno-54-2 name=__codelineno-54-2 href=#__codelineno-54-2></a><span class=go>    Range Id  Group               Start Index                 End Index  \</span>
</span><span id=__span-54-3><a id=__codelineno-54-3 name=__codelineno-54-3 href=#__codelineno-54-3></a><span class=go>0          0  group 2020-01-01 00:00:00+00:00 2020-02-01 00:00:00+00:00   </span>
</span><span id=__span-54-4><a id=__codelineno-54-4 name=__codelineno-54-4 href=#__codelineno-54-4></a><span class=go>1          1  group 2020-02-01 00:00:00+00:00 2020-03-01 00:00:00+00:00   </span>
</span><span id=__span-54-5><a id=__codelineno-54-5 name=__codelineno-54-5 href=#__codelineno-54-5></a><span class=go>2          2  group 2020-03-01 00:00:00+00:00 2020-04-01 00:00:00+00:00   </span>
</span><span id=__span-54-6><a id=__codelineno-54-6 name=__codelineno-54-6 href=#__codelineno-54-6></a><span class=go>3          3  group 2020-04-01 00:00:00+00:00 2020-05-01 00:00:00+00:00   </span>
</span><span id=__span-54-7><a id=__codelineno-54-7 name=__codelineno-54-7 href=#__codelineno-54-7></a><span class=go>4          4  group 2020-05-01 00:00:00+00:00 2020-06-01 00:00:00+00:00   </span>
</span><span id=__span-54-8><a id=__codelineno-54-8 name=__codelineno-54-8 href=#__codelineno-54-8></a><span class=go>5          5  group 2020-06-01 00:00:00+00:00 2020-07-01 00:00:00+00:00   </span>
</span><span id=__span-54-9><a id=__codelineno-54-9 name=__codelineno-54-9 href=#__codelineno-54-9></a><span class=go>6          6  group 2020-07-01 00:00:00+00:00 2020-08-01 00:00:00+00:00   </span>
</span><span id=__span-54-10><a id=__codelineno-54-10 name=__codelineno-54-10 href=#__codelineno-54-10></a><span class=go>7          7  group 2020-08-01 00:00:00+00:00 2020-09-01 00:00:00+00:00   </span>
</span><span id=__span-54-11><a id=__codelineno-54-11 name=__codelineno-54-11 href=#__codelineno-54-11></a><span class=go>8          8  group 2020-09-01 00:00:00+00:00 2020-10-01 00:00:00+00:00   </span>
</span><span id=__span-54-12><a id=__codelineno-54-12 name=__codelineno-54-12 href=#__codelineno-54-12></a><span class=go>9          9  group 2020-10-01 00:00:00+00:00 2020-11-01 00:00:00+00:00   </span>
</span><span id=__span-54-13><a id=__codelineno-54-13 name=__codelineno-54-13 href=#__codelineno-54-13></a><span class=go>10        10  group 2020-11-01 00:00:00+00:00 2020-12-01 00:00:00+00:00   </span>
</span><span id=__span-54-14><a id=__codelineno-54-14 name=__codelineno-54-14 href=#__codelineno-54-14></a>
</span><span id=__span-54-15><a id=__codelineno-54-15 name=__codelineno-54-15 href=#__codelineno-54-15></a><span class=go>            Allocation Index  Status  </span>
</span><span id=__span-54-16><a id=__codelineno-54-16 name=__codelineno-54-16 href=#__codelineno-54-16></a><span class=go>0  2020-02-01 00:00:00+00:00  Closed  </span>
</span><span id=__span-54-17><a id=__codelineno-54-17 name=__codelineno-54-17 href=#__codelineno-54-17></a><span class=go>1  2020-03-01 00:00:00+00:00  Closed  </span>
</span><span id=__span-54-18><a id=__codelineno-54-18 name=__codelineno-54-18 href=#__codelineno-54-18></a><span class=go>2  2020-04-01 00:00:00+00:00  Closed  </span>
</span><span id=__span-54-19><a id=__codelineno-54-19 name=__codelineno-54-19 href=#__codelineno-54-19></a><span class=go>3  2020-05-01 00:00:00+00:00  Closed  </span>
</span><span id=__span-54-20><a id=__codelineno-54-20 name=__codelineno-54-20 href=#__codelineno-54-20></a><span class=go>4  2020-06-01 00:00:00+00:00  Closed  </span>
</span><span id=__span-54-21><a id=__codelineno-54-21 name=__codelineno-54-21 href=#__codelineno-54-21></a><span class=go>5  2020-07-01 00:00:00+00:00  Closed  </span>
</span><span id=__span-54-22><a id=__codelineno-54-22 name=__codelineno-54-22 href=#__codelineno-54-22></a><span class=go>6  2020-08-01 00:00:00+00:00  Closed  </span>
</span><span id=__span-54-23><a id=__codelineno-54-23 name=__codelineno-54-23 href=#__codelineno-54-23></a><span class=go>7  2020-09-01 00:00:00+00:00  Closed  </span>
</span><span id=__span-54-24><a id=__codelineno-54-24 name=__codelineno-54-24 href=#__codelineno-54-24></a><span class=go>8  2020-10-01 00:00:00+00:00  Closed  </span>
</span><span id=__span-54-25><a id=__codelineno-54-25 name=__codelineno-54-25 href=#__codelineno-54-25></a><span class=go>9  2020-11-01 00:00:00+00:00  Closed  </span>
</span><span id=__span-54-26><a id=__codelineno-54-26 name=__codelineno-54-26 href=#__codelineno-54-26></a><span class=go>10 2020-12-01 00:00:00+00:00  Closed  </span>
</span></code></pre></div> <p>We observe three different types of timestamps: a start (<code>start_idx</code>), an end (<code>end_idx</code>), and an allocation timestamp (<code>alloc_idx</code>). The start and end timestamps define our index ranges, while the allocation timestamps indicate when the allocations were actually placed. By default, VBT places an allocation at the end of each index range. In cases where the end index exceeds the bounds (remember that it is an excluded index), the status of the range is marked as "Open"; otherwise, it is "Closed" (meaning we can safely use that allocation). Allocation arrays and filled allocation arrays include only closed allocations.</p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>Use the <code>alloc_wait</code> argument to control how many ticks after the range the allocation should be placed. The default is <code>1</code>. Passing <code>0</code> will place the allocation at the last tick within the index range, which should be used with caution when optimizing based on the close price.</p> </div> <p>Let's validate the allocation generated from the first month of data:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-55-1><a id=__codelineno-55-1 name=__codelineno-55-1 href=#__codelineno-55-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>start_idx</span> <span class=o>=</span> <span class=n>pfo</span><span class=o>.</span><span class=n>alloc_records</span><span class=o>.</span><span class=n>values</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=s2>&quot;start_idx&quot;</span><span class=p>]</span>
</span><span id=__span-55-2><a id=__codelineno-55-2 name=__codelineno-55-2 href=#__codelineno-55-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>end_idx</span> <span class=o>=</span> <span class=n>pfo</span><span class=o>.</span><span class=n>alloc_records</span><span class=o>.</span><span class=n>values</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=s2>&quot;end_idx&quot;</span><span class=p>]</span>
</span><span id=__span-55-3><a id=__codelineno-55-3 name=__codelineno-55-3 href=#__codelineno-55-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>close_period</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>start_idx</span><span class=p>:</span><span class=n>end_idx</span><span class=p>]</span>
</span><span id=__span-55-4><a id=__codelineno-55-4 name=__codelineno-55-4 href=#__codelineno-55-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>close_period</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>rebase</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>vbt</span><span class=o>.</span><span class=n>plot</span><span class=p>()</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>  <span class=c1># (1)!</span>
</span></code></pre></div> <ol> <li>Rescale all close prices to start from 1 using <a href=https://vectorbt.pro/pvt_41531c19/api/generic/accessors/#vectorbtpro.generic.accessors.GenericAccessor.rebase>GenericAccessor.rebase</a> and plot them using <a href=https://vectorbt.pro/pvt_41531c19/api/generic/accessors/#vectorbtpro.generic.accessors.GenericAccessor.plot>GenericAccessor.plot</a>.</li> </ol> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/close_period.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/close_period.dark.svg#only-dark></p> <p>We see that <code>ADAUSDT</code> produced the highest return and <code>XRPUSDT</code> the lowest. This is correctly reflected by allocating only 6% to ADAUSDT and 33% to XRPUSDT.</p> <p>Storing index ranges, rather than just index points, in a <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer>PortfolioOptimizer</a> instance also enables new metrics and subplots:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-56-1><a id=__codelineno-56-1 name=__codelineno-56-1 href=#__codelineno-56-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>stats</span><span class=p>()</span>
</span><span id=__span-56-2><a id=__codelineno-56-2 name=__codelineno-56-2 href=#__codelineno-56-2></a><span class=go>Start                       2020-01-01 00:00:00+00:00</span>
</span><span id=__span-56-3><a id=__codelineno-56-3 name=__codelineno-56-3 href=#__codelineno-56-3></a><span class=go>End                         2020-12-31 23:00:00+00:00</span>
</span><span id=__span-56-4><a id=__codelineno-56-4 name=__codelineno-56-4 href=#__codelineno-56-4></a><span class=go>Period                              365 days 06:00:00</span>
</span><span id=__span-56-5><a id=__codelineno-56-5 name=__codelineno-56-5 href=#__codelineno-56-5></a><span class=go>Total Records                                      11</span>
</span><span id=__span-56-6><a id=__codelineno-56-6 name=__codelineno-56-6 href=#__codelineno-56-6></a><span class=go>Coverage                                     0.915593  &lt;&lt; ranges cover 92%</span>
</span><span id=__span-56-7><a id=__codelineno-56-7 name=__codelineno-56-7 href=#__codelineno-56-7></a><span class=go>Overlap Coverage                                  0.0  &lt;&lt; ranges do not overlap</span>
</span><span id=__span-56-8><a id=__codelineno-56-8 name=__codelineno-56-8 href=#__codelineno-56-8></a><span class=go>Mean Allocation: ADAUSDT                     0.181818</span>
</span><span id=__span-56-9><a id=__codelineno-56-9 name=__codelineno-56-9 href=#__codelineno-56-9></a><span class=go>Mean Allocation: BNBUSDT                     0.212121</span>
</span><span id=__span-56-10><a id=__codelineno-56-10 name=__codelineno-56-10 href=#__codelineno-56-10></a><span class=go>Mean Allocation: BTCUSDT                     0.218182</span>
</span><span id=__span-56-11><a id=__codelineno-56-11 name=__codelineno-56-11 href=#__codelineno-56-11></a><span class=go>Mean Allocation: ETHUSDT                     0.163636</span>
</span><span id=__span-56-12><a id=__codelineno-56-12 name=__codelineno-56-12 href=#__codelineno-56-12></a><span class=go>Mean Allocation: XRPUSDT                     0.224242</span>
</span><span id=__span-56-13><a id=__codelineno-56-13 name=__codelineno-56-13 href=#__codelineno-56-13></a><span class=go>Name: group, dtype: object</span>
</span><span id=__span-56-14><a id=__codelineno-56-14 name=__codelineno-56-14 href=#__codelineno-56-14></a>
</span><span id=__span-56-15><a id=__codelineno-56-15 name=__codelineno-56-15 href=#__codelineno-56-15></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>plots</span><span class=p>()</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></code></pre></div> <p><img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/plots.light.svg#only-light> <img alt class=iimg loading=lazy src=https://vectorbt.pro/pvt_41531c19/assets/images/tutorials/pf-opt/plots.dark.svg#only-dark></p> <p>In the graph above, we see not only when each re-allocation occurs, but also which index range the re-allocation is based on.</p> <p>All other features, such as <a href=#groups>support for groups</a>, remain identical to <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer.from_allocate_func>PortfolioOptimizer.from_allocate_func</a>.</p> <h4 id=waiting>Waiting<a class=headerlink href=#waiting title="Permanent link">&para;</a></h4> <p>By default, when generating weights over a specific time period, the weights will be allocated at the next available timestamp. This has some implications. For example, when calling <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/base/#vectorbtpro.portfolio.pfopt.base.PortfolioOptimizer.from_optimize_func>PortfolioOptimizer.from_optimize_func</a> without any arguments, it will optimize over the entire time period but return no allocations, because there is no next timestamp at which to allocate the generated weights:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-57-1><a id=__codelineno-57-1 name=__codelineno-57-1 href=#__codelineno-57-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_optimize_func</span><span class=p>(</span>
</span><span id=__span-57-2><a id=__codelineno-57-2 name=__codelineno-57-2 href=#__codelineno-57-2></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-57-3><a id=__codelineno-57-3 name=__codelineno-57-3 href=#__codelineno-57-3></a><span class=gp>... </span>    <span class=n>inv_rank_optimize_func</span><span class=p>,</span>
</span><span id=__span-57-4><a id=__codelineno-57-4 name=__codelineno-57-4 href=#__codelineno-57-4></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>Takeable</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>))</span>
</span><span id=__span-57-5><a id=__codelineno-57-5 name=__codelineno-57-5 href=#__codelineno-57-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-57-6><a id=__codelineno-57-6 name=__codelineno-57-6 href=#__codelineno-57-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>allocations</span>
</span><span id=__span-57-7><a id=__codelineno-57-7 name=__codelineno-57-7 href=#__codelineno-57-7></a><span class=go>Empty DataFrame</span>
</span><span id=__span-57-8><a id=__codelineno-57-8 name=__codelineno-57-8 href=#__codelineno-57-8></a><span class=go>Columns: [BTCUSDT, ETHUSDT, BNBUSDT, XRPUSDT, ADAUSDT]</span>
</span><span id=__span-57-9><a id=__codelineno-57-9 name=__codelineno-57-9 href=#__codelineno-57-9></a><span class=go>Index: []</span>
</span></code></pre></div> <p>The solution is to set the waiting time to zero:</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-58-1><a id=__codelineno-58-1 name=__codelineno-58-1 href=#__codelineno-58-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_optimize_func</span><span class=p>(</span>
</span><span id=__span-58-2><a id=__codelineno-58-2 name=__codelineno-58-2 href=#__codelineno-58-2></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-58-3><a id=__codelineno-58-3 name=__codelineno-58-3 href=#__codelineno-58-3></a><span class=gp>... </span>    <span class=n>inv_rank_optimize_func</span><span class=p>,</span>
</span><span id=__span-58-4><a id=__codelineno-58-4 name=__codelineno-58-4 href=#__codelineno-58-4></a><span class=gp>... </span>    <span class=n>vbt</span><span class=o>.</span><span class=n>Takeable</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)),</span>
</span><span id=__span-58-5><a id=__codelineno-58-5 name=__codelineno-58-5 href=#__codelineno-58-5></a><span class=gp>... </span>    <span class=n>alloc_wait</span><span class=o>=</span><span class=mi>0</span>  <span class=c1># (1)!</span>
</span><span id=__span-58-6><a id=__codelineno-58-6 name=__codelineno-58-6 href=#__codelineno-58-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-58-7><a id=__codelineno-58-7 name=__codelineno-58-7 href=#__codelineno-58-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>allocations</span>
</span><span id=__span-58-8><a id=__codelineno-58-8 name=__codelineno-58-8 href=#__codelineno-58-8></a><span class=go>symbol                     BTCUSDT   ETHUSDT   BNBUSDT   XRPUSDT   ADAUSDT</span>
</span><span id=__span-58-9><a id=__codelineno-58-9 name=__codelineno-58-9 href=#__codelineno-58-9></a><span class=go>Open time                                                                 </span>
</span><span id=__span-58-10><a id=__codelineno-58-10 name=__codelineno-58-10 href=#__codelineno-58-10></a><span class=go>2020-12-31 23:00:00+00:00      0.2  0.066667  0.266667  0.333333  0.133333</span>
</span></code></pre></div> <ol> <li>Here.</li> </ol> <h4 id=numba_1>Numba<a class=headerlink href=#numba_1 title="Permanent link">&para;</a></h4> <p>Let's perform both the iteration and optimization entirely using Numba. The only difference, compared to a Numba-compiled allocation function, is that an optimization function takes two arguments instead of one: the range start and end index. Under the hood, the iteration and execution are managed by <a href=https://vectorbt.pro/pvt_41531c19/api/portfolio/pfopt/nb/#vectorbtpro.portfolio.pfopt.nb.optimize_meta_nb>optimize_meta_nb</a>.</p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-59-1><a id=__codelineno-59-1 name=__codelineno-59-1 href=#__codelineno-59-1></a><span class=gp>&gt;&gt;&gt; </span><span class=nd>@njit</span>
</span><span id=__span-59-2><a id=__codelineno-59-2 name=__codelineno-59-2 href=#__codelineno-59-2></a><span class=gp>... </span><span class=k>def</span><span class=w> </span><span class=nf>inv_rank_optimize_func_nb</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>start_idx</span><span class=p>,</span> <span class=n>end_idx</span><span class=p>,</span> <span class=n>price</span><span class=p>):</span>
</span><span id=__span-59-3><a id=__codelineno-59-3 name=__codelineno-59-3 href=#__codelineno-59-3></a><span class=gp>... </span>    <span class=n>price_period</span> <span class=o>=</span> <span class=n>price</span><span class=p>[</span><span class=n>start_idx</span><span class=p>:</span><span class=n>end_idx</span><span class=p>]</span>
</span><span id=__span-59-4><a id=__codelineno-59-4 name=__codelineno-59-4 href=#__codelineno-59-4></a><span class=gp>... </span>    <span class=n>first_price</span> <span class=o>=</span> <span class=n>price_period</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span><span id=__span-59-5><a id=__codelineno-59-5 name=__codelineno-59-5 href=#__codelineno-59-5></a><span class=gp>... </span>    <span class=n>last_price</span> <span class=o>=</span> <span class=n>price_period</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-59-6><a id=__codelineno-59-6 name=__codelineno-59-6 href=#__codelineno-59-6></a><span class=gp>... </span>    <span class=n>ret</span> <span class=o>=</span> <span class=p>(</span><span class=n>last_price</span> <span class=o>-</span> <span class=n>first_price</span><span class=p>)</span> <span class=o>/</span> <span class=n>first_price</span>
</span><span id=__span-59-7><a id=__codelineno-59-7 name=__codelineno-59-7 href=#__codelineno-59-7></a><span class=gp>... </span>    <span class=n>ranks</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>nb</span><span class=o>.</span><span class=n>rank_1d_nb</span><span class=p>(</span><span class=o>-</span><span class=n>ret</span><span class=p>)</span>  <span class=c1># (1)!</span>
</span><span id=__span-59-8><a id=__codelineno-59-8 name=__codelineno-59-8 href=#__codelineno-59-8></a><span class=gp>... </span>    <span class=k>return</span> <span class=n>ranks</span> <span class=o>/</span> <span class=n>ranks</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span><span id=__span-59-9><a id=__codelineno-59-9 name=__codelineno-59-9 href=#__codelineno-59-9></a>
</span><span id=__span-59-10><a id=__codelineno-59-10 name=__codelineno-59-10 href=#__codelineno-59-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span> <span class=o>=</span> <span class=n>vbt</span><span class=o>.</span><span class=n>PortfolioOptimizer</span><span class=o>.</span><span class=n>from_optimize_func</span><span class=p>(</span>
</span><span id=__span-59-11><a id=__codelineno-59-11 name=__codelineno-59-11 href=#__codelineno-59-11></a><span class=gp>... </span>    <span class=n>symbol_wrapper</span><span class=p>,</span>
</span><span id=__span-59-12><a id=__codelineno-59-12 name=__codelineno-59-12 href=#__codelineno-59-12></a><span class=gp>... </span>    <span class=n>inv_rank_optimize_func_nb</span><span class=p>,</span>
</span><span id=__span-59-13><a id=__codelineno-59-13 name=__codelineno-59-13 href=#__codelineno-59-13></a><span class=gp>... </span>    <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;Close&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>  <span class=c1># (2)!</span>
</span><span id=__span-59-14><a id=__codelineno-59-14 name=__codelineno-59-14 href=#__codelineno-59-14></a><span class=gp>... </span>    <span class=n>every</span><span class=o>=</span><span class=s2>&quot;M&quot;</span><span class=p>,</span>
</span><span id=__span-59-15><a id=__codelineno-59-15 name=__codelineno-59-15 href=#__codelineno-59-15></a><span class=gp>... </span>    <span class=n>jitted_loop</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-59-16><a id=__codelineno-59-16 name=__codelineno-59-16 href=#__codelineno-59-16></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-59-17><a id=__codelineno-59-17 name=__codelineno-59-17 href=#__codelineno-59-17></a>
</span><span id=__span-59-18><a id=__codelineno-59-18 name=__codelineno-59-18 href=#__codelineno-59-18></a><span class=gp>&gt;&gt;&gt; </span><span class=n>pfo</span><span class=o>.</span><span class=n>allocations</span>
</span><span id=__span-59-19><a id=__codelineno-59-19 name=__codelineno-59-19 href=#__codelineno-59-19></a><span class=go>symbol                      ADAUSDT   BNBUSDT   BTCUSDT   ETHUSDT   XRPUSDT</span>
</span><span id=__span-59-20><a id=__codelineno-59-20 name=__codelineno-59-20 href=#__codelineno-59-20></a><span class=go>Open time                                                                  </span>
</span><span id=__span-59-21><a id=__codelineno-59-21 name=__codelineno-59-21 href=#__codelineno-59-21></a><span class=go>2020-02-01 00:00:00+00:00  0.066667  0.200000  0.266667  0.133333  0.333333</span>
</span><span id=__span-59-22><a id=__codelineno-59-22 name=__codelineno-59-22 href=#__codelineno-59-22></a><span class=go>2020-03-01 00:00:00+00:00  0.333333  0.133333  0.266667  0.066667  0.200000</span>
</span><span id=__span-59-23><a id=__codelineno-59-23 name=__codelineno-59-23 href=#__codelineno-59-23></a><span class=go>2020-04-01 00:00:00+00:00  0.266667  0.200000  0.133333  0.333333  0.066667</span>
</span><span id=__span-59-24><a id=__codelineno-59-24 name=__codelineno-59-24 href=#__codelineno-59-24></a><span class=go>2020-05-01 00:00:00+00:00  0.066667  0.200000  0.266667  0.133333  0.333333</span>
</span><span id=__span-59-25><a id=__codelineno-59-25 name=__codelineno-59-25 href=#__codelineno-59-25></a><span class=go>2020-06-01 00:00:00+00:00  0.066667  0.266667  0.200000  0.133333  0.333333</span>
</span><span id=__span-59-26><a id=__codelineno-59-26 name=__codelineno-59-26 href=#__codelineno-59-26></a><span class=go>2020-07-01 00:00:00+00:00  0.066667  0.266667  0.200000  0.133333  0.333333</span>
</span><span id=__span-59-27><a id=__codelineno-59-27 name=__codelineno-59-27 href=#__codelineno-59-27></a><span class=go>2020-08-01 00:00:00+00:00  0.066667  0.266667  0.333333  0.133333  0.200000</span>
</span><span id=__span-59-28><a id=__codelineno-59-28 name=__codelineno-59-28 href=#__codelineno-59-28></a><span class=go>2020-09-01 00:00:00+00:00  0.333333  0.133333  0.266667  0.066667  0.200000</span>
</span><span id=__span-59-29><a id=__codelineno-59-29 name=__codelineno-59-29 href=#__codelineno-59-29></a><span class=go>2020-10-01 00:00:00+00:00  0.266667  0.066667  0.133333  0.333333  0.200000</span>
</span><span id=__span-59-30><a id=__codelineno-59-30 name=__codelineno-59-30 href=#__codelineno-59-30></a><span class=go>2020-11-01 00:00:00+00:00  0.333333  0.266667  0.066667  0.133333  0.200000</span>
</span><span id=__span-59-31><a id=__codelineno-59-31 name=__codelineno-59-31 href=#__codelineno-59-31></a><span class=go>2020-12-01 00:00:00+00:00  0.133333  0.333333  0.266667  0.200000  0.066667</span>
</span></code></pre></div> <ol> <li>Negate the array to calculate the inverse rank.</li> <li>Make sure to convert any Pandas object to a NumPy array.</li> </ol> <p>The adaptation to Numba is quite simple, right? <img alt=😉 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f609.svg title=:wink:></p> <p>The speedup from this compilation is significant, especially when there are many re-allocation steps and/or parameter combinations. Try it for yourself!</p> <p><a class=md-button href=https://vectorbt.pro/pvt_41531c19/assets/jupytext/tutorials/portfolio-optimization/index.py.txt target=blank_><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19.14 7.5A2.86 2.86 0 0 1 22 10.36v3.78A2.86 2.86 0 0 1 19.14 17H12c0 .39.32.96.71.96H17v1.68a2.86 2.86 0 0 1-2.86 2.86H9.86A2.86 2.86 0 0 1 7 19.64v-3.75a2.85 2.85 0 0 1 2.86-2.85h5.25a2.85 2.85 0 0 0 2.85-2.86V7.5zm-4.28 11.79c-.4 0-.72.3-.72.89s.32.71.72.71a.71.71 0 0 0 .71-.71c0-.59-.32-.89-.71-.89m-10-1.79A2.86 2.86 0 0 1 2 14.64v-3.78A2.86 2.86 0 0 1 4.86 8H12c0-.39-.32-.96-.71-.96H7V5.36A2.86 2.86 0 0 1 9.86 2.5h4.28A2.86 2.86 0 0 1 17 5.36v3.75a2.85 2.85 0 0 1-2.86 2.85H8.89a2.85 2.85 0 0 0-2.85 2.86v2.68zM9.14 5.71c.4 0 .72-.3.72-.89s-.32-.71-.72-.71c-.39 0-.71.12-.71.71s.32.89.71.89"/></svg></span> Python code</a> <a class=md-button href=https://github.com/polakowo/vectorbt.pro/blob/notebooks/PortfolioOptimization.ipynb target=blank_><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 4v6l-2-2-2 2V4H9v16h10V4zM3 7V5h2V4a2 2 0 0 1 2-2h12c1.05 0 2 .95 2 2v16c0 1.05-.95 2-2 2H7c-1.05 0-2-.95-2-2v-1H3v-2h2v-4H3v-2h2V7zm2-2v2h2V5zm0 14h2v-2H5zm0-6h2v-2H5z"/></svg></span> Notebook</a></p> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/mtf-analysis/aggregation/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Aggregation"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Aggregation </div> </div> </a> <a href=https://vectorbt.pro/pvt_41531c19/tutorials/portfolio-optimization/integrations/ class="md-footer__link md-footer__link--next" aria-label="Next: Integrations"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Integrations </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2021-2025 Oleg Polakow. All rights reserved. </div> </div> <div class=md-social> <a href=https://www.linkedin.com/in/polakowo target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> <a href=https://github.com/polakowo target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <div class=md-consent data-md-component=consent id=__consent hidden> <div class=md-consent__overlay></div> <aside class=md-consent__inner> <form class="md-consent__form md-grid md-typeset" name=consent> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class=md-toggle type=checkbox id=__settings> <div class=md-consent__settings> <ul class=task-list> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=analytics checked> <span class=task-list-indicator></span> Google Analytics </label> </li> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=github checked> <span class=task-list-indicator></span> GitHub </label> </li> </ul> </div> <div class=md-consent__controls> <button class="md-button md-button--primary">Accept</button> <label class=md-button for=__settings>Manage settings</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script> <script id=__config type=application/json>{"annotate": null, "base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.instant", "navigation.instant.progress", "navigation.top", "navigation.prune", "navigation.path", "navigation.footer", "search.suggest", "search.share", "content.code.annotate", "content.code.copy", "content.code.select", "content.tooltips", "content.tabs.link", "toc.follow", "toc.integrate", "announce.dismiss"], "search": "../../assets/javascripts/workers/search.26099bd0.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=https://vectorbt.pro/pvt_41531c19/assets/javascripts/bundle.9d1edc04.min.js></script> <script src=https://vectorbt.pro/pvt_41531c19/assets/scripts/extra.js></script> <script src=https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js></script> </body> 
<!-- Mirrored from vectorbt.pro/pvt_41531c19/tutorials/portfolio-optimization/ by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 22 Nov 2025 03:47:00 GMT -->
</html>